================================================================================
SCAN SELECTED FILES - 153 FILES
================================================================================

--------------------------------------------------------------------------------
ðŸ“‚ DIRECTORY TREE
--------------------------------------------------------------------------------
ðŸ“ backend
â”œâ”€â”€ ðŸ“„ .env
â”œâ”€â”€ ðŸ“„ nest-cli.json
â”œâ”€â”€ ðŸ“„ package.json
â”œâ”€â”€ ðŸ“ sql
â”‚   â”œâ”€â”€ ðŸ“„ add_phone_model_to_cart.sql
â”‚   â”œâ”€â”€ ðŸ“„ add_season_column.sql
â”‚   â”œâ”€â”€ ðŸ“„ alter_wishlists.sql
â”‚   â”œâ”€â”€ ðŸ“„ create_collections.sql
â”‚   â”œâ”€â”€ ðŸ“„ create_contact_messages.sql
â”‚   â”œâ”€â”€ ðŸ“„ create_designs.sql
â”‚   â”œâ”€â”€ ðŸ“„ create_gifts.sql
â”‚   â”œâ”€â”€ ðŸ“„ create_messenger_orders.sql
â”‚   â””â”€â”€ ðŸ“„ create_wishlist.sql
â””â”€â”€ ðŸ“ src
    â”œâ”€â”€ ðŸ“„ app.controller.spec.ts
    â”œâ”€â”€ ðŸ“„ app.controller.ts
    â”œâ”€â”€ ðŸ“„ app.module.ts
    â”œâ”€â”€ ðŸ“„ app.service.ts
    â”œâ”€â”€ ðŸ“ auth
    â”‚   â”œâ”€â”€ ðŸ“„ auth.controller.ts
    â”‚   â”œâ”€â”€ ðŸ“„ auth.module.ts
    â”‚   â”œâ”€â”€ ðŸ“„ auth.service.ts
    â”‚   â”œâ”€â”€ ðŸ“ decorators
    â”‚   â”‚   â”œâ”€â”€ ðŸ“„ current-user.decorator.ts
    â”‚   â”‚   â”œâ”€â”€ ðŸ“„ customer-only.decorator.ts
    â”‚   â”‚   â”œâ”€â”€ ðŸ“„ index.ts
    â”‚   â”‚   â””â”€â”€ ðŸ“„ roles.decorator.ts
    â”‚   â”œâ”€â”€ ðŸ“ guards
    â”‚   â”‚   â”œâ”€â”€ ðŸ“„ customer.guard.ts
    â”‚   â”‚   â”œâ”€â”€ ðŸ“„ index.ts
    â”‚   â”‚   â”œâ”€â”€ ðŸ“„ jwt-auth.guard.ts
    â”‚   â”‚   â””â”€â”€ ðŸ“„ roles.guard.ts
    â”‚   â””â”€â”€ ðŸ“„ supabase.strategy.ts
    â”œâ”€â”€ ðŸ“ category
    â”‚   â”œâ”€â”€ ðŸ“„ category.controller.ts
    â”‚   â”œâ”€â”€ ðŸ“„ category.module.ts
    â”‚   â””â”€â”€ ðŸ“„ category.service.ts
    â”œâ”€â”€ ðŸ“ cloudinary
    â”‚   â”œâ”€â”€ ðŸ“„ cloudinary.module.ts
    â”‚   â””â”€â”€ ðŸ“„ cloudinary.service.ts
    â”œâ”€â”€ ðŸ“ collection
    â”‚   â”œâ”€â”€ ðŸ“„ collection.controller.ts
    â”‚   â”œâ”€â”€ ðŸ“„ collection.module.ts
    â”‚   â””â”€â”€ ðŸ“„ collection.service.ts
    â”œâ”€â”€ ðŸ“ common
    â”‚   â”œâ”€â”€ ðŸ“ enums
    â”‚   â”‚   â””â”€â”€ ðŸ“„ user-role.enum.ts
    â”‚   â”œâ”€â”€ ðŸ“„ index.ts
    â”‚   â””â”€â”€ ðŸ“ interfaces
    â”‚       â””â”€â”€ ðŸ“„ authenticated-user.interface.ts
    â”œâ”€â”€ ðŸ“ contact
    â”‚   â”œâ”€â”€ ðŸ“„ contact.controller.ts
    â”‚   â”œâ”€â”€ ðŸ“„ contact.module.ts
    â”‚   â””â”€â”€ ðŸ“„ contact.service.ts
    â”œâ”€â”€ ðŸ“ design
    â”‚   â”œâ”€â”€ ðŸ“„ design.controller.ts
    â”‚   â”œâ”€â”€ ðŸ“„ design.module.ts
    â”‚   â””â”€â”€ ðŸ“„ design.service.ts
    â”œâ”€â”€ ðŸ“ gift
    â”‚   â”œâ”€â”€ ðŸ“„ gift.controller.ts
    â”‚   â”œâ”€â”€ ðŸ“„ gift.module.ts
    â”‚   â””â”€â”€ ðŸ“„ gift.service.ts
    â”œâ”€â”€ ðŸ“„ main.ts
    â”œâ”€â”€ ðŸ“ messenger
    â”‚   â”œâ”€â”€ ðŸ“„ messenger.controller.ts
    â”‚   â”œâ”€â”€ ðŸ“„ messenger.dto.ts
    â”‚   â”œâ”€â”€ ðŸ“„ messenger.module.ts
    â”‚   â”œâ”€â”€ ðŸ“„ messenger.service.ts
    â”‚   â””â”€â”€ ðŸ“„ messenger.types.ts
    â”œâ”€â”€ ðŸ“ order
    â”‚   â”œâ”€â”€ ðŸ“„ order.controller.ts
    â”‚   â”œâ”€â”€ ðŸ“„ order.module.ts
    â”‚   â””â”€â”€ ðŸ“„ order.service.ts
    â”œâ”€â”€ ðŸ“ payment
    â”‚   â”œâ”€â”€ ðŸ“„ payment.controller.ts
    â”‚   â”œâ”€â”€ ðŸ“„ payment.module.ts
    â”‚   â””â”€â”€ ðŸ“„ payment.service.ts
    â”œâ”€â”€ ðŸ“ phone-model
    â”‚   â”œâ”€â”€ ðŸ“„ phone-model.controller.ts
    â”‚   â”œâ”€â”€ ðŸ“„ phone-model.module.ts
    â”‚   â””â”€â”€ ðŸ“„ phone-model.service.ts
    â”œâ”€â”€ ðŸ“ product
    â”‚   â”œâ”€â”€ ðŸ“„ product.controller.ts
    â”‚   â”œâ”€â”€ ðŸ“„ product.module.ts
    â”‚   â””â”€â”€ ðŸ“„ product.service.ts
    â”œâ”€â”€ ðŸ“ review
    â”‚   â”œâ”€â”€ ðŸ“„ review.controller.ts
    â”‚   â”œâ”€â”€ ðŸ“„ review.module.ts
    â”‚   â””â”€â”€ ðŸ“„ review.service.ts
    â”œâ”€â”€ ðŸ“ shopping-cart
    â”‚   â”œâ”€â”€ ðŸ“„ shopping-cart.controller.ts
    â”‚   â”œâ”€â”€ ðŸ“„ shopping-cart.module.ts
    â”‚   â””â”€â”€ ðŸ“„ shopping-cart.service.ts
    â”œâ”€â”€ ðŸ“„ supabase.service.ts
    â”œâ”€â”€ ðŸ“ users
    â”‚   â”œâ”€â”€ ðŸ“„ users.controller.ts
    â”‚   â”œâ”€â”€ ðŸ“„ users.module.ts
    â”‚   â””â”€â”€ ðŸ“„ users.service.ts
    â””â”€â”€ ðŸ“ wishlist
        â”œâ”€â”€ ðŸ“„ wishlist.controller.ts
        â”œâ”€â”€ ðŸ“„ wishlist.module.ts
        â””â”€â”€ ðŸ“„ wishlist.service.ts
ðŸ“ fontend
â”œâ”€â”€ ðŸ“ lib
â”‚   â”œâ”€â”€ ðŸ“„ api-client.ts
â”‚   â”œâ”€â”€ ðŸ“ api
â”‚   â”‚   â”œâ”€â”€ ðŸ“„ auth.api.ts
â”‚   â”‚   â”œâ”€â”€ ðŸ“„ category.api.ts
â”‚   â”‚   â”œâ”€â”€ ðŸ“„ index.ts
â”‚   â”‚   â”œâ”€â”€ ðŸ“„ order.api.ts
â”‚   â”‚   â”œâ”€â”€ ðŸ“„ product.api.ts
â”‚   â”‚   â””â”€â”€ ðŸ“„ users.api.ts
â”‚   â””â”€â”€ ðŸ“„ constants.ts
â”œâ”€â”€ ðŸ“„ next-env.d.ts
â”œâ”€â”€ ðŸ“„ next.config.ts
â”œâ”€â”€ ðŸ“„ package.json
â”œâ”€â”€ ðŸ“„ postcss.config.mjs
â””â”€â”€ ðŸ“ src
    â”œâ”€â”€ ðŸ“ app
    â”‚   â”œâ”€â”€ ðŸ“ (public)
    â”‚   â”‚   â”œâ”€â”€ ðŸ“ about
    â”‚   â”‚   â”‚   â””â”€â”€ ðŸ“„ page.tsx
    â”‚   â”‚   â”œâ”€â”€ ðŸ“ blog
    â”‚   â”‚   â”‚   â”œâ”€â”€ ðŸ“ [slug]
    â”‚   â”‚   â”‚   â”‚   â””â”€â”€ ðŸ“„ page.tsx
    â”‚   â”‚   â”‚   â””â”€â”€ ðŸ“„ page.tsx
    â”‚   â”‚   â”œâ”€â”€ ðŸ“ categories
    â”‚   â”‚   â”‚   â””â”€â”€ ðŸ“„ page.tsx
    â”‚   â”‚   â”œâ”€â”€ ðŸ“ checkout
    â”‚   â”‚   â”‚   â””â”€â”€ ðŸ“„ page.tsx
    â”‚   â”‚   â”œâ”€â”€ ðŸ“ collections
    â”‚   â”‚   â”‚   â””â”€â”€ ðŸ“„ page.tsx
    â”‚   â”‚   â”œâ”€â”€ ðŸ“ contact
    â”‚   â”‚   â”‚   â””â”€â”€ ðŸ“„ page.tsx
    â”‚   â”‚   â”œâ”€â”€ ðŸ“„ layout.tsx
    â”‚   â”‚   â”œâ”€â”€ ðŸ“ login
    â”‚   â”‚   â”‚   â””â”€â”€ ðŸ“„ page.tsx
    â”‚   â”‚   â”œâ”€â”€ ðŸ“ order
    â”‚   â”‚   â”‚   â”œâ”€â”€ ðŸ“ [orderNumber]
    â”‚   â”‚   â”‚   â”‚   â””â”€â”€ ðŸ“„ page.tsx
    â”‚   â”‚   â”‚   â”œâ”€â”€ ðŸ“„ page.tsx
    â”‚   â”‚   â”‚   â””â”€â”€ ðŸ“ success
    â”‚   â”‚   â”‚       â””â”€â”€ ðŸ“„ page.tsx
    â”‚   â”‚   â”œâ”€â”€ ðŸ“ payment
    â”‚   â”‚   â”‚   â”œâ”€â”€ ðŸ“ payment-result
    â”‚   â”‚   â”‚   â”‚   â””â”€â”€ ðŸ“„ page.tsx
    â”‚   â”‚   â”‚   â””â”€â”€ ðŸ“ payment-test
    â”‚   â”‚   â”‚       â””â”€â”€ ðŸ“„ page.tsx
    â”‚   â”‚   â”œâ”€â”€ ðŸ“ register
    â”‚   â”‚   â”‚   â””â”€â”€ ðŸ“„ page.tsx
    â”‚   â”‚   â”œâ”€â”€ ðŸ“ search
    â”‚   â”‚   â”‚   â””â”€â”€ ðŸ“„ page.tsx
    â”‚   â”‚   â”œâ”€â”€ ðŸ“ shop
    â”‚   â”‚   â”‚   â”œâ”€â”€ ðŸ“„ page.tsx
    â”‚   â”‚   â”‚   â””â”€â”€ ðŸ“ product
    â”‚   â”‚   â”‚       â””â”€â”€ ðŸ“ [slug]
    â”‚   â”‚   â”‚           â””â”€â”€ ðŸ“„ page.tsx
    â”‚   â”‚   â”œâ”€â”€ ðŸ“ shopping-cart
    â”‚   â”‚   â”‚   â””â”€â”€ ðŸ“„ page.tsx
    â”‚   â”‚   â””â”€â”€ ðŸ“ wishlist
    â”‚   â”‚       â””â”€â”€ ðŸ“„ page.tsx
    â”‚   â”œâ”€â”€ ðŸ“ account
    â”‚   â”‚   â””â”€â”€ ðŸ“„ page.tsx
    â”‚   â”œâ”€â”€ ðŸ“ admin
    â”‚   â”‚   â”œâ”€â”€ ðŸ“ designs
    â”‚   â”‚   â”‚   â””â”€â”€ ðŸ“„ page.tsx
    â”‚   â”‚   â”œâ”€â”€ ðŸ“„ page.tsx
    â”‚   â”‚   â””â”€â”€ ðŸ“ templates
    â”‚   â”‚       â””â”€â”€ ðŸ“„ page.tsx
    â”‚   â”œâ”€â”€ ðŸ“ api-test
    â”‚   â”‚   â””â”€â”€ ðŸ“„ page.tsx
    â”‚   â”œâ”€â”€ ðŸ“ context
    â”‚   â”‚   â”œâ”€â”€ ðŸ“„ cart-context.tsx
    â”‚   â”‚   â””â”€â”€ ðŸ“„ wishlist-context.tsx
    â”‚   â”œâ”€â”€ ðŸ“ design
    â”‚   â”‚   â””â”€â”€ ðŸ“„ page.tsx
    â”‚   â”œâ”€â”€ ðŸ“ gift
    â”‚   â”‚   â”œâ”€â”€ ðŸ“ claim
    â”‚   â”‚   â”‚   â””â”€â”€ ðŸ“ [giftId]
    â”‚   â”‚   â”‚       â””â”€â”€ ðŸ“„ page.tsx
    â”‚   â”‚   â””â”€â”€ ðŸ“ send
    â”‚   â”‚       â””â”€â”€ ðŸ“„ page.tsx
    â”‚   â”œâ”€â”€ ðŸ“„ globals.css
    â”‚   â”œâ”€â”€ ðŸ“„ layout.tsx
    â”‚   â”œâ”€â”€ ðŸ“„ page.tsx
    â”‚   â”œâ”€â”€ ðŸ“ product
    â”‚   â”‚   â””â”€â”€ ðŸ“ [id]
    â”‚   â”‚       â””â”€â”€ ðŸ“„ page.tsx
    â”‚   â””â”€â”€ ðŸ“ promotions
    â”‚       â””â”€â”€ ðŸ“„ page.tsx
    â”œâ”€â”€ ðŸ“ components
    â”‚   â”œâ”€â”€ ðŸ“ guards
    â”‚   â”‚   â”œâ”€â”€ ðŸ“„ CustomerOnly.tsx
    â”‚   â”‚   â”œâ”€â”€ ðŸ“„ RoleGuard.tsx
    â”‚   â”‚   â””â”€â”€ ðŸ“„ index.ts
    â”‚   â”œâ”€â”€ ðŸ“ home
    â”‚   â”‚   â”œâ”€â”€ ðŸ“„ CategoryGrid.tsx
    â”‚   â”‚   â”œâ”€â”€ ðŸ“„ FeaturedProducts.tsx
    â”‚   â”‚   â”œâ”€â”€ ðŸ“„ HeroCarousel.tsx
    â”‚   â”‚   â”œâ”€â”€ ðŸ“„ PromoSection.tsx
    â”‚   â”‚   â””â”€â”€ ðŸ“„ index.ts
    â”‚   â”œâ”€â”€ ðŸ“ layout
    â”‚   â”‚   â”œâ”€â”€ ðŸ“„ Footer.tsx
    â”‚   â”‚   â”œâ”€â”€ ðŸ“„ Header.tsx
    â”‚   â”‚   â””â”€â”€ ðŸ“„ TopBanner.tsx
    â”‚   â”œâ”€â”€ ðŸ“ modals
    â”‚   â”‚   â”œâ”€â”€ ðŸ“„ CartModal.tsx
    â”‚   â”‚   â”œâ”€â”€ ðŸ“„ CurrencyModal.tsx
    â”‚   â”‚   â””â”€â”€ ðŸ“„ index.ts
    â”‚   â”œâ”€â”€ ðŸ“ products
    â”‚   â”‚   â””â”€â”€ ðŸ“„ AddToCartButton.tsx
    â”‚   â””â”€â”€ ðŸ“ ui
    â”‚       â”œâ”€â”€ ðŸ“„ ProductCard.tsx
    â”‚       â””â”€â”€ ðŸ“„ index.ts
    â”œâ”€â”€ ðŸ“ contexts
    â”‚   â””â”€â”€ ðŸ“„ AuthContext.tsx
    â”œâ”€â”€ ðŸ“ hooks
    â”‚   â”œâ”€â”€ ðŸ“„ index.ts
    â”‚   â”œâ”€â”€ ðŸ“„ useAuth.ts
    â”‚   â”œâ”€â”€ ðŸ“„ useCart.ts
    â”‚   â”œâ”€â”€ ðŸ“„ useCustomerGuard.ts
    â”‚   â”œâ”€â”€ ðŸ“„ useProducts.ts
    â”‚   â””â”€â”€ ðŸ“„ useWishlist.ts
    â”œâ”€â”€ ðŸ“„ middleware.ts
    â””â”€â”€ ðŸ“ types
        â””â”€â”€ ðŸ“„ index.ts
ðŸ“„ supabase.sql


################################################################################
## FILE 1: supabase.sql
## Path: supabase.sql
################################################################################


CREATE TABLE public.categories (
  category_id integer NOT NULL DEFAULT nextval('categories_category_id_seq'::regclass),
  category_name character varying NOT NULL,
  category_slug character varying NOT NULL UNIQUE,
  parent_category_id integer,
  description text,
  image_url character varying,
  icon_name character varying,
  display_order integer DEFAULT 0,
  is_active boolean DEFAULT true,
  created_at timestamp without time zone DEFAULT CURRENT_TIMESTAMP,
  updated_at timestamp without time zone DEFAULT CURRENT_TIMESTAMP,
  CONSTRAINT categories_pkey PRIMARY KEY (category_id),
  CONSTRAINT categories_parent_category_id_fkey FOREIGN KEY (parent_category_id) REFERENCES public.categories(category_id)
);
CREATE TABLE public.contact_messages (
  id integer NOT NULL DEFAULT nextval('contact_messages_id_seq'::regclass),
  name character varying NOT NULL,
  email character varying NOT NULL,
  phone character varying,
  subject character varying,
  message text NOT NULL,
  status character varying DEFAULT 'pending'::character varying,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT contact_messages_pkey PRIMARY KEY (id)
);
CREATE TABLE public.coupons (
  coupon_id integer NOT NULL DEFAULT nextval('coupons_coupon_id_seq'::regclass),
  coupon_code character varying NOT NULL UNIQUE,
  coupon_type character varying NOT NULL,
  discount_value numeric NOT NULL,
  min_order_amount numeric,
  max_discount_amount numeric,
  usage_limit integer,
  used_count integer DEFAULT 0,
  valid_from timestamp without time zone NOT NULL,
  valid_to timestamp without time zone NOT NULL,
  is_active boolean DEFAULT true,
  description text,
  created_at timestamp without time zone DEFAULT CURRENT_TIMESTAMP,
  CONSTRAINT coupons_pkey PRIMARY KEY (coupon_id)
);
CREATE TABLE public.custom_designs (
  design_id integer NOT NULL DEFAULT nextval('custom_designs_design_id_seq'::regclass),
  user_id uuid,
  guest_email character varying,
  guest_name character varying,
  guest_phone character varying,
  template_id integer,
  phone_model character varying NOT NULL,
  design_data jsonb NOT NULL,
  preview_image_url text,
  high_res_image_url text,
  status character varying DEFAULT 'draft'::character varying CHECK (status::text = ANY (ARRAY['draft'::character varying, 'submitted'::character varying, 'processing'::character varying, 'approved'::character varying, 'rejected'::character varying, 'printed'::character varying]::text[])),
  admin_notes text,
  order_id integer,
  created_at timestamp without time zone DEFAULT CURRENT_TIMESTAMP,
  updated_at timestamp without time zone DEFAULT CURRENT_TIMESTAMP,
  submitted_at timestamp without time zone,
  processed_at timestamp without time zone,
  CONSTRAINT custom_designs_pkey PRIMARY KEY (design_id),
  CONSTRAINT custom_designs_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id),
  CONSTRAINT custom_designs_template_id_fkey FOREIGN KEY (template_id) REFERENCES public.phone_templates(template_id),
  CONSTRAINT custom_designs_order_id_fkey FOREIGN KEY (order_id) REFERENCES public.orders(order_id)
);
CREATE TABLE public.design_collections (
  collection_id integer NOT NULL DEFAULT nextval('design_collections_collection_id_seq'::regclass),
  collection_name character varying NOT NULL,
  collection_slug character varying NOT NULL UNIQUE,
  description text,
  banner_image character varying,
  thumbnail_image character varying,
  theme_color character varying,
  is_featured boolean DEFAULT false,
  is_active boolean DEFAULT true,
  display_order integer DEFAULT 0,
  valid_from timestamp without time zone,
  valid_to timestamp without time zone,
  view_count integer DEFAULT 0,
  created_at timestamp without time zone DEFAULT CURRENT_TIMESTAMP,
  CONSTRAINT design_collections_pkey PRIMARY KEY (collection_id)
);
CREATE TABLE public.design_images (
  image_id integer NOT NULL DEFAULT nextval('design_images_image_id_seq'::regclass),
  design_id integer,
  original_url text NOT NULL,
  thumbnail_url text,
  file_name character varying,
  file_size integer,
  width integer,
  height integer,
  created_at timestamp without time zone DEFAULT CURRENT_TIMESTAMP,
  CONSTRAINT design_images_pkey PRIMARY KEY (image_id),
  CONSTRAINT design_images_design_id_fkey FOREIGN KEY (design_id) REFERENCES public.custom_designs(design_id)
);
CREATE TABLE public.gift_emails (
  email_id uuid NOT NULL DEFAULT gen_random_uuid(),
  gift_id uuid,
  email_type character varying NOT NULL,
  sent_to character varying NOT NULL,
  sent_at timestamp with time zone DEFAULT now(),
  status character varying DEFAULT 'sent'::character varying,
  CONSTRAINT gift_emails_pkey PRIMARY KEY (email_id),
  CONSTRAINT gift_emails_gift_id_fkey FOREIGN KEY (gift_id) REFERENCES public.gifts(gift_id)
);
CREATE TABLE public.gifts (
  gift_id uuid NOT NULL DEFAULT gen_random_uuid(),
  sender_id uuid,
  sender_name character varying NOT NULL,
  sender_email character varying NOT NULL,
  sender_message text,
  recipient_name character varying NOT NULL,
  recipient_email character varying NOT NULL,
  recipient_phone character varying,
  recipient_address text,
  product_id integer NOT NULL,
  quantity integer DEFAULT 1,
  verification_code character varying NOT NULL,
  status character varying DEFAULT 'pending'::character varying,
  created_at timestamp with time zone DEFAULT now(),
  verified_at timestamp with time zone,
  claimed_at timestamp with time zone,
  expires_at timestamp with time zone DEFAULT (now() + '7 days'::interval),
  notes text,
  CONSTRAINT gifts_pkey PRIMARY KEY (gift_id),
  CONSTRAINT gifts_sender_id_fkey FOREIGN KEY (sender_id) REFERENCES public.users(id),
  CONSTRAINT gifts_product_id_fkey FOREIGN KEY (product_id) REFERENCES public.products(product_id)
);
CREATE TABLE public.inventory (
  inventory_id integer NOT NULL DEFAULT nextval('inventory_inventory_id_seq'::regclass),
  product_id integer,
  variant_id integer,
  warehouse_location character varying,
  quantity_available integer DEFAULT 0,
  quantity_reserved integer DEFAULT 0,
  quantity_sold integer DEFAULT 0,
  reorder_level integer DEFAULT 10,
  reorder_quantity integer DEFAULT 50,
  last_restock_date timestamp without time zone,
  updated_at timestamp without time zone DEFAULT CURRENT_TIMESTAMP,
  CONSTRAINT inventory_pkey PRIMARY KEY (inventory_id),
  CONSTRAINT inventory_product_id_fkey FOREIGN KEY (product_id) REFERENCES public.products(product_id),
  CONSTRAINT inventory_variant_id_fkey FOREIGN KEY (variant_id) REFERENCES public.product_variants(variant_id)
);
CREATE TABLE public.messenger_orders (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  facebook_user_id character varying NOT NULL,
  customer_name character varying NOT NULL,
  phone character varying NOT NULL,
  address text NOT NULL,
  product_name character varying NOT NULL,
  product_price numeric NOT NULL DEFAULT 0,
  quantity integer NOT NULL DEFAULT 1,
  color character varying,
  total_price numeric NOT NULL DEFAULT 0,
  notes text,
  status character varying NOT NULL DEFAULT 'pending'::character varying,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT messenger_orders_pkey PRIMARY KEY (id)
);
CREATE TABLE public.order_items (
  order_item_id integer NOT NULL DEFAULT nextval('order_items_order_item_id_seq'::regclass),
  order_id integer,
  product_id integer,
  variant_id integer,
  product_name character varying NOT NULL,
  variant_name character varying,
  sku character varying NOT NULL,
  quantity integer NOT NULL,
  unit_price numeric NOT NULL,
  discount_amount numeric DEFAULT 0,
  total_price numeric NOT NULL,
  created_at timestamp without time zone DEFAULT CURRENT_TIMESTAMP,
  phone_model_id integer,
  phone_model_name character varying,
  CONSTRAINT order_items_pkey PRIMARY KEY (order_item_id),
  CONSTRAINT order_items_order_id_fkey FOREIGN KEY (order_id) REFERENCES public.orders(order_id),
  CONSTRAINT order_items_product_id_fkey FOREIGN KEY (product_id) REFERENCES public.products(product_id)
);
CREATE TABLE public.orders (
  order_id integer NOT NULL DEFAULT nextval('orders_order_id_seq'::regclass),
  order_number character varying NOT NULL UNIQUE,
  order_status character varying DEFAULT 'pending'::character varying,
  payment_status character varying DEFAULT 'unpaid'::character varying,
  payment_method character varying,
  shipping_method character varying,
  subtotal numeric NOT NULL,
  discount_amount numeric DEFAULT 0,
  shipping_fee numeric DEFAULT 0,
  tax_amount numeric DEFAULT 0,
  total_amount numeric NOT NULL,
  coupon_code character varying,
  shipping_address_id integer,
  billing_address_id integer,
  customer_note text,
  admin_note text,
  tracking_number character varying,
  shipped_at timestamp without time zone,
  delivered_at timestamp without time zone,
  cancelled_at timestamp without time zone,
  created_at timestamp without time zone DEFAULT CURRENT_TIMESTAMP,
  updated_at timestamp without time zone DEFAULT CURRENT_TIMESTAMP,
  shipping_full_name character varying,
  shipping_phone character varying,
  shipping_address text,
  shipping_ward character varying,
  shipping_district character varying,
  shipping_city character varying,
  customer_id uuid,
  CONSTRAINT orders_pkey PRIMARY KEY (order_id),
  CONSTRAINT orders_customer_id_fkey FOREIGN KEY (customer_id) REFERENCES public.users(id)
);
CREATE TABLE public.phone_models (
  model_id integer NOT NULL DEFAULT nextval('phone_models_model_id_seq'::regclass),
  brand_name character varying NOT NULL,
  model_name character varying NOT NULL,
  model_code character varying,
  release_year integer,
  screen_size numeric,
  dimensions character varying,
  weight character varying,
  image_url character varying,
  is_popular boolean DEFAULT false,
  is_active boolean DEFAULT true,
  display_order integer DEFAULT 0,
  created_at timestamp without time zone DEFAULT CURRENT_TIMESTAMP,
  CONSTRAINT phone_models_pkey PRIMARY KEY (model_id)
);
CREATE TABLE public.phone_templates (
  template_id integer NOT NULL DEFAULT nextval('phone_templates_template_id_seq'::regclass),
  phone_model character varying NOT NULL,
  brand character varying NOT NULL,
  template_image_url text,
  print_width_mm numeric DEFAULT 70,
  print_height_mm numeric DEFAULT 150,
  canvas_width integer DEFAULT 700,
  canvas_height integer DEFAULT 1500,
  is_active boolean DEFAULT true,
  created_at timestamp without time zone DEFAULT CURRENT_TIMESTAMP,
  CONSTRAINT phone_templates_pkey PRIMARY KEY (template_id)
);
CREATE TABLE public.product_collections (
  id integer NOT NULL DEFAULT nextval('product_collections_id_seq'::regclass),
  product_id integer,
  collection_id integer,
  display_order integer DEFAULT 0,
  created_at timestamp without time zone DEFAULT CURRENT_TIMESTAMP,
  CONSTRAINT product_collections_pkey PRIMARY KEY (id),
  CONSTRAINT product_collections_product_id_fkey FOREIGN KEY (product_id) REFERENCES public.products(product_id),
  CONSTRAINT product_collections_collection_id_fkey FOREIGN KEY (collection_id) REFERENCES public.design_collections(collection_id)
);
CREATE TABLE public.product_compatibility (
  compatibility_id integer NOT NULL DEFAULT nextval('product_compatibility_compatibility_id_seq'::regclass),
  product_id integer,
  phone_model_id integer,
  fit_type character varying DEFAULT 'exact'::character varying,
  notes text,
  created_at timestamp without time zone DEFAULT CURRENT_TIMESTAMP,
  CONSTRAINT product_compatibility_pkey PRIMARY KEY (compatibility_id),
  CONSTRAINT product_compatibility_product_id_fkey FOREIGN KEY (product_id) REFERENCES public.products(product_id),
  CONSTRAINT product_compatibility_phone_model_id_fkey FOREIGN KEY (phone_model_id) REFERENCES public.phone_models(model_id)
);
CREATE TABLE public.product_images (
  image_id integer NOT NULL DEFAULT nextval('product_images_image_id_seq'::regclass),
  product_id integer,
  variant_id integer,
  image_url character varying NOT NULL,
  alt_text character varying,
  display_order integer DEFAULT 0,
  is_primary boolean DEFAULT false,
  created_at timestamp without time zone DEFAULT CURRENT_TIMESTAMP,
  CONSTRAINT product_images_pkey PRIMARY KEY (image_id),
  CONSTRAINT product_images_product_id_fkey FOREIGN KEY (product_id) REFERENCES public.products(product_id),
  CONSTRAINT product_images_variant_id_fkey FOREIGN KEY (variant_id) REFERENCES public.product_variants(variant_id)
);
CREATE TABLE public.product_reviews (
  review_id integer NOT NULL DEFAULT nextval('product_reviews_review_id_seq'::regclass),
  product_id integer,
  customer_id integer,
  order_id integer,
  rating integer NOT NULL CHECK (rating >= 1 AND rating <= 5),
  title character varying,
  comment text,
  is_verified_purchase boolean DEFAULT false,
  is_approved boolean DEFAULT false,
  helpful_count integer DEFAULT 0,
  created_at timestamp without time zone DEFAULT CURRENT_TIMESTAMP,
  updated_at timestamp without time zone DEFAULT CURRENT_TIMESTAMP,
  CONSTRAINT product_reviews_pkey PRIMARY KEY (review_id),
  CONSTRAINT product_reviews_product_id_fkey FOREIGN KEY (product_id) REFERENCES public.products(product_id),
  CONSTRAINT product_reviews_order_id_fkey FOREIGN KEY (order_id) REFERENCES public.orders(order_id)
);
CREATE TABLE public.product_variants (
  variant_id integer NOT NULL DEFAULT nextval('product_variants_variant_id_seq'::regclass),
  product_id integer,
  sku character varying NOT NULL UNIQUE,
  variant_name character varying,
  color character varying,
  color_code character varying,
  size character varying,
  material character varying,
  price numeric,
  sale_price numeric,
  image_url character varying,
  is_active boolean DEFAULT true,
  created_at timestamp without time zone DEFAULT CURRENT_TIMESTAMP,
  CONSTRAINT product_variants_pkey PRIMARY KEY (variant_id),
  CONSTRAINT product_variants_product_id_fkey FOREIGN KEY (product_id) REFERENCES public.products(product_id)
);
CREATE TABLE public.products (
  product_id integer NOT NULL DEFAULT nextval('products_product_id_seq'::regclass),
  product_name character varying NOT NULL,
  product_slug character varying NOT NULL UNIQUE,
  category_id integer,
  brand_id integer,
  sku character varying NOT NULL UNIQUE,
  description text,
  short_description text,
  price numeric NOT NULL,
  sale_price numeric,
  cost_price numeric,
  is_featured boolean DEFAULT false,
  is_new boolean DEFAULT false,
  is_bestseller boolean DEFAULT false,
  is_trending boolean DEFAULT false,
  status character varying DEFAULT 'active'::character varying,
  meta_title character varying,
  meta_description text,
  meta_keywords text,
  view_count integer DEFAULT 0,
  rating_average numeric DEFAULT 0,
  review_count integer DEFAULT 0,
  created_at timestamp without time zone DEFAULT CURRENT_TIMESTAMP,
  updated_at timestamp without time zone DEFAULT CURRENT_TIMESTAMP,
  image_url text,
  season text,
  CONSTRAINT products_pkey PRIMARY KEY (product_id),
  CONSTRAINT products_category_id_fkey FOREIGN KEY (category_id) REFERENCES public.categories(category_id)
);
CREATE TABLE public.shopping_carts (
  cart_id integer NOT NULL DEFAULT nextval('shopping_carts_cart_id_seq'::regclass),
  customer_id uuid,
  product_id integer,
  variant_id integer,
  quantity integer NOT NULL DEFAULT 1,
  created_at timestamp without time zone DEFAULT CURRENT_TIMESTAMP,
  updated_at timestamp without time zone DEFAULT CURRENT_TIMESTAMP,
  phone_model_id integer,
  phone_model_name character varying,
  CONSTRAINT shopping_carts_pkey PRIMARY KEY (cart_id),
  CONSTRAINT shopping_carts_product_id_fkey FOREIGN KEY (product_id) REFERENCES public.products(product_id),
  CONSTRAINT shopping_carts_variant_id_fkey FOREIGN KEY (variant_id) REFERENCES public.product_variants(variant_id),
  CONSTRAINT shopping_carts_customer_id_fkey FOREIGN KEY (customer_id) REFERENCES public.users(id)
);
CREATE TABLE public.staff (
  staff_id integer NOT NULL DEFAULT nextval('staff_staff_id_seq'::regclass),
  email character varying NOT NULL UNIQUE,
  password_hash character varying NOT NULL,
  full_name character varying NOT NULL,
  phone character varying,
  role character varying NOT NULL,
  permissions text,
  is_active boolean DEFAULT true,
  last_login timestamp without time zone,
  created_at timestamp without time zone DEFAULT CURRENT_TIMESTAMP,
  CONSTRAINT staff_pkey PRIMARY KEY (staff_id)
);
CREATE TABLE public.users (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  email character varying NOT NULL UNIQUE,
  password_hash text NOT NULL,
  full_name character varying,
  phone character varying,
  avatar_url text,
  address text,
  is_admin boolean DEFAULT false,
  role character varying DEFAULT 'user'::character varying,
  status character varying DEFAULT 'active'::character varying,
  email_verified boolean DEFAULT false,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  last_login_at timestamp with time zone,
  CONSTRAINT users_pkey PRIMARY KEY (id)
);
CREATE TABLE public.wishlists (
  wishlist_id integer NOT NULL DEFAULT nextval('wishlists_wishlist_id_seq'::regclass),
  customer_id integer,
  product_id integer,
  variant_id integer,
  created_at timestamp without time zone DEFAULT CURRENT_TIMESTAMP,
  user_id uuid,
  CONSTRAINT wishlists_pkey PRIMARY KEY (wishlist_id),
  CONSTRAINT wishlists_product_id_fkey FOREIGN KEY (product_id) REFERENCES public.products(product_id),
  CONSTRAINT wishlists_variant_id_fkey FOREIGN KEY (variant_id) REFERENCES public.product_variants(variant_id),
  CONSTRAINT wishlists_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id)
);



################################################################################
## FILE 2: package.json
## Path: backend/package.json
################################################################################

{
  "name": "backend",
  "version": "0.0.1",
  "description": "",
  "author": "",
  "private": true,
  "license": "UNLICENSED",
  "scripts": {
    "build": "nest build",
    "format": "prettier --write \"src/**/*.ts\" \"test/**/*.ts\"",
    "start": "nest start",
    "start:dev": "nest start --watch",
    "start:debug": "nest start --debug --watch",
    "start:prod": "node dist/main",
    "lint": "eslint \"{src,apps,libs,test}/**/*.ts\" --fix",
    "test": "jest",
    "test:watch": "jest --watch",
    "test:cov": "jest --coverage",
    "test:debug": "node --inspect-brk -r tsconfig-paths/register -r ts-node/register node_modules/.bin/jest --runInBand",
    "test:e2e": "jest --config ./test/jest-e2e.json"
  },
  "dependencies": {
    "@nestjs/common": "^11.0.1",
    "@nestjs/config": "^4.0.2",
    "@nestjs/core": "^11.0.1",
    "@nestjs/jwt": "^11.0.2",
    "@nestjs/passport": "^11.0.5",
    "@nestjs/platform-express": "^11.0.1",
    "@nestjs/serve-static": "^5.0.4",
    "@supabase/supabase-js": "^2.86.2",
    "@types/multer": "^2.0.0",
    "@types/nodemailer": "^7.0.4",
    "axios": "^1.13.2",
    "bcrypt": "^6.0.0",
    "cloudinary": "^2.8.0",
    "next-cloudinary": "^6.17.5",
    "nodemailer": "^7.0.11",
    "passport": "^0.7.0",
    "passport-jwt": "^4.0.1",
    "reflect-metadata": "^0.2.2",
    "rxjs": "^7.8.1",
    "sharp": "^0.34.5",
    "xmlrpc": "^1.3.2"
  },
  "devDependencies": {
    "@eslint/eslintrc": "^3.2.0",
    "@eslint/js": "^9.18.0",
    "@nestjs/cli": "^11.0.0",
    "@nestjs/schematics": "^11.0.0",
    "@nestjs/testing": "^11.0.1",
    "@types/bcrypt": "^6.0.0",
    "@types/express": "^5.0.0",
    "@types/jest": "^30.0.0",
    "@types/node": "^22.10.7",
    "@types/passport-jwt": "^4.0.1",
    "@types/supertest": "^6.0.2",
    "@types/xmlrpc": "^1.3.10",
    "eslint": "^9.18.0",
    "eslint-config-prettier": "^10.0.1",
    "eslint-plugin-prettier": "^5.2.2",
    "globals": "^16.0.0",
    "jest": "^30.0.0",
    "prettier": "^3.4.2",
    "source-map-support": "^0.5.21",
    "supertest": "^7.0.0",
    "ts-jest": "^29.2.5",
    "ts-loader": "^9.5.2",
    "ts-node": "^10.9.2",
    "tsconfig-paths": "^4.2.0",
    "typescript": "^5.7.3",
    "typescript-eslint": "^8.20.0"
  },
  "jest": {
    "moduleFileExtensions": [
      "js",
      "json",
      "ts"
    ],
    "rootDir": "src",
    "testRegex": ".*\\.spec\\.ts$",
    "transform": {
      "^.+\\.(t|j)s$": "ts-jest"
    },
    "collectCoverageFrom": [
      "**/*.(t|j)s"
    ],
    "coverageDirectory": "../coverage",
    "testEnvironment": "node"
  }
}




################################################################################
## FILE 3: nest-cli.json
## Path: backend/nest-cli.json
################################################################################

{
  "$schema": "https://json.schemastore.org/nest-cli",
  "collection": "@nestjs/schematics",
  "sourceRoot": "src",
  "compilerOptions": {
    "deleteOutDir": true
  }
}




################################################################################
## FILE 4: .env
## Path: backend/.env
################################################################################

SUPABASE_URL=https://zrmbsfzamyhbvufvdbwx.supabase.co
SUPABASE_SERVICE_ROLE_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpybWJzZnphbXloYnZ1ZnZkYnd4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE0NzQ3MzgsImV4cCI6MjA3NzA1MDczOH0.r2bZD_FU_8EjuYi9Xl1Wpp3vmIDsOIZpbl7Q0I3QJLY
JWT_SECRET=your-super-secret-jwt-key-here-make-it-long-and-random
PORT=3001



################################################################################
## FILE 5: create_wishlist.sql
## Path: backend/sql/create_wishlist.sql
################################################################################

-- Wishlists table (náº¿u chÆ°a cÃ³)
-- Náº¿u báº£ng wishlists Ä‘Ã£ tá»“n táº¡i, script nÃ y sáº½ khÃ´ng cháº¡y

-- Kiá»ƒm tra cáº¥u trÃºc báº£ng wishlists hiá»‡n cÃ³
-- Cáº§n cÃ³ cÃ¡c cá»™t: id, customer_id, product_id, variant_id, created_at

-- VÃ­ dá»¥ cáº¥u trÃºc:
-- CREATE TABLE IF NOT EXISTS wishlists (
--     id SERIAL PRIMARY KEY,
--     customer_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
--     product_id INTEGER NOT NULL REFERENCES products(product_id) ON DELETE CASCADE,
--     variant_id INTEGER,
--     created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
--     UNIQUE(customer_id, product_id)
-- );

-- Index for faster queries
CREATE INDEX IF NOT EXISTS idx_wishlists_customer_id ON wishlists(customer_id);
CREATE INDEX IF NOT EXISTS idx_wishlists_product_id ON wishlists(product_id);




################################################################################
## FILE 6: create_messenger_orders.sql
## Path: backend/sql/create_messenger_orders.sql
################################################################################

-- =====================================================
-- Táº¡o báº£ng messenger_orders
-- LÆ°u trá»¯ Ä‘Æ¡n hÃ ng tá»« Facebook Messenger Bot
-- =====================================================

-- Táº¡o báº£ng messenger_orders
CREATE TABLE IF NOT EXISTS messenger_orders (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    
    -- ThÃ´ng tin Facebook
    facebook_user_id VARCHAR(255) NOT NULL,
    
    -- ThÃ´ng tin khÃ¡ch hÃ ng
    customer_name VARCHAR(255) NOT NULL,
    phone VARCHAR(20) NOT NULL,
    address TEXT NOT NULL,
    
    -- ThÃ´ng tin sáº£n pháº©m
    product_name VARCHAR(255) NOT NULL,
    product_price DECIMAL(12, 0) NOT NULL DEFAULT 0,
    quantity INTEGER NOT NULL DEFAULT 1,
    color VARCHAR(100),
    
    -- Tá»•ng tiá»n
    total_price DECIMAL(12, 0) NOT NULL DEFAULT 0,
    
    -- Ghi chÃº
    notes TEXT,
    
    -- Tráº¡ng thÃ¡i Ä‘Æ¡n hÃ ng
    -- pending: Chá» xÃ¡c nháº­n
    -- confirmed: ÄÃ£ xÃ¡c nháº­n  
    -- processing: Äang xá»­ lÃ½
    -- shipping: Äang giao hÃ ng
    -- delivered: ÄÃ£ giao hÃ ng
    -- cancelled: ÄÃ£ há»§y
    status VARCHAR(50) NOT NULL DEFAULT 'pending',
    
    -- Timestamps
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Index Ä‘á»ƒ tÃ¬m kiáº¿m nhanh theo facebook_user_id
CREATE INDEX IF NOT EXISTS idx_messenger_orders_facebook_user_id 
ON messenger_orders(facebook_user_id);

-- Index Ä‘á»ƒ tÃ¬m kiáº¿m nhanh theo status
CREATE INDEX IF NOT EXISTS idx_messenger_orders_status 
ON messenger_orders(status);

-- Index Ä‘á»ƒ sáº¯p xáº¿p theo ngÃ y táº¡o
CREATE INDEX IF NOT EXISTS idx_messenger_orders_created_at 
ON messenger_orders(created_at DESC);

-- Index Ä‘á»ƒ tÃ¬m kiáº¿m theo sá»‘ Ä‘iá»‡n thoáº¡i
CREATE INDEX IF NOT EXISTS idx_messenger_orders_phone 
ON messenger_orders(phone);

-- Trigger tá»± Ä‘á»™ng cáº­p nháº­t updated_at
CREATE OR REPLACE FUNCTION update_messenger_orders_updated_at()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = NOW();
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- Táº¡o trigger
DROP TRIGGER IF EXISTS trigger_update_messenger_orders_updated_at ON messenger_orders;
CREATE TRIGGER trigger_update_messenger_orders_updated_at
    BEFORE UPDATE ON messenger_orders
    FOR EACH ROW
    EXECUTE FUNCTION update_messenger_orders_updated_at();

-- Enable Row Level Security (RLS)
ALTER TABLE messenger_orders ENABLE ROW LEVEL SECURITY;

-- Policy cho phÃ©p service role Ä‘á»c táº¥t cáº£
CREATE POLICY "Service role can read all messenger_orders" 
ON messenger_orders FOR SELECT 
TO service_role 
USING (true);

-- Policy cho phÃ©p service role insert
CREATE POLICY "Service role can insert messenger_orders" 
ON messenger_orders FOR INSERT 
TO service_role 
WITH CHECK (true);

-- Policy cho phÃ©p service role update
CREATE POLICY "Service role can update messenger_orders" 
ON messenger_orders FOR UPDATE 
TO service_role 
USING (true);

-- Policy cho phÃ©p authenticated users Ä‘á»c Ä‘Æ¡n cá»§a há» (náº¿u cáº§n)
-- CREATE POLICY "Users can read their own messenger_orders" 
-- ON messenger_orders FOR SELECT 
-- TO authenticated 
-- USING (facebook_user_id = auth.uid()::text);

-- =====================================================
-- Insert dá»¯ liá»‡u máº«u (optional - cÃ³ thá»ƒ comment out)
-- =====================================================

-- INSERT INTO messenger_orders (
--     facebook_user_id,
--     customer_name,
--     phone,
--     address,
--     product_name,
--     product_price,
--     quantity,
--     color,
--     total_price,
--     status
-- ) VALUES 
-- (
--     '1234567890',
--     'Nguyá»…n VÄƒn A',
--     '0912345678',
--     '123 ÄÆ°á»ng ABC, Quáº­n 1, TP.HCM',
--     'á»p Silicone',
--     150000,
--     2,
--     'Äen',
--     300000,
--     'pending'
-- ),
-- (
--     '0987654321',
--     'Tráº§n Thá»‹ B',
--     '0909876543',
--     '456 ÄÆ°á»ng XYZ, Quáº­n 7, TP.HCM',
--     'á»p Leather',
--     200000,
--     1,
--     'NÃ¢u',
--     200000,
--     'confirmed'
-- );

-- =====================================================
-- View thá»‘ng kÃª Ä‘Æ¡n hÃ ng (optional)
-- =====================================================

CREATE OR REPLACE VIEW messenger_orders_stats AS
SELECT 
    COUNT(*) as total_orders,
    COUNT(CASE WHEN status = 'pending' THEN 1 END) as pending_orders,
    COUNT(CASE WHEN status = 'confirmed' THEN 1 END) as confirmed_orders,
    COUNT(CASE WHEN status = 'processing' THEN 1 END) as processing_orders,
    COUNT(CASE WHEN status = 'shipping' THEN 1 END) as shipping_orders,
    COUNT(CASE WHEN status = 'delivered' THEN 1 END) as delivered_orders,
    COUNT(CASE WHEN status = 'cancelled' THEN 1 END) as cancelled_orders,
    SUM(total_price) as total_revenue,
    SUM(CASE WHEN status = 'delivered' THEN total_price ELSE 0 END) as completed_revenue,
    DATE(created_at) as order_date
FROM messenger_orders
GROUP BY DATE(created_at)
ORDER BY order_date DESC;

-- =====================================================
-- Comment giáº£i thÃ­ch cÃ¡c cá»™t
-- =====================================================

COMMENT ON TABLE messenger_orders IS 'Báº£ng lÆ°u trá»¯ Ä‘Æ¡n hÃ ng tá»« Facebook Messenger Bot';
COMMENT ON COLUMN messenger_orders.facebook_user_id IS 'ID ngÆ°á»i dÃ¹ng Facebook (PSID)';
COMMENT ON COLUMN messenger_orders.customer_name IS 'TÃªn khÃ¡ch hÃ ng';
COMMENT ON COLUMN messenger_orders.phone IS 'Sá»‘ Ä‘iá»‡n thoáº¡i liÃªn há»‡';
COMMENT ON COLUMN messenger_orders.address IS 'Äá»‹a chá»‰ giao hÃ ng';
COMMENT ON COLUMN messenger_orders.product_name IS 'TÃªn sáº£n pháº©m Ä‘áº·t mua';
COMMENT ON COLUMN messenger_orders.product_price IS 'GiÃ¡ sáº£n pháº©m (VNÄ)';
COMMENT ON COLUMN messenger_orders.quantity IS 'Sá»‘ lÆ°á»£ng Ä‘áº·t mua';
COMMENT ON COLUMN messenger_orders.color IS 'MÃ u sáº¯c sáº£n pháº©m';
COMMENT ON COLUMN messenger_orders.total_price IS 'Tá»•ng tiá»n Ä‘Æ¡n hÃ ng (VNÄ)';
COMMENT ON COLUMN messenger_orders.status IS 'Tráº¡ng thÃ¡i Ä‘Æ¡n: pending, confirmed, processing, shipping, delivered, cancelled';




################################################################################
## FILE 7: create_gifts.sql
## Path: backend/sql/create_gifts.sql
################################################################################

-- Táº¡o báº£ng gifts Ä‘á»ƒ lÆ°u thÃ´ng tin quÃ  táº·ng
CREATE TABLE IF NOT EXISTS gifts (
    gift_id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    
    -- ThÃ´ng tin ngÆ°á»i gá»­i
    sender_id UUID REFERENCES users(user_id),
    sender_name VARCHAR(255) NOT NULL,
    sender_email VARCHAR(255) NOT NULL,
    sender_message TEXT,
    
    -- ThÃ´ng tin ngÆ°á»i nháº­n
    recipient_name VARCHAR(255) NOT NULL,
    recipient_email VARCHAR(255) NOT NULL,
    recipient_phone VARCHAR(20),
    recipient_address TEXT,
    
    -- ThÃ´ng tin sáº£n pháº©m
    product_id INTEGER REFERENCES products(product_id) NOT NULL,
    quantity INTEGER DEFAULT 1,
    
    -- MÃ£ xÃ¡c nháº­n
    verification_code VARCHAR(10) NOT NULL,
    
    -- Tráº¡ng thÃ¡i: pending, verified, claimed, expired, cancelled
    status VARCHAR(20) DEFAULT 'pending',
    
    -- Thá»i gian
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    verified_at TIMESTAMP WITH TIME ZONE,
    claimed_at TIMESTAMP WITH TIME ZONE,
    expires_at TIMESTAMP WITH TIME ZONE DEFAULT (NOW() + INTERVAL '7 days'),
    
    -- Ghi chÃº
    notes TEXT
);

-- Index Ä‘á»ƒ tÃ¬m kiáº¿m nhanh
CREATE INDEX IF NOT EXISTS idx_gifts_recipient_email ON gifts(recipient_email);
CREATE INDEX IF NOT EXISTS idx_gifts_verification_code ON gifts(verification_code);
CREATE INDEX IF NOT EXISTS idx_gifts_status ON gifts(status);
CREATE INDEX IF NOT EXISTS idx_gifts_sender_id ON gifts(sender_id);

-- Báº£ng lÆ°u lá»‹ch sá»­ email Ä‘Ã£ gá»­i
CREATE TABLE IF NOT EXISTS gift_emails (
    email_id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    gift_id UUID REFERENCES gifts(gift_id) ON DELETE CASCADE,
    email_type VARCHAR(50) NOT NULL, -- notification, reminder, confirmation
    sent_to VARCHAR(255) NOT NULL,
    sent_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    status VARCHAR(20) DEFAULT 'sent' -- sent, failed, bounced
);

-- Comment
COMMENT ON TABLE gifts IS 'Báº£ng lÆ°u thÃ´ng tin quÃ  táº·ng sáº£n pháº©m';
COMMENT ON COLUMN gifts.verification_code IS 'MÃ£ 6 sá»‘ Ä‘á»ƒ xÃ¡c nháº­n nháº­n quÃ ';
COMMENT ON COLUMN gifts.status IS 'pending: chá» xÃ¡c nháº­n, verified: Ä‘Ã£ xÃ¡c nháº­n email, claimed: Ä‘Ã£ nháº­n quÃ , expired: háº¿t háº¡n, cancelled: Ä‘Ã£ há»§y';




################################################################################
## FILE 8: create_designs.sql
## Path: backend/sql/create_designs.sql
################################################################################

-- Báº£ng lÆ°u phone templates (cÃ¡c máº«u Ä‘iá»‡n thoáº¡i cÃ³ sáºµn)
CREATE TABLE IF NOT EXISTS phone_templates (
    template_id SERIAL PRIMARY KEY,
    phone_model VARCHAR(100) NOT NULL, -- iPhone 15, Samsung S24, etc.
    brand VARCHAR(50) NOT NULL, -- Apple, Samsung, Xiaomi, etc.
    template_image_url TEXT NOT NULL, -- áº¢nh template chuáº©n (khung Ä‘iá»‡n thoáº¡i)
    print_width_mm DECIMAL(10,2) DEFAULT 70, -- Chiá»u rá»™ng vÃ¹ng in (mm)
    print_height_mm DECIMAL(10,2) DEFAULT 150, -- Chiá»u cao vÃ¹ng in (mm)
    canvas_width INT DEFAULT 700, -- Chiá»u rá»™ng canvas (px)
    canvas_height INT DEFAULT 1500, -- Chiá»u cao canvas (px)
    is_active BOOLEAN DEFAULT true,
    created_at TIMESTAMP WITHOUT TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

-- Báº£ng lÆ°u cÃ¡c thiáº¿t káº¿ cá»§a khÃ¡ch hÃ ng
CREATE TABLE IF NOT EXISTS custom_designs (
    design_id SERIAL PRIMARY KEY,
    user_id UUID REFERENCES users(id) ON DELETE SET NULL, -- Tham chiáº¿u Ä‘áº¿n users(id) - UUID
    guest_email VARCHAR(255), -- Email khÃ¡ch vÃ£ng lai
    guest_name VARCHAR(100), -- TÃªn khÃ¡ch vÃ£ng lai
    guest_phone VARCHAR(20), -- SÄT khÃ¡ch vÃ£ng lai
    
    -- ThÃ´ng tin template
    template_id INTEGER REFERENCES phone_templates(template_id),
    phone_model VARCHAR(100) NOT NULL,
    
    -- Dá»¯ liá»‡u thiáº¿t káº¿ (JSON tá»« Fabric.js)
    design_data JSONB NOT NULL, -- Chá»©a toÃ n bá»™ canvas data
    preview_image_url TEXT, -- áº¢nh preview cháº¥t lÆ°á»£ng tháº¥p
    high_res_image_url TEXT, -- áº¢nh render cháº¥t lÆ°á»£ng cao (sau khi xá»­ lÃ½)
    
    -- Tráº¡ng thÃ¡i
    status VARCHAR(20) DEFAULT 'draft' CHECK (status IN ('draft', 'submitted', 'processing', 'approved', 'rejected', 'printed')),
    admin_notes TEXT, -- Ghi chÃº cá»§a admin
    
    -- ThÃ´ng tin Ä‘Æ¡n hÃ ng (náº¿u cÃ³)
    order_id INTEGER REFERENCES orders(order_id) ON DELETE SET NULL,
    
    -- Timestamps
    created_at TIMESTAMP WITHOUT TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITHOUT TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    submitted_at TIMESTAMP WITHOUT TIME ZONE, -- Thá»i Ä‘iá»ƒm gá»­i cho admin
    processed_at TIMESTAMP WITHOUT TIME ZONE -- Thá»i Ä‘iá»ƒm admin xá»­ lÃ½ xong
);

-- Báº£ng lÆ°u cÃ¡c áº£nh khÃ¡ch upload cho thiáº¿t káº¿
CREATE TABLE IF NOT EXISTS design_images (
    image_id SERIAL PRIMARY KEY,
    design_id INTEGER REFERENCES custom_designs(design_id) ON DELETE CASCADE,
    original_url TEXT NOT NULL, -- URL áº£nh gá»‘c full resolution
    thumbnail_url TEXT, -- URL áº£nh thumbnail
    file_name VARCHAR(255),
    file_size INT, -- bytes
    width INT,
    height INT,
    created_at TIMESTAMP WITHOUT TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

-- Index Ä‘á»ƒ query nhanh
CREATE INDEX IF NOT EXISTS idx_designs_user_id ON custom_designs(user_id);
CREATE INDEX IF NOT EXISTS idx_designs_status ON custom_designs(status);
CREATE INDEX IF NOT EXISTS idx_designs_order_id ON custom_designs(order_id);
CREATE INDEX IF NOT EXISTS idx_designs_created_at ON custom_designs(created_at DESC);
CREATE INDEX IF NOT EXISTS idx_design_images_design_id ON design_images(design_id);

-- Insert má»™t sá»‘ phone templates máº«u
INSERT INTO phone_templates (phone_model, brand, template_image_url, print_width_mm, print_height_mm) VALUES
('iPhone 15', 'Apple', '/templates/iphone15.svg', 71.6, 147.6),
('iPhone 15 Pro', 'Apple', '/templates/iphone15pro.svg', 70.6, 146.6),
('iPhone 15 Pro Max', 'Apple', '/templates/iphone15promax.svg', 76.7, 159.9),
('iPhone 14', 'Apple', '/templates/iphone14.svg', 71.5, 146.7),
('iPhone 14 Pro', 'Apple', '/templates/iphone14pro.svg', 71.5, 147.5),
('Samsung Galaxy S24', 'Samsung', '/templates/samsung-s24.svg', 70.6, 147.0),
('Samsung Galaxy S24 Ultra', 'Samsung', '/templates/samsung-s24-ultra.svg', 79.0, 162.3),
('Xiaomi 14', 'Xiaomi', '/templates/xiaomi14.svg', 71.5, 152.8),
('OPPO Find X7', 'OPPO', '/templates/oppo-findx7.svg', 74.2, 162.2)
ON CONFLICT DO NOTHING;




################################################################################
## FILE 9: create_contact_messages.sql
## Path: backend/sql/create_contact_messages.sql
################################################################################

-- Táº¡o báº£ng contact_messages Ä‘á»ƒ lÆ°u tin nháº¯n liÃªn há»‡ tá»« khÃ¡ch hÃ ng
CREATE TABLE IF NOT EXISTS contact_messages (
    id SERIAL PRIMARY KEY,
    name VARCHAR(255) NOT NULL,
    email VARCHAR(255) NOT NULL,
    phone VARCHAR(20),
    subject VARCHAR(255),
    message TEXT NOT NULL,
    status VARCHAR(50) DEFAULT 'pending', -- pending, replied, closed
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Táº¡o index cho tÃ¬m kiáº¿m nhanh
CREATE INDEX idx_contact_messages_status ON contact_messages(status);
CREATE INDEX idx_contact_messages_created_at ON contact_messages(created_at DESC);

-- Enable RLS (Row Level Security)
ALTER TABLE contact_messages ENABLE ROW LEVEL SECURITY;

-- Policy cho phÃ©p insert tá»« báº¥t ká»³ ai (anonymous)
CREATE POLICY "Anyone can create contact messages" ON contact_messages
    FOR INSERT WITH CHECK (true);

-- Policy cho phÃ©p admin Ä‘á»c táº¥t cáº£
CREATE POLICY "Admin can view all contact messages" ON contact_messages
    FOR SELECT USING (true);

-- Policy cho phÃ©p admin update
CREATE POLICY "Admin can update contact messages" ON contact_messages
    FOR UPDATE USING (true);

-- Policy cho phÃ©p admin delete
CREATE POLICY "Admin can delete contact messages" ON contact_messages
    FOR DELETE USING (true);




################################################################################
## FILE 10: create_collections.sql
## Path: backend/sql/create_collections.sql
################################################################################

-- Táº¡o báº£ng collections (Bá»™ sÆ°u táº­p)
CREATE TABLE IF NOT EXISTS collections (
    collection_id SERIAL PRIMARY KEY,
    collection_name VARCHAR(100) NOT NULL,
    collection_slug VARCHAR(100) UNIQUE NOT NULL,
    description TEXT,
    image_url TEXT,
    gradient_color VARCHAR(100) DEFAULT 'from-purple-500 to-pink-500',
    icon_name VARCHAR(50) DEFAULT 'Sparkles',
    display_order INT DEFAULT 0,
    is_featured BOOLEAN DEFAULT false,
    is_active BOOLEAN DEFAULT true,
    collection_type VARCHAR(20) DEFAULT 'normal', -- normal, seasonal
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Táº¡o báº£ng liÃªn káº¿t product_collections (1 sáº£n pháº©m cÃ³ thá»ƒ thuá»™c nhiá»u bá»™ sÆ°u táº­p)
CREATE TABLE IF NOT EXISTS product_collections (
    id SERIAL PRIMARY KEY,
    product_id INT NOT NULL REFERENCES products(product_id) ON DELETE CASCADE,
    collection_id INT NOT NULL REFERENCES collections(collection_id) ON DELETE CASCADE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    UNIQUE(product_id, collection_id)
);

-- Táº¡o indexes
CREATE INDEX IF NOT EXISTS idx_collections_slug ON collections(collection_slug);
CREATE INDEX IF NOT EXISTS idx_collections_type ON collections(collection_type);
CREATE INDEX IF NOT EXISTS idx_product_collections_product ON product_collections(product_id);
CREATE INDEX IF NOT EXISTS idx_product_collections_collection ON product_collections(collection_id);

-- Enable RLS
ALTER TABLE collections ENABLE ROW LEVEL SECURITY;
ALTER TABLE product_collections ENABLE ROW LEVEL SECURITY;

-- Policies cho collections
CREATE POLICY "Anyone can view collections" ON collections FOR SELECT USING (true);
CREATE POLICY "Anyone can insert collections" ON collections FOR INSERT WITH CHECK (true);
CREATE POLICY "Anyone can update collections" ON collections FOR UPDATE USING (true);
CREATE POLICY "Anyone can delete collections" ON collections FOR DELETE USING (true);

-- Policies cho product_collections
CREATE POLICY "Anyone can view product_collections" ON product_collections FOR SELECT USING (true);
CREATE POLICY "Anyone can insert product_collections" ON product_collections FOR INSERT WITH CHECK (true);
CREATE POLICY "Anyone can update product_collections" ON product_collections FOR UPDATE USING (true);
CREATE POLICY "Anyone can delete product_collections" ON product_collections FOR DELETE USING (true);

-- Insert cÃ¡c bá»™ sÆ°u táº­p máº·c Ä‘á»‹nh
INSERT INTO collections (collection_name, collection_slug, description, gradient_color, icon_name, display_order, is_featured, collection_type) VALUES
('Luxury Edition', 'luxury-edition', 'Bá»™ sÆ°u táº­p cao cáº¥p vá»›i cháº¥t liá»‡u da tháº­t vÃ  kim loáº¡i nguyÃªn khá»‘i', 'from-amber-500 via-yellow-500 to-orange-500', 'Crown', 1, true, 'normal'),
('Minimalist', 'minimalist', 'Thiáº¿t káº¿ tá»‘i giáº£n, tinh táº¿ cho ngÆ°á»i yÃªu thÃ­ch sá»± Ä‘Æ¡n giáº£n', 'from-gray-700 via-gray-800 to-gray-900', 'Gem', 2, false, 'normal'),
('Artistic Series', 'artistic-series', 'Há»a tiáº¿t nghá»‡ thuáº­t Ä‘á»™c Ä‘Ã¡o tá»« cÃ¡c nghá»‡ sÄ© hÃ ng Ä‘áº§u', 'from-purple-500 via-pink-500 to-red-500', 'Palette', 3, false, 'normal'),
('Gaming Pro', 'gaming-pro', 'DÃ nh cho game thá»§ vá»›i thiáº¿t káº¿ RGB vÃ  grip chá»‘ng trÆ°á»£t', 'from-green-400 via-cyan-500 to-blue-500', 'Zap', 4, false, 'normal'),
('Rugged Armor', 'rugged-armor', 'Báº£o vá»‡ tá»‘i Ä‘a vá»›i chuáº©n quÃ¢n Ä‘á»™i, chá»‘ng va Ä‘áº­p cá»±c tá»‘t', 'from-slate-600 via-slate-700 to-slate-800', 'Shield', 5, false, 'normal'),
('Limited Edition', 'limited-edition', 'PhiÃªn báº£n giá»›i háº¡n, sá»‘ lÆ°á»£ng cÃ³ háº¡n, thiáº¿t káº¿ Ä‘á»™c quyá»n', 'from-rose-500 via-pink-600 to-purple-600', 'Sparkles', 6, true, 'normal'),
('GiÃ¡ng Sinh - Noel', 'giang-sinh-noel', 'Bá»™ sÆ°u táº­p Ä‘áº·c biá»‡t mÃ¹a GiÃ¡ng sinh', 'from-red-600 to-green-600', 'Gift', 7, false, 'seasonal'),
('Valentine', 'valentine', 'Bá»™ sÆ°u táº­p tÃ¬nh yÃªu cho ngÃ y Valentine', 'from-red-400 to-pink-500', 'Heart', 8, false, 'seasonal'),
('Táº¿t NguyÃªn ÄÃ¡n', 'tet-nguyen-dan', 'Bá»™ sÆ°u táº­p Ä‘Ã³n Táº¿t cá»• truyá»n Viá»‡t Nam', 'from-yellow-500 to-red-500', 'Sparkles', 9, false, 'seasonal')
ON CONFLICT (collection_slug) DO NOTHING;




################################################################################
## FILE 11: alter_wishlists.sql
## Path: backend/sql/alter_wishlists.sql
################################################################################

-- ThÃªm cá»™t user_id Ä‘á»ƒ há»— trá»£ users table (UUID)
ALTER TABLE wishlists ADD COLUMN IF NOT EXISTS user_id UUID REFERENCES users(id) ON DELETE CASCADE;

-- Táº¡o unique index Ä‘á»ƒ trÃ¡nh duplicate
CREATE UNIQUE INDEX IF NOT EXISTS idx_wishlists_user_product ON wishlists(user_id, product_id) WHERE user_id IS NOT NULL;




################################################################################
## FILE 12: add_season_column.sql
## Path: backend/sql/add_season_column.sql
################################################################################

-- ThÃªm cá»™t season vÃ o báº£ng products
-- GiÃ¡ trá»‹: NULL (khÃ´ng thuá»™c mÃ¹a nÃ o), 'noel', 'valentine', 'tet'

ALTER TABLE products 
ADD COLUMN IF NOT EXISTS season VARCHAR(20) DEFAULT NULL;

-- Táº¡o index Ä‘á»ƒ query nhanh hÆ¡n
CREATE INDEX IF NOT EXISTS idx_products_season ON products(season);

-- Comment Ä‘á»ƒ giáº£i thÃ­ch
COMMENT ON COLUMN products.season IS 'MÃ¹a lá»…: noel, valentine, tet hoáº·c NULL';




################################################################################
## FILE 13: add_phone_model_to_cart.sql
## Path: backend/sql/add_phone_model_to_cart.sql
################################################################################

-- ThÃªm cá»™t phone_model_id vÃ o báº£ng shopping_carts
-- Äá»ƒ lÆ°u dÃ²ng mÃ¡y Ä‘iá»‡n thoáº¡i ngÆ°á»i dÃ¹ng chá»n khi thÃªm á»‘p vÃ o giá»

ALTER TABLE public.shopping_carts
ADD COLUMN phone_model_id integer,
ADD COLUMN phone_model_name character varying(100);

-- ThÃªm foreign key (optional - cÃ³ thá»ƒ bá» náº¿u muá»‘n linh hoáº¡t hÆ¡n)
-- ALTER TABLE public.shopping_carts
-- ADD CONSTRAINT shopping_carts_phone_model_id_fkey 
--   FOREIGN KEY (phone_model_id) 
--   REFERENCES public.phone_models(model_id);

-- ThÃªm cá»™t phone_model vÃ o order_items Ä‘á»ƒ lÆ°u khi checkout
ALTER TABLE public.order_items
ADD COLUMN phone_model_id integer,
ADD COLUMN phone_model_name character varying(100);

COMMENT ON COLUMN public.shopping_carts.phone_model_id IS 'ID cá»§a dÃ²ng mÃ¡y Ä‘iá»‡n thoáº¡i Ä‘Æ°á»£c chá»n';
COMMENT ON COLUMN public.shopping_carts.phone_model_name IS 'TÃªn dÃ²ng mÃ¡y (backup)';
COMMENT ON COLUMN public.order_items.phone_model_id IS 'ID dÃ²ng mÃ¡y Ä‘Ã£ chá»n khi Ä‘áº·t hÃ ng';
COMMENT ON COLUMN public.order_items.phone_model_name IS 'TÃªn dÃ²ng mÃ¡y (backup)';




################################################################################
## FILE 14: supabase.service.ts
## Path: backend/src/supabase.service.ts
################################################################################

import { Injectable } from '@nestjs/common';
import { createClient } from '@supabase/supabase-js';

@Injectable()
export class SupabaseService {
  private supabase = createClient(
    process.env.SUPABASE_URL || '',
    process.env.SUPABASE_SERVICE_ROLE_KEY || '',
  );

  // ============ USERS ============
  async getCustomers() {
    const { data, error } = await this.supabase.from('users').select('*');
    return { data, error };
  }

  async getCustomerById(customerId: string) {
    const { data, error } = await this.supabase
      .from('users')
      .select('*')
      .eq('id', customerId)
      .single();
    return { data, error };
  }

  async createCustomer(customerData: any) {
    const { data, error } = await this.supabase
      .from('users')
      .insert([customerData])
      .select();
    return { data, error };
  }

  async getCustomerByEmail(email: string) {
    const { data, error } = await this.supabase
      .from('users')
      .select('*')
      .eq('email', email)
      .single();
    return { data, error };
  }

  async loginCustomer(email: string, password: string) {
    const { data, error } = await this.supabase
      .from('users')
      .select('*')
      .eq('email', email)
      .eq('password_hash', password)
      .single();
    return { data, error };
  }

  async createCustomerAddress(addressData: any) {
    const { data, error } = await this.supabase
      .from('customer_addresses')
      .insert([addressData])
      .select();
    return { data, error };
  }

  async getCustomerAddresses(customerId: number) {
    const { data, error } = await this.supabase
      .from('customer_addresses')
      .select('*')
      .eq('customer_id', customerId)
      .order('is_default', { ascending: false });
    return { data, error };
  }

  // ============ PRODUCTS ============
  async getProducts(limit = 10) {
    const { data, error } = await this.supabase
      .from('products')
      .select(`
        *,
        categories (
          category_id,
          category_name
        ),
        product_images (
          image_id,
          image_url,
          is_primary,
          display_order
        )
      `)
      .neq('status', 'deleted')
      .limit(limit);

    const flattenedData = data?.map((p: any) => {
      // tÃ¬m áº£nh chÃ­nh
      const primaryImage =
        p.product_images?.find((img: any) => img.is_primary) ||
        p.product_images?.[0];

      return {
        ...p,
        category_name: p.categories?.category_name || 'KhÃ¡c',
        image_url: primaryImage?.image_url || null,
        images: p.product_images || [],
      };
    });

    return { data: flattenedData, error };
  }


  async getProductById(productId: number) {
    const { data, error } = await this.supabase
      .from('products')
      .select(`
        *,
        categories (
          category_id,
          category_name
        )
      `)
      .eq('product_id', productId)
      .single();
    
    // Flatten category name
    const flattenedData = data ? {
      ...data,
      category_name: data.categories?.category_name || 'KhÃ¡c'
    } : null;
    
    return { data: flattenedData, error };;
  }

  async createProduct(productData: any) {
    const { data, error } = await this.supabase
      .from('products')
      .insert([productData])
      .select();
    return { data, error };
  }

  async updateProduct(productId: number, productData: any) {
    console.log('=== SUPABASE UPDATE ===');
    console.log('Updating product_id:', productId);
    console.log('Raw data received:', JSON.stringify(productData, null, 2));
    
    // Chá»‰ láº¥y cÃ¡c field há»£p lá»‡ trong báº£ng products
    const validFields = [
      'product_name', 'product_slug', 'category_id', 'brand_id', 'sku',
      'description', 'short_description', 'price', 'sale_price', 'cost_price',
      'is_featured', 'is_new', 'is_bestseller', 'is_trending', 'status',
      'meta_title', 'meta_description', 'meta_keywords', 'image_url', 'season'
    ];
    
    const cleanData: any = {};
    for (const field of validFields) {
      if (productData[field] !== undefined) {
        // Xá»­ lÃ½ cÃ¡c giÃ¡ trá»‹ rá»—ng
        if (productData[field] === '' || productData[field] === null) {
          // Cho phÃ©p null cho cÃ¡c field optional
          if (['category_id', 'brand_id', 'sale_price', 'cost_price', 'season', 'image_url'].includes(field)) {
            cleanData[field] = null;
          }
          // Bá» qua string rá»—ng cho cÃ¡c field khÃ¡c
        } else {
          cleanData[field] = productData[field];
        }
      }
    }
    
    // ThÃªm updated_at
    cleanData.updated_at = new Date().toISOString();
    
    console.log('Clean data to update:', JSON.stringify(cleanData, null, 2));
    
    const { data, error } = await this.supabase
      .from('products')
      .update(cleanData)
      .eq('product_id', productId)
      .select();
    
    console.log('Supabase response - data:', JSON.stringify(data, null, 2));
    console.log('Supabase response - error:', error);
    
    return { data, error };
  }

  // Soft delete - Ä‘á»•i status thÃ nh 'deleted' thay vÃ¬ xÃ³a háº³n
  // VÃ¬ sáº£n pháº©m cÃ³ thá»ƒ Ä‘Ã£ cÃ³ trong order_items
  async deleteProduct(productId: number) {
    const { data, error } = await this.supabase
      .from('products')
      .update({ status: 'deleted' })
      .eq('product_id', productId)
      .select();
    return { data, error };
  }

  async getProductsByCategory(categoryId: number) {
    const { data, error } = await this.supabase
      .from('products')
      .select('*')
      .eq('category_id', categoryId);
    return { data, error };
  }

  // ============ PRODUCTS BY SEASON ============
  async getProductsBySeason(season: string) {
    const { data, error } = await this.supabase
      .from('products')
      .select('*')
      .eq('season', season)
      .eq('status', 'active');
    return { data, error };
  }

  async getSeasonProductCounts() {
    const seasons = ['noel', 'valentine', 'tet'];
    const counts: Record<string, number> = {};
    
    for (const season of seasons) {
      const { data, error } = await this.supabase
        .from('products')
        .select('product_id', { count: 'exact' })
        .eq('season', season)
        .eq('status', 'active');
      
      counts[season] = data?.length || 0;
    }
    
    return counts;
  }

  // ============ ORDERS ============
  async getOrders(limit = 20) {
    const { data, error } = await this.supabase
      .from('orders')
      .select('*')
      .order('created_at', { ascending: false })
      .limit(limit);
    return { data, error };
  }

  async getOrderById(orderId: number) {
    const { data, error } = await this.supabase
      .from('orders')
      .select('*')
      .eq('order_id', orderId)
      .single();
    return { data, error };
  }

  async getOrdersByCustomer(customerId: number) {
    const { data, error } = await this.supabase
      .from('orders')
      .select('*')
      .eq('customer_id', customerId)
      .order('created_at', { ascending: false });
    return { data, error };
  }

  async createOrder(orderData: any) {
    const { data, error } = await this.supabase
      .from('orders')
      .insert([orderData])
      .select();
    return { data, error };
  }

  async updateOrderStatus(orderId: number, newStatus: string) {
    const { data, error } = await this.supabase
      .from('orders')
      .update({ order_status: newStatus, updated_at: new Date() })
      .eq('order_id', orderId)
      .select();
    return { data, error };
  }

  async updatePaymentStatus(orderId: number, paymentStatus: string) {
    const { data, error } = await this.supabase
      .from('orders')
      .update({ payment_status: paymentStatus, updated_at: new Date() })
      .eq('order_id', orderId)
      .select();
    return { data, error };
  }

  // ============ ORDER ITEMS ============
  async getOrderItems(orderId: number) {
    const { data, error } = await this.supabase
      .from('order_items')
      .select('*')
      .eq('order_id', orderId);
    return { data, error };
  }

  async createOrderItem(itemData: any) {
    const { data, error } = await this.supabase
      .from('order_items')
      .insert([itemData])
      .select();
    return { data, error };
  }
  // ============ ORDERS - ENHANCED ============

// Táº¡o order vá»›i Ä‘áº§y Ä‘á»§ thÃ´ng tin
async createFullOrder(orderData: {
  customer_id: string;
  order_number: string;
  subtotal: number;
  discount_amount?: number;
  shipping_fee?: number;
  total_amount: number;
  payment_method?: string;
  shipping_address_id?: number;
  customer_note?: string;
  shipping_full_name?: string;
  shipping_phone?: string;
  shipping_address?: string;
  shipping_ward?: string;
  shipping_district?: string;
  shipping_city?: string;
}) {
  const { data, error } = await this.supabase
    .from('orders')
    .insert([{
      ...orderData,
      order_status: 'pending',
      payment_status: 'unpaid',
      created_at: new Date().toISOString(),
      updated_at: new Date().toISOString(),
    }])
    .select();
  return { data, error };
}

// Táº¡o order item vá»›i Ä‘áº§y Ä‘á»§ thÃ´ng tin
async createFullOrderItem(itemData: {
  order_id: number;
  product_id: number;
  //variant_id?: number;
  product_name: string;
  variant_name?: string;
  sku: string;
  quantity: number;
  unit_price: number;
  discount_amount?: number;
  total_price: number;
  phone_model_id?: number | null;
  phone_model_name?: string | null;
}) {
  const { data, error } = await this.supabase
    .from('order_items')
    .insert([itemData])
    .select();
  return { data, error };
}

// Láº¥y order theo order_number
async getOrderByNumber(orderNumber: string) {
  const { data, error } = await this.supabase
    .from('orders')
    .select('*')
    .eq('order_number', orderNumber)
    .single();
  return { data, error };
}

// Láº¥y order vá»›i items
async getOrderWithItems(orderId: number) {
  const { data: order, error: orderError } = await this.supabase
    .from('orders')
    .select('*')
    .eq('order_id', orderId)
    .single();

  if (orderError) return { data: null, error: orderError };

  const { data: items, error: itemsError } = await this.supabase
    .from('order_items')
    .select(`
      *,
      products (
        product_id,
        product_name,
        product_slug,
        price,
        sale_price
      )
    `)
    .eq('order_id', orderId);

  if (itemsError) return { data: order, error: itemsError };

  return { 
    data: { ...order, items: items || [] }, 
    error: null 
  };
}

// Láº¥y order vá»›i items theo order_number
async getOrderWithItemsByNumber(orderNumber: string) {
  const { data: order, error: orderError } = await this.supabase
    .from('orders')
    .select('*')
    .eq('order_number', orderNumber)
    .single();

  if (orderError || !order) return { data: null, error: orderError };

  const { data: items, error: itemsError } = await this.supabase
    .from('order_items')
    .select(`
      *,
      products (
        product_id,
        product_name,
        product_slug
      )
    `)
    .eq('order_id', order.order_id);

  return { 
    data: { ...order, items: items || [] }, 
    error: itemsError 
  };
}

// ============ COLLECTIONS - ENHANCED ============

// Láº¥y táº¥t cáº£ collections (tá»« design_collections)
async getAllDesignCollections() {
  const { data, error } = await this.supabase
    .from('design_collections')
    .select('*')
    .eq('is_active', true)
    .order('display_order', { ascending: true });
  return { data, error };
}

// Láº¥y collection theo type
async getDesignCollectionsByType(type: string) {
  // type: 'normal' hoáº·c 'seasonal'
  const { data, error } = await this.supabase
    .from('design_collections')
    .select('*')
    .eq('is_active', true)
    .ilike('collection_name', type === 'seasonal' ? '%Noel%|%Valentine%|%Táº¿t%' : '%')
    .order('display_order', { ascending: true });
  return { data, error };
}

// Láº¥y collection theo slug
async getDesignCollectionBySlug(slug: string) {
  const { data, error } = await this.supabase
    .from('design_collections')
    .select('*')
    .eq('collection_slug', slug)
    .eq('is_active', true)
    .single();
  return { data, error };
}

// Láº¥y sáº£n pháº©m trong collection
async getProductsByDesignCollection(collectionId: number) {
  const { data: pcData, error: pcError } = await this.supabase
    .from('product_collections')
    .select('product_id')
    .eq('collection_id', collectionId)
    .order('display_order', { ascending: true });

  if (pcError || !pcData || pcData.length === 0) {
    return { data: [], error: pcError };
  }

  const productIds = pcData.map(pc => pc.product_id);

  const { data: products, error: prodError } = await this.supabase
    .from('products')
    .select(`
      *,
      product_images (
        image_url,
        is_primary
      )
    `)
    .in('product_id', productIds)
    .eq('status', 'active');

  return { data: products || [], error: prodError };
}

// Äáº¿m sáº£n pháº©m trong má»—i collection
async getDesignCollectionProductCounts() {
  const { data: collections, error: colError } = await this.supabase
    .from('design_collections')
    .select('collection_id, collection_name, collection_slug')
    .eq('is_active', true);

  if (colError) return { data: null, error: colError };

  const counts: Record<string, number> = {};
  
  for (const col of collections || []) {
    const { data: pcData } = await this.supabase
      .from('product_collections')
      .select('product_id', { count: 'exact' })
      .eq('collection_id', col.collection_id);
    
    counts[col.collection_slug] = pcData?.length || 0;
  }

  return { data: counts, error: null };
}
  // ============ PAYMENT TRANSACTIONS ============
  async createPaymentTransaction(transactionData: any) {
    const { data, error } = await this.supabase
      .from('payment_transactions')
      .insert([transactionData])
      .select();
    return { data, error };
  }

  async getPaymentTransactionsByOrder(orderId: number) {
    const { data, error } = await this.supabase
      .from('payment_transactions')
      .select('*')
      .eq('order_id', orderId);
    return { data, error };
  }

  // ============ INVENTORY ============
  async getInventory(productId: number) {
    const { data, error } = await this.supabase
      .from('inventory')
      .select('*')
      .eq('product_id', productId);
    return { data, error };
  }

  async updateInventory(inventoryId: number, updates: any) {
    const { data, error } = await this.supabase
      .from('inventory')
      .update(updates)
      .eq('inventory_id', inventoryId)
      .select();
    return { data, error };
  }

  // ============ CATEGORIES ============
  async getCategories() {
    const { data, error } = await this.supabase
      .from('categories')
      .select('*')
      .eq('is_active', true)
      .order('display_order', { ascending: true });
    return { data, error };
  }

  async getCategoriesWithProductCount() {
    // Láº¥y táº¥t cáº£ categories
    const { data: categories, error: catError } = await this.supabase
      .from('categories')
      .select('*')
      .eq('is_active', true)
      .order('display_order', { ascending: true });

    if (catError) return { data: null, error: catError };

    // Láº¥y táº¥t cáº£ sáº£n pháº©m (khÃ´ng lá»c status Ä‘á»ƒ Ä‘áº¿m háº¿t)
    const { data: products, error: prodError } = await this.supabase
      .from('products')
      .select('category_id, status');

    if (prodError) return { data: categories, error: prodError };

    // Äáº¿m sá»‘ sáº£n pháº©m theo category_id (cháº¥p nháº­n status: active, Active, hoáº·c khÃ´ng cÃ³ status)
    const productCountMap: Record<number, number> = {};
    products?.forEach((p: any) => {
      if (p.category_id) {
        const status = (p.status || '').toLowerCase();
        // Äáº¿m náº¿u status lÃ  active hoáº·c khÃ´ng cÃ³ status
        if (status === 'active' || status === '' || !p.status) {
          productCountMap[p.category_id] = (productCountMap[p.category_id] || 0) + 1;
        }
      }
    });

    // Gáº¯n sá»‘ lÆ°á»£ng sáº£n pháº©m vÃ o tá»«ng category
    const categoriesWithCount = categories?.map((cat: any) => ({
      ...cat,
      product_count: productCountMap[cat.category_id] || 0
    }));

    return { data: categoriesWithCount, error: null };
  }

  async getCategoryById(categoryId: number) {
    const { data, error } = await this.supabase
      .from('categories')
      .select('*')
      .eq('category_id', categoryId)
      .single();
    return { data, error };
  }

  async getCategoryBySlug(slug: string) {
    const { data, error } = await this.supabase
      .from('categories')
      .select('*')
      .eq('category_slug', slug)
      .eq('is_active', true)
      .single();
    return { data, error };
  }

  async getRootCategories() {
    const { data, error } = await this.supabase
      .from('categories')
      .select('*')
      .is('parent_category_id', null)
      .eq('is_active', true)
      .order('display_order', { ascending: true });
    return { data, error };
  }

  async getChildCategories(parentId: number) {
    const { data, error } = await this.supabase
      .from('categories')
      .select('*')
      .eq('parent_category_id', parentId)
      .eq('is_active', true)
      .order('display_order', { ascending: true });
    return { data, error };
  }

  async createCategory(categoryData: any) {
    const { data, error } = await this.supabase
      .from('categories')
      .insert([categoryData])
      .select();
    return { data, error };
  }

  async updateCategory(categoryId: number, categoryData: any) {
    const { data, error } = await this.supabase
      .from('categories')
      .update(categoryData)
      .eq('category_id', categoryId)
      .select();
    return { data, error };
  }

  // Soft delete - Ä‘á»•i is_active thÃ nh false thay vÃ¬ xÃ³a háº³n
  // VÃ¬ danh má»¥c cÃ³ thá»ƒ Ä‘Ã£ cÃ³ sáº£n pháº©m
  async deleteCategory(categoryId: number) {
    const { data, error } = await this.supabase
      .from('categories')
      .update({ is_active: false })
      .eq('category_id', categoryId)
      .select();
    return { data, error };
  }

  // ============ REVIEWS ============
  async getAllReviews(limit = 50) {
    const { data, error } = await this.supabase
      .from('product_reviews')
      .select('*')
      .order('created_at', { ascending: false })
      .limit(limit);
    return { data, error };
  }

  async getProductReviews(productId: number) {
    const { data, error } = await this.supabase
      .from('product_reviews')
      .select('*')
      .eq('product_id', productId)
      .eq('is_approved', true)
      .order('created_at', { ascending: false });
    return { data, error };
  }

  async getReviewById(reviewId: number) {
    const { data, error } = await this.supabase
      .from('product_reviews')
      .select('*')
      .eq('review_id', reviewId)
      .single();
    return { data, error };
  }

  async createReview(reviewData: any) {
    const { data, error } = await this.supabase
      .from('product_reviews')
      .insert([reviewData])
      .select();
    return { data, error };
  }

  async updateReview(reviewId: number, reviewData: any) {
    const { data, error } = await this.supabase
      .from('product_reviews')
      .update(reviewData)
      .eq('review_id', reviewId)
      .select();
    return { data, error };
  }

  async deleteReview(reviewId: number) {
    const { data, error } = await this.supabase
      .from('product_reviews')
      .delete()
      .eq('review_id', reviewId);
    return { data, error };
  }

  async approveReview(reviewId: number, isApproved: boolean) {
    const { data, error } = await this.supabase
      .from('product_reviews')
      .update({ is_approved: isApproved })
      .eq('review_id', reviewId)
      .select();
    return { data, error };
  }

  // ============ WISHLIST ============
  async getWishlist(customerId: number) {
    const { data, error } = await this.supabase
      .from('wishlists')
      .select('*')
      .eq('customer_id', customerId);
    return { data, error };
  }

  async addToWishlist(customerId: number, productId: number, variantId?: number) {
    const { data, error } = await this.supabase
      .from('wishlists')
      .insert([{ customer_id: customerId, product_id: productId, variant_id: variantId || null }])
      .select();
    return { data, error };
  }

  async removeFromWishlist(customerId: number, productId: number) {
    const { error } = await this.supabase
      .from('wishlists')
      .delete()
      .eq('customer_id', customerId)
      .eq('product_id', productId);
    return { error };
  }

  // ============ COUPONS ============
  async getCoupon(couponCode: string) {
    const { data, error } = await this.supabase
      .from('coupons')
      .select('*')
      .eq('coupon_code', couponCode)
      .eq('is_active', true)
      .single();
    return { data, error };
  }

  // ============ GENERIC QUERY (for any table) ============
  async query(tableName: string, filters?: any, limit?: number) {
    let query = this.supabase.from(tableName).select('*');
    
    if (filters) {
      Object.keys(filters).forEach(key => {
        query = query.eq(key, filters[key]);
      });
    }

    if (limit) {
      query = query.limit(limit);
    }

    const { data, error } = await query;
    return { data, error };
  }

  // ============ CONTACT MESSAGES ============
  async getAllContactMessages(limit = 50) {
    const { data, error } = await this.supabase
      .from('contact_messages')
      .select('*')
      .order('created_at', { ascending: false })
      .limit(limit);
    return { data, error };
  }

  async getContactMessageById(id: number) {
    const { data, error } = await this.supabase
      .from('contact_messages')
      .select('*')
      .eq('id', id)
      .single();
    return { data, error };
  }

  async createContactMessage(messageData: any) {
    const { data, error } = await this.supabase
      .from('contact_messages')
      .insert([messageData])
      .select();
    return { data, error };
  }

  async updateContactMessageStatus(id: number, status: string) {
    const { data, error } = await this.supabase
      .from('contact_messages')
      .update({ status, updated_at: new Date().toISOString() })
      .eq('id', id)
      .select();
    return { data, error };
  }

  async deleteContactMessage(id: number) {
    const { data, error } = await this.supabase
      .from('contact_messages')
      .delete()
      .eq('id', id);
    return { data, error };
  }
    // ============ SHOPPING CART ============
  // async createProduct(productData: any) {
  //   const { data, error } = await this.supabase
  //     .from('products')
  //     .insert([productData])
  //     .select();
  //   return { data, error };
  // }
  // CREATE: thÃªm sáº£n pháº©m vÃ o giá»
  // async createShoppingCart(cartData: any) {
  //   const { data, error } = await this.supabase
  //     .from('shopping_carts')
  //     .insert([cartData])
  //     .select();
  //     // .single();

  //   return { data, error };
  // }

  // // READ: láº¥y giá» hÃ ng theo customer
  // // async getShoppingCart(customerId: number) {
  // //   const { data, error } = await this.supabase
  // //     .from('shopping_carts')
  // //     .select('*')
  // //     .eq('customer_id', customerId)
  // //     .order('created_at', { ascending: false });

  // //   return { data, error };
  // // }

  // // UPDATE: cáº­p nháº­t sá»‘ lÆ°á»£ng
  // async updateShoppingCart(
  //   cartId: number,
  //   quantity: number,
  // ) {
  //   const { data, error } = await this.supabase
  //     .from('shopping_carts')
  //     .update({
  //       quantity,
  //       updated_at: new Date().toISOString(),
  //     })
  //     .eq('cart_id', cartId)
  //     .select()
  //     .single();

  //   return { data, error };
  // }

  // // DELETE: xÃ³a sáº£n pháº©m khá»i giá»
  // async deleteShoppingCart(cartId: number) {
  //   const { data, error } = await this.supabase
  //     .from('shopping_carts')
  //     .delete()
  //     .eq('cart_id', cartId);

  //   return { data, error };
  // }
  // async getCartItemByUserAndProduct(
  //   userId: string,
  //   productId: number,
  // ) {
  //   const { data, error } = await this.supabase
  //     .from('shopping_carts')
  //     .select('*')
  //     .eq('customer_id', userId)
  //     .eq('product_id', productId)
  //     .single();

  //   return { data, error };
  // }
  // async getCartItemById(cartId: string) {
  //   const { data, error } = await this.supabase
  //     .from('shopping_carts')
  //     .select('*')
  //     .eq('cart_id', cartId)
  //     .single();

  //   return { data, error };
  // }
  // async getShoppingCart(customerId: string) {
  //   const { data, error } = await this.supabase
  //     .from('shopping_carts')
  //     .select('*')
  //     .eq('customer_id', customerId)
  //     .order('created_at', { ascending: false });

  //   return { data, error };
  // }
  // ============ SHOPPING CART (Cáº¬P NHáº¬T) ============

/**
 * Láº¥y giá» hÃ ng theo user_id (UUID) - JOIN vá»›i products vÃ  product_images
 */
async getShoppingCartByUserId(userId: string) {
  const { data, error } = await this.supabase
    .from('shopping_carts')
    .select(`
      cart_id,
      customer_id,
      product_id,
      variant_id,
      quantity,
      created_at,
      updated_at,
      products (
        product_id,
        product_name,
        price,
        sale_price,
        status,
        product_images (
          image_url,
          is_primary
        )
      )
    `)
    .eq('customer_id', userId)
    .order('created_at', { ascending: false });

  return { data, error };
}

/**
 * Kiá»ƒm tra sáº£n pháº©m Ä‘Ã£ cÃ³ trong giá» chÆ°a (cÃ³ thá»ƒ check theo phone_model_id)
 */
async getCartItemByUserAndProduct(userId: string, productId: number, phoneModelId?: number) {
  let query = this.supabase
    .from('shopping_carts')
    .select('*')
    .eq('customer_id', userId)
    .eq('product_id', productId);
    
  // Náº¿u cÃ³ phoneModelId, check cáº£ phone model
  if (phoneModelId) {
    query = query.eq('phone_model_id', phoneModelId);
  } else {
    query = query.is('phone_model_id', null);
  }

  const { data, error } = await query.maybeSingle();  // DÃ¹ng maybeSingle thay vÃ¬ single Ä‘á»ƒ trÃ¡nh lá»—i khi khÃ´ng cÃ³ data

  return { data, error };
}

/**
 * ThÃªm sáº£n pháº©m vÃ o giá»
 */
/**
 * Map tá»« users.id (UUID) sang customers.customer_id (INTEGER)
 * VÃ¬ 2 báº£ng liÃªn káº¿t qua email
 */
async createShoppingCartItem(cartData: {
  customer_id: string;  // UUID tá»« users.id
  product_id: number;
  variant_id?: number | null;
  phone_model_id?: number | null;
  phone_model_name?: string | null;
  quantity: number;
}) {
  const { data, error } = await this.supabase
    .from('shopping_carts')
    .insert([{
      customer_id: cartData.customer_id,  // âœ… UUID trá»±c tiáº¿p, khÃ´ng cáº§n map
      product_id: cartData.product_id,
      variant_id: cartData.variant_id || null,
      phone_model_id: cartData.phone_model_id || null,
      phone_model_name: cartData.phone_model_name || null,
      quantity: cartData.quantity,
    }])
    .select(`*`)
    .single();

  return { data, error };
}

/**
 * Cáº­p nháº­t sá»‘ lÆ°á»£ng
 */
async updateShoppingCartQuantity(cartId: number, quantity: number) {
  const { data, error } = await this.supabase
    .from('shopping_carts')
    .update({
      quantity,
      updated_at: new Date().toISOString(),
    })
    .eq('cart_id', cartId)
    .select(`
      cart_id,
      customer_id,
      product_id,
      quantity,
      products (
        product_id,
        product_name,
        price,
        sale_price
      )
    `)
    .single();

  return { data, error };
}

/**
 * XÃ³a item khá»i giá»
 */
async deleteShoppingCartItem(cartId: number) {
  const { data, error } = await this.supabase
    .from('shopping_carts')
    .delete()
    .eq('cart_id', cartId);

  return { data, error };
}

/**
 * XÃ³a toÃ n bá»™ giá» hÃ ng cá»§a user
 */
async clearShoppingCart(userId: string) {
  const { data, error } = await this.supabase
    .from('shopping_carts')
    .delete()
    .eq('customer_id', userId);

  return { data, error };
}

/**
 * Láº¥y cart item theo ID (Ä‘á»ƒ verify ownership)
 */
async getCartItemById(cartId: number) {
  const { data, error } = await this.supabase
    .from('shopping_carts')
    .select('*')
    .eq('cart_id', cartId)
    .single();

  return { data, error };
}

// ============ WISHLIST ============

/**
 * Láº¥y danh sÃ¡ch yÃªu thÃ­ch cá»§a user (dÃ¹ng user_id UUID)
 */
async getWishlistByUserId(userId: string) {
  const { data, error } = await this.supabase
    .from('wishlists')
    .select(`
      wishlist_id,
      product_id,
      created_at,
      products (
        product_id,
        product_name,
        price,
        sale_price,
        image_url,
        description
      )
    `)
    .eq('user_id', userId)
    .order('created_at', { ascending: false });

  return { data, error };
}

/**
 * Láº¥y danh sÃ¡ch product_id trong wishlist cá»§a user
 */
async getWishlistProductIds(userId: string) {
  const { data, error } = await this.supabase
    .from('wishlists')
    .select('product_id')
    .eq('user_id', userId);

  return { data, error };
}

/**
 * ThÃªm sáº£n pháº©m vÃ o wishlist (user_id dáº¡ng UUID)
 */
async addProductToWishlist(userId: string, productId: number) {
  const { data, error } = await this.supabase
    .from('wishlists')
    .insert({
      user_id: userId,
      product_id: productId,
    })
    .select()
    .single();

  return { data, error };
}

/**
 * XÃ³a sáº£n pháº©m khá»i wishlist (user_id dáº¡ng UUID)
 */
async removeProductFromWishlist(userId: string, productId: number) {
  const { data, error } = await this.supabase
    .from('wishlists')
    .delete()
    .eq('user_id', userId)
    .eq('product_id', productId);

  return { data, error };
}

/**
 * Kiá»ƒm tra sáº£n pháº©m cÃ³ trong wishlist khÃ´ng
 */
async getWishlistItem(userId: string, productId: number) {
  const { data, error } = await this.supabase
    .from('wishlists')
    .select('wishlist_id')
    .eq('user_id', userId)
    .eq('product_id', productId)
    .single();

  return { data, error };
}

// ============ GIFTS ============

/**
 * Táº¡o quÃ  táº·ng má»›i
 */
async createGift(giftData: {
  sender_id?: string;
  sender_name: string;
  sender_email: string;
  sender_message?: string;
  recipient_name: string;
  recipient_email: string;
  recipient_phone?: string;
  recipient_address?: string;
  product_id: number;
  quantity: number;
  verification_code: string;
}) {
  const { data, error } = await this.supabase
    .from('gifts')
    .insert(giftData)
    .select()
    .single();
  return { data, error };
}

/**
 * Láº¥y thÃ´ng tin quÃ  táº·ng theo ID
 */
async getGiftById(giftId: string) {
  const { data, error } = await this.supabase
    .from('gifts')
    .select(`
      *,
      products (
        product_id,
        product_name,
        price,
        sale_price,
        image_url,
        product_images (
          image_url,
          is_primary
        )
      )
    `)
    .eq('gift_id', giftId)
    .single();
  return { data, error };
}

/**
 * Láº¥y thÃ´ng tin quÃ  táº·ng cÃ´ng khai (khÃ´ng cÃ³ verification_code)
 */
async getGiftPublicInfo(giftId: string) {
  const { data, error } = await this.supabase
    .from('gifts')
    .select(`
      gift_id,
      sender_name,
      sender_message,
      recipient_name,
      recipient_email,
      status,
      created_at,
      expires_at,
      products (
        product_id,
        product_name,
        price,
        sale_price,
        image_url,
        product_images (
          image_url,
          is_primary
        )
      )
    `)
    .eq('gift_id', giftId)
    .single();
  return { data, error };
}

/**
 * Cáº­p nháº­t tráº¡ng thÃ¡i quÃ  táº·ng
 */
async updateGiftStatus(giftId: string, status: string, extraData?: any) {
  const updateData: any = { status, ...extraData };
  
  if (status === 'verified') {
    updateData.verified_at = new Date().toISOString();
  } else if (status === 'claimed') {
    updateData.claimed_at = new Date().toISOString();
  }

  const { data, error } = await this.supabase
    .from('gifts')
    .update(updateData)
    .eq('gift_id', giftId)
    .select()
    .single();
  return { data, error };
}

/**
 * LÆ°u lá»‹ch sá»­ email quÃ  táº·ng
 */
async createGiftEmail(emailData: {
  gift_id: string;
  email_type: string;
  sent_to: string;
  status?: string;
}) {
  const { data, error } = await this.supabase
    .from('gift_emails')
    .insert(emailData)
    .select()
    .single();
  return { data, error };
}

/**
 * Láº¥y danh sÃ¡ch quÃ  Ä‘Ã£ gá»­i theo user
 */
async getSentGifts(userId: string) {
  const { data, error } = await this.supabase
    .from('gifts')
    .select(`
      *,
      products (
        product_name,
        price,
        sale_price,
        image_url,
        product_images (image_url, is_primary)
      )
    `)
    .eq('sender_id', userId)
    .order('created_at', { ascending: false });
  return { data, error };
}

/**
 * Láº¥y danh sÃ¡ch quÃ  Ä‘Ã£ nháº­n theo email
 */
async getReceivedGifts(email: string) {
  const { data, error } = await this.supabase
    .from('gifts')
    .select(`
      *,
      products (
        product_name,
        price,
        sale_price,
        image_url,
        product_images (image_url, is_primary)
      )
    `)
    .eq('recipient_email', email)
    .order('created_at', { ascending: false });
  return { data, error };
}

// ============ PHONE TEMPLATES ============

/**
 * Láº¥y danh sÃ¡ch phone templates
 */
async getPhoneTemplates() {
  const { data, error } = await this.supabase
    .from('phone_templates')
    .select('*')
    .eq('is_active', true)
    .order('brand', { ascending: true });
  return { data, error };
}

/**
 * Láº¥y phone template theo ID
 */
async getPhoneTemplateById(templateId: number) {
  const { data, error } = await this.supabase
    .from('phone_templates')
    .select('*')
    .eq('template_id', templateId)
    .single();
  return { data, error };
}

/**
 * Táº¡o phone template má»›i
 */
async createPhoneTemplate(templateData: any) {
  const { data, error } = await this.supabase
    .from('phone_templates')
    .insert(templateData)
    .select()
    .single();
  return { data, error };
}

/**
 * Cáº­p nháº­t phone template
 */
async updatePhoneTemplate(templateId: number, templateData: any) {
  const { data, error } = await this.supabase
    .from('phone_templates')
    .update(templateData)
    .eq('template_id', templateId)
    .select()
    .single();
  return { data, error };
}

/**
 * XÃ³a phone template
 */
async deletePhoneTemplate(templateId: number) {
  const { error } = await this.supabase
    .from('phone_templates')
    .delete()
    .eq('template_id', templateId);
  return { error };
}

// ============ CUSTOM DESIGNS ============

/**
 * Táº¡o thiáº¿t káº¿ má»›i
 */
async createDesign(designData: any) {
  const { data, error } = await this.supabase
    .from('custom_designs')
    .insert(designData)
    .select()
    .single();
  return { data, error };
}

/**
 * Láº¥y thiáº¿t káº¿ theo ID
 */
async getDesignById(designId: number) {
  const { data, error } = await this.supabase
    .from('custom_designs')
    .select(`
      *,
      phone_templates (
        phone_model,
        brand,
        template_image_url
      )
    `)
    .eq('design_id', designId)
    .single();
  return { data, error };
}

/**
 * Cáº­p nháº­t thiáº¿t káº¿
 */
async updateDesign(designId: number, updateData: any) {
  const { data, error } = await this.supabase
    .from('custom_designs')
    .update(updateData)
    .eq('design_id', designId)
    .select()
    .single();
  return { data, error };
}

/**
 * Láº¥y danh sÃ¡ch thiáº¿t káº¿ cá»§a user
 */
async getUserDesigns(userId: string) {
  const { data, error } = await this.supabase
    .from('custom_designs')
    .select(`
      *,
      phone_templates (
        phone_model,
        brand,
        template_image_url
      )
    `)
    .eq('user_id', userId)
    .order('created_at', { ascending: false });
  return { data, error };
}

/**
 * Láº¥y táº¥t cáº£ thiáº¿t káº¿ (admin)
 */
async getAllDesigns(status?: string) {
  let query = this.supabase
    .from('custom_designs')
    .select(`
      *,
      phone_templates (
        phone_model,
        brand,
        template_image_url
      ),
      users (
        full_name,
        email,
        phone
      )
    `)
    .order('submitted_at', { ascending: false, nullsFirst: false });

  if (status) {
    query = query.eq('status', status);
  }

  const { data, error } = await query;
  return { data, error };
}

/**
 * XÃ³a thiáº¿t káº¿
 */
async deleteDesign(designId: number) {
  const { error } = await this.supabase
    .from('custom_designs')
    .delete()
    .eq('design_id', designId);
  return { error };
}

/**
 * LÆ°u áº£nh thiáº¿t káº¿
 */
async createDesignImage(imageData: any) {
  const { data, error } = await this.supabase
    .from('design_images')
    .insert(imageData)
    .select()
    .single();
  return { data, error };
}

/**
 * Láº¥y danh sÃ¡ch áº£nh cá»§a thiáº¿t káº¿
 */
async getDesignImages(designId: number) {
  const { data, error } = await this.supabase
    .from('design_images')
    .select('*')
    .eq('design_id', designId)
    .order('created_at', { ascending: true });
  return { data, error };
}

}




################################################################################
## FILE 15: main.ts
## Path: backend/src/main.ts
################################################################################

import { NestFactory } from '@nestjs/core';
import { AppModule } from './app.module';
import { json, urlencoded } from 'express';
import { NestExpressApplication } from '@nestjs/platform-express';
import { join } from 'path';

async function bootstrap() {
  const app = await NestFactory.create<NestExpressApplication>(AppModule);

  // TÄƒng giá»›i háº¡n body size Ä‘á»ƒ upload áº£nh base64
  app.use(json({ limit: '50mb' }));
  app.use(urlencoded({ extended: true, limit: '50mb' }));

  // Serve static files tá»« thÆ° má»¥c uploads
  app.useStaticAssets(join(process.cwd(), 'uploads'), {
    prefix: '/uploads/',
  });

  app.enableCors({
    origin: 'http://localhost:3000',
    credentials: true,
  });

  await app.listen(process.env.PORT ?? 3001);
}
bootstrap();




################################################################################
## FILE 16: app.service.ts
## Path: backend/src/app.service.ts
################################################################################

import { Injectable } from '@nestjs/common';
import { SupabaseService } from './supabase.service';

@Injectable()
export class AppService {
  constructor(private readonly supabaseService: SupabaseService) {}

  getHello(): string {
    return 'Hello World!';
  }

  // Tá»•ng há»£p sá»‘ liá»‡u dashboard admin
  async getAdminDashboard() {
    // Tá»•ng doanh thu
    const ordersRes = await this.supabaseService.getOrders(1000);
    const orders = ordersRes.data || [];
    const totalRevenue = orders.reduce((sum, o) => sum + (o.total_amount || 0), 0);
    // Sá»‘ Ä‘Æ¡n hÃ ng
    const orderCount = orders.length;
    // Sá»‘ sáº£n pháº©m
    const productsRes = await this.supabaseService.getProducts(1000);
    const products = productsRes.data || [];
    const productCount = products.length;
    // Sá»‘ khÃ¡ch hÃ ng
    const customersRes = await this.supabaseService.getCustomers();
    const customers = customersRes.data || [];
    const customerCount = customers.length;
    // Doanh thu 7 ngÃ y qua
    const now = new Date();
    const revenue7Days = Array(7).fill(0);
    for (const o of orders) {
      if (o.created_at) {
        const d = new Date(o.created_at);
        const diff = Math.floor((now.getTime() - d.getTime()) / (1000*60*60*24));
        if (diff >= 0 && diff < 7) {
          revenue7Days[6-diff] += o.total_amount || 0;
        }
      }
    }
    // Top sáº£n pháº©m bÃ¡n cháº¡y
    const productSales: Record<string, {name: string, sold: number, revenue: number}> = {};
    for (const o of orders) {
      if (Array.isArray(o.products)) {
        for (const p of o.products) {
          const key = String(p.id);
          if (!productSales[key]) {
            const prod = products.find(pr => pr.id == p.id) || {};
            productSales[key] = { name: prod.name || '', sold: 0, revenue: 0 };
          }
          productSales[key].sold += p.quantity || 0;
          productSales[key].revenue += (p.quantity || 0) * (p.price || 0);
        }
      }
    }
    const bestSellers = Object.entries(productSales)
      .sort((a,b) => b[1].sold - a[1].sold)
      .slice(0,5)
      .map(([id, info]) => ({ id, ...info }));

    return {
      totalRevenue,
      orderCount,
      productCount,
      customerCount,
      revenue7Days,
      bestSellers
    };
  }
}




################################################################################
## FILE 17: app.module.ts
## Path: backend/src/app.module.ts
################################################################################

import { Module } from '@nestjs/common';
import { ConfigModule } from '@nestjs/config';
import { ServeStaticModule } from '@nestjs/serve-static';
import { join } from 'path';
import { AppController } from './app.controller';
import { AppService } from './app.service';
import { PaymentController } from './payment/payment.controller';
import { SupabaseService } from './supabase.service';
import { AuthModule } from './auth/auth.module';
import { ProductModule } from './product/product.module';
import { OrderModule } from './order/order.module';
import { CategoryModule } from './category/category.module';
import { UsersModule } from './users/users.module';
import { ReviewModule } from './review/review.module';
import { ContactModule } from './contact/contact.module';
import { CollectionModule } from './collection/collection.module';
import { ShoppingCartModule } from './shopping-cart/shopping-cart.module';
import { WishlistModule } from './wishlist/wishlist.module';
import { GiftModule } from './gift/gift.module';
import { DesignModule } from './design/design.module';
import { MessengerModule } from './messenger/messenger.module';
import { PhoneModelModule } from './phone-model/phone-model.module';

@Module({
  imports: [
    ConfigModule.forRoot(),
    ServeStaticModule.forRoot({
      rootPath: join(__dirname, '..', 'uploads'),
      serveRoot: '/uploads',
    }),
    AuthModule,
    ProductModule,
    OrderModule,
    CategoryModule,
    UsersModule,
    ReviewModule,
    ContactModule,
    CollectionModule,
    ShoppingCartModule,
    WishlistModule,
    GiftModule,
    DesignModule,
    MessengerModule,
    PhoneModelModule,
  ],
  controllers: [AppController, PaymentController],
  providers: [AppService, SupabaseService],
})
export class AppModule {}




################################################################################
## FILE 18: app.controller.ts
## Path: backend/src/app.controller.ts
################################################################################

import { Controller, Get } from '@nestjs/common';
import { AppService } from './app.service';

@Controller()
export class AppController {
  constructor(private readonly appService: AppService) {}

  @Get()
  getHello(): string {
    return this.appService.getHello();
  }

  // API tá»•ng há»£p sá»‘ liá»‡u dashboard admin
  @Get('admin/dashboard')
  async getAdminDashboard() {
    return await this.appService.getAdminDashboard();
  }
}




################################################################################
## FILE 19: app.controller.spec.ts
## Path: backend/src/app.controller.spec.ts
################################################################################

import { Test, TestingModule } from '@nestjs/testing';
import { AppController } from './app.controller';
import { AppService } from './app.service';

describe('AppController', () => {
  let appController: AppController;

  beforeEach(async () => {
    const app: TestingModule = await Test.createTestingModule({
      controllers: [AppController],
      providers: [AppService],
    }).compile();

    appController = app.get<AppController>(AppController);
  });

  describe('root', () => {
    it('should return "Hello World!"', () => {
      expect(appController.getHello()).toBe('Hello World!');
    });
  });
});




################################################################################
## FILE 20: supabase.strategy.ts
## Path: backend/src/auth/supabase.strategy.ts
################################################################################

import { Injectable } from '@nestjs/common';
import { PassportStrategy } from '@nestjs/passport';
import { ExtractJwt, Strategy } from 'passport-jwt';
import { ConfigService } from '@nestjs/config';

@Injectable()
export class SupabaseStrategy extends PassportStrategy(Strategy, 'jwt') {
  constructor(private readonly configService: ConfigService) {
    super({
      jwtFromRequest: ExtractJwt.fromAuthHeaderAsBearerToken(),
      ignoreExpiration: false,
      secretOrKey: configService.get<string>('SUPABASE_JWT_SECRET')!,
    });
  }

  async validate(payload: any) {
    // Tráº£ vá» object user vá»›i role máº·c Ä‘á»‹nh lÃ  customer náº¿u chÆ°a cÃ³
    return { 
      userId: payload.sub, 
      email: payload.email,
      role: payload.user_metadata?.role || 'customer',
    };
  }
}



################################################################################
## FILE 21: auth.service.ts
## Path: backend/src/auth/auth.service.ts
################################################################################

import { 
  Injectable, 
  UnauthorizedException, 
  BadRequestException, 
  Logger,
  ConflictException 
} from '@nestjs/common';
import { ConfigService } from '@nestjs/config';
import { createClient, SupabaseClient } from '@supabase/supabase-js';
import * as bcrypt from 'bcrypt';
import { UserRole } from '../common';
import type { AuthenticatedUser } from '../common';
import { JwtService } from '@nestjs/jwt';

@Injectable()
export class AuthService {
  private readonly logger = new Logger(AuthService.name);
  private supabase: SupabaseClient;
  private readonly SALT_ROUNDS = 10;

  constructor(
    private configService: ConfigService,
    private jwtService: JwtService,
  ) {
    this.supabase = createClient(
      this.configService.get<string>('SUPABASE_URL')!,
      this.configService.get<string>('SUPABASE_SERVICE_ROLE_KEY')!,
    );
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // ÄÄ‚NG KÃ TÃ€I KHOáº¢N Má»šI
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  async register(userData: {
    email: string;
    password: string;
    full_name: string;
    phone?: string;
  }) {
    try {
      const { email, password, full_name, phone } = userData;

      // 1. Validate input
      if (!email || !password || !full_name) {
        throw new BadRequestException('Email, password vÃ  há» tÃªn lÃ  báº¯t buá»™c');
      }

      if (password.length < 6) {
        throw new BadRequestException('Máº­t kháº©u pháº£i cÃ³ Ã­t nháº¥t 6 kÃ½ tá»±');
      }

      // 2. Kiá»ƒm tra email Ä‘Ã£ tá»“n táº¡i chÆ°a
      const { data: existingUser, error: checkError } = await this.supabase
        .from('users')
        .select('id')
        .eq('email', email.toLowerCase().trim())
        .single();

      if (existingUser) {
        throw new ConflictException('Email Ä‘Ã£ Ä‘Æ°á»£c sá»­ dá»¥ng');
      }

      // 3. Hash password vá»›i bcrypt
      const hashedPassword = await bcrypt.hash(password, this.SALT_ROUNDS);

      // 4. Táº¡o user má»›i trong báº£ng users
      const { data: newUser, error: insertError } = await this.supabase
        .from('users')
        .insert({
          email: email.toLowerCase().trim(),
          password_hash: hashedPassword,
          full_name: full_name.trim(),
          phone: phone?.trim() || null,
          role: 'customer',
          status: 'active',
          email_verified: false,
          is_admin: false,
        })
        .select()
        .single();

      if (insertError) {
        this.logger.error(`Register insert error: ${insertError.message}`);
        throw new BadRequestException(`KhÃ´ng thá»ƒ táº¡o tÃ i khoáº£n: ${insertError.message}`);
      }

      this.logger.log(`User registered successfully: ${email}`);

      return {
        success: true,
        message: 'ÄÄƒng kÃ½ thÃ nh cÃ´ng! Báº¡n cÃ³ thá»ƒ Ä‘Äƒng nháº­p ngay.',
        user: {
          id: newUser.id,
          email: newUser.email,
          full_name: newUser.full_name,
          phone: newUser.phone,
          role: newUser.role,
          created_at: newUser.created_at,
        },
      };

    } catch (error: any) {
      this.logger.error(`Register error: ${error.message}`);
      
      if (error instanceof BadRequestException || error instanceof ConflictException) {
        throw error;
      }
      
      throw new BadRequestException(error.message || 'ÄÄƒng kÃ½ tháº¥t báº¡i');
    }
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // ÄÄ‚NG NHáº¬P
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  async login(email: string, password: string) {
    try {
      // 1. Validate input
      if (!email || !password) {
        throw new BadRequestException('Email vÃ  máº­t kháº©u lÃ  báº¯t buá»™c');
      }

      // 2. TÃ¬m user theo email
      const { data: userData, error: dbError } = await this.supabase
        .from('users')
        .select('*')
        .eq('email', email.toLowerCase().trim())
        .single();

      if (dbError || !userData) {
        this.logger.warn(`Login failed: User not found - ${email}`);
        throw new UnauthorizedException('Email hoáº·c máº­t kháº©u khÃ´ng Ä‘Ãºng');
      }

      // 3. Kiá»ƒm tra status
      if (userData.status !== 'active') {
        throw new UnauthorizedException('TÃ i khoáº£n Ä‘Ã£ bá»‹ khÃ³a');
      }

      // 4. So sÃ¡nh password vá»›i bcrypt
      const isPasswordValid = await bcrypt.compare(password, userData.password_hash);

      if (!isPasswordValid) {
        this.logger.warn(`Login failed: Wrong password - ${email}`);
        throw new UnauthorizedException('Email hoáº·c máº­t kháº©u khÃ´ng Ä‘Ãºng');
      }

      // 5. Táº¡o JWT payload
      const payload = {
        sub: userData.id,              // userId
        email: userData.email,
        role: userData.is_admin ? 'admin' : userData.role,
      };

      // 6. Sign JWT
      const access_token = this.jwtService.sign(payload);

      // 7. Cáº­p nháº­t last_login_at
      await this.supabase
        .from('users')
        .update({ last_login_at: new Date().toISOString() })
        .eq('id', userData.id);

      this.logger.log(`User logged in successfully: ${email}`);

      // 8. Tráº£ vá» thÃ´ng tin user (khÃ´ng cÃ³ password)
      return {
        success: true,
        message: 'ÄÄƒng nháº­p thÃ nh cÃ´ng',
        access_token,
        user: {
          id: userData.id,
          email: userData.email,
          full_name: userData.full_name,
          phone: userData.phone,
          avatar_url: userData.avatar_url,
          address: userData.address,
          role: userData.role,
          is_admin: userData.is_admin,
          created_at: userData.created_at,
        },
        role: userData.is_admin ? 'admin' : userData.role,
      };

    } catch (error: any) {
      this.logger.error(`Login error: ${error.message}`);
      
      if (error instanceof UnauthorizedException || error instanceof BadRequestException) {
        throw error;
      }
      
      throw new UnauthorizedException('ÄÄƒng nháº­p tháº¥t báº¡i');
    }
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // VALIDATE TOKEN (Sá»¬A Äá»‚ DÃ™NG CUSTOM JWT)
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  async validateToken(token: string): Promise<AuthenticatedUser> {
    try {
      // ðŸ”§ Sá»¬A: Verify Custom JWT thay vÃ¬ dÃ¹ng Supabase Auth
      let payload: any;
      
      try {
        payload = this.jwtService.verify(token);
      } catch (jwtError: any) {
        this.logger.error(`JWT verify error: ${jwtError.message}`);
        throw new UnauthorizedException('Token khÃ´ng há»£p lá»‡ hoáº·c Ä‘Ã£ háº¿t háº¡n');
      }

      // Kiá»ƒm tra payload cÃ³ Ä‘á»§ thÃ´ng tin khÃ´ng
      if (!payload.sub || !payload.email) {
        throw new UnauthorizedException('Token khÃ´ng chá»©a Ä‘á»§ thÃ´ng tin');
      }

      // Láº¥y thÃ´ng tin user tá»« báº£ng users Ä‘á»ƒ Ä‘áº£m báº£o user cÃ²n tá»“n táº¡i vÃ  active
      const { data: userData, error: dbError } = await this.supabase
        .from('users')
        .select('*')
        .eq('id', payload.sub)
        .single();

      if (dbError || !userData) {
        this.logger.error(`User not found for token: ${payload.sub}`);
        throw new UnauthorizedException('KhÃ´ng tÃ¬m tháº¥y thÃ´ng tin user');
      }

      // Kiá»ƒm tra user cÃ²n active khÃ´ng
      if (userData.status !== 'active') {
        throw new UnauthorizedException('TÃ i khoáº£n Ä‘Ã£ bá»‹ khÃ³a');
      }

      return {
        id: userData.id,
        email: userData.email,
        fullName: userData.full_name,
        phone: userData.phone,
        role: userData.is_admin ? UserRole.ADMIN : UserRole.CUSTOMER,
        createdAt: new Date(userData.created_at),
      };

    } catch (error: any) {
      this.logger.error(`Token validation error: ${error.message}`);
      
      if (error instanceof UnauthorizedException) {
        throw error;
      }
      
      throw new UnauthorizedException('Token khÃ´ng há»£p lá»‡');
    }
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // HELPER METHODS
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  async getUserById(userId: string) {
    const { data, error } = await this.supabase
      .from('users')
      .select('*')
      .eq('id', userId)
      .single();

    if (error || !data) {
      return null;
    }

    return data;
  }

  async changePassword(userId: string, oldPassword: string, newPassword: string) {
    try {
      // 1. Láº¥y user hiá»‡n táº¡i
      const user = await this.getUserById(userId);
      if (!user) {
        throw new BadRequestException('KhÃ´ng tÃ¬m tháº¥y user');
      }

      // 2. Verify old password
      const isOldPasswordValid = await bcrypt.compare(oldPassword, user.password_hash);
      if (!isOldPasswordValid) {
        throw new BadRequestException('Máº­t kháº©u cÅ© khÃ´ng Ä‘Ãºng');
      }

      // 3. Hash new password
      const hashedNewPassword = await bcrypt.hash(newPassword, this.SALT_ROUNDS);

      // 4. Update password
      const { error } = await this.supabase
        .from('users')
        .update({ 
          password_hash: hashedNewPassword,
          updated_at: new Date().toISOString()
        })
        .eq('id', userId);

      if (error) {
        throw new BadRequestException('KhÃ´ng thá»ƒ Ä‘á»•i máº­t kháº©u');
      }

      return { success: true, message: 'Äá»•i máº­t kháº©u thÃ nh cÃ´ng' };

    } catch (error: any) {
      throw new BadRequestException(error.message || 'Äá»•i máº­t kháº©u tháº¥t báº¡i');
    }
  }
}



################################################################################
## FILE 22: auth.module.ts
## Path: backend/src/auth/auth.module.ts
################################################################################

// import { Module } from '@nestjs/common';
// import { PassportModule } from '@nestjs/passport';
// import { ConfigModule } from '@nestjs/config';
// import { AuthController } from './auth.controller';
// import { AuthService } from './auth.service';
// import { SupabaseService } from '../supabase.service';

// @Module({
//   imports: [PassportModule, ConfigModule],
//   controllers: [AuthController],
//   providers: [AuthService, SupabaseService],
//   exports: [AuthService],
// })
// export class AuthModule {}
import { Module } from '@nestjs/common';
import { JwtModule } from '@nestjs/jwt';
import { PassportModule } from '@nestjs/passport';
import { ConfigModule , ConfigService } from '@nestjs/config';

import { AuthService } from './auth.service';
import { AuthController } from './auth.controller';
import { JwtAuthGuard, RolesGuard, CustomerGuard } from './guards';

@Module({
  imports: [ConfigModule,PassportModule,JwtModule.registerAsync({
      imports: [ConfigModule],
      inject: [ConfigService],
      useFactory: (config: ConfigService) => ({
        secret: config.get('JWT_SECRET') || 'jwt-secret-key',
        signOptions: { expiresIn: '7d' },
      }),
    }),
  ],
  controllers: [AuthController],
  providers: [
    AuthService,
    JwtAuthGuard,
    RolesGuard,
    CustomerGuard,
    
  ],
  exports: [
    AuthService,
    JwtAuthGuard,
    RolesGuard,
    CustomerGuard,
  ],
})
export class AuthModule {}



################################################################################
## FILE 23: auth.controller.ts
## Path: backend/src/auth/auth.controller.ts
################################################################################



import {
  Controller,
  Get,
  Post,
  Put,
  Body,
  Headers,
  UseGuards,
  UnauthorizedException,
  HttpCode,
  HttpStatus,
} from '@nestjs/common';
import { AuthService } from './auth.service';
import { JwtAuthGuard, CustomerGuard, RolesGuard } from './guards';
import { Roles, CurrentUser, CustomerOnly } from './decorators';
import { UserRole } from '../common';
import type { AuthenticatedUser } from '../common';

// DTOs
class RegisterDto {
  email: string;
  password: string;
  full_name: string;
  phone?: string;
}

class LoginDto {
  email: string;
  password: string;
}

class ChangePasswordDto {
  oldPassword: string;
  newPassword: string;
}

@Controller('auth')
export class AuthController {
  constructor(private readonly authService: AuthService) {}

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // PUBLIC ENDPOINTS (khÃ´ng cáº§n authentication)
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  /**
   * POST /auth/register - ÄÄƒng kÃ½ tÃ i khoáº£n má»›i
   */
  @Post('register')
  @HttpCode(HttpStatus.CREATED)
  async register(@Body() body: RegisterDto) {
    return await this.authService.register(body);
  }

  /**
   * POST /auth/login - ÄÄƒng nháº­p
   */
  @Post('login')
  @HttpCode(HttpStatus.OK)
  async login(@Body() body: LoginDto) {
    return await this.authService.login(body.email, body.password);
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // PROTECTED ENDPOINTS (cáº§n authentication)
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  /**
   * GET /auth/me - Láº¥y thÃ´ng tin user hiá»‡n táº¡i
   * YÃªu cáº§u: ÄÃ£ Ä‘Äƒng nháº­p
   */
  @Get('me')
  @UseGuards(JwtAuthGuard)
  async getCurrentUser(@CurrentUser() user: AuthenticatedUser) {
    return {
      success: true,
      data: {
        id: user.id,
        email: user.email,
        fullName: user.fullName,
        phone: user.phone,
        role: user.role,
      },
    };
  }

  /**
   * POST /auth/validate - Validate token vÃ  tráº£ vá» user info
   * DÃ¹ng cho frontend Ä‘á»ƒ kiá»ƒm tra token cÃ²n há»£p lá»‡ khÃ´ng
   */
  @Post('validate')
  @HttpCode(HttpStatus.OK)
  async validateToken(@Headers('authorization') authHeader: string) {
    if (!authHeader || !authHeader.startsWith('Bearer ')) {
      throw new UnauthorizedException('Token khÃ´ng há»£p lá»‡');
    }

    const token = authHeader.substring(7);
    const user = await this.authService.validateToken(token);

    return {
      valid: true,
      user: {
        id: user.id,
        email: user.email,
        fullName: user.fullName,
        role: user.role,
      },
    };
  }

  /**
   * PUT /auth/change-password - Äá»•i máº­t kháº©u
   * YÃªu cáº§u: ÄÃ£ Ä‘Äƒng nháº­p
   */
  @Put('change-password')
  @UseGuards(JwtAuthGuard)
  @HttpCode(HttpStatus.OK)
  async changePassword(
    @CurrentUser('id') userId: string,
    @Body() body: ChangePasswordDto,
  ) {
    return await this.authService.changePassword(
      userId,
      body.oldPassword,
      body.newPassword,
    );
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // TEST ENDPOINTS
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  /**
   * GET /auth/customer-only-test - Test endpoint chá»‰ cho customer
   */
  @Get('customer-only-test')
  @CustomerOnly()
  async customerOnlyTest(@CurrentUser() user: AuthenticatedUser) {
    return {
      success: true,
      message: 'âœ… Báº¡n Ä‘ang truy cáº­p vá»›i vai trÃ² CUSTOMER',
      user: {
        id: user.id,
        email: user.email,
        role: user.role,
      },
    };
  }

  /**
   * GET /auth/admin-only-test - Test endpoint chá»‰ cho admin
   */
  @Get('admin-only-test')
  @UseGuards(JwtAuthGuard, RolesGuard)
  @Roles(UserRole.ADMIN)
  async adminOnlyTest(@CurrentUser() user: AuthenticatedUser) {
    return {
      success: true,
      message: 'âœ… Báº¡n Ä‘ang truy cáº­p vá»›i vai trÃ² ADMIN',
      user: {
        id: user.id,
        email: user.email,
        role: user.role,
      },
    };
  }
}



################################################################################
## FILE 24: roles.decorator.ts
## Path: backend/src/auth/decorators/roles.decorator.ts
################################################################################

// import { SetMetadata } from '@nestjs/common';
// export const ROLES_KEY = 'roles';
// export const Roles = (...roles: string[]) =>
//   SetMetadata(ROLES_KEY, roles);
import { SetMetadata } from '@nestjs/common';
import { UserRole } from '../../common';

export const ROLES_KEY = 'roles';

/**
 * Decorator Ä‘á»ƒ chá»‰ Ä‘á»‹nh roles Ä‘Æ°á»£c phÃ©p truy cáº­p
 * Sá»­ dá»¥ng: @Roles(UserRole.ADMIN) hoáº·c @Roles(UserRole.CUSTOMER, UserRole.ADMIN)
 */
export const Roles = (...roles: UserRole[]) => SetMetadata(ROLES_KEY, roles);



################################################################################
## FILE 25: index.ts
## Path: backend/src/auth/decorators/index.ts
################################################################################

export * from './roles.decorator';
export * from './customer-only.decorator';
export * from './current-user.decorator';




################################################################################
## FILE 26: customer-only.decorator.ts
## Path: backend/src/auth/decorators/customer-only.decorator.ts
################################################################################

import { applyDecorators, UseGuards } from '@nestjs/common';
import { JwtAuthGuard } from '../guards/jwt-auth.guard';
import { CustomerGuard } from '../guards/customer.guard';

/**
 * Decorator káº¿t há»£p Ä‘á»ƒ báº£o vá»‡ endpoint chá»‰ cho CUSTOMER
 * Sá»­ dá»¥ng: @CustomerOnly() thay vÃ¬ @UseGuards(JwtAuthGuard, CustomerGuard)
 */
export function CustomerOnly() {
  return applyDecorators(
    UseGuards(JwtAuthGuard, CustomerGuard)
  );
}



################################################################################
## FILE 27: current-user.decorator.ts
## Path: backend/src/auth/decorators/current-user.decorator.ts
################################################################################

import { createParamDecorator, ExecutionContext } from '@nestjs/common';
import { AuthenticatedUser } from '../../common';

/**
 * Decorator Ä‘á»ƒ láº¥y user hiá»‡n táº¡i tá»« request
 * 
 * Sá»­ dá»¥ng:
 * - @CurrentUser() user: AuthenticatedUser  -> Láº¥y toÃ n bá»™ user
 * - @CurrentUser('id') userId: string       -> Chá»‰ láº¥y id
 * - @CurrentUser('role') role: UserRole     -> Chá»‰ láº¥y role
 */
export const CurrentUser = createParamDecorator(
  (data: keyof AuthenticatedUser | undefined, ctx: ExecutionContext) => {
    const request = ctx.switchToHttp().getRequest();
    const user = request.user as AuthenticatedUser;

    if (!user) return null;

    return data ? user[data] : user;
  },
);
        



################################################################################
## FILE 28: roles.guard.ts
## Path: backend/src/auth/guards/roles.guard.ts
################################################################################

// import { Injectable, CanActivate, ExecutionContext } from '@nestjs/common';
// import { Reflector } from '@nestjs/core';
// import { ROLES_KEY } from '../decorators/roles.decorator';

// @Injectable()
// export class RolesGuard implements CanActivate {
//   constructor(private reflector: Reflector) {}

//   canActivate(context: ExecutionContext): boolean {
//     const requiredRoles =
//       this.reflector.getAllAndOverride<string[]>(ROLES_KEY, [
//         context.getHandler(),
//         context.getClass(),
//       ]);

//     // KhÃ´ng yÃªu cáº§u role â†’ cho phÃ©p
//     if (!requiredRoles || requiredRoles.length === 0) {
//       return true;
//     }

//     const { user } = context.switchToHttp().getRequest();

//     return requiredRoles.some(
//       (role) => user?.role === role
//     );
//   }
// }
import {
  Injectable,
  CanActivate,
  ExecutionContext,
  ForbiddenException,
} from '@nestjs/common';
import { Reflector } from '@nestjs/core';
import { UserRole } from '../../common';
import { ROLES_KEY } from '../decorators/roles.decorator';

@Injectable()
export class RolesGuard implements CanActivate {
  constructor(private reflector: Reflector) {}

  canActivate(context: ExecutionContext): boolean {
    // Láº¥y danh sÃ¡ch roles Ä‘Æ°á»£c phÃ©p tá»« decorator
    const requiredRoles = this.reflector.getAllAndOverride<UserRole[]>(
      ROLES_KEY,
      [context.getHandler(), context.getClass()]
    );

    // Náº¿u khÃ´ng cÃ³ decorator @Roles(), cho phÃ©p táº¥t cáº£
    if (!requiredRoles || requiredRoles.length === 0) {
      return true;
    }

    const request = context.switchToHttp().getRequest();
    const user = request.user;

    if (!user) {
      throw new ForbiddenException('ChÆ°a xÃ¡c thá»±c');
    }

    const hasRole = requiredRoles.includes(user.role);

    if (!hasRole) {
      throw new ForbiddenException(
        `Báº¡n cáº§n quyá»n ${requiredRoles.join(' hoáº·c ')} Ä‘á»ƒ thá»±c hiá»‡n thao tÃ¡c nÃ y`
      );
    }

    return true;
  }
}



################################################################################
## FILE 29: jwt-auth.guard.ts
## Path: backend/src/auth/guards/jwt-auth.guard.ts
################################################################################

// import { Injectable } from '@nestjs/common';
// import { AuthGuard } from '@nestjs/passport';

// @Injectable()
// export class JwtAuthGuard extends AuthGuard('jwt') {}
import {
  Injectable,
  CanActivate,
  ExecutionContext,
  UnauthorizedException,
} from '@nestjs/common';
import { AuthService } from '../auth.service';

@Injectable()
export class JwtAuthGuard implements CanActivate {
  constructor(private authService: AuthService) {}

  async canActivate(context: ExecutionContext): Promise<boolean> {
    const request = context.switchToHttp().getRequest();
    const authHeader = request.headers.authorization;

    if (!authHeader) {
      throw new UnauthorizedException('KhÃ´ng tÃ¬m tháº¥y token xÃ¡c thá»±c');
    }

    if (!authHeader.startsWith('Bearer ')) {
      throw new UnauthorizedException('Token khÃ´ng Ä‘Ãºng Ä‘á»‹nh dáº¡ng');
    }

    const token = authHeader.substring(7); // Bá» "Bearer "

    try {
      const user = await this.authService.validateToken(token);
      request.user = user; // Gáº¯n user vÃ o request Ä‘á»ƒ sá»­ dá»¥ng sau
      return true;
    } catch (error) {
      throw new UnauthorizedException(error.message || 'Token khÃ´ng há»£p lá»‡');
    }
  }
}



################################################################################
## FILE 30: index.ts
## Path: backend/src/auth/guards/index.ts
################################################################################

export * from './jwt-auth.guard';
export * from './roles.guard';
export * from './customer.guard';




################################################################################
## FILE 31: customer.guard.ts
## Path: backend/src/auth/guards/customer.guard.ts
################################################################################

import {
  Injectable,
  CanActivate,
  ExecutionContext,
  ForbiddenException,
} from '@nestjs/common';
import { UserRole } from '../../common';

/**
 * Guard chá»‰ cho phÃ©p CUSTOMER truy cáº­p
 * Sá»­ dá»¥ng: @UseGuards(JwtAuthGuard, CustomerGuard)
 */
@Injectable()
export class CustomerGuard implements CanActivate {
  canActivate(context: ExecutionContext): boolean {
    const request = context.switchToHttp().getRequest();
    const user = request.user;

    if (!user) {
      throw new ForbiddenException('ChÆ°a Ä‘Äƒng nháº­p');
    }

    if (user.role !== UserRole.CUSTOMER) {
      throw new ForbiddenException(
        'Chá»‰ khÃ¡ch hÃ ng (customer) má»›i Ä‘Æ°á»£c thá»±c hiá»‡n thao tÃ¡c nÃ y'
      );
    }

    return true;
  }
}



################################################################################
## FILE 32: category.service.ts
## Path: backend/src/category/category.service.ts
################################################################################

import { Injectable } from '@nestjs/common';
import { SupabaseService } from '../supabase.service';

@Injectable()
export class CategoryService {
  constructor(private readonly supabaseService: SupabaseService) {}

  async getCategories() {
    const result = await this.supabaseService.getCategories();
    return result.data || [];
  }

  async getCategoriesWithProductCount() {
    const result = await this.supabaseService.getCategoriesWithProductCount();
    return result.data || [];
  }

  async getRootCategories() {
    const result = await this.supabaseService.getRootCategories();
    return result.data || [];
  }

  async getCategoryBySlug(slug: string) {
    const result = await this.supabaseService.getCategoryBySlug(slug);
    return result.data || null;
  }

  async getChildCategories(parentId: number) {
    const result = await this.supabaseService.getChildCategories(parentId);
    return result.data || [];
  }

  async getCategoryById(categoryId: number) {
    const result = await this.supabaseService.getCategoryById(categoryId);
    return result.data || null;
  }

  async createCategory(categoryData: any) {
    const result = await this.supabaseService.createCategory(categoryData);
    return result;
  }

  async updateCategory(categoryId: number, categoryData: any) {
    const result = await this.supabaseService.updateCategory(categoryId, categoryData);
    return result;
  }

  async deleteCategory(categoryId: number) {
    const result = await this.supabaseService.deleteCategory(categoryId);
    return result;
  }
}




################################################################################
## FILE 33: category.module.ts
## Path: backend/src/category/category.module.ts
################################################################################

import { Module } from '@nestjs/common';
import { CategoryController } from './category.controller';
import { CategoryService } from './category.service';
import { SupabaseService } from '../supabase.service';

@Module({
  controllers: [CategoryController],
  providers: [CategoryService, SupabaseService],
  exports: [CategoryService],
})
export class CategoryModule {}




################################################################################
## FILE 34: category.controller.ts
## Path: backend/src/category/category.controller.ts
################################################################################

import { Controller, Get, Post, Put, Delete, Param, Body } from '@nestjs/common';
import { CategoryService } from './category.service';

@Controller('categories')
export class CategoryController {
  constructor(private readonly categoryService: CategoryService) {}

  @Get()
  async getCategories() {
    return await this.categoryService.getCategories();
  }

  @Get('with-count')
  async getCategoriesWithProductCount() {
    return await this.categoryService.getCategoriesWithProductCount();
  }

  @Get('root')
  async getRootCategories() {
    return await this.categoryService.getRootCategories();
  }

  @Get('slug/:slug')
  async getCategoryBySlug(@Param('slug') slug: string) {
    return await this.categoryService.getCategoryBySlug(slug);
  }

  @Get(':id/children')
  async getChildCategories(@Param('id') id: string) {
    return await this.categoryService.getChildCategories(parseInt(id));
  }

  @Get(':id')
  async getCategoryById(@Param('id') id: string) {
    return await this.categoryService.getCategoryById(parseInt(id));
  }

  @Post()
  async createCategory(@Body() categoryData: any) {
    return await this.categoryService.createCategory(categoryData);
  }

  @Put(':id')
  async updateCategory(@Param('id') id: string, @Body() categoryData: any) {
    return await this.categoryService.updateCategory(parseInt(id), categoryData);
  }

  @Delete(':id')
  async deleteCategory(@Param('id') id: string) {
    return await this.categoryService.deleteCategory(parseInt(id));
  }
}




################################################################################
## FILE 35: cloudinary.service.ts
## Path: backend/src/cloudinary/cloudinary.service.ts
################################################################################

import { Injectable } from '@nestjs/common';
import { v2 as cloudinary } from 'cloudinary';

@Injectable()
export class CloudinaryService {
  constructor() {
    cloudinary.config({
      cloud_name: process.env.CLOUDINARY_CLOUD_NAME,
      api_key: process.env.CLOUDINARY_API_KEY,
      api_secret: process.env.CLOUDINARY_API_SECRET,
    });
  }

  async uploadImage(
    fileBuffer: Buffer,
    folder = 'products',
  ): Promise<string> {
    return new Promise((resolve, reject) => {
      cloudinary.uploader
        .upload_stream(
          {
            folder,
            resource_type: 'image',
            format: 'webp',
            quality: 'auto:good',
          },
          (error, result) => {
            if (error) return reject(error);
            // resolve(result.secure_url);
            console.log('ok');
          },
        )
        .end(fileBuffer);
    });
  }
}




################################################################################
## FILE 36: cloudinary.module.ts
## Path: backend/src/cloudinary/cloudinary.module.ts
################################################################################

import { Module } from '@nestjs/common';
import { CloudinaryService } from './cloudinary.service';
import { ProductModule } from 'src/product/product.module';

@Module({
    imports: [ProductModule],
  providers: [CloudinaryService],
  exports: [CloudinaryService],
})
export class CloudinaryModule {}




################################################################################
## FILE 37: collection.service.ts
## Path: backend/src/collection/collection.service.ts
################################################################################

import { Injectable } from '@nestjs/common';
import { createClient } from '@supabase/supabase-js';

@Injectable()
export class CollectionService {
  private supabase = createClient(
    process.env.SUPABASE_URL || '',
    process.env.SUPABASE_SERVICE_ROLE_KEY || '',
  );

  // Láº¥y táº¥t cáº£ bá»™ sÆ°u táº­p
  async getAllCollections() {
    try {
      const { data, error } = await this.supabase
        .from('collections')
        .select('*')
        .eq('is_active', true)
        .order('display_order', { ascending: true });

      if (error) {
        console.error('getAllCollections error:', error.message);
        return []; // Tráº£ vá» máº£ng rá»—ng
      }
      return data || [];
    } catch (error: any) {
      console.error('getAllCollections error:', error.message);
      return [];
    }
  }

  // Láº¥y bá»™ sÆ°u táº­p theo loáº¡i (main, seasonal)
  async getCollectionsByType(type: string) {
    try {
      const { data, error } = await this.supabase
        .from('collections')
        .select('*')
        .eq('collection_type', type)
        .eq('is_active', true)
        .order('display_order', { ascending: true });

      if (error) {
        console.error('getCollectionsByType error:', error.message);
        return [];
      }
      return data || [];
    } catch (error: any) {
      console.error('getCollectionsByType error:', error.message);
      return [];
    }
  }

  // Láº¥y bá»™ sÆ°u táº­p theo slug
  async getCollectionBySlug(slug: string) {
    const { data, error } = await this.supabase
      .from('collections')
      .select('*')
      .eq('collection_slug', slug)
      .single();

    if (error) {
      throw new Error(error.message);
    }
    return data;
  }

  // Láº¥y sá»‘ lÆ°á»£ng sáº£n pháº©m trong má»—i bá»™ sÆ°u táº­p
  async getCollectionProductCounts() {
    try {
      // Láº¥y táº¥t cáº£ collections
      const { data: collections, error: collectionsError } = await this.supabase
        .from('collections')
        .select('collection_id, collection_slug')
        .eq('is_active', true);

      if (collectionsError) {
        console.error('Collections table error:', collectionsError.message);
        return {}; // Tráº£ vá» object rá»—ng náº¿u table khÃ´ng tá»“n táº¡i
      }

      // Äáº¿m sáº£n pháº©m cho má»—i collection
      const counts: Record<string, number> = {};
      
      for (const collection of collections || []) {
        const { count, error } = await this.supabase
          .from('product_collections')
          .select('*', { count: 'exact', head: true })
          .eq('collection_id', collection.collection_id);

        if (!error) {
          counts[collection.collection_slug] = count || 0;
        }
      }

      return counts;
    } catch (error: any) {
      console.error('getCollectionProductCounts error:', error.message);
      return {}; // Tráº£ vá» object rá»—ng khi cÃ³ lá»—i
    }
  }

  // Láº¥y sáº£n pháº©m trong má»™t bá»™ sÆ°u táº­p
  async getProductsByCollection(slug: string) {
    // Láº¥y collection_id tá»« slug
    const { data: collection, error: collectionError } = await this.supabase
      .from('collections')
      .select('collection_id')
      .eq('collection_slug', slug)
      .single();

    if (collectionError || !collection) {
      throw new Error('Collection not found');
    }

    // Láº¥y product_ids tá»« product_collections
    const { data: productCollections, error: pcError } = await this.supabase
      .from('product_collections')
      .select('product_id')
      .eq('collection_id', collection.collection_id)
      .order('display_order', { ascending: true });

    if (pcError) {
      throw new Error(pcError.message);
    }

    if (!productCollections || productCollections.length === 0) {
      return [];
    }

    const productIds = productCollections.map(pc => pc.product_id);

    // Láº¥y thÃ´ng tin sáº£n pháº©m
    const { data: products, error: productsError } = await this.supabase
      .from('products')
      .select('*')
      .in('product_id', productIds);

    if (productsError) {
      throw new Error(productsError.message);
    }

    return products;
  }

  // ThÃªm sáº£n pháº©m vÃ o bá»™ sÆ°u táº­p
  async addProductToCollection(productId: number, collectionId: number, displayOrder: number = 0) {
    const { data, error } = await this.supabase
      .from('product_collections')
      .insert({
        product_id: productId,
        collection_id: collectionId,
        display_order: displayOrder,
      })
      .select()
      .single();

    if (error) {
      throw new Error(error.message);
    }
    return data;
  }

  // XÃ³a sáº£n pháº©m khá»i bá»™ sÆ°u táº­p
  async removeProductFromCollection(productId: number, collectionId: number) {
    const { error } = await this.supabase
      .from('product_collections')
      .delete()
      .eq('product_id', productId)
      .eq('collection_id', collectionId);

    if (error) {
      throw new Error(error.message);
    }
    return { success: true };
  }

  // Cáº­p nháº­t cÃ¡c bá»™ sÆ°u táº­p cá»§a sáº£n pháº©m (xÃ³a cÅ©, thÃªm má»›i)
  async updateProductCollections(productId: number, collectionIds: number[]) {
    // XÃ³a táº¥t cáº£ liÃªn káº¿t cÅ©
    const { error: deleteError } = await this.supabase
      .from('product_collections')
      .delete()
      .eq('product_id', productId);

    if (deleteError) {
      throw new Error(deleteError.message);
    }

    // ThÃªm cÃ¡c liÃªn káº¿t má»›i
    if (collectionIds.length > 0) {
      const inserts = collectionIds.map((collectionId, index) => ({
        product_id: productId,
        collection_id: collectionId,
        display_order: index,
      }));

      const { error: insertError } = await this.supabase
        .from('product_collections')
        .insert(inserts);

      if (insertError) {
        throw new Error(insertError.message);
      }
    }

    return { success: true };
  }

  // Láº¥y cÃ¡c bá»™ sÆ°u táº­p cá»§a má»™t sáº£n pháº©m
  async getProductCollections(productId: number) {
    try {
      const { data, error } = await this.supabase
        .from('product_collections')
        .select(`
          collection_id,
          design_collections (
            collection_id,
            collection_name,
            collection_slug,
            is_active
          )
        `)
        .eq('product_id', productId);

      if (error) {
        console.error('getProductCollections error:', error.message);
        return []; // Tráº£ vá» máº£ng rá»—ng thay vÃ¬ throw error
      }
      return data || [];
    } catch (error: any) {
      console.error('getProductCollections error:', error.message);
      return [];
    }
  }

  // Táº¡o bá»™ sÆ°u táº­p má»›i
  async createCollection(collectionData: {
    collection_name: string;
    collection_slug: string;
    collection_description?: string;
    collection_image?: string;
    collection_gradient?: string;
    collection_icon?: string;
    collection_type?: string;
    display_order?: number;
  }) {
    const { data, error } = await this.supabase
      .from('collections')
      .insert(collectionData)
      .select()
      .single();

    if (error) {
      throw new Error(error.message);
    }
    return data;
  }

  // Cáº­p nháº­t bá»™ sÆ°u táº­p
  async updateCollection(collectionId: number, collectionData: Partial<{
    collection_name: string;
    collection_description: string;
    collection_image: string;
    collection_gradient: string;
    collection_icon: string;
    collection_type: string;
    display_order: number;
    is_active: boolean;
  }>) {
    const { data, error } = await this.supabase
      .from('collections')
      .update(collectionData)
      .eq('collection_id', collectionId)
      .select()
      .single();

    if (error) {
      throw new Error(error.message);
    }
    return data;
  }

  // XÃ³a bá»™ sÆ°u táº­p
  async deleteCollection(collectionId: number) {
    // XÃ³a liÃªn káº¿t vá»›i sáº£n pháº©m trÆ°á»›c
    await this.supabase
      .from('product_collections')
      .delete()
      .eq('collection_id', collectionId);

    // XÃ³a bá»™ sÆ°u táº­p
    const { error } = await this.supabase
      .from('collections')
      .delete()
      .eq('collection_id', collectionId);

    if (error) {
      throw new Error(error.message);
    }
    return { success: true };
  }
}




################################################################################
## FILE 38: collection.module.ts
## Path: backend/src/collection/collection.module.ts
################################################################################

import { Module } from '@nestjs/common';
import { CollectionService } from './collection.service';
import { CollectionController } from './collection.controller';

@Module({
  controllers: [CollectionController],
  providers: [CollectionService],
})
export class CollectionModule {}




################################################################################
## FILE 39: collection.controller.ts
## Path: backend/src/collection/collection.controller.ts
################################################################################

import { Controller, Get, Post, Put, Delete, Param, Body, Query } from '@nestjs/common';
import { CollectionService } from './collection.service';

@Controller('collections')
export class CollectionController {
  constructor(private readonly collectionService: CollectionService) {}

  // GET /collections - Láº¥y táº¥t cáº£ bá»™ sÆ°u táº­p
  @Get()
  async getAllCollections() {
    return this.collectionService.getAllCollections();
  }

  // GET /collections/type/:type - Láº¥y bá»™ sÆ°u táº­p theo loáº¡i (main, seasonal)
  @Get('type/:type')
  async getCollectionsByType(@Param('type') type: string) {
    return this.collectionService.getCollectionsByType(type);
  }

  // GET /collections/counts - Láº¥y sá»‘ lÆ°á»£ng sáº£n pháº©m trong má»—i bá»™ sÆ°u táº­p
  @Get('counts')
  async getCollectionProductCounts() {
    return this.collectionService.getCollectionProductCounts();
  }

  // GET /collections/slug/:slug - Láº¥y bá»™ sÆ°u táº­p theo slug
  @Get('slug/:slug')
  async getCollectionBySlug(@Param('slug') slug: string) {
    return this.collectionService.getCollectionBySlug(slug);
  }

  // GET /collections/slug/:slug/products - Láº¥y sáº£n pháº©m trong bá»™ sÆ°u táº­p
  @Get('slug/:slug/products')
  async getProductsByCollection(@Param('slug') slug: string) {
    return this.collectionService.getProductsByCollection(slug);
  }

  // GET /collections/product/:productId - Láº¥y cÃ¡c bá»™ sÆ°u táº­p cá»§a sáº£n pháº©m
  @Get('product/:productId')
  async getProductCollections(@Param('productId') productId: number) {
    return this.collectionService.getProductCollections(productId);
  }

  // POST /collections - Táº¡o bá»™ sÆ°u táº­p má»›i
  @Post()
  async createCollection(
    @Body() collectionData: {
      collection_name: string;
      collection_slug: string;
      collection_description?: string;
      collection_image?: string;
      collection_gradient?: string;
      collection_icon?: string;
      collection_type?: string;
      display_order?: number;
    },
  ) {
    return this.collectionService.createCollection(collectionData);
  }

  // POST /collections/product - ThÃªm sáº£n pháº©m vÃ o bá»™ sÆ°u táº­p
  @Post('product')
  async addProductToCollection(
    @Body() data: { productId: number; collectionId: number; displayOrder?: number },
  ) {
    return this.collectionService.addProductToCollection(
      data.productId,
      data.collectionId,
      data.displayOrder || 0,
    );
  }

  // PUT /collections/:id - Cáº­p nháº­t bá»™ sÆ°u táº­p
  @Put(':id')
  async updateCollection(
    @Param('id') id: number,
    @Body() collectionData: Partial<{
      collection_name: string;
      collection_description: string;
      collection_image: string;
      collection_gradient: string;
      collection_icon: string;
      collection_type: string;
      display_order: number;
      is_active: boolean;
    }>,
  ) {
    return this.collectionService.updateCollection(id, collectionData);
  }

  // PUT /collections/product/:productId - Cáº­p nháº­t cÃ¡c bá»™ sÆ°u táº­p cá»§a sáº£n pháº©m
  @Put('product/:productId')
  async updateProductCollections(
    @Param('productId') productId: number,
    @Body() data: { collectionIds: number[] },
  ) {
    return this.collectionService.updateProductCollections(productId, data.collectionIds);
  }

  // DELETE /collections/:id - XÃ³a bá»™ sÆ°u táº­p
  @Delete(':id')
  async deleteCollection(@Param('id') id: number) {
    return this.collectionService.deleteCollection(id);
  }

  // DELETE /collections/product - XÃ³a sáº£n pháº©m khá»i bá»™ sÆ°u táº­p
  @Delete('product')
  async removeProductFromCollection(
    @Body() data: { productId: number; collectionId: number },
  ) {
    return this.collectionService.removeProductFromCollection(data.productId, data.collectionId);
  }
}




################################################################################
## FILE 40: index.ts
## Path: backend/src/common/index.ts
################################################################################

export * from './enums/user-role.enum';
export * from './interfaces/authenticated-user.interface';



################################################################################
## FILE 41: user-role.enum.ts
## Path: backend/src/common/enums/user-role.enum.ts
################################################################################

export enum UserRole {
  ADMIN = 'admin',
  CUSTOMER = 'customer',
  GUEST = 'guest',
}




################################################################################
## FILE 42: authenticated-user.interface.ts
## Path: backend/src/common/interfaces/authenticated-user.interface.ts
################################################################################

import { UserRole } from '../enums/user-role.enum';

export interface AuthenticatedUser {
  id: string;           // UUID tá»« Supabase Auth
  email: string;
  fullName?: string;
  phone?: string;
  role: UserRole;
  createdAt?: Date;
}




################################################################################
## FILE 43: contact.service.ts
## Path: backend/src/contact/contact.service.ts
################################################################################

import { Injectable } from '@nestjs/common';
import { SupabaseService } from '../supabase.service';

@Injectable()
export class ContactService {
  constructor(private supabaseService: SupabaseService) {}

  async getAllMessages() {
    return this.supabaseService.getAllContactMessages();
  }

  async getMessageById(id: number) {
    return this.supabaseService.getContactMessageById(id);
  }

  async createMessage(messageData: any) {
    return this.supabaseService.createContactMessage(messageData);
  }

  async updateMessageStatus(id: number, status: string) {
    return this.supabaseService.updateContactMessageStatus(id, status);
  }

  async deleteMessage(id: number) {
    return this.supabaseService.deleteContactMessage(id);
  }
}




################################################################################
## FILE 44: contact.module.ts
## Path: backend/src/contact/contact.module.ts
################################################################################

import { Module } from '@nestjs/common';
import { ContactService } from './contact.service';
import { ContactController } from './contact.controller';
import { SupabaseService } from '../supabase.service';

@Module({
  controllers: [ContactController],
  providers: [ContactService, SupabaseService],
})
export class ContactModule {}




################################################################################
## FILE 45: contact.controller.ts
## Path: backend/src/contact/contact.controller.ts
################################################################################

import { Controller, Get, Post, Put, Delete, Body, Param, Query } from '@nestjs/common';
import { ContactService } from './contact.service';

@Controller('contacts')
export class ContactController {
  constructor(private readonly contactService: ContactService) {}

  @Get()
  async getAllMessages(@Query('limit') limit?: number) {
    const result = await this.contactService.getAllMessages();
    return result.data || [];
  }

  @Get(':id')
  async getMessageById(@Param('id') id: string) {
    const result = await this.contactService.getMessageById(parseInt(id));
    return result.data;
  }

  @Post()
  async createMessage(@Body() body: any) {
    const messageData = {
      name: body.name,
      email: body.email,
      phone: body.phone || null,
      subject: body.subject || 'LiÃªn há»‡',
      message: body.message,
      status: 'pending',
      created_at: new Date().toISOString(),
    };
    const result = await this.contactService.createMessage(messageData);
    return { success: !result.error, data: result.data, error: result.error };
  }

  @Put(':id/status')
  async updateStatus(@Param('id') id: string, @Body() body: any) {
    const result = await this.contactService.updateMessageStatus(parseInt(id), body.status);
    return { success: !result.error, data: result.data, error: result.error };
  }

  @Delete(':id')
  async deleteMessage(@Param('id') id: string) {
    const result = await this.contactService.deleteMessage(parseInt(id));
    return { success: !result.error, error: result.error };
  }
}




################################################################################
## FILE 46: design.service.ts
## Path: backend/src/design/design.service.ts
################################################################################

import { Injectable, NotFoundException, BadRequestException } from '@nestjs/common';
import { SupabaseService } from '../supabase.service';
import sharp from 'sharp';
import * as path from 'path';
import * as fs from 'fs';

export interface CreateDesignDto {
  userId?: string;
  guestEmail?: string;
  guestName?: string;
  guestPhone?: string;
  templateId?: number;
  phoneModel: string;
  designData: any; // JSON tá»« Fabric.js
  previewImageBase64?: string; // áº¢nh preview dáº¡ng base64
}

export interface UpdateDesignDto {
  designData?: any;
  previewImageBase64?: string;
  status?: string;
  adminNotes?: string;
}

export interface SubmitDesignDto {
  designId: number;
  guestEmail?: string;
  guestName?: string;
  guestPhone?: string;
}

@Injectable()
export class DesignService {
  private uploadDir = path.join(process.cwd(), 'uploads', 'designs');

  constructor(private supabaseService: SupabaseService) {
    // Táº¡o thÆ° má»¥c upload náº¿u chÆ°a tá»“n táº¡i
    if (!fs.existsSync(this.uploadDir)) {
      fs.mkdirSync(this.uploadDir, { recursive: true });
    }
  }

  // Láº¥y danh sÃ¡ch phone templates
  async getPhoneTemplates() {
    return this.supabaseService.getPhoneTemplates();
  }

  // Láº¥y template theo ID
  async getTemplateById(templateId: number) {
    const { data, error } = await this.supabaseService.getPhoneTemplateById(templateId);
    if (error || !data) {
      throw new NotFoundException('Template khÃ´ng tá»“n táº¡i');
    }
    return data;
  }

  // Táº¡o template má»›i
  async createTemplate(dto: any) {
    // Xá»­ lÃ½ áº£nh base64 náº¿u cÃ³
    let imageUrl = dto.template_image_url;
    if (imageUrl && imageUrl.startsWith('data:image')) {
      imageUrl = await this.saveBase64Image(imageUrl, 'template');
    }

    const { data, error } = await this.supabaseService.createPhoneTemplate({
      phone_model: dto.phone_model,
      brand: dto.brand,
      template_image_url: imageUrl || null,
      print_width_mm: dto.print_width_mm || 70,
      print_height_mm: dto.print_height_mm || 150,
      canvas_width: dto.canvas_width || 700,
      canvas_height: dto.canvas_height || 1500,
      is_active: dto.is_active !== false,
    });

    if (error) {
      throw new BadRequestException('KhÃ´ng thá»ƒ táº¡o template: ' + error.message);
    }

    return { success: true, message: 'ÄÃ£ táº¡o template!', template: data };
  }

  // Cáº­p nháº­t template
  async updateTemplate(templateId: number, dto: any) {
    // Xá»­ lÃ½ áº£nh base64 náº¿u cÃ³
    let imageUrl = dto.template_image_url;
    if (imageUrl && imageUrl.startsWith('data:image')) {
      imageUrl = await this.saveBase64Image(imageUrl, 'template');
    }

    const updateData: any = {};
    if (dto.phone_model !== undefined) updateData.phone_model = dto.phone_model;
    if (dto.brand !== undefined) updateData.brand = dto.brand;
    // Chá»‰ update image náº¿u cÃ³ giÃ¡ trá»‹ má»›i (khÃ´ng pháº£i empty string)
    if (imageUrl && imageUrl.trim() !== '') {
      updateData.template_image_url = imageUrl;
    }
    if (dto.print_width_mm !== undefined) updateData.print_width_mm = dto.print_width_mm;
    if (dto.print_height_mm !== undefined) updateData.print_height_mm = dto.print_height_mm;
    if (dto.canvas_width !== undefined) updateData.canvas_width = dto.canvas_width;
    if (dto.canvas_height !== undefined) updateData.canvas_height = dto.canvas_height;
    if (dto.is_active !== undefined) updateData.is_active = dto.is_active;

    const { data, error } = await this.supabaseService.updatePhoneTemplate(templateId, updateData);

    if (error) {
      console.error('Update template error:', error);
      throw new BadRequestException('KhÃ´ng thá»ƒ cáº­p nháº­t template: ' + error.message);
    }

    return { success: true, message: 'ÄÃ£ cáº­p nháº­t template!', template: data };
  }

  // XÃ³a template
  async deleteTemplate(templateId: number) {
    const { error } = await this.supabaseService.deletePhoneTemplate(templateId);

    if (error) {
      throw new BadRequestException('KhÃ´ng thá»ƒ xÃ³a template: ' + error.message);
    }

    return { success: true, message: 'ÄÃ£ xÃ³a template!' };
  }

  // Táº¡o thiáº¿t káº¿ má»›i
  async createDesign(dto: CreateDesignDto) {
    // LÆ°u preview image náº¿u cÃ³
    let previewImageUrl: string | null = null;
    if (dto.previewImageBase64) {
      previewImageUrl = await this.saveBase64Image(dto.previewImageBase64, 'preview');
    }

    const { data, error } = await this.supabaseService.createDesign({
      user_id: dto.userId || null,
      guest_email: dto.guestEmail || null,
      guest_name: dto.guestName || null,
      guest_phone: dto.guestPhone || null,
      template_id: dto.templateId || null,
      phone_model: dto.phoneModel,
      design_data: dto.designData,
      preview_image_url: previewImageUrl,
      status: 'draft',
    });

    if (error) {
      console.error('Create design error:', error);
      throw new BadRequestException('KhÃ´ng thá»ƒ táº¡o thiáº¿t káº¿: ' + error.message);
    }

    return {
      success: true,
      message: 'Táº¡o thiáº¿t káº¿ thÃ nh cÃ´ng',
      design: data,
    };
  }

  // Cáº­p nháº­t thiáº¿t káº¿
  async updateDesign(designId: number, dto: UpdateDesignDto) {
    // Kiá»ƒm tra thiáº¿t káº¿ tá»“n táº¡i
    const { data: existing, error: existError } = await this.supabaseService.getDesignById(designId);
    if (existError || !existing) {
      throw new NotFoundException('Thiáº¿t káº¿ khÃ´ng tá»“n táº¡i');
    }

    // KhÃ´ng cho phÃ©p sá»­a náº¿u Ä‘Ã£ submitted
    if (existing.status !== 'draft' && !dto.status && !dto.adminNotes) {
      throw new BadRequestException('KhÃ´ng thá»ƒ sá»­a thiáº¿t káº¿ Ä‘Ã£ gá»­i');
    }

    const updateData: any = {};

    if (dto.designData) {
      updateData.design_data = dto.designData;
    }

    if (dto.previewImageBase64) {
      updateData.preview_image_url = await this.saveBase64Image(dto.previewImageBase64, 'preview');
    }

    if (dto.status) {
      updateData.status = dto.status;
      if (dto.status === 'submitted') {
        updateData.submitted_at = new Date().toISOString();
      }
      if (['approved', 'rejected', 'printed'].includes(dto.status)) {
        updateData.processed_at = new Date().toISOString();
      }
    }

    if (dto.adminNotes !== undefined) {
      updateData.admin_notes = dto.adminNotes;
    }

    const { data, error } = await this.supabaseService.updateDesign(designId, updateData);

    if (error) {
      throw new BadRequestException('KhÃ´ng thá»ƒ cáº­p nháº­t thiáº¿t káº¿: ' + error.message);
    }

    return {
      success: true,
      message: 'Cáº­p nháº­t thiáº¿t káº¿ thÃ nh cÃ´ng',
      design: data,
    };
  }

  // Gá»­i thiáº¿t káº¿ cho admin duyá»‡t
  async submitDesign(dto: SubmitDesignDto) {
    const { data: existing, error: existError } = await this.supabaseService.getDesignById(dto.designId);
    if (existError || !existing) {
      throw new NotFoundException('Thiáº¿t káº¿ khÃ´ng tá»“n táº¡i');
    }

    if (existing.status !== 'draft') {
      throw new BadRequestException('Thiáº¿t káº¿ Ä‘Ã£ Ä‘Æ°á»£c gá»­i trÆ°á»›c Ä‘Ã³');
    }

    // Render áº£nh cháº¥t lÆ°á»£ng cao
    let highResUrl: string | null = null;
    try {
      highResUrl = await this.renderHighResImage(existing.design_data, existing.phone_model);
    } catch (renderError) {
      console.error('Render high-res error:', renderError);
      // Váº«n tiáº¿p tá»¥c submit dÃ¹ khÃ´ng render Ä‘Æ°á»£c
    }

    const { data, error } = await this.supabaseService.updateDesign(dto.designId, {
      status: 'submitted',
      submitted_at: new Date().toISOString(),
      high_res_image_url: highResUrl,
      guest_email: dto.guestEmail || existing.guest_email,
      guest_name: dto.guestName || existing.guest_name,
      guest_phone: dto.guestPhone || existing.guest_phone,
    });

    if (error) {
      throw new BadRequestException('KhÃ´ng thá»ƒ gá»­i thiáº¿t káº¿: ' + error.message);
    }

    return {
      success: true,
      message: 'Thiáº¿t káº¿ Ä‘Ã£ Ä‘Æ°á»£c gá»­i! Admin sáº½ xem xÃ©t vÃ  liÃªn há»‡ vá»›i báº¡n.',
      design: data,
    };
  }

  // Láº¥y thiáº¿t káº¿ theo ID
  async getDesignById(designId: number) {
    const { data, error } = await this.supabaseService.getDesignById(designId);
    if (error || !data) {
      throw new NotFoundException('Thiáº¿t káº¿ khÃ´ng tá»“n táº¡i');
    }
    return data;
  }

  // Láº¥y danh sÃ¡ch thiáº¿t káº¿ cá»§a user
  async getUserDesigns(userId: string) {
    return this.supabaseService.getUserDesigns(userId);
  }

  // Láº¥y danh sÃ¡ch thiáº¿t káº¿ cho admin
  async getAllDesigns(status?: string) {
    return this.supabaseService.getAllDesigns(status);
  }

  // Admin duyá»‡t thiáº¿t káº¿
  async approveDesign(designId: number, adminNotes?: string) {
    return this.updateDesign(designId, {
      status: 'approved',
      adminNotes,
    });
  }

  // Admin tá»« chá»‘i thiáº¿t káº¿
  async rejectDesign(designId: number, adminNotes: string) {
    if (!adminNotes) {
      throw new BadRequestException('Vui lÃ²ng nháº­p lÃ½ do tá»« chá»‘i');
    }
    return this.updateDesign(designId, {
      status: 'rejected',
      adminNotes,
    });
  }

  // LÆ°u áº£nh base64
  private async saveBase64Image(base64Data: string, prefix: string): Promise<string> {
    try {
      // XÃ³a header base64 náº¿u cÃ³
      const base64Image = base64Data.replace(/^data:image\/\w+;base64,/, '');
      const buffer = Buffer.from(base64Image, 'base64');

      const fileName = `${prefix}_${Date.now()}_${Math.random().toString(36).substring(7)}.png`;
      const filePath = path.join(this.uploadDir, fileName);

      // Optimize image vá»›i sharp
      await sharp(buffer)
        .png({ quality: 90 })
        .toFile(filePath);

      // Tráº£ vá» URL relative
      return `/uploads/designs/${fileName}`;
    } catch (error) {
      console.error('Save image error:', error);
      throw new BadRequestException('KhÃ´ng thá»ƒ lÆ°u áº£nh');
    }
  }

  // Render áº£nh cháº¥t lÆ°á»£ng cao (300dpi) tá»« design data
  private async renderHighResImage(designData: any, phoneModel: string): Promise<string> {
    try {
      // KÃ­ch thÆ°á»›c chuáº©n cho in áº¥n (300 DPI)
      // Giáº£ sá»­ kÃ­ch thÆ°á»›c á»‘p lÃ  70mm x 150mm
      // 70mm * (300/25.4) â‰ˆ 827 pixels
      // 150mm * (300/25.4) â‰ˆ 1772 pixels
      const DPI = 300;
      const MM_TO_INCH = 25.4;
      const printWidth = Math.round(70 * DPI / MM_TO_INCH); // ~827px
      const printHeight = Math.round(150 * DPI / MM_TO_INCH); // ~1772px

      // Táº¡o canvas tráº¯ng vá»›i kÃ­ch thÆ°á»›c in
      const canvas = sharp({
        create: {
          width: printWidth,
          height: printHeight,
          channels: 4,
          background: { r: 255, g: 255, b: 255, alpha: 1 }
        }
      });

      const composites: any[] = [];

      // Xá»­ lÃ½ tá»«ng object trong design data
      if (designData.objects && Array.isArray(designData.objects)) {
        for (const obj of designData.objects) {
          if (obj.type === 'image' && obj.src) {
            try {
              // Download vÃ  resize áº£nh
              const response = await fetch(obj.src);
              const arrayBuffer = await response.arrayBuffer();
              const imageBuffer = Buffer.from(arrayBuffer);

              // TÃ­nh toÃ¡n scale tá»« canvas sang print size
              const scaleX = printWidth / (designData.width || 700);
              const scaleY = printHeight / (designData.height || 1500);

              const width = Math.round((obj.width || 100) * (obj.scaleX || 1) * scaleX);
              const height = Math.round((obj.height || 100) * (obj.scaleY || 1) * scaleY);
              const left = Math.round((obj.left || 0) * scaleX);
              const top = Math.round((obj.top || 0) * scaleY);

              const resizedImage = await sharp(imageBuffer)
                .resize(width, height, { fit: 'fill' })
                .toBuffer();

              composites.push({
                input: resizedImage,
                left: Math.max(0, left),
                top: Math.max(0, top),
              });
            } catch (imgError) {
              console.error('Process image error:', imgError);
            }
          }
        }
      }

      // Composite táº¥t cáº£ áº£nh
      const finalImage = await canvas
        .composite(composites)
        .png({ quality: 100 })
        .toBuffer();

      // LÆ°u file
      const fileName = `highres_${Date.now()}_${Math.random().toString(36).substring(7)}.png`;
      const filePath = path.join(this.uploadDir, fileName);
      await sharp(finalImage).toFile(filePath);

      return `/uploads/designs/${fileName}`;
    } catch (error) {
      console.error('Render high-res error:', error);
      throw error;
    }
  }

  // Upload áº£nh cho thiáº¿t káº¿
  async uploadDesignImage(designId: number, file: any) {
    // Kiá»ƒm tra thiáº¿t káº¿ tá»“n táº¡i
    const { data: existing } = await this.supabaseService.getDesignById(designId);
    if (!existing) {
      throw new NotFoundException('Thiáº¿t káº¿ khÃ´ng tá»“n táº¡i');
    }

    // Táº¡o thumbnail
    const thumbnailBuffer = await sharp(file.buffer)
      .resize(200, 200, { fit: 'cover' })
      .jpeg({ quality: 80 })
      .toBuffer();

    // LÆ°u áº£nh gá»‘c
    const originalFileName = `original_${Date.now()}_${file.originalname}`;
    const originalPath = path.join(this.uploadDir, originalFileName);
    await sharp(file.buffer).toFile(originalPath);

    // LÆ°u thumbnail
    const thumbnailFileName = `thumb_${Date.now()}_${file.originalname}`;
    const thumbnailPath = path.join(this.uploadDir, thumbnailFileName);
    await sharp(thumbnailBuffer).toFile(thumbnailPath);

    // Láº¥y metadata
    const metadata = await sharp(file.buffer).metadata();

    // LÆ°u vÃ o database
    const { data, error } = await this.supabaseService.createDesignImage({
      design_id: designId,
      original_url: `/uploads/designs/${originalFileName}`,
      thumbnail_url: `/uploads/designs/${thumbnailFileName}`,
      file_name: file.originalname,
      file_size: file.size,
      width: metadata.width,
      height: metadata.height,
    });

    if (error) {
      throw new BadRequestException('KhÃ´ng thá»ƒ lÆ°u áº£nh: ' + error.message);
    }

    return {
      success: true,
      image: data,
    };
  }

  // Láº¥y danh sÃ¡ch áº£nh cá»§a thiáº¿t káº¿
  async getDesignImages(designId: number) {
    return this.supabaseService.getDesignImages(designId);
  }

  // XÃ³a thiáº¿t káº¿
  async deleteDesign(designId: number) {
    const { error } = await this.supabaseService.deleteDesign(designId);
    if (error) {
      throw new BadRequestException('KhÃ´ng thá»ƒ xÃ³a thiáº¿t káº¿: ' + error.message);
    }
    return { success: true, message: 'ÄÃ£ xÃ³a thiáº¿t káº¿' };
  }
}




################################################################################
## FILE 47: design.module.ts
## Path: backend/src/design/design.module.ts
################################################################################

import { Module } from '@nestjs/common';
import { MulterModule } from '@nestjs/platform-express';
import { DesignController } from './design.controller';
import { DesignService } from './design.service';
import { SupabaseService } from '../supabase.service';

@Module({
  imports: [
    MulterModule.register({
      limits: {
        fileSize: 10 * 1024 * 1024, // 10MB max
      },
    }),
  ],
  controllers: [DesignController],
  providers: [DesignService, SupabaseService],
  exports: [DesignService],
})
export class DesignModule {}




################################################################################
## FILE 48: design.controller.ts
## Path: backend/src/design/design.controller.ts
################################################################################

import {
  Controller,
  Get,
  Post,
  Put,
  Delete,
  Body,
  Param,
  Query,
  UseInterceptors,
  UploadedFile,
  ParseIntPipe,
} from '@nestjs/common';
import { FileInterceptor } from '@nestjs/platform-express';
import { DesignService } from './design.service';
import type { CreateDesignDto, UpdateDesignDto, SubmitDesignDto } from './design.service';

@Controller('designs')
export class DesignController {
  constructor(private readonly designService: DesignService) {}

  // ============ PHONE TEMPLATES ============

  // Láº¥y danh sÃ¡ch templates
  @Get('templates')
  async getTemplates() {
    return this.designService.getPhoneTemplates();
  }

  // Láº¥y template theo ID
  @Get('templates/:templateId')
  async getTemplateById(@Param('templateId', ParseIntPipe) templateId: number) {
    return this.designService.getTemplateById(templateId);
  }

  // Táº¡o template má»›i
  @Post('templates')
  async createTemplate(@Body() dto: any) {
    return this.designService.createTemplate(dto);
  }

  // Cáº­p nháº­t template
  @Put('templates/:templateId')
  async updateTemplate(
    @Param('templateId', ParseIntPipe) templateId: number,
    @Body() dto: any,
  ) {
    return this.designService.updateTemplate(templateId, dto);
  }

  // XÃ³a template
  @Delete('templates/:templateId')
  async deleteTemplate(@Param('templateId', ParseIntPipe) templateId: number) {
    return this.designService.deleteTemplate(templateId);
  }

  // ============ DESIGNS ============

  // Táº¡o thiáº¿t káº¿ má»›i
  @Post()
  async createDesign(@Body() dto: CreateDesignDto) {
    return this.designService.createDesign(dto);
  }

  // Láº¥y thiáº¿t káº¿ theo ID
  @Get(':designId')
  async getDesignById(@Param('designId', ParseIntPipe) designId: number) {
    return this.designService.getDesignById(designId);
  }

  // Cáº­p nháº­t thiáº¿t káº¿
  @Put(':designId')
  async updateDesign(
    @Param('designId', ParseIntPipe) designId: number,
    @Body() dto: UpdateDesignDto,
  ) {
    return this.designService.updateDesign(designId, dto);
  }

  // Gá»­i thiáº¿t káº¿ cho admin
  @Post(':designId/submit')
  async submitDesign(
    @Param('designId', ParseIntPipe) designId: number,
    @Body() dto: Omit<SubmitDesignDto, 'designId'>,
  ) {
    return this.designService.submitDesign({ ...dto, designId });
  }

  // Láº¥y thiáº¿t káº¿ cá»§a user
  @Get('user/:userId')
  async getUserDesigns(@Param('userId') userId: string) {
    return this.designService.getUserDesigns(userId);
  }

  // XÃ³a thiáº¿t káº¿
  @Delete(':designId')
  async deleteDesign(@Param('designId', ParseIntPipe) designId: number) {
    return this.designService.deleteDesign(designId);
  }

  // ============ ADMIN ============

  // Láº¥y táº¥t cáº£ thiáº¿t káº¿ (admin)
  @Get('admin/all')
  async getAllDesigns(@Query('status') status?: string) {
    return this.designService.getAllDesigns(status);
  }

  // Duyá»‡t thiáº¿t káº¿
  @Put('admin/:designId/approve')
  async approveDesign(
    @Param('designId', ParseIntPipe) designId: number,
    @Body('adminNotes') adminNotes?: string,
  ) {
    return this.designService.approveDesign(designId, adminNotes);
  }

  // Tá»« chá»‘i thiáº¿t káº¿
  @Put('admin/:designId/reject')
  async rejectDesign(
    @Param('designId', ParseIntPipe) designId: number,
    @Body('adminNotes') adminNotes: string,
  ) {
    return this.designService.rejectDesign(designId, adminNotes);
  }

  // ============ IMAGES ============

  // Upload áº£nh cho thiáº¿t káº¿
  @Post(':designId/images')
  @UseInterceptors(FileInterceptor('file'))
  async uploadImage(
    @Param('designId', ParseIntPipe) designId: number,
    @UploadedFile() file: any,
  ) {
    return this.designService.uploadDesignImage(designId, file);
  }

  // Láº¥y danh sÃ¡ch áº£nh cá»§a thiáº¿t káº¿
  @Get(':designId/images')
  async getDesignImages(@Param('designId', ParseIntPipe) designId: number) {
    return this.designService.getDesignImages(designId);
  }
}




################################################################################
## FILE 49: gift.service.ts
## Path: backend/src/gift/gift.service.ts
################################################################################

import { Injectable, BadRequestException, NotFoundException } from '@nestjs/common';
import { SupabaseService } from '../supabase.service';
import * as nodemailer from 'nodemailer';

export interface SendGiftDto {
  senderName: string;
  senderEmail: string;
  senderMessage?: string;
  senderId?: string;
  recipientName: string;
  recipientEmail: string;
  recipientPhone?: string;
  recipientAddress?: string;
  productId: number;
  quantity?: number;
}

export interface VerifyGiftDto {
  giftId: string;
  verificationCode: string;
}

export interface ClaimGiftDto {
  giftId: string;
  recipientAddress: string;
  recipientPhone: string;
}

@Injectable()
export class GiftService {
  private transporter: nodemailer.Transporter;

  constructor(private supabaseService: SupabaseService) {
    // Cáº¥u hÃ¬nh email transporter
    // Sá»­ dá»¥ng Gmail SMTP - Báº¡n cáº§n táº¡o App Password trong Google Account
    console.log('ðŸ“§ Email config:', {
      user: process.env.EMAIL_USER || 'NOT SET',
      passLength: process.env.EMAIL_PASS ? process.env.EMAIL_PASS.length : 0,
    });
    
    this.transporter = nodemailer.createTransport({
      service: 'gmail',
      auth: {
        user: process.env.EMAIL_USER || 'your-email@gmail.com',
        pass: process.env.EMAIL_PASS || 'your-app-password',
      },
    });
  }

  // Táº¡o mÃ£ xÃ¡c nháº­n 6 sá»‘
  private generateVerificationCode(): string {
    return Math.floor(100000 + Math.random() * 900000).toString();
  }

  // Gá»­i quÃ  táº·ng
  async sendGift(dto: SendGiftDto) {
    // Kiá»ƒm tra sáº£n pháº©m tá»“n táº¡i
    const { data: product, error: productError } = await this.supabaseService.getProductById(dto.productId);

    if (productError || !product) {
      throw new NotFoundException('Sáº£n pháº©m khÃ´ng tá»“n táº¡i');
    }

    // Táº¡o mÃ£ xÃ¡c nháº­n
    const verificationCode = this.generateVerificationCode();

    // LÆ°u thÃ´ng tin quÃ  táº·ng
    const { data: gift, error: giftError } = await this.supabaseService.createGift({
      sender_id: dto.senderId || undefined,
      sender_name: dto.senderName,
      sender_email: dto.senderEmail,
      sender_message: dto.senderMessage || '',
      recipient_name: dto.recipientName,
      recipient_email: dto.recipientEmail,
      recipient_phone: dto.recipientPhone || '',
      recipient_address: dto.recipientAddress || '',
      product_id: dto.productId,
      quantity: dto.quantity || 1,
      verification_code: verificationCode,
    });

    if (giftError) {
      console.error('Gift insert error:', giftError);
      throw new BadRequestException('KhÃ´ng thá»ƒ táº¡o quÃ  táº·ng: ' + giftError.message);
    }

    // Láº¥y áº£nh sáº£n pháº©m
    const productImage = product.image_url || 
      product.product_images?.find((img: any) => img.is_primary)?.image_url ||
      product.product_images?.[0]?.image_url ||
      'https://via.placeholder.com/200';

    // Gá»­i email cho ngÆ°á»i nháº­n
    try {
      console.log('ðŸ“§ Sending email to:', dto.recipientEmail);
      await this.sendGiftNotificationEmail({
        recipientEmail: dto.recipientEmail,
        recipientName: dto.recipientName,
        senderName: dto.senderName,
        senderMessage: dto.senderMessage || '',
        productName: product.product_name,
        productImage: productImage,
        productPrice: product.sale_price || product.price,
        giftId: gift.gift_id,
        verificationCode: verificationCode,
      });

      // LÆ°u lá»‹ch sá»­ email
      await this.supabaseService.createGiftEmail({
        gift_id: gift.gift_id,
        email_type: 'notification',
        sent_to: dto.recipientEmail,
        status: 'sent',
      });

    } catch (emailError) {
      console.error('âŒ Email send error:', emailError);
      console.error('âŒ Email error message:', (emailError as any).message);
      // Váº«n return success vÃ¬ gift Ä‘Ã£ Ä‘Æ°á»£c táº¡o
    }

    return {
      success: true,
      message: 'QuÃ  táº·ng Ä‘Ã£ Ä‘Æ°á»£c gá»­i! Email xÃ¡c nháº­n Ä‘Ã£ Ä‘Æ°á»£c gá»­i Ä‘áº¿n ngÆ°á»i nháº­n.',
      giftId: gift.gift_id,
    };
  }

  // Gá»­i email thÃ´ng bÃ¡o quÃ  táº·ng
  private async sendGiftNotificationEmail(data: {
    recipientEmail: string;
    recipientName: string;
    senderName: string;
    senderMessage: string;
    productName: string;
    productImage: string;
    productPrice: number;
    giftId: string;
    verificationCode: string;
  }) {
    const frontendUrl = process.env.FRONTEND_URL || 'http://localhost:3000';
    const claimUrl = `${frontendUrl}/gift/claim/${data.giftId}`;

    const htmlContent = `
    <!DOCTYPE html>
    <html>
    <head>
      <meta charset="utf-8">
      <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f5f5f5; margin: 0; padding: 20px; }
        .container { max-width: 600px; margin: 0 auto; background: white; border-radius: 16px; overflow: hidden; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
        .header { background: linear-gradient(135deg, #ec4899, #f43f5e); padding: 40px 20px; text-align: center; }
        .header h1 { color: white; margin: 0; font-size: 28px; }
        .header p { color: rgba(255,255,255,0.9); margin: 10px 0 0; }
        .gift-icon { font-size: 60px; margin-bottom: 10px; }
        .content { padding: 30px; }
        .message-box { background: #fdf2f8; border-left: 4px solid #ec4899; padding: 20px; margin: 20px 0; border-radius: 8px; }
        .product-card { display: flex; gap: 20px; background: #f9fafb; padding: 20px; border-radius: 12px; margin: 20px 0; }
        .product-image { width: 120px; height: 120px; object-fit: cover; border-radius: 8px; }
        .product-info h3 { margin: 0 0 10px; color: #1f2937; }
        .product-price { color: #ec4899; font-size: 24px; font-weight: bold; }
        .verification-box { background: #fef3c7; padding: 20px; border-radius: 12px; text-align: center; margin: 20px 0; }
        .verification-code { font-size: 32px; font-weight: bold; letter-spacing: 8px; color: #d97706; margin: 10px 0; }
        .claim-btn { display: inline-block; background: linear-gradient(135deg, #ec4899, #f43f5e); color: white; padding: 16px 40px; border-radius: 50px; text-decoration: none; font-weight: bold; font-size: 18px; margin: 20px 0; }
        .footer { background: #1f2937; color: #9ca3af; padding: 20px; text-align: center; font-size: 14px; }
        .footer a { color: #ec4899; }
      </style>
    </head>
    <body>
      <div class="container">
        <div class="header">
          <div class="gift-icon">ðŸŽ</div>
          <h1>Báº¡n Nháº­n ÄÆ°á»£c QuÃ  Táº·ng!</h1>
          <p>Tá»« ${data.senderName}</p>
        </div>
        
        <div class="content">
          <p style="font-size: 18px; color: #374151;">
            Xin chÃ o <strong>${data.recipientName}</strong>,
          </p>
          
          <p style="color: #6b7280; line-height: 1.6;">
            <strong>${data.senderName}</strong> Ä‘Ã£ gá»­i táº·ng báº¡n má»™t mÃ³n quÃ  Ä‘áº·c biá»‡t tá»« GoatTech! ðŸŽ‰
          </p>
          
          ${data.senderMessage ? `
          <div class="message-box">
            <p style="margin: 0; color: #831843; font-style: italic;">
              "${data.senderMessage}"
            </p>
            <p style="margin: 10px 0 0; color: #9d174d; font-size: 14px;">
              â€” ${data.senderName}
            </p>
          </div>
          ` : ''}
          
          <h2 style="color: #1f2937;">ðŸŽ QuÃ  táº·ng cá»§a báº¡n:</h2>
          
          <div class="product-card">
            <img src="${data.productImage}" alt="${data.productName}" class="product-image">
            <div class="product-info">
              <h3>${data.productName}</h3>
              <p class="product-price">${data.productPrice.toLocaleString('vi-VN')}â‚«</p>
            </div>
          </div>
          
          <div class="verification-box">
            <p style="margin: 0; color: #92400e;">ðŸ” MÃ£ xÃ¡c nháº­n cá»§a báº¡n:</p>
            <div class="verification-code">${data.verificationCode}</div>
            <p style="margin: 0; color: #92400e; font-size: 14px;">
              Sá»­ dá»¥ng mÃ£ nÃ y Ä‘á»ƒ nháº­n quÃ 
            </p>
          </div>
          
          <div style="text-align: center;">
            <a href="${claimUrl}" class="claim-btn">
              ðŸŽ Nháº­n QuÃ  Ngay
            </a>
          </div>
          
          <p style="color: #9ca3af; font-size: 14px; text-align: center;">
            Hoáº·c truy cáº­p: <a href="${claimUrl}" style="color: #ec4899;">${claimUrl}</a>
          </p>
          
          <div style="background: #fef2f2; padding: 15px; border-radius: 8px; margin-top: 20px;">
            <p style="margin: 0; color: #991b1b; font-size: 14px;">
              â° <strong>LÆ°u Ã½:</strong> QuÃ  táº·ng cÃ³ hiá»‡u lá»±c trong 7 ngÃ y. 
              Vui lÃ²ng nháº­n quÃ  trÆ°á»›c khi háº¿t háº¡n!
            </p>
          </div>
        </div>
        
        <div class="footer">
          <p>Â© 2025 GoatTech - Phá»¥ kiá»‡n Ä‘iá»‡n thoáº¡i cao cáº¥p</p>
          <p>
            Email nÃ y Ä‘Æ°á»£c gá»­i tá»± Ä‘á»™ng. Náº¿u báº¡n khÃ´ng yÃªu cáº§u, vui lÃ²ng bá» qua.
          </p>
        </div>
      </div>
    </body>
    </html>
    `;

    console.log('ðŸ“§ Attempting to send email...');
    console.log('ðŸ“§ From:', `"GoatTech Gift ðŸŽ" <${process.env.EMAIL_USER || 'noreply@goattech.vn'}>`);
    console.log('ðŸ“§ To:', data.recipientEmail);
    
    const result = await this.transporter.sendMail({
      from: `"GoatTech Gift ðŸŽ" <${process.env.EMAIL_USER || 'noreply@goattech.vn'}>`,
      to: data.recipientEmail,
      subject: `ðŸŽ ${data.senderName} Ä‘Ã£ gá»­i táº·ng báº¡n má»™t mÃ³n quÃ !`,
      html: htmlContent,
    });
    
    console.log('âœ… Email sent successfully!', result);
  }

  // XÃ¡c nháº­n mÃ£ Ä‘á»ƒ nháº­n quÃ 
  async verifyGift(dto: VerifyGiftDto) {
    const { data: gift, error } = await this.supabaseService.getGiftById(dto.giftId);

    if (error || !gift) {
      throw new NotFoundException('KhÃ´ng tÃ¬m tháº¥y quÃ  táº·ng');
    }

    if (gift.status === 'claimed') {
      throw new BadRequestException('QuÃ  táº·ng Ä‘Ã£ Ä‘Æ°á»£c nháº­n');
    }

    if (gift.status === 'expired' || new Date(gift.expires_at) < new Date()) {
      throw new BadRequestException('QuÃ  táº·ng Ä‘Ã£ háº¿t háº¡n');
    }

    if (gift.verification_code !== dto.verificationCode) {
      throw new BadRequestException('MÃ£ xÃ¡c nháº­n khÃ´ng Ä‘Ãºng');
    }

    // Cáº­p nháº­t tráº¡ng thÃ¡i
    await this.supabaseService.updateGiftStatus(dto.giftId, 'verified');

    return {
      success: true,
      message: 'XÃ¡c nháº­n thÃ nh cÃ´ng!',
      gift: {
        ...gift,
        verification_code: undefined, // KhÃ´ng tráº£ vá» mÃ£
      },
    };
  }

  // Nháº­n quÃ  (sau khi Ä‘Ã£ xÃ¡c nháº­n)
  async claimGift(dto: ClaimGiftDto) {
    const { data: gift, error } = await this.supabaseService.getGiftById(dto.giftId);

    if (error || !gift) {
      throw new NotFoundException('KhÃ´ng tÃ¬m tháº¥y quÃ  táº·ng');
    }

    if (gift.status === 'claimed') {
      throw new BadRequestException('QuÃ  táº·ng Ä‘Ã£ Ä‘Æ°á»£c nháº­n');
    }

    if (gift.status !== 'verified') {
      throw new BadRequestException('Vui lÃ²ng xÃ¡c nháº­n mÃ£ trÆ°á»›c khi nháº­n quÃ ');
    }

    // Táº¡o Ä‘Æ¡n hÃ ng cho quÃ  táº·ng
    const { data: order, error: orderError } = await this.supabaseService.createOrder({
      user_id: null, // Guest order
      total_amount: 0, // Free gift
      status: 'confirmed',
      payment_method: 'gift',
      payment_status: 'paid',
      shipping_address: dto.recipientAddress,
      phone: dto.recipientPhone,
      notes: `QuÃ  táº·ng tá»« ${gift.sender_name} (${gift.sender_email})`,
    });

    if (orderError || !order) {
      throw new BadRequestException('KhÃ´ng thá»ƒ táº¡o Ä‘Æ¡n hÃ ng');
    }

    const orderData = order as any;
    const orderId = Array.isArray(orderData) ? orderData[0]?.order_id : orderData.order_id;

    // ThÃªm sáº£n pháº©m vÃ o Ä‘Æ¡n hÃ ng
    await this.supabaseService.createOrderItem({
      order_id: orderId,
      product_id: gift.product_id,
      quantity: gift.quantity,
      price: 0, // Free
    });

    // Cáº­p nháº­t tráº¡ng thÃ¡i gift
    await this.supabaseService.updateGiftStatus(dto.giftId, 'claimed', {
      recipient_address: dto.recipientAddress,
      recipient_phone: dto.recipientPhone,
    });

    // Gá»­i email xÃ¡c nháº­n cho ngÆ°á»i nháº­n
    try {
      await this.sendClaimConfirmationEmail({
        recipientEmail: gift.recipient_email,
        recipientName: gift.recipient_name,
        productName: gift.products.product_name,
        orderId: orderId,
      });
    } catch (e) {
      console.error('Failed to send confirmation email:', e);
    }

    return {
      success: true,
      message: 'Nháº­n quÃ  thÃ nh cÃ´ng! ÄÆ¡n hÃ ng Ä‘Ã£ Ä‘Æ°á»£c táº¡o.',
      orderId: orderId,
    };
  }

  // Email xÃ¡c nháº­n Ä‘Ã£ nháº­n quÃ 
  private async sendClaimConfirmationEmail(data: {
    recipientEmail: string;
    recipientName: string;
    productName: string;
    orderId: number;
  }) {
    const htmlContent = `
    <!DOCTYPE html>
    <html>
    <head>
      <meta charset="utf-8">
      <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f5f5f5; margin: 0; padding: 20px; }
        .container { max-width: 600px; margin: 0 auto; background: white; border-radius: 16px; overflow: hidden; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
        .header { background: linear-gradient(135deg, #10b981, #059669); padding: 40px 20px; text-align: center; color: white; }
        .content { padding: 30px; }
        .order-box { background: #f0fdf4; padding: 20px; border-radius: 12px; text-align: center; }
        .footer { background: #1f2937; color: #9ca3af; padding: 20px; text-align: center; }
      </style>
    </head>
    <body>
      <div class="container">
        <div class="header">
          <h1>âœ… Nháº­n QuÃ  ThÃ nh CÃ´ng!</h1>
        </div>
        <div class="content">
          <p>Xin chÃ o <strong>${data.recipientName}</strong>,</p>
          <p>Báº¡n Ä‘Ã£ nháº­n thÃ nh cÃ´ng quÃ  táº·ng:</p>
          <div class="order-box">
            <h3>${data.productName}</h3>
            <p>MÃ£ Ä‘Æ¡n hÃ ng: <strong>#${data.orderId}</strong></p>
          </div>
          <p>ChÃºng tÃ´i sáº½ sá»›m giao hÃ ng Ä‘áº¿n Ä‘á»‹a chá»‰ cá»§a báº¡n!</p>
        </div>
        <div class="footer">
          <p>Â© 2025 GoatTech</p>
        </div>
      </div>
    </body>
    </html>
    `;

    await this.transporter.sendMail({
      from: `"GoatTech" <${process.env.EMAIL_USER}>`,
      to: data.recipientEmail,
      subject: `âœ… Báº¡n Ä‘Ã£ nháº­n quÃ  thÃ nh cÃ´ng - ÄÆ¡n hÃ ng #${data.orderId}`,
      html: htmlContent,
    });
  }

  // Láº¥y thÃ´ng tin quÃ  táº·ng (public - khÃ´ng cáº§n auth)
  async getGiftInfo(giftId: string) {
    const { data: gift, error } = await this.supabaseService.getGiftPublicInfo(giftId);

    if (error || !gift) {
      throw new NotFoundException('KhÃ´ng tÃ¬m tháº¥y quÃ  táº·ng');
    }

    return gift;
  }

  // Láº¥y danh sÃ¡ch quÃ  Ä‘Ã£ gá»­i (cho user)
  async getSentGifts(userId: string) {
    const { data, error } = await this.supabaseService.getSentGifts(userId);

    if (error) {
      throw new BadRequestException('KhÃ´ng thá»ƒ láº¥y danh sÃ¡ch quÃ  táº·ng');
    }

    return data;
  }

  // Láº¥y danh sÃ¡ch quÃ  Ä‘Ã£ nháº­n (theo email)
  async getReceivedGifts(email: string) {
    const { data, error } = await this.supabaseService.getReceivedGifts(email);

    if (error) {
      throw new BadRequestException('KhÃ´ng thá»ƒ láº¥y danh sÃ¡ch quÃ  táº·ng');
    }

    return data;
  }
}




################################################################################
## FILE 50: gift.module.ts
## Path: backend/src/gift/gift.module.ts
################################################################################

import { Module } from '@nestjs/common';
import { GiftController } from './gift.controller';
import { GiftService } from './gift.service';
import { SupabaseService } from '../supabase.service';

@Module({
  controllers: [GiftController],
  providers: [GiftService, SupabaseService],
  exports: [GiftService],
})
export class GiftModule {}




################################################################################
## FILE 51: gift.controller.ts
## Path: backend/src/gift/gift.controller.ts
################################################################################

import {
  Controller,
  Post,
  Get,
  Body,
  Param,
  Query,
  HttpCode,
  HttpStatus,
} from '@nestjs/common';
import { GiftService } from './gift.service';

// DTOs
class SendGiftDto {
  senderName: string;
  senderEmail: string;
  senderMessage?: string;
  senderId?: string;
  recipientName: string;
  recipientEmail: string;
  recipientPhone?: string;
  recipientAddress?: string;
  productId: number;
  quantity?: number;
}

class VerifyGiftDto {
  giftId: string;
  verificationCode: string;
}

class ClaimGiftDto {
  giftId: string;
  recipientAddress: string;
  recipientPhone: string;
}

@Controller('gift')
export class GiftController {
  constructor(private readonly giftService: GiftService) {}

  // POST /gift/send - Gá»­i quÃ  táº·ng
  @Post('send')
  @HttpCode(HttpStatus.CREATED)
  async sendGift(@Body() dto: SendGiftDto) {
    return this.giftService.sendGift(dto);
  }

  // POST /gift/verify - XÃ¡c nháº­n mÃ£
  @Post('verify')
  @HttpCode(HttpStatus.OK)
  async verifyGift(@Body() dto: VerifyGiftDto) {
    return this.giftService.verifyGift(dto);
  }

  // POST /gift/claim - Nháº­n quÃ 
  @Post('claim')
  @HttpCode(HttpStatus.OK)
  async claimGift(@Body() dto: ClaimGiftDto) {
    return this.giftService.claimGift(dto);
  }

  // GET /gift/:giftId - Láº¥y thÃ´ng tin quÃ  (public)
  @Get(':giftId')
  async getGiftInfo(@Param('giftId') giftId: string) {
    return this.giftService.getGiftInfo(giftId);
  }

  // GET /gift/sent/:userId - Láº¥y quÃ  Ä‘Ã£ gá»­i
  @Get('sent/:userId')
  async getSentGifts(@Param('userId') userId: string) {
    return this.giftService.getSentGifts(userId);
  }

  // GET /gift/received?email=xxx - Láº¥y quÃ  Ä‘Ã£ nháº­n
  @Get('received/by-email')
  async getReceivedGifts(@Query('email') email: string) {
    return this.giftService.getReceivedGifts(email);
  }
}




################################################################################
## FILE 52: messenger.types.ts
## Path: backend/src/messenger/messenger.types.ts
################################################################################

/**
 * Facebook Messenger Bot Types
 * Äá»‹nh nghÄ©a cÃ¡c kiá»ƒu dá»¯ liá»‡u cho Messenger Bot
 */

// Tráº¡ng thÃ¡i cá»§a cuá»™c há»™i thoáº¡i Ä‘áº·t hÃ ng
export enum ConversationState {
  IDLE = 'IDLE',                           // Chá» ngÆ°á»i dÃ¹ng báº¯t Ä‘áº§u
  WAITING_PRODUCT = 'WAITING_PRODUCT',     // Äang chá» chá»n sáº£n pháº©m
  WAITING_PHONE_MODEL = 'WAITING_PHONE_MODEL', // Äang chá» chá»n dÃ²ng mÃ¡y Ä‘iá»‡n thoáº¡i
  WAITING_QUANTITY = 'WAITING_QUANTITY',   // Äang chá» nháº­p sá»‘ lÆ°á»£ng
  WAITING_COLOR = 'WAITING_COLOR',         // Äang chá» chá»n mÃ u sáº¯c
  WAITING_NAME = 'WAITING_NAME',           // Äang chá» nháº­p tÃªn
  WAITING_PHONE = 'WAITING_PHONE',         // Äang chá» nháº­p sá»‘ Ä‘iá»‡n thoáº¡i
  WAITING_ADDRESS = 'WAITING_ADDRESS',     // Äang chá» nháº­p Ä‘á»‹a chá»‰
  WAITING_CONFIRM = 'WAITING_CONFIRM',     // Äang chá» xÃ¡c nháº­n Ä‘Æ¡n hÃ ng
}

// ThÃ´ng tin sáº£n pháº©m
export interface Product {
  id: string;
  name: string;
  price: number;
  emoji: string;
  description?: string;
  colors?: string[];
  image_url?: string;
  stock_quantity?: number;
}

// ThÃ´ng tin dÃ²ng mÃ¡y Ä‘iá»‡n thoáº¡i
export interface PhoneModelInfo {
  model_id: number;
  brand_name: string;
  model_name: string;
}

// Dá»¯ liá»‡u phiÃªn Ä‘áº·t hÃ ng cá»§a khÃ¡ch
export interface UserSession {
  state: ConversationState;
  selectedProduct?: Product;
  selectedPhoneModel?: PhoneModelInfo;
  quantity?: number;
  color?: string;
  customerName?: string;
  phone?: string;
  address?: string;
  notes?: string;
  createdAt: Date;
  updatedAt: Date;
}

// ÄÆ¡n hÃ ng tá»« Messenger
export interface MessengerOrder {
  id?: string;
  facebook_user_id: string;
  customer_name: string;
  phone: string;
  address: string;
  product_name: string;
  product_price: number;
  quantity: number;
  color?: string;
  phone_model_id?: number;
  phone_model_name?: string;
  notes?: string;
  total_price: number;
  status: OrderStatus;
  created_at?: Date;
  updated_at?: Date;
}

// Tráº¡ng thÃ¡i Ä‘Æ¡n hÃ ng
export enum OrderStatus {
  PENDING = 'pending',
  CONFIRMED = 'confirmed',
  PROCESSING = 'processing',
  SHIPPING = 'shipping',
  DELIVERED = 'delivered',
  CANCELLED = 'cancelled',
}

// Payload tá»« Facebook Webhook
export interface FacebookWebhookPayload {
  object: string;
  entry: FacebookEntry[];
}

export interface FacebookEntry {
  id: string;
  time: number;
  messaging: FacebookMessaging[];
}

export interface FacebookMessaging {
  sender: { id: string };
  recipient: { id: string };
  timestamp: number;
  message?: FacebookMessage;
  postback?: FacebookPostback;
}

export interface FacebookMessage {
  mid: string;
  text?: string;
  quick_reply?: {
    payload: string;
  };
  attachments?: any[];
}

export interface FacebookPostback {
  title: string;
  payload: string;
}

// Quick Reply Button
export interface QuickReply {
  content_type: 'text';
  title: string;
  payload: string;
}

// Generic Template Element
export interface GenericElement {
  title: string;
  subtitle?: string;
  image_url?: string;
  buttons?: Button[];
}

// Button types
export interface Button {
  type: 'postback' | 'web_url' | 'phone_number';
  title: string;
  payload?: string;
  url?: string;
}

// Response message types
export interface TextMessage {
  text: string;
  quick_replies?: QuickReply[];
}

export interface TemplateMessage {
  attachment: {
    type: 'template';
    payload: {
      template_type: 'generic' | 'button' | 'receipt';
      elements?: GenericElement[];
      text?: string;
      buttons?: Button[];
    };
  };
}

// Webhook Ä‘á»ƒ gá»­i Ä‘áº¿n há»‡ thá»‘ng quáº£n lÃ½
export interface WebhookOrderPayload {
  customer_name: string;
  phone: string;
  address: string;
  product: string;
  quantity: number;
  color?: string;
  notes?: string;
  total_price: number;
  facebook_user_id: string;
  order_id?: string;
  created_at: string;
}




################################################################################
## FILE 53: messenger.service.ts
## Path: backend/src/messenger/messenger.service.ts
################################################################################

/**
 * Messenger Service
 * Xá»­ lÃ½ logic chÃ­nh cá»§a Facebook Messenger Bot
 */

import { Injectable, Logger } from '@nestjs/common';
import { ConfigService } from '@nestjs/config';
import { createClient, SupabaseClient } from '@supabase/supabase-js';
import axios from 'axios';
import {
  ConversationState,
  UserSession,
  Product,
  MessengerOrder,
  OrderStatus,
  FacebookWebhookPayload,
  FacebookMessaging,
  QuickReply,
  WebhookOrderPayload,
  PhoneModelInfo,
} from './messenger.types';

// Interface cho Phone Model tá»« database
interface PhoneModel {
  model_id: number;
  brand_name: string;
  model_name: string;
  model_code?: string;
  is_popular: boolean;
  is_active: boolean;
}

@Injectable()
export class MessengerService {
  private readonly logger = new Logger(MessengerService.name);
  private supabase: SupabaseClient;
  
  // LÆ°u trá»¯ session cá»§a ngÆ°á»i dÃ¹ng (trong production nÃªn dÃ¹ng Redis)
  private userSessions: Map<string, UserSession> = new Map();
  
  // Cache sáº£n pháº©m tá»« database (refresh má»—i 5 phÃºt)
  private productsCache: Product[] = [];
  private productsCacheTime: Date | null = null;
  private readonly CACHE_DURATION = 5 * 60 * 1000; // 5 phÃºt

  // Cache phone models
  private phoneModelsCache: PhoneModel[] = [];
  private phoneModelsCacheTime: Date | null = null;

  // Facebook API URL
  private readonly FB_API_URL = 'https://graph.facebook.com/v18.0/me/messages';

  constructor(private configService: ConfigService) {
    // Khá»Ÿi táº¡o Supabase client
    this.supabase = createClient(
      this.configService.get('SUPABASE_URL') || '',
      this.configService.get('SUPABASE_SERVICE_ROLE_KEY') || '',
    );
    this.logger.log('MessengerService Ä‘Ã£ Ä‘Æ°á»£c khá»Ÿi táº¡o');
    
    // Load sáº£n pháº©m tá»« database khi khá»Ÿi táº¡o
    this.loadProductsFromDatabase();
    // Load phone models
    this.loadPhoneModelsFromDatabase();
  }

  /**
   * Láº¥y sáº£n pháº©m tá»« database vá»›i cache
   */
  private async loadProductsFromDatabase(): Promise<Product[]> {
    try {
      // Kiá»ƒm tra cache cÃ²n hiá»‡u lá»±c khÃ´ng
      if (
        this.productsCache.length > 0 &&
        this.productsCacheTime &&
        Date.now() - this.productsCacheTime.getTime() < this.CACHE_DURATION
      ) {
        return this.productsCache;
      }

      this.logger.log('Äang táº£i sáº£n pháº©m tá»« database...');

      // Láº¥y sáº£n pháº©m kÃ¨m variants Ä‘á»ƒ cÃ³ mÃ u sáº¯c
      const { data, error } = await this.supabase
        .from('products')
        .select(`
          product_id,
          product_name,
          price,
          sale_price,
          description,
          image_url,
          status,
          categories (
            category_name
          ),
          product_variants (
            color,
            is_active
          ),
          inventory (
            quantity_available
          )
        `)
        .eq('status', 'active')
        .order('product_name');

      if (error) {
        this.logger.error(`Lá»—i láº¥y sáº£n pháº©m: ${error.message}`);
        return this.productsCache; // Tráº£ vá» cache cÅ© náº¿u lá»—i
      }

      // Chuyá»ƒn Ä‘á»•i sang format Product
      this.productsCache = (data || [])
        .filter((p: any) => {
          // Lá»c sáº£n pháº©m cÃ²n hÃ ng
          const totalStock = (p.inventory || []).reduce((sum: number, inv: any) => sum + (inv.quantity_available || 0), 0);
          return totalStock > 0 || p.inventory?.length === 0; // Náº¿u khÃ´ng cÃ³ inventory thÃ¬ váº«n hiá»‡n
        })
        .map((p: any): Product => {
          // Láº¥y danh sÃ¡ch mÃ u tá»« variants
          const colors: string[] = (p.product_variants || [])
            .filter((v: any) => v.is_active && v.color)
            .map((v: any) => v.color as string);
          
          // TÃ­nh tá»•ng stock
          const totalStock = (p.inventory || []).reduce((sum: number, inv: any) => sum + (inv.quantity_available || 0), 0);

          return {
            id: p.product_id.toString(),
            name: p.product_name,
            price: p.sale_price || p.price,
            emoji: this.getProductEmoji(p.categories?.category_name || ''),
            description: p.description || 'Sáº£n pháº©m cháº¥t lÆ°á»£ng cao',
            colors: colors.length > 0 ? [...new Set(colors)] as string[] : ['Máº·c Ä‘á»‹nh'], // Unique colors
            image_url: p.image_url,
            stock_quantity: totalStock,
          };
        });

      this.productsCacheTime = new Date();
      this.logger.log(`ÄÃ£ táº£i ${this.productsCache.length} sáº£n pháº©m tá»« database`);

      return this.productsCache;
    } catch (error) {
      this.logger.error(`Lá»—i loadProductsFromDatabase: ${error.message}`);
      return this.productsCache;
    }
  }

  /**
   * Láº¥y phone models tá»« database vá»›i cache
   */
  private async loadPhoneModelsFromDatabase(): Promise<PhoneModel[]> {
    try {
      // Kiá»ƒm tra cache cÃ²n hiá»‡u lá»±c khÃ´ng
      if (
        this.phoneModelsCache.length > 0 &&
        this.phoneModelsCacheTime &&
        Date.now() - this.phoneModelsCacheTime.getTime() < this.CACHE_DURATION
      ) {
        return this.phoneModelsCache;
      }

      this.logger.log('Äang táº£i phone models tá»« database...');

      const { data, error } = await this.supabase
        .from('phone_models')
        .select('model_id, brand_name, model_name, model_code, is_popular, is_active')
        .eq('is_active', true)
        .order('is_popular', { ascending: false })
        .order('brand_name')
        .order('model_name');

      if (error) {
        this.logger.error(`Lá»—i láº¥y phone models: ${error.message}`);
        return this.phoneModelsCache;
      }

      this.phoneModelsCache = data || [];
      this.phoneModelsCacheTime = new Date();
      this.logger.log(`ÄÃ£ táº£i ${this.phoneModelsCache.length} phone models tá»« database`);

      return this.phoneModelsCache;
    } catch (error) {
      this.logger.error(`Lá»—i loadPhoneModelsFromDatabase: ${error.message}`);
      return this.phoneModelsCache;
    }
  }

  /**
   * Láº¥y danh sÃ¡ch brands tá»« phone models
   */
  private async getPhoneBrands(): Promise<string[]> {
    const models = await this.loadPhoneModelsFromDatabase();
    const brands = [...new Set(models.map(m => m.brand_name))];
    return brands;
  }

  /**
   * Láº¥y phone models theo brand
   */
  private async getPhoneModelsByBrand(brandName: string): Promise<PhoneModel[]> {
    const models = await this.loadPhoneModelsFromDatabase();
    return models.filter(m => m.brand_name.toLowerCase() === brandName.toLowerCase());
  }

  /**
   * Láº¥y danh sÃ¡ch phone models (public API)
   */
  async getPhoneModelList(): Promise<{ brand: string; models: PhoneModel[] }[]> {
    const models = await this.loadPhoneModelsFromDatabase();
    
    // Group by brand
    const groupedByBrand: { [key: string]: PhoneModel[] } = {};
    models.forEach((model) => {
      if (!groupedByBrand[model.brand_name]) {
        groupedByBrand[model.brand_name] = [];
      }
      groupedByBrand[model.brand_name].push(model);
    });

    // Convert to array format
    return Object.entries(groupedByBrand).map(([brand, brandModels]) => ({
      brand,
      models: brandModels,
    }));
  }

  /**
   * Láº¥y emoji theo category
   */
  private getProductEmoji(categoryName: string): string {
    const emojiMap: Record<string, string> = {
      'á»p lÆ°ng': 'ðŸ“±',
      'á»p Ä‘iá»‡n thoáº¡i': 'ðŸ“±',
      'Phá»¥ kiá»‡n': 'ðŸŽ§',
      'Sáº¡c': 'ðŸ”Œ',
      'CÃ¡p': 'ðŸ”—',
      'Tai nghe': 'ðŸŽ§',
      'Bao da': 'ðŸ‘œ',
      'KÃ­nh cÆ°á»ng lá»±c': 'âœ¨',
      'GiÃ¡ Ä‘á»¡': 'ðŸ“',
    };
    
    for (const [key, emoji] of Object.entries(emojiMap)) {
      if (categoryName.toLowerCase().includes(key.toLowerCase())) {
        return emoji;
      }
    }
    return 'ðŸ“¦'; // Default emoji
  }

  /**
   * Láº¥y danh sÃ¡ch sáº£n pháº©m (public)
   */
  async getProducts(): Promise<Product[]> {
    return this.loadProductsFromDatabase();
  }

  /**
   * XÃ¡c minh webhook tá»« Facebook
   */
  verifyWebhook(mode: string, token: string, challenge: string): string | null {
    const verifyToken = this.configService.get('FACEBOOK_VERIFY_TOKEN');
    
    this.logger.log(`XÃ¡c minh webhook - Mode: ${mode}, Token: ${token}`);
    
    if (mode === 'subscribe' && token === verifyToken) {
      this.logger.log('Webhook Ä‘Ã£ Ä‘Æ°á»£c xÃ¡c minh thÃ nh cÃ´ng!');
      return challenge;
    }
    
    this.logger.warn('XÃ¡c minh webhook tháº¥t báº¡i!');
    return null;
  }

  /**
   * Xá»­ lÃ½ webhook event tá»« Facebook
   */
  async handleWebhook(payload: FacebookWebhookPayload): Promise<void> {
    try {
      this.logger.log(`Nháº­n webhook: ${JSON.stringify(payload)}`);

      if (payload.object !== 'page') {
        this.logger.warn('KhÃ´ng pháº£i page event, bá» qua');
        return;
      }

      // Xá»­ lÃ½ tá»«ng entry
      for (const entry of payload.entry) {
        for (const event of entry.messaging) {
          await this.processMessagingEvent(event);
        }
      }
    } catch (error) {
      this.logger.error(`Lá»—i xá»­ lÃ½ webhook: ${error.message}`, error.stack);
      throw error;
    }
  }

  /**
   * Xá»­ lÃ½ tá»«ng messaging event
   */
  private async processMessagingEvent(event: FacebookMessaging): Promise<void> {
    const senderId = event.sender.id;
    
    this.logger.log(`Xá»­ lÃ½ event tá»« user: ${senderId}`);

    // Xá»­ lÃ½ postback (khi user click button)
    if (event.postback) {
      await this.handlePostback(senderId, event.postback.payload);
      return;
    }

    // Xá»­ lÃ½ tin nháº¯n
    if (event.message) {
      // Xá»­ lÃ½ quick reply
      if (event.message.quick_reply) {
        await this.handleQuickReply(senderId, event.message.quick_reply.payload);
        return;
      }

      // Xá»­ lÃ½ tin nháº¯n text thÃ´ng thÆ°á»ng
      if (event.message.text) {
        await this.handleTextMessage(senderId, event.message.text);
        return;
      }
    }
  }

  /**
   * Xá»­ lÃ½ postback (button clicks)
   */
  private async handlePostback(senderId: string, payload: string): Promise<void> {
    this.logger.log(`Postback tá»« ${senderId}: ${payload}`);

    switch (payload) {
      case 'GET_STARTED':
        await this.sendWelcomeMessage(senderId);
        break;
      case 'VIEW_PRODUCTS':
        await this.sendProductList(senderId);
        break;
      case 'VIEW_ORDERS':
        await this.sendOrderHistory(senderId);
        break;
      case 'CONTACT_SUPPORT':
        await this.sendSupportInfo(senderId);
        break;
      default:
        // Xá»­ lÃ½ chá»n sáº£n pháº©m
        if (payload.startsWith('PRODUCT_')) {
          const productId = payload.replace('PRODUCT_', '');
          await this.handleProductSelection(senderId, productId);
        }
        break;
    }
  }

  /**
   * Xá»­ lÃ½ quick reply
   */
  private async handleQuickReply(senderId: string, payload: string): Promise<void> {
    this.logger.log(`Quick reply tá»« ${senderId}: ${payload}`);

    // Xá»­ lÃ½ xÃ¡c nháº­n Ä‘Æ¡n hÃ ng
    if (payload === 'CONFIRM_ORDER') {
      await this.confirmOrder(senderId);
      return;
    }
    if (payload === 'CANCEL_ORDER') {
      await this.cancelOrder(senderId);
      return;
    }

    // Xá»­ lÃ½ chá»n sáº£n pháº©m
    if (payload.startsWith('PRODUCT_')) {
      const productId = payload.replace('PRODUCT_', '');
      await this.handleProductSelection(senderId, productId);
      return;
    }

    // Xá»­ lÃ½ chá»n mÃ u sáº¯c
    if (payload.startsWith('COLOR_')) {
      const color = payload.replace('COLOR_', '');
      await this.handleColorSelection(senderId, color);
      return;
    }

    // Xá»­ lÃ½ chá»n brand Ä‘iá»‡n thoáº¡i
    if (payload.startsWith('BRAND_')) {
      const brand = payload.replace('BRAND_', '');
      await this.handleBrandSelection(senderId, brand);
      return;
    }

    // Xá»­ lÃ½ chá»n dÃ²ng mÃ¡y Ä‘iá»‡n thoáº¡i
    if (payload.startsWith('PHONEMODEL_')) {
      const modelId = payload.replace('PHONEMODEL_', '');
      await this.handlePhoneModelSelection(senderId, parseInt(modelId));
      return;
    }

    // Xá»­ lÃ½ menu sáº£n pháº©m
    if (payload === 'MENU_PRODUCTS' || payload === 'VIEW_PRODUCTS') {
      await this.sendProductList(senderId);
      return;
    }

    // Xá»­ lÃ½ xem Ä‘Æ¡n hÃ ng
    if (payload === 'VIEW_ORDERS') {
      await this.sendOrderHistory(senderId);
      return;
    }

    // Xá»­ lÃ½ há»— trá»£
    if (payload === 'CONTACT_SUPPORT') {
      await this.sendSupportInfo(senderId);
      return;
    }

    // Xá»­ lÃ½ menu
    if (payload === 'MENU') {
      await this.sendMainMenu(senderId);
      return;
    }
  }

  /**
   * Xá»­ lÃ½ tin nháº¯n text
   */
  private async handleTextMessage(senderId: string, text: string): Promise<void> {
    const normalizedText = text.toLowerCase().trim();
    this.logger.log(`Tin nháº¯n tá»« ${senderId}: ${text}`);

    // Láº¥y session hiá»‡n táº¡i cá»§a user
    const session = this.getUserSession(senderId);

    // Xá»­ lÃ½ cÃ¡c lá»‡nh cÆ¡ báº£n
    if (['menu', 'hi', 'hello', 'xin chÃ o', 'chÃ o', 'start', 'báº¯t Ä‘áº§u'].includes(normalizedText)) {
      await this.sendWelcomeMessage(senderId);
      return;
    }

    if (['sáº£n pháº©m', 'xem sáº£n pháº©m', 'mua hÃ ng', 'products'].includes(normalizedText)) {
      await this.sendProductList(senderId);
      return;
    }

    if (['Ä‘Æ¡n hÃ ng', 'xem Ä‘Æ¡n', 'orders', 'lá»‹ch sá»­'].includes(normalizedText)) {
      await this.sendOrderHistory(senderId);
      return;
    }

    if (['há»— trá»£', 'support', 'liÃªn há»‡', 'contact'].includes(normalizedText)) {
      await this.sendSupportInfo(senderId);
      return;
    }

    if (['há»§y', 'cancel', 'bá»', 'dá»«ng'].includes(normalizedText)) {
      await this.cancelOrder(senderId);
      return;
    }

    // Xá»­ lÃ½ theo tráº¡ng thÃ¡i conversation
    switch (session.state) {
      case ConversationState.WAITING_QUANTITY:
        await this.handleQuantityInput(senderId, text);
        break;
      case ConversationState.WAITING_NAME:
        await this.handleNameInput(senderId, text);
        break;
      case ConversationState.WAITING_PHONE:
        await this.handlePhoneInput(senderId, text);
        break;
      case ConversationState.WAITING_ADDRESS:
        await this.handleAddressInput(senderId, text);
        break;
      case ConversationState.WAITING_CONFIRM:
        await this.handleConfirmInput(senderId, text);
        break;
      default:
        // KhÃ´ng hiá»ƒu tin nháº¯n, gá»­i menu
        await this.sendUnknownMessage(senderId);
        break;
    }
  }

  /**
   * Gá»­i tin nháº¯n chÃ o má»«ng
   */
  private async sendWelcomeMessage(senderId: string): Promise<void> {
    // Reset session
    this.resetUserSession(senderId);

    const welcomeText = `Xin chÃ o! ðŸ‘‹ ChÃ o má»«ng báº¡n Ä‘áº¿n vá»›i Cá»­a hÃ ng á»p Ä‘iá»‡n thoáº¡i & Phá»¥ kiá»‡n! ðŸ“±

ðŸ›ï¸ ChÃºng tÃ´i chuyÃªn cung cáº¥p:
â€¢ á»p lÆ°ng Ä‘iá»‡n thoáº¡i cao cáº¥p
â€¢ Phá»¥ kiá»‡n chÃ­nh hÃ£ng
â€¢ GiÃ¡ cáº£ há»£p lÃ½, cháº¥t lÆ°á»£ng Ä‘áº£m báº£o

Báº¡n muá»‘n lÃ m gÃ¬ hÃ´m nay?`;

    await this.sendMessage(senderId, { text: welcomeText });
    await this.sendMainMenu(senderId);
  }

  /**
   * Gá»­i menu chÃ­nh
   */
  private async sendMainMenu(senderId: string): Promise<void> {
    const quickReplies: QuickReply[] = [
      { content_type: 'text', title: 'ðŸ“± Xem sáº£n pháº©m', payload: 'MENU_PRODUCTS' },
      { content_type: 'text', title: 'ðŸ“¦ ÄÆ¡n hÃ ng cá»§a tÃ´i', payload: 'VIEW_ORDERS' },
      { content_type: 'text', title: 'ðŸ’¬ Há»— trá»£', payload: 'CONTACT_SUPPORT' },
    ];

    await this.sendMessage(senderId, {
      text: 'Chá»n má»™t trong cÃ¡c tÃ¹y chá»n bÃªn dÆ°á»›i:',
      quick_replies: quickReplies,
    });
  }

  /**
   * Gá»­i danh sÃ¡ch sáº£n pháº©m
   */
  private async sendProductList(senderId: string): Promise<void> {
    // Cáº­p nháº­t tráº¡ng thÃ¡i
    this.updateUserSession(senderId, { state: ConversationState.WAITING_PRODUCT });

    // Láº¥y sáº£n pháº©m tá»« database
    const products = await this.loadProductsFromDatabase();

    if (products.length === 0) {
      await this.sendMessage(senderId, {
        text: 'ðŸ˜” Hiá»‡n táº¡i chÆ°a cÃ³ sáº£n pháº©m nÃ o. Vui lÃ²ng quay láº¡i sau!',
      });
      await this.sendMainMenu(senderId);
      return;
    }

    // Giá»›i háº¡n 10 sáº£n pháº©m (Facebook quick reply tá»‘i Ä‘a 13)
    const displayProducts = products.slice(0, 10);

    const productText = `ðŸ“± DANH SÃCH Sáº¢N PHáº¨M ðŸ“±

${displayProducts.map((p, i) => `${i + 1}. ${p.emoji} ${p.name} - ${this.formatPrice(p.price)}`).join('\n')}

Chá»n sáº£n pháº©m báº¡n muá»‘n mua:`;

    // RÃºt gá»n tÃªn náº¿u quÃ¡ dÃ i (Facebook giá»›i háº¡n 20 kÃ½ tá»± cho title)
    const quickReplies: QuickReply[] = displayProducts.map((p) => ({
      content_type: 'text' as const,
      title: this.truncateText(`${p.emoji} ${p.name}`, 20),
      payload: `PRODUCT_${p.id}`,
    }));

    await this.sendMessage(senderId, {
      text: productText,
      quick_replies: quickReplies,
    });
  }

  /**
   * RÃºt gá»n text náº¿u quÃ¡ dÃ i
   */
  private truncateText(text: string, maxLength: number): string {
    if (text.length <= maxLength) return text;
    return text.substring(0, maxLength - 3) + '...';
  }

  /**
   * Xá»­ lÃ½ khi khÃ¡ch chá»n sáº£n pháº©m
   */
  private async handleProductSelection(senderId: string, productId: string): Promise<void> {
    const products = await this.loadProductsFromDatabase();
    const product = products.find((p) => p.id === productId);
    
    if (!product) {
      await this.sendMessage(senderId, { text: 'âŒ Sáº£n pháº©m khÃ´ng tá»“n táº¡i. Vui lÃ²ng chá»n láº¡i.' });
      await this.sendProductList(senderId);
      return;
    }

    // LÆ°u sáº£n pháº©m Ä‘Ã£ chá»n
    this.updateUserSession(senderId, {
      selectedProduct: product,
      state: ConversationState.WAITING_PHONE_MODEL,
    });

    this.logger.log(`User ${senderId} Ä‘Ã£ chá»n sáº£n pháº©m: ${product.name}`);

    // Gá»­i thÃ´ng tin sáº£n pháº©m vÃ  há»i chá»n dÃ²ng mÃ¡y
    const productInfo = `âœ… Báº¡n Ä‘Ã£ chá»n: ${product.emoji} ${product.name}
ðŸ’° GiÃ¡: ${this.formatPrice(product.price)}
ðŸ“ MÃ´ táº£: ${product.description}

ðŸ“± Vui lÃ²ng chá»n HÃƒNG Ä‘iá»‡n thoáº¡i cá»§a báº¡n:`;

    // Láº¥y danh sÃ¡ch brands
    const brands = await this.getPhoneBrands();
    
    if (brands.length === 0) {
      // Náº¿u khÃ´ng cÃ³ phone models trong database, bá» qua bÆ°á»›c nÃ y
      this.updateUserSession(senderId, {
        state: ConversationState.WAITING_COLOR,
      });
      await this.sendColorSelection(senderId, product);
      return;
    }

    // Giá»›i háº¡n 10 brands (Facebook quick reply tá»‘i Ä‘a 13)
    const displayBrands = brands.slice(0, 10);
    
    const brandReplies: QuickReply[] = displayBrands.map((brand) => ({
      content_type: 'text' as const,
      title: this.getBrandEmoji(brand) + ' ' + this.truncateText(brand, 17),
      payload: `BRAND_${brand}`,
    }));

    await this.sendMessage(senderId, {
      text: productInfo,
      quick_replies: brandReplies,
    });
  }

  /**
   * Láº¥y emoji cho brand Ä‘iá»‡n thoáº¡i
   */
  private getBrandEmoji(brand: string): string {
    const emojiMap: Record<string, string> = {
      'Apple': 'ðŸŽ',
      'Samsung': 'ðŸ“±',
      'Xiaomi': 'ðŸ”·',
      'OPPO': 'ðŸ’š',
      'Vivo': 'ðŸ’™',
      'Realme': 'ðŸ’›',
      'Huawei': 'ðŸ”´',
      'OnePlus': 'ðŸ”´',
      'Google': 'ðŸ”µ',
      'Sony': 'âš«',
    };
    return emojiMap[brand] || 'ðŸ“±';
  }

  /**
   * Xá»­ lÃ½ khi khÃ¡ch chá»n brand Ä‘iá»‡n thoáº¡i
   */
  private async handleBrandSelection(senderId: string, brandName: string): Promise<void> {
    this.logger.log(`User ${senderId} Ä‘Ã£ chá»n brand: ${brandName}`);

    const models = await this.getPhoneModelsByBrand(brandName);
    
    if (models.length === 0) {
      await this.sendMessage(senderId, { 
        text: `âŒ KhÃ´ng tÃ¬m tháº¥y dÃ²ng mÃ¡y cho ${brandName}. Vui lÃ²ng chá»n hÃ£ng khÃ¡c.` 
      });
      // Gá»­i láº¡i danh sÃ¡ch brands
      const brands = await this.getPhoneBrands();
      const brandReplies: QuickReply[] = brands.slice(0, 10).map((brand) => ({
        content_type: 'text' as const,
        title: this.getBrandEmoji(brand) + ' ' + this.truncateText(brand, 17),
        payload: `BRAND_${brand}`,
      }));
      await this.sendMessage(senderId, {
        text: 'ðŸ“± Chá»n hÃ£ng Ä‘iá»‡n thoáº¡i:',
        quick_replies: brandReplies,
      });
      return;
    }

    // Giá»›i háº¡n 10 models (Facebook quick reply tá»‘i Ä‘a 13)
    const displayModels = models.slice(0, 10);
    
    const modelText = `ðŸ“± DÃ²ng mÃ¡y ${brandName}:

${displayModels.map((m, i) => `${i + 1}. ${m.model_name}${m.is_popular ? ' â­' : ''}`).join('\n')}

Chá»n dÃ²ng mÃ¡y cá»§a báº¡n:`;

    const modelReplies: QuickReply[] = displayModels.map((model) => ({
      content_type: 'text' as const,
      title: this.truncateText(model.model_name, 20),
      payload: `PHONEMODEL_${model.model_id}`,
    }));

    await this.sendMessage(senderId, {
      text: modelText,
      quick_replies: modelReplies,
    });
  }

  /**
   * Xá»­ lÃ½ khi khÃ¡ch chá»n dÃ²ng mÃ¡y Ä‘iá»‡n thoáº¡i
   */
  private async handlePhoneModelSelection(senderId: string, modelId: number): Promise<void> {
    const models = await this.loadPhoneModelsFromDatabase();
    const selectedModel = models.find(m => m.model_id === modelId);
    
    if (!selectedModel) {
      await this.sendMessage(senderId, { text: 'âŒ DÃ²ng mÃ¡y khÃ´ng tá»“n táº¡i. Vui lÃ²ng chá»n láº¡i.' });
      return;
    }

    // LÆ°u dÃ²ng mÃ¡y Ä‘Ã£ chá»n
    this.updateUserSession(senderId, {
      selectedPhoneModel: {
        model_id: selectedModel.model_id,
        brand_name: selectedModel.brand_name,
        model_name: selectedModel.model_name,
      },
      state: ConversationState.WAITING_COLOR,
    });

    this.logger.log(`User ${senderId} Ä‘Ã£ chá»n dÃ²ng mÃ¡y: ${selectedModel.brand_name} ${selectedModel.model_name}`);

    // Chuyá»ƒn sang chá»n mÃ u
    const session = this.getUserSession(senderId);
    if (session.selectedProduct) {
      await this.sendMessage(senderId, {
        text: `âœ… DÃ²ng mÃ¡y: ${selectedModel.brand_name} ${selectedModel.model_name}`,
      });
      await this.sendColorSelection(senderId, session.selectedProduct);
    }
  }

  /**
   * Gá»­i lá»±a chá»n mÃ u sáº¯c
   */
  private async sendColorSelection(senderId: string, product: Product): Promise<void> {
    const colorText = `ðŸŽ¨ Vui lÃ²ng chá»n mÃ u sáº¯c:`;

    const colorReplies: QuickReply[] = (product.colors || []).map((color) => ({
      content_type: 'text' as const,
      title: color,
      payload: `COLOR_${color}`,
    }));

    await this.sendMessage(senderId, {
      text: colorText,
      quick_replies: colorReplies,
    });
  }

  /**
   * Xá»­ lÃ½ khi khÃ¡ch chá»n mÃ u sáº¯c
   */
  private async handleColorSelection(senderId: string, color: string): Promise<void> {
    this.updateUserSession(senderId, {
      color: color,
      state: ConversationState.WAITING_QUANTITY,
    });

    this.logger.log(`User ${senderId} Ä‘Ã£ chá»n mÃ u: ${color}`);

    await this.sendMessage(senderId, {
      text: `ðŸŽ¨ MÃ u sáº¯c: ${color}\n\nðŸ“¦ Vui lÃ²ng nháº­p sá»‘ lÆ°á»£ng báº¡n muá»‘n mua (1-99):`,
    });
  }

  /**
   * Xá»­ lÃ½ nháº­p sá»‘ lÆ°á»£ng
   */
  private async handleQuantityInput(senderId: string, text: string): Promise<void> {
    const quantity = parseInt(text.trim(), 10);

    // Validate sá»‘ lÆ°á»£ng
    if (isNaN(quantity) || quantity < 1 || quantity > 99) {
      await this.sendMessage(senderId, {
        text: 'âŒ Sá»‘ lÆ°á»£ng khÃ´ng há»£p lá»‡. Vui lÃ²ng nháº­p sá»‘ tá»« 1 Ä‘áº¿n 99:',
      });
      return;
    }

    this.updateUserSession(senderId, {
      quantity: quantity,
      state: ConversationState.WAITING_NAME,
    });

    this.logger.log(`User ${senderId} Ä‘Ã£ nháº­p sá»‘ lÆ°á»£ng: ${quantity}`);

    await this.sendMessage(senderId, {
      text: `ðŸ“¦ Sá»‘ lÆ°á»£ng: ${quantity}\n\nðŸ‘¤ Vui lÃ²ng nháº­p Há»Œ VÃ€ TÃŠN ngÆ°á»i nháº­n hÃ ng:`,
    });
  }

  /**
   * Xá»­ lÃ½ nháº­p tÃªn
   */
  private async handleNameInput(senderId: string, text: string): Promise<void> {
    const name = text.trim();

    // Validate tÃªn
    if (name.length < 2 || name.length > 100) {
      await this.sendMessage(senderId, {
        text: 'âŒ TÃªn khÃ´ng há»£p lá»‡. Vui lÃ²ng nháº­p há» tÃªn Ä‘áº§y Ä‘á»§ (2-100 kÃ½ tá»±):',
      });
      return;
    }

    this.updateUserSession(senderId, {
      customerName: name,
      state: ConversationState.WAITING_PHONE,
    });

    this.logger.log(`User ${senderId} Ä‘Ã£ nháº­p tÃªn: ${name}`);

    await this.sendMessage(senderId, {
      text: `ðŸ‘¤ TÃªn: ${name}\n\nðŸ“ž Vui lÃ²ng nháº­p Sá» ÄIá»†N THOáº I liÃªn há»‡ (10-11 sá»‘):`,
    });
  }

  /**
   * Xá»­ lÃ½ nháº­p sá»‘ Ä‘iá»‡n thoáº¡i
   */
  private async handlePhoneInput(senderId: string, text: string): Promise<void> {
    const phone = text.replace(/\s/g, '').trim();

    // Validate sá»‘ Ä‘iá»‡n thoáº¡i Viá»‡t Nam
    const phoneRegex = /^(0|84|\+84)?[3-9][0-9]{8}$/;
    if (!phoneRegex.test(phone)) {
      await this.sendMessage(senderId, {
        text: 'âŒ Sá»‘ Ä‘iá»‡n thoáº¡i khÃ´ng há»£p lá»‡. Vui lÃ²ng nháº­p sá»‘ Ä‘iá»‡n thoáº¡i Viá»‡t Nam (VD: 0912345678):',
      });
      return;
    }

    // Chuáº©n hÃ³a sá»‘ Ä‘iá»‡n thoáº¡i
    let normalizedPhone = phone;
    if (phone.startsWith('+84')) {
      normalizedPhone = '0' + phone.slice(3);
    } else if (phone.startsWith('84')) {
      normalizedPhone = '0' + phone.slice(2);
    }

    this.updateUserSession(senderId, {
      phone: normalizedPhone,
      state: ConversationState.WAITING_ADDRESS,
    });

    this.logger.log(`User ${senderId} Ä‘Ã£ nháº­p SÄT: ${normalizedPhone}`);

    await this.sendMessage(senderId, {
      text: `ðŸ“ž SÄT: ${normalizedPhone}\n\nðŸ  Vui lÃ²ng nháº­p Äá»ŠA CHá»ˆ giao hÃ ng chi tiáº¿t (sá»‘ nhÃ , Ä‘Æ°á»ng, phÆ°á»ng/xÃ£, quáº­n/huyá»‡n, tá»‰nh/thÃ nh phá»‘):`,
    });
  }

  /**
   * Xá»­ lÃ½ nháº­p Ä‘á»‹a chá»‰
   */
  private async handleAddressInput(senderId: string, text: string): Promise<void> {
    const address = text.trim();

    // Validate Ä‘á»‹a chá»‰
    if (address.length < 10 || address.length > 500) {
      await this.sendMessage(senderId, {
        text: 'âŒ Äá»‹a chá»‰ khÃ´ng há»£p lá»‡. Vui lÃ²ng nháº­p Ä‘á»‹a chá»‰ chi tiáº¿t hÆ¡n (10-500 kÃ½ tá»±):',
      });
      return;
    }

    this.updateUserSession(senderId, {
      address: address,
      state: ConversationState.WAITING_CONFIRM,
    });

    this.logger.log(`User ${senderId} Ä‘Ã£ nháº­p Ä‘á»‹a chá»‰: ${address}`);

    // Hiá»ƒn thá»‹ xÃ¡c nháº­n Ä‘Æ¡n hÃ ng
    await this.sendOrderConfirmation(senderId);
  }

  /**
   * Gá»­i xÃ¡c nháº­n Ä‘Æ¡n hÃ ng
   */
  private async sendOrderConfirmation(senderId: string): Promise<void> {
    const session = this.getUserSession(senderId);
    const totalPrice = (session.selectedProduct?.price || 0) * (session.quantity || 0);

    // Táº¡o chuá»—i hiá»ƒn thá»‹ dÃ²ng mÃ¡y náº¿u cÃ³
    const phoneModelText = session.selectedPhoneModel 
      ? `ðŸ“± DÃ²ng mÃ¡y: ${session.selectedPhoneModel.brand_name} ${session.selectedPhoneModel.model_name}\n` 
      : '';

    const confirmText = `ðŸ“‹ XÃC NHáº¬N ÄÆ N HÃ€NG ðŸ“‹
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ðŸ“± Sáº£n pháº©m: ${session.selectedProduct?.emoji} ${session.selectedProduct?.name}
${phoneModelText}ðŸŽ¨ MÃ u sáº¯c: ${session.color}
ðŸ“¦ Sá»‘ lÆ°á»£ng: ${session.quantity}
ðŸ’° ÄÆ¡n giÃ¡: ${this.formatPrice(session.selectedProduct?.price || 0)}

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ðŸ’µ Tá»”NG TIá»€N: ${this.formatPrice(totalPrice)}
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ðŸ‘¤ NgÆ°á»i nháº­n: ${session.customerName}
ðŸ“ž Äiá»‡n thoáº¡i: ${session.phone}
ðŸ  Äá»‹a chá»‰: ${session.address}

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ðŸšš PhÃ­ ship: MIá»„N PHÃ
ðŸ’³ Thanh toÃ¡n: Khi nháº­n hÃ ng (COD)

Báº¡n xÃ¡c nháº­n Ä‘áº·t hÃ ng?`;

    const quickReplies: QuickReply[] = [
      { content_type: 'text', title: 'âœ… XÃ¡c nháº­n Ä‘áº·t hÃ ng', payload: 'CONFIRM_ORDER' },
      { content_type: 'text', title: 'âŒ Há»§y Ä‘Æ¡n', payload: 'CANCEL_ORDER' },
    ];

    await this.sendMessage(senderId, {
      text: confirmText,
      quick_replies: quickReplies,
    });
  }

  /**
   * Xá»­ lÃ½ input xÃ¡c nháº­n (text)
   */
  private async handleConfirmInput(senderId: string, text: string): Promise<void> {
    const normalizedText = text.toLowerCase().trim();

    if (['cÃ³', 'yes', 'ok', 'Ä‘á»“ng Ã½', 'xÃ¡c nháº­n', 'confirm'].includes(normalizedText)) {
      await this.confirmOrder(senderId);
    } else if (['khÃ´ng', 'no', 'há»§y', 'cancel', 'bá»'].includes(normalizedText)) {
      await this.cancelOrder(senderId);
    } else {
      await this.sendMessage(senderId, {
        text: 'Vui lÃ²ng chá»n "XÃ¡c nháº­n Ä‘áº·t hÃ ng" hoáº·c "Há»§y Ä‘Æ¡n"',
      });
      await this.sendOrderConfirmation(senderId);
    }
  }

  /**
   * XÃ¡c nháº­n vÃ  lÆ°u Ä‘Æ¡n hÃ ng
   */
  private async confirmOrder(senderId: string): Promise<void> {
    const session = this.getUserSession(senderId);

    // Kiá»ƒm tra session cÃ³ Ä‘á»§ thÃ´ng tin khÃ´ng
    if (!session.selectedProduct || !session.customerName || !session.phone || !session.address) {
      await this.sendMessage(senderId, {
        text: 'âŒ ThÃ´ng tin Ä‘Æ¡n hÃ ng khÃ´ng Ä‘áº§y Ä‘á»§. Vui lÃ²ng báº¯t Ä‘áº§u láº¡i.',
      });
      await this.sendProductList(senderId);
      return;
    }

    try {
      const totalPrice = (session.selectedProduct.price || 0) * (session.quantity || 0);

      // Táº¡o Ä‘Æ¡n hÃ ng
      const order: MessengerOrder = {
        facebook_user_id: senderId,
        customer_name: session.customerName,
        phone: session.phone,
        address: session.address,
        product_name: session.selectedProduct.name,
        product_price: session.selectedProduct.price,
        quantity: session.quantity || 1,
        color: session.color,
        phone_model_id: session.selectedPhoneModel?.model_id,
        phone_model_name: session.selectedPhoneModel 
          ? `${session.selectedPhoneModel.brand_name} ${session.selectedPhoneModel.model_name}` 
          : undefined,
        total_price: totalPrice,
        status: OrderStatus.PENDING,
      };

      // LÆ°u vÃ o Supabase (báº£ng orders chÃ­nh)
      const savedOrder = await this.saveOrderToSupabase(order);
      this.logger.log(`ÄÃ£ lÆ°u Ä‘Æ¡n hÃ ng: ${JSON.stringify(savedOrder)}`);

      // Gá»­i webhook Ä‘áº¿n há»‡ thá»‘ng quáº£n lÃ½
      await this.sendWebhookToAdmin(order, savedOrder?.order_number || savedOrder?.id);

      // Gá»­i thÃ´ng bÃ¡o thÃ nh cÃ´ng
      await this.sendMessage(senderId, {
        text: `ðŸŽ‰ Äáº¶T HÃ€NG THÃ€NH CÃ”NG! ðŸŽ‰
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ðŸ“¦ MÃ£ Ä‘Æ¡n hÃ ng: #${savedOrder?.order_number || savedOrder?.id || 'N/A'}
ðŸ’µ Tá»•ng tiá»n: ${this.formatPrice(totalPrice)}

ðŸ“ž ChÃºng tÃ´i sáº½ liÃªn há»‡ xÃ¡c nháº­n Ä‘Æ¡n hÃ ng trong vÃ²ng 30 phÃºt!

ðŸšš Dá»± kiáº¿n giao hÃ ng: 2-3 ngÃ y

Cáº£m Æ¡n báº¡n Ä‘Ã£ mua hÃ ng! â¤ï¸`,
      });

      // Reset session
      this.resetUserSession(senderId);

      // Gá»­i menu tiáº¿p tá»¥c mua hÃ ng
      await this.sendMessage(senderId, {
        text: 'Báº¡n cÃ³ muá»‘n tiáº¿p tá»¥c mua sáº¯m khÃ´ng?',
        quick_replies: [
          { content_type: 'text', title: 'ðŸ“± Xem sáº£n pháº©m', payload: 'MENU_PRODUCTS' },
          { content_type: 'text', title: 'ðŸ“¦ Xem Ä‘Æ¡n hÃ ng', payload: 'VIEW_ORDERS' },
        ],
      });
    } catch (error) {
      this.logger.error(`Lá»—i lÆ°u Ä‘Æ¡n hÃ ng: ${error.message}`, error.stack);
      await this.sendMessage(senderId, {
        text: 'âŒ CÃ³ lá»—i xáº£y ra khi xá»­ lÃ½ Ä‘Æ¡n hÃ ng. Vui lÃ²ng thá»­ láº¡i sau hoáº·c liÃªn há»‡ hotline: 0123456789',
      });
    }
  }

  /**
   * Há»§y Ä‘Æ¡n hÃ ng
   */
  private async cancelOrder(senderId: string): Promise<void> {
    this.resetUserSession(senderId);

    await this.sendMessage(senderId, {
      text: 'âŒ ÄÃ£ há»§y Ä‘Æ¡n hÃ ng.\n\nBáº¡n cÃ³ thá»ƒ tiáº¿p tá»¥c mua sáº¯m báº¥t cá»© lÃºc nÃ o!',
    });

    await this.sendMainMenu(senderId);
  }

  /**
   * Táº¡o mÃ£ Ä‘Æ¡n hÃ ng duy nháº¥t
   */
  private generateOrderNumber(): string {
    const date = new Date();
    const dateStr = date.toISOString().slice(0, 10).replace(/-/g, '');
    const random = Math.random().toString(36).substring(2, 8).toUpperCase();
    return `MSG${dateStr}${random}`;
  }

  /**
   * LÆ°u Ä‘Æ¡n hÃ ng vÃ o báº£ng orders chÃ­nh cá»§a há»‡ thá»‘ng
   */
  private async saveOrderToSupabase(order: MessengerOrder): Promise<any> {
    try {
      const session = this.getUserSession(order.facebook_user_id);
      const orderNumber = this.generateOrderNumber();

      // 1. Táº¡o Ä‘Æ¡n hÃ ng trong báº£ng orders chÃ­nh
      const { data: orderData, error: orderError } = await this.supabase
        .from('orders')
        .insert([
          {
            order_number: orderNumber,
            // customer_id Ä‘á»ƒ null vÃ¬ khÃ¡ch tá»« Messenger chÆ°a cÃ³ tÃ i khoáº£n
            // Facebook ID Ä‘Æ°á»£c lÆ°u trong customer_note Ä‘á»ƒ tra cá»©u
            subtotal: order.total_price,
            discount_amount: 0,
            shipping_fee: 0,
            total_amount: order.total_price,
            payment_method: 'cod', // Thanh toÃ¡n khi nháº­n hÃ ng
            order_status: 'pending',
            payment_status: 'unpaid',
            shipping_full_name: order.customer_name,
            shipping_phone: order.phone,
            shipping_address: order.address,
            // LÆ°u Facebook ID á»Ÿ Ä‘áº§u Ä‘á»ƒ dá»… tra cá»©u
            customer_note: `[FB:${order.facebook_user_id}] ${order.customer_name} - ${order.phone}${order.phone_model_name ? ` | DÃ²ng mÃ¡y: ${order.phone_model_name}` : ''}${order.color ? ` | MÃ u: ${order.color}` : ''}`,
            created_at: new Date().toISOString(),
            updated_at: new Date().toISOString(),
          },
        ])
        .select()
        .single();

      if (orderError) {
        this.logger.error(`Lá»—i táº¡o order: ${orderError.message}`);
        throw orderError;
      }

      this.logger.log(`ÄÃ£ táº¡o Ä‘Æ¡n hÃ ng #${orderData.order_id}`);

      // 2. Táº¡o order_items
      const { data: itemData, error: itemError } = await this.supabase
        .from('order_items')
        .insert([
          {
            order_id: orderData.order_id,
            product_id: parseInt(session.selectedProduct?.id || '0', 10),
            product_name: order.product_name,
            variant_name: order.color || null, // LÆ°u mÃ u vÃ o variant_name
            phone_model_id: order.phone_model_id || null,
            phone_model_name: order.phone_model_name || null,
            sku: `MSG-${Date.now()}`, // SKU táº¡m
            quantity: order.quantity,
            unit_price: order.product_price,
            discount_amount: 0,
            total_price: order.total_price,
          },
        ])
        .select();

      if (itemError) {
        this.logger.error(`Lá»—i táº¡o order_item: ${itemError.message}`);
        // KhÃ´ng throw, váº«n tiáº¿p tá»¥c
      }

      // 3. Cáº­p nháº­t stock sáº£n pháº©m
      if (session.selectedProduct?.id) {
        const productId = parseInt(session.selectedProduct.id, 10);
        const { error: stockError } = await this.supabase.rpc('decrement_stock', {
          p_product_id: productId,
          p_quantity: order.quantity,
        });
        
        if (stockError) {
          this.logger.warn(`KhÃ´ng thá»ƒ giáº£m stock: ${stockError.message}`);
          // Thá»­ cÃ¡ch khÃ¡c náº¿u function khÃ´ng tá»“n táº¡i
          const { data: product } = await this.supabase
            .from('products')
            .select('stock_quantity')
            .eq('product_id', productId)
            .single();
          
          if (product) {
            await this.supabase
              .from('products')
              .update({ stock_quantity: Math.max(0, product.stock_quantity - order.quantity) })
              .eq('product_id', productId);
          }
        }
      }

      // Clear cache Ä‘á»ƒ láº¥y stock má»›i
      this.productsCacheTime = null;

      return {
        id: orderData.order_id,
        order_number: orderNumber,
        ...orderData,
      };
    } catch (error) {
      this.logger.error(`Lá»—i lÆ°u Ä‘Æ¡n hÃ ng: ${error.message}`);
      throw error;
    }
  }

  /**
   * Gá»­i webhook Ä‘áº¿n há»‡ thá»‘ng quáº£n lÃ½ vá»›i retry logic
   */
  private async sendWebhookToAdmin(order: MessengerOrder, orderId?: string): Promise<void> {
    const webhookUrl = this.configService.get('WEBHOOK_URL');
    
    if (!webhookUrl) {
      this.logger.warn('WEBHOOK_URL chÆ°a Ä‘Æ°á»£c cáº¥u hÃ¬nh');
      return;
    }

    const payload: WebhookOrderPayload = {
      customer_name: order.customer_name,
      phone: order.phone,
      address: order.address,
      product: order.product_name,
      quantity: order.quantity,
      color: order.color,
      notes: order.notes,
      total_price: order.total_price,
      facebook_user_id: order.facebook_user_id,
      order_id: orderId,
      created_at: new Date().toISOString(),
    };

    // Retry 3 láº§n
    const maxRetries = 3;
    const retryDelay = 2000; // 2 giÃ¢y

    for (let attempt = 1; attempt <= maxRetries; attempt++) {
      try {
        this.logger.log(`Gá»­i webhook (láº§n ${attempt}/${maxRetries}): ${webhookUrl}`);
        
        const response = await axios.post(webhookUrl, payload, {
          timeout: 5000, // 5 giÃ¢y timeout
          headers: {
            'Content-Type': 'application/json',
          },
        });

        this.logger.log(`Webhook thÃ nh cÃ´ng: ${response.status}`);
        return;
      } catch (error) {
        this.logger.error(`Webhook tháº¥t báº¡i (láº§n ${attempt}/${maxRetries}): ${error.message}`);
        
        if (attempt < maxRetries) {
          this.logger.log(`Chá» ${retryDelay}ms trÆ°á»›c khi thá»­ láº¡i...`);
          await this.delay(retryDelay);
        }
      }
    }

    this.logger.error(`Webhook tháº¥t báº¡i sau ${maxRetries} láº§n thá»­!`);
  }

  /**
   * Gá»­i lá»‹ch sá»­ Ä‘Æ¡n hÃ ng (láº¥y tá»« báº£ng orders chÃ­nh)
   */
  private async sendOrderHistory(senderId: string): Promise<void> {
    try {
      // TÃ¬m Ä‘Æ¡n hÃ ng theo ghi chÃº cÃ³ chá»©a Facebook ID [FB:xxxxx]
      const { data: orders, error } = await this.supabase
        .from('orders')
        .select(`
          order_id,
          order_number,
          total_amount,
          order_status,
          payment_status,
          created_at,
          order_items (
            product_name,
            quantity,
            variant_name
          )
        `)
        .ilike('customer_note', `%[FB:${senderId}]%`)
        .order('created_at', { ascending: false })
        .limit(5);

      if (error) {
        throw error;
      }

      if (!orders || orders.length === 0) {
        await this.sendMessage(senderId, {
          text: 'ðŸ“¦ Báº¡n chÆ°a cÃ³ Ä‘Æ¡n hÃ ng nÃ o.\n\nHÃ£y báº¯t Ä‘áº§u mua sáº¯m ngay!',
          quick_replies: [
            { content_type: 'text', title: 'ðŸ“± Xem sáº£n pháº©m', payload: 'MENU_PRODUCTS' },
          ],
        });
        return;
      }

      let orderText = 'ðŸ“¦ ÄÆ N HÃ€NG Cá»¦A Báº N ðŸ“¦\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n';

      orders.forEach((order: any, index: number) => {
        const statusEmoji = this.getStatusEmoji(order.order_status);
        const items = order.order_items || [];
        const itemInfo = items.map((item: any) => `${item.product_name} x${item.quantity}`).join(', ');
        
        orderText += `${index + 1}. #${order.order_number || order.order_id}\n`;
        orderText += `   ðŸ“± ${itemInfo || 'Sáº£n pháº©m'}\n`;
        orderText += `   ðŸ’µ ${this.formatPrice(order.total_amount)}\n`;
        orderText += `   ${statusEmoji} ${this.getStatusText(order.order_status)}\n\n`;
      });

      await this.sendMessage(senderId, {
        text: orderText,
        quick_replies: [
          { content_type: 'text', title: 'ðŸ“± Mua thÃªm', payload: 'MENU_PRODUCTS' },
          { content_type: 'text', title: 'ðŸ’¬ Há»— trá»£', payload: 'CONTACT_SUPPORT' },
        ],
      });
    } catch (error) {
      this.logger.error(`Lá»—i láº¥y lá»‹ch sá»­ Ä‘Æ¡n hÃ ng: ${error.message}`);
      await this.sendMessage(senderId, {
        text: 'âŒ CÃ³ lá»—i xáº£y ra. Vui lÃ²ng thá»­ láº¡i sau.',
      });
    }
  }

  /**
   * Gá»­i thÃ´ng tin há»— trá»£
   */
  private async sendSupportInfo(senderId: string): Promise<void> {
    await this.sendMessage(senderId, {
      text: `ðŸ’¬ THÃ”NG TIN Há»– TRá»¢ ðŸ’¬
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ðŸ“ž Hotline: 0123 456 789
ðŸ“§ Email: support@shop.com
â° Giá» lÃ m viá»‡c: 8:00 - 22:00

ðŸ“ Äá»‹a chá»‰ cá»­a hÃ ng:
123 ÄÆ°á»ng ABC, Quáº­n XYZ
TP. Há»“ ChÃ­ Minh

NhÃ¢n viÃªn sáº½ há»— trá»£ báº¡n sá»›m nháº¥t! â¤ï¸`,
      quick_replies: [
        { content_type: 'text', title: 'ðŸ“± Xem sáº£n pháº©m', payload: 'MENU_PRODUCTS' },
        { content_type: 'text', title: 'ðŸ  Menu chÃ­nh', payload: 'MENU' },
      ],
    });
  }

  /**
   * Gá»­i tin nháº¯n khÃ´ng hiá»ƒu
   */
  private async sendUnknownMessage(senderId: string): Promise<void> {
    await this.sendMessage(senderId, {
      text: 'ðŸ¤” Xin lá»—i, tÃ´i chÆ°a hiá»ƒu Ã½ báº¡n.\n\nVui lÃ²ng chá»n tá»« menu bÃªn dÆ°á»›i hoáº·c gÃµ "menu" Ä‘á»ƒ xem cÃ¡c tÃ¹y chá»n.',
      quick_replies: [
        { content_type: 'text', title: 'ðŸ“± Xem sáº£n pháº©m', payload: 'MENU_PRODUCTS' },
        { content_type: 'text', title: 'ðŸ“¦ ÄÆ¡n hÃ ng', payload: 'VIEW_ORDERS' },
        { content_type: 'text', title: 'ðŸ’¬ Há»— trá»£', payload: 'CONTACT_SUPPORT' },
      ],
    });
  }

  /**
   * Gá»­i tin nháº¯n Ä‘áº¿n Facebook
   */
  private async sendMessage(recipientId: string, message: any): Promise<void> {
    const accessToken = this.configService.get('FACEBOOK_PAGE_ACCESS_TOKEN');

    if (!accessToken) {
      this.logger.error('FACEBOOK_PAGE_ACCESS_TOKEN chÆ°a Ä‘Æ°á»£c cáº¥u hÃ¬nh!');
      return;
    }

    try {
      const response = await axios.post(
        this.FB_API_URL,
        {
          recipient: { id: recipientId },
          message: message,
        },
        {
          params: { access_token: accessToken },
          timeout: 5000, // 5 giÃ¢y timeout theo yÃªu cáº§u webhook
        },
      );

      this.logger.log(`ÄÃ£ gá»­i tin nháº¯n Ä‘áº¿n ${recipientId}: ${response.status}`);
    } catch (error) {
      this.logger.error(`Lá»—i gá»­i tin nháº¯n: ${error.response?.data || error.message}`);
      throw error;
    }
  }

  // ==================== HELPER FUNCTIONS ====================

  /**
   * Láº¥y session cá»§a user
   */
  private getUserSession(userId: string): UserSession {
    if (!this.userSessions.has(userId)) {
      this.resetUserSession(userId);
    }
    return this.userSessions.get(userId)!;
  }

  /**
   * Cáº­p nháº­t session cá»§a user
   */
  private updateUserSession(userId: string, updates: Partial<UserSession>): void {
    const session = this.getUserSession(userId);
    this.userSessions.set(userId, {
      ...session,
      ...updates,
      updatedAt: new Date(),
    });
  }

  /**
   * Reset session cá»§a user
   */
  private resetUserSession(userId: string): void {
    this.userSessions.set(userId, {
      state: ConversationState.IDLE,
      createdAt: new Date(),
      updatedAt: new Date(),
    });
  }

  /**
   * Format giÃ¡ tiá»n VNÄ
   */
  private formatPrice(price: number): string {
    return new Intl.NumberFormat('vi-VN', {
      style: 'currency',
      currency: 'VND',
    }).format(price);
  }

  /**
   * Láº¥y emoji theo tráº¡ng thÃ¡i Ä‘Æ¡n hÃ ng
   */
  private getStatusEmoji(status: string): string {
    const emojis: Record<string, string> = {
      pending: 'â³',
      confirmed: 'âœ…',
      processing: 'ðŸ”„',
      shipping: 'ðŸšš',
      delivered: 'ðŸ“¦',
      cancelled: 'âŒ',
    };
    return emojis[status] || 'â“';
  }

  /**
   * Láº¥y text theo tráº¡ng thÃ¡i Ä‘Æ¡n hÃ ng
   */
  private getStatusText(status: string): string {
    const texts: Record<string, string> = {
      pending: 'Chá» xÃ¡c nháº­n',
      confirmed: 'ÄÃ£ xÃ¡c nháº­n',
      processing: 'Äang xá»­ lÃ½',
      shipping: 'Äang giao hÃ ng',
      delivered: 'ÄÃ£ giao hÃ ng',
      cancelled: 'ÄÃ£ há»§y',
    };
    return texts[status] || 'KhÃ´ng xÃ¡c Ä‘á»‹nh';
  }

  /**
   * Delay helper
   */
  private delay(ms: number): Promise<void> {
    return new Promise((resolve) => setTimeout(resolve, ms));
  }

  /**
   * Láº¥y danh sÃ¡ch sáº£n pháº©m (public API)
   */
  async getProductList(): Promise<Product[]> {
    return this.loadProductsFromDatabase();
  }

  /**
   * Láº¥y Ä‘Æ¡n hÃ ng theo ID (public API)
   */
  async getOrderById(orderId: string): Promise<any> {
    const { data, error } = await this.supabase
      .from('orders')
      .select(`
        *,
        order_items (*)
      `)
      .eq('id', orderId)
      .single();

    if (error) {
      this.logger.error(`Lá»—i láº¥y Ä‘Æ¡n hÃ ng: ${error.message}`);
      return null;
    }

    return data;
  }

  /**
   * Láº¥y táº¥t cáº£ Ä‘Æ¡n hÃ ng (admin API)
   */
  async getAllOrders(limit = 50, offset = 0): Promise<any> {
    const { data, error, count } = await this.supabase
      .from('messenger_orders')
      .select('*', { count: 'exact' })
      .order('created_at', { ascending: false })
      .range(offset, offset + limit - 1);

    if (error) {
      this.logger.error(`Lá»—i láº¥y danh sÃ¡ch Ä‘Æ¡n hÃ ng: ${error.message}`);
      return { orders: [], total: 0 };
    }

    return { orders: data, total: count };
  }

  /**
   * Cáº­p nháº­t tráº¡ng thÃ¡i Ä‘Æ¡n hÃ ng (admin API)
   */
  async updateOrderStatus(orderId: string, status: OrderStatus): Promise<any> {
    const { data, error } = await this.supabase
      .from('messenger_orders')
      .update({ status, updated_at: new Date().toISOString() })
      .eq('id', orderId)
      .select()
      .single();

    if (error) {
      this.logger.error(`Lá»—i cáº­p nháº­t tráº¡ng thÃ¡i: ${error.message}`);
      throw error;
    }

    return data;
  }
}




################################################################################
## FILE 54: messenger.module.ts
## Path: backend/src/messenger/messenger.module.ts
################################################################################

/**
 * Messenger Module
 * Module chá»©a cÃ¡c thÃ nh pháº§n cá»§a Messenger Bot
 */

import { Module } from '@nestjs/common';
import { ConfigModule } from '@nestjs/config';
import { MessengerController } from './messenger.controller';
import { MessengerService } from './messenger.service';

@Module({
  imports: [ConfigModule],
  controllers: [MessengerController],
  providers: [MessengerService],
  exports: [MessengerService],
})
export class MessengerModule {}




################################################################################
## FILE 55: messenger.dto.ts
## Path: backend/src/messenger/messenger.dto.ts
################################################################################

/**
 * Messenger DTOs
 * Data Transfer Objects cho Messenger Controller
 */

// DTO cho Facebook Webhook Entry Messaging
export class FacebookMessagingDto {
  sender: { id: string };
  recipient: { id: string };
  timestamp: number;
  message?: {
    mid: string;
    text?: string;
    quick_reply?: { payload: string };
    attachments?: any[];
  };
  postback?: {
    title: string;
    payload: string;
  };
}

// DTO cho Facebook Webhook Entry
export class FacebookEntryDto {
  id: string;
  time: number;
  messaging: FacebookMessagingDto[];
}

// DTO cho Facebook Webhook Payload
export class FacebookWebhookPayloadDto {
  object: string;
  entry: FacebookEntryDto[];
}

// DTO cho cáº­p nháº­t tráº¡ng thÃ¡i Ä‘Æ¡n hÃ ng
export class UpdateOrderStatusDto {
  status: string;
}

// DTO cho query params láº¥y Ä‘Æ¡n hÃ ng
export class GetOrdersQueryDto {
  limit?: string;
  offset?: string;
}




################################################################################
## FILE 56: messenger.controller.ts
## Path: backend/src/messenger/messenger.controller.ts
################################################################################

/**
 * Messenger Controller
 * API endpoints cho Facebook Messenger Webhook vÃ  quáº£n lÃ½ Ä‘Æ¡n hÃ ng
 */

import {
  Controller,
  Get,
  Post,
  Put,
  Body,
  Query,
  Param,
  HttpCode,
  HttpStatus,
  Logger,
  BadRequestException,
  NotFoundException,
} from '@nestjs/common';
import { MessengerService } from './messenger.service';
import { OrderStatus } from './messenger.types';
import { FacebookWebhookPayloadDto } from './messenger.dto';

@Controller('messenger')
export class MessengerController {
  private readonly logger = new Logger(MessengerController.name);

  constructor(private readonly messengerService: MessengerService) {}

  /**
   * GET /messenger/webhook
   * XÃ¡c minh webhook tá»« Facebook
   * Facebook sáº½ gá»i endpoint nÃ y khi cáº¥u hÃ¬nh webhook
   */
  @Get('webhook')
  verifyWebhook(
    @Query('hub.mode') mode: string,
    @Query('hub.verify_token') token: string,
    @Query('hub.challenge') challenge: string,
  ): string {
    this.logger.log(`Nháº­n yÃªu cáº§u xÃ¡c minh webhook - Mode: ${mode}`);

    if (!mode || !token) {
      this.logger.warn('Thiáº¿u mode hoáº·c token');
      throw new BadRequestException('Missing mode or token');
    }

    const result = this.messengerService.verifyWebhook(mode, token, challenge);

    if (result) {
      this.logger.log('XÃ¡c minh webhook thÃ nh cÃ´ng');
      return result;
    }

    this.logger.warn('XÃ¡c minh webhook tháº¥t báº¡i - Token khÃ´ng khá»›p');
    throw new BadRequestException('Verification failed');
  }

  /**
   * POST /messenger/webhook
   * Nháº­n sá»± kiá»‡n tá»« Facebook Messenger
   * Táº¥t cáº£ tin nháº¯n, postback sáº½ Ä‘Æ°á»£c gá»­i Ä‘áº¿n Ä‘Ã¢y
   */
  @Post('webhook')
  @HttpCode(HttpStatus.OK)
  async handleWebhook(@Body() payload: FacebookWebhookPayloadDto): Promise<string> {
    this.logger.log(`Nháº­n webhook event: ${JSON.stringify(payload).substring(0, 200)}...`);

    // Pháº£n há»“i ngay trong 5 giÃ¢y theo yÃªu cáº§u cá»§a Facebook
    // Xá»­ lÃ½ async Ä‘á»ƒ khÃ´ng block
    setImmediate(async () => {
      try {
        await this.messengerService.handleWebhook(payload as any);
      } catch (error) {
        this.logger.error(`Lá»—i xá»­ lÃ½ webhook: ${error.message}`, error.stack);
      }
    });

    // Tráº£ vá» ngay Ä‘á»ƒ Facebook khÃ´ng timeout
    return 'EVENT_RECEIVED';
  }

  // ==================== API QUáº¢N LÃ ÄÆ N HÃ€NG ====================

  /**
   * GET /messenger/products
   * Láº¥y danh sÃ¡ch sáº£n pháº©m
   */
  @Get('products')
  async getProducts() {
    this.logger.log('Láº¥y danh sÃ¡ch sáº£n pháº©m');
    const products = await this.messengerService.getProductList();
    return {
      success: true,
      data: products,
    };
  }

  /**
   * GET /messenger/phone-models
   * Láº¥y danh sÃ¡ch dÃ²ng mÃ¡y Ä‘iá»‡n thoáº¡i cho bot
   */
  @Get('phone-models')
  async getPhoneModels(): Promise<{ success: boolean; data: any[] }> {
    this.logger.log('Láº¥y danh sÃ¡ch phone models cho bot');
    const models = await this.messengerService.getPhoneModelList();
    return {
      success: true,
      data: models,
    };
  }

  /**
   * GET /messenger/orders
   * Láº¥y danh sÃ¡ch táº¥t cáº£ Ä‘Æ¡n hÃ ng (admin)
   */
  @Get('orders')
  async getAllOrders(
    @Query('limit') limit?: string,
    @Query('offset') offset?: string,
  ) {
    this.logger.log(`Láº¥y danh sÃ¡ch Ä‘Æ¡n hÃ ng - Limit: ${limit}, Offset: ${offset}`);
    
    const result = await this.messengerService.getAllOrders(
      parseInt(limit || '50', 10),
      parseInt(offset || '0', 10),
    );

    return {
      success: true,
      data: result.orders,
      total: result.total,
    };
  }

  /**
   * GET /messenger/orders/:id
   * Láº¥y chi tiáº¿t Ä‘Æ¡n hÃ ng theo ID
   */
  @Get('orders/:id')
  async getOrderById(@Param('id') id: string) {
    this.logger.log(`Láº¥y Ä‘Æ¡n hÃ ng: ${id}`);

    const order = await this.messengerService.getOrderById(id);

    if (!order) {
      throw new NotFoundException('KhÃ´ng tÃ¬m tháº¥y Ä‘Æ¡n hÃ ng');
    }

    return {
      success: true,
      data: order,
    };
  }

  /**
   * PUT /messenger/orders/:id/status
   * Cáº­p nháº­t tráº¡ng thÃ¡i Ä‘Æ¡n hÃ ng
   */
  @Put('orders/:id/status')
  async updateOrderStatus(
    @Param('id') id: string,
    @Body('status') status: OrderStatus,
  ) {
    this.logger.log(`Cáº­p nháº­t tráº¡ng thÃ¡i Ä‘Æ¡n ${id}: ${status}`);

    // Validate status
    const validStatuses = Object.values(OrderStatus);
    if (!validStatuses.includes(status)) {
      throw new BadRequestException(`Tráº¡ng thÃ¡i khÃ´ng há»£p lá»‡. Cháº¥p nháº­n: ${validStatuses.join(', ')}`);
    }

    try {
      const updatedOrder = await this.messengerService.updateOrderStatus(id, status);
      return {
        success: true,
        message: 'Cáº­p nháº­t tráº¡ng thÃ¡i thÃ nh cÃ´ng',
        data: updatedOrder,
      };
    } catch (error) {
      this.logger.error(`Lá»—i cáº­p nháº­t tráº¡ng thÃ¡i: ${error.message}`);
      throw new BadRequestException('KhÃ´ng thá»ƒ cáº­p nháº­t tráº¡ng thÃ¡i Ä‘Æ¡n hÃ ng');
    }
  }

  /**
   * POST /messenger/orders/webhook
   * Nháº­n Ä‘Æ¡n hÃ ng tá»« webhook (endpoint cho há»‡ thá»‘ng quáº£n lÃ½)
   */
  @Post('orders/webhook')
  @HttpCode(HttpStatus.OK)
  async receiveOrderWebhook(@Body() orderData: any) {
    this.logger.log(`Nháº­n webhook Ä‘Æ¡n hÃ ng: ${JSON.stringify(orderData)}`);

    // Validate dá»¯ liá»‡u cÆ¡ báº£n
    if (!orderData.customer_name || !orderData.phone || !orderData.product) {
      throw new BadRequestException('Thiáº¿u thÃ´ng tin báº¯t buá»™c: customer_name, phone, product');
    }

    return {
      success: true,
      message: 'ÄÃ£ nháº­n Ä‘Æ¡n hÃ ng',
      received_at: new Date().toISOString(),
    };
  }

  /**
   * GET /messenger/health
   * Kiá»ƒm tra tráº¡ng thÃ¡i service
   */
  @Get('health')
  healthCheck() {
    return {
      status: 'ok',
      service: 'messenger-bot',
      timestamp: new Date().toISOString(),
    };
  }
}




################################################################################
## FILE 57: order.service.ts
## Path: backend/src/order/order.service.ts
################################################################################

import { Injectable, BadRequestException } from '@nestjs/common';
import { SupabaseService } from '../supabase.service';

interface CreateOrderDto {
  items: {
    product_id: number;
    variant_id?: number;
    phone_model_id?: number;
    phone_model_name?: string;
    product_name: string;
    quantity: number;
    unit_price: number;
    discount_amount?: number;
  }[];

  shipping_address: {
    full_name: string;
    phone: string;
    address_line1: string;
    ward?: string;
    district?: string;
    city: string;
  };

  subtotal: number;
  discount_amount?: number;
  shipping_fee?: number;
  tax_amount?: number;
  total_amount: number;

  payment_method?: string;
  coupon_code?: string;
  customer_note?: string;
}


@Injectable()
export class OrderService {
  constructor(private readonly supabaseService: SupabaseService) {}

  // Táº¡o mÃ£ Ä‘Æ¡n hÃ ng unique
  private generateOrderNumber(): string {
    const timestamp = Date.now().toString(36).toUpperCase();
    const random = Math.random().toString(36).substring(2, 6).toUpperCase();
    return `GT${timestamp}${random}`;
  }

  /**
   * Táº¡o Ä‘Æ¡n hÃ ng má»›i - LUá»’NG CHÃNH
   */
  async createOrder(userId: string, orderDto: CreateOrderDto) {
    try {
      const {
        items,
        shipping_address,
        subtotal,
        discount_amount = 0,
        shipping_fee = 0,
        tax_amount = 0,
        total_amount,
        payment_method,
        coupon_code,
        customer_note,
      } = orderDto;

      if (!items || items.length === 0) {
        throw new BadRequestException('Giá» hÃ ng trá»‘ng');
      }

      // âŒ XÃ“A: let subtotal = 0;
      // âŒ XÃ“A: toÃ n bá»™ reduce + tÃ­nh láº¡i tiá»n

      // 1ï¸âƒ£ Generate order number
      const orderNumber = this.generateOrderNumber();

      // 2ï¸âƒ£ Create order
      const { data: orderData, error: orderError } =
        await this.supabaseService.createFullOrder({
          customer_id: userId,
          order_number: orderNumber,
          subtotal,
          discount_amount,
          shipping_fee,
          // tax_amount,
          total_amount,
          payment_method,
          // coupon_code,
          customer_note,
          shipping_full_name: shipping_address.full_name,
          shipping_phone: shipping_address.phone,
          shipping_address: shipping_address.address_line1,
          shipping_ward: shipping_address.ward,
          shipping_district: shipping_address.district,
          shipping_city: shipping_address.city,
        });

      if (orderError || !orderData || orderData.length === 0) {
        throw new BadRequestException(orderError?.message || 'KhÃ´ng thá»ƒ táº¡o Ä‘Æ¡n hÃ ng');
      }

      const orderId = orderData[0].order_id;

      // 3ï¸âƒ£ Create order items
      for (const item of items) {
        const { data: itemData, error: itemError } = await this.supabaseService.createFullOrderItem({
          order_id: orderId,
          product_id: item.product_id,
          product_name: item.product_name,
          sku: `SKU-${item.product_id}`,
          quantity: item.quantity,
          unit_price: item.unit_price,
          discount_amount: item.discount_amount || 0,
          total_price: item.unit_price * item.quantity - (item.discount_amount || 0),
          phone_model_id: item.phone_model_id || null,
          phone_model_name: item.phone_model_name || null,
        });

        // THÃŠM LOG Äá»‚ DEBUG
        if (itemError) {
          console.error('Order item insert error:', itemError);
          throw new BadRequestException(`KhÃ´ng thá»ƒ táº¡o order item: ${itemError.message}`);
        }
      }
      

      await this.supabaseService.clearShoppingCart(userId);

      return {
        success: true,
        data: {
          order_id: orderId,
          order_number: orderNumber,
          total_amount,
        },
      };
    } catch (error: any) {
      throw new BadRequestException(error.message || 'Lá»—i táº¡o Ä‘Æ¡n hÃ ng');
    }
  }


  /**
   * Láº¥y táº¥t cáº£ orders (ADMIN)
   */
  async getAllOrders() {
    const { data, error } = await this.supabaseService.getOrders();
    if (error) throw new BadRequestException(error.message);
    return data;
  }

  /**
   * Láº¥y orders cá»§a customer
   */
  async getOrdersByUserId(userId: string) {
    const { data, error } = await this.supabaseService.getOrdersByCustomer(userId as any);
    if (error) throw new BadRequestException(error.message);
    return data;
  }

  /**
   * Láº¥y chi tiáº¿t order theo ID
   */
  async getOrderById(orderId: string) {
    const { data, error } = await this.supabaseService.getOrderWithItems(Number(orderId));
    if (error) throw new BadRequestException(error.message);
    return data;
  }

  /**
   * Láº¥y chi tiáº¿t order theo Order Number
   */
  async getOrderByNumber(orderNumber: string) {
    const { data, error } = await this.supabaseService.getOrderWithItemsByNumber(orderNumber);
    if (error) throw new BadRequestException(error.message);
    if (!data) throw new BadRequestException('KhÃ´ng tÃ¬m tháº¥y Ä‘Æ¡n hÃ ng');
    return data;
  }

  /**
   * Cáº­p nháº­t tráº¡ng thÃ¡i Ä‘Æ¡n hÃ ng
   */
  async updateOrderStatus(orderId: string, newStatus: string) {
    const { data, error } = await this.supabaseService.updateOrderStatus(Number(orderId), newStatus);
    if (error) return { success: false, message: error.message };
    return { success: true, data };
  }

  /**
   * Cáº­p nháº­t tráº¡ng thÃ¡i thanh toÃ¡n
   */
  async updatePaymentStatus(orderId: string, paymentStatus: string) {
    const { data, error } = await this.supabaseService.updatePaymentStatus(Number(orderId), paymentStatus);
    if (error) return { success: false, message: error.message };
    return { success: true, data };
  }
}



################################################################################
## FILE 58: order.module.ts
## Path: backend/src/order/order.module.ts
################################################################################

import { Module } from '@nestjs/common';
import { OrderController } from './order.controller';
import { OrderService } from './order.service';
import { SupabaseService } from '../supabase.service';
import { AuthModule } from '../auth/auth.module';

@Module({
  imports: [AuthModule], 
  controllers: [OrderController],
  providers: [OrderService, SupabaseService],
  exports: [OrderService],
})
export class OrderModule {}




################################################################################
## FILE 59: order.controller.ts
## Path: backend/src/order/order.controller.ts
################################################################################

import {
  Controller,
  Get,
  Post,
  Put,
  Body,
  Param,
  UseGuards,
  BadRequestException,
} from '@nestjs/common';
import { OrderService } from './order.service';
import { JwtAuthGuard, RolesGuard, CustomerGuard } from '../auth/guards';
import { Roles, CurrentUser, CustomerOnly } from '../auth/decorators';
import { UserRole } from '../common';
import type { AuthenticatedUser } from '../common';

@Controller('orders')
export class OrderController {
  constructor(private readonly orderService: OrderService) {}

  /**
   * POST /orders - Táº¡o Ä‘Æ¡n hÃ ng má»›i
   * YÃªu cáº§u: CUSTOMER only (pháº£i Ä‘Äƒng nháº­p)
   */
  @Post()
  @CustomerOnly()
  async createOrder(
    @CurrentUser() user: AuthenticatedUser,
    @Body() body: {
      items: {
    product_id: number;
    variant_id?: number;
    product_name: string;
    quantity: number;
    unit_price: number;
    discount_amount?: number;
  }[];

  shipping_address: {
    full_name: string;
    phone: string;
    address_line1: string;
    ward?: string;
    district?: string;
    city: string;
  };

  subtotal: number;
  discount_amount?: number;
  shipping_fee?: number;
  tax_amount?: number;
  total_amount: number;

  payment_method?: string;
  coupon_code?: string;
  customer_note?: string;
    },
  ) {
    if (!body.items || body.items.length === 0) {
      throw new BadRequestException('Giá» hÃ ng trá»‘ng');
    }

    return this.orderService.createOrder(user.id, body);
  }

  /**
   * GET /orders - Láº¥y danh sÃ¡ch orders
   * - Admin: xem táº¥t cáº£
   * - Customer: chá»‰ xem cá»§a mÃ¬nh
   */
  @Get()
  @UseGuards(JwtAuthGuard)
  async getOrders(@CurrentUser() user: AuthenticatedUser) {
    if (user.role === UserRole.ADMIN) {
      return this.orderService.getAllOrders();
    }
    return this.orderService.getOrdersByUserId(user.id);
  }

  /**
   * GET /orders/number/:orderNumber - Láº¥y order theo mÃ£ Ä‘Æ¡n hÃ ng
   * DÃ¹ng cho trang order success vÃ  order detail
   */
  @Get('number/:orderNumber')
  async getOrderByNumber(@Param('orderNumber') orderNumber: string) {
    return this.orderService.getOrderByNumber(orderNumber);
  }

  /**
   * GET /orders/:id - Xem chi tiáº¿t Ä‘Æ¡n hÃ ng theo ID
   */
  @Get(':id')
  @UseGuards(JwtAuthGuard)
  async getOrderById(
    @CurrentUser() user: AuthenticatedUser,
    @Param('id') orderId: string,
  ) {
    const order = await this.orderService.getOrderById(orderId);

    // Customer chá»‰ xem Ä‘Æ°á»£c order cá»§a mÃ¬nh
    if (user.role === UserRole.CUSTOMER && order.customer_id !== user.id) {
      throw new BadRequestException('KhÃ´ng cÃ³ quyá»n xem Ä‘Æ¡n hÃ ng nÃ y');
    }

    return order;
  }

  /**
   * PUT /orders/:id/status - Cáº­p nháº­t tráº¡ng thÃ¡i (ADMIN only)
   */
  @Put(':id/status')
  @UseGuards(JwtAuthGuard, RolesGuard)
  @Roles(UserRole.ADMIN)
  async updateOrderStatus(
    @Param('id') orderId: string,
    @Body('status') status: string,
  ) {
    return this.orderService.updateOrderStatus(orderId, status);
  }

  /**
   * PUT /orders/:id/payment - Cáº­p nháº­t tráº¡ng thÃ¡i thanh toÃ¡n
   */
  @Put(':id/payment')
  @UseGuards(JwtAuthGuard, RolesGuard)
  @Roles(UserRole.ADMIN)
  async updatePaymentStatus(
    @Param('id') orderId: string,
    @Body('payment_status') paymentStatus: string,
  ) {
    return this.orderService.updatePaymentStatus(orderId, paymentStatus);
  }

  /**
   * GET /orders/admin/all - Xem táº¥t cáº£ orders (ADMIN only)
   * Táº¡m thá»i bá» guard Ä‘á»ƒ test
   */
  @Get('admin/all')
  async getAllOrders() {
    return this.orderService.getAllOrders();
  }
}



################################################################################
## FILE 60: payment.service.ts
## Path: backend/src/payment/payment.service.ts
################################################################################

// backend/src/payment/payment.service.ts
import { Injectable, BadRequestException } from '@nestjs/common';
import axios from 'axios';
import * as crypto from 'crypto';
import { SupabaseService } from '../supabase.service';
import { OrderService } from '../order/order.service';

interface MomoConfig {
  accessKey: string;
  secretKey: string;
  partnerCode: string;
  endpoint: string;
}

@Injectable()
export class PaymentService {
  private momoConfig: MomoConfig = {
    accessKey: 'F8BBA842ECF85',
    secretKey: 'K951B6PE1waDMi640xX08PD3vg6EkVlz',
    partnerCode: 'MOMO',
    endpoint: 'https://test-payment.momo.vn/v2/gateway/api',
  };

  constructor(
    private readonly supabaseService: SupabaseService,
    private readonly orderService: OrderService,
  ) {}

  // ================== UTILS ==================
  private sign(raw: string): string {
    return crypto
      .createHmac('sha256', this.momoConfig.secretKey)
      .update(raw)
      .digest('hex');
  }

  // ================== CREATE PAYMENT ==================
  async createMomoPayment(payload: {
    amount: string;
    orderId: string;
    orderInfo: string;
    redirectUrl: string;
    ipnUrl: string;
    extraData?: string;
  }) {
    const {
      accessKey,
      partnerCode,
      endpoint,
    } = this.momoConfig;

    const requestType = 'payWithMethod';
    const requestId = payload.orderId;
    const autoCapture = true;
    const lang = 'vi';
    const extraData = payload.extraData || '';

    const rawSignature =
      `accessKey=${accessKey}` +
      `&amount=${payload.amount}` +
      `&extraData=${extraData}` +
      `&ipnUrl=${payload.ipnUrl}` +
      `&orderId=${payload.orderId}` +
      `&orderInfo=${payload.orderInfo}` +
      `&partnerCode=${partnerCode}` +
      `&redirectUrl=${payload.redirectUrl}` +
      `&requestId=${requestId}` +
      `&requestType=${requestType}`;

    const signature = this.sign(rawSignature);

    const body = {
      partnerCode,
      partnerName: 'GoatTech Store',
      storeId: 'GoatTechStore',
      requestId,
      amount: payload.amount,
      orderId: payload.orderId,
      orderInfo: payload.orderInfo,
      redirectUrl: payload.redirectUrl,
      ipnUrl: payload.ipnUrl,
      requestType,
      autoCapture,
      lang,
      extraData,
      signature,
    };

    const response = await axios.post(`${endpoint}/create`, body, {
      headers: { 'Content-Type': 'application/json' },
    });

    return response.data;
  }

  // ================== IPN ==================
  async handleMomoIPN(body: any) {
    const {
      partnerCode,
      orderId,
      requestId,
      amount,
      orderInfo,
      orderType,
      transId,
      resultCode,
      message,
      payType,
      responseTime,
      extraData,
      signature,
    } = body;

    const rawSignature =
      `accessKey=${this.momoConfig.accessKey}` +
      `&amount=${amount}` +
      `&extraData=${extraData}` +
      `&message=${message}` +
      `&orderId=${orderId}` +
      `&orderInfo=${orderInfo}` +
      `&orderType=${orderType}` +
      `&partnerCode=${partnerCode}` +
      `&payType=${payType}` +
      `&requestId=${requestId}` +
      `&responseTime=${responseTime}` +
      `&resultCode=${resultCode}` +
      `&transId=${transId}`;

    const expected = this.sign(rawSignature);
    if (expected !== signature) {
      throw new BadRequestException('Invalid MoMo signature');
    }

    // 1ï¸âƒ£ Ghi payment_transactions
    await this.supabaseService.createPaymentTransaction({
      order_id: null, // map báº±ng order_number phÃ­a dÆ°á»›i
      payment_gateway: 'momo',
      transaction_ref: transId,
      amount,
      currency: 'VND',
      status: resultCode === 0 ? 'success' : 'failed',
      payment_date: new Date().toISOString(),
      response_data: JSON.stringify(body),
    });

    // 2ï¸âƒ£ Update order
    if (resultCode === 0) {
      await this.orderService.updatePaymentStatus(orderId, 'paid');
    } else {
      await this.orderService.updatePaymentStatus(orderId, 'failed');
    }

    return {
      partnerCode,
      orderId,
      requestId,
      resultCode: 0,
      message: 'success',
      responseTime: Date.now(),
    };
  }

  // ================== CHECK STATUS ==================
  async checkMomoStatus(orderId: string) {
    const { accessKey, partnerCode, endpoint } = this.momoConfig;
    const requestId = orderId;

    const rawSignature =
      `accessKey=${accessKey}` +
      `&orderId=${orderId}` +
      `&partnerCode=${partnerCode}` +
      `&requestId=${requestId}`;

    const signature = this.sign(rawSignature);

    const body = {
      partnerCode,
      requestId,
      orderId,
      lang: 'vi',
      signature,
    };

    const response = await axios.post(`${endpoint}/query`, body, {
      headers: { 'Content-Type': 'application/json' },
    });

    return response.data;
  }

  // ================== REFUND ==================
  async refundMomo(payload: {
    orderId: string;
    transId: string;
    amount: string;
    description?: string;
  }) {
    const { accessKey, partnerCode, endpoint } = this.momoConfig;
    const requestId = `REFUND_${Date.now()}`;
    const description = payload.description || 'HoÃ n tiá»n Ä‘Æ¡n hÃ ng';

    const rawSignature =
      `accessKey=${accessKey}` +
      `&amount=${payload.amount}` +
      `&description=${description}` +
      `&orderId=${payload.orderId}` +
      `&partnerCode=${partnerCode}` +
      `&requestId=${requestId}` +
      `&transId=${payload.transId}`;

    const signature = this.sign(rawSignature);

    const body = {
      partnerCode,
      requestId,
      orderId: payload.orderId,
      amount: payload.amount,
      transId: payload.transId,
      description,
      lang: 'vi',
      signature,
    };

    const response = await axios.post(`${endpoint}/refund`, body, {
      headers: { 'Content-Type': 'application/json' },
    });

    return response.data;
  }
}




################################################################################
## FILE 61: payment.module.ts
## Path: backend/src/payment/payment.module.ts
################################################################################

// backend/src/payment/payment.module.ts
import { Module } from '@nestjs/common';
import { PaymentController } from './payment.controller';
import { PaymentService } from './payment.service';
import { SupabaseService } from '../supabase.service';
import { OrderModule } from '../order/order.module';

@Module({
  imports: [OrderModule],
  controllers: [PaymentController],
  providers: [
    PaymentService,
    SupabaseService,
  ],
  exports: [PaymentService],
})
export class PaymentModule {}




################################################################################
## FILE 62: payment.controller.ts
## Path: backend/src/payment/payment.controller.ts
################################################################################

import { Controller, Post, Body, Res, Get, Query } from '@nestjs/common';
import axios from 'axios';
import type { Response } from 'express';
import * as crypto from 'crypto';

interface MomoConfig {
  accessKey: string;
  secretKey: string;
  partnerCode: string;
  endpoint: string;
}

@Controller('payment')
export class PaymentController {
  private momoConfig: MomoConfig = {
    accessKey: 'F8BBA842ECF85',
    secretKey: 'K951B6PE1waDMi640xX08PD3vg6EkVlz',
    partnerCode: 'MOMO',
    endpoint: 'https://test-payment.momo.vn/v2/gateway/api',
  };

  // Táº¡o chá»¯ kÃ½ HMAC SHA256
  private createSignature(rawSignature: string): string {
    return crypto
      .createHmac('sha256', this.momoConfig.secretKey)
      .update(rawSignature)
      .digest('hex');
  }

  // POST /payment/momo - Táº¡o thanh toÃ¡n MoMo
  @Post('momo')
  async createMomoPayment(@Body() body: any, @Res() res: Response) {
    try {
      const { accessKey, secretKey, partnerCode, endpoint } = this.momoConfig;
      
      const orderInfo = body.orderInfo || 'Thanh toÃ¡n Ä‘Æ¡n hÃ ng GoatTech';
      const redirectUrl = body.redirectUrl || 'http://localhost:3000/payment-result';
      const ipnUrl = body.ipnUrl || 'http://localhost:3001/payment/momo/ipn';
      const requestType = 'payWithMethod';
      const amount = String(body.amount || '50000');
      const orderId = body.orderId || `${partnerCode}${Date.now()}`;
      const requestId = orderId;
      const extraData = body.extraData || '';
      const autoCapture = true;
      const lang = 'vi';

      // Build raw signature theo thá»© tá»± alphabet
      const rawSignature = `accessKey=${accessKey}&amount=${amount}&extraData=${extraData}&ipnUrl=${ipnUrl}&orderId=${orderId}&orderInfo=${orderInfo}&partnerCode=${partnerCode}&redirectUrl=${redirectUrl}&requestId=${requestId}&requestType=${requestType}`;
      
      const signature = this.createSignature(rawSignature);

      console.log('ðŸ“ MoMo Payment Request:');
      console.log('- Order ID:', orderId);
      console.log('- Amount:', amount);
      console.log('- Raw Signature:', rawSignature);

      // Build request body
      const requestBody = {
        partnerCode,
        partnerName: 'GoatTech Store',
        storeId: 'GoatTechStore',
        requestId,
        amount,
        orderId,
        orderInfo,
        redirectUrl,
        ipnUrl,
        lang,
        requestType,
        autoCapture,
        extraData,
        signature,
      };

      // Call MoMo API
      const response = await axios.post(
        `${endpoint}/create`,
        requestBody,
        {
          headers: { 'Content-Type': 'application/json' },
        },
      );

      console.log('âœ… MoMo Response:', response.data);

      return res.status(200).json({
        success: true,
        data: response.data,
      });
    } catch (error: any) {
      console.error('âŒ MoMo Payment Error:', error?.response?.data || error.message);
      return res.status(500).json({
        success: false,
        message: 'Lá»—i táº¡o thanh toÃ¡n MoMo',
        error: error?.response?.data || error?.message,
      });
    }
  }

  // POST /payment/momo/ipn - Nháº­n thÃ´ng bÃ¡o tá»« MoMo (IPN - Instant Payment Notification)
  @Post('momo/ipn')
  async handleMomoIPN(@Body() body: any, @Res() res: Response) {
    try {
      console.log('ðŸ”” MoMo IPN Received:', body);

      const { 
        partnerCode, orderId, requestId, amount, orderInfo, 
        orderType, transId, resultCode, message, payType,
        responseTime, extraData, signature 
      } = body;

      // Verify signature
      const { accessKey } = this.momoConfig;
      const rawSignature = `accessKey=${accessKey}&amount=${amount}&extraData=${extraData}&message=${message}&orderId=${orderId}&orderInfo=${orderInfo}&orderType=${orderType}&partnerCode=${partnerCode}&payType=${payType}&requestId=${requestId}&responseTime=${responseTime}&resultCode=${resultCode}&transId=${transId}`;
      
      const expectedSignature = this.createSignature(rawSignature);

      if (signature !== expectedSignature) {
        console.error('âŒ Invalid signature!');
        return res.status(400).json({ message: 'Invalid signature' });
      }

      // Xá»­ lÃ½ káº¿t quáº£ thanh toÃ¡n
      if (resultCode === 0) {
        console.log('âœ… Payment Success!');
        console.log('- Transaction ID:', transId);
        console.log('- Order ID:', orderId);
        console.log('- Amount:', amount);
        
        // TODO: Cáº­p nháº­t tráº¡ng thÃ¡i Ä‘Æ¡n hÃ ng trong database
        // await this.orderService.updatePaymentStatus(orderId, 'paid', transId);
      } else {
        console.log('âŒ Payment Failed:', message);
        // TODO: Cáº­p nháº­t tráº¡ng thÃ¡i Ä‘Æ¡n hÃ ng tháº¥t báº¡i
      }

      // Pháº£n há»“i MoMo
      return res.status(200).json({
        partnerCode,
        requestId,
        orderId,
        resultCode: 0,
        message: 'success',
        responseTime: Date.now(),
      });
    } catch (error: any) {
      console.error('âŒ IPN Error:', error.message);
      return res.status(500).json({ message: 'IPN processing failed' });
    }
  }

  // POST /payment/momo/check-status - Kiá»ƒm tra tráº¡ng thÃ¡i thanh toÃ¡n
  @Post('momo/check-status')
  async checkPaymentStatus(@Body() body: any, @Res() res: Response) {
    try {
      const { accessKey, secretKey, partnerCode, endpoint } = this.momoConfig;
      
      const orderId = body.orderId;
      const requestId = orderId;
      const lang = 'vi';

      if (!orderId) {
        return res.status(400).json({
          success: false,
          message: 'orderId is required',
        });
      }

      // Build raw signature
      const rawSignature = `accessKey=${accessKey}&orderId=${orderId}&partnerCode=${partnerCode}&requestId=${requestId}`;
      const signature = this.createSignature(rawSignature);

      const requestBody = {
        partnerCode,
        requestId,
        orderId,
        lang,
        signature,
      };

      const response = await axios.post(
        `${endpoint}/query`,
        requestBody,
        {
          headers: { 'Content-Type': 'application/json' },
        },
      );

      console.log('ðŸ“Š Payment Status:', response.data);

      return res.status(200).json({
        success: true,
        data: response.data,
      });
    } catch (error: any) {
      console.error('âŒ Check Status Error:', error?.response?.data || error.message);
      return res.status(500).json({
        success: false,
        message: 'Lá»—i kiá»ƒm tra tráº¡ng thÃ¡i',
        error: error?.response?.data || error?.message,
      });
    }
  }

  // POST /payment/momo/refund - HoÃ n tiá»n
  @Post('momo/refund')
  async refundPayment(@Body() body: any, @Res() res: Response) {
    try {
      const { accessKey, partnerCode, endpoint } = this.momoConfig;
      
      const orderId = body.orderId;
      const transId = body.transId;
      const amount = String(body.amount);
      const requestId = `REFUND${Date.now()}`;
      const description = body.description || 'HoÃ n tiá»n Ä‘Æ¡n hÃ ng';
      const lang = 'vi';

      if (!orderId || !transId || !amount) {
        return res.status(400).json({
          success: false,
          message: 'orderId, transId vÃ  amount lÃ  báº¯t buá»™c',
        });
      }

      // Build raw signature
      const rawSignature = `accessKey=${accessKey}&amount=${amount}&description=${description}&orderId=${orderId}&partnerCode=${partnerCode}&requestId=${requestId}&transId=${transId}`;
      const signature = this.createSignature(rawSignature);

      const requestBody = {
        partnerCode,
        requestId,
        orderId,
        amount,
        transId,
        description,
        lang,
        signature,
      };

      const response = await axios.post(
        `${endpoint}/refund`,
        requestBody,
        {
          headers: { 'Content-Type': 'application/json' },
        },
      );

      console.log('ðŸ’° Refund Response:', response.data);

      return res.status(200).json({
        success: true,
        data: response.data,
      });
    } catch (error: any) {
      console.error('âŒ Refund Error:', error?.response?.data || error.message);
      return res.status(500).json({
        success: false,
        message: 'Lá»—i hoÃ n tiá»n',
        error: error?.response?.data || error?.message,
      });
    }
  }

  // GET /payment/momo/result - Trang káº¿t quáº£ thanh toÃ¡n (redirect tá»« MoMo)
  @Get('momo/result')
  async paymentResult(@Query() query: any, @Res() res: Response) {
    console.log('ðŸ”„ Payment Result Query:', query);
    
    const { resultCode, orderId, message, transId, amount } = query;
    
    // Redirect vá» frontend vá»›i káº¿t quáº£
    const frontendUrl = `http://localhost:3000/payment-result?resultCode=${resultCode}&orderId=${orderId}&message=${encodeURIComponent(message || '')}&transId=${transId || ''}&amount=${amount || ''}`;
    
    return res.redirect(frontendUrl);
  }
}




################################################################################
## FILE 63: phone-model.service.ts
## Path: backend/src/phone-model/phone-model.service.ts
################################################################################

/**
 * Phone Model Service
 * Quáº£n lÃ½ dÃ²ng mÃ¡y Ä‘iá»‡n thoáº¡i tÆ°Æ¡ng thÃ­ch vá»›i sáº£n pháº©m
 */

import { Injectable, Logger } from '@nestjs/common';
import { createClient, SupabaseClient } from '@supabase/supabase-js';

// Interface cho Phone Model
export interface PhoneModel {
  model_id: number;
  brand_name: string;
  model_name: string;
  model_code?: string;
  release_year?: number;
  screen_size?: number;
  image_url?: string;
  is_popular: boolean;
  is_active: boolean;
  display_order: number;
}

// Interface cho Product Compatibility
export interface ProductCompatibility {
  compatibility_id: number;
  product_id: number;
  phone_model_id: number;
  fit_type: string;
  notes?: string;
  phone_model?: PhoneModel;
}

@Injectable()
export class PhoneModelService {
  private readonly logger = new Logger(PhoneModelService.name);
  private supabase: SupabaseClient;

  constructor() {
    this.supabase = createClient(
      process.env.SUPABASE_URL || '',
      process.env.SUPABASE_SERVICE_ROLE_KEY || '',
    );
  }

  /**
   * Láº¥y táº¥t cáº£ dÃ²ng mÃ¡y (grouped by brand)
   */
  async getAllPhoneModels(): Promise<{ brand: string; models: PhoneModel[] }[]> {
    try {
      const { data, error } = await this.supabase
        .from('phone_models')
        .select('*')
        .order('brand_name')
        .order('display_order')
        .order('model_name');

      if (error) {
        this.logger.error(`Lá»—i láº¥y phone models: ${error.message}`);
        throw error;
      }

      // Group by brand
      const groupedByBrand: { [key: string]: PhoneModel[] } = {};
      (data || []).forEach((model: PhoneModel) => {
        if (!groupedByBrand[model.brand_name]) {
          groupedByBrand[model.brand_name] = [];
        }
        groupedByBrand[model.brand_name].push(model);
      });

      // Convert to array format: [{ brand: 'Apple', models: [...] }, ...]
      const result = Object.entries(groupedByBrand).map(([brand, models]) => ({
        brand,
        models,
      }));

      return result;
    } catch (error) {
      this.logger.error(`Lá»—i getAllPhoneModels: ${error.message}`);
      throw error;
    }
  }

  /**
   * Láº¥y dÃ²ng mÃ¡y theo brand
   */
  async getPhoneModelsByBrand(brandName: string): Promise<PhoneModel[]> {
    try {
      const { data, error } = await this.supabase
        .from('phone_models')
        .select('*')
        .eq('brand_name', brandName)
        .order('display_order')
        .order('model_name');

      if (error) {
        this.logger.error(`Lá»—i láº¥y phone models by brand: ${error.message}`);
        throw error;
      }

      return data || [];
    } catch (error) {
      this.logger.error(`Lá»—i getPhoneModelsByBrand: ${error.message}`);
      throw error;
    }
  }

  /**
   * Láº¥y dÃ²ng mÃ¡y phá»• biáº¿n
   */
  async getPopularPhoneModels(): Promise<PhoneModel[]> {
    try {
      const { data, error } = await this.supabase
        .from('phone_models')
        .select('*')
        .eq('is_popular', true)
        .order('brand_name')
        .order('display_order')
        .limit(20);

      if (error) {
        this.logger.error(`Lá»—i láº¥y popular phone models: ${error.message}`);
        throw error;
      }

      return data || [];
    } catch (error) {
      this.logger.error(`Lá»—i getPopularPhoneModels: ${error.message}`);
      throw error;
    }
  }

  /**
   * Láº¥y dÃ²ng mÃ¡y tÆ°Æ¡ng thÃ­ch vá»›i sáº£n pháº©m
   */
  async getCompatibleModels(productId: number): Promise<PhoneModel[]> {
    try {
      const { data, error } = await this.supabase
        .from('product_compatibility')
        .select(`
          *,
          phone_models (*)
        `)
        .eq('product_id', productId);

      if (error) {
        this.logger.error(`Lá»—i láº¥y compatible models: ${error.message}`);
        throw error;
      }

      // Extract phone models tá»« káº¿t quáº£
      const models = (data || [])
        .map((c: any) => c.phone_models)
        .filter((m: any) => m && m.is_active);

      return models;
    } catch (error) {
      this.logger.error(`Lá»—i getCompatibleModels: ${error.message}`);
      throw error;
    }
  }

  /**
   * Láº¥y chi tiáº¿t má»™t dÃ²ng mÃ¡y
   */
  async getPhoneModelById(modelId: number): Promise<PhoneModel | null> {
    try {
      const { data, error } = await this.supabase
        .from('phone_models')
        .select('*')
        .eq('model_id', modelId)
        .single();

      if (error) {
        this.logger.error(`Lá»—i láº¥y phone model: ${error.message}`);
        return null;
      }

      return data;
    } catch (error) {
      this.logger.error(`Lá»—i getPhoneModelById: ${error.message}`);
      return null;
    }
  }

  /**
   * TÃ¬m kiáº¿m dÃ²ng mÃ¡y
   */
  async searchPhoneModels(keyword: string): Promise<PhoneModel[]> {
    try {
      const { data, error } = await this.supabase
        .from('phone_models')
        .select('*')
        .or(`model_name.ilike.%${keyword}%,brand_name.ilike.%${keyword}%,model_code.ilike.%${keyword}%`)
        .order('is_popular', { ascending: false })
        .order('brand_name')
        .limit(20);

      if (error) {
        this.logger.error(`Lá»—i search phone models: ${error.message}`);
        throw error;
      }

      return data || [];
    } catch (error) {
      this.logger.error(`Lá»—i searchPhoneModels: ${error.message}`);
      throw error;
    }
  }

  // ==================== ADMIN FUNCTIONS ====================

  /**
   * Táº¡o dÃ²ng mÃ¡y má»›i (Admin)
   */
  async createPhoneModel(modelData: Partial<PhoneModel>): Promise<PhoneModel> {
    try {
      const { data, error } = await this.supabase
        .from('phone_models')
        .insert([modelData])
        .select()
        .single();

      if (error) {
        this.logger.error(`Lá»—i táº¡o phone model: ${error.message}`);
        throw error;
      }

      this.logger.log(`ÄÃ£ táº¡o phone model: ${data.model_name}`);
      return data;
    } catch (error) {
      this.logger.error(`Lá»—i createPhoneModel: ${error.message}`);
      throw error;
    }
  }

  /**
   * Cáº­p nháº­t dÃ²ng mÃ¡y (Admin)
   */
  async updatePhoneModel(modelId: number, modelData: Partial<PhoneModel>): Promise<PhoneModel> {
    try {
      const { data, error } = await this.supabase
        .from('phone_models')
        .update(modelData)
        .eq('model_id', modelId)
        .select()
        .single();

      if (error) {
        this.logger.error(`Lá»—i cáº­p nháº­t phone model: ${error.message}`);
        throw error;
      }

      this.logger.log(`ÄÃ£ cáº­p nháº­t phone model: ${modelId}`);
      return data;
    } catch (error) {
      this.logger.error(`Lá»—i updatePhoneModel: ${error.message}`);
      throw error;
    }
  }

  /**
   * XÃ³a dÃ²ng mÃ¡y (Admin) - soft delete
   */
  async deletePhoneModel(modelId: number): Promise<boolean> {
    try {
      const { error } = await this.supabase
        .from('phone_models')
        .update({ is_active: false })
        .eq('model_id', modelId);

      if (error) {
        this.logger.error(`Lá»—i xÃ³a phone model: ${error.message}`);
        throw error;
      }

      this.logger.log(`ÄÃ£ xÃ³a phone model: ${modelId}`);
      return true;
    } catch (error) {
      this.logger.error(`Lá»—i deletePhoneModel: ${error.message}`);
      throw error;
    }
  }

  /**
   * ThÃªm tÆ°Æ¡ng thÃ­ch sáº£n pháº©m - dÃ²ng mÃ¡y (Admin)
   */
  async addProductCompatibility(
    productId: number,
    phoneModelId: number,
    fitType: string = 'exact',
    notes?: string,
  ): Promise<ProductCompatibility> {
    try {
      const { data, error } = await this.supabase
        .from('product_compatibility')
        .insert([
          {
            product_id: productId,
            phone_model_id: phoneModelId,
            fit_type: fitType,
            notes: notes,
          },
        ])
        .select()
        .single();

      if (error) {
        this.logger.error(`Lá»—i thÃªm compatibility: ${error.message}`);
        throw error;
      }

      return data;
    } catch (error) {
      this.logger.error(`Lá»—i addProductCompatibility: ${error.message}`);
      throw error;
    }
  }

  /**
   * XÃ³a tÆ°Æ¡ng thÃ­ch sáº£n pháº©m - dÃ²ng mÃ¡y (Admin)
   */
  async removeProductCompatibility(productId: number, phoneModelId: number): Promise<boolean> {
    try {
      const { error } = await this.supabase
        .from('product_compatibility')
        .delete()
        .eq('product_id', productId)
        .eq('phone_model_id', phoneModelId);

      if (error) {
        this.logger.error(`Lá»—i xÃ³a compatibility: ${error.message}`);
        throw error;
      }

      return true;
    } catch (error) {
      this.logger.error(`Lá»—i removeProductCompatibility: ${error.message}`);
      throw error;
    }
  }

  /**
   * Bulk thÃªm tÆ°Æ¡ng thÃ­ch cho sáº£n pháº©m (Admin)
   */
  async setProductCompatibility(
    productId: number,
    phoneModelIds: number[],
  ): Promise<void> {
    try {
      // XÃ³a táº¥t cáº£ compatibility cÅ©
      await this.supabase
        .from('product_compatibility')
        .delete()
        .eq('product_id', productId);

      // ThÃªm compatibility má»›i
      if (phoneModelIds.length > 0) {
        const inserts = phoneModelIds.map((modelId) => ({
          product_id: productId,
          phone_model_id: modelId,
          fit_type: 'exact',
        }));

        const { error } = await this.supabase
          .from('product_compatibility')
          .insert(inserts);

        if (error) {
          this.logger.error(`Lá»—i bulk insert compatibility: ${error.message}`);
          throw error;
        }
      }

      this.logger.log(`ÄÃ£ set ${phoneModelIds.length} compatible models cho product ${productId}`);
    } catch (error) {
      this.logger.error(`Lá»—i setProductCompatibility: ${error.message}`);
      throw error;
    }
  }
}




################################################################################
## FILE 64: phone-model.module.ts
## Path: backend/src/phone-model/phone-model.module.ts
################################################################################

/**
 * Phone Model Module
 * Module quáº£n lÃ½ dÃ²ng mÃ¡y Ä‘iá»‡n thoáº¡i
 */

import { Module } from '@nestjs/common';
import { PhoneModelController } from './phone-model.controller';
import { PhoneModelService } from './phone-model.service';

@Module({
  controllers: [PhoneModelController],
  providers: [PhoneModelService],
  exports: [PhoneModelService],
})
export class PhoneModelModule {}




################################################################################
## FILE 65: phone-model.controller.ts
## Path: backend/src/phone-model/phone-model.controller.ts
################################################################################

/**
 * Phone Model Controller
 * API endpoints cho dÃ²ng mÃ¡y Ä‘iá»‡n thoáº¡i
 */

import {
  Controller,
  Get,
  Post,
  Put,
  Delete,
  Body,
  Param,
  Query,
  Logger,
  BadRequestException,
  NotFoundException,
} from '@nestjs/common';
import { PhoneModelService, PhoneModel } from './phone-model.service';

@Controller('phone-models')
export class PhoneModelController {
  private readonly logger = new Logger(PhoneModelController.name);

  constructor(private readonly phoneModelService: PhoneModelService) {}

  /**
   * GET /phone-models
   * Láº¥y táº¥t cáº£ dÃ²ng mÃ¡y (grouped by brand)
   */
  @Get()
  async getAllPhoneModels() {
    this.logger.log('Láº¥y táº¥t cáº£ phone models');
    try {
      const result = await this.phoneModelService.getAllPhoneModels();
      return {
        success: true,
        data: result,
      };
    } catch (error) {
      this.logger.error(`Lá»—i: ${error.message}`);
      throw new BadRequestException('KhÃ´ng thá»ƒ láº¥y danh sÃ¡ch dÃ²ng mÃ¡y');
    }
  }

  /**
   * GET /phone-models/popular
   * Láº¥y dÃ²ng mÃ¡y phá»• biáº¿n
   */
  @Get('popular')
  async getPopularPhoneModels() {
    this.logger.log('Láº¥y popular phone models');
    try {
      const models = await this.phoneModelService.getPopularPhoneModels();
      return {
        success: true,
        data: models,
      };
    } catch (error) {
      this.logger.error(`Lá»—i: ${error.message}`);
      throw new BadRequestException('KhÃ´ng thá»ƒ láº¥y dÃ²ng mÃ¡y phá»• biáº¿n');
    }
  }

  /**
   * GET /phone-models/search?keyword=iphone
   * TÃ¬m kiáº¿m dÃ²ng mÃ¡y
   */
  @Get('search')
  async searchPhoneModels(@Query('keyword') keyword: string) {
    if (!keyword || keyword.length < 2) {
      throw new BadRequestException('Keyword pháº£i cÃ³ Ã­t nháº¥t 2 kÃ½ tá»±');
    }

    this.logger.log(`TÃ¬m kiáº¿m phone models: ${keyword}`);
    try {
      const models = await this.phoneModelService.searchPhoneModels(keyword);
      return {
        success: true,
        data: models,
      };
    } catch (error) {
      this.logger.error(`Lá»—i: ${error.message}`);
      throw new BadRequestException('KhÃ´ng thá»ƒ tÃ¬m kiáº¿m dÃ²ng mÃ¡y');
    }
  }

  /**
   * GET /phone-models/brand/:brandName
   * Láº¥y dÃ²ng mÃ¡y theo brand
   */
  @Get('brand/:brandName')
  async getPhoneModelsByBrand(@Param('brandName') brandName: string) {
    this.logger.log(`Láº¥y phone models theo brand: ${brandName}`);
    try {
      const models = await this.phoneModelService.getPhoneModelsByBrand(brandName);
      return {
        success: true,
        data: models,
      };
    } catch (error) {
      this.logger.error(`Lá»—i: ${error.message}`);
      throw new BadRequestException('KhÃ´ng thá»ƒ láº¥y dÃ²ng mÃ¡y theo hÃ£ng');
    }
  }

  /**
   * GET /phone-models/product/:productId
   * Láº¥y dÃ²ng mÃ¡y tÆ°Æ¡ng thÃ­ch vá»›i sáº£n pháº©m
   */
  @Get('product/:productId')
  async getCompatibleModels(@Param('productId') productId: string) {
    const id = parseInt(productId, 10);
    if (isNaN(id)) {
      throw new BadRequestException('Product ID khÃ´ng há»£p lá»‡');
    }

    this.logger.log(`Láº¥y compatible models cho product: ${id}`);
    try {
      const models = await this.phoneModelService.getCompatibleModels(id);
      return {
        success: true,
        data: models,
      };
    } catch (error) {
      this.logger.error(`Lá»—i: ${error.message}`);
      throw new BadRequestException('KhÃ´ng thá»ƒ láº¥y dÃ²ng mÃ¡y tÆ°Æ¡ng thÃ­ch');
    }
  }

  /**
   * GET /phone-models/:id
   * Láº¥y chi tiáº¿t dÃ²ng mÃ¡y
   */
  @Get(':id')
  async getPhoneModelById(@Param('id') id: string) {
    const modelId = parseInt(id, 10);
    if (isNaN(modelId)) {
      throw new BadRequestException('Model ID khÃ´ng há»£p lá»‡');
    }

    this.logger.log(`Láº¥y phone model: ${modelId}`);
    try {
      const model = await this.phoneModelService.getPhoneModelById(modelId);
      if (!model) {
        throw new NotFoundException('KhÃ´ng tÃ¬m tháº¥y dÃ²ng mÃ¡y');
      }
      return {
        success: true,
        data: model,
      };
    } catch (error) {
      if (error instanceof NotFoundException) throw error;
      this.logger.error(`Lá»—i: ${error.message}`);
      throw new BadRequestException('KhÃ´ng thá»ƒ láº¥y thÃ´ng tin dÃ²ng mÃ¡y');
    }
  }

  // ==================== ADMIN ENDPOINTS ====================

  /**
   * POST /phone-models
   * Táº¡o dÃ²ng mÃ¡y má»›i (Admin)
   */
  @Post()
  async createPhoneModel(@Body() modelData: Partial<PhoneModel>) {
    if (!modelData.brand_name || !modelData.model_name) {
      throw new BadRequestException('Thiáº¿u brand_name hoáº·c model_name');
    }

    this.logger.log(`Táº¡o phone model: ${modelData.model_name}`);
    try {
      const model = await this.phoneModelService.createPhoneModel(modelData);
      return {
        success: true,
        message: 'Táº¡o dÃ²ng mÃ¡y thÃ nh cÃ´ng',
        data: model,
      };
    } catch (error) {
      this.logger.error(`Lá»—i: ${error.message}`);
      throw new BadRequestException('KhÃ´ng thá»ƒ táº¡o dÃ²ng mÃ¡y');
    }
  }

  /**
   * PUT /phone-models/:id
   * Cáº­p nháº­t dÃ²ng mÃ¡y (Admin)
   */
  @Put(':id')
  async updatePhoneModel(
    @Param('id') id: string,
    @Body() modelData: Partial<PhoneModel>,
  ) {
    const modelId = parseInt(id, 10);
    if (isNaN(modelId)) {
      throw new BadRequestException('Model ID khÃ´ng há»£p lá»‡');
    }

    this.logger.log(`Cáº­p nháº­t phone model: ${modelId}`);
    try {
      const model = await this.phoneModelService.updatePhoneModel(modelId, modelData);
      return {
        success: true,
        message: 'Cáº­p nháº­t dÃ²ng mÃ¡y thÃ nh cÃ´ng',
        data: model,
      };
    } catch (error) {
      this.logger.error(`Lá»—i: ${error.message}`);
      throw new BadRequestException('KhÃ´ng thá»ƒ cáº­p nháº­t dÃ²ng mÃ¡y');
    }
  }

  /**
   * DELETE /phone-models/:id
   * XÃ³a dÃ²ng mÃ¡y (Admin)
   */
  @Delete(':id')
  async deletePhoneModel(@Param('id') id: string) {
    const modelId = parseInt(id, 10);
    if (isNaN(modelId)) {
      throw new BadRequestException('Model ID khÃ´ng há»£p lá»‡');
    }

    this.logger.log(`XÃ³a phone model: ${modelId}`);
    try {
      await this.phoneModelService.deletePhoneModel(modelId);
      return {
        success: true,
        message: 'XÃ³a dÃ²ng mÃ¡y thÃ nh cÃ´ng',
      };
    } catch (error) {
      this.logger.error(`Lá»—i: ${error.message}`);
      throw new BadRequestException('KhÃ´ng thá»ƒ xÃ³a dÃ²ng mÃ¡y');
    }
  }

  /**
   * POST /phone-models/product/:productId/compatibility
   * Set dÃ²ng mÃ¡y tÆ°Æ¡ng thÃ­ch cho sáº£n pháº©m (Admin)
   */
  @Post('product/:productId/compatibility')
  async setProductCompatibility(
    @Param('productId') productId: string,
    @Body() body: { phoneModelIds: number[] },
  ) {
    const id = parseInt(productId, 10);
    if (isNaN(id)) {
      throw new BadRequestException('Product ID khÃ´ng há»£p lá»‡');
    }

    if (!Array.isArray(body.phoneModelIds)) {
      throw new BadRequestException('phoneModelIds pháº£i lÃ  máº£ng');
    }

    this.logger.log(`Set compatibility cho product ${id}: ${body.phoneModelIds.length} models`);
    try {
      await this.phoneModelService.setProductCompatibility(id, body.phoneModelIds);
      return {
        success: true,
        message: 'Cáº­p nháº­t tÆ°Æ¡ng thÃ­ch thÃ nh cÃ´ng',
      };
    } catch (error) {
      this.logger.error(`Lá»—i: ${error.message}`);
      throw new BadRequestException('KhÃ´ng thá»ƒ cáº­p nháº­t tÆ°Æ¡ng thÃ­ch');
    }
  }
}




################################################################################
## FILE 66: product.service.ts
## Path: backend/src/product/product.service.ts
################################################################################

import { Injectable } from '@nestjs/common';
import { SupabaseService } from '../supabase.service';

@Injectable()
export class ProductService {
  constructor(private readonly supabaseService: SupabaseService) {}

  async getProducts(limit = 10) {
    const result = await this.supabaseService.getProducts(limit);
    return result.data || [];
  }

  async getProductById(productId: number) {
    const result = await this.supabaseService.getProductById(productId);
    return result.data || null;
  }

  async createProduct(productData: any) {
    const result = await this.supabaseService.createProduct(productData);
    if (result.error) {
      return { success: false, message: result.error.message };
    }
    return { success: true, data: result.data };
  }

  async updateProduct(productId: number, productData: any) {
    console.log('=== UPDATE PRODUCT DEBUG ===');
    console.log('Product ID:', productId);
    console.log('Product Data received:', JSON.stringify(productData, null, 2));
    console.log('image_url value:', productData.image_url);
    
    const result = await this.supabaseService.updateProduct(productId, productData);
    
    console.log('Supabase result:', JSON.stringify(result, null, 2));
    
    if (result.error) {
      console.log('Update error:', result.error.message);
      return { success: false, message: result.error.message };
    }
    return { success: true, data: result.data };
  }

  async deleteProduct(productId: number) {
    const result = await this.supabaseService.deleteProduct(productId);
    if (result.error) {
      return { success: false, message: result.error.message };
    }
    return { success: true, message: 'ÄÃ£ áº©n sáº£n pháº©m thÃ nh cÃ´ng' };
  }

  async getProductsBySeason(season: string) {
    const result = await this.supabaseService.getProductsBySeason(season);
    return result.data || [];
  }

  async getSeasonProductCounts() {
    return await this.supabaseService.getSeasonProductCounts();
  }
}




################################################################################
## FILE 67: product.module.ts
## Path: backend/src/product/product.module.ts
################################################################################

import { Module } from '@nestjs/common';
import { ProductController } from './product.controller';
import { ProductService } from './product.service';
import { SupabaseService } from '../supabase.service';
import { CloudinaryModule } from 'src/cloudinary/cloudinary.module';

@Module({
  // imports:[CloudinaryModule],
  controllers: [ProductController],
  providers: [ProductService, SupabaseService],
  exports: [ProductService],
})
export class ProductModule {}




################################################################################
## FILE 68: product.controller.ts
## Path: backend/src/product/product.controller.ts
################################################################################

import { Controller, Get, Post, Put, Delete, Query, Param, Body,UploadedFile, UseInterceptors } from '@nestjs/common';
import { FileInterceptor } from '@nestjs/platform-express';
import { ProductService } from './product.service';
import { CloudinaryService } from '../cloudinary/cloudinary.service';
@Controller('products')
export class ProductController {
  constructor(
    // private readonly cloudinaryService: CloudinaryService,
    private readonly productService: ProductService
  ) {}

  @Get()
  async getProducts(@Query('limit') limit: string = '10') {
    return await this.productService.getProducts(parseInt(limit));
  }

  // Season routes - Ä‘áº·t trÆ°á»›c :id Ä‘á»ƒ trÃ¡nh conflict
  @Get('season/counts')
  async getSeasonProductCounts() {
    return await this.productService.getSeasonProductCounts();
  }

  @Get('season/:season')
  async getProductsBySeason(@Param('season') season: string) {
    return await this.productService.getProductsBySeason(season);
  }

  @Get(':id')
  async getProductById(@Param('id') id: string) {
    return await this.productService.getProductById(parseInt(id));
  }

  @Post()
  async createProduct(@Body() productData: any) {
    return await this.productService.createProduct(productData);
  }

  @Put(':id')
  async updateProduct(@Param('id') id: string, @Body() productData: any) {
    return await this.productService.updateProduct(parseInt(id), productData);
  }

  @Delete(':id')
  async deleteProduct(@Param('id') id: string) {
    return await this.productService.deleteProduct(parseInt(id));
  }

  // @Post('upload')
  // @UseInterceptors(FileInterceptor('image'))
  // async uploadProduct(
  //   @UploadedFile() file: Express.Multer.File,
  //   @Body('name') name: string,
  // ) {
  //   const imageUrl = await this.cloudinaryService.uploadImage(
  //     file.buffer,
  //     'products',
  //   );

  //   return this.productService.create({
  //     name,
  //     image_url: imageUrl,
  //   });
  // }
}




################################################################################
## FILE 69: review.service.ts
## Path: backend/src/review/review.service.ts
################################################################################

import { Injectable } from '@nestjs/common';
import { SupabaseService } from '../supabase.service';

@Injectable()
export class ReviewService {
  constructor(private readonly supabaseService: SupabaseService) {}

  async getAllReviews(limit = 50) {
    const result = await this.supabaseService.getAllReviews(limit);
    return result;
  }

  async getProductReviews(productId: number) {
    const result = await this.supabaseService.getProductReviews(productId);
    return result;
  }

  async getReviewById(reviewId: number) {
    const result = await this.supabaseService.getReviewById(reviewId);
    return result;
  }

  async createReview(reviewData: any) {
    const result = await this.supabaseService.createReview(reviewData);
    return result;
  }

  async updateReview(reviewId: number, reviewData: any) {
    const result = await this.supabaseService.updateReview(reviewId, reviewData);
    return result;
  }

  async deleteReview(reviewId: number) {
    const result = await this.supabaseService.deleteReview(reviewId);
    return result;
  }

  async approveReview(reviewId: number, isApproved: boolean) {
    const result = await this.supabaseService.approveReview(reviewId, isApproved);
    return result;
  }
}




################################################################################
## FILE 70: review.module.ts
## Path: backend/src/review/review.module.ts
################################################################################

import { Module } from '@nestjs/common';
import { ReviewController } from './review.controller';
import { ReviewService } from './review.service';
import { SupabaseService } from '../supabase.service';

@Module({
  controllers: [ReviewController],
  providers: [ReviewService, SupabaseService],
  exports: [ReviewService],
})
export class ReviewModule {}




################################################################################
## FILE 71: review.controller.ts
## Path: backend/src/review/review.controller.ts
################################################################################

import { Controller, Get, Post, Put, Delete, Param, Body, Query } from '@nestjs/common';
import { ReviewService } from './review.service';

@Controller('reviews')
export class ReviewController {
  constructor(private readonly reviewService: ReviewService) {}

  // Láº¥y táº¥t cáº£ Ä‘Ã¡nh giÃ¡ (cho admin)
  @Get()
  async getAllReviews(@Query('limit') limit?: string) {
    return await this.reviewService.getAllReviews(limit ? parseInt(limit) : 50);
  }

  // Láº¥y Ä‘Ã¡nh giÃ¡ theo sáº£n pháº©m
  @Get('product/:productId')
  async getProductReviews(@Param('productId') productId: string) {
    return await this.reviewService.getProductReviews(parseInt(productId));
  }

  // Láº¥y Ä‘Ã¡nh giÃ¡ theo ID
  @Get(':id')
  async getReviewById(@Param('id') id: string) {
    return await this.reviewService.getReviewById(parseInt(id));
  }

  // Táº¡o Ä‘Ã¡nh giÃ¡ má»›i (khÃ¡ch hÃ ng gá»­i)
  @Post()
  async createReview(@Body() reviewData: {
    product_id: number;
    customer_id?: number;
    customer_name: string;
    customer_email?: string;
    rating: number;
    review_title?: string;
    review_text: string;
    is_approved?: boolean;
  }) {
    // Máº·c Ä‘á»‹nh chÆ°a duyá»‡t
    const data = {
      ...reviewData,
      is_approved: reviewData.is_approved ?? false,
      created_at: new Date().toISOString()
    };
    return await this.reviewService.createReview(data);
  }

  // Cáº­p nháº­t Ä‘Ã¡nh giÃ¡
  @Put(':id')
  async updateReview(@Param('id') id: string, @Body() reviewData: any) {
    return await this.reviewService.updateReview(parseInt(id), reviewData);
  }

  // Duyá»‡t/tá»« chá»‘i Ä‘Ã¡nh giÃ¡
  @Put(':id/approve')
  async approveReview(@Param('id') id: string, @Body() body: { is_approved: boolean }) {
    return await this.reviewService.approveReview(parseInt(id), body.is_approved);
  }

  // XÃ³a Ä‘Ã¡nh giÃ¡
  @Delete(':id')
  async deleteReview(@Param('id') id: string) {
    return await this.reviewService.deleteReview(parseInt(id));
  }
}




################################################################################
## FILE 72: shopping-cart.service.ts
## Path: backend/src/shopping-cart/shopping-cart.service.ts
################################################################################

import { Injectable, ForbiddenException, BadRequestException, Logger } from '@nestjs/common';
import { SupabaseService } from '../supabase.service';

@Injectable()
export class ShoppingCartService {
  private readonly logger = new Logger(ShoppingCartService.name);

  constructor(private readonly supabaseService: SupabaseService) {}

  /**
   * Láº¥y giá» hÃ ng cá»§a user (cÃ³ JOIN products)
   */
  async getCartByUserId(userId: string) {
    this.logger.log(`Getting cart for user: ${userId}`);

    const { data, error } = await this.supabaseService.getShoppingCartByUserId(userId);

    if (error) {
      this.logger.error(`Get cart error: ${error.message}`);
      return { success: false, message: error.message, data: [] };
    }

    // Transform data Ä‘á»ƒ frontend dá»… sá»­ dá»¥ng
    const cartItems = (data || []).map((item: any) => {
      // Láº¥y áº£nh primary hoáº·c áº£nh Ä‘áº§u tiÃªn tá»« product_images
      const images = item.products?.product_images || [];
      const primaryImage = images.find((img: any) => img.is_primary) || images[0];
      const imageUrl = primaryImage?.image_url || null;

      return {
        cart_id: item.cart_id,
        product_id: item.product_id,
        variant_id: item.variant_id,
        phone_model_id: item.phone_model_id,
        phone_model_name: item.phone_model_name,
        quantity: item.quantity,
        created_at: item.created_at,
        // Flatten product info
        product_name: item.products?.product_name || `Sáº£n pháº©m #${item.product_id}`,
        price: item.products?.sale_price || item.products?.price || 0,
        original_price: item.products?.price || 0,
        image_url: imageUrl,
        status: item.products?.status || 'active',
      };
    });

    return {
      success: true,
      data: cartItems,
      total: cartItems.reduce((sum: number, item: any) => sum + (item.price * item.quantity), 0),
      itemCount: cartItems.reduce((sum: number, item: any) => sum + item.quantity, 0),
    };
  }

  /**
   * ThÃªm sáº£n pháº©m vÃ o giá»
   */
  async addToCart(
    userId: string, 
    productId: number, 
    quantity: number = 1, 
    variantId?: number,
    phoneModelId?: number,
    phoneModelName?: string
  ) {
    this.logger.log(`Adding to cart: user=${userId}, product=${productId}, qty=${quantity}, phoneModel=${phoneModelName || phoneModelId}`);

    if (quantity < 1) {
      throw new BadRequestException('Sá»‘ lÆ°á»£ng pháº£i >= 1');
    }

    // 1ï¸âƒ£ Kiá»ƒm tra sáº£n pháº©m Ä‘Ã£ cÃ³ trong giá» chÆ°a (cÃ¹ng phone model)
    const { data: existingItem, error: checkError } = 
      await this.supabaseService.getCartItemByUserAndProduct(userId, productId, phoneModelId);

    if (checkError && checkError.code !== 'PGRST116') {
      // PGRST116 = no rows returned, khÃ´ng pháº£i lá»—i thá»±c sá»±
      this.logger.error(`Check existing error: ${checkError.message}`);
      return { success: false, message: checkError.message };
    }

    // 2ï¸âƒ£ Náº¿u Ä‘Ã£ tá»“n táº¡i â†’ cá»™ng dá»“n quantity
    if (existingItem) {
      const newQuantity = existingItem.quantity + quantity;
      const { data: updated, error: updateError } = 
        await this.supabaseService.updateShoppingCartQuantity(existingItem.cart_id, newQuantity);

      if (updateError) {
        this.logger.error(`Update quantity error: ${updateError.message}`);
        return { success: false, message: updateError.message };
      }

      this.logger.log(`Updated existing cart item: ${existingItem.cart_id}, new qty: ${newQuantity}`);

      return {
        success: true,
        action: 'updated',
        message: 'ÄÃ£ cáº­p nháº­t sá»‘ lÆ°á»£ng trong giá» hÃ ng',
        data: updated,
      };
    }

    // 3ï¸âƒ£ ChÆ°a tá»“n táº¡i â†’ insert má»›i
    const { data: created, error: createError } = await this.supabaseService.createShoppingCartItem({
      customer_id: userId,
      product_id: productId,
      variant_id: variantId || null,
      phone_model_id: phoneModelId || null,
      phone_model_name: phoneModelName || null,
      quantity,
    });

    if (createError) {
      this.logger.error(`Create cart item error: ${createError.message}`);
      return { success: false, message: createError.message };
    }

    this.logger.log(`Created new cart item for product: ${productId}`);

    return {
      success: true,
      action: 'created',
      message: 'ÄÃ£ thÃªm sáº£n pháº©m vÃ o giá» hÃ ng',
      data: created,
    };
  }

  /**
   * Cáº­p nháº­t sá»‘ lÆ°á»£ng sáº£n pháº©m trong giá»
   */
  async updateQuantity(userId: string, cartId: number, quantity: number) {
    this.logger.log(`Updating quantity: cart=${cartId}, qty=${quantity}`);

    // 1ï¸âƒ£ Verify ownership
    const { data: cartItem, error: getError } = await this.supabaseService.getCartItemById(cartId);

    if (getError || !cartItem) {
      throw new BadRequestException('KhÃ´ng tÃ¬m tháº¥y item trong giá» hÃ ng');
    }

    if (cartItem.customer_id !== userId) {
      throw new ForbiddenException('Báº¡n khÃ´ng cÃ³ quyá»n sá»­a giá» hÃ ng nÃ y');
    }

    // 2ï¸âƒ£ Náº¿u quantity = 0 â†’ xÃ³a item
    if (quantity <= 0) {
      return this.removeFromCart(userId, cartId);
    }

    // 3ï¸âƒ£ Update quantity
    const { data, error } = await this.supabaseService.updateShoppingCartQuantity(cartId, quantity);

    if (error) {
      this.logger.error(`Update error: ${error.message}`);
      return { success: false, message: error.message };
    }

    return {
      success: true,
      message: 'ÄÃ£ cáº­p nháº­t sá»‘ lÆ°á»£ng',
      data,
    };
  }

  /**
   * XÃ³a sáº£n pháº©m khá»i giá»
   */
  async removeFromCart(userId: string, cartId: number) {
    this.logger.log(`Removing from cart: cart=${cartId}`);

    // 1ï¸âƒ£ Verify ownership
    const { data: cartItem, error: getError } = await this.supabaseService.getCartItemById(cartId);

    if (getError || !cartItem) {
      throw new BadRequestException('KhÃ´ng tÃ¬m tháº¥y item trong giá» hÃ ng');
    }

    if (cartItem.customer_id !== userId) {
      throw new ForbiddenException('Báº¡n khÃ´ng cÃ³ quyá»n xÃ³a item nÃ y');
    }

    // 2ï¸âƒ£ Delete
    const { error } = await this.supabaseService.deleteShoppingCartItem(cartId);

    if (error) {
      this.logger.error(`Delete error: ${error.message}`);
      return { success: false, message: error.message };
    }

    return {
      success: true,
      message: 'ÄÃ£ xÃ³a sáº£n pháº©m khá»i giá» hÃ ng',
    };
  }

  /**
   * XÃ³a toÃ n bá»™ giá» hÃ ng
   */
  async clearCart(userId: string) {
    const { error } = await this.supabaseService.clearShoppingCart(userId);

    if (error) {
      return { success: false, message: error.message };
    }

    return {
      success: true,
      message: 'ÄÃ£ xÃ³a toÃ n bá»™ giá» hÃ ng',
    };
  }
}



################################################################################
## FILE 73: shopping-cart.module.ts
## Path: backend/src/shopping-cart/shopping-cart.module.ts
################################################################################

import { Module } from '@nestjs/common';
import { ShoppingCartController } from './shopping-cart.controller';
import { ShoppingCartService } from './shopping-cart.service';
import { SupabaseService } from '../supabase.service';
import { AuthModule } from '../auth/auth.module';

@Module({
  imports: [AuthModule],
  controllers: [ShoppingCartController],
  providers: [ShoppingCartService,SupabaseService],
  exports: [ShoppingCartService],
})
export class ShoppingCartModule {}




################################################################################
## FILE 74: shopping-cart.controller.ts
## Path: backend/src/shopping-cart/shopping-cart.controller.ts
################################################################################

import {
  Controller,
  Get,
  Post,
  Put,
  Delete,
  Body,
  Param,
  ParseIntPipe,
  HttpCode,
  HttpStatus,
} from '@nestjs/common';
import { ShoppingCartService } from './shopping-cart.service';
import { CurrentUser, CustomerOnly } from '../auth/decorators';

// DTOs
class AddToCartDto {
  productId: number;
  quantity?: number;
  variantId?: number;
  phoneModelId?: number;
  phoneModelName?: string;
}

class UpdateQuantityDto {
  quantity: number;
}

@Controller('shopping-cart')
export class ShoppingCartController {
  constructor(private readonly cartService: ShoppingCartService) {}

  /**
   * GET /shopping-cart - Láº¥y giá» hÃ ng cá»§a user hiá»‡n táº¡i
   * YÃªu cáº§u: ÄÄƒng nháº­p vá»›i role CUSTOMER
   */
  @Get()
  @CustomerOnly()
  async getCart(@CurrentUser('id') userId: string) {
    return this.cartService.getCartByUserId(userId);
  }

  /**
   * POST /shopping-cart - ThÃªm sáº£n pháº©m vÃ o giá»
   * Body: { productId: number, quantity?: number, variantId?: number }
   */
  @Post()
  @CustomerOnly()
  @HttpCode(HttpStatus.CREATED)
  async addToCart(
    @CurrentUser('id') userId: string,
    @Body() body: AddToCartDto,
  ) {
    return this.cartService.addToCart(
      userId,
      body.productId,
      body.quantity || 1,
      body.variantId,
      body.phoneModelId,
      body.phoneModelName,
    );
  }

  /**
   * PUT /shopping-cart/:id - Cáº­p nháº­t sá»‘ lÆ°á»£ng
   * Params: id = cart_id
   * Body: { quantity: number }
   */
  @Put(':id')
  @CustomerOnly()
  async updateQuantity(
    @CurrentUser('id') userId: string,
    @Param('id', ParseIntPipe) cartId: number,
    @Body() body: UpdateQuantityDto,
  ) {
    return this.cartService.updateQuantity(userId, cartId, body.quantity);
  }

  /**
   * DELETE /shopping-cart/:id - XÃ³a item khá»i giá»
   */
  @Delete(':id')
  @CustomerOnly()
  async removeFromCart(
    @CurrentUser('id') userId: string,
    @Param('id', ParseIntPipe) cartId: number,
  ) {
    return this.cartService.removeFromCart(userId, cartId);
  }

  /**
   * DELETE /shopping-cart - XÃ³a toÃ n bá»™ giá» hÃ ng
   */
  @Delete()
  @CustomerOnly()
  async clearCart(@CurrentUser('id') userId: string) {
    return this.cartService.clearCart(userId);
  }
}




################################################################################
## FILE 75: users.service.ts
## Path: backend/src/users/users.service.ts
################################################################################

import { Injectable } from '@nestjs/common';
import { SupabaseService } from '../supabase.service';

@Injectable()
export class UsersService {
  constructor(private readonly supabaseService: SupabaseService) {}

  async getUsers() {
    const result = await this.supabaseService.getCustomers();
    return result.data || [];
  }
}




################################################################################
## FILE 76: users.module.ts
## Path: backend/src/users/users.module.ts
################################################################################

import { Module } from '@nestjs/common';
import { UsersController } from './users.controller';
import { UsersService } from './users.service';
import { SupabaseService } from '../supabase.service';

@Module({
  controllers: [UsersController],
  providers: [UsersService, SupabaseService],
  exports: [UsersService],
})
export class UsersModule {}




################################################################################
## FILE 77: users.controller.ts
## Path: backend/src/users/users.controller.ts
################################################################################

import { Controller, Get } from '@nestjs/common';
import { UsersService } from './users.service';

@Controller('users')
export class UsersController {
  constructor(private readonly usersService: UsersService) {}

  @Get()
  async getUsers() {
    return await this.usersService.getUsers();
  }
}




################################################################################
## FILE 78: wishlist.service.ts
## Path: backend/src/wishlist/wishlist.service.ts
################################################################################

import { Injectable } from '@nestjs/common';
import { SupabaseService } from '../supabase.service';

@Injectable()
export class WishlistService {
  constructor(private supabaseService: SupabaseService) {}

  // Láº¥y danh sÃ¡ch yÃªu thÃ­ch cá»§a user
  async getWishlist(userId: string) {
    try {
      const { data, error } = await this.supabaseService.getWishlistByUserId(userId);

      if (error) {
        console.error('Get wishlist error:', error);
        return [];
      }

      return data || [];
    } catch (error) {
      console.error('Get wishlist error:', error);
      return [];
    }
  }

  // Láº¥y danh sÃ¡ch product_id trong wishlist cá»§a user
  async getWishlistProductIds(userId: string): Promise<number[]> {
    try {
      const { data, error } = await this.supabaseService.getWishlistProductIds(userId);

      if (error) {
        console.error('Get wishlist product ids error:', error);
        return [];
      }

      return data?.map(item => item.product_id) || [];
    } catch (error) {
      console.error('Get wishlist product ids error:', error);
      return [];
    }
  }

  // ThÃªm sáº£n pháº©m vÃ o danh sÃ¡ch yÃªu thÃ­ch
  async addToWishlist(userId: string, productId: number) {
    try {
      const { data, error } = await this.supabaseService.addProductToWishlist(userId, productId);

      if (error) {
        // Náº¿u Ä‘Ã£ tá»“n táº¡i thÃ¬ khÃ´ng bÃ¡o lá»—i
        if (error.code === '23505') {
          return { message: 'Product already in wishlist', success: true };
        }
        console.error('Add to wishlist error:', error);
        throw error;
      }

      return { message: 'Added to wishlist', success: true, data };
    } catch (error) {
      console.error('Add to wishlist error:', error);
      throw error;
    }
  }

  // XÃ³a sáº£n pháº©m khá»i danh sÃ¡ch yÃªu thÃ­ch
  async removeFromWishlist(userId: string, productId: number) {
    try {
      const { error } = await this.supabaseService.removeProductFromWishlist(userId, productId);

      if (error) {
        console.error('Remove from wishlist error:', error);
        throw error;
      }

      return { message: 'Removed from wishlist', success: true };
    } catch (error) {
      console.error('Remove from wishlist error:', error);
      throw error;
    }
  }

  // Toggle wishlist (thÃªm náº¿u chÆ°a cÃ³, xÃ³a náº¿u Ä‘Ã£ cÃ³)
  async toggleWishlist(userId: string, productId: number) {
    try {
      // Kiá»ƒm tra xem Ä‘Ã£ cÃ³ trong wishlist chÆ°a
      const { data: existing } = await this.supabaseService.getWishlistItem(userId, productId);

      if (existing) {
        // ÄÃ£ cÃ³ -> xÃ³a
        await this.removeFromWishlist(userId, productId);
        return { message: 'Removed from wishlist', success: true, action: 'removed' };
      } else {
        // ChÆ°a cÃ³ -> thÃªm
        await this.addToWishlist(userId, productId);
        return { message: 'Added to wishlist', success: true, action: 'added' };
      }
    } catch (error) {
      console.error('Toggle wishlist error:', error);
      throw error;
    }
  }

  // Kiá»ƒm tra sáº£n pháº©m cÃ³ trong wishlist khÃ´ng
  async isInWishlist(userId: string, productId: number): Promise<boolean> {
    try {
      const { data } = await this.supabaseService.getWishlistItem(userId, productId);
      return !!data;
    } catch (error) {
      return false;
    }
  }
}




################################################################################
## FILE 79: wishlist.module.ts
## Path: backend/src/wishlist/wishlist.module.ts
################################################################################

import { Module } from '@nestjs/common';
import { WishlistController } from './wishlist.controller';
import { WishlistService } from './wishlist.service';
import { SupabaseService } from '../supabase.service';
import { AuthModule } from '../auth/auth.module';

@Module({
  imports: [AuthModule],
  controllers: [WishlistController],
  providers: [WishlistService, SupabaseService],
  exports: [WishlistService],
})
export class WishlistModule {}




################################################################################
## FILE 80: wishlist.controller.ts
## Path: backend/src/wishlist/wishlist.controller.ts
################################################################################

import {
  Controller,
  Get,
  Post,
  Delete,
  Param,
  UseGuards,
  Request,
  ParseIntPipe,
} from '@nestjs/common';
import { WishlistService } from './wishlist.service';
import { JwtAuthGuard } from '../auth/guards/jwt-auth.guard';

@Controller('wishlist')
export class WishlistController {
  constructor(private readonly wishlistService: WishlistService) {}

  // Láº¥y danh sÃ¡ch yÃªu thÃ­ch cá»§a user
  @UseGuards(JwtAuthGuard)
  @Get()
  async getWishlist(@Request() req) {
    const userId = req.user.sub || req.user.id;
    return this.wishlistService.getWishlist(userId);
  }

  // Láº¥y danh sÃ¡ch product_id trong wishlist
  @UseGuards(JwtAuthGuard)
  @Get('product-ids')
  async getWishlistProductIds(@Request() req) {
    const userId = req.user.sub || req.user.id;
    return this.wishlistService.getWishlistProductIds(userId);
  }

  // ThÃªm sáº£n pháº©m vÃ o wishlist
  @UseGuards(JwtAuthGuard)
  @Post(':productId')
  async addToWishlist(
    @Request() req,
    @Param('productId', ParseIntPipe) productId: number,
  ) {
    const userId = req.user.sub || req.user.id;
    return this.wishlistService.addToWishlist(userId, productId);
  }

  // XÃ³a sáº£n pháº©m khá»i wishlist
  @UseGuards(JwtAuthGuard)
  @Delete(':productId')
  async removeFromWishlist(
    @Request() req,
    @Param('productId', ParseIntPipe) productId: number,
  ) {
    const userId = req.user.sub || req.user.id;
    return this.wishlistService.removeFromWishlist(userId, productId);
  }

  // Toggle wishlist (thÃªm/xÃ³a)
  @UseGuards(JwtAuthGuard)
  @Post('toggle/:productId')
  async toggleWishlist(
    @Request() req,
    @Param('productId', ParseIntPipe) productId: number,
  ) {
    const userId = req.user.sub || req.user.id;
    return this.wishlistService.toggleWishlist(userId, productId);
  }

  // Kiá»ƒm tra sáº£n pháº©m cÃ³ trong wishlist khÃ´ng
  @UseGuards(JwtAuthGuard)
  @Get('check/:productId')
  async isInWishlist(
    @Request() req,
    @Param('productId', ParseIntPipe) productId: number,
  ) {
    const userId = req.user.sub || req.user.id;
    const isInWishlist = await this.wishlistService.isInWishlist(userId, productId);
    return { isInWishlist };
  }
}




################################################################################
## FILE 81: postcss.config.mjs
## Path: fontend/postcss.config.mjs
################################################################################

const config = {
  plugins: {
    "@tailwindcss/postcss": {},
  },
};

export default config;




################################################################################
## FILE 82: package.json
## Path: fontend/package.json
################################################################################

{
  "name": "fontend",
  "version": "0.1.0",
  "private": true,
  "scripts": {
    "dev": "next dev",
    "build": "next build",
    "start": "next start",
    "lint": "eslint"
  },
  "dependencies": {
    "@supabase/ssr": "^0.8.0",
    "@supabase/supabase-js": "^2.87.3",
    "axios": "^1.13.2",
    "fabric": "^6.9.1",
    "lucide-react": "^0.555.0",
    "next": "16.0.7",
    "react": "19.2.0",
    "react-dom": "19.2.0",
    "sharp": "^0.34.5"
  },
  "devDependencies": {
    "@tailwindcss/postcss": "^4",
    "@types/node": "^20",
    "@types/react": "^19",
    "@types/react-dom": "^19",
    "autoprefixer": "^10.4.23",
    "babel-plugin-react-compiler": "1.0.0",
    "eslint": "^9",
    "eslint-config-next": "16.0.7",
    "postcss": "^8.5.6",
    "tailwindcss": "^3.4.13",
    "typescript": "^5"
  }
}




################################################################################
## FILE 83: next.config.ts
## Path: fontend/next.config.ts
################################################################################

import type { NextConfig } from "next";

const nextConfig: NextConfig = {
  /* config options here */
  reactCompiler: true,
  images: {
    remotePatterns: [
      {
        protocol: 'https',
        hostname: '**',
      },
      {
        protocol: 'http',
        hostname: '**',
      },
    ],
  },
};

export default nextConfig;




################################################################################
## FILE 84: next-env.d.ts
## Path: fontend/next-env.d.ts
################################################################################

/// <reference types="next" />
/// <reference types="next/image-types/global" />
import "./.next/dev/types/routes.d.ts";

// NOTE: This file should not be edited
// see https://nextjs.org/docs/app/api-reference/config/typescript for more information.




################################################################################
## FILE 85: constants.ts
## Path: fontend/lib/constants.ts
################################################################################

// Danh má»¥c sáº£n pháº©m - dÃ¹ng chung cho táº¥t cáº£ cÃ¡c trang
export const PRODUCT_CATEGORIES = [
  { name: 'á»p lÆ°ng', icon: 'ðŸ“±', count: 120 },
  { name: 'CÆ°á»ng lá»±c mÃ n hÃ¬nh', icon: 'ðŸ›¡ï¸', count: 95 },
  { name: 'Miáº¿ng dÃ¡n camera', icon: 'ðŸ“·', count: 85 },
  // { name: 'CÃ¡p sáº¡c', icon: 'âš¡', count: 60 },
  // { name: 'Tai nghe', icon: 'ðŸŽ§', count: 40 },
  // { name: 'DÃ¢y Ä‘eo Ä‘iá»‡n thoáº¡i', icon: 'ðŸ”—', count: 60 },
  // { name: 'Sticker trang trÃ­', icon: 'âœ¨', count: 40 }
];

// Danh má»¥c cho trang Shop (cÃ³ thÃªm "Táº¥t Cáº£")
export const SHOP_CATEGORIES = [
  { name: 'Táº¥t Cáº£', icon: 'ðŸ›’' },
  ...PRODUCT_CATEGORIES.map(cat => ({ name: cat.name, icon: cat.icon }))
];

// ThÆ°Æ¡ng hiá»‡u
export const BRAND_NAME = 'GoatTech';

// Danh sÃ¡ch thiáº¿t bá»‹ há»— trá»£
export const DEVICES = [
  'iPhone 17 Pro Max',
  'iPhone 17 Pro',
  'iPhone 16 Pro Max',
  'iPhone 16 Pro',
  'iPhone 16e',
  'iPhone 15 Pro Max',
  'iPhone 15 Pro',
  'iPhone 14 Pro Max',
  'Samsung Galaxy S24',
];

// Banner slides cho trang chá»§
export const BANNER_SLIDES = [
  {
    title: 'á»p Äiá»‡n Thoáº¡i Cao Cáº¥p - Shop #1 Viá»‡t Nam',
    subtitle: 'Báº£o Vá»‡ Äiá»‡n Thoáº¡i Cá»§a Báº¡n Vá»›i Phong CÃ¡ch',
    bg: 'from-purple-600 to-pink-600'
  },
  {
    title: 'Bá»™ SÆ°u Táº­p XuÃ¢n 2024 - Máº«u Má»›i Äáº·c Biá»‡t',
    subtitle: 'Thiáº¿t Káº¿ Äá»™c ÄÃ¡o, Cháº¥t LÆ°á»£ng Tuyá»‡t Vá»i',
    bg: 'from-blue-600 to-cyan-600'
  },
  {
    title: 'Miá»…n PhÃ­ Váº­n Chuyá»ƒn - ÄÆ¡n HÃ ng TrÃªn 100K',
    subtitle: 'Nhanh, An ToÃ n, Uy TÃ­n',
    bg: 'from-green-600 to-teal-600'
  }
];




################################################################################
## FILE 86: api-client.ts
## Path: fontend/lib/api-client.ts
################################################################################

// ============ ADMIN DASHBOARD ============
export const fetchAdminDashboard = async () => {
  const response = await apiClient.get('/admin/dashboard');
  return response.data;
};
import axios from 'axios';

const API_BASE_URL = 'http://localhost:3001';

export const apiClient = axios.create({
  baseURL: API_BASE_URL,
  headers: {
    'Content-Type': 'application/json',
  },
});

// ============ USERS ============
export const fetchUsers = async () => {
  const response = await apiClient.get('/users');
  return response.data;
};

// ============ PRODUCTS ============
export const fetchProducts = async (limit = 10) => {
  const response = await apiClient.get(`/products?limit=${limit}`);
  return response.data;
};

export const fetchProductById = async (id: number) => {
  try {
    const response = await apiClient.get(`/products/${id}`);
    return response.data;
  } catch (error) {
    console.error('Fetch product by id error:', error);
    return null;
  }
};

export const createProduct = async (productData: any) => {
  const response = await apiClient.post('/products', productData);
  return response.data;
};

export const updateProduct = async (id: number, productData: any) => {
  const response = await apiClient.put(`/products/${id}`, productData);
  return response.data;
};

export const deleteProduct = async (id: number) => {
  const response = await apiClient.delete(`/products/${id}`);
  return response.data;
};

// ============ PRODUCTS BY SEASON ============
export const fetchProductsBySeason = async (season: string) => {
  const response = await apiClient.get(`/products/season/${season}`);
  return response.data;
};

export const fetchSeasonProductCounts = async () => {
  const response = await apiClient.get('/products/season/counts');
  return response.data;
};

// ============ ORDERS ============
export const fetchOrders = async (limit = 20) => {
  try {
    // Gá»­i token náº¿u cÃ³
    const customerData = localStorage.getItem('customer');
    const headers: Record<string, string> = {};
    
    if (customerData) {
      const customer = JSON.parse(customerData);
      if (customer.access_token) {
        headers['Authorization'] = `Bearer ${customer.access_token}`;
      }
    }
    
    const response = await apiClient.get(`/orders?limit=${limit}`, { headers });
    return response.data;
  } catch (error: any) {
    console.error('fetchOrders error:', error);
    return [];
  }
};

// Láº¥y táº¥t cáº£ orders cho admin
export const fetchAllOrdersAdmin = async () => {
  try {
    const customerData = localStorage.getItem('customer');
    const headers: Record<string, string> = {};
    
    if (customerData) {
      const customer = JSON.parse(customerData);
      if (customer.access_token) {
        headers['Authorization'] = `Bearer ${customer.access_token}`;
      }
    }
    
    const response = await apiClient.get('/orders/admin/all', { headers });
    return response.data;
  } catch (error: any) {
    console.error('fetchAllOrdersAdmin error:', error);
    return [];
  }
};

// ============ CATEGORIES ============
export const fetchCategories = async () => {
  const response = await apiClient.get('/categories');
  return response.data;
};

export const fetchCategoriesWithCount = async () => {
  const response = await apiClient.get('/categories/with-count');
  return response.data;
};

export const fetchRootCategories = async () => {
  const response = await apiClient.get('/categories/root');
  return response.data;
};

export const fetchCategoryById = async (id: number) => {
  const response = await apiClient.get(`/categories/${id}`);
  return response.data;
};

export const fetchCategoryBySlug = async (slug: string) => {
  const response = await apiClient.get(`/categories/slug/${slug}`);
  return response.data;
};

export const fetchChildCategories = async (parentId: number) => {
  const response = await apiClient.get(`/categories/${parentId}/children`);
  return response.data;
};

export const createCategory = async (categoryData: {
  category_name: string;
  category_slug: string;
  description?: string;
  parent_category_id?: number | null;
  display_order?: number;
  is_active?: boolean;
}) => {
  const response = await apiClient.post('/categories', categoryData);
  return response.data;
};

export const updateCategory = async (id: number, categoryData: any) => {
  const response = await apiClient.put(`/categories/${id}`, categoryData);
  return response.data;
};

export const deleteCategory = async (id: number) => {
  const response = await apiClient.delete(`/categories/${id}`);
  return response.data;
};

// ============ AUTHENTICATION ============

export const registerCustomer = async (customerData: {
  email: string;
  password: string;
  first_name?: string;
  last_name?: string;
  full_name?: string;
  phone?: string;
}) => {
  try {
    // GhÃ©p first_name + last_name thÃ nh full_name náº¿u cáº§n
    const fullName = customerData.full_name || 
      `${customerData.first_name || ''} ${customerData.last_name || ''}`.trim();
    
    const response = await apiClient.post('/auth/register', {
      email: customerData.email.trim().toLowerCase(),
      password: customerData.password,
      full_name: fullName,
      phone: customerData.phone?.trim() || undefined,
    });
    return response.data;
  } catch (error: any) {
    // Tráº£ vá» error message tá»« backend
    return {
      success: false,
      message: error.response?.data?.message || 'ÄÄƒng kÃ½ tháº¥t báº¡i',
    };
  }
};

export const loginCustomer = async (email: string, password: string) => {
  try {
    const response = await apiClient.post('/auth/login', { 
      email: email.trim().toLowerCase(), 
      password 
    });
    return response.data;
  } catch (error: any) {
    // Tráº£ vá» error message tá»« backend
    return {
      success: false,
      message: error.response?.data?.message || 'ÄÄƒng nháº­p tháº¥t báº¡i',
    };
  }
};

export const validateToken = async (token: string) => {
  try {
    const response = await apiClient.post('/auth/validate', null, {
      headers: {
        Authorization: `Bearer ${token}`,
      },
    });
    return response.data;
  } catch (error: any) {
    return {
      valid: false,
      message: error.response?.data?.message || 'Token khÃ´ng há»£p lá»‡',
    };
  }
};

export const changePassword = async (oldPassword: string, newPassword: string) => {
  try {
    const response = await apiClient.put('/auth/change-password', {
      oldPassword,
      newPassword,
    });
    return response.data;
  } catch (error: any) {
    return {
      success: false,
      message: error.response?.data?.message || 'Äá»•i máº­t kháº©u tháº¥t báº¡i',
    };
  }
};
// ============ REVIEWS ============
export const fetchAllReviews = async (limit = 50) => {
  const response = await apiClient.get(`/reviews?limit=${limit}`);
  return response.data;
};

export const fetchProductReviews = async (productId: number) => {
  const response = await apiClient.get(`/reviews/product/${productId}`);
  return response.data;
};

export const createReview = async (reviewData: {
  product_id: number;
  customer_id?: number;
  customer_name: string;
  customer_email?: string;
  rating: number;
  review_title?: string;
  review_text: string;
}) => {
  const response = await apiClient.post('/reviews', reviewData);
  return response.data;
};

export const approveReview = async (reviewId: number, isApproved: boolean) => {
  const response = await apiClient.put(`/reviews/${reviewId}/approve`, { is_approved: isApproved });
  return response.data;
};

export const deleteReview = async (reviewId: number) => {
  const response = await apiClient.delete(`/reviews/${reviewId}`);
  return response.data;
};

// ============ CONTACT MESSAGES ============
export const fetchAllContacts = async (limit = 50) => {
  const response = await apiClient.get(`/contacts?limit=${limit}`);
  return response.data;
};

export const createContactMessage = async (messageData: {
  name: string;
  email: string;
  phone?: string;
  subject?: string;
  message: string;
}) => {
  const response = await apiClient.post('/contacts', messageData);
  return response.data;
};

export const updateContactStatus = async (id: number, status: string) => {
  const response = await apiClient.put(`/contacts/${id}/status`, { status });
  return response.data;
};

export const deleteContact = async (id: number) => {
  const response = await apiClient.delete(`/contacts/${id}`);
  return response.data;
};

// ============ PAYMENT / MOMO ============
export const createMomoPayment = async (data: {
  amount: string | number;
  orderInfo?: string;
  orderId?: string;
  redirectUrl?: string;
  ipnUrl?: string;
  extraData?: string;
}) => {
  const response = await apiClient.post('/payment/momo', {
    amount: String(data.amount),
    orderInfo: data.orderInfo || 'Thanh toÃ¡n Ä‘Æ¡n hÃ ng GoatTech',
    orderId: data.orderId,
    redirectUrl: data.redirectUrl,
    ipnUrl: data.ipnUrl,
    extraData: data.extraData || '',
  });
  return response.data;
};

export const checkMomoPaymentStatus = async (orderId: string) => {
  const response = await apiClient.post('/payment/momo/check-status', { orderId });
  return response.data;
};

export const refundMomoPayment = async (data: {
  orderId: string;
  transId: string;
  amount: string | number;
  description?: string;
}) => {
  const response = await apiClient.post('/payment/momo/refund', {
    orderId: data.orderId,
    transId: data.transId,
    amount: String(data.amount),
    description: data.description || 'HoÃ n tiá»n Ä‘Æ¡n hÃ ng',
  });
  return response.data;
};

// ============ COLLECTIONS ============
export const fetchAllCollections = async () => {
  const response = await apiClient.get('/collections');
  return response.data;
};

export const fetchCollectionsByType = async (type: string) => {
  const response = await apiClient.get(`/collections/type/${type}`);
  return response.data;
};

export const fetchCollectionBySlug = async (slug: string) => {
  const response = await apiClient.get(`/collections/slug/${slug}`);
  return response.data;
};

export const fetchCollectionProductCounts = async () => {
  const response = await apiClient.get('/collections/counts');
  return response.data;
};

export const fetchProductsByCollection = async (slug: string) => {
  const response = await apiClient.get(`/collections/slug/${slug}/products`);
  return response.data;
};

export const fetchProductCollections = async (productId: number) => {
  const response = await apiClient.get(`/collections/product/${productId}`);
  return response.data;
};

export const addProductToCollection = async (productId: number, collectionId: number) => {
  const response = await apiClient.post('/collections/product', { productId, collectionId });
  return response.data;
};

export const updateProductCollections = async (productId: number, collectionIds: number[]) => {
  const response = await apiClient.put(`/collections/product/${productId}`, { collectionIds });
  return response.data;
};

export const removeProductFromCollection = async (productId: number, collectionId: number) => {
  const response = await apiClient.delete('/collections/product', { 
    data: { productId, collectionId } 
  });
  return response.data;
};

export const createCollection = async (collectionData: {
  collection_name: string;
  collection_slug: string;
  collection_description?: string;
  collection_image?: string;
  collection_gradient?: string;
  collection_icon?: string;
  collection_type?: string;
  display_order?: number;
}) => {
  const response = await apiClient.post('/collections', collectionData);
  return response.data;
};

export const updateCollection = async (id: number, collectionData: any) => {
  const response = await apiClient.put(`/collections/${id}`, collectionData);
  return response.data;
};

export const deleteCollection = async (id: number) => {
  const response = await apiClient.delete(`/collections/${id}`);
  return response.data;
};

// ============ ERROR HANDLING ============
apiClient.interceptors.response.use(
  (response) => response,
  (error) => {
    console.error('API Error:', error.response?.data || error.message);
    return Promise.reject(error);
  },
);
// ============ SHOPPING_CART ============
/**
 * Láº¥y giá» hÃ ng cá»§a user hiá»‡n táº¡i
 * YÃªu cáº§u: Pháº£i Ä‘Äƒng nháº­p (cÃ³ token)
 */
export const fetchShoppingCart = async () => {
  try {
    console.log('console log Ä‘ang Ä‘Æ°á»£c gá»i tá»« fetchShoppingCart');
    // Láº¥y token tá»« localStorage
    const customerData = localStorage.getItem('customer');
    console.log(customerData);
    console.log(getAuthHeaders());
    
    if (!customerData) {
      return { success: false, message: 'ChÆ°a Ä‘Äƒng nháº­p', data: [] };
    }
    const customer = JSON.parse(customerData);
    console.log('Customer ID (UUID):', customer.id);
    
    const response = await apiClient.get('/shopping-cart', {
      headers: getAuthHeaders(),
    });
    return response.data;
  } catch (error: any) {
    console.error('Fetch cart error:', error);
    return {
      success: false,
      message: error.response?.data?.message || 'KhÃ´ng thá»ƒ táº£i giá» hÃ ng',
      data: [],
    };
  }
};

/**
 * ThÃªm sáº£n pháº©m vÃ o giá»
 */
export const addToShoppingCart = async (data: {
  userId: string;
  productId: number;
  quantity?: number;
  variantId?: number;
  phoneModelId?: number;
  phoneModelName?: string;
}) => {
  try {
    const response = await apiClient.post(
      '/shopping-cart',
      {
        productId: data.productId,
        quantity: data.quantity || 1,
        variantId: data.variantId || null,
        phoneModelId: data.phoneModelId || null,
        phoneModelName: data.phoneModelName || null,
      },
      {
        headers: getAuthHeaders(),
      }
    );
    return response.data;
  } catch (error: any) {
    console.error('Add to cart error:', error);
    return {
      success: false,
      message: error.response?.data?.message || 'KhÃ´ng thá»ƒ thÃªm vÃ o giá» hÃ ng',
    };
  }
};

/**
 * Cáº­p nháº­t sá»‘ lÆ°á»£ng
 */
export const updateShoppingCart = async (cartId: number, quantity: number) => {
  try {
    const response = await apiClient.put(
      `/shopping-cart/${cartId}`,
      { quantity },
      {
        headers: getAuthHeaders(),
      }
    );
    return response.data;
  } catch (error: any) {
    console.error('Update cart error:', error);
    return {
      success: false,
      message: error.response?.data?.message || 'KhÃ´ng thá»ƒ cáº­p nháº­t',
    };
  }
};

/**
 * XÃ³a item khá»i giá»
 */
export const deleteShoppingCart = async (cartId: number) => {
  try {
    const response = await apiClient.delete(`/shopping-cart/${cartId}`, {
      headers: getAuthHeaders(),
    });
    return response.data;
  } catch (error: any) {
    console.error('Delete cart item error:', error);
    return {
      success: false,
      message: error.response?.data?.message || 'KhÃ´ng thá»ƒ xÃ³a',
    };
  }
};

/**
 * XÃ³a toÃ n bá»™ giá» hÃ ng
 */
export const clearShoppingCart = async () => {
  try {
    const response = await apiClient.delete('/shopping-cart', {
      headers: getAuthHeaders(),
    });
    return response.data;
  } catch (error: any) {
    console.error('Clear cart error:', error);
    return {
      success: false,
      message: error.response?.data?.message || 'KhÃ´ng thá»ƒ xÃ³a giá» hÃ ng',
    };
  }
};

/**
 * Helper: Láº¥y auth headers
 */
const getAuthHeaders = () => {
  const customerData = localStorage.getItem('customer');
  if (!customerData) return {};
  console.log('ðŸ” getAuthHeaders called');
  console.log('ðŸ“¦ customerData raw:', customerData);
  try {
    const customer = JSON.parse(customerData);
    // Náº¿u cÃ³ access_token thÃ¬ dÃ¹ng, khÃ´ng thÃ¬ dÃ¹ng id nhÆ° lÃ  simple auth
    console.log('âœ… Using Authorization Bearer token',customer.access_token);
    if (customer.access_token) {
      return { Authorization: `Bearer ${customer.access_token}` };
    }
    // Fallback: gá»­i user-id trong header (backend cáº§n xá»­ lÃ½)
    return { 'X-User-Id': customer.id };
  } catch {
    return {};
  }
};

// ============ ORDERS - ENHANCED ============

/**
 * Táº¡o Ä‘Æ¡n hÃ ng má»›i
 */
export const createOrder = async (orderData: {
  items: {
    product_id: number;
    variant_id?: number;
    product_name: string;
    variant_name?: string;
    sku?: string;
    quantity: number;
    unit_price: number;
    discount_amount?: number;
  }[];
  shipping_address?: {
    full_name: string;
    phone: string;
    address_line1: string;
    ward?: string;
    district?: string;
    city: string;
  };
  subtotal:number,
  payment_method?: string;
  coupon_code?: string;
  customer_note?: string;
}) => {
  try {
    const response = await apiClient.post('/orders', orderData, {
      headers: getAuthHeaders(),
    });
    return response.data;
  } catch (error: any) {
    console.error('Create order error:', error);
    return {
      success: false,
      message: error.response?.data?.message || 'KhÃ´ng thá»ƒ táº¡o Ä‘Æ¡n hÃ ng',
    };
  }
};

/**
 * Láº¥y Ä‘Æ¡n hÃ ng theo order number
 */
export const fetchOrderByNumber = async (orderNumber: string) => {
  try {
    const response = await apiClient.get(`/orders/number/${orderNumber}`);
    return response.data;
  } catch (error: any) {
    console.error('Fetch order error:', error);
    return null;
  }
};

/**
 * Láº¥y danh sÃ¡ch Ä‘Æ¡n hÃ ng cá»§a customer
 */
export const fetchMyOrders = async () => {
  try {
    const response = await apiClient.get('/orders', {
      headers: getAuthHeaders(),
    });
    return response.data;
  } catch (error: any) {
    console.error('Fetch orders error:', error);
    return [];
  }
};

// ============ WISHLIST ============
export const fetchWishlist = async () => {
  try {
    const response = await apiClient.get('/wishlist', {
      headers: getAuthHeaders(),
    });
    return response.data;
  } catch (error: any) {
    console.error('Fetch wishlist error:', error);
    return [];
  }
};

export const fetchWishlistProductIds = async (): Promise<number[]> => {
  try {
    const response = await apiClient.get('/wishlist/product-ids', {
      headers: getAuthHeaders(),
    });
    return response.data;
  } catch (error: any) {
    console.error('Fetch wishlist product ids error:', error);
    return [];
  }
};

export const addToWishlist = async (productId: number) => {
  try {
    const response = await apiClient.post(`/wishlist/${productId}`, {}, {
      headers: getAuthHeaders(),
    });
    return response.data;
  } catch (error: any) {
    console.error('Add to wishlist error:', error);
    throw error;
  }
};

export const removeFromWishlist = async (productId: number) => {
  try {
    const response = await apiClient.delete(`/wishlist/${productId}`, {
      headers: getAuthHeaders(),
    });
    return response.data;
  } catch (error: any) {
    console.error('Remove from wishlist error:', error);
    throw error;
  }
};

export const toggleWishlist = async (productId: number) => {
  try {
    const response = await apiClient.post(`/wishlist/toggle/${productId}`, {}, {
      headers: getAuthHeaders(),
    });
    return response.data;
  } catch (error: any) {
    console.error('Toggle wishlist error:', error);
    throw error;
  }
};

export const checkIsInWishlist = async (productId: number): Promise<boolean> => {
  try {
    const response = await apiClient.get(`/wishlist/check/${productId}`, {
      headers: getAuthHeaders(),
    });
    return response.data.isInWishlist;
  } catch (error: any) {
    console.error('Check wishlist error:', error);
    return false;
  }
};

// ============ GIFT ============
export interface SendGiftData {
  senderName: string;
  senderEmail: string;
  senderMessage?: string;
  senderId?: string;
  recipientName: string;
  recipientEmail: string;
  recipientPhone?: string;
  recipientAddress?: string;
  productId: number;
  quantity?: number;
}

export const sendGift = async (data: SendGiftData) => {
  const response = await apiClient.post('/gift/send', data);
  return response.data;
};

export const verifyGift = async (giftId: string, verificationCode: string) => {
  const response = await apiClient.post('/gift/verify', { giftId, verificationCode });
  return response.data;
};

export const claimGift = async (giftId: string, recipientAddress: string, recipientPhone: string) => {
  const response = await apiClient.post('/gift/claim', { giftId, recipientAddress, recipientPhone });
  return response.data;
};

export const getGiftInfo = async (giftId: string) => {
  const response = await apiClient.get(`/gift/${giftId}`);
  return response.data;
};

export const getSentGifts = async (userId: string) => {
  const response = await apiClient.get(`/gift/sent/${userId}`);
  return response.data;
};

export const getReceivedGifts = async (email: string) => {
  const response = await apiClient.get(`/gift/received/by-email?email=${encodeURIComponent(email)}`);
  return response.data;
};

// ============ CUSTOM DESIGNS ============
export interface CreateDesignData {
  userId?: string;
  guestEmail?: string;
  guestName?: string;
  guestPhone?: string;
  templateId?: string;
  phoneModel: string;
  designData: any;
  previewImageBase64?: string;
}

export interface SubmitDesignData {
  guestEmail?: string;
  guestName?: string;
  guestPhone?: string;
}

// Láº¥y danh sÃ¡ch phone templates
export const getPhoneTemplates = async () => {
  const response = await apiClient.get('/designs/templates');
  return response.data;
};

// Táº¡o thiáº¿t káº¿ má»›i
export const createDesign = async (data: CreateDesignData) => {
  const response = await apiClient.post('/designs', data);
  return response.data;
};

// Láº¥y thiáº¿t káº¿ theo ID
export const getDesignById = async (designId: string) => {
  const response = await apiClient.get(`/designs/${designId}`);
  return response.data;
};

// Cáº­p nháº­t thiáº¿t káº¿
export const updateDesign = async (designId: string, data: any) => {
  const response = await apiClient.put(`/designs/${designId}`, data);
  return response.data;
};

// Gá»­i thiáº¿t káº¿ cho admin
export const submitDesign = async (designId: string, data: SubmitDesignData) => {
  const response = await apiClient.post(`/designs/${designId}/submit`, data);
  return response.data;
};

// Láº¥y thiáº¿t káº¿ cá»§a user
export const getUserDesigns = async (userId: string) => {
  const response = await apiClient.get(`/designs/user/${userId}`);
  return response.data;
};

// Admin: Láº¥y táº¥t cáº£ thiáº¿t káº¿
export const getAllDesigns = async (status?: string) => {
  const url = status ? `/designs/admin/all?status=${status}` : '/designs/admin/all';
  const response = await apiClient.get(url);
  return response.data;
};

// Admin: Duyá»‡t thiáº¿t káº¿
export const approveDesign = async (designId: string, adminNotes?: string) => {
  const response = await apiClient.put(`/designs/admin/${designId}/approve`, { adminNotes });
  return response.data;
};

// Admin: Tá»« chá»‘i thiáº¿t káº¿
export const rejectDesign = async (designId: string, adminNotes: string) => {
  const response = await apiClient.put(`/designs/admin/${designId}/reject`, { adminNotes });
  return response.data;
};

// XÃ³a thiáº¿t káº¿
export const deleteDesign = async (designId: string) => {
  const response = await apiClient.delete(`/designs/${designId}`);
  return response.data;
};

// ============ PHONE MODELS (DÃ²ng mÃ¡y Ä‘iá»‡n thoáº¡i) ============

// Láº¥y táº¥t cáº£ dÃ²ng mÃ¡y (grouped by brand)
export const fetchAllPhoneModels = async () => {
  try {
    const response = await apiClient.get('/phone-models');
    return response.data;
  } catch (error) {
    console.error('fetchAllPhoneModels error:', error);
    return { success: false, data: [] };
  }
};

// Láº¥y dÃ²ng mÃ¡y phá»• biáº¿n
export const fetchPopularPhoneModels = async () => {
  try {
    const response = await apiClient.get('/phone-models/popular');
    return response.data;
  } catch (error) {
    console.error('fetchPopularPhoneModels error:', error);
    return { success: false, data: [] };
  }
};

// Láº¥y dÃ²ng mÃ¡y theo hÃ£ng
export const fetchPhoneModelsByBrand = async (brandName: string) => {
  try {
    const response = await apiClient.get(`/phone-models/brand/${encodeURIComponent(brandName)}`);
    return response.data;
  } catch (error) {
    console.error('fetchPhoneModelsByBrand error:', error);
    return { success: false, data: [] };
  }
};

// TÃ¬m kiáº¿m dÃ²ng mÃ¡y
export const searchPhoneModels = async (keyword: string) => {
  try {
    const response = await apiClient.get(`/phone-models/search?keyword=${encodeURIComponent(keyword)}`);
    return response.data;
  } catch (error) {
    console.error('searchPhoneModels error:', error);
    return { success: false, data: [] };
  }
};

// Láº¥y dÃ²ng mÃ¡y tÆ°Æ¡ng thÃ­ch vá»›i sáº£n pháº©m
export const fetchCompatiblePhoneModels = async (productId: number) => {
  try {
    const response = await apiClient.get(`/phone-models/product/${productId}`);
    return response.data;
  } catch (error) {
    console.error('fetchCompatiblePhoneModels error:', error);
    return { success: false, data: [] };
  }
};

// Láº¥y chi tiáº¿t dÃ²ng mÃ¡y
export const fetchPhoneModelById = async (modelId: number) => {
  try {
    const response = await apiClient.get(`/phone-models/${modelId}`);
    return response.data;
  } catch (error) {
    console.error('fetchPhoneModelById error:', error);
    return null;
  }
};

// Admin: Táº¡o dÃ²ng mÃ¡y má»›i
export const createPhoneModel = async (modelData: {
  brand_name: string;
  model_name: string;
  model_code?: string;
  release_year?: number;
  screen_size?: string;
  is_popular?: boolean;
  is_active?: boolean;
}) => {
  const response = await apiClient.post('/phone-models', modelData);
  return response.data;
};

// Admin: Cáº­p nháº­t dÃ²ng mÃ¡y
export const updatePhoneModel = async (modelId: number, modelData: any) => {
  const response = await apiClient.put(`/phone-models/${modelId}`, modelData);
  return response.data;
};

// Admin: XÃ³a dÃ²ng mÃ¡y
export const deletePhoneModel = async (modelId: number) => {
  const response = await apiClient.delete(`/phone-models/${modelId}`);
  return response.data;
};

// Admin: Set dÃ²ng mÃ¡y tÆ°Æ¡ng thÃ­ch cho sáº£n pháº©m
export const setProductCompatibility = async (productId: number, phoneModelIds: number[]) => {
  const response = await apiClient.post(`/phone-models/product/${productId}/compatibility`, {
    phoneModelIds,
  });
  return response.data;
};

import { createBrowserClient } from '@supabase/ssr';
const client = axios.create({ baseURL: process.env.NEXT_PUBLIC_API_URL });

client.interceptors.request.use(async (config) => {
  const supabase = createBrowserClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!
  );
  const { data } = await supabase.auth.getSession();
  const token = data.session?.access_token;
  if (token) config.headers.Authorization = `Bearer ${token}`;
  return config;
});

export default client;




################################################################################
## FILE 87: users.api.ts
## Path: fontend/lib/api/users.api.ts
################################################################################

import { apiClient } from './auth.api';

// ============ USERS ============
export const fetchUsers = async () => {
  const response = await apiClient.get('/users');
  return response.data;
};




################################################################################
## FILE 88: product.api.ts
## Path: fontend/lib/api/product.api.ts
################################################################################

import { apiClient } from './auth.api';

// ============ PRODUCTS ============
export const fetchProducts = async (limit = 10) => {
  const response = await apiClient.get(`/products?limit=${limit}`);
  return response.data;
};

export const fetchProductById = async (id: number) => {
  const response = await apiClient.get(`/products/${id}`);
  return response.data;
};




################################################################################
## FILE 89: order.api.ts
## Path: fontend/lib/api/order.api.ts
################################################################################

import { apiClient } from './auth.api';

// ============ ORDERS ============
export const fetchOrders = async (limit = 20) => {
  const response = await apiClient.get(`/orders?limit=${limit}`);
  return response.data;
};

export const fetchOrderById = async (id: number) => {
  const response = await apiClient.get(`/orders/${id}`);
  return response.data;
};




################################################################################
## FILE 90: index.ts
## Path: fontend/lib/api/index.ts
################################################################################

// Export táº¥t cáº£ API functions
export * from './auth.api';
export * from './product.api';
export * from './category.api';
export * from './order.api';
export * from './users.api';




################################################################################
## FILE 91: category.api.ts
## Path: fontend/lib/api/category.api.ts
################################################################################

import { apiClient } from './auth.api';

// ============ CATEGORIES ============
export const fetchCategories = async () => {
  const response = await apiClient.get('/categories');
  return response.data;
};

export const fetchRootCategories = async () => {
  const response = await apiClient.get('/categories/root');
  return response.data;
};

export const fetchCategoryById = async (id: number) => {
  const response = await apiClient.get(`/categories/${id}`);
  return response.data;
};

export const fetchCategoryBySlug = async (slug: string) => {
  const response = await apiClient.get(`/categories/slug/${slug}`);
  return response.data;
};

export const fetchChildCategories = async (parentId: number) => {
  const response = await apiClient.get(`/categories/${parentId}/children`);
  return response.data;
};




################################################################################
## FILE 92: auth.api.ts
## Path: fontend/lib/api/auth.api.ts
################################################################################

import axios from 'axios';

const API_BASE_URL = 'http://localhost:3001';

export const apiClient = axios.create({
  baseURL: API_BASE_URL,
  headers: {
    'Content-Type': 'application/json',
  },
});

// ============ AUTHENTICATION ============
export const registerCustomer = async (customerData: {
  email: string;
  password: string;
  full_name: string;
  phone_number?: string;
  address?: string;
}) => {
  const response = await apiClient.post('/auth/register', customerData);
  return response.data;
};

export const loginCustomer = async (email: string, password: string) => {
  const response = await apiClient.post('/auth/login', { email, password });
  return response.data;
};




################################################################################
## FILE 93: middleware.ts
## Path: fontend/src/middleware.ts
################################################################################

import { NextResponse, type NextRequest } from 'next/server';
import { createServerClient } from '@supabase/ssr';

// const PROTECTED_ROUTES = ['/account', '/shopping-cart', '/checkout', '/orders'];
const PROTECTED_ROUTES = ['/hihit'];
export async function middleware(request: NextRequest) {
  let response = NextResponse.next({
    request: {
      headers: request.headers,
    },
  });

  const supabase = createServerClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
    {
      cookies: {
        getAll() {
          return request.cookies.getAll();
        },
        setAll(cookiesToSet) {
          cookiesToSet.forEach(({ name, value, options }) => {
            request.cookies.set(name, value);
          });

          response = NextResponse.next({
            request: {
              headers: request.headers,
            },
          });

          cookiesToSet.forEach(({ name, value, options }) => {
            response.cookies.set(name, value, options);
          });
        },
      },
    }
  );

  const {
    data: { session },
  } = await supabase.auth.getSession();

  const pathname = request.nextUrl.pathname;

  const isProtected = PROTECTED_ROUTES.some(route =>
    pathname.startsWith(route)
  );

  if (isProtected && !session) {
    const loginUrl = new URL('/login', request.url);
    loginUrl.searchParams.set('redirect', pathname);
    return NextResponse.redirect(loginUrl);
  }

  return response;
}

export const config = {
  matcher: ['/((?!_next/static|_next/image|favicon.ico|api).*)'],
};




################################################################################
## FILE 94: page.tsx
## Path: fontend/src/app/page.tsx
################################################################################

// File: fontend/src/app/(public)/page.tsx

'use client';

import { useState, useEffect } from 'react';
import { useRouter } from 'next/navigation';
import Link from 'next/link';
import { fetchProducts, fetchCategoriesWithCount, createMomoPayment, fetchAllCollections } from '@/lib/api-client';
import { PRODUCT_CATEGORIES, BANNER_SLIDES } from '@/lib/constants';
import { Product, CartItem, Category } from '@/types';
import { 
  ChevronLeft, ChevronRight, Heart, ShoppingBag, Star, 
  Sparkles, Gift, Truck, Shield, ArrowRight, TrendingUp,
  Smartphone, Watch, Headphones, Zap
} from 'lucide-react';

// Components
import TopBanner from '@/components/layout/TopBanner';
import Header from '@/components/layout/Header';
import Footer from '@/components/layout/Footer';
import CartModal from '@/components/modals/CartModal';
import CurrencyModal from '@/components/modals/CurrencyModal';
import { useWishlist } from '@/app/context/wishlist-context';
import { useCart } from '@/app/context/cart-context';

// Icon map for categories
const CATEGORY_ICON_MAP: Record<string, React.ReactNode> = {
  'á»p lÆ°ng': <Smartphone className="w-8 h-8" />,
  'CÆ°á»ng lá»±c mÃ n hÃ¬nh': <Shield className="w-8 h-8" />,
  'Miáº¿ng dÃ¡n camera': <Watch className="w-8 h-8" />,
  'CÃ¡p sáº¡c': <Zap className="w-8 h-8" />,
  'Tai nghe': <Headphones className="w-8 h-8" />,
  'Phá»¥ kiá»‡n': <Gift className="w-8 h-8" />,
};

// Gradient colors for categories
const CATEGORY_GRADIENTS = [
  'from-pink-500 via-rose-500 to-red-500',
  'from-violet-500 via-purple-500 to-indigo-500',
  'from-cyan-500 via-blue-500 to-indigo-500',
  'from-emerald-500 via-green-500 to-teal-500',
  'from-amber-500 via-orange-500 to-red-500',
  'from-fuchsia-500 via-pink-500 to-rose-500',
  'from-sky-500 via-blue-500 to-violet-500',
];

export default function HomePage() {
  const router = useRouter();
  const { wishedProducts, toggleWishlist } = useWishlist();
  const { refreshCart } = useCart();

  // State
  const [cartItems, setCartItems] = useState<CartItem[]>([]);
  const [isCartOpen, setIsCartOpen] = useState(false);
  const [isCurrencyModalOpen, setIsCurrencyModalOpen] = useState(false);
  const [selectedCurrency, setSelectedCurrency] = useState('VND');
  const [featuredProducts, setFeaturedProducts] = useState<Product[]>([]);
  const [categories, setCategories] = useState<Category[]>([]);
  const [devices, setDevices] = useState<string[]>(['iPhone 17 Pro Max']);
  const [selectedDevice, setSelectedDevice] = useState('iPhone 17 Pro Max');
  const [loading, setLoading] = useState(true);
  const [checkoutLoading, setCheckoutLoading] = useState(false);
  const [currentSlide, setCurrentSlide] = useState(0);
  const [hoveredProduct, setHoveredProduct] = useState<number | null>(null);

  // Hero slides vá»›i thiáº¿t káº¿ má»›i
  const heroSlides = [
    {
      title: 'Bá»™ SÆ°u Táº­p XuÃ¢n 2026',
      subtitle: 'Thiáº¿t Káº¿ Äá»™c ÄÃ¡o, Cháº¥t LÆ°á»£ng Tuyá»‡t Vá»i',
      gradient: 'from-purple-600 via-pink-500 to-rose-500',
      cta: 'KhÃ¡m PhÃ¡ Ngay',
    },
    {
      title: 'Flash Sale - Giáº£m 50%',
      subtitle: 'Chá»‰ Trong HÃ´m Nay - Sá»‘ LÆ°á»£ng CÃ³ Háº¡n',
      gradient: 'from-orange-500 via-red-500 to-pink-500',
      cta: 'Mua Ngay',
    },
    {
      title: 'Phá»¥ Kiá»‡n Cao Cáº¥p',
      subtitle: 'Báº£o Vá»‡ HoÃ n Háº£o Cho Thiáº¿t Bá»‹ Cá»§a Báº¡n',
      gradient: 'from-cyan-500 via-blue-500 to-violet-500',
      cta: 'Xem ThÃªm',
    },
  ];

  // Auto slide
  useEffect(() => {
    const interval = setInterval(() => {
      setCurrentSlide((prev) => (prev + 1) % heroSlides.length);
    }, 5000);
    return () => clearInterval(interval);
  }, []);

  // Fetch categories
  useEffect(() => {
    const loadCategories = async () => {
      try {
        const data = await fetchCategoriesWithCount();
        if (Array.isArray(data) && data.length > 0) {
          const categoryNames = data.map((cat: any) => cat.category_name);
          setDevices(categoryNames);
          setSelectedDevice(categoryNames[0]);
          setCategories(data);
        }
      } catch (error) {
        console.error('Error loading categories:', error);
      }
    };
    loadCategories();
  }, []);

  // Fetch products
  useEffect(() => {
    const loadProducts = async () => {
      try {
        setLoading(true);
        const data = await fetchProducts(8);
        if (Array.isArray(data)) {
          setFeaturedProducts(data);
        }
      } catch (error) {
        console.error('Error loading products:', error);
      } finally {
        setLoading(false);
      }
    };
    loadProducts();
  }, []);

  // Format price
  const formatPrice = (price: number) => {
    return price.toLocaleString('vi-VN') + 'â‚«';
  };

  // Cart handlers
  const addToCart = (product: Product) => {
    setCartItems((prev) => {
      const existing = prev.find((item) => item.id === product.id);
      if (existing) {
        return prev.map((item) =>
          item.id === product.id ? { ...item, quantity: item.quantity + 1 } : item
        );
      }
      return [...prev, { ...product, quantity: 1 }];
    });
  };

  const updateQuantity = (productId: number, newQuantity: number) => {
    if (newQuantity <= 0) {
      setCartItems((prev) => prev.filter((item) => item.id !== productId));
    } else {
      setCartItems((prev) =>
        prev.map((item) =>
          item.id === productId ? { ...item, quantity: newQuantity } : item
        )
      );
    }
  };

  const removeFromCart = (productId: number) => {
    setCartItems((prev) => prev.filter((item) => item.id !== productId));
  };

  // Checkout handler
  const handleCheckout = async () => {
    try {
      setCheckoutLoading(true);
      const cartTotal = cartItems.reduce((t, i) => t + i.price * i.quantity, 0);
      const orderItems = cartItems.map((i) => `${i.name} x${i.quantity}`).join(', ');
      const result = await createMomoPayment({
        amount: Math.round(cartTotal),
        orderInfo: `GoatTech - ${orderItems}`,
      });

      if (result?.data?.payUrl) {
        window.location.href = result.data.payUrl;
      } else {
        alert('KhÃ´ng thá»ƒ táº¡o thanh toÃ¡n. Vui lÃ²ng thá»­ láº¡i!');
      }
    } catch (error: any) {
      console.error('Payment error:', error);
      alert('Lá»—i thanh toÃ¡n: ' + (error.message || 'Vui lÃ²ng thá»­ láº¡i!'));
    } finally {
      setCheckoutLoading(false);
    }
  };

  return (
    <div className="min-h-screen bg-gradient-to-b from-gray-50 to-white">
      {/* Modals */}
      <CartModal
        isOpen={isCartOpen}
        onClose={() => setIsCartOpen(false)}
        cartItems={cartItems}
        onUpdateQuantity={updateQuantity}
        onRemoveItem={removeFromCart}
        onCheckout={handleCheckout}
        checkoutLoading={checkoutLoading}
      />

      {isCurrencyModalOpen && (
        <CurrencyModal
          isOpen={isCurrencyModalOpen}
          onClose={() => setIsCurrencyModalOpen(false)}
          selectedCurrency={selectedCurrency}
          onCurrencyChange={setSelectedCurrency}
        />
      )}

      {/* Layout */}
      <TopBanner />
      
      <Header
        onCartClick={() => setIsCartOpen(true)}
        onWishlistClick={() => router.push('/wishlist')}
        wishlistCount={wishedProducts.size}
        showDeviceSelector
        devices={devices}
        selectedDevice={selectedDevice}
        onDeviceChange={setSelectedDevice}
        showCurrencySelector
        selectedCurrency={selectedCurrency}
        onCurrencyClick={() => setIsCurrencyModalOpen(true)}
      />

      {/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          HERO SECTION - Modern Carousel
      â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */}
      <section className="relative h-[500px] md:h-[600px] overflow-hidden">
        {heroSlides.map((slide, index) => (
          <div
            key={index}
            className={`absolute inset-0 transition-all duration-700 ease-in-out ${
              index === currentSlide 
                ? 'opacity-100 scale-100' 
                : 'opacity-0 scale-105'
            }`}
          >
            <div className={`absolute inset-0 bg-gradient-to-r ${slide.gradient}`} />
            <div className="absolute inset-0 bg-[url('/pattern.svg')] opacity-10" />
            
            <div className="relative h-full max-w-7xl mx-auto px-4 flex items-center justify-center">
              <div className="text-center text-white">
                <h1 className="text-4xl md:text-6xl lg:text-7xl font-black mb-6 drop-shadow-lg animate-fade-in">
                  {slide.title}
                </h1>
                <p className="text-xl md:text-2xl mb-8 opacity-90 max-w-2xl mx-auto">
                  {slide.subtitle}
                </p>
                <button
                  onClick={() => router.push('/shop')}
                  className="group bg-white text-gray-900 px-8 py-4 rounded-full font-bold text-lg hover:bg-opacity-90 transition-all duration-300 shadow-xl hover:shadow-2xl hover:scale-105"
                >
                  {slide.cta}
                  <ArrowRight className="inline-block ml-2 w-5 h-5 group-hover:translate-x-1 transition-transform" />
                </button>
              </div>
            </div>
          </div>
        ))}

        {/* Navigation */}
        <button
          onClick={() => setCurrentSlide((prev) => (prev - 1 + heroSlides.length) % heroSlides.length)}
          className="absolute left-4 top-1/2 -translate-y-1/2 bg-white/20 hover:bg-white/40 backdrop-blur-sm p-3 rounded-full transition-all"
        >
          <ChevronLeft className="w-6 h-6 text-white" />
        </button>
        <button
          onClick={() => setCurrentSlide((prev) => (prev + 1) % heroSlides.length)}
          className="absolute right-4 top-1/2 -translate-y-1/2 bg-white/20 hover:bg-white/40 backdrop-blur-sm p-3 rounded-full transition-all"
        >
          <ChevronRight className="w-6 h-6 text-white" />
        </button>

        {/* Dots */}
        <div className="absolute bottom-6 left-1/2 -translate-x-1/2 flex gap-2">
          {heroSlides.map((_, index) => (
            <button
              key={index}
              onClick={() => setCurrentSlide(index)}
              className={`h-2 rounded-full transition-all duration-300 ${
                index === currentSlide 
                  ? 'bg-white w-8' 
                  : 'bg-white/50 w-2 hover:bg-white/70'
              }`}
            />
          ))}
        </div>
      </section>

      {/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          FEATURES BAR
      â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */}
      <section className="bg-white border-b">
        <div className="max-w-7xl mx-auto px-4 py-6">
          <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
            {[
              { icon: <Truck className="w-6 h-6" />, title: 'Miá»…n phÃ­ ship', desc: 'ÄÆ¡n tá»« 100K' },
              { icon: <Shield className="w-6 h-6" />, title: 'Báº£o hÃ nh', desc: '12 thÃ¡ng' },
              { icon: <Gift className="w-6 h-6" />, title: 'QuÃ  táº·ng', desc: 'Mua 4 táº·ng 2' },
              { icon: <Sparkles className="w-6 h-6" />, title: 'ChÃ­nh hÃ£ng', desc: '100% authentic' },
            ].map((feature, index) => (
              <div key={index} className="flex items-center gap-3 justify-center p-3">
                <div className="text-pink-600">{feature.icon}</div>
                <div>
                  <p className="font-semibold text-gray-900 text-sm">{feature.title}</p>
                  <p className="text-gray-500 text-xs">{feature.desc}</p>
                </div>
              </div>
            ))}
          </div>
        </div>
      </section>

      {/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          CATEGORIES SECTION
      â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */}
      <section className="py-20 px-4 bg-gradient-to-b from-gray-50 via-white to-gray-50 overflow-hidden">
        <div className="max-w-7xl mx-auto">
          {/* Header vá»›i animation */}
          <div className="text-center mb-16 relative">
            <div className="absolute inset-0 flex items-center justify-center -z-10">
              <div className="w-72 h-72 bg-pink-200/30 rounded-full blur-3xl animate-pulse" />
            </div>
            <span className="inline-block px-4 py-2 bg-gradient-to-r from-pink-500 to-purple-500 text-white text-sm font-semibold rounded-full mb-4 shadow-lg">
               KhÃ¡m PhÃ¡ Ngay
            </span>
            <h2 className="text-4xl md:text-5xl font-black text-transparent bg-clip-text bg-gradient-to-r from-gray-900 via-pink-600 to-purple-600 mb-4">
              Danh Má»¥c Sáº£n Pháº©m
            </h2>
            <p className="text-gray-600 max-w-2xl mx-auto text-lg">
              KhÃ¡m phÃ¡ Ä‘a dáº¡ng phá»¥ kiá»‡n Ä‘iá»‡n thoáº¡i cháº¥t lÆ°á»£ng cao vá»›i thiáº¿t káº¿ Ä‘á»™c Ä‘Ã¡o
            </p>
          </div>

          {/* Categories Grid - Thiáº¿t káº¿ má»›i */}
          <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6 md:gap-8">
            {categories.slice(0, 8).map((cat: any, index) => {
              const icons = Object.values(CATEGORY_ICON_MAP);
              const gradients = [
                'from-rose-400 via-pink-500 to-pink-600',
                'from-violet-400 via-purple-500 to-purple-600',
                'from-blue-400 via-cyan-500 to-cyan-600',
                'from-emerald-400 via-green-500 to-green-600',
                'from-amber-400 via-orange-500 to-orange-600',
                'from-fuchsia-400 via-pink-500 to-rose-600',
                'from-indigo-400 via-blue-500 to-blue-600',
                'from-teal-400 via-cyan-500 to-teal-600',
              ];
              
              return (
                <Link
                  key={cat.category_id}
                  href={`/shop?category=${encodeURIComponent(cat.category_name)}`}
                  className="group perspective-1000"
                >
                  <div className={`
                    relative h-52 rounded-3xl overflow-hidden
                    bg-gradient-to-br ${gradients[index % gradients.length]}
                    transform transition-all duration-500 ease-out
                    group-hover:scale-[1.02] group-hover:-rotate-1
                    group-hover:shadow-[0_20px_50px_rgba(0,0,0,0.3)]
                    shadow-xl
                  `}>
                    {/* Animated background patterns */}
                    <div className="absolute inset-0 opacity-30">
                      <div className="absolute top-0 right-0 w-40 h-40 bg-white/20 rounded-full -translate-y-1/2 translate-x-1/2 group-hover:scale-150 transition-transform duration-700" />
                      <div className="absolute bottom-0 left-0 w-32 h-32 bg-white/20 rounded-full translate-y-1/2 -translate-x-1/2 group-hover:scale-150 transition-transform duration-700" />
                      <div className="absolute top-1/2 left-1/2 w-24 h-24 bg-white/10 rounded-full -translate-x-1/2 -translate-y-1/2 group-hover:rotate-180 transition-transform duration-1000" />
                    </div>
                    
                    {/* Shimmer effect on hover */}
                    <div className="absolute inset-0 bg-gradient-to-r from-transparent via-white/20 to-transparent -translate-x-full group-hover:translate-x-full transition-transform duration-1000" />
                    
                    {/* Content */}
                    <div className="relative z-10 h-full flex flex-col items-center justify-center p-6 text-white">
                      {/* Icon vá»›i animation */}
                      <div className="text-5xl mb-4 transform group-hover:scale-125 group-hover:-rotate-12 transition-all duration-300 drop-shadow-lg">
                        {icons[index % icons.length]}
                      </div>
                      
                      {/* Category name */}
                      <h3 className="font-bold text-xl mb-2 text-center line-clamp-2 drop-shadow-md group-hover:scale-105 transition-transform">
                        {cat.category_name}
                      </h3>
                      
                      {/* Product count vá»›i pill design */}
                      <div className="flex items-center gap-2 bg-white/25 backdrop-blur-sm px-4 py-1.5 rounded-full text-sm font-medium shadow-inner">
                        <span className="w-2 h-2 bg-white rounded-full animate-pulse" />
                        {cat.product_count || 0} sáº£n pháº©m
                      </div>
                      
                      {/* Arrow indicator */}
                      <div className="absolute bottom-4 right-4 w-10 h-10 bg-white/20 rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 transform translate-x-4 group-hover:translate-x-0 transition-all duration-300">
                        <ArrowRight className="w-5 h-5 text-white" />
                      </div>
                    </div>
                  </div>
                </Link>
              );
            })}
          </div>

          {/* CTA Button */}
          <div className="text-center mt-12">
            <Link
              href="/shop"
              className="inline-flex items-center gap-3 bg-gradient-to-r from-pink-500 to-purple-600 text-white px-8 py-4 rounded-full font-bold text-lg hover:from-pink-600 hover:to-purple-700 transition-all duration-300 shadow-lg hover:shadow-xl hover:scale-105 transform"
            >
              <Sparkles className="w-5 h-5" />
              Xem Táº¥t Cáº£ Danh Má»¥c
              <ArrowRight className="w-5 h-5" />
            </Link>
          </div>
        </div>
      </section>

      {/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          DESIGN YOUR OWN CASE - CTA BANNER
      â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */}
      <section className="py-12 px-4">
        <div className="max-w-7xl mx-auto">
          <div className="relative overflow-hidden rounded-3xl bg-gradient-to-r from-purple-600 via-pink-600 to-rose-600 p-8 md:p-12">
            {/* Decorative elements */}
            <div className="absolute top-0 right-0 w-64 h-64 bg-white/10 rounded-full -translate-y-1/2 translate-x-1/2" />
            <div className="absolute bottom-0 left-0 w-48 h-48 bg-white/10 rounded-full translate-y-1/2 -translate-x-1/2" />
            <div className="absolute top-1/2 left-1/2 w-32 h-32 bg-white/5 rounded-full -translate-x-1/2 -translate-y-1/2" />
            
            <div className="relative z-10 flex flex-col md:flex-row items-center justify-between gap-8">
              <div className="text-center md:text-left">
                <div className="inline-flex items-center gap-2 bg-white/20 text-white px-4 py-2 rounded-full text-sm font-medium mb-4">
                  <Sparkles className="w-4 h-4" />
                  <span>TÃ­nh nÄƒng má»›i</span>
                </div>
                <h2 className="text-3xl md:text-4xl font-bold text-white mb-4">
                  ðŸŽ¨ Tá»± Thiáº¿t Káº¿ á»p LÆ°ng Cá»§a Báº¡n
                </h2>
                <p className="text-white/90 text-lg max-w-xl">
                  Upload áº£nh yÃªu thÃ­ch, thÃªm chá»¯ vÃ  táº¡o ra chiáº¿c á»‘p Ä‘iá»‡n thoáº¡i Ä‘á»™c nháº¥t vÃ´ nhá»‹. 
                  ChÃºng tÃ´i sáº½ in vÃ  giao Ä‘áº¿n táº­n tay báº¡n!
                </p>
                <ul className="mt-4 space-y-2 text-white/80">
                  <li className="flex items-center gap-2">
                    <span className="text-green-300">âœ“</span> Thiáº¿t káº¿ theo Ã½ thÃ­ch
                  </li>
                  <li className="flex items-center gap-2">
                    <span className="text-green-300">âœ“</span> In áº¥n cháº¥t lÆ°á»£ng cao 300dpi
                  </li>
                  <li className="flex items-center gap-2">
                    <span className="text-green-300">âœ“</span> Nhiá»u máº«u Ä‘iá»‡n thoáº¡i
                  </li>
                </ul>
              </div>
              
              <div className="flex flex-col items-center">
                <div className="text-8xl mb-4"></div>
                <Link
                  href="/design"
                  className="bg-white text-pink-600 px-8 py-4 rounded-full font-bold text-lg hover:bg-gray-100 transition-all hover:shadow-xl transform hover:scale-105"
                >
                  Báº¯t Äáº§u Thiáº¿t Káº¿ Ngay â†’
                </Link>
              </div>
            </div>
          </div>
        </div>
      </section>

      {/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          FEATURED PRODUCTS SECTION
      â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */}
      <section className="py-16 px-4 bg-gradient-to-b from-gray-50 to-white">
        <div className="max-w-7xl mx-auto">
          <div className="flex items-center justify-between mb-12">
            <div>
              <h2 className="text-3xl md:text-4xl font-bold text-gray-900 mb-2">
                Sáº£n Pháº©m Ná»•i Báº­t
              </h2>
              <p className="text-gray-600">ÄÆ°á»£c yÃªu thÃ­ch nháº¥t tuáº§n nÃ y</p>
            </div>
            <Link
              href="/shop"
              className="hidden md:flex items-center gap-2 bg-pink-600 text-white px-6 py-3 rounded-full font-semibold hover:bg-pink-700 transition-all hover:shadow-lg"
            >
              Xem táº¥t cáº£
              <ArrowRight className="w-4 h-4" />
            </Link>
          </div>

          {loading ? (
            <div className="grid grid-cols-2 md:grid-cols-4 gap-4 md:gap-6">
              {[...Array(4)].map((_, i) => (
                <div key={i} className="bg-white rounded-2xl shadow-sm overflow-hidden animate-pulse">
                  <div className="h-48 md:h-64 bg-gray-200" />
                  <div className="p-4 space-y-3">
                    <div className="h-4 bg-gray-200 rounded w-3/4" />
                    <div className="h-4 bg-gray-200 rounded w-1/2" />
                    <div className="h-10 bg-gray-200 rounded" />
                  </div>
                </div>
              ))}
            </div>
          ) : (
            <div className="grid grid-cols-2 md:grid-cols-4 gap-4 md:gap-6">
              {featuredProducts.map((product: any) => {
                const productId = product.product_id || product.id;
                const isWished = wishedProducts.has(productId);
                const primaryImage = product.product_images?.find((img: any) => img.is_primary)?.image_url 
                  || product.product_images?.[0]?.image_url
                  || product.image_url;
                const hasDiscount = product.sale_price && product.sale_price < product.price;
                const discountPercent = hasDiscount 
                  ? Math.round((1 - product.sale_price / product.price) * 100)
                  : 0;

                return (
                  <div
                    key={productId}
                    className="group bg-white rounded-2xl shadow-sm hover:shadow-xl transition-all duration-300 overflow-hidden"
                    onMouseEnter={() => setHoveredProduct(productId)}
                    onMouseLeave={() => setHoveredProduct(null)}
                  >
                    {/* Image */}
                    <div className="relative h-48 md:h-64 bg-gray-100 overflow-hidden">
                      {primaryImage ? (
                        <img
                          src={primaryImage}
                          alt={product.product_name}
                          className="w-full h-full object-cover group-hover:scale-110 transition-transform duration-500"
                        />
                      ) : (
                        <div className="w-full h-full flex items-center justify-center text-gray-400">
                          <Smartphone className="w-16 h-16" />
                        </div>
                      )}

                      {/* Badges */}
                      {hasDiscount && (
                        <div className="absolute top-3 left-3 bg-red-500 text-white px-2 py-1 rounded-lg text-xs font-bold">
                          -{discountPercent}%
                        </div>
                      )}

                      {/* Wishlist button */}
                      <button
                        onClick={(e) => {
                          e.preventDefault();
                          toggleWishlist(productId);
                        }}
                        className={`absolute top-3 right-3 p-2 rounded-full transition-all duration-300 ${
                          isWished 
                            ? 'bg-pink-500 text-white' 
                            : 'bg-white/80 text-gray-600 hover:bg-pink-500 hover:text-white'
                        }`}
                      >
                        <Heart className={`w-5 h-5 ${isWished ? 'fill-current' : ''}`} />
                      </button>

                      {/* Quick actions */}
                      <div className={`absolute bottom-0 left-0 right-0 p-4 bg-gradient-to-t from-black/60 to-transparent transform transition-all duration-300 ${
                        hoveredProduct === productId ? 'translate-y-0 opacity-100' : 'translate-y-full opacity-0'
                      }`}>
                        <Link
                          href={`/product/${productId}`}
                          className="block w-full bg-white text-gray-900 text-center py-2 rounded-lg font-semibold hover:bg-pink-600 hover:text-white transition"
                        >
                          Xem chi tiáº¿t
                        </Link>
                      </div>
                    </div>

                    {/* Info */}
                    <div className="p-4">
                      <Link href={`/product/${productId}`}>
                        <h3 className="font-semibold text-gray-900 mb-2 line-clamp-2 hover:text-pink-600 transition">
                          {product.product_name}
                        </h3>
                      </Link>

                      {/* Rating */}
                      <div className="flex items-center gap-1 mb-2">
                        {[...Array(5)].map((_, i) => (
                          <Star
                            key={i}
                            className={`w-4 h-4 ${i < 4 ? 'text-yellow-400 fill-yellow-400' : 'text-gray-300'}`}
                          />
                        ))}
                        <span className="text-xs text-gray-500 ml-1">(128)</span>
                      </div>

                      {/* Price */}
                      <div className="flex items-center gap-2">
                        <span className="text-lg font-bold text-pink-600">
                          {formatPrice(product.sale_price || product.price)}
                        </span>
                        {hasDiscount && (
                          <span className="text-sm text-gray-400 line-through">
                            {formatPrice(product.price)}
                          </span>
                        )}
                      </div>
                    </div>
                  </div>
                );
              })}
            </div>
          )}

          {/* Mobile CTA */}
          <div className="text-center mt-8 md:hidden">
            <Link
              href="/shop"
              className="inline-flex items-center gap-2 bg-pink-600 text-white px-6 py-3 rounded-full font-semibold"
            >
              Xem táº¥t cáº£ sáº£n pháº©m
              <ArrowRight className="w-4 h-4" />
            </Link>
          </div>
        </div>
      </section>

      {/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          TRENDING SECTION
      â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */}
      <section className="py-16 px-4">
        <div className="max-w-7xl mx-auto">
          <div className="bg-gradient-to-r from-purple-600 via-pink-600 to-rose-600 rounded-3xl p-8 md:p-12 text-white relative overflow-hidden">
            {/* Decorative */}
            <div className="absolute top-0 right-0 w-64 h-64 bg-white/10 rounded-full -translate-y-1/2 translate-x-1/2" />
            <div className="absolute bottom-0 left-0 w-48 h-48 bg-white/10 rounded-full translate-y-1/2 -translate-x-1/2" />

            <div className="relative z-10 flex flex-col md:flex-row items-center justify-between gap-6">
              <div className="text-center md:text-left">
                <div className="flex items-center gap-2 justify-center md:justify-start mb-4">
                  <TrendingUp className="w-6 h-6" />
                  <span className="text-sm font-semibold uppercase tracking-wider">Hot Trend</span>
                </div>
                <h2 className="text-3xl md:text-4xl font-bold mb-4">
                  Bá»™ SÆ°u Táº­p MÃ¹a Lá»… Há»™i
                </h2>
                <p className="text-white/80 max-w-md">
                  KhÃ¡m phÃ¡ nhá»¯ng thiáº¿t káº¿ Ä‘á»™c Ä‘Ã¡o cho mÃ¹a Noel, Valentine vÃ  Táº¿t NguyÃªn ÄÃ¡n
                </p>
              </div>
              <Link
                href="/collections"
                className="flex items-center gap-2 bg-white text-purple-600 px-8 py-4 rounded-full font-bold hover:bg-opacity-90 transition-all shadow-xl hover:shadow-2xl"
              >
                KhÃ¡m phÃ¡ ngay
                <ArrowRight className="w-5 h-5" />
              </Link>
            </div>
          </div>
        </div>
      </section>

      {/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          NEWSLETTER SECTION
      â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */}
      <section className="py-16 px-4 bg-gray-900 text-white">
        <div className="max-w-4xl mx-auto text-center">
          <Sparkles className="w-12 h-12 mx-auto mb-6 text-pink-500" />
          <h2 className="text-3xl md:text-4xl font-bold mb-4">
            ÄÄƒng KÃ½ Nháº­n Æ¯u ÄÃ£i
          </h2>
          <p className="text-gray-400 mb-8 max-w-xl mx-auto">
            Nháº­n ngay mÃ£ giáº£m giÃ¡ 10% cho Ä‘Æ¡n hÃ ng Ä‘áº§u tiÃªn vÃ  cáº­p nháº­t nhá»¯ng Æ°u Ä‘Ã£i má»›i nháº¥t
          </p>
          <form className="flex flex-col sm:flex-row gap-4 max-w-md mx-auto">
            <input
              type="email"
              placeholder="Email cá»§a báº¡n..."
              className="flex-1 px-6 py-4 rounded-full bg-white/10 border border-white/20 text-white placeholder-gray-400 focus:outline-none focus:border-pink-500 transition"
            />
            <button
              type="submit"
              className="px-8 py-4 bg-gradient-to-r from-pink-500 to-rose-500 rounded-full font-bold hover:opacity-90 transition"
            >
              ÄÄƒng kÃ½
            </button>
          </form>
        </div>
      </section>

      {/* Footer */}
      <Footer />
    </div>
  );
}



################################################################################
## FILE 95: layout.tsx
## Path: fontend/src/app/layout.tsx
################################################################################

import type { Metadata } from "next";
import { Geist, Geist_Mono } from "next/font/google";
import "./globals.css";
import { CartProvider } from '@/app/context/cart-context';
import { WishlistProvider } from '@/app/context/wishlist-context';
// import { AuthProvider } from '@/app/context/auth-context';
import { AuthProvider } from '@/contexts/AuthContext';
// import Navbar from '@/components/Navbar'; 
const geistSans = Geist({
  variable: "--font-geist-sans",
  subsets: ["latin"],
});

const geistMono = Geist_Mono({
  variable: "--font-geist-mono",
  subsets: ["latin"],
});

export const metadata: Metadata = {
  title: "GoatTech",
  description: "GoatTech Shop",
};

export default function RootLayout({ children,}: Readonly<{ children: React.ReactNode; }>) {
  return (
    <html lang="vi">
      <body
        className={`${geistSans.variable} ${geistMono.variable} antialiased`}
      >
        <AuthProvider>
          <CartProvider>
            <WishlistProvider>
              {children}
            </WishlistProvider>
          </CartProvider>
        </AuthProvider>
      </body>
    </html>
  );
}




################################################################################
## FILE 96: globals.css
## Path: fontend/src/app/globals.css
################################################################################

/* @import "tailwindcss"; */
@tailwind base;
@tailwind components;
@tailwind utilities;


:root {
  --background: #ffffff;
  --foreground: #171717;
}

@theme inline {
  --color-background: var(--background);
  --color-foreground: var(--foreground);
  --font-sans: var(--font-geist-sans);
  --font-mono: var(--font-geist-mono);
}

@media (prefers-color-scheme: dark) {
  :root {
    --background: #0a0a0a;
    --foreground: #ededed;
  }
}

body {
  background: var(--background);
  color: var(--foreground);
  font-family: Arial, Helvetica, sans-serif;
}

/* Custom Animations */
@keyframes fadeIn {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

@keyframes slideUp {
  from {
    opacity: 0;
    transform: translateY(30px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

@keyframes scaleIn {
  from {
    opacity: 0;
    transform: scale(0.95);
  }
  to {
    opacity: 1;
    transform: scale(1);
  }
}

@keyframes shimmer {
  0% {
    background-position: -200% 0;
  }
  100% {
    background-position: 200% 0;
  }
}

.animate-fade-in {
  animation: fadeIn 0.6s ease-out forwards;
}

.animate-slide-up {
  animation: slideUp 0.5s ease-out forwards;
}

.animate-scale-in {
  animation: scaleIn 0.3s ease-out forwards;
}

.animate-shimmer {
  background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
  background-size: 200% 100%;
  animation: shimmer 1.5s infinite;
}

/* Custom scrollbar */
::-webkit-scrollbar {
  width: 8px;
  height: 8px;
}

::-webkit-scrollbar-track {
  background: #f1f1f1;
  border-radius: 4px;
}

::-webkit-scrollbar-thumb {
  background: #c1c1c1;
  border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
  background: #a1a1a1;
}

/* Hide scrollbar for horizontal scroll sections */
.hide-scrollbar::-webkit-scrollbar {
  display: none;
}

.hide-scrollbar {
  -ms-overflow-style: none;
  scrollbar-width: none;
}

/* Line clamp utility */
.line-clamp-2 {
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow: hidden;
}

/* Glass effect */
.glass {
  background: rgba(255, 255, 255, 0.1);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
}




################################################################################
## FILE 97: layout.tsx
## Path: fontend/src/app/(public)/layout.tsx
################################################################################

import Header from '@/components/layout/Header';
import Footer from '@/components/layout/Footer';

export default function PublicLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  return (
    <>  
        <Header />
            {children}
        <Footer />
    </>
  );
}




################################################################################
## FILE 98: page.tsx
## Path: fontend/src/app/(public)/about/page.tsx
################################################################################

'use client';

import React, { useState, useEffect } from 'react';
import { ShoppingCart, User, Heart, Search, Menu, Award, Users, Globe, Truck, Shield, Star } from 'lucide-react';
import Link from 'next/link';
import { fetchCategories } from '@/lib/api-client';

const AboutPage: React.FC = () => {
  const [cartCount, setCartCount] = useState(0);
  const [wishlistCount, setWishlistCount] = useState(0);
  const [selectedDevice, setSelectedDevice] = useState('iPhone 17 Pro Max');
  const [isCurrencyModalOpen, setIsCurrencyModalOpen] = useState(false);
  const [selectedCurrency, setSelectedCurrency] = useState('USD');
  const [devices, setDevices] = useState<string[]>(['iPhone 17 Pro Max']);

  useEffect(() => {
    const loadCategories = async () => {
      try {
        const data = await fetchCategories();
        if (Array.isArray(data) && data.length > 0) {
          const categoryNames = data.map((cat: any) => cat.category_name);
          setDevices(categoryNames);
          setSelectedDevice(categoryNames[0]);
        }
      } catch (error) {
        console.error('Error loading categories:', error);
      }
    };
    loadCategories();
  }, []);

  const handleCurrencyChange = (currency: string) => {
    setSelectedCurrency(currency);
    setIsCurrencyModalOpen(false);
  };

  const stats = [
    { number: '100K+', label: 'KhÃ¡ch HÃ ng HÃ i LÃ²ng', icon: Users },
    { number: '100K+', label: 'Sáº£n Pháº©m ÄÃ£ BÃ¡n', icon: Award },
    { number: '50+', label: 'Quá»‘c Gia', icon: Globe },
    { number: '4.5/5', label: 'ÄÃ¡nh GiÃ¡ Trung BÃ¬nh', icon: Star }
  ];

  const values = [
    {
      icon: Award,
      title: 'Cháº¥t LÆ°á»£ng Cao Cáº¥p',
      description: 'Sá»­ dá»¥ng váº­t liá»‡u cao cáº¥p nháº¥t, Ä‘áº£m báº£o Ä‘á»™ bá»n vÃ  báº£o vá»‡ tá»‘i Æ°u cho thiáº¿t bá»‹ cá»§a báº¡n.'
    },
    {
      icon: Shield,
      title: 'Báº£o Vá»‡ Tuyá»‡t Äá»‘i',
      description: 'Thiáº¿t káº¿ chá»‘ng sá»‘c, chá»‘ng tráº§y xÆ°á»›c, báº£o vá»‡ Ä‘iá»‡n thoáº¡i trong má»i tÃ¬nh huá»‘ng.'
    },
    {
      icon: Truck,
      title: 'Giao HÃ ng Nhanh',
      description: 'Giao hÃ ng toÃ n quá»‘c trong 2-5 ngÃ y, miá»…n phÃ­ cho Ä‘Æ¡n hÃ ng trÃªn 100K.'
    },
    {
      icon: Star,
      title: 'Thiáº¿t Káº¿ Äá»™c ÄÃ¡o',
      description: 'HÃ ng trÄƒm máº«u thiáº¿t káº¿ Ä‘á»™c quyá»n, tá»« tá»‘i giáº£n Ä‘áº¿n nghá»‡ thuáº­t Ä‘áº§y mÃ u sáº¯c.'
    }
  ];

  const team = [
    {
      name: 'Pháº¡m CÃ´ng ÄoÃ n',
      role: 'GiÃ¡m Äá»‘c Äiá»u HÃ nh',
      image: 'Ä‘oÃ n.jpg'
    },
    {
      name: 'VÃµ Tráº§n Minh Báº£o',
      role: 'TrÆ°á»Ÿng PhÃ²ng Thiáº¿t Káº¿',
      image: 'báº£o.jpg'
    },
    {
      name: 'Triá»‡u QuÃ¢n Sá»±',
      role: 'TrÆ°á»Ÿng PhÃ²ng Marketing',
      image: 'lÄ©nh.jpg'
    },
    {
      name: 'ÄoÃ n VÄƒn SÃ¡ng',
      role: 'TrÆ°á»Ÿng PhÃ²ng Kinh Doanh',
      image: 'nam.png'
    }
  ];

  return (
    <div className="min-h-screen bg-gray-50">
      {/* Currency Modal */}
      {isCurrencyModalOpen && (
        <div className="fixed inset-0 z-50 flex items-center justify-center" onClick={() => setIsCurrencyModalOpen(false)}>
          <div className="bg-white rounded-xl p-6 max-w-md w-full mx-4 shadow-2xl" onClick={(e) => e.stopPropagation()}>
            <div className="flex items-center justify-between mb-6">
              <h2 className="text-xl font-bold">CHá»ŒN LOáº I TIá»€N Tá»†</h2>
              <button onClick={() => setIsCurrencyModalOpen(false)} className="text-gray-500 hover:text-gray-700">
                <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                </svg>
              </button>
            </div>
            
            <div className="mb-6">
              <label className="block text-sm font-semibold mb-2 text-gray-700">QUá»C GIA/KHU Vá»°C:</label>
              <select 
                className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-600"
                value={selectedCurrency}
                onChange={(e) => handleCurrencyChange(e.target.value)}
              >
                <option value="USD">United States (USD $)</option>
                <option value="VND">Viá»‡t Nam (VND â‚«)</option>
              </select>
            </div>

            <button 
              onClick={() => setIsCurrencyModalOpen(false)}
              className="w-full bg-black text-white py-3 rounded-lg font-semibold hover:bg-gray-800 transition"
            >
              ÃP Dá»¤NG
            </button>
          </div>
        </div>
      )}

      {/* Hero Section */}
      <div className="bg-gradient-to-r from-purple-600 to-pink-600 text-white py-20">
        <div className="max-w-7xl mx-auto px-4 text-center">
          <h1 className="text-5xl md:text-6xl font-bold mb-6">Vá» GoatTech</h1>
          <p className="text-xl md:text-2xl max-w-3xl mx-auto">
            ChÃºng tÃ´i lÃ  thÆ°Æ¡ng hiá»‡u á»‘p Ä‘iá»‡n thoáº¡i sá»‘ 1 Viá»‡t Nam, mang Ä‘áº¿n sá»± báº£o vá»‡ hoÃ n háº£o vá»›i phong cÃ¡ch Ä‘á»™c Ä‘Ã¡o
          </p>
        </div>
      </div>

      {/* Stats Section */}
      <div className="max-w-7xl mx-auto px-4 py-16">
        <div className="grid grid-cols-2 lg:grid-cols-4 gap-8">
          {stats.map((stat, index) => (
            <div key={index} className="bg-white p-8 rounded-xl shadow-sm text-center">
              <div className="bg-pink-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
                <stat.icon className="w-8 h-8 text-pink-600" />
              </div>
              <h3 className="text-3xl font-bold text-gray-900 mb-2">{stat.number}</h3>
              <p className="text-gray-600">{stat.label}</p>
            </div>
          ))}
        </div>
      </div>

      {/* Story Section */}
      <div className="bg-white py-16">
        <div className="max-w-7xl mx-auto px-4">
          <div className="grid grid-cols-1 lg:grid-cols-2 gap-12 items-center">
            <div>
              <h2 className="text-4xl font-bold mb-6">CÃ¢u Chuyá»‡n Cá»§a ChÃºng TÃ´i</h2>
              <p className="text-gray-600 mb-4 leading-relaxed">
                GoatTech Ä‘Æ°á»£c thÃ nh láº­p vÃ o nÄƒm 2018 vá»›i sá»© má»‡nh mang Ä‘áº¿n nhá»¯ng sáº£n pháº©m báº£o vá»‡ Ä‘iá»‡n thoáº¡i cháº¥t lÆ°á»£ng cao vÃ  thiáº¿t káº¿ Ä‘á»™c Ä‘Ã¡o cho ngÆ°á»i dÃ¹ng Viá»‡t Nam.
              </p>
              <p className="text-gray-600 mb-4 leading-relaxed">
                Báº¯t Ä‘áº§u tá»« má»™t cá»­a hÃ ng nhá» á»Ÿ TP.HCM, chÃºng tÃ´i Ä‘Ã£ phÃ¡t triá»ƒn thÃ nh thÆ°Æ¡ng hiá»‡u á»‘p Ä‘iá»‡n thoáº¡i Ä‘Æ°á»£c yÃªu thÃ­ch nháº¥t vá»›i hÆ¡n 500,000 khÃ¡ch hÃ ng trÃªn toÃ n quá»‘c.
              </p>
              <p className="text-gray-600 mb-4 leading-relaxed">
                Má»—i sáº£n pháº©m cá»§a GoatTech Ä‘á»u Ä‘Æ°á»£c thiáº¿t káº¿ tá»‰ má»‰, tá»« viá»‡c chá»n váº­t liá»‡u cao cáº¥p Ä‘áº¿n quy trÃ¬nh sáº£n xuáº¥t nghiÃªm ngáº·t, Ä‘áº£m báº£o mang Ä‘áº¿n tráº£i nghiá»‡m tá»‘t nháº¥t cho khÃ¡ch hÃ ng.
              </p>
              <Link href="/shop" className="inline-block bg-gradient-to-r from-purple-600 to-pink-600 text-white px-8 py-3 rounded-lg font-semibold hover:from-purple-700 hover:to-pink-700 transition">
                KhÃ¡m PhÃ¡ Sáº£n Pháº©m
              </Link>
            </div>
            <div className="grid grid-cols-2 gap-4">
              <img
                src="about1.jpg"
                alt="GoatTech Store"
                className="rounded-xl shadow-lg w-full h-48 object-cover"
              />
              <img
                src="about2.jpg"
                alt="Phone Cases"
                className="rounded-xl shadow-lg w-full h-48 object-cover mt-8"
              />
              <img
                src="about3.jpg"
                alt="Design Process"
                className="rounded-xl shadow-lg w-full h-48 object-cover"
              />
              <img
                src="about4.jpg"
                alt="Quality Check"
                className="rounded-xl shadow-lg w-full h-48 object-cover mt-8"
              />
            </div>
          </div>
        </div>
      </div>

      {/* Values Section */}
      <div className="max-w-7xl mx-auto px-4 py-16">
        <h2 className="text-4xl font-bold text-center mb-12">GiÃ¡ Trá»‹ Cá»‘t LÃµi</h2>
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-8">
          {values.map((value, index) => (
            <div key={index} className="bg-white p-6 rounded-xl shadow-sm hover:shadow-lg transition">
              <div className="bg-gradient-to-br from-purple-100 to-pink-100 w-16 h-16 rounded-full flex items-center justify-center mb-4">
                <value.icon className="w-8 h-8 text-purple-600" />
              </div>
              <h3 className="text-xl font-semibold mb-3">{value.title}</h3>
              <p className="text-gray-600">{value.description}</p>
            </div>
          ))}
        </div>
      </div>

      {/* Team Section */}
      <div className="bg-gradient-to-br from-purple-50 to-pink-50 py-16">
        <div className="max-w-7xl mx-auto px-4">
          <h2 className="text-4xl font-bold text-center mb-4">Äá»™i NgÅ© Cá»§a ChÃºng TÃ´i</h2>
          <p className="text-center text-gray-600 mb-12 max-w-2xl mx-auto">
            Äá»™i ngÅ© chuyÃªn nghiá»‡p, táº­n tÃ¢m vÃ  sÃ¡ng táº¡o luÃ´n ná»— lá»±c Ä‘á»ƒ mang Ä‘áº¿n nhá»¯ng sáº£n pháº©m tá»‘t nháº¥t
          </p>
          
          <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-8">
            {team.map((member, index) => (
              <div key={index} className="bg-white rounded-xl overflow-hidden shadow-sm hover:shadow-lg transition">
                <img
                  src={member.image}
                  alt={member.name}
                  className="w-full h-64 object-cover"
                />
                <div className="p-6 text-center">
                  <h3 className="text-xl font-semibold mb-1">{member.name}</h3>
                  <p className="text-gray-600">{member.role}</p>
                </div>
              </div>
            ))}
          </div>
        </div>
      </div>

      {/* Mission Section */}
      <div className="max-w-7xl mx-auto px-4 py-16">
        <div className="bg-gradient-to-r from-purple-600 to-pink-600 rounded-2xl p-12 text-white text-center">
          <h2 className="text-4xl font-bold mb-6">Sá»© Má»‡nh Cá»§a ChÃºng TÃ´i</h2>
          <p className="text-xl max-w-3xl mx-auto mb-8">
            Mang Ä‘áº¿n cho má»—i khÃ¡ch hÃ ng nhá»¯ng sáº£n pháº©m báº£o vá»‡ Ä‘iá»‡n thoáº¡i cháº¥t lÆ°á»£ng cao nháº¥t, 
            káº¿t há»£p giá»¯a tÃ­nh nÄƒng vÆ°á»£t trá»™i vÃ  thiáº¿t káº¿ nghá»‡ thuáº­t, 
            giÃºp há» thá»ƒ hiá»‡n phong cÃ¡ch riÃªng vÃ  báº£o vá»‡ thiáº¿t bá»‹ yÃªu quÃ½ cá»§a mÃ¬nh.
          </p>
          <Link href="/contact" className="inline-block bg-white text-purple-600 px-8 py-3 rounded-lg font-semibold hover:bg-gray-100 transition">
            LiÃªn Há»‡ Vá»›i ChÃºng TÃ´i
          </Link>
        </div>
      </div>
    </div>
  );
};

export default AboutPage;




################################################################################
## FILE 99: page.tsx
## Path: fontend/src/app/(public)/blog/page.tsx
################################################################################

'use client';

import React, { useState, useEffect } from 'react';
import Link from 'next/link';
import { Calendar, User, Eye, Clock, Search, ChevronRight, Tag } from 'lucide-react';

interface BlogPost {
  post_id: number;
  title: string;
  slug: string;
  content: string;
  excerpt: string;
  featured_image: string;
  author_id: number;
  category: string;
  tags: string;
  view_count: number;
  is_published: boolean;
  published_at: string;
  meta_title: string;
  meta_description: string;
  created_at: string;
  updated_at: string;
}

const API_URL = process.env.NEXT_PUBLIC_API_URL || 'http://localhost:3001';

export default function BlogPage() {
  const [posts, setPosts] = useState<BlogPost[]>([]);
  const [loading, setLoading] = useState(true);
  const [searchQuery, setSearchQuery] = useState('');
  const [selectedCategory, setSelectedCategory] = useState('all');
  const [currentPage, setCurrentPage] = useState(1);
  const postsPerPage = 9;

  const categories = [
    { id: 'all', name: 'Táº¥t cáº£' },
    { id: 'news', name: 'Tin tá»©c' },
    { id: 'tips', name: 'Máº¹o hay' },
    { id: 'review', name: 'ÄÃ¡nh giÃ¡' },
    { id: 'guide', name: 'HÆ°á»›ng dáº«n' },
  ];

  useEffect(() => {
    loadPosts();
  }, []);

  const loadPosts = async () => {
    try {
      setLoading(true);
      const response = await fetch(`${API_URL}/blog-posts`);
      if (response.ok) {
        const data = await response.json();
        setPosts(data.filter((p: BlogPost) => p.is_published));
      } else {
        setPosts(getSamplePosts());
      }
    } catch (error) {
      console.error('Error loading posts:', error);
      setPosts(getSamplePosts());
    } finally {
      setLoading(false);
    }
  };

  const getSamplePosts = (): BlogPost[] => {
    return [
      {
        post_id: 1,
        title: 'Top 10 á»‘p lÆ°ng iPhone 15 Pro Max Ä‘áº¹p nháº¥t 2024',
        slug: 'top-10-op-lung-iphone-15-pro-max-dep-nhat-2024',
        content: '',
        excerpt: 'KhÃ¡m phÃ¡ nhá»¯ng máº«u á»‘p lÆ°ng iPhone 15 Pro Max Ä‘Æ°á»£c yÃªu thÃ­ch nháº¥t.',
        featured_image: '/noel.jpg',
        author_id: 1,
        category: 'review',
        tags: 'iPhone,á»‘p lÆ°ng,phá»¥ kiá»‡n',
        view_count: 1523,
        is_published: true,
        published_at: '2024-12-15T10:00:00Z',
        meta_title: '',
        meta_description: '',
        created_at: '2024-12-15T10:00:00Z',
        updated_at: '2024-12-15T10:00:00Z',
      },
      {
        post_id: 2,
        title: 'CÃ¡ch báº£o vá»‡ Ä‘iá»‡n thoáº¡i trong mÃ¹a Ä‘Ã´ng láº¡nh',
        slug: 'cach-bao-ve-dien-thoai-mua-dong',
        content: '',
        excerpt: 'Nhá»¯ng máº¹o Ä‘Æ¡n giáº£n giÃºp báº£o vá»‡ Ä‘iá»‡n thoáº¡i cá»§a báº¡n.',
        featured_image: '/about1.jpg',
        author_id: 1,
        category: 'tips',
        tags: 'máº¹o hay,báº£o vá»‡ Ä‘iá»‡n thoáº¡i',
        view_count: 892,
        is_published: true,
        published_at: '2024-12-10T14:30:00Z',
        meta_title: '',
        meta_description: '',
        created_at: '2024-12-10T14:30:00Z',
        updated_at: '2024-12-10T14:30:00Z',
      },
      {
        post_id: 3,
        title: 'GoatTech ra máº¯t bá»™ sÆ°u táº­p GiÃ¡ng sinh 2024',
        slug: 'goattech-bo-suu-tap-giang-sinh-2024',
        content: '',
        excerpt: 'ChÃ o Ä‘Ã³n mÃ¹a lá»… há»™i vá»›i bá»™ sÆ°u táº­p á»‘p lÆ°ng GiÃ¡ng sinh Ä‘á»™c quyá»n.',
        featured_image: '/noel.jpg',
        author_id: 1,
        category: 'news',
        tags: 'GiÃ¡ng sinh,bá»™ sÆ°u táº­p,má»›i',
        view_count: 2341,
        is_published: true,
        published_at: '2024-12-01T09:00:00Z',
        meta_title: '',
        meta_description: '',
        created_at: '2024-12-01T09:00:00Z',
        updated_at: '2024-12-01T09:00:00Z',
      },
    ];
  };

  const filteredPosts = posts.filter(post => {
    const matchesSearch = post.title.toLowerCase().includes(searchQuery.toLowerCase()) ||
                          post.excerpt.toLowerCase().includes(searchQuery.toLowerCase());
    const matchesCategory = selectedCategory === 'all' || post.category === selectedCategory;
    return matchesSearch && matchesCategory;
  });

  const totalPages = Math.ceil(filteredPosts.length / postsPerPage);
  const paginatedPosts = filteredPosts.slice(
    (currentPage - 1) * postsPerPage,
    currentPage * postsPerPage
  );

  const formatDate = (dateString: string) => {
    return new Date(dateString).toLocaleDateString('vi-VN', {
      day: '2-digit',
      month: '2-digit',
      year: 'numeric',
    });
  };

  return (
    <div className="min-h-screen bg-gray-50">
      {/* Hero Section */}
      <section className="bg-gradient-to-r from-purple-600 to-pink-600 text-white py-16">
        <div className="max-w-7xl mx-auto px-4 text-center">
          <h1 className="text-4xl md:text-5xl font-bold mb-4">Blog GoatTech</h1>
          <p className="text-xl text-white/90 mb-8">
            Tin tá»©c, máº¹o hay vÃ  hÆ°á»›ng dáº«n vá» phá»¥ kiá»‡n Ä‘iá»‡n thoáº¡i
          </p>
          
          {/* Search Bar */}
          <div className="max-w-xl mx-auto relative">
            <input
              type="text"
              placeholder="TÃ¬m kiáº¿m bÃ i viáº¿t..."
              value={searchQuery}
              onChange={(e) => setSearchQuery(e.target.value)}
              className="w-full px-6 py-4 pr-12 rounded-full text-gray-900 focus:outline-none focus:ring-4 focus:ring-white/30"
            />
            <Search className="absolute right-4 top-1/2 -translate-y-1/2 w-6 h-6 text-gray-400" />
          </div>
        </div>
      </section>

      {/* Category Filter */}
      <section className="bg-white border-b sticky top-0 z-10">
        <div className="max-w-7xl mx-auto px-4 py-4">
          <div className="flex flex-wrap gap-3 justify-center">
            {categories.map((cat) => (
              <button
                key={cat.id}
                onClick={() => {
                  setSelectedCategory(cat.id);
                  setCurrentPage(1);
                }}
                className={`px-6 py-2 rounded-full font-medium transition ${
                  selectedCategory === cat.id
                    ? 'bg-gradient-to-r from-purple-600 to-pink-600 text-white'
                    : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                }`}
              >
                {cat.name}
              </button>
            ))}
          </div>
        </div>
      </section>

      {/* Blog Posts Grid */}
      <section className="max-w-7xl mx-auto px-4 py-12">
        {loading ? (
          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
            {[1, 2, 3, 4, 5, 6].map((i) => (
              <div key={i} className="animate-pulse">
                <div className="bg-gray-200 rounded-2xl h-48 mb-4"></div>
                <div className="bg-gray-200 h-6 rounded mb-2"></div>
                <div className="bg-gray-200 h-4 rounded w-3/4"></div>
              </div>
            ))}
          </div>
        ) : paginatedPosts.length > 0 ? (
          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
            {paginatedPosts.map((post) => (
              <Link key={post.post_id} href={`/blog/\${post.slug}`}>
                <article className="group bg-white rounded-2xl overflow-hidden shadow-sm hover:shadow-xl transition h-full flex flex-col">
                  <div className="relative h-48 overflow-hidden">
                    <img
                      src={post.featured_image || '/about1.jpg'}
                      alt={post.title}
                      className="w-full h-full object-cover group-hover:scale-110 transition duration-500"
                    />
                    <div className="absolute top-3 left-3">
                      <span className="bg-white/90 backdrop-blur-sm text-gray-700 text-xs font-medium px-3 py-1 rounded-full capitalize">
                        {categories.find(c => c.id === post.category)?.name || post.category}
                      </span>
                    </div>
                  </div>
                  
                  <div className="p-6 flex-1 flex flex-col">
                    <div className="flex items-center gap-4 text-xs text-gray-500 mb-3">
                      <span className="flex items-center gap-1">
                        <Calendar className="w-3 h-3" />
                        {formatDate(post.published_at)}
                      </span>
                      <span className="flex items-center gap-1">
                        <Eye className="w-3 h-3" />
                        {post.view_count}
                      </span>
                    </div>
                    
                    <h3 className="font-bold text-lg mb-3 line-clamp-2 group-hover:text-pink-600 transition">
                      {post.title}
                    </h3>
                    
                    <p className="text-gray-600 text-sm line-clamp-3 flex-1">
                      {post.excerpt}
                    </p>
                    
                    <div className="mt-4 pt-4 border-t">
                      <span className="text-pink-600 text-sm font-medium flex items-center gap-1 group-hover:gap-2 transition-all">
                        Äá»c thÃªm <ChevronRight className="w-4 h-4" />
                      </span>
                    </div>
                  </div>
                </article>
              </Link>
            ))}
          </div>
        ) : (
          <div className="text-center py-16">
            <div className="text-6xl mb-4">ðŸ“</div>
            <h3 className="text-xl font-semibold text-gray-700 mb-2">
              KhÃ´ng tÃ¬m tháº¥y bÃ i viáº¿t
            </h3>
            <p className="text-gray-500">
              Thá»­ tÃ¬m kiáº¿m vá»›i tá»« khÃ³a khÃ¡c
            </p>
          </div>
        )}

        {/* Pagination */}
        {totalPages > 1 && (
          <div className="flex justify-center gap-2 mt-12">
            {Array.from({ length: totalPages }, (_, i) => i + 1).map((page) => (
              <button
                key={page}
                onClick={() => setCurrentPage(page)}
                className={`px-4 py-2 rounded-lg \${
                  currentPage === page
                    ? 'bg-gradient-to-r from-purple-600 to-pink-600 text-white'
                    : 'bg-white border hover:bg-gray-50'
                }`}
              >
                {page}
              </button>
            ))}
          </div>
        )}
      </section>
    </div>
  );
}



################################################################################
## FILE 100: page.tsx
## Path: fontend/src/app/(public)/blog/[slug]/page.tsx
################################################################################

'use client';

import React, { useState, useEffect } from 'react';
import { useParams, useRouter } from 'next/navigation';
import Link from 'next/link';
import { Calendar, User, Eye, Clock, ArrowLeft, Share2, Heart, Facebook, Twitter, Copy, Check, ChevronRight, Tag } from 'lucide-react';

interface BlogPost {
  post_id: number;
  title: string;
  slug: string;
  content: string;
  excerpt: string;
  featured_image: string;
  author_id: number;
  category: string;
  tags: string;
  view_count: number;
  is_published: boolean;
  published_at: string;
}

const API_URL = process.env.NEXT_PUBLIC_API_URL || 'http://localhost:3001';

export default function BlogDetailPage() {
  const params = useParams();
  const router = useRouter();
  const slug = params.slug as string;

  const [post, setPost] = useState<BlogPost | null>(null);
  const [relatedPosts, setRelatedPosts] = useState<BlogPost[]>([]);
  const [loading, setLoading] = useState(true);
  const [copied, setCopied] = useState(false);
  const [liked, setLiked] = useState(false);

  useEffect(() => {
    if (slug) {
      loadPost();
    }
  }, [slug]);

  const loadPost = async () => {
    try {
      setLoading(true);
      const response = await fetch(`${API_URL}/blog-posts/${slug}`);
      if (response.ok) {
        const data = await response.json();
        setPost(data);
      } else {
        setPost(getSamplePost());
      }
    } catch (error) {
      setPost(getSamplePost());
    } finally {
      setLoading(false);
    }
  };

  const getSamplePost = (): BlogPost => ({
    post_id: 1,
    title: 'Top 10 á»‘p lÆ°ng iPhone 15 Pro Max Ä‘áº¹p nháº¥t 2024',
    slug: slug,
    content: `
      <h2>Giá»›i thiá»‡u</h2>
      <p>iPhone 15 Pro Max lÃ  smartphone cao cáº¥p nháº¥t hiá»‡n nay. Trong bÃ i viáº¿t nÃ y, chÃºng tÃ´i giá»›i thiá»‡u top 10 á»‘p lÆ°ng Ä‘áº¹p nháº¥t.</p>
      
      <h2>1. á»p lÆ°ng MagSafe trong suá»‘t</h2>
      <p>ÄÃ¢y lÃ  lá»±a chá»n hoÃ n háº£o cho nhá»¯ng ai muá»‘n khoe váº» Ä‘áº¹p cá»§a iPhone 15 Pro Max.</p>
      <ul>
        <li>Cháº¥t liá»‡u: Polycarbonate + TPU</li>
        <li>Trá»ng lÆ°á»£ng: 30g</li>
        <li>Äá»™ dÃ y: 1.2mm</li>
      </ul>
      
      <h2>2. á»p lÆ°ng da cao cáº¥p</h2>
      <p>Vá»›i cháº¥t liá»‡u da tháº­t, chiáº¿c á»‘p nÃ y mang Ä‘áº¿n váº» sang trá»ng vÃ  Ä‘áº³ng cáº¥p.</p>
      
      <h2>Káº¿t luáº­n</h2>
      <p>Viá»‡c chá»n á»‘p lÆ°ng phÃ¹ há»£p phá»¥ thuá»™c vÃ o nhu cáº§u cÃ¡ nhÃ¢n. GoatTech cung cáº¥p Ä‘áº§y Ä‘á»§ cÃ¡c loáº¡i á»‘p lÆ°ng vá»›i giÃ¡ cáº¡nh tranh.</p>
    `,
    excerpt: 'KhÃ¡m phÃ¡ nhá»¯ng máº«u á»‘p lÆ°ng iPhone 15 Pro Max Ä‘Æ°á»£c yÃªu thÃ­ch nháº¥t.',
    featured_image: '/noel.jpg',
    author_id: 1,
    category: 'review',
    tags: 'iPhone,á»‘p lÆ°ng,phá»¥ kiá»‡n,review',
    view_count: 1523,
    is_published: true,
    published_at: '2024-12-15T10:00:00Z',
  });

  const formatDate = (dateString: string) => {
    return new Date(dateString).toLocaleDateString('vi-VN', {
      day: '2-digit',
      month: 'long',
      year: 'numeric',
    });
  };

  const handleCopyLink = () => {
    navigator.clipboard.writeText(window.location.href);
    setCopied(true);
    setTimeout(() => setCopied(false), 2000);
  };

  if (loading) {
    return (
      <div className="min-h-screen bg-gray-50 flex items-center justify-center">
        <div className="animate-spin rounded-full h-16 w-16 border-t-4 border-pink-600"></div>
      </div>
    );
  }

  if (!post) {
    return (
      <div className="min-h-screen bg-gray-50 flex items-center justify-center">
        <div className="text-center">
          <div className="text-6xl mb-4">ðŸ˜¢</div>
          <h2 className="text-2xl font-bold mb-2">KhÃ´ng tÃ¬m tháº¥y bÃ i viáº¿t</h2>
          <Link href="/blog" className="text-pink-600 hover:underline">
            â† Quay láº¡i Blog
          </Link>
        </div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-gray-50">
      {/* Header Image */}
      <div className="relative h-[50vh] min-h-[400px]">
        <img
          src={post.featured_image || '/noel.jpg'}
          alt={post.title}
          className="w-full h-full object-cover"
        />
        <div className="absolute inset-0 bg-gradient-to-t from-black/70 via-black/30 to-transparent"></div>
        
        <Link
          href="/blog"
          className="absolute top-6 left-6 flex items-center gap-2 bg-white/90 backdrop-blur-sm text-gray-800 px-4 py-2 rounded-full font-medium hover:bg-white transition"
        >
          <ArrowLeft className="w-4 h-4" />
          Quay láº¡i
        </Link>

        <div className="absolute bottom-0 left-0 right-0 p-8 max-w-4xl mx-auto">
          <div className="flex items-center gap-3 mb-4">
            <span className="bg-white/90 backdrop-blur-sm text-gray-700 text-sm font-medium px-4 py-1 rounded-full capitalize">
              {post.category}
            </span>
          </div>
          <h1 className="text-3xl md:text-4xl lg:text-5xl font-bold text-white mb-4">
            {post.title}
          </h1>
          <div className="flex flex-wrap items-center gap-4 text-white/80 text-sm">
            <span className="flex items-center gap-1">
              <Calendar className="w-4 h-4" />
              {formatDate(post.published_at)}
            </span>
            <span className="flex items-center gap-1">
              <Eye className="w-4 h-4" />
              {post.view_count} lÆ°á»£t xem
            </span>
          </div>
        </div>
      </div>

      {/* Content */}
      <article className="max-w-4xl mx-auto px-4 py-12">
        <div className="bg-white rounded-2xl shadow-sm p-8 md:p-12">
          <p className="text-xl text-gray-600 leading-relaxed mb-8 pb-8 border-b">
            {post.excerpt}
          </p>

          <div 
            className="prose prose-lg max-w-none"
            dangerouslySetInnerHTML={{ __html: post.content }}
          />

          {/* Tags */}
          {post.tags && (
            <div className="mt-12 pt-8 border-t">
              <div className="flex items-center gap-2 flex-wrap">
                <Tag className="w-5 h-5 text-gray-400" />
                {post.tags.split(',').map((tag, index) => (
                  <Link
                    key={index}
                    href={`/blog?tag=${tag.trim()}`}
                    className="bg-gray-100 hover:bg-gray-200 text-gray-700 px-4 py-2 rounded-full text-sm transition"
                  >
                    #{tag.trim()}
                  </Link>
                ))}
              </div>
            </div>
          )}

          {/* Share */}
          <div className="mt-8 pt-8 border-t flex flex-wrap items-center justify-between gap-4">
            <div className="flex items-center gap-3">
              <span className="text-gray-600 font-medium">Chia sáº»:</span>
              <button className="bg-blue-600 text-white p-2 rounded-full hover:bg-blue-700 transition">
                <Facebook className="w-5 h-5" />
              </button>
              <button className="bg-sky-500 text-white p-2 rounded-full hover:bg-sky-600 transition">
                <Twitter className="w-5 h-5" />
              </button>
              <button
                onClick={handleCopyLink}
                className="bg-gray-200 text-gray-700 p-2 rounded-full hover:bg-gray-300 transition"
              >
                {copied ? <Check className="w-5 h-5 text-green-600" /> : <Copy className="w-5 h-5" />}
              </button>
            </div>
            
            <button
              onClick={() => setLiked(!liked)}
              className={`flex items-center gap-2 px-6 py-2 rounded-full transition ${
                liked
                  ? 'bg-pink-100 text-pink-600'
                  : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
              }`}
            >
              <Heart className={`w-5 h-5 ${liked ? 'fill-pink-600' : ''}`} />
              {liked ? 'ÄÃ£ thÃ­ch' : 'ThÃ­ch bÃ i viáº¿t'}
            </button>
          </div>
        </div>

        {/* CTA */}
        <div className="mt-16 bg-gradient-to-r from-purple-600 to-pink-600 rounded-2xl p-8 text-white text-center">
          <h3 className="text-2xl font-bold mb-4">KhÃ¡m phÃ¡ sáº£n pháº©m cá»§a GoatTech</h3>
          <p className="text-white/90 mb-6">
            HÃ ng ngÃ n máº«u á»‘p lÆ°ng cháº¥t lÆ°á»£ng cao Ä‘ang chá» báº¡n
          </p>
          <Link
            href="/shop"
            className="inline-block bg-white text-pink-600 px-8 py-3 rounded-full font-semibold hover:bg-gray-100 transition"
          >
            Mua sáº¯m ngay
          </Link>
        </div>
      </article>
    </div>
  );
}



################################################################################
## FILE 101: page.tsx
## Path: fontend/src/app/(public)/categories/page.tsx
################################################################################

'use client';

import React, { useState, useEffect } from 'react';
import { Search, Menu, ShoppingCart, User, Heart, ChevronRight } from 'lucide-react';
import Link from 'next/link';
import { fetchRootCategories, fetchChildCategories } from '@/lib/api-client';

interface Category {
  category_id: number;
  category_name: string;
  category_slug: string;
  parent_category_id: number | null;
  description: string;
  image_url: string;
  icon_name: string;
  display_order: number;
  is_active: boolean;
  created_at?: string;
  updated_at?: string;
}

const CategoriesPage: React.FC = () => {
  const [rootCategories, setRootCategories] = useState<Category[]>([]);
  const [selectedCategory, setSelectedCategory] = useState<Category | null>(null);
  const [childCategories, setChildCategories] = useState<Category[]>([]);
  const [loading, setLoading] = useState(true);
  const [isMenuOpen, setIsMenuOpen] = useState(false);

  useEffect(() => {
    loadRootCategories();
  }, []);

  const loadRootCategories = async () => {
    try {
      setLoading(true);
      const data = await fetchRootCategories();
      if (Array.isArray(data)) {
        setRootCategories(data);
      }
    } catch (error) {
      console.error('Error loading categories:', error);
    } finally {
      setLoading(false);
    }
  };

  const loadChildCategories = async (parentId: number, category: Category) => {
    try {
      setSelectedCategory(category);
      const data = await fetchChildCategories(parentId);
      if (Array.isArray(data)) {
        setChildCategories(data);
      }
    } catch (error) {
      console.error('Error loading child categories:', error);
    }
  };

  return (
    <div className="min-h-screen bg-gray-50">
      {/* Top Banner */}
      <div className="bg-black text-white py-2 px-4 text-center text-sm">
        <div className="max-w-7xl mx-auto flex items-center justify-center gap-4">
          <span>Miá»…n phÃ­ váº­n chuyá»ƒn cho Ä‘Æ¡n hÃ ng trÃªn 100K</span>
          <span className="hidden md:inline">|</span>
          <span className="hidden md:inline">Æ¯u Ä‘Ã£i GoatTech: Mua 4 á»‘p - Tráº£ tiá»n 2 á»‘p</span>
        </div>
      </div>

      {/* Header */}
      <header className="bg-white shadow-sm sticky top-0 z-50">
        <div className="max-w-7xl mx-auto px-4 py-4">
          <div className="flex items-center justify-between gap-4">
            <div className="flex items-center gap-4">
              <button className="lg:hidden" onClick={() => setIsMenuOpen(!isMenuOpen)}>
                <Menu className="w-6 h-6" />
              </button>
              <button className="lg:hidden">
                <Search className="w-6 h-6" />
              </button>
            </div>

            <Link href="/" className="text-2xl font-bold tracking-wider">
              GoatTech
            </Link>

            <div className="flex items-center gap-4">
              <button className="relative">
                <Heart className="w-6 h-6" />
              </button>

              <Link href="/account">
                <User className="w-6 h-6" />
              </Link>

              <Link href="/shop" className="relative">
                <ShoppingCart className="w-6 h-6" />
              </Link>
            </div>
          </div>

          {/* Desktop Navigation */}
          <nav className="hidden lg:flex items-center justify-center gap-8 mt-4 pt-4 border-t">
            <Link href="/" className="text-sm font-medium hover:text-pink-600">Trang Chá»§</Link>
            <Link href="/shop" className="text-sm font-medium hover:text-pink-600">Cá»­a HÃ ng</Link>
            <Link href="/categories" className="text-sm font-medium text-pink-600">Danh Má»¥c</Link>
            <Link href="/about" className="text-sm font-medium hover:text-pink-600">Vá» ChÃºng TÃ´i</Link>
            <Link href="/contact" className="text-sm font-medium hover:text-pink-600">LiÃªn Há»‡</Link>
            <Link href="/promotions" className="text-sm font-medium hover:text-pink-600">Khuyáº¿n Máº¡i</Link>
          </nav>
        </div>
      </header>

      {/* Main Content */}
      <main className="max-w-7xl mx-auto px-4 py-12">
        {/* Page Title */}
        <div className="text-center mb-12">
          <h1 className="text-4xl font-bold mb-4">Danh Má»¥c Sáº£n Pháº©m</h1>
          <p className="text-gray-600">KhÃ¡m phÃ¡ cÃ¡c danh má»¥c á»‘p lÆ°ng vÃ  phá»¥ kiá»‡n Ä‘iá»‡n thoáº¡i</p>
        </div>

        {loading ? (
          <div className="text-center py-12">
            <p className="text-xl">Äang táº£i...</p>
          </div>
        ) : (
          <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
            {/* Root Categories - Left Side */}
            <div className="lg:col-span-1">
              <h2 className="text-2xl font-bold mb-6">Danh Má»¥c ChÃ­nh</h2>
              <div className="space-y-3">
                {rootCategories.map((category) => (
                  <button
                    key={category.category_id}
                    onClick={() => loadChildCategories(category.category_id, category)}
                    className={`w-full text-left p-4 rounded-lg border-2 transition ${
                      selectedCategory?.category_id === category.category_id
                        ? 'border-pink-600 bg-pink-50'
                        : 'border-gray-200 hover:border-pink-300'
                    }`}
                  >
                    <div className="flex items-center justify-between">
                      <div>
                        <h3 className="font-semibold text-lg">{category.category_name}</h3>
                        <p className="text-sm text-gray-600">{category.description}</p>
                      </div>
                      <ChevronRight className="w-5 h-5 text-gray-400" />
                    </div>
                  </button>
                ))}
              </div>
            </div>

            {/* Child Categories - Right Side */}
            <div className="lg:col-span-2">
              {selectedCategory ? (
                <>
                  <h2 className="text-2xl font-bold mb-6">
                    {selectedCategory.category_name}
                  </h2>
                  {childCategories.length > 0 ? (
                    <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                      {childCategories.map((category) => (
                        <Link
                          key={category.category_id}
                          href={`/shop?category=${category.category_slug}`}
                          className="group bg-white rounded-lg border-2 border-gray-200 hover:border-pink-600 transition p-6"
                        >
                          <div className="flex items-start justify-between">
                            <div>
                              <h3 className="font-semibold text-lg mb-2 group-hover:text-pink-600">
                                {category.category_name}
                              </h3>
                              <p className="text-sm text-gray-600">{category.description}</p>
                            </div>
                            <span className="text-2xl">{category.icon_name || 'ðŸ“±'}</span>
                          </div>
                        </Link>
                      ))}
                    </div>
                  ) : (
                    <div className="text-center py-12 bg-white rounded-lg border-2 border-gray-200">
                      <p className="text-gray-600">ChÆ°a cÃ³ danh má»¥c con</p>
                    </div>
                  )}
                </>
              ) : (
                <div className="text-center py-20 bg-white rounded-lg border-2 border-gray-200">
                  <p className="text-gray-600 text-lg">
                    â† Chá»n má»™t danh má»¥c bÃªn trÃ¡i Ä‘á»ƒ xem chi tiáº¿t
                  </p>
                </div>
              )}
            </div>
          </div>
        )}

        {/* Quick Links */}
        <div className="mt-16 grid grid-cols-1 md:grid-cols-3 gap-6">
          <div className="bg-gradient-to-br from-purple-600 to-pink-600 text-white p-8 rounded-2xl">
            <h3 className="text-2xl font-bold mb-4">á»p LÆ°ng Theo HÃ£ng</h3>
            <p className="mb-4">iPhone, Samsung, Xiaomi, OPPO...</p>
            <Link href="/shop?filter=brand" className="inline-block bg-white text-pink-600 px-6 py-2 rounded-lg font-medium hover:bg-gray-100">
              Xem Ngay
            </Link>
          </div>

          <div className="bg-gradient-to-br from-blue-600 to-cyan-600 text-white p-8 rounded-2xl">
            <h3 className="text-2xl font-bold mb-4">Bá»™ SÆ°u Táº­p Äá»™c Quyá»n</h3>
            <p className="mb-4">Thiáº¿t káº¿ Ä‘á»™c Ä‘Ã¡o, phong cÃ¡ch riÃªng</p>
            <Link href="/shop?filter=collection" className="inline-block bg-white text-blue-600 px-6 py-2 rounded-lg font-medium hover:bg-gray-100">
              KhÃ¡m PhÃ¡
            </Link>
          </div>

          <div className="bg-gradient-to-br from-green-600 to-teal-600 text-white p-8 rounded-2xl">
            <h3 className="text-2xl font-bold mb-4">Phá»¥ Kiá»‡n Cao Cáº¥p</h3>
            <p className="mb-4">KÃ­nh cÆ°á»ng lá»±c, dÃ¢y Ä‘eo, charm...</p>
            <Link href="/shop?filter=accessories" className="inline-block bg-white text-green-600 px-6 py-2 rounded-lg font-medium hover:bg-gray-100">
              Mua Sáº¯m
            </Link>
          </div>
        </div>
      </main>

      {/* Footer */}
      <footer className="bg-gray-900 text-white py-12 mt-16">
        <div className="max-w-7xl mx-auto px-4 grid grid-cols-1 md:grid-cols-4 gap-8">
          <div>
            <h3 className="text-xl font-bold mb-4">GoatTech</h3>
            <p className="text-gray-400">á»p lÆ°ng cao cáº¥p, phong cÃ¡ch Viá»‡t Nam</p>
          </div>
          <div>
            <h4 className="font-semibold mb-4">Há»— Trá»£</h4>
            <ul className="space-y-2 text-gray-400">
              <li><Link href="/contact">LiÃªn Há»‡</Link></li>
              <li><Link href="/shipping">Váº­n Chuyá»ƒn</Link></li>
              <li><Link href="/return">Äá»•i Tráº£</Link></li>
            </ul>
          </div>
          <div>
            <h4 className="font-semibold mb-4">Vá» ChÃºng TÃ´i</h4>
            <ul className="space-y-2 text-gray-400">
              <li><Link href="/about">Giá»›i Thiá»‡u</Link></li>
              <li><Link href="/careers">Tuyá»ƒn Dá»¥ng</Link></li>
              <li><Link href="/press">BÃ¡o ChÃ­</Link></li>
            </ul>
          </div>
          <div>
            <h4 className="font-semibold mb-4">Theo DÃµi</h4>
            <ul className="space-y-2 text-gray-400">
              <li>Facebook</li>
              <li>Instagram</li>
              <li>TikTok</li>
            </ul>
          </div>
        </div>
        <div className="max-w-7xl mx-auto px-4 mt-8 pt-8 border-t border-gray-800 text-center text-gray-400">
          <p>&copy; 2024 GoatTech Vietnam. All rights reserved.</p>
        </div>
      </footer>
    </div>
  );
};

export default CategoriesPage;




################################################################################
## FILE 102: page.tsx
## Path: fontend/src/app/(public)/checkout/page.tsx
################################################################################

'use client';

import React, { useEffect, useState } from 'react';
import { useRouter } from 'next/navigation';
import Link from 'next/link';
import { useAuth } from '@/contexts/AuthContext';
import {
  fetchShoppingCart,
  createOrder,
  clearShoppingCart,
  createMomoPayment,
} from '@/lib/api-client';
import {
  ArrowLeft,
  CreditCard,
  Truck,
  MapPin,
  Phone,
  User,
  FileText,
  ShoppingBag,
  Shield,
  AlertCircle,
  Check,
} from 'lucide-react';

interface CartItem {
  cart_id: number;
  product_id: number;
  variant_id?: number;
  phone_model_id?: number;
  phone_model_name?: string;
  quantity: number;
  product_name: string;
  price: number;
  original_price?: number;
  image_url?: string;
}

interface ShippingAddress {
  fullname: string;
  phone: string;
  addressline1: string;
  ward: string;
  district: string;
  city: string;
}

export default function CheckoutPage() {
  const { user, isAuthenticated, loading: authLoading } = useAuth();
  const router = useRouter();

  // States
  const [cartItems, setCartItems] = useState<CartItem[]>([]);
  const [loading, setLoading] = useState(true);
  const [submitting, setSubmitting] = useState(false);
  const [subtotal, setSubtotal] = useState(0);
  const [shippingFee, setShippingFee] = useState(30000);
  const [discount, setDiscount] = useState(0);
  const [paymentMethod, setPaymentMethod] = useState('cod');
  const [couponCode, setCouponCode] = useState('');
  const [customerNote, setCustomerNote] = useState('');
  const [validationErrors, setValidationErrors] = useState<Record<string, string>>({});

  // Shipping address form
  const [shippingAddress, setShippingAddress] = useState<ShippingAddress>({
    fullname: '',
    phone: '',
    addressline1: '',
    ward: '',
    district: '',
    city: '',
  });

  // Load cart data
  useEffect(() => {
    if (authLoading) return;

    if (!isAuthenticated) {
      router.push('/login?redirect=checkout');
      return;
    }

    const loadCart = async () => {
      setLoading(true);
      try {
        const res = await fetchShoppingCart();

        if (!res.success || !res.data || res.data.length === 0) {
          alert('Giá» hÃ ng trá»‘ng!');
          router.push('/shopping-cart');
          return;
        }

        setCartItems(res.data);
        // Calculate subtotal
        const total = res.data.reduce((sum: number, item: CartItem) => {
          return sum + item.price * item.quantity;
        }, 0);

        setSubtotal(total);

        // Free shipping for orders >= 500k
        setShippingFee(total >= 500000 ? 0 : 30000);

        // Pre-fill user info
        if (user) {
          setShippingAddress((prev) => ({
            ...prev,
            fullname: user.fullname || user.firstname || '',
            phone: user.phone || '',
          }));
        }
      } catch (error) {
        console.error('Load cart error:', error);
        alert('Lá»—i khi táº£i giá» hÃ ng');
      } finally {
        setLoading(false);
      }
    };

    loadCart();
  }, [authLoading, isAuthenticated, router, user]);

  // Handle input changes
  const handleAddressChange = (
    e: React.ChangeEvent<HTMLInputElement | HTMLTextAreaElement>
  ) => {
    const { name, value } = e.target;
    setShippingAddress((prev) => ({
      ...prev,
      [name]: value,
    }));
    // Clear error for this field when user starts typing
    if (validationErrors[name]) {
      setValidationErrors((prev) => ({
        ...prev,
        [name]: '',
      }));
    }
  };

  // Validate form - Cáº¢I THIá»†N
  const validateForm = (): boolean => {
    const errors: Record<string, string> = {};
    let isValid = true;

    if (!shippingAddress.fullname.trim()) {
      errors.fullname = 'Vui lÃ²ng nháº­p há» tÃªn';
      isValid = false;
    }

    if (!shippingAddress.phone.trim()) {
      errors.phone = 'Vui lÃ²ng nháº­p sá»‘ Ä‘iá»‡n thoáº¡i';
      isValid = false;
    } else if (!/^[0-9]{10,11}$/.test(shippingAddress.phone.trim())) {
      errors.phone = 'Sá»‘ Ä‘iá»‡n thoáº¡i khÃ´ng há»£p lá»‡ (10-11 chá»¯ sá»‘)';
      isValid = false;
    }

    if (!shippingAddress.addressline1.trim()) {
      errors.addressline1 = 'Vui lÃ²ng nháº­p Ä‘á»‹a chá»‰ chi tiáº¿t';
      isValid = false;
    }

    if (!shippingAddress.district.trim()) {
      errors.district = 'Vui lÃ²ng nháº­p quáº­n/huyá»‡n';
      isValid = false;
    }

    if (!shippingAddress.city.trim()) {
      errors.city = 'Vui lÃ²ng nháº­p tá»‰nh/thÃ nh phá»‘';
      isValid = false;
    }

    setValidationErrors(errors);

    if (!isValid) {
      // Scroll to first error
      const firstErrorField = document.querySelector('[data-error]');
      if (firstErrorField) {
        firstErrorField.scrollIntoView({ behavior: 'smooth', block: 'center' });
      }
    }

    return isValid;
  };

  // Submit order - CHÃNH
  const handleCheckout = async () => {
    if (!validateForm()) return;

    setSubmitting(true);

    try {
      const orderData = {
        // âœ… items - ÄÃšNG KEY BACKEND
        items: cartItems.map(item => ({
          product_id: item.product_id,//
          variant_id: item.variant_id,//
          phone_model_id: item.phone_model_id,
          phone_model_name: item.phone_model_name,
          product_name: item.product_name || item.products?.product_name || `Product #${item.product_id}`,
          quantity: item.quantity,//
          unit_price: item.price || item.products?.sale_price || item.products?.price || 0,
          discount_amount: 0,//
        })),

        // âœ… shipping_address - ÄÃšNG STRUCT
        shipping_address: {
          full_name: shippingAddress.fullname,//
          phone: shippingAddress.phone,//
          address_line1: shippingAddress.addressline1,//
          ward: shippingAddress.ward ||  undefined,///
          district: shippingAddress.district,//
          city: shippingAddress.city,//
        },

        // âœ… order financials (FULL TABLE)
        subtotal:subtotal,
        total_amount: subtotal - discount + shippingFee,

        // âœ… meta
        payment_method: paymentMethod,
        coupon_code: couponCode ||  undefined,
        customer_note: customerNote ||  undefined,
      };

      const result = await createOrder(orderData);

      if (!result.success) throw new Error(result.message);

      const orderNumber = result.data.order_number;
      const orderId = result.data.order_id || result.data.id;
      const totalAmount = result.data.total_amount || (subtotal - discount + shippingFee);

      // âœ… Náº¿u chá»n thanh toÃ¡n MoMo -> Gá»i API MoMo vÃ  redirect
      if (paymentMethod === 'momo') {
        try {
          const momoResult = await createMomoPayment({
            amount: totalAmount,
            orderInfo: `Thanh toÃ¡n Ä‘Æ¡n hÃ ng #${orderNumber}`,
            orderId: orderNumber, // DÃ¹ng order_number lÃ m orderId cho MoMo
            redirectUrl: `${window.location.origin}/payment-result`,
            extraData: JSON.stringify({ orderId, orderNumber }),
          });

          if (momoResult.success && momoResult.data?.payUrl) {
            // XÃ³a giá» hÃ ng trÆ°á»›c khi redirect
            await clearShoppingCart();
            // Redirect Ä‘áº¿n trang thanh toÃ¡n MoMo
            window.location.href = momoResult.data.payUrl;
            return;
          } else {
            throw new Error(momoResult.message || 'KhÃ´ng thá»ƒ táº¡o thanh toÃ¡n MoMo');
          }
        } catch (momoError: any) {
          console.error('MoMo payment error:', momoError);
          // Váº«n chuyá»ƒn Ä‘áº¿n trang order náº¿u MoMo lá»—i, Ä‘á»ƒ user cÃ³ thá»ƒ thanh toÃ¡n sau
          alert(`Lá»—i thanh toÃ¡n MoMo: ${momoError.message}. ÄÆ¡n hÃ ng Ä‘Ã£ Ä‘Æ°á»£c táº¡o, báº¡n cÃ³ thá»ƒ thanh toÃ¡n sau.`);
        }
      }

      // COD hoáº·c thanh toÃ¡n khÃ¡c -> XÃ³a giá» hÃ ng vÃ  chuyá»ƒn Ä‘áº¿n trang order
      await clearShoppingCart();
      router.push(`/order/${orderNumber}?total=${totalAmount}`);
    } catch (err: any) {
      alert(err.message || 'Lá»—i táº¡o Ä‘Æ¡n hÃ ng');
    } finally {
      setSubmitting(false);
    }
  };


  // Calculate total
  const totalAmount = subtotal - discount + shippingFee;

  // Format price
  const formatPrice = (price: number) => {
    return price.toLocaleString('vi-VN');
  };

  // Loading state
  if (loading || authLoading) {
    return (
      <div className="min-h-screen flex items-center justify-center bg-gray-50">
        <div className="text-center">
          <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-pink-600 mx-auto mb-4"></div>
          <p className="text-gray-600">Äang táº£i thÃ´ng tin thanh toÃ¡n...</p>
        </div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-gray-50 py-8">
      <div className="max-w-6xl mx-auto px-4">
        {/* Header */}
        <div className="mb-8">
          <Link
            href="/shopping-cart"
            className="flex items-center gap-2 text-gray-600 hover:text-pink-600 mb-4"
          >
            <ArrowLeft className="w-5 h-5" />
            Quay láº¡i giá» hÃ ng
          </Link>
          <h1 className="text-3xl font-bold text-gray-900">Thanh toÃ¡n</h1>
        </div>

        <div className="grid lg:grid-cols-3 gap-8">
          {/* Left Column - Forms */}
          <div className="lg:col-span-2 space-y-6">
            {/* Shipping Address */}
            <div className="bg-white rounded-2xl shadow-sm p-6">
              <div className="flex items-center gap-3 mb-6">
                <div className="p-2 bg-pink-100 rounded-lg">
                  <MapPin className="w-5 h-5 text-pink-600" />
                </div>
                <h2 className="text-xl font-semibold">Äá»‹a chá»‰ giao hÃ ng</h2>
              </div>

              <div className="grid md:grid-cols-2 gap-4">
                {/* Fullname */}
                <div data-error={validationErrors.fullname ? 'true' : ''}>
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    <User className="w-4 h-4 inline mr-1" />
                    Há» vÃ  tÃªn
                  </label>
                  <input
                    type="text"
                    name="fullname"
                    value={shippingAddress.fullname}
                    onChange={handleAddressChange}
                    className={`w-full border rounded-xl px-4 py-3 focus:ring-2 focus:ring-pink-500 focus:border-transparent ${
                      validationErrors.fullname
                        ? 'border-red-500'
                        : 'border-gray-300'
                    }`}
                    placeholder="Nguyá»…n VÄƒn A"
                  />
                  {validationErrors.fullname && (
                    <p className="text-red-500 text-sm mt-1 flex items-center gap-1">
                      <AlertCircle className="w-4 h-4" />
                      {validationErrors.fullname}
                    </p>
                  )}
                </div>

                {/* Phone */}
                <div data-error={validationErrors.phone ? 'true' : ''}>
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    <Phone className="w-4 h-4 inline mr-1" />
                    Sá»‘ Ä‘iá»‡n thoáº¡i
                  </label>
                  <input
                    type="tel"
                    name="phone"
                    value={shippingAddress.phone}
                    onChange={handleAddressChange}
                    className={`w-full border rounded-xl px-4 py-3 focus:ring-2 focus:ring-pink-500 focus:border-transparent ${
                      validationErrors.phone
                        ? 'border-red-500'
                        : 'border-gray-300'
                    }`}
                    placeholder="0901234567"
                  />
                  {validationErrors.phone && (
                    <p className="text-red-500 text-sm mt-1 flex items-center gap-1">
                      <AlertCircle className="w-4 h-4" />
                      {validationErrors.phone}
                    </p>
                  )}
                </div>

                {/* Address */}
                <div
                  className="md:col-span-2"
                  data-error={validationErrors.addressline1 ? 'true' : ''}
                >
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    Äá»‹a chá»‰ chi tiáº¿t
                  </label>
                  <input
                    type="text"
                    name="addressline1"
                    value={shippingAddress.addressline1}
                    onChange={handleAddressChange}
                    className={`w-full border rounded-xl px-4 py-3 focus:ring-2 focus:ring-pink-500 focus:border-transparent ${
                      validationErrors.addressline1
                        ? 'border-red-500'
                        : 'border-gray-300'
                    }`}
                    placeholder="Sá»‘ nhÃ , tÃªn Ä‘Æ°á»ng..."
                  />
                  {validationErrors.addressline1 && (
                    <p className="text-red-500 text-sm mt-1 flex items-center gap-1">
                      <AlertCircle className="w-4 h-4" />
                      {validationErrors.addressline1}
                    </p>
                  )}
                </div>

                {/* Ward */}
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    PhÆ°á»ng/XÃ£ (tÃ¹y chá»n)
                  </label>
                  <input
                    type="text"
                    name="ward"
                    value={shippingAddress.ward}
                    onChange={handleAddressChange}
                    className="w-full border border-gray-300 rounded-xl px-4 py-3 focus:ring-2 focus:ring-pink-500 focus:border-transparent"
                    placeholder="PhÆ°á»ng 1"
                  />
                </div>

                {/* District */}
                <div data-error={validationErrors.district ? 'true' : ''}>
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    Quáº­n/Huyá»‡n
                  </label>
                  <input
                    type="text"
                    name="district"
                    value={shippingAddress.district}
                    onChange={handleAddressChange}
                    className={`w-full border rounded-xl px-4 py-3 focus:ring-2 focus:ring-pink-500 focus:border-transparent ${
                      validationErrors.district
                        ? 'border-red-500'
                        : 'border-gray-300'
                    }`}
                    placeholder="Quáº­n 1"
                  />
                  {validationErrors.district && (
                    <p className="text-red-500 text-sm mt-1 flex items-center gap-1">
                      <AlertCircle className="w-4 h-4" />
                      {validationErrors.district}
                    </p>
                  )}
                </div>

                {/* City */}
                <div data-error={validationErrors.city ? 'true' : ''}>
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    Tá»‰nh/ThÃ nh phá»‘
                  </label>
                  <input
                    type="text"
                    name="city"
                    value={shippingAddress.city}
                    onChange={handleAddressChange}
                    className={`w-full border rounded-xl px-4 py-3 focus:ring-2 focus:ring-pink-500 focus:border-transparent ${
                      validationErrors.city
                        ? 'border-red-500'
                        : 'border-gray-300'
                    }`}
                    placeholder="TP. Há»“ ChÃ­ Minh"
                  />
                  {validationErrors.city && (
                    <p className="text-red-500 text-sm mt-1 flex items-center gap-1">
                      <AlertCircle className="w-4 h-4" />
                      {validationErrors.city}
                    </p>
                  )}
                </div>
              </div>
            </div>

            {/* Payment Method */}
            <div className="bg-white rounded-2xl shadow-sm p-6">
              <div className="flex items-center gap-3 mb-6">
                <div className="p-2 bg-blue-100 rounded-lg">
                  <CreditCard className="w-5 h-5 text-blue-600" />
                </div>
                <h2 className="text-xl font-semibold">PhÆ°Æ¡ng thá»©c thanh toÃ¡n</h2>
              </div>

              <div className="space-y-3">
                {/* COD */}
                <label className="flex items-center gap-4 p-4 border-2 rounded-xl cursor-pointer transition hover:bg-gray-50"
                  style={{
                    borderColor: paymentMethod === 'cod' ? '#ec4899' : '#d1d5db',
                    backgroundColor: paymentMethod === 'cod' ? '#fce7f3' : 'white',
                  }}>
                  <input
                    type="radio"
                    name="payment"
                    value="cod"
                    checked={paymentMethod === 'cod'}
                    onChange={(e) => setPaymentMethod(e.target.value)}
                    className="w-5 h-5 text-pink-600"
                  />
                  <Truck className="w-6 h-6 text-gray-600" />
                  <div>
                    <p className="font-medium">Thanh toÃ¡n khi nháº­n hÃ ng (COD)</p>
                    <p className="text-sm text-gray-500">
                      Thanh toÃ¡n báº±ng tiá»n máº·t khi nháº­n hÃ ng
                    </p>
                  </div>
                </label>

                {/* MoMo */}
                <label className="flex items-center gap-4 p-4 border-2 rounded-xl cursor-pointer transition hover:bg-gray-50"
                  style={{
                    borderColor: paymentMethod === 'momo' ? '#ec4899' : '#d1d5db',
                    backgroundColor: paymentMethod === 'momo' ? '#fce7f3' : 'white',
                  }}>
                  <input
                    type="radio"
                    name="payment"
                    value="momo"
                    checked={paymentMethod === 'momo'}
                    onChange={(e) => setPaymentMethod(e.target.value)}
                    className="w-5 h-5 text-pink-600"
                  />
                  <div className="w-6 h-6 bg-pink-500 rounded-lg flex items-center justify-center text-white font-bold text-xs">
                    M
                  </div>
                  <div>
                    <p className="font-medium">VÃ­ MoMo</p>
                    <p className="text-sm text-gray-500">
                      Thanh toÃ¡n qua vÃ­ Ä‘iá»‡n tá»­ MoMo
                    </p>
                  </div>
                </label>

                {/* Bank Transfer */}
                <label className="flex items-center gap-4 p-4 border-2 rounded-xl cursor-pointer transition hover:bg-gray-50"
                  style={{
                    borderColor: paymentMethod === 'bank' ? '#ec4899' : '#d1d5db',
                    backgroundColor: paymentMethod === 'bank' ? '#fce7f3' : 'white',
                  }}>
                  <input
                    type="radio"
                    name="payment"
                    value="bank"
                    checked={paymentMethod === 'bank'}
                    onChange={(e) => setPaymentMethod(e.target.value)}
                    className="w-5 h-5 text-pink-600"
                  />
                  <CreditCard className="w-6 h-6 text-gray-600" />
                  <div>
                    <p className="font-medium">Chuyá»ƒn khoáº£n ngÃ¢n hÃ ng</p>
                    <p className="text-sm text-gray-500">
                      Chuyá»ƒn khoáº£n qua tÃ i khoáº£n ngÃ¢n hÃ ng
                    </p>
                  </div>
                </label>
              </div>
            </div>

            {/* Customer Note */}
            <div className="bg-white rounded-2xl shadow-sm p-6">
              <div className="flex items-center gap-3 mb-4">
                <div className="p-2 bg-gray-100 rounded-lg">
                  <FileText className="w-5 h-5 text-gray-600" />
                </div>
                <h2 className="text-xl font-semibold">Ghi chÃº Ä‘Æ¡n hÃ ng</h2>
              </div>
              <textarea
                value={customerNote}
                onChange={(e) => setCustomerNote(e.target.value)}
                className="w-full border border-gray-300 rounded-xl px-4 py-3 focus:ring-2 focus:ring-pink-500 focus:border-transparent resize-none"
                rows={3}
                placeholder="Ghi chÃº thÃªm vá» Ä‘Æ¡n hÃ ng tÃ¹y chá»n..."
              ></textarea>
            </div>
          </div>

          {/* Right Column - Order Summary */}
          <div className="lg:col-span-1">
            <div className="bg-white rounded-2xl shadow-sm p-6 sticky top-4">
              <h2 className="text-xl font-semibold mb-6">ÄÆ¡n hÃ ng cá»§a báº¡n</h2>

              {/* Cart Items */}
              <div className="space-y-4 max-h-64 overflow-y-auto mb-6 pb-4 border-b">
                {cartItems.map((item) => (
                  <div key={item.cart_id} className="flex gap-3">
                    <div className="w-16 h-16 bg-gray-100 rounded-lg overflow-hidden flex-shrink-0">
                      <img
                        src={item.image_url || '/placeholder.png'}
                        alt={item.product_name}
                        className="w-full h-full object-cover"
                      />
                    </div>
                    <div className="flex-1 min-w-0">
                      <p className="font-medium text-sm line-clamp-2">
                        {item.product_name}
                      </p>
                      {item.phone_model_name && (
                        <p className="text-xs text-gray-500 bg-gray-100 px-2 py-0.5 rounded inline-block mt-1">
                          ðŸ“± {item.phone_model_name}
                        </p>
                      )}
                      <p className="text-gray-500 text-sm">
                        x{item.quantity}
                      </p>
                      <p className="font-semibold text-pink-600 whitespace-nowrap">
                        {formatPrice(item.price * item.quantity)}â‚«
                      </p>
                    </div>
                  </div>
                ))}
              </div>

              {/* Summary */}
              <div className="space-y-3">
                <div className="flex justify-between text-gray-600">
                  <span>Táº¡m tÃ­nh</span>
                  <span>{formatPrice(subtotal)}â‚«</span>
                </div>

                {discount > 0 && (
                  <div className="flex justify-between text-green-600">
                    <span>Giáº£m giÃ¡</span>
                    <span>-{formatPrice(discount)}â‚«</span>
                  </div>
                )}

                <div className="flex justify-between text-gray-600">
                  <span>PhÃ­ váº­n chuyá»ƒn</span>
                  <span>
                    {shippingFee === 0 ? 'Miá»…n phÃ­' : formatPrice(shippingFee) + 'â‚«'}
                  </span>
                </div>

                <div className="border-t pt-4 flex justify-between font-bold text-lg">
                  <span>Tá»•ng cá»™ng</span>
                  <span className="text-pink-600">{formatPrice(totalAmount)}â‚«</span>
                </div>
              </div>

              {/* Submit Button */}
              <button
                onClick={handleCheckout}
                disabled={submitting || cartItems.length === 0}
                className="w-full mt-6 bg-gradient-to-r from-pink-600 to-pink-500 text-white py-3 rounded-xl font-bold hover:from-pink-700 hover:to-pink-600 transition disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2"
              >
                {submitting ? (
                  <>
                    <div className="animate-spin rounded-full h-5 w-5 border-b-2 border-white"></div>
                    Äang xá»­ lÃ½...
                  </>
                ) : (
                  <>
                    <Check className="w-5 h-5" />
                    XÃ¡c nháº­n Ä‘Æ¡n hÃ ng
                  </>
                )}
              </button>

              {/* Security Badge */}
              <div className="mt-4 flex items-center justify-center gap-2 text-gray-500 text-sm">
                <Shield className="w-4 h-4" />
                <span>Thanh toÃ¡n an toÃ n</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
}




################################################################################
## FILE 103: page.tsx
## Path: fontend/src/app/(public)/collections/page.tsx
################################################################################

'use client';

import React, { useState, useEffect } from 'react';
import { Search, Menu, ShoppingCart, User, Heart, ArrowRight, Star, Sparkles, Crown, Gem, Palette, Zap, Shield, Gift, X } from 'lucide-react';
import Link from 'next/link';
import { fetchProducts, fetchCategoriesWithCount, fetchProductsBySeason, fetchSeasonProductCounts, fetchAllCollections, fetchCollectionsByType, fetchCollectionProductCounts, fetchProductsByCollection } from '@/lib/api-client';

interface Collection {
  id: number;
  name: string;
  description: string;
  image: string;
  productCount: number;
  gradient: string;
  icon: React.ReactNode;
  featured?: boolean;
}

interface Product {
  id: number;
  name: string;
  price: number;
  image: string;
  rating: number;
  reviews: number;
  tag?: string;
}

interface SeasonalCollection {
  id: number;
  name: string;
  image: string;
  gradient: string;
  products: number;
  seasonKey: string;
}

const CollectionsPage: React.FC = () => {
  const [cartCount, setCartCount] = useState(0);
  const [wishlistCount, setWishlistCount] = useState(0);
  const [isMenuOpen, setIsMenuOpen] = useState(false);
  const [activeCollection, setActiveCollection] = useState<number | null>(null);
  const [hoveredProduct, setHoveredProduct] = useState<number | null>(null);
  const [featuredProducts, setFeaturedProducts] = useState<Product[]>([]);
  const [loading, setLoading] = useState(true);
  
  // Season modal states
  const [showSeasonModal, setShowSeasonModal] = useState(false);
  const [selectedSeason, setSelectedSeason] = useState<SeasonalCollection | null>(null);
  const [seasonProducts, setSeasonProducts] = useState<Product[]>([]);
  const [loadingSeasonProducts, setLoadingSeasonProducts] = useState(false);
  
  // Season product counts from API
  const [seasonCounts, setSeasonCounts] = useState<Record<string, number>>({
    noel: 0,
    valentine: 0,
    tet: 0
  });

  // Collection product counts from API (báº¯t Ä‘áº§u tá»« 0)
  const [collectionCounts, setCollectionCounts] = useState<Record<string, number>>({
    'luxury-edition': 0,
    'minimalist': 0,
    'artistic-series': 0,
    'gaming-pro': 0,
    'rugged-armor': 0,
    'limited-edition': 0,
    'giang-sinh-noel': 0,
    'valentine': 0,
    'tet-nguyen-dan': 0
  });

  // Featured Collections - sá»­ dá»¥ng collectionCounts tá»« API
  const collections: Collection[] = [
    {
      id: 1,
      name: 'Luxury Edition',
      description: 'Bá»™ sÆ°u táº­p cao cáº¥p vá»›i cháº¥t liá»‡u da tháº­t vÃ  kim loáº¡i nguyÃªn khá»‘i',
      image: 'https://images.unsplash.com/photo-1616348436168-de43ad0db179?w=800&h=600&fit=crop',
      productCount: collectionCounts['luxury-edition'] || 0,
      gradient: 'from-amber-500 via-yellow-500 to-orange-500',
      icon: <Crown className="w-8 h-8" />,
      featured: true
    },
    {
      id: 2,
      name: 'Minimalist',
      description: 'Thiáº¿t káº¿ tá»‘i giáº£n, tinh táº¿ cho ngÆ°á»i yÃªu thÃ­ch sá»± Ä‘Æ¡n giáº£n',
      image: 'https://images.unsplash.com/photo-1609081219090-a6d81d3085bf?w=800&h=600&fit=crop',
      productCount: collectionCounts['minimalist'] || 0,
      gradient: 'from-gray-700 via-gray-800 to-gray-900',
      icon: <Gem className="w-8 h-8" />
    },
    {
      id: 3,
      name: 'Artistic Series',
      description: 'Há»a tiáº¿t nghá»‡ thuáº­t Ä‘á»™c Ä‘Ã¡o tá»« cÃ¡c nghá»‡ sÄ© hÃ ng Ä‘áº§u',
      image: 'https://images.unsplash.com/photo-1586953208448-b95a79798f07?w=800&h=600&fit=crop',
      productCount: collectionCounts['artistic-series'] || 0,
      gradient: 'from-purple-500 via-pink-500 to-red-500',
      icon: <Palette className="w-8 h-8" />
    },
    {
      id: 4,
      name: 'Gaming Pro',
      description: 'DÃ nh cho game thá»§ vá»›i thiáº¿t káº¿ RGB vÃ  grip chá»‘ng trÆ°á»£t',
      image: 'https://images.unsplash.com/photo-1612287230202-1ff1d85d1bdf?w=800&h=600&fit=crop',
      productCount: collectionCounts['gaming-pro'] || 0,
      gradient: 'from-green-400 via-cyan-500 to-blue-500',
      icon: <Zap className="w-8 h-8" />
    },
    {
      id: 5,
      name: 'Rugged Armor',
      description: 'Báº£o vá»‡ tá»‘i Ä‘a vá»›i chuáº©n quÃ¢n Ä‘á»™i, chá»‘ng va Ä‘áº­p cá»±c tá»‘t',
      image: 'https://images.unsplash.com/photo-1601784551446-20c9e07cdbdb?w=800&h=600&fit=crop',
      productCount: collectionCounts['rugged-armor'] || 0,
      gradient: 'from-slate-600 via-slate-700 to-slate-800',
      icon: <Shield className="w-8 h-8" />
    },
    {
      id: 6,
      name: 'Limited Edition',
      description: 'PhiÃªn báº£n giá»›i háº¡n, sá»‘ lÆ°á»£ng cÃ³ háº¡n, thiáº¿t káº¿ Ä‘á»™c quyá»n',
      image: 'https://images.unsplash.com/photo-1585771724684-38269d6639fd?w=800&h=600&fit=crop',
      productCount: collectionCounts['limited-edition'] || 0,
      gradient: 'from-rose-500 via-pink-600 to-purple-600',
      icon: <Sparkles className="w-8 h-8" />,
      featured: true
    }
  ];

  // Seasonal Collections - sá»­ dá»¥ng collectionCounts tá»« API
  const seasonalCollections: SeasonalCollection[] = [
    {
      id: 7,
      name: 'GiÃ¡ng Sinh - Noel',
      image: 'noel.jpg',
      gradient: 'from-red-600 to-green-600',
      products: collectionCounts['giang-sinh-noel'] || 0,
      seasonKey: 'noel'
    },
    {
      id: 8,
      name: 'Valentine',
      image: 'https://images.unsplash.com/photo-1518199266791-5375a83190b7?w=600&h=400&fit=crop',
      gradient: 'from-red-400 to-pink-500',
      products: collectionCounts['valentine'] || 0,
      seasonKey: 'valentine'
    },
    {
      id: 9,
      name: 'Táº¿t NguyÃªn ÄÃ¡n',
      image: 'https://images.unsplash.com/photo-1548919973-5cef591cdbc9?w=600&h=400&fit=crop',
      gradient: 'from-yellow-500 to-red-500',
      products: collectionCounts['tet-nguyen-dan'] || 0,
      seasonKey: 'tet'
    }
  ];

  // Load season product counts
  useEffect(() => {
    const loadSeasonCounts = async () => {
      try {
        const counts = await fetchSeasonProductCounts();
        setSeasonCounts(counts);
      } catch (error) {
        console.error('Error loading season counts:', error);
      }
    };
    loadSeasonCounts();
  }, []);

  // Load collection product counts tá»« API
  useEffect(() => {
    const loadCollectionCounts = async () => {
      try {
        const counts = await fetchCollectionProductCounts();
        setCollectionCounts(counts);
      } catch (error) {
        console.error('Error loading collection counts:', error);
        // Giá»¯ giÃ¡ trá»‹ 0 náº¿u lá»—i
      }
    };
    loadCollectionCounts();
  }, []);

  // Handle click on seasonal collection
  const handleSeasonClick = async (collection: SeasonalCollection) => {
    setSelectedSeason(collection);
    setShowSeasonModal(true);
    setLoadingSeasonProducts(true);
    
    try {
      const products = await fetchProductsBySeason(collection.seasonKey);
      const mapped = products.map((p: any) => ({
        id: p.product_id || p.id,
        name: p.product_name || p.name,
        price: p.price || 0,
        image: p.image_url || p.image || 'https://images.unsplash.com/photo-1565849904461-04a3cc76e3a9?w=400',
        rating: p.rating || 4.5,
        reviews: p.reviews || 0,
        tag: p.tag
      }));
      setSeasonProducts(mapped);
    } catch (error) {
      console.error('Error loading season products:', error);
      setSeasonProducts([]);
    } finally {
      setLoadingSeasonProducts(false);
    }
  };

  useEffect(() => {
    const loadFeaturedProducts = async () => {
      try {
        setLoading(true);
        const data = await fetchProducts(8);
        const mapped = data.map((p: any) => ({
          id: p.product_id || p.id,
          name: p.product_name || p.name,
          price: p.price || 0,
          image: p.image_url || p.image || 'https://images.unsplash.com/photo-1565849904461-04a3cc76e3a9?w=400',
          rating: p.rating || 4.5,
          reviews: p.reviews || 0,
          tag: p.tag
        }));
        setFeaturedProducts(mapped);
      } catch (error) {
        console.error('Error loading products:', error);
        // Fallback data
        setFeaturedProducts([
          { id: 1, name: 'á»p Luxury Gold', price: 299000, image: 'https://images.unsplash.com/photo-1565849904461-04a3cc76e3a9?w=400', rating: 4.9, reviews: 128 },
          { id: 2, name: 'á»p Minimal Black', price: 199000, image: 'https://images.unsplash.com/photo-1592899677977-9c10ca588bbd?w=400', rating: 4.8, reviews: 256 },
          { id: 3, name: 'á»p Art Series', price: 249000, image: 'https://images.unsplash.com/photo-1586953208448-b95a79798f07?w=400', rating: 4.7, reviews: 89 },
          { id: 4, name: 'á»p Gaming RGB', price: 349000, image: 'https://images.unsplash.com/photo-1612287230202-1ff1d85d1bdf?w=400', rating: 4.9, reviews: 312 }
        ]);
      } finally {
        setLoading(false);
      }
    };
    loadFeaturedProducts();
  }, []);

  return (
    <div className="min-h-screen bg-gray-50">
      {/* Season Products Modal */}
      {showSeasonModal && selectedSeason && (
        <div className="fixed inset-0 z-[100] flex items-center justify-center bg-black/50 backdrop-blur-sm" onClick={() => setShowSeasonModal(false)}>
          <div className="bg-white rounded-2xl w-full max-w-4xl max-h-[90vh] overflow-hidden shadow-2xl mx-4" onClick={(e) => e.stopPropagation()}>
            {/* Modal Header */}
            <div className={`bg-gradient-to-r ${selectedSeason.gradient} p-6 text-white relative`}>
              <button 
                onClick={() => setShowSeasonModal(false)}
                className="absolute top-4 right-4 bg-white/20 hover:bg-white/30 p-2 rounded-full transition"
              >
                <X className="w-5 h-5" />
              </button>
              <h2 className="text-2xl font-bold">{selectedSeason.name}</h2>
              <p className="text-white/80">{selectedSeason.products} sáº£n pháº©m trong bá»™ sÆ°u táº­p</p>
            </div>
            
            {/* Modal Content */}
            <div className="p-6 overflow-y-auto max-h-[60vh]">
              {loadingSeasonProducts ? (
                <div className="grid grid-cols-2 md:grid-cols-3 gap-4">
                  {[1, 2, 3, 4, 5, 6].map((i) => (
                    <div key={i} className="animate-pulse">
                      <div className="bg-gray-200 rounded-xl h-40 mb-3"></div>
                      <div className="bg-gray-200 h-4 rounded mb-2"></div>
                      <div className="bg-gray-200 h-4 rounded w-2/3"></div>
                    </div>
                  ))}
                </div>
              ) : seasonProducts.length === 0 ? (
                <div className="text-center py-12">
                  <Gift className="w-16 h-16 mx-auto text-gray-300 mb-4" />
                  <p className="text-gray-500 text-lg">ChÆ°a cÃ³ sáº£n pháº©m trong bá»™ sÆ°u táº­p nÃ y</p>
                  <p className="text-gray-400 text-sm mt-2">HÃ£y thÃªm sáº£n pháº©m vá»›i mÃ¹a "{selectedSeason.seasonKey}" trong Admin</p>
                </div>
              ) : (
                <div className="grid grid-cols-2 md:grid-cols-3 gap-4">
                  {seasonProducts.map((product) => (
                    <Link href={`/product/${product.id}`} key={product.id}>
                      <div className="group bg-gray-50 rounded-xl overflow-hidden hover:shadow-lg transition">
                        <div className="relative overflow-hidden">
                          <img 
                            src={product.image} 
                            alt={product.name}
                            className="w-full h-40 object-cover group-hover:scale-110 transition duration-300"
                          />
                          {product.tag && (
                            <span className="absolute top-2 left-2 bg-pink-500 text-white text-xs font-bold px-2 py-1 rounded-full">
                              {product.tag}
                            </span>
                          )}
                        </div>
                        <div className="p-3">
                          <h3 className="font-medium text-sm line-clamp-2 mb-2 group-hover:text-pink-600 transition">{product.name}</h3>
                          <div className="flex items-center gap-1 mb-2">
                            <Star className="w-3 h-3 fill-yellow-400 text-yellow-400" />
                            <span className="text-xs text-gray-600">{product.rating}</span>
                          </div>
                          <p className="text-pink-600 font-bold">{product.price.toLocaleString('vi-VN')}â‚«</p>
                        </div>
                      </div>
                    </Link>
                  ))}
                </div>
              )}
            </div>
            
            {/* Modal Footer */}
            <div className="p-4 border-t bg-gray-50">
              <Link href="/shop" className="block w-full bg-gradient-to-r from-purple-600 to-pink-600 text-white py-3 rounded-xl font-semibold text-center hover:from-purple-700 hover:to-pink-700 transition">
                Xem Táº¥t Cáº£ Sáº£n Pháº©m
              </Link>
            </div>
          </div>
        </div>
      )}

      {/* Top Banner */}
      <div className="bg-gradient-to-r from-purple-900 via-indigo-900 to-purple-900 text-white py-2 px-4 text-center text-sm">
        <div className="max-w-7xl mx-auto flex items-center justify-center gap-4">
          <Sparkles className="w-4 h-4 text-yellow-400" />
          <span>KhÃ¡m phÃ¡ bá»™ sÆ°u táº­p má»›i nháº¥t - Giáº£m Ä‘áº¿n 30% cho thÃ nh viÃªn</span>
          <Sparkles className="w-4 h-4 text-yellow-400" />
        </div>
      </div>

      

      {/* Hero Section */}
      <section className="relative overflow-hidden">
        <div className="absolute inset-0 bg-gradient-to-br from-purple-900 via-indigo-800 to-pink-900"></div>
        <div className="absolute inset-0 opacity-20">
          <div className="absolute inset-0" style={{
            backgroundImage: `url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.4'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E")`,
          }}></div>
        </div>
        <div className="relative max-w-7xl mx-auto px-4 py-20 md:py-32">
          <div className="text-center text-white">
            <div className="inline-flex items-center gap-2 bg-white/10 backdrop-blur-sm px-4 py-2 rounded-full mb-6">
              <Sparkles className="w-5 h-5 text-yellow-400" />
              <span className="text-sm font-medium">Bá»™ sÆ°u táº­p 2025</span>
            </div>
            <h1 className="text-5xl md:text-7xl font-bold mb-6">
              KhÃ¡m PhÃ¡ <span className="bg-gradient-to-r from-yellow-400 via-pink-400 to-purple-400 bg-clip-text text-transparent">Bá»™ SÆ°u Táº­p</span>
            </h1>
            <p className="text-xl md:text-2xl text-white/80 mb-8 max-w-2xl mx-auto">
              Nhá»¯ng thiáº¿t káº¿ Ä‘á»™c Ä‘Ã¡o, cháº¥t lÆ°á»£ng cao cáº¥p dÃ nh riÃªng cho báº¡n
            </p>
            <div className="flex flex-col sm:flex-row gap-4 justify-center">
              <button className="bg-white text-purple-900 px-8 py-4 rounded-full font-semibold hover:bg-gray-100 transition transform hover:scale-105 shadow-xl">
                KhÃ¡m PhÃ¡ Ngay
              </button>
              <button className="border-2 border-white text-white px-8 py-4 rounded-full font-semibold hover:bg-white/10 transition">
                Xem Video
              </button>
            </div>
          </div>
        </div>
        
        {/* Animated gradient orbs */}
        <div className="absolute top-20 left-10 w-72 h-72 bg-purple-500/30 rounded-full blur-3xl animate-pulse"></div>
        <div className="absolute bottom-20 right-10 w-96 h-96 bg-pink-500/30 rounded-full blur-3xl animate-pulse" style={{ animationDelay: '1s' }}></div>
      </section>

      {/* Featured Collections Grid */}
      <section className="max-w-7xl mx-auto px-4 py-16">
        <div className="text-center mb-12">
          <h2 className="text-4xl font-bold mb-4">Bá»™ SÆ°u Táº­p Ná»•i Báº­t</h2>
          <p className="text-gray-600 max-w-2xl mx-auto">KhÃ¡m phÃ¡ nhá»¯ng bá»™ sÆ°u táº­p Ä‘Æ°á»£c thiáº¿t káº¿ Ä‘áº·c biá»‡t, mang Ä‘áº¿n phong cÃ¡ch Ä‘á»™c Ä‘Ã¡o cho chiáº¿c Ä‘iá»‡n thoáº¡i cá»§a báº¡n</p>
        </div>

        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
          {collections.map((collection, index) => (
            <div
              key={collection.id}
              className={`group relative overflow-hidden rounded-3xl cursor-pointer transform transition-all duration-500 hover:scale-[1.02] hover:shadow-2xl ${
                collection.featured ? 'md:col-span-2 lg:col-span-1' : ''
              }`}
              style={{ minHeight: collection.featured ? '400px' : '320px' }}
              onMouseEnter={() => setActiveCollection(collection.id)}
              onMouseLeave={() => setActiveCollection(null)}
            >
              {/* Background Image */}
              <div className="absolute inset-0">
                <img 
                  src={collection.image} 
                  alt={collection.name}
                  className="w-full h-full object-cover transition-transform duration-700 group-hover:scale-110"
                />
              </div>
              
              {/* Gradient Overlay */}
              <div className={`absolute inset-0 bg-gradient-to-t ${collection.gradient} opacity-80 group-hover:opacity-90 transition-opacity duration-300`}></div>
              
              {/* Content */}
              <div className="absolute inset-0 p-6 flex flex-col justify-end text-white">
                {collection.featured && (
                  <div className="absolute top-4 right-4 bg-yellow-400 text-black text-xs font-bold px-3 py-1 rounded-full flex items-center gap-1">
                    <Star className="w-3 h-3 fill-current" />
                    HOT
                  </div>
                )}
                
                <div className={`transform transition-all duration-500 ${activeCollection === collection.id ? 'translate-y-0' : 'translate-y-4'}`}>
                  <div className="mb-3 inline-flex items-center justify-center w-14 h-14 bg-white/20 backdrop-blur-sm rounded-2xl">
                    {collection.icon}
                  </div>
                  <h3 className="text-2xl font-bold mb-2">{collection.name}</h3>
                  <p className={`text-white/80 mb-4 transition-all duration-300 ${activeCollection === collection.id ? 'opacity-100 max-h-20' : 'opacity-0 max-h-0'} overflow-hidden`}>
                    {collection.description}
                  </p>
                  <div className="flex items-center justify-between">
                    <span className="text-sm bg-white/20 px-3 py-1 rounded-full">{collection.productCount} sáº£n pháº©m</span>
                    <button className="flex items-center gap-2 font-medium hover:gap-3 transition-all">
                      Xem ngay <ArrowRight className="w-4 h-4" />
                    </button>
                  </div>
                </div>
              </div>
            </div>
          ))}
        </div>
      </section>

      {/* Seasonal Collections */}
      <section className="bg-gradient-to-b from-gray-100 to-white py-16">
        <div className="max-w-7xl mx-auto px-4">
          <div className="flex items-center justify-between mb-8">
            <div>
              <h2 className="text-3xl font-bold mb-2">Bá»™ SÆ°u Táº­p Theo MÃ¹a</h2>
              <p className="text-gray-600">Nhá»¯ng thiáº¿t káº¿ phÃ¹ há»£p vá»›i tá»«ng dá»‹p Ä‘áº·c biá»‡t</p>
            </div>
            <Link href="/shop" className="hidden md:flex items-center gap-2 text-pink-600 font-medium hover:gap-3 transition-all">
              Xem táº¥t cáº£ <ArrowRight className="w-4 h-4" />
            </Link>
          </div>

          <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
            {seasonalCollections.map((collection) => (
              <div
                key={collection.id}
                className="group relative overflow-hidden rounded-2xl h-64 cursor-pointer"
                onClick={() => handleSeasonClick(collection)}
              >
                <img 
                  src={collection.image} 
                  alt={collection.name}
                  className="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110"
                />
                <div className={`absolute inset-0 bg-gradient-to-t ${collection.gradient} opacity-60 group-hover:opacity-70 transition-opacity`}></div>
                <div className="absolute inset-0 p-6 flex flex-col justify-end text-white">
                  <h3 className="text-xl font-bold mb-1">{collection.name}</h3>
                  <p className="text-sm text-white/80">{collection.products} sáº£n pháº©m</p>
                </div>
              </div>
            ))}
          </div>
        </div>
      </section>

      {/* Featured Products from Collections
      <section className="max-w-7xl mx-auto px-4 py-16">
        <div className="text-center mb-12">
          <h2 className="text-3xl font-bold mb-4">Sáº£n Pháº©m Ná»•i Báº­t Tá»« Bá»™ SÆ°u Táº­p</h2>
          <p className="text-gray-600">Nhá»¯ng sáº£n pháº©m Ä‘Æ°á»£c yÃªu thÃ­ch nháº¥t</p>
        </div>

        {loading ? (
          <div className="grid grid-cols-2 md:grid-cols-4 gap-6">
            {[1, 2, 3, 4].map((i) => (
              <div key={i} className="animate-pulse">
                <div className="bg-gray-200 rounded-2xl h-64 mb-4"></div>
                <div className="bg-gray-200 h-4 rounded mb-2"></div>
                <div className="bg-gray-200 h-4 rounded w-2/3"></div>
              </div>
            ))}
          </div>
        ) : (
          <div className="grid grid-cols-2 md:grid-cols-4 gap-6">
            {featuredProducts.slice(0, 4).map((product) => (
              <div
                key={product.id}
                className="group bg-white rounded-2xl overflow-hidden shadow-sm hover:shadow-xl transition-all duration-300 transform hover:-translate-y-2"
                onMouseEnter={() => setHoveredProduct(product.id)}
                onMouseLeave={() => setHoveredProduct(null)}
              >
                <div className="relative overflow-hidden">
                  <img 
                    src={product.image} 
                    alt={product.name}
                    className="w-full h-64 object-cover transition-transform duration-500 group-hover:scale-110"
                  />
                  {product.tag && (
                    <span className="absolute top-3 left-3 bg-gradient-to-r from-pink-500 to-purple-500 text-white text-xs font-bold px-3 py-1 rounded-full">
                      {product.tag}
                    </span>
                  )}
                  <div className={`absolute inset-0 bg-black/20 flex items-center justify-center transition-opacity duration-300 ${hoveredProduct === product.id ? 'opacity-100' : 'opacity-0'}`}>
                    <button className="bg-white text-gray-900 px-6 py-2 rounded-full font-medium transform transition-transform hover:scale-105">
                      Xem Chi Tiáº¿t
                    </button>
                  </div>
                  <button className="absolute top-3 right-3 bg-white/80 backdrop-blur-sm p-2 rounded-full opacity-0 group-hover:opacity-100 transition-opacity hover:bg-white">
                    <Heart className="w-5 h-5 text-gray-600 hover:text-pink-500 transition-colors" />
                  </button>
                </div>
                <div className="p-4">
                  <h3 className="font-semibold mb-2 line-clamp-2 group-hover:text-pink-600 transition-colors">{product.name}</h3>
                  <div className="flex items-center gap-2 mb-2">
                    <div className="flex items-center">
                      <Star className="w-4 h-4 fill-yellow-400 text-yellow-400" />
                      <span className="text-sm ml-1">{product.rating}</span>
                    </div>
                    <span className="text-sm text-gray-500">({product.reviews})</span>
                  </div>
                  <div className="flex items-center justify-between">
                    <span className="text-lg font-bold text-pink-600">{product.price.toLocaleString('vi-VN')}â‚«</span>
                    <button className="bg-gradient-to-r from-purple-600 to-pink-600 text-white px-4 py-2 rounded-lg text-sm font-medium hover:from-purple-700 hover:to-pink-700 transition">
                      ThÃªm
                    </button>
                  </div>
                </div>
              </div>
            ))}
          </div>
        )}

        <div className="text-center mt-10">
          <Link href="/shop" className="inline-flex items-center gap-2 bg-gradient-to-r from-purple-600 to-pink-600 text-white px-8 py-4 rounded-full font-semibold hover:from-purple-700 hover:to-pink-700 transition transform hover:scale-105 shadow-lg">
            Xem Táº¥t Cáº£ Sáº£n Pháº©m <ArrowRight className="w-5 h-5" />
          </Link>
        </div>
      </section> */}

      {/* Newsletter Section */}
      <section className="relative overflow-hidden">
        <div className="absolute inset-0 bg-gradient-to-r from-purple-600 via-pink-600 to-orange-500"></div>
        <div className="absolute inset-0 opacity-10">
          <div className="absolute inset-0" style={{
            backgroundImage: `radial-gradient(circle at 2px 2px, white 1px, transparent 0)`,
            backgroundSize: '32px 32px'
          }}></div>
        </div>
        <div className="relative max-w-4xl mx-auto px-4 py-20 text-center text-white">
          <Gift className="w-16 h-16 mx-auto mb-6 opacity-80" />
          <h2 className="text-4xl font-bold mb-4">Nháº­n Æ¯u ÄÃ£i Äá»™c Quyá»n</h2>
          <p className="text-xl text-white/80 mb-8">ÄÄƒng kÃ½ Ä‘á»ƒ nháº­n thÃ´ng tin vá» bá»™ sÆ°u táº­p má»›i vÃ  giáº£m giÃ¡ 15% cho Ä‘Æ¡n hÃ ng Ä‘áº§u tiÃªn</p>
          <div className="flex flex-col sm:flex-row gap-4 justify-center max-w-md mx-auto">
            <input
              type="email"
              placeholder="Nháº­p email cá»§a báº¡n"
              className="flex-1 px-6 py-4 rounded-full text-gray-900 focus:outline-none focus:ring-4 focus:ring-white/30"
            />
            <button className="bg-white text-purple-600 px-8 py-4 rounded-full font-semibold hover:bg-gray-100 transition transform hover:scale-105 shadow-lg">
              ÄÄƒng KÃ½
            </button>
          </div>
        </div>
      </section>
    </div>
  );
};

export default CollectionsPage;




################################################################################
## FILE 104: page.tsx
## Path: fontend/src/app/(public)/contact/page.tsx
################################################################################

'use client';

import React, { useState, useEffect } from 'react';
import { ShoppingCart, User, Heart, Search, Menu, Mail, Phone, MapPin, Clock, Send } from 'lucide-react';
import Link from 'next/link';
import { fetchCategories, createContactMessage } from '@/lib/api-client';

const ContactPage: React.FC = () => {
  const [cartCount, setCartCount] = useState(0);
  const [wishlistCount, setWishlistCount] = useState(0);
  const [selectedDevice, setSelectedDevice] = useState('iPhone 17 Pro Max');
  const [isCurrencyModalOpen, setIsCurrencyModalOpen] = useState(false);
  const [selectedCurrency, setSelectedCurrency] = useState('USD');
  const [formData, setFormData] = useState({
    name: '',
    email: '',
    phone: '',
    subject: '',
    message: ''
  });
  const [devices, setDevices] = useState<string[]>(['iPhone 17 Pro Max']);

  useEffect(() => {
    const loadCategories = async () => {
      try {
        const data = await fetchCategories();
        if (Array.isArray(data) && data.length > 0) {
          const categoryNames = data.map((cat: any) => cat.category_name);
          setDevices(categoryNames);
          setSelectedDevice(categoryNames[0]);
        }
      } catch (error) {
        console.error('Error loading categories:', error);
      }
    };
    loadCategories();
  }, []);

  const handleCurrencyChange = (currency: string) => {
    setSelectedCurrency(currency);
    setIsCurrencyModalOpen(false);
  };

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    
    try {
      const result = await createContactMessage({
        name: formData.name,
        email: formData.email,
        phone: formData.phone,
        subject: formData.subject,
        message: formData.message
      });
      
      if (result.success) {
        alert(`Cáº£m Æ¡n ${formData.name}! Tin nháº¯n cá»§a báº¡n Ä‘Ã£ Ä‘Æ°á»£c gá»­i thÃ nh cÃ´ng. ChÃºng tÃ´i sáº½ liÃªn há»‡ láº¡i vá»›i báº¡n sá»›m.`);
        setFormData({ name: '', email: '', phone: '', subject: '', message: '' });
      } else {
        alert('CÃ³ lá»—i xáº£y ra khi gá»­i tin nháº¯n. Vui lÃ²ng thá»­ láº¡i!');
      }
    } catch (error) {
      console.error('Error sending message:', error);
      alert(`Cáº£m Æ¡n ${formData.name}! ChÃºng tÃ´i sáº½ liÃªn há»‡ láº¡i vá»›i báº¡n sá»›m.`);
      setFormData({ name: '', email: '', phone: '', subject: '', message: '' });
    }
  };

  const handleInputChange = (e: React.ChangeEvent<HTMLInputElement | HTMLTextAreaElement | HTMLSelectElement>) => {
    setFormData({
      ...formData,
      [e.target.name]: e.target.value
    });
  };

  return (
    <div className="min-h-screen bg-gray-50">
      {/* Currency Modal */}
      {isCurrencyModalOpen && (
        <div className="fixed inset-0 z-50 flex items-center justify-center" onClick={() => setIsCurrencyModalOpen(false)}>
          <div className="bg-white rounded-xl p-6 max-w-md w-full mx-4 shadow-2xl" onClick={(e) => e.stopPropagation()}>
            <div className="flex items-center justify-between mb-6">
              <h2 className="text-xl font-bold">CHá»ŒN LOáº I TIá»€N Tá»†</h2>
              <button onClick={() => setIsCurrencyModalOpen(false)} className="text-gray-500 hover:text-gray-700">
                <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                </svg>
              </button>
            </div>
            
            <div className="mb-6">
              <label className="block text-sm font-semibold mb-2 text-gray-700">QUá»C GIA/KHU Vá»°C:</label>
              <select 
                className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-600"
                value={selectedCurrency}
                onChange={(e) => handleCurrencyChange(e.target.value)}
              >
                <option value="USD">United States (USD $)</option>
                <option value="VND">Viá»‡t Nam (VND â‚«)</option>
              </select>
            </div>

            <button 
              onClick={() => setIsCurrencyModalOpen(false)}
              className="w-full bg-black text-white py-3 rounded-lg font-semibold hover:bg-gray-800 transition"
            >
              ÃP Dá»¤NG
            </button>
          </div>
        </div>
      )}

      {/* Top Banner */}
      <div className="bg-black text-white py-2 px-4 text-center text-sm">
        <div className="max-w-7xl mx-auto flex items-center justify-center gap-4">
          <span>Miá»…n phÃ­ váº­n chuyá»ƒn cho Ä‘Æ¡n hÃ ng trÃªn 100K</span>
          <span className="hidden md:inline">|</span>
          <span className="hidden md:inline">Æ¯u Ä‘Ã£i GoatTech: Mua 4 á»‘p - Tráº£ tiá»n 2 á»‘p</span>
        </div>
      </div>

      {/* Hero Section */}
      <div className="bg-gradient-to-r from-purple-600 to-pink-600 text-white py-16">
        <div className="max-w-7xl mx-auto px-4 text-center">
          <h1 className="text-4xl md:text-5xl font-bold mb-4">LiÃªn Há»‡ ChÃºng TÃ´i</h1>
          <p className="text-xl">ChÃºng tÃ´i luÃ´n sáºµn sÃ ng há»— trá»£ báº¡n 24/7</p>
        </div>
      </div>

      {/* Contact Information */}
      <div className="max-w-7xl mx-auto px-4 py-16">
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-8 mb-16">
          <div className="bg-white p-6 rounded-xl shadow-sm text-center">
            <div className="bg-pink-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
              <Phone className="w-8 h-8 text-pink-600" />
            </div>
            <h3 className="font-semibold text-lg mb-2">Äiá»‡n Thoáº¡i</h3>
            <p className="text-gray-600">+84 941 402 595</p>
            <p className="text-gray-600">+84 914 100 559</p>
          </div>

          <div className="bg-white p-6 rounded-xl shadow-sm text-center">
            <div className="bg-blue-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
              <Mail className="w-8 h-8 text-blue-600" />
            </div>
            <h3 className="font-semibold text-lg mb-2">Email</h3>
            <p className="text-gray-600">support@GoatTech.vn</p>
            <p className="text-gray-600">sales@GoatTech.vn</p>
          </div>

          <div className="bg-white p-6 rounded-xl shadow-sm text-center">
            <div className="bg-green-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
              <MapPin className="w-8 h-8 text-green-600" />
            </div>
            <h3 className="font-semibold text-lg mb-2">Äá»‹a Chá»‰</h3>
            <p className="text-gray-600">Khu phá»‘ 6, P.Linh Trung</p>
            <p className="text-gray-600">Ho Chi Minh City, Vietnam</p>
          </div>

          <div className="bg-white p-6 rounded-xl shadow-sm text-center">
            <div className="bg-orange-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
              <Clock className="w-8 h-8 text-orange-600" />
            </div>
            <h3 className="font-semibold text-lg mb-2">Giá» LÃ m Viá»‡c</h3>
            <p className="text-gray-600">T2 - T6: 9:00 - 18:00</p>
            <p className="text-gray-600">T7 - CN: 10:00 - 17:00</p>
          </div>
        </div>

        {/* Contact Form */}
        <div className="grid grid-cols-1 lg:grid-cols-2 gap-12">
          <div>
            <h2 className="text-3xl font-bold mb-6">Gá»­i Tin Nháº¯n Cho ChÃºng TÃ´i</h2>
            <p className="text-gray-600 mb-8">
              Äiá»n thÃ´ng tin vÃ o form bÃªn dÆ°á»›i vÃ  chÃºng tÃ´i sáº½ pháº£n há»“i trong vÃ²ng 24 giá».
            </p>

            <form onSubmit={handleSubmit} className="space-y-6">
              <div>
                <label className="block text-sm font-semibold mb-2">Há» vÃ  TÃªn *</label>
                <input
                  type="text"
                  name="name"
                  value={formData.name}
                  onChange={handleInputChange}
                  placeholder="Nguyá»…n VÄƒn A"
                  className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-600"
                  required
                />
              </div>

              <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                  <label className="block text-sm font-semibold mb-2">Email *</label>
                  <input
                    type="email"
                    name="email"
                    value={formData.email}
                    onChange={handleInputChange}
                    placeholder="email@example.com"
                    className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-600"
                    required
                  />
                </div>

                <div>
                  <label className="block text-sm font-semibold mb-2">Sá»‘ Äiá»‡n Thoáº¡i</label>
                  <input
                    type="tel"
                    name="phone"
                    value={formData.phone}
                    onChange={handleInputChange}
                    placeholder="0123 456 789"
                    className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-600"
                  />
                </div>
              </div>

              <div>
                <label className="block text-sm font-semibold mb-2">Chá»§ Äá» *</label>
                <select
                  name="subject"
                  value={formData.subject}
                  onChange={handleInputChange}
                  className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-600"
                  required
                >
                  <option value="">Chá»n chá»§ Ä‘á»</option>
                  <option value="order">ÄÆ¡n HÃ ng</option>
                  <option value="product">Sáº£n Pháº©m</option>
                  <option value="shipping">Váº­n Chuyá»ƒn</option>
                  <option value="return">HoÃ n Tráº£</option>
                  <option value="other">KhÃ¡c</option>
                </select>
              </div>

              <div>
                <label className="block text-sm font-semibold mb-2">Tin Nháº¯n *</label>
                <textarea
                  name="message"
                  value={formData.message}
                  onChange={handleInputChange}
                  placeholder="Ná»™i dung tin nháº¯n cá»§a báº¡n..."
                  rows={6}
                  className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-600 resize-none"
                  required
                />
              </div>

              <button
                type="submit"
                className="w-full bg-gradient-to-r from-purple-600 to-pink-600 text-white py-4 rounded-lg font-semibold hover:from-purple-700 hover:to-pink-700 transition flex items-center justify-center gap-2"
              >
                <Send className="w-5 h-5" />
                Gá»­i Tin Nháº¯n
              </button>
            </form>
          </div>

          {/* Map or Additional Info */}
          <div>
            <h2 className="text-3xl font-bold mb-6">TÃ¬m ChÃºng TÃ´i</h2>
            <div className="bg-gray-200 rounded-xl overflow-hidden mb-6" style={{ height: '400px' }}>
              <iframe
                src="https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d3919.4989654716707!2d106.69822631533431!3d10.772466862169026!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x31752f4b3330bcc9%3A0x5a8b0f0c00dbf5e6!2zTmd1eeG7hW4gSHXhu4csIFF1YW4gMSwgVGjDoG5oIHBo4buRIEjhu5MgQ2jDrSBNaW5o!5e0!3m2!1svi!2s!4v1234567890123!5m2!1svi!2s"
                width="100%"
                height="100%"
                style={{ border: 0 }}
                allowFullScreen
                loading="lazy"
                referrerPolicy="no-referrer-when-downgrade"
              />
            </div>

            <div className="bg-gradient-to-r from-purple-100 to-pink-100 p-6 rounded-xl">
              <h3 className="font-semibold text-lg mb-4">CÃ¢u Há»i ThÆ°á»ng Gáº·p</h3>
              <ul className="space-y-3 text-gray-700">
                <li className="flex items-start gap-2">
                  <span className="text-pink-600 font-bold">â€¢</span>
                  <span>Thá»i gian giao hÃ ng: 2-5 ngÃ y lÃ m viá»‡c</span>
                </li>
                <li className="flex items-start gap-2">
                  <span className="text-pink-600 font-bold">â€¢</span>
                  <span>ChÃ­nh sÃ¡ch Ä‘á»•i tráº£ trong vÃ²ng 30 ngÃ y</span>
                </li>
                <li className="flex items-start gap-2">
                  <span className="text-pink-600 font-bold">â€¢</span>
                  <span>Miá»…n phÃ­ váº­n chuyá»ƒn Ä‘Æ¡n hÃ ng trÃªn 100K</span>
                </li>
                <li className="flex items-start gap-2">
                  <span className="text-pink-600 font-bold">â€¢</span>
                  <span>Báº£o hÃ nh 12 thÃ¡ng cho táº¥t cáº£ sáº£n pháº©m</span>
                </li>
              </ul>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
};

export default ContactPage;




################################################################################
## FILE 105: page.tsx
## Path: fontend/src/app/(public)/login/page.tsx
################################################################################

'use client';

import { useState } from 'react';
import { useRouter } from 'next/navigation';
import { loginCustomer } from '@/lib/api-client';
import Link from 'next/link';
import { Mail, Lock, AlertCircle, User, LogOut, Settings, ShoppingBag, Heart, Edit, Eye, EyeOff } from 'lucide-react';
import { useAuth } from '@/contexts/AuthContext';

export default function LoginPage() {
  const router = useRouter();
  const { user, isAuthenticated, login, logout, getDisplayName, loading , is_admin } = useAuth();
  const [formData, setFormData] = useState({
    email: '',
    password: '',
  });
  const [submitLoading, setSubmitLoading] = useState(false);
  const [error, setError] = useState('');
  const [showPassword, setShowPassword] = useState(false);

  const handleChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    setFormData({
      ...formData,
      [e.target.name]: e.target.value,
    });
    setError('');
  };

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    setError('');

    // Validation
    if (!formData.email || !formData.password) {
      setError('Vui lÃ²ng Ä‘iá»n Ä‘áº§y Ä‘á»§ thÃ´ng tin');
      return;
    }

    if (!formData.email.includes('@')) {
      setError('Email khÃ´ng há»£p lá»‡');
      return;
    }

    setSubmitLoading(true);

    try {
      const result = await loginCustomer(formData.email, formData.password);

      if (result.success) {
        const user = result.customer || result.user;
        
        // ðŸ”§ Sá»¬A: LÆ°u access_token vÃ o cÃ¹ng vá»›i user data
        const customerData = {
          ...user,
          access_token: result.access_token,
        };
        
        localStorage.setItem('customer', JSON.stringify(customerData));
        
        const isAdmin = result.role === 'admin' || 
                        user?.role === 'admin' || 
                        user?.email?.toLowerCase().includes('admin');
        
        localStorage.setItem('userRole', isAdmin ? 'admin' : 'customer');
        
        // ðŸ”§ Sá»¬A: DÃ¹ng login() tá»« useAuth() thay vÃ¬ setLoggedInUser
        login(customerData);
        
        if (isAdmin) {
          router.push('/admin');
        } else {
          router.push('/');
        }
      } else {
        setError(result.message || 'ÄÄƒng nháº­p tháº¥t báº¡i');
      }
    } catch (err: any) {
      console.error('Login error:', err);
      setError('CÃ³ lá»—i xáº£y ra, vui lÃ²ng thá»­ láº¡i');
    } finally {
      setSubmitLoading(false);
    }
  };

  const handleLogout = () => {
    logout();
    localStorage.removeItem('userRole');
  };

  const getUserRole = () => {
    const role = localStorage.getItem('userRole');
    return role === 'admin' ? 'Quáº£n trá»‹ viÃªn' : 'KhÃ¡ch hÃ ng';
  };

  // Loading state
  if (loading) {
    return (
      <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex items-center justify-center">
        <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
      </div>
    );
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // Náº¾U ÄÃƒ ÄÄ‚NG NHáº¬P - HIá»‚N THá»Š THÃ”NG TIN TÃ€I KHOáº¢N
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  if (isAuthenticated && user) {
    return (
      <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 py-12 px-4 sm:px-6 lg:px-8">
        <div className="max-w-2xl mx-auto">
          <div className="bg-white rounded-2xl shadow-2xl overflow-hidden">
            {/* Header vá»›i avatar */}
            <div className="bg-gradient-to-r from-blue-600 to-indigo-600 px-8 py-10 text-center">
              <div className="w-24 h-24 bg-white rounded-full mx-auto flex items-center justify-center text-3xl font-bold text-blue-600 shadow-lg">
                {getDisplayName().charAt(0).toUpperCase()}
              </div>
              <h2 className="mt-4 text-2xl font-bold text-white">
                {getDisplayName()}
              </h2>
              <p className="mt-1 text-blue-100">{user.email}</p>
              <span className="inline-block mt-3 px-4 py-1 bg-white/20 rounded-full text-sm text-white">
                {getUserRole()}
              </span>
            </div>

            {/* ThÃ´ng tin chi tiáº¿t */}
            <div className="p-8">
              <h3 className="text-lg font-semibold text-gray-900 mb-4">
                ThÃ´ng tin tÃ i khoáº£n
              </h3>

              <div className="space-y-4">
                <div className="flex items-center justify-between py-3 border-b border-gray-100">
                  <div className="flex items-center gap-3">
                    <Mail className="w-5 h-5 text-gray-400" />
                    <span className="text-gray-600">Email</span>
                  </div>
                  <span className="text-gray-900 font-medium">{user.email}</span>
                </div>

                <div className="flex items-center justify-between py-3 border-b border-gray-100">
                  <div className="flex items-center gap-3">
                    <User className="w-5 h-5 text-gray-400" />
                    <span className="text-gray-600">Há» vÃ  tÃªn</span>
                  </div>
                  <span className="text-gray-900 font-medium">{getDisplayName()}</span>
                </div>

                {user.phone && (
                  <div className="flex items-center justify-between py-3 border-b border-gray-100">
                    <div className="flex items-center gap-3">
                      <span className="text-gray-400">ðŸ“±</span>
                      <span className="text-gray-600">Sá»‘ Ä‘iá»‡n thoáº¡i</span>
                    </div>
                    <span className="text-gray-900 font-medium">{user.phone}</span>
                  </div>
                )}

                <div className="flex items-center justify-between py-3 border-b border-gray-100">
                  <div className="flex items-center gap-3">
                    <Settings className="w-5 h-5 text-gray-400" />
                    <span className="text-gray-600">Vai trÃ²</span>
                  </div>
                  <span className={`px-3 py-1 rounded-full text-sm font-medium ${
                    user.role === 'admin' || user.is_admin
                      ? 'bg-purple-100 text-purple-700' 
                      : 'bg-green-100 text-green-700'
                  }`}>
                    {getUserRole()}
                  </span>
                </div>
              </div>

              {/* Action buttons */}
              <div className="mt-8 grid grid-cols-2 gap-4">
                <Link
                  href="/account"
                  className="flex items-center justify-center gap-2 px-4 py-3 bg-blue-50 text-blue-600 rounded-lg hover:bg-blue-100 transition font-medium"
                >
                  <Edit className="w-5 h-5" />
                  Chá»‰nh sá»­a
                </Link>

                <Link
                  href="/orders"
                  className="flex items-center justify-center gap-2 px-4 py-3 bg-green-50 text-green-600 rounded-lg hover:bg-green-100 transition font-medium"
                >
                  <ShoppingBag className="w-5 h-5" />
                  ÄÆ¡n hÃ ng
                </Link>

                <Link
                  href="/wishlist"
                  className="flex items-center justify-center gap-2 px-4 py-3 bg-pink-50 text-pink-600 rounded-lg hover:bg-pink-100 transition font-medium"
                >
                  <Heart className="w-5 h-5" />
                  YÃªu thÃ­ch
                </Link>

                <button
                  onClick={handleLogout}
                  className="flex items-center justify-center gap-2 px-4 py-3 bg-red-50 text-red-600 rounded-lg hover:bg-red-100 transition font-medium"
                >
                  <LogOut className="w-5 h-5" />
                  ÄÄƒng xuáº¥t
                </button>
              </div>

              {(user.role === 'admin' || user.is_admin) && (
                <Link
                  href="/admin"
                  className="mt-4 w-full flex items-center justify-center gap-2 px-4 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition font-medium"
                >
                  <Settings className="w-5 h-5" />
                  Trang quáº£n trá»‹
                </Link>
              )}
            </div>
          </div>

          <div className="mt-6 text-center">
            <Link href="/shop" className="text-blue-600 hover:text-blue-700 font-medium">
              â† Tiáº¿p tá»¥c mua sáº¯m
            </Link>
          </div>
        </div>
      </div>
    );
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // CHÆ¯A ÄÄ‚NG NHáº¬P - HIá»‚N THá»Š FORM ÄÄ‚NG NHáº¬P
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  return (
    <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex items-center justify-center py-12 px-4 sm:px-6 lg:px-8">
      <div className="max-w-md w-full space-y-8 bg-white p-10 rounded-2xl shadow-2xl">
        <div>
          <h2 className="text-center text-4xl font-extrabold text-gray-900">ÄÄƒng nháº­p</h2>
          <p className="mt-2 text-center text-sm text-gray-600">
            Hoáº·c{' '}
            <Link href="/register" className="font-medium text-blue-600 hover:text-blue-500">
              Táº¡o tÃ i khoáº£n má»›i
            </Link>
          </p>
        </div>

        {error && (
          <div className="bg-red-50 border-l-4 border-red-500 p-4 rounded">
            <div className="flex items-center">
              <AlertCircle className="h-5 w-5 text-red-500 mr-2" />
              <p className="text-sm text-red-700">{error}</p>
            </div>
          </div>
        )}

        <form className="mt-8 space-y-6" onSubmit={handleSubmit}>
          <div className="space-y-4">
            {/* Email */}
            <div>
              <label htmlFor="email" className="block text-sm font-medium text-gray-700 mb-1">
                Email
              </label>
              <div className="relative">
                <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                  <Mail className="h-5 w-5 text-gray-400" />
                </div>
                <input
                  id="email"
                  name="email"
                  type="email"
                  autoComplete="email"
                  required
                  value={formData.email}
                  onChange={handleChange}
                  className="block w-full pl-10 pr-3 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-gray-900"
                  placeholder="example@email.com"
                />
              </div>
            </div>

            {/* Password */}
            <div>
              <label htmlFor="password" className="block text-sm font-medium text-gray-700 mb-1">
                Máº­t kháº©u
              </label>
              <div className="relative">
                <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                  <Lock className="h-5 w-5 text-gray-400" />
                </div>
                <input
                  id="password"
                  name="password"
                  type={showPassword ? 'text' : 'password'}
                  autoComplete="current-password"
                  required
                  value={formData.password}
                  onChange={handleChange}
                  className="block w-full pl-10 pr-10 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-gray-900"
                  placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"
                />
                <button
                  type="button"
                  onClick={() => setShowPassword(!showPassword)}
                  className="absolute inset-y-0 right-0 pr-3 flex items-center"
                >
                  {showPassword ? (
                    <EyeOff className="h-5 w-5 text-gray-400 hover:text-gray-600" />
                  ) : (
                    <Eye className="h-5 w-5 text-gray-400 hover:text-gray-600" />
                  )}
                </button>
              </div>
            </div>
          </div>

          {/* Remember & Forgot */}
          <div className="flex items-center justify-between">
            <div className="flex items-center">
              <input
                id="remember-me"
                name="remember-me"
                type="checkbox"
                className="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"
              />
              <label htmlFor="remember-me" className="ml-2 block text-sm text-gray-900">
                Ghi nhá»› Ä‘Äƒng nháº­p
              </label>
            </div>
            <div className="text-sm">
              <Link href="/forgot-password" className="font-medium text-blue-600 hover:text-blue-500">
                QuÃªn máº­t kháº©u?
              </Link>
            </div>
          </div>

          {/* Submit Button */}
          <div>
            <button
              type="submit"
              disabled={submitLoading}
              className={`w-full flex justify-center py-3 px-4 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white ${
                submitLoading
                  ? 'bg-blue-400 cursor-not-allowed'
                  : 'bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500'
              }`}
            >
              {submitLoading ? (
                <span className="flex items-center">
                  <svg className="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                    <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                  </svg>
                  Äang xá»­ lÃ½...
                </span>
              ) : (
                'ÄÄƒng nháº­p'
              )}
            </button>
          </div>
        </form>
      </div>
    </div>
  );
}



################################################################################
## FILE 106: page.tsx
## Path: fontend/src/app/(public)/order/page.tsx
################################################################################

'use client';

import React, { useEffect, useState } from 'react';
import Link from 'next/link';
import { fetchMyOrders } from '@/lib/api-client';
import { Package, ArrowRight, Clock, CheckCircle, XCircle } from 'lucide-react';

interface Order {
  order_id: number;
  order_number: string;
  order_status: string;
  total_amount: number;
  created_at: string;
}

export default function OrdersPage() {
  const [orders, setOrders] = useState<Order[]>([]);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    loadOrders();
  }, []);

  const loadOrders = async () => {
    setLoading(true);
    try {
      const data = await fetchMyOrders();
      setOrders(data || []);
    } catch (err) {
      console.error('Fetch orders error', err);
    } finally {
      setLoading(false);
    }
  };

  const statusBadge = (status: string) => {
    switch (status) {
      case 'pending':
        return (
          <span className="flex items-center gap-1 text-yellow-700">
            <Clock className="w-4 h-4" /> Chá» xá»­ lÃ½
          </span>
        );
      case 'delivered':
        return (
          <span className="flex items-center gap-1 text-green-700">
            <CheckCircle className="w-4 h-4" /> ÄÃ£ giao
          </span>
        );
      case 'cancelled':
        return (
          <span className="flex items-center gap-1 text-red-700">
            <XCircle className="w-4 h-4" /> ÄÃ£ há»§y
          </span>
        );
      default:
        return status;
    }
  };

  if (loading) {
    return (
      <div className="min-h-screen flex justify-center items-center">
        <div className="animate-spin h-12 w-12 border-4 border-pink-600 border-t-transparent rounded-full" />
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-gray-50 py-10">
      <div className="max-w-5xl mx-auto px-4">
        <h1 className="text-2xl font-bold mb-6 flex items-center gap-2">
          <Package className="w-6 h-6 text-pink-600" />
          ÄÆ¡n hÃ ng cá»§a tÃ´i
        </h1>

        {orders.length === 0 ? (
          <div className="bg-white p-10 rounded-xl text-center shadow">
            <p className="text-gray-500 mb-4">
              Báº¡n chÆ°a cÃ³ Ä‘Æ¡n hÃ ng nÃ o
            </p>
            <Link
              href="/shop"
              className="inline-block bg-pink-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-pink-700"
            >
              Mua sáº¯m ngay
            </Link>
          </div>
        ) : (
          <div className="space-y-4">
            {orders.map((order) => (
              <div
                key={order.order_id}
                className="bg-white rounded-xl shadow p-5 flex justify-between items-center"
              >
                <div>
                  <p className="font-semibold text-lg">
                    #{order.order_number}
                  </p>
                  <p className="text-sm text-gray-500">
                    {new Date(order.created_at).toLocaleString('vi-VN')}
                  </p>
                  <div className="mt-1">
                    {statusBadge(order.order_status)}
                  </div>
                </div>

                <div className="text-right">
                  <p className="font-bold text-pink-600 text-lg">
                    {order.total_amount.toLocaleString('vi-VN')}â‚«
                  </p>
                  <Link
                    href={`/order/${order.order_number}`}
                    className="inline-flex items-center gap-1 text-sm text-pink-600 hover:underline mt-2"
                  >
                    Xem chi tiáº¿t <ArrowRight className="w-4 h-4" />
                  </Link>
                </div>
              </div>
            ))}
          </div>
        )}
      </div>
    </div>
  );
}




################################################################################
## FILE 107: page.tsx
## Path: fontend/src/app/(public)/order/[orderNumber]/page.tsx
################################################################################

'use client';

import React, { useState, useEffect } from 'react';
import { useParams } from 'next/navigation';
import Link from 'next/link';
import { fetchOrderByNumber } from '@/lib/api-client';
import { 
  ArrowLeft, 
  Package, 
  Truck, 
  CheckCircle, 
  Clock, 
  XCircle,
  MapPin,
  Phone,
  CreditCard,
  Calendar
} from 'lucide-react';

interface OrderItem {
  order_item_id: number;
  product_id: number;
  product_name: string;
  variant_name?: string;
  quantity: number;
  unit_price: number;
  total_price: number;
  image_url?: string;
}

interface Order {
  order_id: number;
  order_number: string;
  order_status: string;
  payment_status: string;
  payment_method: string;
  subtotal: number;
  discount_amount: number;
  shipping_fee: number;
  total_amount: number;
  tracking_number?: string;
  created_at: string;
  items: OrderItem[];
  shipping_full_name?: string;
  shipping_phone?: string;
  shipping_address?: string;
  shipping_ward?: string;
  shipping_district?: string;
  shipping_city?: string;
}

export default function OrderDetailPage() {
  const params = useParams();
  const orderNumber = params.orderNumber as string;
  
  const [order, setOrder] = useState<Order | null>(null);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    if (orderNumber) {
      loadOrder();
    }
  }, [orderNumber]);

  const loadOrder = async () => {
    setLoading(true);
    try {
      const data = await fetchOrderByNumber(orderNumber);
      setOrder(data);
    } catch (error) {
      console.error('Load order error:', error);
    } finally {
      setLoading(false);
    }
  };

  const getStatusInfo = (status: string) => {
    const statuses: Record<string, { label: string; color: string; icon: React.ReactNode }> = {
      pending: { label: 'Chá» xá»­ lÃ½', color: 'bg-yellow-100 text-yellow-700', icon: <Clock className="w-5 h-5" /> },
      confirmed: { label: 'ÄÃ£ xÃ¡c nháº­n', color: 'bg-blue-100 text-blue-700', icon: <CheckCircle className="w-5 h-5" /> },
      processing: { label: 'Äang chuáº©n bá»‹', color: 'bg-purple-100 text-purple-700', icon: <Package className="w-5 h-5" /> },
      shipped: { label: 'Äang giao hÃ ng', color: 'bg-indigo-100 text-indigo-700', icon: <Truck className="w-5 h-5" /> },
      delivered: { label: 'ÄÃ£ giao hÃ ng', color: 'bg-green-100 text-green-700', icon: <CheckCircle className="w-5 h-5" /> },
      cancelled: { label: 'ÄÃ£ há»§y', color: 'bg-red-100 text-red-700', icon: <XCircle className="w-5 h-5" /> },
    };
    return statuses[status] || statuses.pending;
  };

  const formatPrice = (price: number) => price.toLocaleString('vi-VN') + 'â‚«';
  const formatDate = (dateString: string) => new Date(dateString).toLocaleString('vi-VN');

  if (loading) {
    return (
      <div className="min-h-screen bg-gray-50 flex items-center justify-center">
        <div className="animate-spin rounded-full h-16 w-16 border-t-4 border-pink-600"></div>
      </div>
    );
  }

  if (!order) {
    return (
      <div className="min-h-screen bg-gray-50 flex items-center justify-center">
        <div className="text-center">
          <div className="text-6xl mb-4">ðŸ“¦</div>
          <h2 className="text-2xl font-bold mb-2">KhÃ´ng tÃ¬m tháº¥y Ä‘Æ¡n hÃ ng</h2>
          <p className="text-gray-500 mb-4">MÃ£ Ä‘Æ¡n hÃ ng: {orderNumber}</p>
          <Link href="/" className="text-pink-600 hover:underline">
            â† Quay láº¡i trang chá»§
          </Link>
        </div>
      </div>
    );
  }

  const statusInfo = getStatusInfo(order.order_status);

  return (
    <div className="min-h-screen bg-gray-50 py-8">
      <div className="max-w-5xl mx-auto px-4">
        {/* Header */}
        <div className="flex items-center justify-between mb-6">
          <div>
            <Link href="/account" className="flex items-center gap-2 text-gray-600 hover:text-pink-600 mb-2">
              <ArrowLeft className="w-4 h-4" />
              Quay láº¡i
            </Link>
            <h1 className="text-2xl font-bold">ÄÆ¡n hÃ ng #{order.order_number}</h1>
            <p className="text-gray-500 text-sm flex items-center gap-2 mt-1">
              <Calendar className="w-4 h-4" />
              Äáº·t ngÃ y: {formatDate(order.created_at)}
            </p>
          </div>
          <div className={`flex items-center gap-2 px-4 py-2 rounded-full ${statusInfo.color}`}>
            {statusInfo.icon}
            <span className="font-medium">{statusInfo.label}</span>
          </div>
        </div>

        <div className="grid lg:grid-cols-3 gap-6">
          {/* Order Items */}
          <div className="lg:col-span-2 space-y-6">
            <div className="bg-white rounded-2xl p-6 shadow-sm">
              <h2 className="font-bold text-lg mb-4 flex items-center gap-2">
                <Package className="w-5 h-5 text-pink-600" />
                Sáº£n pháº©m Ä‘Ã£ Ä‘áº·t ({order.items?.length || 0})
              </h2>
              <div className="space-y-4">
                {order.items?.map((item) => (
                  <div key={item.order_item_id} className="flex gap-4 pb-4 border-b last:border-0 last:pb-0">
                    <div className="w-20 h-20 bg-gray-100 rounded-lg overflow-hidden flex-shrink-0">
                      <img
                        src={item.image_url || '/placeholder.png'}
                        alt={item.product_name}
                        className="w-full h-full object-cover"
                      />
                    </div>
                    <div className="flex-1">
                      <h3 className="font-medium">{item.product_name}</h3>
                      {item.variant_name && (
                        <p className="text-sm text-gray-500">PhÃ¢n loáº¡i: {item.variant_name}</p>
                      )}
                      <div className="flex justify-between items-end mt-2">
                        <span className="text-sm text-gray-600">
                          {formatPrice(item.unit_price)} x {item.quantity}
                        </span>
                        <span className="font-semibold text-pink-600">{formatPrice(item.total_price)}</span>
                      </div>
                    </div>
                  </div>
                ))}
              </div>
            </div>

            {/* Tracking Info */}
            {order.tracking_number && (
              <div className="bg-white rounded-2xl p-6 shadow-sm">
                <h2 className="font-bold text-lg mb-4 flex items-center gap-2">
                  <Truck className="w-5 h-5 text-blue-600" />
                  Theo dÃµi Ä‘Æ¡n hÃ ng
                </h2>
                <div className="flex items-center gap-3 bg-blue-50 p-4 rounded-xl">
                  <Truck className="w-6 h-6 text-blue-600" />
                  <div>
                    <p className="text-sm text-gray-600">MÃ£ váº­n Ä‘Æ¡n</p>
                    <p className="font-mono font-semibold">{order.tracking_number}</p>
                  </div>
                </div>
              </div>
            )}
          </div>

          {/* Order Summary */}
          <div className="space-y-6">
            {/* Payment Summary */}
            <div className="bg-white rounded-2xl p-6 shadow-sm">
              <h2 className="font-bold text-lg mb-4 flex items-center gap-2">
                <CreditCard className="w-5 h-5 text-green-600" />
                Thanh toÃ¡n
              </h2>
              <div className="space-y-3">
                <div className="flex justify-between">
                  <span className="text-gray-600">Táº¡m tÃ­nh</span>
                  <span>{formatPrice(order.subtotal)}</span>
                </div>
                {order.discount_amount > 0 && (
                  <div className="flex justify-between text-green-600">
                    <span>Giáº£m giÃ¡</span>
                    <span>-{formatPrice(order.discount_amount)}</span>
                  </div>
                )}
                <div className="flex justify-between">
                  <span className="text-gray-600">PhÃ­ váº­n chuyá»ƒn</span>
                  <span>{order.shipping_fee === 0 ? 'Miá»…n phÃ­' : formatPrice(order.shipping_fee)}</span>
                </div>
                <div className="border-t pt-3 flex justify-between">
                  <span className="font-bold">Tá»•ng cá»™ng</span>
                  <span className="font-bold text-pink-600 text-xl">{formatPrice(order.total_amount)}</span>
                </div>
                <div className="pt-2">
                  <span className="text-sm text-gray-500">
                    PhÆ°Æ¡ng thá»©c: {order.payment_method === 'cod' ? 'Thanh toÃ¡n khi nháº­n hÃ ng' : 
                                  order.payment_method === 'momo' ? 'VÃ­ MoMo' : 'Chuyá»ƒn khoáº£n'}
                  </span>
                </div>
              </div>
            </div>

            {/* Shipping Address */}
            {order.shipping_full_name && (
              <div className="bg-white rounded-2xl p-6 shadow-sm">
                <h2 className="font-bold text-lg mb-4 flex items-center gap-2">
                  <MapPin className="w-5 h-5 text-purple-600" />
                  Äá»‹a chá»‰ giao hÃ ng
                </h2>
                <div className="space-y-2 text-sm">
                  <p className="font-medium text-base">{order.shipping_full_name}</p>
                  <p className="flex items-center gap-2 text-gray-600">
                    <Phone className="w-4 h-4" />
                    {order.shipping_phone}
                  </p>
                  <p className="flex items-start gap-2 text-gray-600">
                    <MapPin className="w-4 h-4 mt-0.5 flex-shrink-0" />
                    <span>
                      {[
                        order.shipping_address,
                        order.shipping_ward,
                        order.shipping_district,
                        order.shipping_city
                      ].filter(Boolean).join(', ')}
                    </span>
                  </p>
                </div>
              </div>
            )}

            {/* Actions */}
            <div className="space-y-3">
              <Link
                href="/shop"
                className="block w-full text-center bg-gradient-to-r from-pink-600 to-purple-600 text-white py-3 rounded-xl font-semibold hover:from-pink-700 hover:to-purple-700 transition"
              >
                Tiáº¿p tá»¥c mua sáº¯m
              </Link>
              <Link
                href="/contact"
                className="block w-full text-center bg-gray-100 text-gray-700 py-3 rounded-xl font-semibold hover:bg-gray-200 transition"
              >
                LiÃªn há»‡ há»— trá»£
              </Link>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
}



################################################################################
## FILE 108: page.tsx
## Path: fontend/src/app/(public)/order/success/page.tsx
################################################################################

'use client';

import React, { useState } from 'react';
import { useSearchParams } from 'next/navigation';
import Link from 'next/link';
import { CheckCircle, Package, Truck, ArrowRight, Mail, Phone, Copy, Check } from 'lucide-react';

export default function OrderSuccessPage() {
  const searchParams = useSearchParams();
  const [copied, setCopied] = useState(false);
  
  const orderNumber = searchParams.get('orderNumber') || searchParams.get('order') || 'GT' + Date.now();
  const total = searchParams.get('total');

  const handleCopyOrderNumber = () => {
    navigator.clipboard.writeText(orderNumber);
    setCopied(true);
    setTimeout(() => setCopied(false), 2000);
  };

  return (
    <div className="min-h-screen bg-gradient-to-br from-green-50 via-white to-purple-50 py-12 px-4">
      <div className="max-w-2xl mx-auto">
        {/* Success Animation */}
        <div className="text-center mb-8">
          <div className="inline-flex items-center justify-center w-24 h-24 bg-green-100 rounded-full mb-6 animate-bounce">
            <CheckCircle className="w-14 h-14 text-green-600" />
          </div>
          <h1 className="text-3xl md:text-4xl font-bold text-gray-900 mb-4">
            Äáº·t hÃ ng thÃ nh cÃ´ng! ðŸŽ‰
          </h1>
          <p className="text-gray-600 text-lg">
            Cáº£m Æ¡n báº¡n Ä‘Ã£ mua sáº¯m táº¡i GoatTech
          </p>
        </div>

        {/* Order Info Card */}
        <div className="bg-white rounded-2xl shadow-xl p-8 mb-8">
          <div className="text-center mb-6 pb-6 border-b">
            <p className="text-gray-500 mb-2">MÃ£ Ä‘Æ¡n hÃ ng cá»§a báº¡n</p>
            <div className="flex items-center justify-center gap-3">
              <span className="text-2xl font-bold text-pink-600 font-mono">
                {orderNumber}
              </span>
              <button
                onClick={handleCopyOrderNumber}
                className="p-2 rounded-lg bg-gray-100 hover:bg-gray-200 transition"
              >
                {copied ? (
                  <Check className="w-5 h-5 text-green-600" />
                ) : (
                  <Copy className="w-5 h-5 text-gray-500" />
                )}
              </button>
            </div>
            {total && (
              <p className="mt-4 text-lg">
                Tá»•ng thanh toÃ¡n: <span className="font-bold text-pink-600">{parseInt(total).toLocaleString('vi-VN')}â‚«</span>
              </p>
            )}
          </div>

          {/* Order Steps */}
          <div className="mb-6">
            <h3 className="font-semibold mb-4">CÃ¡c bÆ°á»›c tiáº¿p theo:</h3>
            <div className="space-y-4">
              <div className="flex items-start gap-4">
                <div className="flex-shrink-0 w-10 h-10 bg-green-100 rounded-full flex items-center justify-center">
                  <CheckCircle className="w-5 h-5 text-green-600" />
                </div>
                <div>
                  <p className="font-medium">ÄÆ¡n hÃ ng Ä‘Ã£ Ä‘Æ°á»£c xÃ¡c nháº­n</p>
                  <p className="text-sm text-gray-500">ChÃºng tÃ´i Ä‘Ã£ nháº­n Ä‘Æ°á»£c Ä‘Æ¡n hÃ ng cá»§a báº¡n</p>
                </div>
              </div>

              <div className="flex items-start gap-4">
                <div className="flex-shrink-0 w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center">
                  <Package className="w-5 h-5 text-blue-600" />
                </div>
                <div>
                  <p className="font-medium">Äang chuáº©n bá»‹ hÃ ng</p>
                  <p className="text-sm text-gray-500">ÄÆ¡n hÃ ng sáº½ Ä‘Æ°á»£c Ä‘Ã³ng gÃ³i trong 1-2 ngÃ y</p>
                </div>
              </div>

              <div className="flex items-start gap-4">
                <div className="flex-shrink-0 w-10 h-10 bg-purple-100 rounded-full flex items-center justify-center">
                  <Truck className="w-5 h-5 text-purple-600" />
                </div>
                <div>
                  <p className="font-medium">Giao hÃ ng</p>
                  <p className="text-sm text-gray-500">Dá»± kiáº¿n giao trong 2-5 ngÃ y lÃ m viá»‡c</p>
                </div>
              </div>
            </div>
          </div>

          {/* Email Notice */}
          <div className="bg-blue-50 rounded-xl p-4 mb-6">
            <div className="flex items-start gap-3">
              <Mail className="w-5 h-5 text-blue-600 mt-0.5" />
              <div>
                <p className="text-sm font-medium text-blue-900">
                  Email xÃ¡c nháº­n Ä‘Ã£ Ä‘Æ°á»£c gá»­i
                </p>
                <p className="text-sm text-blue-700">
                  Kiá»ƒm tra há»™p thÆ° cá»§a báº¡n Ä‘á»ƒ xem chi tiáº¿t Ä‘Æ¡n hÃ ng.
                </p>
              </div>
            </div>
          </div>

          {/* Action Buttons */}
          <div className="flex flex-col sm:flex-row gap-4">
            <Link
              href={`/order/${orderNumber}`}
              className="flex-1 flex items-center justify-center gap-2 bg-gradient-to-r from-pink-600 to-purple-600 text-white py-3 px-6 rounded-xl font-semibold hover:from-pink-700 hover:to-purple-700 transition"
            >
              Xem chi tiáº¿t Ä‘Æ¡n hÃ ng
              <ArrowRight className="w-5 h-5" />
            </Link>
            <Link
              href="/shop"
              className="flex-1 flex items-center justify-center gap-2 bg-gray-100 text-gray-700 py-3 px-6 rounded-xl font-semibold hover:bg-gray-200 transition"
            >
              Tiáº¿p tá»¥c mua sáº¯m
            </Link>
          </div>
        </div>

        {/* Support Info */}
        <div className="bg-white rounded-2xl shadow-sm p-6 text-center">
          <h3 className="font-semibold mb-4">Cáº§n há»— trá»£?</h3>
          <div className="flex flex-col sm:flex-row justify-center gap-6">
            <a href="tel:1900xxxx" className="flex items-center justify-center gap-2 text-gray-600 hover:text-pink-600">
              <Phone className="w-5 h-5" />
              <span>1900 xxxx</span>
            </a>
            <a href="mailto:support@goattech.vn" className="flex items-center justify-center gap-2 text-gray-600 hover:text-pink-600">
              <Mail className="w-5 h-5" />
              <span>support@goattech.vn</span>
            </a>
          </div>
        </div>

        {/* Promo Banner */}
        <div className="mt-8 bg-gradient-to-r from-purple-600 to-pink-600 rounded-2xl p-6 text-white text-center">
          <h3 className="text-xl font-bold mb-2">Giáº£m 10% cho Ä‘Æ¡n hÃ ng tiáº¿p theo!</h3>
          <p className="text-white/90 mb-4">Sá»­ dá»¥ng mÃ£ <span className="font-mono bg-white/20 px-2 py-1 rounded">THANKYOU10</span></p>
          <Link
            href="/shop"
            className="inline-block bg-white text-pink-600 px-6 py-2 rounded-full font-semibold hover:bg-gray-100 transition"
          >
            Mua sáº¯m ngay
          </Link>
        </div>
      </div>
    </div>
  );
}



################################################################################
## FILE 109: page.tsx
## Path: fontend/src/app/(public)/payment/payment-result/page.tsx
################################################################################

'use client';

import React, { useEffect, useState } from 'react';
import { useSearchParams, useRouter } from 'next/navigation';
import { CheckCircle, XCircle, Clock, ArrowLeft, Receipt } from 'lucide-react';
import Link from 'next/link';

interface PaymentResult {
  resultCode?: string;
  orderId?: string;
  message?: string;
  transId?: string;
  amount?: string;
}

const PaymentResultPage: React.FC = () => {
  const searchParams = useSearchParams();
  const router = useRouter();
  const [result, setResult] = useState<PaymentResult>({});
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    const resultCode = searchParams.get('resultCode');
    const orderId = searchParams.get('orderId');
    const message = searchParams.get('message');
    const transId = searchParams.get('transId');
    const amount = searchParams.get('amount');

    setResult({
      resultCode: resultCode || undefined,
      orderId: orderId || undefined,
      message: message || undefined,
      transId: transId || undefined,
      amount: amount || undefined,
    });
    setLoading(false);
  }, [searchParams]);

  const isSuccess = result.resultCode === '0';
  const isPending = result.resultCode === '9000';
  const isFailed = result.resultCode && result.resultCode !== '0' && result.resultCode !== '9000';

  if (loading) {
    return (
      <div className="min-h-screen bg-gradient-to-br from-purple-50 via-pink-50 to-blue-50 flex items-center justify-center">
        <div className="animate-spin rounded-full h-16 w-16 border-t-4 border-pink-600"></div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-gradient-to-br from-purple-50 via-pink-50 to-blue-50 py-12 px-4">
      <div className="max-w-2xl mx-auto">
        {/* Header vá»›i logo */}
        <div className="text-center mb-8">
          <Link href="/" className="inline-flex items-center gap-2 text-3xl font-bold">
            <span className="bg-gradient-to-r from-pink-600 to-purple-600 bg-clip-text text-transparent">
              Goat
            </span>
            <span className="text-gray-800">Tech</span>
          </Link>
        </div>

        {/* Card káº¿t quáº£ */}
        <div className="bg-white rounded-2xl shadow-xl p-8 md:p-12">
          {/* Icon tráº¡ng thÃ¡i */}
          <div className="text-center mb-6">
            {isSuccess && (
              <div className="inline-flex items-center justify-center w-20 h-20 bg-green-100 rounded-full mb-4">
                <CheckCircle className="w-12 h-12 text-green-600" />
              </div>
            )}
            {isPending && (
              <div className="inline-flex items-center justify-center w-20 h-20 bg-yellow-100 rounded-full mb-4">
                <Clock className="w-12 h-12 text-yellow-600" />
              </div>
            )}
            {isFailed && (
              <div className="inline-flex items-center justify-center w-20 h-20 bg-red-100 rounded-full mb-4">
                <XCircle className="w-12 h-12 text-red-600" />
              </div>
            )}
          </div>

          {/* TiÃªu Ä‘á» */}
          <h1 className="text-3xl font-bold text-center mb-2">
            {isSuccess && <span className="text-green-600">Thanh ToÃ¡n ThÃ nh CÃ´ng!</span>}
            {isPending && <span className="text-yellow-600">Äang Xá»­ LÃ½</span>}
            {isFailed && <span className="text-red-600">Thanh ToÃ¡n Tháº¥t Báº¡i</span>}
          </h1>

          {/* ThÃ´ng bÃ¡o */}
          <p className="text-gray-600 text-center mb-8">
            {isSuccess && 'Cáº£m Æ¡n báº¡n Ä‘Ã£ mua hÃ ng táº¡i GoatTech. ÄÆ¡n hÃ ng cá»§a báº¡n Ä‘Ã£ Ä‘Æ°á»£c xÃ¡c nháº­n.'}
            {isPending && 'Giao dá»‹ch Ä‘ang Ä‘Æ°á»£c xá»­ lÃ½. Vui lÃ²ng Ä‘á»£i trong giÃ¢y lÃ¡t.'}
            {isFailed && result.message || 'Giao dá»‹ch khÃ´ng thÃ nh cÃ´ng. Vui lÃ²ng thá»­ láº¡i.'}
          </p>

          {/* ThÃ´ng tin chi tiáº¿t */}
          <div className="bg-gray-50 rounded-xl p-6 mb-8 space-y-4">
            <div className="flex items-center gap-2 text-gray-600 mb-4">
              <Receipt className="w-5 h-5" />
              <span className="font-semibold">Chi Tiáº¿t Giao Dá»‹ch</span>
            </div>

            {result.orderId && (
              <div className="flex justify-between items-center py-2 border-b border-gray-200">
                <span className="text-gray-600">MÃ£ Ä‘Æ¡n hÃ ng:</span>
                <span className="font-semibold text-gray-800">{result.orderId}</span>
              </div>
            )}

            {result.transId && (
              <div className="flex justify-between items-center py-2 border-b border-gray-200">
                <span className="text-gray-600">MÃ£ giao dá»‹ch:</span>
                <span className="font-semibold text-gray-800">{result.transId}</span>
              </div>
            )}

            {result.amount && (
              <div className="flex justify-between items-center py-2 border-b border-gray-200">
                <span className="text-gray-600">Sá»‘ tiá»n:</span>
                <span className="font-semibold text-pink-600 text-lg">
                  {Number(result.amount).toLocaleString('vi-VN')}â‚«
                </span>
              </div>
            )}

            <div className="flex justify-between items-center py-2">
              <span className="text-gray-600">Tráº¡ng thÃ¡i:</span>
              <span className={`font-semibold ${
                isSuccess ? 'text-green-600' : 
                isPending ? 'text-yellow-600' : 
                'text-red-600'
              }`}>
                {isSuccess && 'ThÃ nh cÃ´ng'}
                {isPending && 'Äang xá»­ lÃ½'}
                {isFailed && 'Tháº¥t báº¡i'}
              </span>
            </div>
          </div>

          {/* NÃºt hÃ nh Ä‘á»™ng */}
          <div className="flex flex-col sm:flex-row gap-4">
            <Link 
              href="/"
              className="flex-1 flex items-center justify-center gap-2 bg-gradient-to-r from-pink-600 to-purple-600 text-white py-3 px-6 rounded-xl hover:from-pink-700 hover:to-purple-700 transition font-medium"
            >
              <ArrowLeft className="w-5 h-5" />
              Vá» Trang Chá»§
            </Link>
            
            {isSuccess && (
              <Link 
                href="/account"
                className="flex-1 flex items-center justify-center gap-2 bg-gray-100 text-gray-800 py-3 px-6 rounded-xl hover:bg-gray-200 transition font-medium"
              >
                Xem ÄÆ¡n HÃ ng
              </Link>
            )}

            {isFailed && (
              <button 
                onClick={() => router.back()}
                className="flex-1 flex items-center justify-center gap-2 bg-gray-100 text-gray-800 py-3 px-6 rounded-xl hover:bg-gray-200 transition font-medium"
              >
                Thá»­ Láº¡i
              </button>
            )}
          </div>

          {/* LÆ°u Ã½ */}
          {isSuccess && (
            <div className="mt-6 p-4 bg-blue-50 rounded-lg border border-blue-200">
              <p className="text-sm text-blue-800">
                <strong>LÆ°u Ã½:</strong> ThÃ´ng tin Ä‘Æ¡n hÃ ng Ä‘Ã£ Ä‘Æ°á»£c gá»­i Ä‘áº¿n email cá»§a báº¡n. 
                Vui lÃ²ng kiá»ƒm tra há»™p thÆ° vÃ  cáº£ thÆ° má»¥c spam.
              </p>
            </div>
          )}
        </div>

        {/* Footer */}
        <div className="text-center mt-8 text-gray-600 text-sm">
          <p>Cáº§n há»— trá»£? LiÃªn há»‡: <a href="mailto:support@goattech.com" className="text-pink-600 hover:underline">support@goattech.com</a></p>
          <p className="mt-1">Hotline: <a href="tel:1900xxxx" className="text-pink-600 hover:underline">1900 xxxx</a></p>
        </div>
      </div>
    </div>
  );
};

export default PaymentResultPage;




################################################################################
## FILE 110: page.tsx
## Path: fontend/src/app/(public)/payment/payment-test/page.tsx
################################################################################

'use client';

import { useState } from 'react';
import { createMomoPayment, checkMomoPaymentStatus } from '@/lib/api-client';
import { CreditCard, DollarSign, FileText, Search } from 'lucide-react';

export default function PaymentTest() {
  const [amount, setAmount] = useState('50000');
  const [orderInfo, setOrderInfo] = useState('Thanh toÃ¡n Ä‘Æ¡n hÃ ng GoatTech');
  const [loading, setLoading] = useState(false);
  const [response, setResponse] = useState<any>(null);
  const [error, setError] = useState<string | null>(null);
  
  // Check status
  const [checkOrderId, setCheckOrderId] = useState('');
  const [checkLoading, setCheckLoading] = useState(false);
  const [checkResponse, setCheckResponse] = useState<any>(null);

  const handlePayment = async () => {
    setLoading(true);
    setError(null);
    setResponse(null);

    try {
      const result = await createMomoPayment({
        amount,
        orderInfo,
      });
      
      setResponse(result);
      console.log('âœ… Payment Created:', result);
      
      // Náº¿u cÃ³ payUrl, tá»± Ä‘á»™ng chuyá»ƒn hÆ°á»›ng
      if (result?.data?.payUrl) {
        setTimeout(() => {
          window.open(result.data.payUrl, '_blank');
        }, 1000);
      }
    } catch (err: any) {
      setError(err.response?.data?.message || err.message || 'Lá»—i khi táº¡o thanh toÃ¡n');
      console.error('âŒ Payment Error:', err);
    } finally {
      setLoading(false);
    }
  };

  const handleCheckStatus = async () => {
    if (!checkOrderId.trim()) {
      alert('Vui lÃ²ng nháº­p Order ID');
      return;
    }

    setCheckLoading(true);
    setCheckResponse(null);

    try {
      const result = await checkMomoPaymentStatus(checkOrderId);
      setCheckResponse(result);
      console.log('ðŸ“Š Status:', result);
    } catch (err: any) {
      console.error('âŒ Check Status Error:', err);
      setCheckResponse({ error: err.message });
    } finally {
      setCheckLoading(false);
    }
  };

  return (
    <main className="min-h-screen bg-gradient-to-br from-purple-50 via-pink-50 to-blue-50 p-8">
      <div className="max-w-4xl mx-auto">
        <h1 className="text-4xl font-bold text-center mb-8 bg-gradient-to-r from-pink-600 to-purple-600 bg-clip-text text-transparent">
          Test Thanh ToÃ¡n MoMo
        </h1>

        <div className="grid md:grid-cols-2 gap-6">
          {/* Card táº¡o thanh toÃ¡n */}
          <div className="bg-white rounded-2xl shadow-xl p-6">
            <div className="flex items-center gap-3 mb-6">
              <div className="p-3 bg-pink-100 rounded-xl">
                <CreditCard className="w-6 h-6 text-pink-600" />
              </div>
              <h2 className="text-2xl font-bold text-gray-800">Táº¡o Thanh ToÃ¡n</h2>
            </div>

            {/* Nháº­p sá»‘ tiá»n */}
            <div className="mb-4">
              <label className="flex items-center gap-2 text-sm font-medium mb-2 text-gray-700">
                <DollarSign className="w-4 h-4" />
                Sá»‘ tiá»n (VND)
              </label>
              <input
                type="text"
                value={amount}
                onChange={(e) => setAmount(e.target.value)}
                className="w-full border-2 border-gray-200 rounded-xl px-4 py-3 focus:border-pink-500 focus:outline-none transition"
                placeholder="50000"
              />
            </div>

            {/* Nháº­p mÃ´ táº£ Ä‘Æ¡n hÃ ng */}
            <div className="mb-6">
              <label className="flex items-center gap-2 text-sm font-medium mb-2 text-gray-700">
                <FileText className="w-4 h-4" />
                MÃ´ táº£ Ä‘Æ¡n hÃ ng
              </label>
              <input
                type="text"
                value={orderInfo}
                onChange={(e) => setOrderInfo(e.target.value)}
                className="w-full border-2 border-gray-200 rounded-xl px-4 py-3 focus:border-pink-500 focus:outline-none transition"
                placeholder="Thanh toÃ¡n Ä‘Æ¡n hÃ ng GoatTech"
              />
            </div>

            {/* NÃºt thanh toÃ¡n */}
            <button
              onClick={handlePayment}
              disabled={loading}
              className="w-full bg-gradient-to-r from-pink-600 to-purple-600 hover:from-pink-700 hover:to-purple-700 disabled:from-gray-400 disabled:to-gray-500 text-white font-bold py-3 px-6 rounded-xl transition shadow-lg"
            >
              {loading ? 'â³ Äang xá»­ lÃ½...' : 'ðŸ’³ Táº¡o Thanh ToÃ¡n MoMo'}
            </button>

            {/* Hiá»ƒn thá»‹ lá»—i */}
            {error && (
              <div className="mt-4 p-4 bg-red-50 border-2 border-red-200 text-red-700 rounded-xl">
                <strong>âŒ Lá»—i:</strong> {error}
              </div>
            )}

            {/* Hiá»ƒn thá»‹ káº¿t quáº£ */}
            {response && (
              <div className="mt-4 p-4 bg-green-50 border-2 border-green-200 rounded-xl">
                <strong className="text-green-700">âœ… ThÃ nh cÃ´ng!</strong>
                {response.data?.payUrl && (
                  <div className="mt-3">
                    <a 
                      href={response.data.payUrl} 
                      target="_blank" 
                      rel="noopener noreferrer"
                      className="inline-block bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition"
                    >
                      ðŸ”— Má»Ÿ Link Thanh ToÃ¡n
                    </a>
                  </div>
                )}
                <details className="mt-3">
                  <summary className="cursor-pointer text-sm text-gray-600 hover:text-gray-800">
                    Xem chi tiáº¿t
                  </summary>
                  <pre className="mt-2 text-xs overflow-auto bg-gray-100 p-2 rounded">
                    {JSON.stringify(response, null, 2)}
                  </pre>
                </details>
              </div>
            )}
          </div>

          {/* Card kiá»ƒm tra tráº¡ng thÃ¡i */}
          <div className="bg-white rounded-2xl shadow-xl p-6">
            <div className="flex items-center gap-3 mb-6">
              <div className="p-3 bg-blue-100 rounded-xl">
                <Search className="w-6 h-6 text-blue-600" />
              </div>
              <h2 className="text-2xl font-bold text-gray-800">Kiá»ƒm Tra Tráº¡ng ThÃ¡i</h2>
            </div>

            <div className="mb-4">
              <label className="block text-sm font-medium mb-2 text-gray-700">
                Order ID
              </label>
              <input
                type="text"
                value={checkOrderId}
                onChange={(e) => setCheckOrderId(e.target.value)}
                className="w-full border-2 border-gray-200 rounded-xl px-4 py-3 focus:border-blue-500 focus:outline-none transition"
                placeholder="MOMO1234567890"
              />
            </div>

            <button
              onClick={handleCheckStatus}
              disabled={checkLoading}
              className="w-full bg-gradient-to-r from-blue-600 to-cyan-600 hover:from-blue-700 hover:to-cyan-700 disabled:from-gray-400 disabled:to-gray-500 text-white font-bold py-3 px-6 rounded-xl transition shadow-lg"
            >
              {checkLoading ? 'â³ Äang kiá»ƒm tra...' : 'ðŸ” Kiá»ƒm Tra Tráº¡ng ThÃ¡i'}
            </button>

            {/* Hiá»ƒn thá»‹ káº¿t quáº£ kiá»ƒm tra */}
            {checkResponse && (
              <div className={`mt-4 p-4 rounded-xl border-2 ${
                checkResponse.error 
                  ? 'bg-red-50 border-red-200' 
                  : 'bg-blue-50 border-blue-200'
              }`}>
                {checkResponse.error ? (
                  <div className="text-red-700">
                    <strong>âŒ Lá»—i:</strong> {checkResponse.error}
                  </div>
                ) : (
                  <>
                    <strong className="text-blue-700">ðŸ“Š Káº¿t quáº£:</strong>
                    {checkResponse.data?.resultCode === 0 && (
                      <div className="mt-2 text-green-600 font-semibold">
                        âœ… Thanh toÃ¡n thÃ nh cÃ´ng
                      </div>
                    )}
                    <details className="mt-3">
                      <summary className="cursor-pointer text-sm text-gray-600 hover:text-gray-800">
                        Xem chi tiáº¿t
                      </summary>
                      <pre className="mt-2 text-xs overflow-auto bg-gray-100 p-2 rounded">
                        {JSON.stringify(checkResponse, null, 2)}
                      </pre>
                    </details>
                  </>
                )}
              </div>
            )}
          </div>
        </div>

        {/* HÆ°á»›ng dáº«n */}
        <div className="mt-8 bg-white rounded-2xl shadow-xl p-6">
          <h3 className="text-xl font-bold mb-4 text-gray-800">ðŸ“– HÆ°á»›ng Dáº«n Test</h3>
          <div className="space-y-3 text-gray-600">
            <div className="flex gap-3">
              <span className="font-bold text-pink-600">1.</span>
              <p>Nháº­p sá»‘ tiá»n vÃ  mÃ´ táº£, nháº¥n <strong>"Táº¡o Thanh ToÃ¡n MoMo"</strong></p>
            </div>
            <div className="flex gap-3">
              <span className="font-bold text-pink-600">2.</span>
              <p>Sao chÃ©p <strong>payUrl</strong> hoáº·c nháº¥n nÃºt "Má»Ÿ Link Thanh ToÃ¡n"</p>
            </div>
            <div className="flex gap-3">
              <span className="font-bold text-pink-600">3.</span>
              <p>TrÃªn trang MoMo test, chá»n phÆ°Æ¡ng thá»©c thanh toÃ¡n vÃ  xÃ¡c nháº­n</p>
            </div>
            <div className="flex gap-3">
              <span className="font-bold text-pink-600">4.</span>
              <p>Sau khi thanh toÃ¡n, báº¡n sáº½ Ä‘Æ°á»£c redirect vá» trang káº¿t quáº£</p>
            </div>
            <div className="flex gap-3">
              <span className="font-bold text-pink-600">5.</span>
              <p>Sá»­ dá»¥ng <strong>Order ID</strong> Ä‘á»ƒ kiá»ƒm tra tráº¡ng thÃ¡i thanh toÃ¡n</p>
            </div>
          </div>
          
          <div className="mt-6 p-4 bg-yellow-50 border-2 border-yellow-200 rounded-xl">
            <p className="text-sm text-yellow-800">
              <strong>âš ï¸ LÆ°u Ã½:</strong> ÄÃ¢y lÃ  mÃ´i trÆ°á»ng test cá»§a MoMo. 
              Sá»­ dá»¥ng thÃ´ng tin test Ä‘Æ°á»£c cung cáº¥p bá»Ÿi MoMo Ä‘á»ƒ thanh toÃ¡n.
            </p>
          </div>
        </div>
      </div>
    </main>
  );
}




################################################################################
## FILE 111: page.tsx
## Path: fontend/src/app/(public)/register/page.tsx
################################################################################

'use client';

import React, { useState } from 'react';
import { useRouter } from 'next/navigation';
import Link from 'next/link';
import { Mail, Lock, User, Phone, Eye, EyeOff, AlertCircle, CheckCircle } from 'lucide-react';
import { registerCustomer } from '@/lib/api-client';

export default function RegisterPage() {
  const router = useRouter();
  const [formData, setFormData] = useState({
    email: '',
    password: '',
    confirmPassword: '',
    first_name: '',
    last_name: '',
    phone: '',
  });
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState('');
  const [showPassword, setShowPassword] = useState(false);
  const [agreed, setAgreed] = useState(false);

  const handleChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    setFormData({ ...formData, [e.target.name]: e.target.value });
    setError('');
  };

  const validateForm = () => {
    if (!formData.email || !formData.password || !formData.confirmPassword) {
      setError('Vui lÃ²ng Ä‘iá»n Ä‘áº§y Ä‘á»§ thÃ´ng tin báº¯t buá»™c');
      return false;
    }
    if (!formData.email.includes('@')) {
      setError('Email khÃ´ng há»£p lá»‡');
      return false;
    }
    if (formData.password.length < 6) {
      setError('Máº­t kháº©u pháº£i cÃ³ Ã­t nháº¥t 6 kÃ½ tá»±');
      return false;
    }
    if (formData.password !== formData.confirmPassword) {
      setError('Máº­t kháº©u xÃ¡c nháº­n khÃ´ng khá»›p');
      return false;
    }
    if (!agreed) {
      setError('Vui lÃ²ng Ä‘á»“ng Ã½ vá»›i Ä‘iá»u khoáº£n sá»­ dá»¥ng');
      return false;
    }
    return true;
  };

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    if (!validateForm()) return;

    setLoading(true);
    try {
      const result = await registerCustomer({
        email: formData.email,
        password: formData.password,
        full_name: `${formData.last_name} ${formData.first_name}`.trim(),
        phone: formData.phone,
      });

      if (result.success) {
        alert('ÄÄƒng kÃ½ thÃ nh cÃ´ng! Vui lÃ²ng Ä‘Äƒng nháº­p.');
        router.push('/login');
      } else {
        setError(result.message || 'ÄÄƒng kÃ½ tháº¥t báº¡i');
      }
    } catch (err: any) {
      setError('CÃ³ lá»—i xáº£y ra, vui lÃ²ng thá»­ láº¡i');
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="min-h-screen bg-gradient-to-br from-purple-50 via-pink-50 to-blue-50 flex items-center justify-center py-12 px-4">
      <div className="max-w-md w-full">
        <div className="text-center mb-8">
          <Link href="/" className="inline-flex items-center gap-2 text-3xl font-bold">
            <span className="bg-gradient-to-r from-pink-600 to-purple-600 bg-clip-text text-transparent">Goat</span>
            <span className="text-gray-800">Tech</span>
          </Link>
        </div>

        <div className="bg-white rounded-2xl shadow-xl p-8">
          <h2 className="text-2xl font-bold text-center mb-2">Táº¡o tÃ i khoáº£n má»›i</h2>
          <p className="text-gray-500 text-center mb-8">ÄÄƒng kÃ½ Ä‘á»ƒ nháº­n nhiá»u Æ°u Ä‘Ã£i háº¥p dáº«n</p>

          {error && (
            <div className="mb-6 bg-red-50 border-l-4 border-red-500 p-4 rounded">
              <div className="flex items-center">
                <AlertCircle className="h-5 w-5 text-red-500 mr-2" />
                <p className="text-sm text-red-700">{error}</p>
              </div>
            </div>
          )}

          <form onSubmit={handleSubmit} className="space-y-5">
            <div className="grid grid-cols-2 gap-4">
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">Há»</label>
                <input
                  type="text"
                  name="last_name"
                  value={formData.last_name}
                  onChange={handleChange}
                  className="block w-full px-3 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-pink-500"
                  placeholder="Nguyá»…n"
                />
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">TÃªn</label>
                <input
                  type="text"
                  name="first_name"
                  value={formData.first_name}
                  onChange={handleChange}
                  className="block w-full px-3 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-pink-500"
                  placeholder="VÄƒn A"
                />
              </div>
            </div>

            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">Email *</label>
              <div className="relative">
                <Mail className="absolute left-3 top-1/2 -translate-y-1/2 h-5 w-5 text-gray-400" />
                <input
                  type="email"
                  name="email"
                  value={formData.email}
                  onChange={handleChange}
                  className="block w-full pl-10 pr-3 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-pink-500"
                  placeholder="email@example.com"
                  required
                />
              </div>
            </div>

            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">Sá»‘ Ä‘iá»‡n thoáº¡i</label>
              <div className="relative">
                <Phone className="absolute left-3 top-1/2 -translate-y-1/2 h-5 w-5 text-gray-400" />
                <input
                  type="tel"
                  name="phone"
                  value={formData.phone}
                  onChange={handleChange}
                  className="block w-full pl-10 pr-3 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-pink-500"
                  placeholder="0901234567"
                />
              </div>
            </div>

            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">Máº­t kháº©u *</label>
              <div className="relative">
                <Lock className="absolute left-3 top-1/2 -translate-y-1/2 h-5 w-5 text-gray-400" />
                <input
                  type={showPassword ? 'text' : 'password'}
                  name="password"
                  value={formData.password}
                  onChange={handleChange}
                  className="block w-full pl-10 pr-10 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-pink-500"
                  placeholder="Tá»‘i thiá»ƒu 6 kÃ½ tá»±"
                  required
                />
                <button
                  type="button"
                  onClick={() => setShowPassword(!showPassword)}
                  className="absolute right-3 top-1/2 -translate-y-1/2"
                >
                  {showPassword ? <EyeOff className="h-5 w-5 text-gray-400" /> : <Eye className="h-5 w-5 text-gray-400" />}
                </button>
              </div>
            </div>

            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">XÃ¡c nháº­n máº­t kháº©u *</label>
              <div className="relative">
                <Lock className="absolute left-3 top-1/2 -translate-y-1/2 h-5 w-5 text-gray-400" />
                <input
                  type="password"
                  name="confirmPassword"
                  value={formData.confirmPassword}
                  onChange={handleChange}
                  className="block w-full pl-10 pr-3 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-pink-500"
                  placeholder="Nháº­p láº¡i máº­t kháº©u"
                  required
                />
              </div>
              {formData.confirmPassword && formData.password === formData.confirmPassword && (
                <p className="text-xs text-green-600 mt-1 flex items-center gap-1">
                  <CheckCircle className="w-3 h-3" /> Máº­t kháº©u khá»›p
                </p>
              )}
            </div>

            <div className="flex items-start gap-3">
              <input
                type="checkbox"
                id="agree"
                checked={agreed}
                onChange={(e) => setAgreed(e.target.checked)}
                className="mt-1 h-4 w-4 text-pink-600 focus:ring-pink-500 border-gray-300 rounded"
              />
              <label htmlFor="agree" className="text-sm text-gray-600">
                TÃ´i Ä‘á»“ng Ã½ vá»›i <Link href="/terms" className="text-pink-600 hover:underline">Äiá»u khoáº£n sá»­ dá»¥ng</Link> vÃ  <Link href="/privacy" className="text-pink-600 hover:underline">ChÃ­nh sÃ¡ch báº£o máº­t</Link>
              </label>
            </div>

            <button
              type="submit"
              disabled={loading}
              className="w-full bg-gradient-to-r from-pink-600 to-purple-600 text-white py-3 rounded-xl font-semibold hover:from-pink-700 hover:to-purple-700 transition disabled:opacity-50"
            >
              {loading ? 'Äang xá»­ lÃ½...' : 'ÄÄƒng kÃ½'}
            </button>
          </form>

          <p className="mt-6 text-center text-gray-600">
            ÄÃ£ cÃ³ tÃ i khoáº£n? <Link href="/login" className="text-pink-600 font-medium hover:underline">ÄÄƒng nháº­p ngay</Link>
          </p>
        </div>
      </div>
    </div>
  );
}



################################################################################
## FILE 112: page.tsx
## Path: fontend/src/app/(public)/search/page.tsx
################################################################################





################################################################################
## FILE 113: page.tsx
## Path: fontend/src/app/(public)/shop/page.tsx
################################################################################

'use client';

import { useEffect, useMemo, useState } from 'react';
import Link from 'next/link';
import { useRouter } from 'next/navigation';
import {
  Heart,
  Star,
  Filter,
  X,
  ShoppingCart,
  Smartphone,
} from 'lucide-react';

import { fetchProducts, fetchCategoriesWithCount, createMomoPayment } from '@/lib/api-client';
import { AddToCartButton } from '@/components/products/AddToCartButton';
import { useCart } from '@/app/context/cart-context';
import { useWishlist } from '@/app/context/wishlist-context';
import { useAuth } from '@/contexts/AuthContext';

/* ===================== TYPES ===================== */
interface Product {
  id: number;
  name: string;
  price: number;
  sale_price?: number;
  image_url: string;
  rating: number;
  reviews: number;
  tag?: string;
  category: string;
  categoryId: number;
}

interface Category {
  category_id: number;
  category_name: string;
  product_count: number;
}

interface CartItem extends Product {
  quantity: number;
}

/* ===================== PAGE ===================== */
export default function ShopPage() {
  /* ---------- State ---------- */
  const [products, setProducts] = useState<Product[]>([]);
  const [categories, setCategories] = useState<Category[]>([]);
  const [loading, setLoading] = useState(true);

  const [isCartOpen, setIsCartOpen] = useState(false);
  const [cartItems, setCartItems] = useState<CartItem[]>([]);
  const [checkoutLoading, setCheckoutLoading] = useState(false);

  const [isFilterOpen, setIsFilterOpen] = useState(false);
  const [selectedCategory, setSelectedCategory] = useState('Táº¥t Cáº£');
  const [sortBy, setSortBy] = useState<'newest' | 'price-low' | 'price-high' | 'rating'>('newest');
  const [priceRange, setPriceRange] = useState<[number, number]>([0, 9_999_999]);
  const [hoveredProduct, setHoveredProduct] = useState<number | null>(null);

  const { refreshCart } = useCart();
  const { isWished, toggleWishlist } = useWishlist();
  const { isAuthenticated } = useAuth();
  const router = useRouter();

  /* ---------- Fetch products & categories ---------- */
  useEffect(() => {
    const loadData = async () => {
      try {
        setLoading(true);
        
        // Fetch categories tá»« API
        const catData = await fetchCategoriesWithCount();
        if (Array.isArray(catData)) {
          setCategories(catData);
        }
        
        // Fetch products
        const data = await fetchProducts(10000);
        console.log('SHOP PRODUCT SAMPLE:', data[0]);

        const mapped: Product[] = data.map((p: any, index: number) => ({
          id: p.product_id || p.id || index + 1,
          name: p.product_name || p.name || 'Sáº£n pháº©m',
          price: p.price || 0,
          sale_price: p.sale_price || null,
          image_url:
            p.image_url ||
            p.product_images?.find((img: any) => img.is_primary)?.image_url ||
            p.product_images?.[0]?.image_url ||
            p.image ||
            null,
          rating: p.rating_average || p.rating || 4.5,
          reviews: p.review_count || p.reviews || 0,
          tag: p.is_new ? 'Má»šI' : p.is_featured ? 'Ná»”I Báº¬T' : undefined,
          category: p.category_name || p.categories?.category_name || 'KhÃ¡c',
          categoryId: p.category_id || (p.categories?.category_id ?? 0),
        }));

        setProducts(mapped);
      } catch (err) {
        console.error('Load data error:', err);
      } finally {
        setLoading(false);
      }
    };

    loadData();
  }, []);

  /* ---------- Derived data ---------- */
  const filteredProducts = useMemo(() => {
    return products
      .filter(
        p =>
          selectedCategory === 'Táº¥t Cáº£' || p.category === selectedCategory,
      )
      .filter(
        p => p.price >= priceRange[0] && p.price <= priceRange[1],
      )
      .sort((a, b) => {
        switch (sortBy) {
          case 'price-low':
            return a.price - b.price;
          case 'price-high':
            return b.price - a.price;
          case 'rating':
            return b.rating - a.rating;
          default:
            return b.id - a.id;
        }
      });
  }, [products, selectedCategory, priceRange, sortBy]);

  const cartCount = cartItems.reduce((t, i) => t + i.quantity, 0);
  const cartTotal = cartItems.reduce((t, i) => t + i.price * i.quantity, 0);

  /* ---------- Handlers ---------- */
  const handleToggleWishlist = async (productId: number) => {
    // Kiá»ƒm tra Ä‘Äƒng nháº­p trÆ°á»›c
    if (!isAuthenticated) {
      if (confirm('Vui lÃ²ng Ä‘Äƒng nháº­p Ä‘á»ƒ thÃªm vÃ o danh sÃ¡ch yÃªu thÃ­ch. Äi Ä‘áº¿n trang Ä‘Äƒng nháº­p?')) {
        router.push('/login');
      }
      return;
    }
    await toggleWishlist(productId);
  };

  /* ===================== RENDER ===================== */
  return (
    <div className="min-h-screen bg-gray-50">
      {/* ===================== BREADCRUMB ===================== */}
      <div className="bg-white border-b">
        <div className="max-w-7xl mx-auto px-4 py-4 text-sm text-gray-600 flex gap-2">
          <Link href="/" className="hover:text-pink-600">
            Trang Chá»§
          </Link>
          <span>/</span>
          <span className="text-gray-900 font-medium">Cá»­a HÃ ng</span>
        </div>
      </div>

      {/* ===================== MAIN ===================== */}
      <div className="max-w-7xl mx-auto px-4 py-8 flex gap-8">
        {/* ---------- FILTER SIDEBAR ---------- */}
        <aside
          className={`w-full lg:w-64 ${
            isFilterOpen ? 'block' : 'hidden lg:block'
          }`}
        >
          <div className="bg-white p-6 rounded-xl shadow-sm">
            <div className="flex justify-between mb-6">
              <h2 className="font-bold">Bá»™ Lá»c</h2>
              <button
                onClick={() => setIsFilterOpen(false)}
                className="lg:hidden"
              >
                <X className="w-5 h-5" />
              </button>
            </div>

            {/* Category */}
            <div className="mb-6">
              <h3 className="font-semibold mb-4">Loáº¡i Sáº£n Pháº©m</h3>
              
              {/* Táº¥t cáº£ */}
              <label className="flex items-center gap-2 p-2 rounded hover:bg-gray-50 cursor-pointer">
                <input
                  type="radio"
                  checked={selectedCategory === 'Táº¥t Cáº£'}
                  onChange={() => setSelectedCategory('Táº¥t Cáº£')}
                />
                <span className="flex-1">Táº¥t Cáº£</span>
                <span className="text-gray-400 text-sm">
                  ({products.length})
                </span>
              </label>
              
              {/* Categories tá»« API */}
              {categories.map(cat => (
                <label
                  key={cat.category_id}
                  className="flex items-center gap-2 p-2 rounded hover:bg-gray-50 cursor-pointer"
                >
                  <input
                    type="radio"
                    checked={selectedCategory === cat.category_name}
                    onChange={() => setSelectedCategory(cat.category_name)}
                  />
                  <span className="flex-1">{cat.category_name}</span>
                  <span className="text-gray-400 text-sm">
                    ({cat.product_count || 0})
                  </span>
                </label>
              ))}
            </div>

            {/* Sort */}
            <div>
              <h3 className="font-semibold mb-4">Sáº¯p Xáº¿p</h3>
              <select
                value={sortBy}
                onChange={e => setSortBy(e.target.value as any)}
                className="w-full border rounded-lg px-3 py-2"
              >
                <option value="newest">Má»›i Nháº¥t</option>
                <option value="price-low">GiÃ¡ Tháº¥p â†’ Cao</option>
                <option value="price-high">GiÃ¡ Cao â†’ Tháº¥p</option>
                <option value="rating">ÄÃ¡nh GiÃ¡ Cao</option>
              </select>
            </div>
          </div>
        </aside>

        {/* ---------- PRODUCTS ---------- */}
        <main className="flex-1">
          <div className="mb-6 flex justify-between lg:hidden">
            <button
              onClick={() => setIsFilterOpen(true)}
              className="flex items-center gap-2 border px-4 py-2 rounded-lg"
            >
              <Filter className="w-4 h-4" />
              Bá»™ Lá»c
            </button>
          </div>

          <p className="text-sm text-gray-600 mb-6">
            Hiá»ƒn thá»‹{' '}
            <span className="font-semibold">{filteredProducts.length}</span> sáº£n
            pháº©m
          </p>

          <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 md:gap-6 auto-rows-fr">
            {filteredProducts.map(product => {
              const productWished = isWished(product.id);
              const hasDiscount = product.sale_price && product.sale_price < product.price;
              const discountPercent = hasDiscount 
                ? Math.round((1 - product.sale_price! / product.price) * 100)
                : 0;

              return (
                <div
                  key={product.id}
                  className="group bg-white rounded-2xl shadow-sm hover:shadow-xl transition-all duration-300 overflow-hidden flex flex-col h-full"
                  onMouseEnter={() => setHoveredProduct(product.id)}
                  onMouseLeave={() => setHoveredProduct(null)}
                >
                  {/* Image */}
                  <div className="relative h-48 md:h-64 bg-gray-100 overflow-hidden">
                    {product.image_url ? (
                      <img
                        src={product.image_url}
                        alt={product.name}
                        className="w-full h-full object-cover group-hover:scale-110 transition-transform duration-500"
                      />
                    ) : (
                      <div className="w-full h-full flex items-center justify-center text-gray-400">
                        <Smartphone className="w-16 h-16" />
                      </div>
                    )}

                    {/* Badge giáº£m giÃ¡ */}
                    {hasDiscount && (
                      <div className="absolute top-3 left-3 bg-red-500 text-white px-2 py-1 rounded-lg text-xs font-bold">
                        -{discountPercent}%
                      </div>
                    )}

                    {/* Wishlist button */}
                    <button
                      onClick={(e) => {
                        e.preventDefault();
                        handleToggleWishlist(product.id);
                      }}
                      className={`absolute top-3 right-3 p-2 rounded-full transition-all duration-300 ${
                        productWished 
                          ? 'bg-pink-500 text-white' 
                          : 'bg-white/80 text-gray-600 hover:bg-pink-500 hover:text-white'
                      }`}
                    >
                      <Heart className={`w-5 h-5 ${productWished ? 'fill-current' : ''}`} />
                    </button>

                    {/* Quick actions on hover */}
                    <div className={`absolute bottom-0 left-0 right-0 p-4 bg-gradient-to-t from-black/60 to-transparent transform transition-all duration-300 ${
                      hoveredProduct === product.id ? 'translate-y-0 opacity-100' : 'translate-y-full opacity-0'
                    }`}>
                      <Link
                        href={`/product/${product.id}`}
                        className="block w-full bg-white text-gray-900 text-center py-2 rounded-lg font-semibold hover:bg-pink-600 hover:text-white transition"
                      >
                        Xem chi tiáº¿t
                      </Link>
                    </div>
                  </div>

                  {/* Info */}
                  <div className="p-4 flex flex-col flex-1">
                    <Link href={`/product/${product.id}`}>
                      <h3 className="font-semibold text-gray-900 mb-2 line-clamp-2 hover:text-pink-600 transition h-12">
                        {product.name}
                      </h3>
                    </Link>

                    {/* Rating */}
                    <div className="flex items-center gap-1 mb-2">
                      {[...Array(5)].map((_, i) => (
                        <Star
                          key={i}
                          className={`w-4 h-4 ${i < Math.floor(product.rating) ? 'text-yellow-400 fill-yellow-400' : 'text-gray-300'}`}
                        />
                      ))}
                      <span className="text-xs text-gray-500 ml-1">({product.reviews})</span>
                    </div>

                    {/* Price */}
                    <div className="flex items-center gap-2 mb-3">
                      <span className="text-lg font-bold text-pink-600">
                        {(product.sale_price || product.price).toLocaleString('vi-VN')}â‚«
                      </span>
                      {hasDiscount && (
                        <span className="text-sm text-gray-400 line-through">
                          {product.price.toLocaleString('vi-VN')}â‚«
                        </span>
                      )}
                    </div>

                    {/* Add to cart button */}
                    <div className="w-full mt-auto">
                      <AddToCartButton productId={product.id} />
                    </div>
                  </div>
                </div>
              );
            })}
          </div>

          {!loading && filteredProducts.length === 0 && (
            <div className="text-center py-12 text-gray-600">
              KhÃ´ng tÃ¬m tháº¥y sáº£n pháº©m phÃ¹ há»£p
            </div>
          )}
        </main>
      </div>
    </div>
  );
}




################################################################################
## FILE 114: page.tsx
## Path: fontend/src/app/(public)/shop/product/[slug]/page.tsx
################################################################################

'use client';

import React, { useState, useEffect } from 'react';
import { useParams, useRouter } from 'next/navigation';
import Link from 'next/link';
import { 
  Star, Heart, ShoppingCart, Minus, Plus, 
  Truck, Shield, RotateCcw, Check, ChevronRight, Gift
} from 'lucide-react';
import { useAuth } from '@/contexts/AuthContext';

interface Product {
  product_id: number;
  product_name: string;
  product_slug: string;
  sku: string;
  description: string;
  short_description: string;
  price: number;
  sale_price: number;
  category_id: number;
  brand_id: number;
  image_url: string;
  is_featured: boolean;
  is_new: boolean;
  status: string;
  category_name?: string;
  brand_name?: string;
  images?: { image_id: number; image_url: string; is_primary: boolean }[];
  variants?: { variant_id: number; variant_name: string; price: number; stock: number }[];
  avg_rating?: number;
  review_count?: number;
}

interface Review {
  review_id: number;
  customer_id: number;
  rating: number;
  comment: string;
  created_at: string;
  customer_name?: string;
}

const API_URL = process.env.NEXT_PUBLIC_API_URL || 'http://localhost:3001';

export default function ProductDetailPage() {
  const params = useParams();
  const router = useRouter();
  const slug = params.slug as string;
  const { user, isAuthenticated } = useAuth();

  const [product, setProduct] = useState<Product | null>(null);
  const [reviews, setReviews] = useState<Review[]>([]);
  const [loading, setLoading] = useState(true);
  const [selectedImage, setSelectedImage] = useState(0);
  const [quantity, setQuantity] = useState(1);
  const [selectedVariant, setSelectedVariant] = useState<number | null>(null);
  const [isWished, setIsWished] = useState(false);
  const [addingToCart, setAddingToCart] = useState(false);
  const [activeTab, setActiveTab] = useState<'description' | 'reviews'>('description');

  useEffect(() => {
    if (slug) {
      loadProduct();
    }
  }, [slug]);

  const loadProduct = async () => {
    try {
      setLoading(true);
      const response = await fetch(`${API_URL}/products/slug/${slug}`);
      if (response.ok) {
        const data = await response.json();
        setProduct(data);
      } else {
        setProduct(getSampleProduct());
        setReviews(getSampleReviews());
      }
    } catch (error) {
      setProduct(getSampleProduct());
      setReviews(getSampleReviews());
    } finally {
      setLoading(false);
    }
  };

  const getSampleProduct = (): Product => ({
    product_id: 1,
    product_name: 'á»p lÆ°ng iPhone 15 Pro Max MagSafe trong suá»‘t cao cáº¥p',
    product_slug: slug,
    sku: 'IP15PM-MAGSAFE-CLEAR',
    description: `
      <h3>Äáº·c Ä‘iá»ƒm ná»•i báº­t:</h3>
      <ul>
        <li>Cháº¥t liá»‡u polycarbonate cao cáº¥p, chá»‘ng tráº§y xÆ°á»›c</li>
        <li>Há»— trá»£ sáº¡c khÃ´ng dÃ¢y MagSafe</li>
        <li>Thiáº¿t káº¿ trong suá»‘t, khoe trá»n váº» Ä‘áº¹p iPhone</li>
        <li>Viá»n chá»‘ng sá»‘c, báº£o vá»‡ gÃ³c cáº¡nh</li>
      </ul>
    `,
    short_description: 'á»p lÆ°ng MagSafe trong suá»‘t cao cáº¥p dÃ nh cho iPhone 15 Pro Max.',
    price: 350000,
    sale_price: 299000,
    category_id: 1,
    brand_id: 1,
    image_url: '/SP001.png',
    is_featured: true,
    is_new: true,
    status: 'active',
    category_name: 'á»p iPhone',
    brand_name: 'GoatTech',
    images: [
      { image_id: 1, image_url: '/SP001.png', is_primary: true },
      { image_id: 2, image_url: '/about1.jpg', is_primary: false },
      { image_id: 3, image_url: '/about2.jpg', is_primary: false },
    ],
    variants: [
      { variant_id: 1, variant_name: 'Trong suá»‘t', price: 299000, stock: 50 },
      { variant_id: 2, variant_name: 'Má» (Matte)', price: 329000, stock: 30 },
    ],
    avg_rating: 4.8,
    review_count: 156,
  });

  const getSampleReviews = (): Review[] => [
    {
      review_id: 1,
      customer_id: 1,
      rating: 5,
      comment: 'á»p ráº¥t Ä‘áº¹p, vá»«a khÃ­t mÃ¡y. Cháº¥t lÆ°á»£ng tuyá»‡t vá»i!',
      created_at: '2024-12-10T10:00:00Z',
      customer_name: 'Nguyá»…n VÄƒn A',
    },
    {
      review_id: 2,
      customer_id: 2,
      rating: 5,
      comment: 'Giao hÃ ng nhanh, Ä‘Ã³ng gÃ³i cáº©n tháº­n.',
      created_at: '2024-12-08T14:30:00Z',
      customer_name: 'Tráº§n Thá»‹ B',
    },
  ];

  const handleAddToCart = async () => {
    if (!isAuthenticated) {
      router.push('/login?redirect=' + encodeURIComponent(window.location.pathname));
      return;
    }

    setAddingToCart(true);
    try {
      // Add to cart API call here
      alert('ÄÃ£ thÃªm vÃ o giá» hÃ ng!');
    } catch (error) {
      console.error('Error adding to cart:', error);
    } finally {
      setAddingToCart(false);
    }
  };

  const formatPrice = (price: number) => {
    return price.toLocaleString('vi-VN') + 'â‚«';
  };

  const getDiscountPercent = () => {
    if (!product || !product.sale_price || product.sale_price >= product.price) return 0;
    return Math.round((1 - product.sale_price / product.price) * 100);
  };

  if (loading) {
    return (
      <div className="min-h-screen bg-gray-50 flex items-center justify-center">
        <div className="animate-spin rounded-full h-16 w-16 border-t-4 border-pink-600"></div>
      </div>
    );
  }

  if (!product) {
    return (
      <div className="min-h-screen bg-gray-50 flex items-center justify-center">
        <div className="text-center">
          <div className="text-6xl mb-4">ðŸ˜¢</div>
          <h2 className="text-2xl font-bold mb-2">KhÃ´ng tÃ¬m tháº¥y sáº£n pháº©m</h2>
          <Link href="/shop" className="text-pink-600 hover:underline">
            â† Quay láº¡i cá»­a hÃ ng
          </Link>
        </div>
      </div>
    );
  }

  const images = product.images?.length ? product.images : [{ image_id: 0, image_url: product.image_url, is_primary: true }];
  const currentPrice = product.sale_price || product.price;

  return (
    <div className="min-h-screen bg-gray-50">
      {/* Breadcrumb */}
      <div className="bg-white border-b">
        <div className="max-w-7xl mx-auto px-4 py-3">
          <div className="flex items-center gap-2 text-sm text-gray-600">
            <Link href="/" className="hover:text-pink-600">Trang chá»§</Link>
            <ChevronRight className="w-4 h-4" />
            <Link href="/shop" className="hover:text-pink-600">Cá»­a hÃ ng</Link>
            <ChevronRight className="w-4 h-4" />
            <span className="text-gray-900 font-medium truncate max-w-[200px]">{product.product_name}</span>
          </div>
        </div>
      </div>

      {/* Product Main */}
      <div className="max-w-7xl mx-auto px-4 py-8">
        <div className="bg-white rounded-2xl shadow-sm p-6 lg:p-8">
          <div className="grid lg:grid-cols-2 gap-8 lg:gap-12">
            {/* Images */}
            <div>
              <div className="relative aspect-square rounded-2xl overflow-hidden bg-gray-100 mb-4">
                <img
                  src={images[selectedImage]?.image_url || product.image_url}
                  alt={product.product_name}
                  className="w-full h-full object-cover"
                />
                {getDiscountPercent() > 0 && (
                  <span className="absolute top-4 left-4 bg-red-500 text-white text-sm font-bold px-3 py-1 rounded-full">
                    -{getDiscountPercent()}%
                  </span>
                )}
              </div>

              {images.length > 1 && (
                <div className="flex gap-3 overflow-x-auto pb-2">
                  {images.map((img, index) => (
                    <button
                      key={img.image_id}
                      onClick={() => setSelectedImage(index)}
                      className={`flex-shrink-0 w-20 h-20 rounded-lg overflow-hidden border-2 transition ${
                        selectedImage === index ? 'border-pink-600' : 'border-gray-200'
                      }`}
                    >
                      <img src={img.image_url} alt="" className="w-full h-full object-cover" />
                    </button>
                  ))}
                </div>
              )}
            </div>

            {/* Info */}
            <div>
              <div className="mb-4">
                {product.brand_name && (
                  <span className="text-pink-600 text-sm font-medium">{product.brand_name}</span>
                )}
                <h1 className="text-2xl lg:text-3xl font-bold text-gray-900 mt-1">
                  {product.product_name}
                </h1>
                <div className="flex items-center gap-4 mt-3">
                  <div className="flex items-center gap-1">
                    {[1, 2, 3, 4, 5].map((star) => (
                      <Star
                        key={star}
                        className={`w-5 h-5 ${
                          star <= (product.avg_rating || 4.5)
                            ? 'fill-yellow-400 text-yellow-400'
                            : 'text-gray-300'
                        }`}
                      />
                    ))}
                    <span className="ml-2 text-sm text-gray-600">
                      {product.avg_rating || 4.5} ({product.review_count || reviews.length} Ä‘Ã¡nh giÃ¡)
                    </span>
                  </div>
                </div>
              </div>

              {/* Price */}
              <div className="mb-6 pb-6 border-b">
                <div className="flex items-baseline gap-3">
                  <span className="text-3xl font-bold text-pink-600">
                    {formatPrice(currentPrice)}
                  </span>
                  {product.sale_price && product.sale_price < product.price && (
                    <span className="text-lg text-gray-400 line-through">
                      {formatPrice(product.price)}
                    </span>
                  )}
                </div>
              </div>

              <p className="text-gray-600 mb-6">{product.short_description}</p>

              {/* Variants */}
              {product.variants && product.variants.length > 0 && (
                <div className="mb-6">
                  <h3 className="font-semibold mb-3">PhÃ¢n loáº¡i:</h3>
                  <div className="flex flex-wrap gap-3">
                    {product.variants.map((variant) => (
                      <button
                        key={variant.variant_id}
                        onClick={() => setSelectedVariant(variant.variant_id)}
                        className={`px-4 py-2 rounded-lg border-2 transition ${
                          selectedVariant === variant.variant_id
                            ? 'border-pink-600 bg-pink-50 text-pink-600'
                            : 'border-gray-200 hover:border-gray-300'
                        }`}
                      >
                        {variant.variant_name}
                      </button>
                    ))}
                  </div>
                </div>
              )}

              {/* Quantity */}
              <div className="mb-6">
                <h3 className="font-semibold mb-3">Sá»‘ lÆ°á»£ng:</h3>
                <div className="flex items-center gap-4">
                  <div className="flex items-center border rounded-lg">
                    <button
                      onClick={() => setQuantity(q => Math.max(1, q - 1))}
                      className="p-3 hover:bg-gray-100 transition"
                    >
                      <Minus className="w-4 h-4" />
                    </button>
                    <span className="px-6 py-3 font-semibold">{quantity}</span>
                    <button
                      onClick={() => setQuantity(q => q + 1)}
                      className="p-3 hover:bg-gray-100 transition"
                    >
                      <Plus className="w-4 h-4" />
                    </button>
                  </div>
                  <button
                    onClick={() => setIsWished(!isWished)}
                    className={`p-3 rounded-lg border transition ${
                      isWished ? 'bg-pink-50 border-pink-600 text-pink-600' : 'border-gray-200'
                    }`}
                  >
                    <Heart className={`w-6 h-6 ${isWished ? 'fill-pink-600' : ''}`} />
                  </button>
                </div>
              </div>

              {/* Buttons */}
              <div className="flex gap-4 mb-4">
                <button
                  onClick={handleAddToCart}
                  disabled={addingToCart}
                  className="flex-1 flex items-center justify-center gap-2 bg-white border-2 border-pink-600 text-pink-600 py-4 rounded-xl font-semibold hover:bg-pink-50 transition disabled:opacity-50"
                >
                  <ShoppingCart className="w-5 h-5" />
                  {addingToCart ? 'Äang thÃªm...' : 'ThÃªm vÃ o giá»'}
                </button>
                <button
                  onClick={() => { handleAddToCart(); router.push('/checkout'); }}
                  className="flex-1 bg-gradient-to-r from-pink-600 to-purple-600 text-white py-4 rounded-xl font-semibold hover:from-pink-700 hover:to-purple-700 transition"
                >
                  Mua ngay
                </button>
              </div>

              {/* Gift Button */}
              <button
                onClick={() => router.push(`/gift/send?productId=${product.product_id}`)}
                className="w-full flex items-center justify-center gap-2 bg-gradient-to-r from-amber-500 to-orange-500 text-white py-4 rounded-xl font-semibold hover:from-amber-600 hover:to-orange-600 transition mb-8"
              >
                <Gift className="w-5 h-5" />
                ðŸŽ Gá»­i Táº·ng Báº¡n BÃ¨
              </button>

              {/* Benefits */}
              <div className="grid grid-cols-2 gap-4 p-4 bg-gray-50 rounded-xl">
                <div className="flex items-center gap-3">
                  <div className="bg-green-100 p-2 rounded-full">
                    <Truck className="w-5 h-5 text-green-600" />
                  </div>
                  <div className="text-sm">
                    <p className="font-medium">Giao hÃ ng nhanh</p>
                    <p className="text-gray-500">2-3 ngÃ y</p>
                  </div>
                </div>
                <div className="flex items-center gap-3">
                  <div className="bg-blue-100 p-2 rounded-full">
                    <Shield className="w-5 h-5 text-blue-600" />
                  </div>
                  <div className="text-sm">
                    <p className="font-medium">Báº£o hÃ nh</p>
                    <p className="text-gray-500">12 thÃ¡ng</p>
                  </div>
                </div>
                <div className="flex items-center gap-3">
                  <div className="bg-orange-100 p-2 rounded-full">
                    <RotateCcw className="w-5 h-5 text-orange-600" />
                  </div>
                  <div className="text-sm">
                    <p className="font-medium">Äá»•i tráº£</p>
                    <p className="text-gray-500">30 ngÃ y</p>
                  </div>
                </div>
                <div className="flex items-center gap-3">
                  <div className="bg-purple-100 p-2 rounded-full">
                    <Check className="w-5 h-5 text-purple-600" />
                  </div>
                  <div className="text-sm">
                    <p className="font-medium">ChÃ­nh hÃ£ng</p>
                    <p className="text-gray-500">100%</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        {/* Tabs */}
        <div className="bg-white rounded-2xl shadow-sm mt-8 overflow-hidden">
          <div className="flex border-b">
            <button
              onClick={() => setActiveTab('description')}
              className={`flex-1 py-4 px-6 text-center font-semibold transition \${
                activeTab === 'description'
                  ? 'text-pink-600 border-b-2 border-pink-600'
                  : 'text-gray-500 hover:text-gray-700'
              }`}
            >
              MÃ´ táº£ sáº£n pháº©m
            </button>
            <button
              onClick={() => setActiveTab('reviews')}
              className={`flex-1 py-4 px-6 text-center font-semibold transition \${
                activeTab === 'reviews'
                  ? 'text-pink-600 border-b-2 border-pink-600'
                  : 'text-gray-500 hover:text-gray-700'
              }`}
            >
              ÄÃ¡nh giÃ¡ ({reviews.length})
            </button>
          </div>

          <div className="p-6 lg:p-8">
            {activeTab === 'description' ? (
              <div
                className="prose max-w-none"
                dangerouslySetInnerHTML={{ __html: product.description }}
              />
            ) : (
              <div className="space-y-6">
                {reviews.map((review) => (
                  <div key={review.review_id} className="border-b pb-6 last:border-0">
                    <div className="flex items-center gap-3 mb-3">
                      <div className="w-10 h-10 bg-gradient-to-br from-pink-500 to-purple-500 rounded-full flex items-center justify-center text-white font-semibold">
                        {review.customer_name?.charAt(0) || 'K'}
                      </div>
                      <div>
                        <p className="font-medium">{review.customer_name || 'KhÃ¡ch hÃ ng'}</p>
                        <p className="text-sm text-gray-500">
                          {new Date(review.created_at).toLocaleDateString('vi-VN')}
                        </p>
                      </div>
                    </div>
                    <div className="flex items-center gap-1 mb-2">
                      {[1, 2, 3, 4, 5].map((star) => (
                        <Star
                          key={star}
                          className={`w-4 h-4 ${
                            star <= review.rating
                              ? 'fill-yellow-400 text-yellow-400'
                              : 'text-gray-300'
                          }`}
                        />
                      ))}
                    </div>
                    <p className="text-gray-700">{review.comment}</p>
                  </div>
                ))}
              </div>
            )}
          </div>
        </div>
      </div>
    </div>
  );
}



################################################################################
## FILE 115: page.tsx
## Path: fontend/src/app/(public)/shopping-cart/page.tsx
################################################################################

'use client';

import React, { useEffect, useState, useCallback } from 'react';
import Link from 'next/link';
import Image from 'next/image';
import { ShoppingCart, Trash2, Plus, Minus, ArrowLeft } from 'lucide-react';
import { useAuth } from '@/contexts/AuthContext';
import { useCart } from '@/app/context/cart-context';
import { useRouter } from 'next/navigation';
import {
  fetchShoppingCart,
  updateShoppingCart,
  deleteShoppingCart,
  clearShoppingCart,
} from '@/lib/api-client';

interface CartItem {
  cart_id: number;
  product_id: number;
  variant_id?: number;
  quantity: number;
  product_name: string;
  price: number;
  original_price?: number;
  image_url: string;
}

export default function CartPage() {
  const { user, isAuthenticated, loading: authLoading } = useAuth();
  const { refreshCart } = useCart();
  const router = useRouter();

  const [cartItems, setCartItems] = useState<CartItem[]>([]);
  const [loading, setLoading] = useState(true);
  const [updating, setUpdating] = useState<number | null>(null);
  const [cartTotal, setCartTotal] = useState(0);
  const [itemCount, setItemCount] = useState(0);

  // Load cart
  const loadCart = useCallback(async () => {
    if (!isAuthenticated) {
      setLoading(false);
      return;
    }

    try {
      setLoading(true);
      const result = await fetchShoppingCart();

      if (result.success) {
        setCartItems(result.data || []);
        setCartTotal(result.total || 0);
        setItemCount(result.itemCount || 0);
        // Cáº­p nháº­t icon giá» hÃ ng trÃªn header
        await refreshCart();
      } else {
        console.error('Load cart failed:', result.message);
        setCartItems([]);
      }
    } catch (error) {
      console.error('Load cart error:', error);
      setCartItems([]);
    } finally {
      setLoading(false);
    }
  }, [isAuthenticated, refreshCart]);

  useEffect(() => {
    if (!authLoading) {
      if (!isAuthenticated) {
        // Redirect to login if not authenticated
        router.push('/login?redirect=/shopping-cart');
      } else {
        loadCart();
      }
    }
  }, [authLoading, isAuthenticated, loadCart, router]);

  // Update quantity
  const handleUpdateQuantity = async (cartId: number, newQuantity: number) => {
    if (newQuantity < 1) {
      handleRemoveItem(cartId);
      return;
    }

    setUpdating(cartId);

    try {
      const result = await updateShoppingCart(cartId, newQuantity);

      if (result.success) {
        // Reload cart to get updated totals
        await loadCart();
        // Cáº­p nháº­t icon
        await refreshCart();
      } else {
        alert(result.message);
      }
    } catch (error) {
      console.error('Update error:', error);
      alert('KhÃ´ng thá»ƒ cáº­p nháº­t sá»‘ lÆ°á»£ng');
    } finally {
      setUpdating(null);
    }
  };

  // Remove item
  const handleRemoveItem = async (cartId: number) => {
    if (!confirm('Báº¡n cÃ³ cháº¯c muá»‘n xÃ³a sáº£n pháº©m nÃ y?')) return;

    setUpdating(cartId);

    try {
      const result = await deleteShoppingCart(cartId);

      if (result.success) {
        await loadCart();
        // Cáº­p nháº­t icon
        await refreshCart();
      } else {
        alert(result.message);
      }
    } catch (error) {
      console.error('Remove error:', error);
      alert('KhÃ´ng thá»ƒ xÃ³a sáº£n pháº©m');
    } finally {
      setUpdating(null);
    }
  };

  // Clear all
  const handleClearCart = async () => {
    if (!confirm('XÃ³a toÃ n bá»™ giá» hÃ ng?')) return;

    try {
      const result = await clearShoppingCart();

      if (result.success) {
        setCartItems([]);
        setCartTotal(0);
        setItemCount(0);
        // Cáº­p nháº­t icon
        await refreshCart();
      } else {
        alert(result.message);
      }
    } catch (error) {
      console.error('Clear cart error:', error);
      alert('KhÃ´ng thá»ƒ xÃ³a giá» hÃ ng');
    }
  };

  // Format price
  const formatPrice = (price: number) => {
    return price.toLocaleString('vi-VN') + 'â‚«';
  };

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // RENDER
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  // Loading state
  if (authLoading || loading) {
    return (
      <div className="min-h-screen flex items-center justify-center bg-gray-50">
        <div className="flex flex-col items-center gap-4">
          <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-pink-600"></div>
          <p className="text-gray-500">Äang táº£i giá» hÃ ng...</p>
        </div>
      </div>
    );
  }

  // Not authenticated
  if (!isAuthenticated) {
    return (
      <div className="min-h-screen flex flex-col items-center justify-center bg-gray-50">
        <ShoppingCart className="w-16 h-16 text-gray-400 mb-4" />
        <h2 className="text-xl font-semibold text-gray-700 mb-2">
          Vui lÃ²ng Ä‘Äƒng nháº­p
        </h2>
        <p className="text-gray-500 mb-6">
          Báº¡n cáº§n Ä‘Äƒng nháº­p Ä‘á»ƒ xem giá» hÃ ng
        </p>
        <Link
          href="/login?redirect=/shopping-cart"
          className="bg-pink-600 hover:bg-pink-700 text-white px-6 py-3 rounded-lg transition"
        >
          ÄÄƒng nháº­p ngay
        </Link>
      </div>
    );
  }

  // Empty cart
  if (cartItems.length === 0) {
    return (
      <div className="min-h-screen flex flex-col items-center justify-center bg-gray-50">
        <ShoppingCart className="w-20 h-20 text-gray-300 mb-4" />
        <h2 className="text-2xl font-semibold text-gray-700 mb-2">
          Giá» hÃ ng trá»‘ng
        </h2>
        <p className="text-gray-500 mb-6">
          HÃ£y thÃªm sáº£n pháº©m vÃ o giá» hÃ ng cá»§a báº¡n
        </p>
        <Link
          href="/shop"
          className="bg-pink-600 hover:bg-pink-700 text-white px-8 py-3 rounded-lg transition flex items-center gap-2"
        >
          <ArrowLeft className="w-5 h-5" />
          Tiáº¿p tá»¥c mua sáº¯m
        </Link>
      </div>
    );
  }

  // Cart with items
  return (
    <div className="min-h-screen bg-gradient-to-br from-gray-50 to-gray-100 py-10">
      <div className="max-w-6xl mx-auto px-4">
        {/* Header */}
        <div className="flex items-center justify-between mb-8">
          <h1 className="text-3xl font-bold text-gray-800 flex items-center gap-3">
            <ShoppingCart className="w-8 h-8 text-pink-600" />
            Giá» HÃ ng ({itemCount} sáº£n pháº©m)
          </h1>

          <button
            onClick={handleClearCart}
            className="text-red-500 hover:text-red-600 text-sm font-medium flex items-center gap-1"
          >
            <Trash2 className="w-4 h-4" />
            XÃ³a táº¥t cáº£
          </button>
        </div>

        <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
          {/* Cart Items */}
          <div className="lg:col-span-2 space-y-4">
            {cartItems.map((item) => (
              <div
                key={item.cart_id}
                className={`bg-white rounded-2xl shadow-md p-5 flex gap-4 transition ${
                  updating === item.cart_id ? 'opacity-50' : ''
                }`}
              >
                {/* Product Image */}
                <div className="w-24 h-24 bg-gray-100 rounded-lg overflow-hidden flex-shrink-0">
                  {item.image_url && item.image_url.startsWith('http') ? (
                    <img
                      src={item.image_url}
                      alt={item.product_name}
                      className="w-full h-full object-cover"
                    />
                  ) : (
                    <div className="w-full h-full flex items-center justify-center text-gray-400 text-xs text-center p-2">
                      {item.product_name}
                    </div>
                  )}
                </div>

                {/* Product Info */}
                <div className="flex-1">
                  <h3 className="font-semibold text-gray-900 mb-1">
                    {item.product_name}
                  </h3>

                  <p className="text-pink-600 font-bold text-lg">
                    {formatPrice(item.price)}
                  </p>

                  {/* Quantity Controls */}
                  <div className="flex items-center gap-3 mt-3">
                    <button
                      onClick={() => handleUpdateQuantity(item.cart_id, item.quantity - 1)}
                      disabled={updating === item.cart_id}
                      className="w-8 h-8 flex items-center justify-center rounded-full border border-gray-300 hover:bg-gray-100 disabled:opacity-50"
                    >
                      <Minus className="w-4 h-4" />
                    </button>

                    <span className="w-8 text-center font-semibold">
                      {item.quantity}
                    </span>

                    <button
                      onClick={() => handleUpdateQuantity(item.cart_id, item.quantity + 1)}
                      disabled={updating === item.cart_id}
                      className="w-8 h-8 flex items-center justify-center rounded-full border border-gray-300 hover:bg-gray-100 disabled:opacity-50"
                    >
                      <Plus className="w-4 h-4" />
                    </button>

                    <button
                      onClick={() => handleRemoveItem(item.cart_id)}
                      disabled={updating === item.cart_id}
                      className="ml-4 text-red-500 hover:text-red-600"
                    >
                      <Trash2 className="w-5 h-5" />
                    </button>
                  </div>
                </div>

                {/* Item Total */}
                <div className="text-right">
                  <p className="text-lg font-bold text-gray-900">
                    {formatPrice(item.price * item.quantity)}
                  </p>
                </div>
              </div>
            ))}
          </div>

          {/* Order Summary */}
          <div className="lg:col-span-1">
            <div className="bg-white rounded-2xl shadow-md p-6 sticky top-4">
              <h2 className="text-xl font-bold text-gray-800 mb-6">
                TÃ³m táº¯t Ä‘Æ¡n hÃ ng
              </h2>

              <div className="space-y-3 mb-6">
                <div className="flex justify-between text-gray-600">
                  <span>Táº¡m tÃ­nh ({itemCount} sáº£n pháº©m)</span>
                  <span>{formatPrice(cartTotal)}</span>
                </div>
                <div className="flex justify-between text-gray-600">
                  <span>PhÃ­ váº­n chuyá»ƒn</span>
                  <span className="text-green-600">Miá»…n phÃ­</span>
                </div>
                <hr />
                <div className="flex justify-between text-xl font-bold">
                  <span>Tá»•ng cá»™ng</span>
                  <span className="text-pink-600">{formatPrice(cartTotal)}</span>
                </div>
              </div>

              <Link
                href="/checkout"
                className="w-full bg-gradient-to-r from-pink-600 to-rose-600 hover:from-pink-700 hover:to-rose-700 text-white py-4 rounded-xl font-semibold text-center block transition"
              >
                ðŸ’³ Tiáº¿n hÃ nh thanh toÃ¡n
              </Link>

              <Link
                href="/shop"
                className="w-full mt-3 border border-gray-300 text-gray-700 py-3 rounded-xl font-medium text-center block hover:bg-gray-50 transition"
              >
                â† Tiáº¿p tá»¥c mua sáº¯m
              </Link>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
}



################################################################################
## FILE 116: page.tsx
## Path: fontend/src/app/(public)/wishlist/page.tsx
################################################################################

'use client';

import React, { useEffect, useState } from 'react';
import Link from 'next/link';
import { Heart, Trash2, Star, ArrowLeft } from 'lucide-react';
import { useWishlist } from '@/app/context/wishlist-context';
import { AddToCartButton } from '@/components/products/AddToCartButton';
import { fetchProductById } from '@/lib/api-client';

interface Product {
  product_id: number;
  product_name: string;
  price: number;
  sale_price?: number;
  image_url: string;
  description?: string;
}

export default function WishlistPage() {
  const { wishedProducts, loading, toggleWishlist, wishlistCount, refreshWishlist } = useWishlist();
  const [products, setProducts] = useState<Product[]>([]);
  const [loadingProducts, setLoadingProducts] = useState(false);

  // Fetch thÃ´ng tin sáº£n pháº©m khi wishedProducts thay Ä‘á»•i
  useEffect(() => {
    const loadProducts = async () => {
      if (wishedProducts.size === 0) {
        setProducts([]);
        return;
      }

      setLoadingProducts(true);
      try {
        const productIds = Array.from(wishedProducts);
        const productPromises = productIds.map(id => fetchProductById(id));
        const results = await Promise.all(productPromises);
        
        // Lá»c nhá»¯ng sáº£n pháº©m fetch thÃ nh cÃ´ng
        const validProducts = results.filter(p => p && p.product_id);
        setProducts(validProducts);
      } catch (error) {
        console.error('Load products error:', error);
      } finally {
        setLoadingProducts(false);
      }
    };

    loadProducts();
  }, [wishedProducts]);

  const formatPrice = (price: number) => price?.toLocaleString('vi-VN') + 'â‚«';

  const handleRemove = async (productId: number) => {
    await toggleWishlist(productId);
  };

  if (loading || loadingProducts) {
    return (
      <div className="min-h-screen bg-gray-50 flex items-center justify-center">
        <div className="animate-spin rounded-full h-16 w-16 border-t-4 border-pink-600"></div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-gray-50 py-8">
      <div className="max-w-7xl mx-auto px-4">
        <div className="flex items-center justify-between mb-8">
          <div>
            <h1 className="text-2xl md:text-3xl font-bold flex items-center gap-3">
              <Heart className="w-8 h-8 text-pink-600 fill-pink-600" />
              Sáº£n pháº©m yÃªu thÃ­ch
            </h1>
            <p className="text-gray-500 mt-1">{wishlistCount} sáº£n pháº©m</p>
          </div>
          <Link href="/shop" className="text-pink-600 hover:underline flex items-center gap-1">
            <ArrowLeft className="w-4 h-4" />
            Tiáº¿p tá»¥c mua sáº¯m
          </Link>
        </div>

        {products.length === 0 ? (
          <div className="bg-white rounded-2xl shadow-sm p-12 text-center">
            <Heart className="w-24 h-24 text-gray-300 mx-auto mb-6" />
            <h2 className="text-2xl font-bold mb-4">ChÆ°a cÃ³ sáº£n pháº©m yÃªu thÃ­ch</h2>
            <p className="text-gray-500 mb-8">
              HÃ£y thÃªm sáº£n pháº©m vÃ o danh sÃ¡ch yÃªu thÃ­ch Ä‘á»ƒ dá»… dÃ ng theo dÃµi!
            </p>
            <Link
              href="/shop"
              className="inline-flex items-center gap-2 bg-gradient-to-r from-pink-600 to-purple-600 text-white px-8 py-3 rounded-full font-semibold hover:from-pink-700 hover:to-purple-700 transition"
            >
              KhÃ¡m phÃ¡ sáº£n pháº©m
            </Link>
          </div>
        ) : (
          <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
            {products.map((product) => (
              <div
                key={product.product_id}
                className="bg-white rounded-xl overflow-hidden shadow-sm hover:shadow-lg transition group"
              >
                <div className="relative">
                  <Link href={`/product/${product.product_id}`}>
                    <img
                      src={product.image_url || 'https://i.pinimg.com/1200x/f4/0a/de/f40ade8f15c8354c5eb584af2b1ebd82.jpg'}
                      alt={product.product_name}
                      className="w-full h-56 object-cover group-hover:scale-105 transition duration-300"
                    />
                  </Link>

                  <button
                    onClick={() => handleRemove(product.product_id)}
                    className="absolute top-3 right-3 bg-white p-2 rounded-full shadow opacity-0 group-hover:opacity-100 transition hover:bg-red-50"
                    title="XÃ³a khá»i yÃªu thÃ­ch"
                  >
                    <Trash2 className="w-5 h-5 text-red-500" />
                  </button>
                </div>

                <div className="p-4">
                  <Link href={`/product/${product.product_id}`}>
                    <h3 className="font-semibold line-clamp-2 mb-2 hover:text-pink-600 transition">
                      {product.product_name}
                    </h3>
                  </Link>

                  <div className="flex items-center gap-1 mb-3">
                    <Star className="w-4 h-4 fill-yellow-400 text-yellow-400" />
                    <span className="text-sm">4.5</span>
                    <span className="text-sm text-gray-500">(0)</span>
                  </div>

                  <div className="flex items-center justify-between">
                    <span className="text-lg font-bold text-pink-600">
                      {formatPrice(product.sale_price || product.price)}
                    </span>
                    <AddToCartButton productId={product.product_id} />
                  </div>
                </div>
              </div>
            ))}
          </div>
        )}
      </div>
    </div>
  );
}




################################################################################
## FILE 117: page.tsx
## Path: fontend/src/app/account/page.tsx
################################################################################

'use client';

import React, { useState, useEffect } from 'react';
import { ShoppingCart, User, Heart, Search, Menu } from 'lucide-react';
import Link from 'next/link';
import { useRouter } from 'next/navigation';
import { fetchCategories, loginCustomer } from '@/lib/api-client';

const AccountPage: React.FC = () => {
  const router = useRouter();
  const [cartCount, setCartCount] = useState(0);
  const [wishlistCount, setWishlistCount] = useState(0);
  const [selectedDevice, setSelectedDevice] = useState('iPhone 17 Pro Max');
  const [isCurrencyModalOpen, setIsCurrencyModalOpen] = useState(false);
  const [selectedCurrency, setSelectedCurrency] = useState('USD');
  const [email, setEmail] = useState('');
  const [password, setPassword] = useState('');
  const [devices, setDevices] = useState<string[]>(['iPhone 17 Pro Max']);

  useEffect(() => {
    const loadCategories = async () => {
      try {
        const data = await fetchCategories();
        if (Array.isArray(data) && data.length > 0) {
          const categoryNames = data.map((cat: any) => cat.category_name);
          setDevices(categoryNames);
          setSelectedDevice(categoryNames[0]);
        }
      } catch (error) {
        console.error('Error loading categories:', error);
      }
    };
    loadCategories();
  }, []);

  const handleSignIn = async (e: React.FormEvent) => {
    e.preventDefault();
    
    try {
      const result = await loginCustomer(email, password);
      
      if (result.success) {
        // LÆ°u thÃ´ng tin user vÃ o localStorage
        const user = result.customer || result.user;
        localStorage.setItem('customer', JSON.stringify(user));
        
        // Kiá»ƒm tra role admin
        const isAdmin = result.role === 'admin' || 
                        user?.role === 'admin' || 
                        user?.email?.toLowerCase().includes('admin');
        
        localStorage.setItem('userRole', isAdmin ? 'admin' : 'customer');
        
        // Hiá»ƒn thá»‹ thÃ´ng bÃ¡o
        alert(`ÄÄƒng nháº­p thÃ nh cÃ´ng vá»›i: ${email}`);
        
        // Redirect dá»±a trÃªn role
        if (isAdmin) {
          router.push('/admin');
        } else {
          router.push('/');
        }
      } else {
        alert(result.message || 'ÄÄƒng nháº­p tháº¥t báº¡i. Vui lÃ²ng kiá»ƒm tra láº¡i email vÃ  máº­t kháº©u.');
      }
    } catch (error: any) {
      alert(error.response?.data?.message || 'CÃ³ lá»—i xáº£y ra, vui lÃ²ng thá»­ láº¡i');
    }
  };

  const handleCreateAccount = () => {
    window.location.href = '/register';
  };

  const handleCurrencyChange = (currency: string) => {
    setSelectedCurrency(currency);
    setIsCurrencyModalOpen(false);
  };

  return (
    <div className="min-h-screen bg-slate-50">
      {/* Currency Modal */}
      {isCurrencyModalOpen && (
        <div
          className="fixed inset-0 z-50 flex items-center justify-center bg-black/40"
          onClick={() => setIsCurrencyModalOpen(false)}
        >
          <div
            className="bg-white rounded-xl p-6 max-w-md w-full mx-4 shadow-xl border border-slate-200"
            onClick={(e) => e.stopPropagation()}
          >
            <div className="flex items-center justify-between mb-6">
              <h2 className="text-xl font-bold text-slate-900">
                CHá»ŒN LOáº I TIá»€N Tá»†
              </h2>
              <button
                onClick={() => setIsCurrencyModalOpen(false)}
                className="text-slate-500 hover:text-slate-700"
              >
                <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                </svg>
              </button>
            </div>

            <div className="mb-6">
              <label className="block text-sm font-semibold mb-2 text-slate-700">
                QUá»C GIA/KHU Vá»°C:
              </label>
              <select
                className="w-full px-4 py-3 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-500"
                value={selectedCurrency}
                onChange={(e) => handleCurrencyChange(e.target.value)}
              >
                <option value="USD">United States (USD $)</option>
                <option value="VND">Viá»‡t Nam (VND â‚«)</option>
              </select>
            </div>

            <button
              onClick={() => setIsCurrencyModalOpen(false)}
              className="w-full bg-pink-600 text-white py-3 rounded-lg font-semibold hover:bg-pink-700 transition"
            >
              ÃP Dá»¤NG
            </button>
          </div>
        </div>
      )}

      {/* Top Banner */}
      <div className="bg-slate-900 text-white py-2 px-4 text-center text-sm">
        <div className="max-w-7xl mx-auto flex items-center justify-center gap-4">
          <span>Miá»…n phÃ­ váº­n chuyá»ƒn cho Ä‘Æ¡n hÃ ng trÃªn 100K</span>
          <span className="hidden md:inline">|</span>
          <span className="hidden md:inline">
            Æ¯u Ä‘Ã£i GoatTech: Mua 4 á»‘p - Tráº£ tiá»n 2 á»‘p
          </span>
        </div>
      </div>

      {/* Header */}
    <header className="bg-slate-900 shadow-md sticky top-0 z-40">
      <div className="max-w-7xl mx-auto px-4 py-4">
        <div className="flex items-center justify-between gap-4">
          <div className="flex items-center gap-4">
            <button className="lg:hidden text-slate-200 hover:text-pink-400">
              <Menu className="w-6 h-6" />
            </button>
            <button className="lg:hidden text-slate-200 hover:text-pink-400">
              <Search className="w-6 h-6" />
            </button>
          </div>

          <Link
            href="/"
            className="text-2xl font-bold tracking-wider text-white hover:text-pink-400 transition"
          >
            GoatTech
          </Link>

          <div className="flex items-center gap-4">
            <button
              className="hidden lg:block px-4 py-2 text-sm font-medium border border-slate-600 text-slate-200 rounded-lg hover:border-pink-500 hover:text-pink-400 transition"
              onClick={() => setIsCurrencyModalOpen(true)}
            >
              ðŸŒ {selectedCurrency} {selectedCurrency === 'USD' ? '$' : 'â‚«'}
            </button>

            <select
              value={selectedDevice}
              onChange={(e) => setSelectedDevice(e.target.value)}
              className="hidden lg:block px-4 py-2 border border-slate-600 bg-slate-900 text-slate-200 rounded-lg text-sm focus:outline-none focus:border-pink-500"
            >
              {devices.map((device) => (
                <option key={device} value={device} className="text-black">
                  {device}
                </option>
              ))}
            </select>

            <button className="relative text-slate-200 hover:text-pink-400 transition">
              <Heart className="w-6 h-6" />
              {wishlistCount > 0 && (
                <span className="absolute -top-1 -right-1 bg-emerald-500 text-white text-xs w-5 h-5 rounded-full flex items-center justify-center">
                  {wishlistCount}
                </span>
              )}
            </button>

            <button className="text-slate-200 hover:text-pink-400 transition">
              <User className="w-6 h-6" />
            </button>

            <button className="relative text-slate-200 hover:text-pink-400 transition">
              <ShoppingCart className="w-6 h-6" />
              {cartCount > 0 && (
                <span className="absolute -top-1 -right-1 bg-pink-600 text-white text-xs w-5 h-5 rounded-full flex items-center justify-center">
                  {cartCount}
                </span>
              )}
            </button>
          </div>
        </div>

        {/* Desktop Navigation */}
        <nav className="hidden lg:flex items-center justify-center gap-8 mt-4 pt-4 border-t border-slate-700">
          <Link href="/" className="text-sm font-medium text-slate-200 hover:text-pink-400">
            Trang Chá»§
          </Link>
          <Link href="/shop" className="text-sm font-medium text-slate-200 hover:text-pink-400">
            Cá»­a HÃ ng
          </Link>
          <button className="text-sm font-medium text-slate-200 hover:text-pink-400">
            Bá»™ SÆ°u Táº­p
          </button>
          <Link href="/about" className="text-sm font-medium text-slate-200 hover:text-pink-400">
            Vá» ChÃºng TÃ´i
          </Link>
          <Link href="/contact" className="text-sm font-medium text-slate-200 hover:text-pink-400">
            LiÃªn Há»‡
          </Link>
          <Link
            href="/promotions"
            className="text-sm font-semibold text-pink-500 hover:text-pink-400"
          >
            Khuyáº¿n Máº¡i
          </Link>
        </nav>
      </div>
    </header>


      {/* Hero Banner */}
      <div className="relative w-full h-[400px] bg-slate-100 overflow-hidden">
        <div className="flex items-center justify-center h-full gap-0 px-4">
          <img src="/banneraccount.jpg" alt="Left Banner" className="h-full w-auto object-contain" />
          <img src="/banneraccount.jpg" alt="Center Banner" className="h-full w-auto object-contain" />
          <img src="/banneraccount.jpg" alt="Right Banner" className="h-full w-auto object-contain" />
        </div>
      </div>

      {/* Account Section */}
      <div className="max-w-7xl mx-auto px-4 py-16">
        <div className="grid grid-cols-1 lg:grid-cols-2 gap-12">
          <div>
            <h1 className="text-3xl font-bold mb-4 text-slate-900">
              CHÃ€O Má»ªNG TRá»ž Láº I
            </h1>
            <p className="text-slate-600 mb-8">
              ÄÄƒng nháº­p Ä‘á»ƒ xem Ä‘Æ¡n hÃ ng vÃ  quáº£n lÃ½ tÃ i khoáº£n cá»§a báº¡n.
            </p>

            <form onSubmit={handleSignIn}>
              <div className="mb-6">
                <label className="block text-sm font-semibold mb-2 text-slate-700">
                  Äá»‹a chá»‰ Email:
                </label>
                <input
                  type="email"
                  value={email}
                  onChange={(e) => setEmail(e.target.value)}
                  placeholder="Nháº­p email cá»§a báº¡n"
                  className="w-full px-4 py-3 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-500"
                  required
                />
              </div>

              <div className="mb-6">
                <label className="block text-sm font-semibold mb-2 text-slate-700">
                  Máº­t kháº©u:
                </label>
                <input
                  type="password"
                  value={password}
                  onChange={(e) => setPassword(e.target.value)}
                  placeholder="Nháº­p máº­t kháº©u"
                  className="w-full px-4 py-3 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-500"
                  required
                />
              </div>

              <button
                type="submit"
                className="w-full bg-pink-600 text-white py-3 rounded-lg font-semibold hover:bg-pink-700 transition mb-4"
              >
                ÄÄ‚NG NHáº¬P
              </button>

              <button
                type="button"
                className="w-full text-sm text-slate-500 hover:text-pink-500 underline"
              >
                QuÃªn máº­t kháº©u?
              </button>
            </form>
          </div>

          <div>
            <h1 className="text-3xl font-bold mb-4 text-slate-900">
              Táº O TÃ€I KHOáº¢N
            </h1>
            <p className="text-slate-600 mb-8">
              Táº¡o tÃ i khoáº£n GoatTech má»›i Ä‘á»ƒ theo dÃµi Ä‘Æ¡n hÃ ng vÃ  quáº£n lÃ½ tÃ i khoáº£n.
            </p>

            <button
              onClick={handleCreateAccount}
              className="w-full bg-slate-900 text-white py-4 rounded-lg font-semibold hover:bg-slate-800 transition text-lg"
            >
              Táº O TÃ€I KHOáº¢N
            </button>
          </div>
        </div>
      </div>

      {/* Footer */}
      <footer className="bg-slate-900 text-white py-12">
        <div className="max-w-7xl mx-auto px-4">
          <div className="grid grid-cols-1 md:grid-cols-4 gap-8 mb-8">
            <div>
              <h3 className="text-2xl font-bold mb-4">GoatTech</h3>
              <p className="text-slate-400">
                á»p Ä‘iá»‡n thoáº¡i cao cáº¥p vÃ  phá»¥ kiá»‡n cÃ´ng nghá»‡
              </p>
            </div>

            <div>
              <h4 className="font-semibold mb-4">Cá»­a HÃ ng</h4>
              <ul className="space-y-2 text-slate-400">
                <li><Link href="/shop" className="hover:text-pink-500 block">á»p iPhone</Link></li>
                <li><Link href="/shop" className="hover:text-pink-500 block">Phá»¥ Kiá»‡n</Link></li>
                <li><Link href="/shop" className="hover:text-pink-500 block">HÃ ng Má»›i Vá»</Link></li>
                <li><Link href="/promotions" className="hover:text-pink-500 block">Khuyáº¿n Máº¡i</Link></li>
              </ul>
            </div>

            <div>
              <h4 className="font-semibold mb-4">Há»— Trá»£</h4>
              <ul className="space-y-2 text-slate-400">
                <li><Link href="/contact" className="hover:text-pink-500 block">LiÃªn Há»‡ ChÃºng TÃ´i</Link></li>
                <li><button className="hover:text-pink-500 text-left">ThÃ´ng Tin Váº­n Chuyá»ƒn</button></li>
                <li><button className="hover:text-pink-500 text-left">ChÃ­nh SÃ¡ch HoÃ n HÃ ng</button></li>
                <li><button className="hover:text-pink-500 text-left">CÃ¢u Há»i ThÆ°á»ng Gáº·p</button></li>
              </ul>
            </div>

            <div>
              <h4 className="font-semibold mb-4">Theo DÃµi ChÃºng TÃ´i</h4>
              <ul className="space-y-2 text-slate-400">
                <li><button className="hover:text-pink-500 text-left">Instagram</button></li>
                <li><button className="hover:text-pink-500 text-left">Facebook</button></li>
                <li><button className="hover:text-pink-500 text-left">TikTok</button></li>
                <li><button className="hover:text-pink-500 text-left">YouTube</button></li>
              </ul>
            </div>
          </div>

          <div className="border-t border-slate-800 pt-8 text-center text-slate-400">
            <p>
              &copy; 2024 GoatTech - á»p Äiá»‡n Thoáº¡i Sá»‘ 1 Viá»‡t Nam. Báº£o LÆ°u Má»i Quyá»n.
            </p>
          </div>
        </div>
      </footer>
    </div>
  );

};

export default AccountPage;




################################################################################
## FILE 118: page.tsx
## Path: fontend/src/app/admin/page.tsx
################################################################################

'use client';

import React, { useState, useEffect } from 'react';
import { useRouter } from 'next/navigation';
import { 
  LayoutDashboard, 
  Package, 
  ShoppingCart, 
  Users, 
  FolderTree, 
  Star, 
  Settings,
  LogOut,
  Menu,
  X,
  TrendingUp,
  DollarSign,
  ShoppingBag,
  UserCheck,
  Search,
  Filter,
  Edit,
  Trash2,
  Eye,
  Plus,
  Check,
  XCircle,
  MessageSquare
} from 'lucide-react';
import Link from 'next/link';
import { fetchProducts, fetchOrders, fetchAllOrdersAdmin, fetchUsers, fetchCategories, createProduct, updateProduct, deleteProduct, createCategory, updateCategory, deleteCategory, fetchAllReviews, approveReview, deleteReview, fetchAllContacts, updateContactStatus, deleteContact, fetchAllCollections, updateProductCollections, fetchProductCollections, fetchAdminDashboard } from '@/lib/api-client';

interface Collection {
  collection_id: number;
  collection_name: string;
  collection_slug: string;
  collection_type: string;
  is_active: boolean;
}

interface Product {
  product_id: number;
  product_name: string;
  product_slug: string;
  sku: string;
  description?: string;
  short_description?: string;
  price: number;
  sale_price?: number;
  category_id?: number;
  brand_id?: number;
  is_featured: boolean;
  is_new: boolean;
  is_bestseller: boolean;
  status: string;
}

interface Order {
  order_id: number;
  order_number: string;
  customer_id: string | null;
  order_status: string;
  payment_status: string;
  total_amount: number;
  created_at: string;
  shipping_full_name?: string;
  shipping_phone?: string;
  shipping_address?: string;
  customer_note?: string;
}

interface Customer {
  id: string;
  full_name: string;
  email: string;
  phone?: string;
  role?: string;
  status?: string;
  created_at: string;
}

interface Category {
  category_id: number;
  category_name: string;
  category_slug: string;
  description?: string;
  parent_category_id?: number;
  is_active: boolean;
  display_order: number;
}

interface Review {
  review_id: number;
  product_id: number;
  user_id: string;
  rating: number;
  review_title?: string;
  review_text?: string;
  is_approved: boolean;
  created_at: string;
  user_name?: string;
  product_name?: string;
}

interface ContactMessage {
  id: number;
  name: string;
  email: string;
  phone?: string;
  subject?: string;
  message: string;
  status: string;
  created_at: string;
}

const AdminDashboard: React.FC = () => {
  const router = useRouter();
  const [activeTab, setActiveTab] = useState('dashboard');
  const [isSidebarOpen, setIsSidebarOpen] = useState(true);
  const [isMounted, setIsMounted] = useState(false);
  const [isAuthenticated, setIsAuthenticated] = useState(false);
  
  // Data states
  const [products, setProducts] = useState<Product[]>([]);
  const [orders, setOrders] = useState<Order[]>([]);
  const [customers, setCustomers] = useState<Customer[]>([]);
  const [categories, setCategories] = useState<Category[]>([]);
  const [reviews, setReviews] = useState<Review[]>([]);
  const [contacts, setContacts] = useState<ContactMessage[]>([]);
  const [collections, setCollections] = useState<Collection[]>([]);
  const [loading, setLoading] = useState(false);
  
  // Selected collections for product form
  const [selectedCollections, setSelectedCollections] = useState<number[]>([]);
  
  // Modal states
  const [showModal, setShowModal] = useState(false);
  const [modalType, setModalType] = useState<'add' | 'edit'>('add');
  const [selectedItem, setSelectedItem] = useState<any>(null);
  
  // Form states for product
  const [formData, setFormData] = useState({
    product_name: '',
    sku: '',
    description: '',
    short_description: '',
    price: 0,
    sale_price: 0,
    category_id: null as number | null,
    image_url: '',
    is_featured: false,
    is_new: true,
    status: 'active',
    season: '' as string // MÃ¹a lá»…: noel, valentine, tet hoáº·c rá»—ng
  });

  // Form states for category
  const [categoryFormData, setCategoryFormData] = useState({
    category_name: '',
    category_slug: '',
    description: '',
    display_order: 0,
    is_active: true
  });

  // Category modal state
  const [showCategoryModal, setShowCategoryModal] = useState(false);
  const [categoryModalType, setCategoryModalType] = useState<'add' | 'edit'>('add');
  const [selectedCategory, setSelectedCategory] = useState<any>(null);
  
  // Search & Filter
  const [searchTerm, setSearchTerm] = useState('');
  const [filterStatus, setFilterStatus] = useState('all');

  // Kiá»ƒm tra quyá»n admin
  useEffect(() => {
    const userRole = localStorage.getItem('userRole');
    const customer = localStorage.getItem('customer');
    
    if (!customer || userRole !== 'admin') {
      router.push('/login');
      return;
    }
    
    setIsAuthenticated(true);
    setIsMounted(true);
  }, [router]);

  useEffect(() => {
    if (isMounted && isAuthenticated) {
      loadData();
    }
  }, [activeTab, isMounted, isAuthenticated]);

  const loadData = async () => {
    try {
      setLoading(true);
      if (activeTab === 'products' || activeTab === 'dashboard') {
        const data = await fetchProducts(100);
        setProducts(Array.isArray(data) ? data : []);
        // Load collections for product form
        try {
          const collectionsData = await fetchAllCollections();
          setCollections(Array.isArray(collectionsData) ? collectionsData : []);
        } catch (e) {
          console.log('Collections not available yet');
        }
      }
      if (activeTab === 'orders' || activeTab === 'dashboard') {
        const data = await fetchAllOrdersAdmin();
        setOrders(Array.isArray(data) ? data : []);
      }
      if (activeTab === 'customers' || activeTab === 'dashboard') {
        const data = await fetchUsers();
        setCustomers(Array.isArray(data) ? data : []);
      }
      if (activeTab === 'categories' || activeTab === 'dashboard') {
        const data = await fetchCategories();
        setCategories(Array.isArray(data) ? data : []);
      }
      if (activeTab === 'reviews' || activeTab === 'dashboard') {
        const data = await fetchAllReviews();
        setReviews(Array.isArray(data) ? data : []);
      }
      if (activeTab === 'contacts' || activeTab === 'dashboard') {
        const data = await fetchAllContacts();
        setContacts(Array.isArray(data) ? data : []);
      }
    } catch (error) {
      console.error('Error loading data:', error);
    } finally {
      setLoading(false);
    }
  };

  const [dashboard, setDashboard] = useState<any>(null);

  useEffect(() => {
    if (isMounted && isAuthenticated && activeTab === 'dashboard') {
      fetchAdminDashboard().then(setDashboard).catch(console.error);
    }
  }, [isMounted, isAuthenticated, activeTab]);

  const revenue7Days = dashboard?.revenue7Days || [];
  const bestSellers = dashboard?.bestSellers || [];

  const stats = dashboard ? [
    {
      label: 'Tá»•ng Doanh Thu',
      value: (dashboard.totalRevenue || 0).toLocaleString('vi-VN') + 'â‚«',
      icon: DollarSign,
      color: 'bg-green-500'
    },
    {
      label: 'ÄÆ¡n HÃ ng',
      value: (dashboard.orderCount || 0).toString(),
      icon: ShoppingCart,
      color: 'bg-blue-500'
    },
    {
      label: 'Sáº£n Pháº©m',
      value: (dashboard.productCount || 0).toString(),
      icon: Package,
      color: 'bg-purple-500'
    },
    {
      label: 'KhÃ¡ch HÃ ng',
      value: (dashboard.customerCount || 0).toString(),
      icon: Users,
      color: 'bg-orange-500'
    }
  ] : [
    { 
      label: 'Tá»•ng Doanh Thu', 
      value: orders.reduce((sum, order) => sum + (order.total_amount || 0), 0).toLocaleString('vi-VN') + 'â‚«', 
      icon: DollarSign, 
      color: 'bg-green-500', 
      change: '+12.5%' 
    },
    { 
      label: 'ÄÆ¡n HÃ ng', 
      value: orders.length.toString(), 
      icon: ShoppingCart, 
      color: 'bg-blue-500', 
      change: '+8.2%' 
    },
    { 
      label: 'Sáº£n Pháº©m', 
      value: products.length.toString(), 
      icon: Package, 
      color: 'bg-purple-500', 
      change: '+3.1%' 
    },
    { 
      label: 'KhÃ¡ch HÃ ng', 
      value: customers.length.toString(), 
      icon: Users, 
      color: 'bg-orange-500', 
      change: '+15.3%' 
    }
  ];

  const menuItems = [
    { id: 'dashboard', label: 'Tá»•ng Quan', icon: LayoutDashboard },
    { id: 'products', label: 'Sáº£n Pháº©m', icon: Package },
    { id: 'orders', label: 'ÄÆ¡n HÃ ng', icon: ShoppingCart },
    { id: 'customers', label: 'KhÃ¡ch HÃ ng', icon: Users },
    { id: 'categories', label: 'Danh Má»¥c', icon: FolderTree },
    { id: 'reviews', label: 'ÄÃ¡nh GiÃ¡', icon: Star },
    { id: 'contacts', label: 'Tin Nháº¯n', icon: MessageSquare },
    { id: 'designs', label: ' Thiáº¿t Káº¿', icon: Package, isLink: true, href: '/admin/designs' },
    { id: 'templates', label: 'CÃ¡c máº«u Ä‘iá»‡n thoáº¡i', icon: Package, isLink: true, href: '/admin/templates' },
    { id: 'settings', label: 'CÃ i Äáº·t', icon: Settings }
  ];

  const getStatusColor = (status: string) => {
    switch (status.toLowerCase()) {
      case 'pending':
      case 'Ä‘ang xá»­ lÃ½': return 'bg-yellow-100 text-yellow-800';
      case 'processing':
      case 'Ä‘ang giao': return 'bg-blue-100 text-blue-800';
      case 'completed':
      case 'delivered':
      case 'Ä‘Ã£ giao': return 'bg-green-100 text-green-800';
      case 'cancelled':
      case 'Ä‘Ã£ há»§y': return 'bg-red-100 text-red-800';
      default: return 'bg-gray-100 text-gray-800';
    }
  };

  const openModal = async (type: 'add' | 'edit', item?: any) => {
    setModalType(type);
    setSelectedItem(item || null);
    if (type === 'edit' && item) {
      setFormData({
        product_name: item.product_name || '',
        sku: item.sku || '',
        description: item.description || '',
        short_description: item.short_description || '',
        price: item.price || 0,
        sale_price: item.sale_price || 0,
        category_id: item.category_id || null,
        image_url: item.image_url || '',
        is_featured: item.is_featured || false,
        is_new: item.is_new || false,
        status: item.status || 'active',
        season: item.season || ''
      });
      // Load collections cá»§a sáº£n pháº©m
      try {
        const productColls = await fetchProductCollections(item.product_id);
        const collIds = productColls.map((pc: any) => pc.collection_id);
        setSelectedCollections(collIds);
      } catch (e) {
        setSelectedCollections([]);
      }
    } else {
      setFormData({
        product_name: '',
        sku: '',
        description: '',
        short_description: '',
        price: 0,
        sale_price: 0,
        category_id: null,
        image_url: '',
        is_featured: false,
        is_new: true,
        status: 'active',
        season: ''
      });
      setSelectedCollections([]);
    }
    setShowModal(true);
  };

  const closeModal = () => {
    setShowModal(false);
    setSelectedItem(null);
    setSelectedCollections([]);
  };

  const handleCollectionToggle = (collectionId: number) => {
    setSelectedCollections(prev => 
      prev.includes(collectionId)
        ? prev.filter(id => id !== collectionId)
        : [...prev, collectionId]
    );
  };

  const handleSaveProduct = async () => {
    // Validate báº¯t buá»™c chá»n danh má»¥c
    if (!formData.category_id) {
      alert('Vui lÃ²ng chá»n danh má»¥c sáº£n pháº©m!');
      return;
    }
    
    try {
      setLoading(true);
      
      // Tá»± Ä‘á»™ng táº¡o slug tá»« tÃªn sáº£n pháº©m
      const slug = formData.product_name
        .toLowerCase()
        .normalize('NFD')
        .replace(/[\u0300-\u036f]/g, '') // Bá» dáº¥u tiáº¿ng Viá»‡t
        .replace(/Ä‘/g, 'd')
        .replace(/[^a-z0-9\s-]/g, '')
        .replace(/\s+/g, '-')
        .replace(/-+/g, '-')
        .trim();
      
      const dataToSend = {
        ...formData,
        product_slug: slug
      };
      
      // Debug log
      console.log('=== FRONTEND DEBUG ===');
      console.log('formData:', formData);
      console.log('dataToSend:', dataToSend);
      console.log('image_url:', dataToSend.image_url);
      
      let productId: number;
      
      if (modalType === 'add') {
        const result = await createProduct(dataToSend);
        if (result.success) {
          productId = result.data?.product_id;
          // LÆ°u collections cho sáº£n pháº©m má»›i
          if (productId && selectedCollections.length > 0) {
            try {
              await updateProductCollections(productId, selectedCollections);
            } catch (e) {
              console.log('Could not save collections');
            }
          }
          alert('ThÃªm sáº£n pháº©m thÃ nh cÃ´ng!');
        } else {
          alert('Lá»—i: ' + result.message);
        }
      } else {
        const result = await updateProduct(selectedItem.product_id, dataToSend);
        if (result.success) {
          // Cáº­p nháº­t collections cho sáº£n pháº©m
          try {
            await updateProductCollections(selectedItem.product_id, selectedCollections);
          } catch (e) {
            console.log('Could not update collections');
          }
          alert('Cáº­p nháº­t sáº£n pháº©m thÃ nh cÃ´ng!');
        } else {
          alert('Lá»—i: ' + result.message);
        }
      }
      closeModal();
      loadData();
    } catch (error: any) {
      alert('Lá»—i: ' + error.message);
    } finally {
      setLoading(false);
    }
  };

  const handleDeleteProduct = async (id: number) => {
    if (confirm('Báº¡n cÃ³ cháº¯c cháº¯n muá»‘n xÃ³a sáº£n pháº©m nÃ y?')) {
      try {
        const result = await deleteProduct(id);
        if (result.success) {
          alert('XÃ³a sáº£n pháº©m thÃ nh cÃ´ng!');
          loadData();
        } else {
          alert('Lá»—i: ' + result.message);
        }
      } catch (error: any) {
        alert('Lá»—i: ' + error.message);
      }
    }
  };

  const handleDelete = (id: number) => {
    if (confirm('Báº¡n cÃ³ cháº¯c cháº¯n muá»‘n xÃ³a?')) {
      console.log('Delete item:', id);
      loadData();
    }
  };

  // Category modal functions
  const openCategoryModal = (type: 'add' | 'edit', category?: any) => {
    setCategoryModalType(type);
    setSelectedCategory(category || null);
    if (type === 'edit' && category) {
      setCategoryFormData({
        category_name: category.category_name || '',
        category_slug: category.category_slug || '',
        description: category.description || '',
        display_order: category.display_order || 0,
        is_active: category.is_active ?? true
      });
    } else {
      setCategoryFormData({
        category_name: '',
        category_slug: '',
        description: '',
        display_order: 0,
        is_active: true
      });
    }
    setShowCategoryModal(true);
  };

  const closeCategoryModal = () => {
    setShowCategoryModal(false);
    setSelectedCategory(null);
  };

  const handleSaveCategory = async () => {
    try {
      setLoading(true);
      
      // Tá»± Ä‘á»™ng táº¡o slug tá»« tÃªn danh má»¥c
      const slug = categoryFormData.category_slug || categoryFormData.category_name
        .toLowerCase()
        .normalize('NFD')
        .replace(/[\u0300-\u036f]/g, '')
        .replace(/Ä‘/g, 'd')
        .replace(/[^a-z0-9\s-]/g, '')
        .replace(/\s+/g, '-')
        .replace(/-+/g, '-')
        .trim();
      
      const dataToSend = {
        ...categoryFormData,
        category_slug: slug
      };
      
      if (categoryModalType === 'add') {
        const result = await createCategory(dataToSend);
        if (result.data) {
          alert('ThÃªm danh má»¥c thÃ nh cÃ´ng!');
        } else {
          alert('Lá»—i: ' + (result.error?.message || 'KhÃ´ng thá»ƒ thÃªm danh má»¥c'));
        }
      } else {
        const result = await updateCategory(selectedCategory.category_id, dataToSend);
        if (result.data) {
          alert('Cáº­p nháº­t danh má»¥c thÃ nh cÃ´ng!');
        } else {
          alert('Lá»—i: ' + (result.error?.message || 'KhÃ´ng thá»ƒ cáº­p nháº­t danh má»¥c'));
        }
      }
      closeCategoryModal();
      loadData();
    } catch (error: any) {
      alert('Lá»—i: ' + error.message);
    } finally {
      setLoading(false);
    }
  };

  const handleDeleteCategory = async (id: number) => {
    if (confirm('Báº¡n cÃ³ cháº¯c cháº¯n muá»‘n xÃ³a danh má»¥c nÃ y?')) {
      try {
        const result = await deleteCategory(id);
        if (!result.error) {
          alert('XÃ³a danh má»¥c thÃ nh cÃ´ng!');
          loadData();
        } else {
          alert('Lá»—i: ' + result.error.message);
        }
      } catch (error: any) {
        alert('Lá»—i: ' + error.message);
      }
    }
  };

  // Review handlers
  const handleApproveReview = async (id: number, approve: boolean) => {
    try {
      const result = await approveReview(id, approve);
      if (!result.error) {
        alert(approve ? 'ÄÃ£ duyá»‡t Ä‘Ã¡nh giÃ¡!' : 'ÄÃ£ tá»« chá»‘i Ä‘Ã¡nh giÃ¡!');
        loadData();
      } else {
        alert('Lá»—i: ' + result.error.message);
      }
    } catch (error: any) {
      alert('Lá»—i: ' + error.message);
    }
  };

  const handleDeleteReview = async (id: number) => {
    if (confirm('Báº¡n cÃ³ cháº¯c cháº¯n muá»‘n xÃ³a Ä‘Ã¡nh giÃ¡ nÃ y?')) {
      try {
        const result = await deleteReview(id);
        if (!result.error) {
          alert('XÃ³a Ä‘Ã¡nh giÃ¡ thÃ nh cÃ´ng!');
          loadData();
        } else {
          alert('Lá»—i: ' + result.error.message);
        }
      } catch (error: any) {
        alert('Lá»—i: ' + error.message);
      }
    }
  };

  // Contact handlers
  const handleUpdateContactStatus = async (id: number, status: string) => {
    try {
      const result = await updateContactStatus(id, status);
      if (result.success) {
        alert(status === 'replied' ? 'ÄÃ£ Ä‘Ã¡nh dáº¥u Ä‘Ã£ tráº£ lá»i!' : 'Cáº­p nháº­t tráº¡ng thÃ¡i thÃ nh cÃ´ng!');
        loadData();
      } else {
        alert('Lá»—i: ' + result.error?.message);
      }
    } catch (error: any) {
      alert('Lá»—i: ' + error.message);
    }
  };

  const handleDeleteContact = async (id: number) => {
    if (confirm('Báº¡n cÃ³ cháº¯c cháº¯n muá»‘n xÃ³a tin nháº¯n nÃ y?')) {
      try {
        const result = await deleteContact(id);
        if (result.success) {
          alert('XÃ³a tin nháº¯n thÃ nh cÃ´ng!');
          loadData();
        } else {
          alert('Lá»—i: ' + result.error?.message);
        }
      } catch (error: any) {
        alert('Lá»—i: ' + error.message);
      }
    }
  };

  const filteredProducts = products.filter(p => 
    p.product_name?.toLowerCase().includes(searchTerm.toLowerCase())
  );

  const filteredOrders = orders.filter(o => 
    filterStatus === 'all' || o.order_status === filterStatus
  );

  const filteredCustomers = customers.filter(c => 
    c.full_name?.toLowerCase().includes(searchTerm.toLowerCase()) ||
    c.email?.toLowerCase().includes(searchTerm.toLowerCase())
  );

  const filteredCategories = categories.filter(c => 
    c.category_name?.toLowerCase().includes(searchTerm.toLowerCase())
  );

  const handleLogout = () => {
    localStorage.removeItem('customer');
    localStorage.removeItem('userRole');
    router.push('/login');
  };

  if (!isMounted || !isAuthenticated) {
    return (
      <div className="min-h-screen bg-gray-100 flex items-center justify-center">
        <div className="text-gray-500">Loading...</div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-gray-100 flex">
      {/* Sidebar */}
      <aside className={`${isSidebarOpen ? 'w-64' : 'w-20'} bg-gray-900 text-white transition-all duration-300 fixed h-full z-30`}>
        <div className="p-4 flex items-center justify-between border-b border-gray-800">
          {isSidebarOpen && <h1 className="text-xl font-bold">GoatTech Admin</h1>}
          <button onClick={() => setIsSidebarOpen(!isSidebarOpen)} className="p-2 hover:bg-gray-800 rounded">
            {isSidebarOpen ? <X className="w-5 h-5" /> : <Menu className="w-5 h-5" />}
          </button>
        </div>

        <nav className="mt-6">
          {menuItems.map((item: any) => (
            item.isLink ? (
              <Link
                key={item.id}
                href={item.href}
                className={`w-full flex items-center gap-3 px-4 py-3 hover:bg-gray-800 transition`}
              >
                <item.icon className="w-5 h-5" />
                {isSidebarOpen && <span>{item.label}</span>}
              </Link>
            ) : (
              <button
                key={item.id}
                onClick={() => setActiveTab(item.id)}
                className={`w-full flex items-center gap-3 px-4 py-3 hover:bg-gray-800 transition ${
                  activeTab === item.id ? 'bg-gray-800 border-l-4 border-pink-500' : ''
                }`}
              >
                <item.icon className="w-5 h-5" />
                {isSidebarOpen && <span>{item.label}</span>}
              </button>
            )
          ))}
        </nav>

        <div className="absolute bottom-0 w-full border-t border-gray-800">
          <button 
            onClick={handleLogout}
            className="w-full flex items-center gap-3 px-4 py-3 hover:bg-gray-800 transition text-red-400"
          >
            <LogOut className="w-5 h-5" />
            {isSidebarOpen && <span>ÄÄƒng Xuáº¥t</span>}
          </button>
        </div>
      </aside>

      {/* Main Content */}
      <main className={`flex-1 ${isSidebarOpen ? 'ml-64' : 'ml-20'} transition-all duration-300`}>
        {/* Top Bar */}
        <header className="bg-white shadow-sm p-4 flex items-center justify-between sticky top-0 z-20">
          <div>
            <h2 className="text-2xl font-bold">
              {menuItems.find(item => item.id === activeTab)?.label || 'Tá»•ng Quan'}
            </h2>
            <p className="text-sm text-gray-600">ChÃ o má»«ng trá»Ÿ láº¡i, Admin!</p>
          </div>
          <div className="flex items-center gap-4">
            <Link href="/" className="text-sm text-pink-600 hover:underline">Xem Website</Link>
            <div className="w-10 h-10 bg-pink-600 rounded-full flex items-center justify-center text-white font-bold">
              A
            </div>
          </div>
        </header>

        {/* Dashboard Content */}
        <div className="p-6">
          {activeTab === 'dashboard' && (
            <>
              {/* Stats Grid */}
              <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
                {stats.map((stat, index) => (
                  <div key={index} className="bg-white rounded-lg shadow p-6">
                    <div className="flex items-center justify-between mb-4">
                      <div className={`${stat.color} w-12 h-12 rounded-lg flex items-center justify-center`}>
                        <stat.icon className="w-6 h-6 text-white" />
                      </div>
                    </div>
                    <h3 className="text-gray-600 text-sm mb-1">{stat.label}</h3>
                    <p className="text-2xl font-bold">{stat.value}</p>
                  </div>
                ))}
              </div>

              {/* Charts Row */}
              <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                {/* Revenue Chart */}
                <div className="bg-white rounded-lg shadow p-6">
                  <h3 className="text-lg font-bold mb-4">Doanh Thu 7 NgÃ y Qua</h3>
                  <div className="h-64 flex items-end justify-around gap-2">
                    {revenue7Days.length === 7 ? revenue7Days.map((amount, i) => (
                      <div key={i} className="flex-1 flex flex-col items-center">
                        <div className="w-full bg-pink-600 rounded-t" style={{ height: `${Math.max(amount / Math.max(...revenue7Days, 1) * 100, 5)}%` }}></div>
                        <span className="text-xs text-gray-600 mt-2">T{i + 2}</span>
                        <span className="text-xs text-gray-500">{amount.toLocaleString('vi-VN')}â‚«</span>
                      </div>
                    )) : <div className="text-gray-400">KhÃ´ng cÃ³ dá»¯ liá»‡u</div>}
                  </div>
                </div>

                {/* Top Products */}
                <div className="bg-white rounded-lg shadow p-6">
                  <h3 className="text-lg font-bold mb-4">Sáº£n Pháº©m BÃ¡n Cháº¡y</h3>
                  <div className="space-y-4">
                    {bestSellers.length > 0 ? bestSellers.map((product, i) => (
                      <div key={product.id} className="flex items-center justify-between">
                        <div className="flex items-center gap-3">
                          <div className="w-10 h-10 bg-gray-200 rounded"></div>
                          <div>
                            <p className="font-medium">{product.name}</p>
                            <p className="text-sm text-gray-600">{product.sold} Ä‘Ã£ bÃ¡n</p>
                          </div>
                        </div>
                        <span className="font-bold text-pink-600">{Math.round(product.revenue/1000)}K</span>
                      </div>
                    )) : <div className="text-gray-400">KhÃ´ng cÃ³ dá»¯ liá»‡u</div>}
                  </div>
                </div>
              </div>

              {/* Recent Orders */}
              <div className="bg-white rounded-lg shadow">
                <div className="p-6 border-b">
                  <h3 className="text-lg font-bold">ÄÆ¡n HÃ ng Gáº§n ÄÃ¢y</h3>
                </div>
                <div className="overflow-x-auto">
                  <table className="w-full">
                    <thead className="bg-gray-50">
                      <tr>
                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">MÃ£ ÄH</th>
                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">NgÃ y Äáº·t</th>
                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Sá»‘ Tiá»n</th>
                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Tráº¡ng ThÃ¡i</th>
                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Thanh ToÃ¡n</th>
                      </tr>
                    </thead>
                    <tbody className="divide-y divide-gray-200">
                      {orders.slice(0, 5).map((order) => (
                        <tr key={order.order_id} className="hover:bg-gray-50">
                          <td className="px-6 py-4 whitespace-nowrap font-medium">#{order.order_number || order.order_id}</td>
                          <td className="px-6 py-4 whitespace-nowrap">{order.created_at ? new Date(order.created_at).toLocaleDateString('vi-VN') : '-'}</td>
                          <td className="px-6 py-4 whitespace-nowrap font-bold">{order.total_amount?.toLocaleString('vi-VN')}â‚«</td>
                          <td className="px-6 py-4 whitespace-nowrap">
                            <span className={`px-3 py-1 rounded-full text-xs font-medium ${getStatusColor(order.order_status)}`}>
                              {order.order_status}
                            </span>
                          </td>
                          <td className="px-6 py-4 whitespace-nowrap">
                            <span className={`px-3 py-1 rounded-full text-xs font-medium ${getStatusColor(order.payment_status)}`}>
                              {order.payment_status}
                            </span>
                          </td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>
              </div>
            </>
          )}

          {/* PRODUCTS TAB */}
          {activeTab === 'products' && (
            <div className="space-y-6">
              <div className="bg-white rounded-lg shadow p-6">
                <div className="flex items-center justify-between mb-6">
                  <h3 className="text-lg font-bold">Quáº£n LÃ½ Sáº£n Pháº©m ({products.length})</h3>
                  <button 
                    onClick={() => openModal('add')}
                    className="bg-pink-600 text-white px-4 py-2 rounded-lg hover:bg-pink-700 flex items-center gap-2"
                  >
                    <Plus className="w-4 h-4" /> ThÃªm Sáº£n Pháº©m
                  </button>
                </div>

                {/* Search */}
                <div className="mb-4 flex gap-4">
                  <div className="flex-1 relative">
                    <Search className="w-5 h-5 absolute left-3 top-1/2 -translate-y-1/2 text-gray-400" />
                    <input
                      type="text"
                      placeholder="TÃ¬m kiáº¿m sáº£n pháº©m..."
                      value={searchTerm}
                      onChange={(e) => setSearchTerm(e.target.value)}
                      className="w-full pl-10 pr-4 py-2 border rounded-lg"
                    />
                  </div>
                </div>

                {/* Table */}
                <div className="overflow-x-auto">
                  <table className="w-full">
                    <thead className="bg-gray-50">
                      <tr>
                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">ID</th>
                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">SKU</th>
                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">TÃªn Sáº£n Pháº©m</th>
                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">GiÃ¡</th>
                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">GiÃ¡ KM</th>
                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Tráº¡ng ThÃ¡i</th>
                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">HÃ nh Äá»™ng</th>
                      </tr>
                    </thead>
                    <tbody className="divide-y divide-gray-200">
                      {filteredProducts.map((product) => (
                        <tr key={product.product_id} className="hover:bg-gray-50">
                          <td className="px-6 py-4 whitespace-nowrap">#{product.product_id}</td>
                          <td className="px-6 py-4 whitespace-nowrap text-gray-500">{product.sku}</td>
                          <td className="px-6 py-4">{product.product_name}</td>
                          <td className="px-6 py-4 whitespace-nowrap font-bold">{product.price?.toLocaleString('vi-VN')}â‚«</td>
                          <td className="px-6 py-4 whitespace-nowrap text-pink-600">
                            {product.sale_price ? `${product.sale_price.toLocaleString('vi-VN')}â‚«` : '-'}
                          </td>
                          <td className="px-6 py-4 whitespace-nowrap">
                            <span className={`px-3 py-1 rounded-full text-xs font-medium ${
                              product.status === 'active' ? 'bg-green-100 text-green-800' : 
                              product.status === 'inactive' ? 'bg-red-100 text-red-800' : 
                              'bg-gray-100 text-gray-800'
                            }`}>
                              {product.status === 'active' ? 'Äang bÃ¡n' : 
                               product.status === 'inactive' ? 'Ngá»«ng bÃ¡n' : 'Báº£n nhÃ¡p'}
                            </span>
                          </td>
                          <td className="px-6 py-4 whitespace-nowrap">
                            <div className="flex items-center gap-2">
                              <button onClick={() => openModal('edit', product)} className="text-blue-600 hover:text-blue-800">
                                <Edit className="w-4 h-4" />
                              </button>
                              <button onClick={() => handleDeleteProduct(product.product_id)} className="text-red-600 hover:text-red-800">
                                <Trash2 className="w-4 h-4" />
                              </button>
                            </div>
                          </td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          )}

          {/* ORDERS TAB */}
          {activeTab === 'orders' && (
            <div className="bg-white rounded-lg shadow p-6">
              <div className="flex items-center justify-between mb-6">
                <h3 className="text-lg font-bold">Quáº£n LÃ½ ÄÆ¡n HÃ ng ({orders.length})</h3>
                <div className="flex gap-2">
                  <select 
                    value={filterStatus}
                    onChange={(e) => setFilterStatus(e.target.value)}
                    className="border rounded-lg px-3 py-2"
                  >
                    <option value="all">Táº¥t cáº£</option>
                    <option value="pending">Chá» xá»­ lÃ½</option>
                    <option value="processing">Äang xá»­ lÃ½</option>
                    <option value="completed">HoÃ n thÃ nh</option>
                    <option value="cancelled">ÄÃ£ há»§y</option>
                  </select>
                </div>
              </div>

              <div className="overflow-x-auto">
                <table className="w-full">
                  <thead className="bg-gray-50">
                    <tr>
                      <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">MÃ£ ÄH</th>
                      <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">KhÃ¡ch HÃ ng</th>
                      <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">NgÃ y Äáº·t</th>
                      <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Tá»•ng Tiá»n</th>
                      <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Tráº¡ng ThÃ¡i</th>
                      <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Thanh ToÃ¡n</th>
                      <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">HÃ nh Äá»™ng</th>
                    </tr>
                  </thead>
                  <tbody className="divide-y divide-gray-200">
                    {filteredOrders.map((order) => (
                      <tr key={order.order_id} className="hover:bg-gray-50">
                        <td className="px-6 py-4 whitespace-nowrap font-medium">#{order.order_number || order.order_id}</td>
                        <td className="px-6 py-4 whitespace-nowrap">
                          {order.customer_id ? (
                            <span>#{order.customer_id.slice(0, 8)}</span>
                          ) : order.shipping_full_name ? (
                            <div className="flex flex-col">
                              <span className="font-medium">{order.shipping_full_name}</span>
                              <span className="text-xs text-gray-500">{order.shipping_phone}</span>
                              {order.order_number?.startsWith('MSG') && (
                                <span className="text-xs text-blue-500"> Messenger</span>
                              )}
                            </div>
                          ) : (
                            <span className="text-gray-400">KhÃ¡ch vÃ£ng lai</span>
                          )}
                        </td>
                        <td className="px-6 py-4 whitespace-nowrap">{order.created_at ? new Date(order.created_at).toLocaleDateString('vi-VN') : '-'}</td>
                        <td className="px-6 py-4 whitespace-nowrap font-bold">{order.total_amount?.toLocaleString('vi-VN')}â‚«</td>
                        <td className="px-6 py-4 whitespace-nowrap">
                          <span className={`px-3 py-1 rounded-full text-xs font-medium ${getStatusColor(order.order_status)}`}>
                            {order.order_status}
                          </span>
                        </td>
                        <td className="px-6 py-4 whitespace-nowrap">
                          <span className={`px-3 py-1 rounded-full text-xs font-medium ${getStatusColor(order.payment_status)}`}>
                            {order.payment_status}
                          </span>
                        </td>
                        <td className="px-6 py-4 whitespace-nowrap">
                          <button className="text-blue-600 hover:text-blue-800 flex items-center gap-1">
                            <Eye className="w-4 h-4" /> Chi tiáº¿t
                          </button>
                        </td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            </div>
          )}

          {/* CUSTOMERS TAB */}
          {activeTab === 'customers' && (
            <div className="bg-white rounded-lg shadow p-6">
              <div className="flex items-center justify-between mb-6">
                <h3 className="text-lg font-bold">Quáº£n LÃ½ KhÃ¡ch HÃ ng ({customers.length})</h3>
                <div className="relative">
                  <Search className="w-5 h-5 absolute left-3 top-1/2 -translate-y-1/2 text-gray-400" />
                  <input
                    type="text"
                    placeholder="TÃ¬m khÃ¡ch hÃ ng..."
                    value={searchTerm}
                    onChange={(e) => setSearchTerm(e.target.value)}
                    className="pl-10 pr-4 py-2 border rounded-lg"
                  />
                </div>
              </div>

              <div className="overflow-x-auto">
                <table className="w-full">
                  <thead className="bg-gray-50">
                    <tr>
                      <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">ID</th>
                      <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Há» TÃªn</th>
                      <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Email</th>
                      <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">SÄT</th>
                      <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">NgÃ y ÄÄƒng KÃ½</th>
                      <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">HÃ nh Äá»™ng</th>
                    </tr>
                  </thead>
                  <tbody className="divide-y divide-gray-200">
                    {filteredCustomers.map((customer) => (
                      <tr key={customer.id} className="hover:bg-gray-50">
                        <td className="px-6 py-4 whitespace-nowrap">#{customer.id?.slice(0, 8)}</td>
                        <td className="px-6 py-4 whitespace-nowrap font-medium">{customer.full_name}</td>
                        <td className="px-6 py-4">{customer.email}</td>
                        <td className="px-6 py-4 whitespace-nowrap">{customer.phone || '-'}</td>
                        <td className="px-6 py-4 whitespace-nowrap">{customer.created_at ? new Date(customer.created_at).toLocaleDateString('vi-VN') : '-'}</td>
                        <td className="px-6 py-4 whitespace-nowrap">
                          <button className="text-blue-600 hover:text-blue-800 flex items-center gap-1">
                            <Eye className="w-4 h-4" /> Xem
                          </button>
                        </td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            </div>
          )}

          {/* CATEGORIES TAB */}
          {activeTab === 'categories' && (
            <div className="bg-white rounded-lg shadow p-6">
              <div className="flex items-center justify-between mb-6">
                <h3 className="text-lg font-bold">Quáº£n LÃ½ Danh Má»¥c ({categories.length})</h3>
                <button 
                  onClick={() => openCategoryModal('add')}
                  className="bg-pink-600 text-white px-4 py-2 rounded-lg hover:bg-pink-700 flex items-center gap-2"
                >
                  <Plus className="w-4 h-4" /> ThÃªm Danh Má»¥c
                </button>
              </div>

              <div className="mb-4">
                <div className="relative">
                  <Search className="w-5 h-5 absolute left-3 top-1/2 -translate-y-1/2 text-gray-400" />
                  <input
                    type="text"
                    placeholder="TÃ¬m danh má»¥c..."
                    value={searchTerm}
                    onChange={(e) => setSearchTerm(e.target.value)}
                    className="w-full pl-10 pr-4 py-2 border rounded-lg"
                  />
                </div>
              </div>

              <div className="overflow-x-auto">
                <table className="w-full">
                  <thead className="bg-gray-50">
                    <tr>
                      <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">ID</th>
                      <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">TÃªn Danh Má»¥c</th>
                      <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Slug</th>
                      <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Thá»© Tá»±</th>
                      <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Tráº¡ng ThÃ¡i</th>
                      <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">HÃ nh Äá»™ng</th>
                    </tr>
                  </thead>
                  <tbody className="divide-y divide-gray-200">
                    {filteredCategories.map((category) => (
                      <tr key={category.category_id} className="hover:bg-gray-50">
                        <td className="px-6 py-4 whitespace-nowrap">#{category.category_id}</td>
                        <td className="px-6 py-4 font-medium">{category.category_name}</td>
                        <td className="px-6 py-4 text-sm text-gray-600">{category.category_slug}</td>
                        <td className="px-6 py-4 whitespace-nowrap">{category.display_order}</td>
                        <td className="px-6 py-4 whitespace-nowrap">
                          <span className={`px-3 py-1 rounded-full text-xs font-medium ${category.is_active ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'}`}>
                            {category.is_active ? 'Hoáº¡t Ä‘á»™ng' : 'Táº¡m ngÆ°ng'}
                          </span>
                        </td>
                        <td className="px-6 py-4 whitespace-nowrap">
                          <div className="flex items-center gap-2">
                            <button onClick={() => openCategoryModal('edit', category)} className="text-blue-600 hover:text-blue-800">
                              <Edit className="w-4 h-4" />
                            </button>
                            <button onClick={() => handleDeleteCategory(category.category_id)} className="text-red-600 hover:text-red-800">
                              <Trash2 className="w-4 h-4" />
                            </button>
                          </div>
                        </td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            </div>
          )}

          {/* REVIEWS TAB */}
          {activeTab === 'reviews' && (
            <div className="bg-white rounded-lg shadow p-6">
              <h3 className="text-lg font-bold mb-6">Quáº£n LÃ½ ÄÃ¡nh GiÃ¡ ({reviews.length})</h3>
              <div className="space-y-4">
                {loading ? (
                  <p className="text-center text-gray-500 py-8">Äang táº£i...</p>
                ) : reviews.length === 0 ? (
                  <p className="text-center text-gray-500 py-8">ChÆ°a cÃ³ Ä‘Ã¡nh giÃ¡ nÃ o.</p>
                ) : (
                  reviews.map((review) => (
                    <div key={review.review_id} className={`border rounded-lg p-4 ${review.is_approved ? 'bg-green-50 border-green-200' : 'bg-yellow-50 border-yellow-200'}`}>
                      <div className="flex items-start justify-between">
                        <div className="flex-1">
                          <div className="flex items-center gap-2 mb-2">
                            <div className="flex">
                              {[1,2,3,4,5].map(i => (
                                <Star 
                                  key={i} 
                                  className={`w-4 h-4 ${i <= review.rating ? 'fill-yellow-400 text-yellow-400' : 'text-gray-300'}`} 
                                />
                              ))}
                            </div>
                            <span className="font-semibold">{review.user_name || 'KhÃ¡ch hÃ ng'}</span>
                            <span className="text-sm text-gray-500">
                              {new Date(review.created_at).toLocaleDateString('vi-VN')}
                            </span>
                            <span className={`text-xs px-2 py-0.5 rounded ${review.is_approved ? 'bg-green-100 text-green-700' : 'bg-yellow-100 text-yellow-700'}`}>
                              {review.is_approved ? 'ÄÃ£ duyá»‡t' : 'Chá» duyá»‡t'}
                            </span>
                          </div>
                          {review.review_title && (
                            <h4 className="font-medium text-gray-800 mb-1">{review.review_title}</h4>
                          )}
                          <p className="text-gray-700 mb-2">{review.review_text || 'KhÃ´ng cÃ³ ná»™i dung'}</p>
                          <div className="text-sm text-gray-500">Sáº£n pháº©m: {review.product_name || `ID: ${review.product_id}`}</div>
                        </div>
                        <div className="flex gap-2 ml-4">
                          {!review.is_approved && (
                            <button 
                              onClick={() => handleApproveReview(review.review_id, true)}
                              className="text-green-600 hover:text-green-800 p-1"
                              title="Duyá»‡t"
                            >
                              <Check className="w-5 h-5" />
                            </button>
                          )}
                          {review.is_approved && (
                            <button 
                              onClick={() => handleApproveReview(review.review_id, false)}
                              className="text-orange-600 hover:text-orange-800 p-1"
                              title="Bá» duyá»‡t"
                            >
                              <XCircle className="w-5 h-5" />
                            </button>
                          )}
                          <button 
                            onClick={() => handleDeleteReview(review.review_id)}
                            className="text-red-600 hover:text-red-800 p-1"
                            title="XÃ³a"
                          >
                            <Trash2 className="w-5 h-5" />
                          </button>
                        </div>
                      </div>
                    </div>
                  ))
                )}
              </div>
            </div>
          )}

          {/* CONTACTS TAB */}
          {activeTab === 'contacts' && (
            <div className="bg-white rounded-lg shadow p-6">
              <h3 className="text-lg font-bold mb-6">Quáº£n LÃ½ Tin Nháº¯n LiÃªn Há»‡ ({contacts.length})</h3>
              <div className="space-y-4">
                {loading ? (
                  <p className="text-center text-gray-500 py-8">Äang táº£i...</p>
                ) : contacts.length === 0 ? (
                  <p className="text-center text-gray-500 py-8">ChÆ°a cÃ³ tin nháº¯n nÃ o.</p>
                ) : (
                  contacts.map((contact) => (
                    <div key={contact.id} className={`border rounded-lg p-4 ${contact.status === 'replied' ? 'bg-green-50 border-green-200' : 'bg-yellow-50 border-yellow-200'}`}>
                      <div className="flex items-start justify-between">
                        <div className="flex-1">
                          <div className="flex items-center gap-2 mb-2">
                            <span className="font-semibold text-lg">{contact.name}</span>
                            <span className="text-sm text-gray-500">
                              {new Date(contact.created_at).toLocaleDateString('vi-VN')} {new Date(contact.created_at).toLocaleTimeString('vi-VN')}
                            </span>
                            <span className={`text-xs px-2 py-0.5 rounded ${contact.status === 'replied' ? 'bg-green-100 text-green-700' : 'bg-yellow-100 text-yellow-700'}`}>
                              {contact.status === 'replied' ? 'ÄÃ£ tráº£ lá»i' : 'Chá» xá»­ lÃ½'}
                            </span>
                          </div>
                          <div className="text-sm text-gray-600 mb-2">
                            <span className="font-medium">Email:</span> {contact.email}
                            {contact.phone && <span className="ml-4"><span className="font-medium">SÄT:</span> {contact.phone}</span>}
                          </div>
                          {contact.subject && (
                            <div className="text-sm text-gray-600 mb-2">
                              <span className="font-medium">Chá»§ Ä‘á»:</span> {contact.subject}
                            </div>
                          )}
                          <p className="text-gray-700 bg-white p-3 rounded border">{contact.message}</p>
                        </div>
                        <div className="flex gap-2 ml-4">
                          {contact.status !== 'replied' && (
                            <button 
                              onClick={() => handleUpdateContactStatus(contact.id, 'replied')}
                              className="text-green-600 hover:text-green-800 p-1"
                              title="ÄÃ¡nh dáº¥u Ä‘Ã£ tráº£ lá»i"
                            >
                              <Check className="w-5 h-5" />
                            </button>
                          )}
                          <button 
                            onClick={() => handleDeleteContact(contact.id)}
                            className="text-red-600 hover:text-red-800 p-1"
                            title="XÃ³a"
                          >
                            <Trash2 className="w-5 h-5" />
                          </button>
                        </div>
                      </div>
                    </div>
                  ))
                )}
              </div>
            </div>
          )}

          {/* SETTINGS TAB */}
          {activeTab === 'settings' && (
            <div className="bg-white rounded-lg shadow p-6">
              <h3 className="text-lg font-bold mb-6">CÃ i Äáº·t Há»‡ Thá»‘ng</h3>
              <div className="space-y-6">
                <div className="border-b pb-6">
                  <h4 className="font-semibold mb-4">ThÃ´ng Tin Website</h4>
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                      <label className="block text-sm text-gray-600 mb-2">TÃªn Website</label>
                      <input type="text" defaultValue="GoatTech Vietnam" className="w-full border rounded-lg px-3 py-2" />
                    </div>
                    <div>
                      <label className="block text-sm text-gray-600 mb-2">Email LiÃªn Há»‡</label>
                      <input type="email" defaultValue="contact@GoatTech.vn" className="w-full border rounded-lg px-3 py-2" />
                    </div>
                    <div>
                      <label className="block text-sm text-gray-600 mb-2">Sá»‘ Äiá»‡n Thoáº¡i</label>
                      <input type="tel" defaultValue="0123456789" className="w-full border rounded-lg px-3 py-2" />
                    </div>
                    <div>
                      <label className="block text-sm text-gray-600 mb-2">Äá»‹a Chá»‰</label>
                      <input type="text" defaultValue="HÃ  Ná»™i, Viá»‡t Nam" className="w-full border rounded-lg px-3 py-2" />
                    </div>
                  </div>
                </div>

                <div className="border-b pb-6">
                  <h4 className="font-semibold mb-4">CÃ i Äáº·t Thanh ToÃ¡n</h4>
                  <div className="space-y-3">
                    <label className="flex items-center gap-3">
                      <input type="checkbox" defaultChecked className="w-4 h-4" />
                      <span>Cháº¥p nháº­n thanh toÃ¡n COD</span>
                    </label>
                    <label className="flex items-center gap-3">
                      <input type="checkbox" defaultChecked className="w-4 h-4" />
                      <span>Cháº¥p nháº­n thanh toÃ¡n MoMo</span>
                    </label>
                    <label className="flex items-center gap-3">
                      <input type="checkbox" className="w-4 h-4" />
                      <span>Cháº¥p nháº­n thanh toÃ¡n VNPay</span>
                    </label>
                  </div>
                </div>

                <div className="border-b pb-6">
                  <h4 className="font-semibold mb-4">CÃ i Äáº·t Váº­n Chuyá»ƒn</h4>
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                      <label className="block text-sm text-gray-600 mb-2">PhÃ­ Ship Máº·c Äá»‹nh</label>
                      <input type="number" defaultValue="30000" className="w-full border rounded-lg px-3 py-2" />
                    </div>
                    <div>
                      <label className="block text-sm text-gray-600 mb-2">Miá»…n Ship Tá»« (VNÄ)</label>
                      <input type="number" defaultValue="200000" className="w-full border rounded-lg px-3 py-2" />
                    </div>
                  </div>
                </div>

                <button className="bg-pink-600 text-white px-6 py-3 rounded-lg hover:bg-pink-700 font-medium">
                  LÆ°u Táº¥t Cáº£ Thay Äá»•i
                </button>
              </div>
            </div>
          )}
        </div>
      </main>

      {/* Modal for Add/Edit */}
      {showModal && (
        <div className="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
          <div className="bg-white rounded-lg max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <div className="p-6 border-b flex items-center justify-between">
              <h3 className="text-xl font-bold">
                {modalType === 'add' ? 'ThÃªm Má»›i' : 'Chá»‰nh Sá»­a'} Sáº£n Pháº©m
              </h3>
              <button onClick={closeModal} className="text-gray-400 hover:text-gray-600">
                <X className="w-6 h-6" />
              </button>
            </div>
            <div className="p-6">
              <form className="space-y-4">
                <div className="grid grid-cols-2 gap-4">
                  <div>
                    <label className="block text-sm font-medium mb-2">TÃªn Sáº£n Pháº©m *</label>
                    <input 
                      type="text" 
                      value={formData.product_name}
                      onChange={(e) => setFormData({...formData, product_name: e.target.value})}
                      className="w-full border rounded-lg px-3 py-2"
                      placeholder="Nháº­p tÃªn sáº£n pháº©m"
                    />
                  </div>
                  <div>
                    <label className="block text-sm font-medium mb-2">SKU *</label>
                    <input 
                      type="text" 
                      value={formData.sku}
                      onChange={(e) => setFormData({...formData, sku: e.target.value.toUpperCase()})}
                      className="w-full border rounded-lg px-3 py-2"
                      placeholder="SP001"
                    />
                  </div>
                </div>
                <div>
                  <label className="block text-sm font-medium mb-2">URL HÃ¬nh áº¢nh</label>
                  <input 
                    type="text" 
                    value={formData.image_url}
                    onChange={(e) => setFormData({...formData, image_url: e.target.value})}
                    className="w-full border rounded-lg px-3 py-2"
                    placeholder="https://example.com/image.jpg"
                  />
                  {formData.image_url && (
                    <img src={formData.image_url} alt="Preview" className="mt-2 h-20 w-20 object-cover rounded border" />
                  )}
                </div>
                <div>
                  <label className="block text-sm font-medium mb-2">MÃ´ Táº£ Ngáº¯n</label>
                  <input 
                    type="text" 
                    value={formData.short_description}
                    onChange={(e) => setFormData({...formData, short_description: e.target.value})}
                    className="w-full border rounded-lg px-3 py-2"
                    placeholder="MÃ´ táº£ ngáº¯n gá»n"
                  />
                </div>
                <div>
                  <label className="block text-sm font-medium mb-2">MÃ´ Táº£ Chi Tiáº¿t</label>
                  <textarea 
                    value={formData.description}
                    onChange={(e) => setFormData({...formData, description: e.target.value})}
                    className="w-full border rounded-lg px-3 py-2 h-24"
                    placeholder="Nháº­p mÃ´ táº£ chi tiáº¿t sáº£n pháº©m"
                  />
                </div>
                <div className="grid grid-cols-2 gap-4">
                  <div>
                    <label className="block text-sm font-medium mb-2">GiÃ¡ Gá»‘c (VNÄ) *</label>
                    <input 
                      type="number" 
                      value={formData.price}
                      onChange={(e) => setFormData({...formData, price: Number(e.target.value)})}
                      className="w-full border rounded-lg px-3 py-2"
                      placeholder="0"
                    />
                  </div>
                  <div>
                    <label className="block text-sm font-medium mb-2">GiÃ¡ Khuyáº¿n MÃ£i</label>
                    <input 
                      type="number" 
                      value={formData.sale_price}
                      onChange={(e) => setFormData({...formData, sale_price: Number(e.target.value)})}
                      className="w-full border rounded-lg px-3 py-2"
                      placeholder="0"
                    />
                  </div>
                </div>
                <div>
                  <label className="block text-sm font-medium mb-2">Danh Má»¥c</label>
                  <select 
                    value={formData.category_id || ''}
                    onChange={(e) => setFormData({...formData, category_id: e.target.value ? Number(e.target.value) : null})}
                    className="w-full border rounded-lg px-3 py-2"
                  >
                    <option value="">-- Chá»n danh má»¥c --</option>
                    {categories.map(cat => (
                      <option key={cat.category_id} value={cat.category_id}>{cat.category_name}</option>
                    ))}
                  </select>
                </div>
                <div className="grid grid-cols-2 gap-4">
                  <div>
                    <label className="flex items-center gap-2">
                      <input 
                        type="checkbox" 
                        checked={formData.is_featured}
                        onChange={(e) => setFormData({...formData, is_featured: e.target.checked})}
                        className="w-4 h-4"
                      />
                      <span className="text-sm font-medium">Sáº£n pháº©m ná»•i báº­t</span>
                    </label>
                  </div>
                  <div>
                    <label className="flex items-center gap-2">
                      <input 
                        type="checkbox" 
                        checked={formData.is_new}
                        onChange={(e) => setFormData({...formData, is_new: e.target.checked})}
                        className="w-4 h-4"
                      />
                      <span className="text-sm font-medium">Sáº£n pháº©m má»›i</span>
                    </label>
                  </div>
                </div>
                <div>
                  <label className="block text-sm font-medium mb-2">Tráº¡ng thÃ¡i</label>
                  <select 
                    value={formData.status}
                    onChange={(e) => setFormData({...formData, status: e.target.value})}
                    className="w-full border rounded-lg px-3 py-2"
                  >
                    <option value="active">Äang bÃ¡n</option>
                    <option value="inactive">Ngá»«ng bÃ¡n</option>
                    <option value="draft">Báº£n nhÃ¡p</option>
                  </select>
                </div>
                <div>
                  <label className="block text-sm font-medium mb-2">Bá»™ SÆ°u Táº­p Theo MÃ¹a (TÃ¹y chá»n)</label>
                  <select 
                    value={formData.season}
                    onChange={(e) => setFormData({...formData, season: e.target.value})}
                    className="w-full border rounded-lg px-3 py-2"
                  >
                    <option value="">-- KhÃ´ng thuá»™c mÃ¹a nÃ o --</option>
                    <option value="noel">ðŸŽ„ GiÃ¡ng Sinh - Noel</option>
                    <option value="valentine">ðŸ’• Valentine</option>
                    <option value="tet">ðŸ§§ Táº¿t NguyÃªn ÄÃ¡n</option>
                  </select>
                </div>

                {/* Collections Multi-select */}
                {collections.length > 0 && (
                  <div>
                    <label className="block text-sm font-medium mb-2">Bá»™ SÆ°u Táº­p (Chá»n nhiá»u)</label>
                    <div className="border rounded-lg p-3 max-h-40 overflow-y-auto space-y-2">
                      {collections.map((collection) => (
                        <label 
                          key={collection.collection_id} 
                          className="flex items-center gap-2 cursor-pointer hover:bg-gray-50 p-1 rounded"
                        >
                          <input
                            type="checkbox"
                            checked={selectedCollections.includes(collection.collection_id)}
                            onChange={() => handleCollectionToggle(collection.collection_id)}
                            className="w-4 h-4 text-pink-600 rounded"
                          />
                          <span className="text-sm">
                            {collection.collection_name}
                            <span className="text-xs text-gray-400 ml-1">
                              ({collection.collection_type === 'seasonal' ? 'Theo mÃ¹a' : 'ChÃ­nh'})
                            </span>
                          </span>
                        </label>
                      ))}
                    </div>
                    {selectedCollections.length > 0 && (
                      <p className="text-xs text-gray-500 mt-1">
                        ÄÃ£ chá»n {selectedCollections.length} bá»™ sÆ°u táº­p
                      </p>
                    )}
                  </div>
                )}

                <div className="flex gap-3 pt-4">
                  <button 
                    type="button"
                    onClick={handleSaveProduct}
                    disabled={loading}
                    className="flex-1 bg-pink-600 text-white py-2 rounded-lg hover:bg-pink-700 font-medium disabled:bg-gray-400"
                  >
                    {loading ? 'Äang xá»­ lÃ½...' : (modalType === 'add' ? 'ThÃªm Má»›i' : 'Cáº­p Nháº­t')}
                  </button>
                  <button 
                    type="button"
                    onClick={closeModal}
                    className="flex-1 bg-gray-200 text-gray-700 py-2 rounded-lg hover:bg-gray-300 font-medium"
                  >
                    Há»§y
                  </button>
                </div>
              </form>
            </div>
          </div>
        </div>
      )}

      {/* Category Modal */}
      {showCategoryModal && (
        <div className="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
          <div className="bg-white rounded-lg max-w-lg w-full max-h-[90vh] overflow-y-auto">
            <div className="p-6 border-b flex items-center justify-between">
              <h3 className="text-xl font-bold">
                {categoryModalType === 'add' ? 'ThÃªm Má»›i' : 'Chá»‰nh Sá»­a'} Danh Má»¥c
              </h3>
              <button onClick={closeCategoryModal} className="text-gray-400 hover:text-gray-600">
                <X className="w-6 h-6" />
              </button>
            </div>
            <div className="p-6">
              <form className="space-y-4">
                <div>
                  <label className="block text-sm font-medium mb-2">TÃªn Danh Má»¥c *</label>
                  <input 
                    type="text" 
                    value={categoryFormData.category_name}
                    onChange={(e) => {
                      const name = e.target.value;
                      const slug = name
                        .toLowerCase()
                        .normalize('NFD')
                        .replace(/[\u0300-\u036f]/g, '')
                        .replace(/Ä‘/g, 'd')
                        .replace(/[^a-z0-9\s-]/g, '')
                        .replace(/\s+/g, '-')
                        .replace(/-+/g, '-')
                        .trim();
                      setCategoryFormData({...categoryFormData, category_name: name, category_slug: slug});
                    }}
                    className="w-full border rounded-lg px-3 py-2"
                    placeholder="Nháº­p tÃªn danh má»¥c"
                  />
                </div>
                <div>
                  <label className="block text-sm font-medium mb-2">Slug</label>
                  <input 
                    type="text" 
                    value={categoryFormData.category_slug}
                    onChange={(e) => setCategoryFormData({...categoryFormData, category_slug: e.target.value})}
                    className="w-full border rounded-lg px-3 py-2 bg-gray-50"
                    placeholder="ten-danh-muc"
                  />
                </div>
                <div>
                  <label className="block text-sm font-medium mb-2">MÃ´ Táº£</label>
                  <textarea 
                    value={categoryFormData.description}
                    onChange={(e) => setCategoryFormData({...categoryFormData, description: e.target.value})}
                    className="w-full border rounded-lg px-3 py-2 h-20"
                    placeholder="Nháº­p mÃ´ táº£ danh má»¥c"
                  />
                </div>
                <div>
                  <label className="block text-sm font-medium mb-2">Thá»© Tá»± Hiá»ƒn Thá»‹</label>
                  <input 
                    type="number" 
                    value={categoryFormData.display_order}
                    onChange={(e) => setCategoryFormData({...categoryFormData, display_order: Number(e.target.value)})}
                    className="w-full border rounded-lg px-3 py-2"
                    placeholder="0"
                  />
                </div>
                <div>
                  <label className="flex items-center gap-2">
                    <input 
                      type="checkbox" 
                      checked={categoryFormData.is_active}
                      onChange={(e) => setCategoryFormData({...categoryFormData, is_active: e.target.checked})}
                      className="w-4 h-4"
                    />
                    <span className="text-sm font-medium">KÃ­ch hoáº¡t danh má»¥c</span>
                  </label>
                </div>

                <div className="flex gap-3 pt-4">
                  <button 
                    type="button"
                    onClick={handleSaveCategory}
                    disabled={loading}
                    className="flex-1 bg-pink-600 text-white py-2 rounded-lg hover:bg-pink-700 font-medium disabled:bg-gray-400"
                  >
                    {loading ? 'Äang xá»­ lÃ½...' : (categoryModalType === 'add' ? 'ThÃªm Má»›i' : 'Cáº­p Nháº­t')}
                  </button>
                  <button 
                    type="button"
                    onClick={closeCategoryModal}
                    className="flex-1 bg-gray-200 text-gray-700 py-2 rounded-lg hover:bg-gray-300 font-medium"
                  >
                    Há»§y
                  </button>
                </div>
              </form>
            </div>
          </div>
        </div>
      )}
    </div>
  );
};

export default AdminDashboard;




################################################################################
## FILE 119: page.tsx
## Path: fontend/src/app/admin/designs/page.tsx
################################################################################

'use client';

import { useEffect, useState } from 'react';
import Link from 'next/link';

interface Design {
  design_id: string;
  phone_model: string;
  status: string;
  preview_image_url: string | null;
  high_res_image_url: string | null;
  guest_name: string | null;
  guest_email: string | null;
  guest_phone: string | null;
  admin_notes: string | null;
  created_at: string;
  submitted_at: string | null;
  design_data: any;
  users?: {
    full_name: string;
    email: string;
    phone: string;
  };
}

const statusLabels: Record<string, { label: string; color: string }> = {
  draft: { label: 'Báº£n nhÃ¡p', color: 'bg-gray-100 text-gray-800' },
  submitted: { label: 'Chá» duyá»‡t', color: 'bg-yellow-100 text-yellow-800' },
  processing: { label: 'Äang xá»­ lÃ½', color: 'bg-blue-100 text-blue-800' },
  approved: { label: 'ÄÃ£ duyá»‡t', color: 'bg-green-100 text-green-800' },
  rejected: { label: 'Tá»« chá»‘i', color: 'bg-red-100 text-red-800' },
  printed: { label: 'ÄÃ£ in', color: 'bg-purple-100 text-purple-800' },
};

export default function AdminDesignsPage() {
  const [designs, setDesigns] = useState<Design[]>([]);
  const [loading, setLoading] = useState(true);
  const [filterStatus, setFilterStatus] = useState<string>('');
  const [selectedDesign, setSelectedDesign] = useState<Design | null>(null);
  const [adminNotes, setAdminNotes] = useState('');
  const [actionLoading, setActionLoading] = useState(false);

  // Load designs
  const loadDesigns = async () => {
    try {
      const url = filterStatus 
        ? `http://localhost:3001/designs/admin/all?status=${filterStatus}`
        : 'http://localhost:3001/designs/admin/all';
      
      const res = await fetch(url);
      if (res.ok) {
        const data = await res.json();
        setDesigns(data.data || []);
      }
    } catch (error) {
      console.error('Load designs error:', error);
    }
    setLoading(false);
  };

  useEffect(() => {
    loadDesigns();
  }, [filterStatus]);

  // Duyá»‡t thiáº¿t káº¿
  const approveDesign = async (designId: string) => {
    setActionLoading(true);
    try {
      const res = await fetch(`http://localhost:3001/designs/admin/${designId}/approve`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ adminNotes }),
      });

      if (res.ok) {
        alert('âœ… ÄÃ£ duyá»‡t thiáº¿t káº¿ thÃ nh cÃ´ng!');
        setSelectedDesign(null);
        setAdminNotes('');
        loadDesigns();
      } else {
        alert('CÃ³ lá»—i xáº£y ra!');
      }
    } catch (error) {
      console.error('Approve error:', error);
      alert('CÃ³ lá»—i xáº£y ra!');
    }
    setActionLoading(false);
  };

  // Tá»« chá»‘i thiáº¿t káº¿
  const rejectDesign = async (designId: string) => {
    if (!adminNotes.trim()) {
      alert('Vui lÃ²ng nháº­p lÃ½ do tá»« chá»‘i!');
      return;
    }

    setActionLoading(true);
    try {
      const res = await fetch(`http://localhost:3001/designs/admin/${designId}/reject`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ adminNotes }),
      });

      if (res.ok) {
        alert('âŒ ÄÃ£ tá»« chá»‘i thiáº¿t káº¿!');
        setSelectedDesign(null);
        setAdminNotes('');
        loadDesigns();
      } else {
        alert('CÃ³ lá»—i xáº£y ra!');
      }
    } catch (error) {
      console.error('Reject error:', error);
      alert('CÃ³ lá»—i xáº£y ra!');
    }
    setActionLoading(false);
  };

  const formatDate = (dateString: string) => {
    return new Date(dateString).toLocaleString('vi-VN');
  };

  return (
    <div className="min-h-screen bg-gray-100">
      {/* Header */}
      <header className="bg-white shadow">
        <div className="max-w-7xl mx-auto px-4 py-4 flex items-center justify-between">
          <div className="flex items-center gap-4">
            <Link href="/admin" className="text-gray-600 hover:text-pink-500">
              â† Quay láº¡i
            </Link>
            <h1 className="text-xl font-bold text-gray-800">ðŸŽ¨ Quáº£n LÃ½ Thiáº¿t Káº¿ á»p LÆ°ng</h1>
          </div>
          <div className="flex items-center gap-4">
            <span className="text-sm text-gray-500">
              Tá»•ng: {designs.length} thiáº¿t káº¿
            </span>
          </div>
        </div>
      </header>

      <main className="max-w-7xl mx-auto px-4 py-6">
        {/* Filter */}
        <div className="bg-white rounded-lg shadow p-4 mb-6">
          <div className="flex flex-wrap gap-2">
            <button
              onClick={() => setFilterStatus('')}
              className={`px-4 py-2 rounded-lg text-sm font-medium transition ${
                !filterStatus ? 'bg-pink-500 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
              }`}
            >
              Táº¥t cáº£
            </button>
            {Object.entries(statusLabels).map(([status, { label }]) => (
              <button
                key={status}
                onClick={() => setFilterStatus(status)}
                className={`px-4 py-2 rounded-lg text-sm font-medium transition ${
                  filterStatus === status ? 'bg-pink-500 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                }`}
              >
                {label}
              </button>
            ))}
          </div>
        </div>

        {/* Designs List */}
        {loading ? (
          <div className="text-center py-12">
            <div className="animate-spin text-4xl">â³</div>
            <p className="text-gray-500 mt-2">Äang táº£i...</p>
          </div>
        ) : designs.length === 0 ? (
          <div className="text-center py-12 bg-white rounded-lg shadow">
            <div className="text-6xl mb-4">ðŸ“­</div>
            <p className="text-gray-500">ChÆ°a cÃ³ thiáº¿t káº¿ nÃ o</p>
          </div>
        ) : (
          <div className="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
            {designs.map((design) => (
              <div
                key={design.design_id}
                className="bg-white rounded-xl shadow-lg overflow-hidden hover:shadow-xl transition"
              >
                {/* Preview Image */}
                <div className="aspect-[3/4] bg-gray-100 relative">
                  {design.preview_image_url ? (
                    <img
                      src={`http://localhost:3001${design.preview_image_url}`}
                      alt="Design preview"
                      className="w-full h-full object-contain"
                      onError={(e) => {
                        console.error('Image load error:', design.preview_image_url);
                        (e.target as HTMLImageElement).style.display = 'none';
                      }}
                    />
                  ) : (
                    <div className="w-full h-full flex items-center justify-center text-gray-400">
                      <span className="text-6xl">ðŸ“±</span>
                    </div>
                  )}
                  
                  {/* Status Badge */}
                  <div className="absolute top-3 right-3">
                    <span className={`px-3 py-1 rounded-full text-xs font-semibold ${statusLabels[design.status]?.color}`}>
                      {statusLabels[design.status]?.label}
                    </span>
                  </div>
                </div>

                {/* Info */}
                <div className="p-4">
                  <h3 className="font-semibold text-gray-800 mb-2">
                     {design.phone_model}
                  </h3>
                  
                  <div className="text-sm text-gray-600 space-y-1">
                    <p>
                      ðŸ‘¤ {design.guest_name || design.users?.full_name || 'áº¨n danh'}
                    </p>
                    <p>
                      ðŸ“ž {design.guest_phone || design.users?.phone || 'N/A'}
                    </p>
                    <p>
                      ðŸ“§ {design.guest_email || design.users?.email || 'N/A'}
                    </p>
                    <p className="text-gray-400">
                      ðŸ• {design.submitted_at ? formatDate(design.submitted_at) : formatDate(design.created_at)}
                    </p>
                  </div>

                  {design.admin_notes && (
                    <div className="mt-3 p-2 bg-gray-50 rounded text-sm">
                      <span className="font-medium">Ghi chÃº:</span> {design.admin_notes}
                    </div>
                  )}

                  {/* Actions */}
                  {design.status === 'submitted' && (
                    <div className="mt-4 flex gap-2">
                      <button
                        onClick={() => {
                          setSelectedDesign(design);
                          setAdminNotes('');
                        }}
                        className="flex-1 bg-pink-500 text-white py-2 rounded-lg text-sm font-medium hover:bg-pink-600"
                      >
                        Xem & Duyá»‡t
                      </button>
                    </div>
                  )}

                  {design.status !== 'submitted' && (
                    <button
                      onClick={() => setSelectedDesign(design)}
                      className="mt-4 w-full bg-gray-100 text-gray-700 py-2 rounded-lg text-sm font-medium hover:bg-gray-200"
                    >
                      Xem chi tiáº¿t
                    </button>
                  )}
                </div>
              </div>
            ))}
          </div>
        )}
      </main>

      {/* Modal xem chi tiáº¿t & duyá»‡t */}
      {selectedDesign && (
        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
          <div className="bg-white rounded-2xl max-w-4xl w-full max-h-[90vh] overflow-auto">
            <div className="sticky top-0 bg-white border-b px-6 py-4 flex items-center justify-between">
              <h2 className="text-xl font-bold">Chi tiáº¿t thiáº¿t káº¿</h2>
              <button
                onClick={() => setSelectedDesign(null)}
                className="text-gray-500 hover:text-gray-700 text-2xl"
              >
                Ã—
              </button>
            </div>

            <div className="p-6 grid md:grid-cols-2 gap-6">
              {/* Preview */}
              <div>
                <div className="aspect-[3/4] bg-gray-100 rounded-xl overflow-hidden relative">
                  {selectedDesign.preview_image_url ? (
                    <img
                      src={`http://localhost:3001${selectedDesign.preview_image_url}`}
                      alt="Design preview"
                      className="w-full h-full object-contain"
                    />
                  ) : (
                    <div className="w-full h-full flex items-center justify-center text-gray-400">
                      <span className="text-6xl">ðŸ“±</span>
                    </div>
                  )}
                </div>

                {selectedDesign.high_res_image_url && (
                  <a
                    href={`http://localhost:3001${selectedDesign.high_res_image_url}`}
                    target="_blank"
                    rel="noopener noreferrer"
                    className="mt-4 block text-center bg-blue-500 text-white py-2 rounded-lg hover:bg-blue-600"
                  >
                     Táº£i áº£nh HD 
                  </a>
                )}
              </div>

              {/* Info & Actions */}
              <div>
                <div className="space-y-4">
                  <div>
                    <span className={`px-3 py-1 rounded-full text-sm font-semibold ${statusLabels[selectedDesign.status]?.color}`}>
                      {statusLabels[selectedDesign.status]?.label}
                    </span>
                  </div>

                  <div className="bg-gray-50 rounded-lg p-4 space-y-2">
                    <h3 className="font-semibold">ðŸ“± ThÃ´ng tin</h3>
                    <p><span className="text-gray-500">Model:</span> {selectedDesign.phone_model}</p>
                    <p><span className="text-gray-500">NgÃ y gá»­i:</span> {selectedDesign.submitted_at ? formatDate(selectedDesign.submitted_at) : 'ChÆ°a gá»­i'}</p>
                  </div>

                  <div className="bg-gray-50 rounded-lg p-4 space-y-2">
                    <h3 className="font-semibold">ðŸ‘¤ KhÃ¡ch hÃ ng</h3>
                    <p><span className="text-gray-500">TÃªn:</span> {selectedDesign.guest_name || selectedDesign.users?.full_name || 'N/A'}</p>
                    <p><span className="text-gray-500">SÄT:</span> {selectedDesign.guest_phone || selectedDesign.users?.phone || 'N/A'}</p>
                    <p><span className="text-gray-500">Email:</span> {selectedDesign.guest_email || selectedDesign.users?.email || 'N/A'}</p>
                  </div>

                  {selectedDesign.status === 'submitted' && (
                    <>
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-2">
                          Ghi chÃº cá»§a Admin
                        </label>
                        <textarea
                          value={adminNotes}
                          onChange={(e) => setAdminNotes(e.target.value)}
                          rows={3}
                          className="w-full border rounded-lg px-3 py-2"
                          placeholder="Nháº­p ghi chÃº (báº¯t buá»™c khi tá»« chá»‘i)..."
                        />
                      </div>

                      <div className="flex gap-3">
                        <button
                          onClick={() => approveDesign(selectedDesign.design_id)}
                          disabled={actionLoading}
                          className="flex-1 bg-green-500 text-white py-3 rounded-lg font-semibold hover:bg-green-600 disabled:opacity-50"
                        >
                          âœ… Duyá»‡t
                        </button>
                        <button
                          onClick={() => rejectDesign(selectedDesign.design_id)}
                          disabled={actionLoading}
                          className="flex-1 bg-red-500 text-white py-3 rounded-lg font-semibold hover:bg-red-600 disabled:opacity-50"
                        >
                          âŒ Tá»« chá»‘i
                        </button>
                      </div>
                    </>
                  )}

                  {selectedDesign.admin_notes && (
                    <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                      <h3 className="font-semibold text-yellow-800">ðŸ“ Ghi chÃº Admin</h3>
                      <p className="text-yellow-700 mt-1">{selectedDesign.admin_notes}</p>
                    </div>
                  )}
                </div>
              </div>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}




################################################################################
## FILE 120: page.tsx
## Path: fontend/src/app/admin/templates/page.tsx
################################################################################

'use client';

import React, { useState, useEffect, useRef } from 'react';
import Link from 'next/link';
import { 
  ArrowLeft, Plus, Pencil, Trash2, Save, X, Upload, 
  Smartphone, Check, AlertCircle, Image as ImageIcon
} from 'lucide-react';

const API_URL = process.env.NEXT_PUBLIC_API_URL || 'http://localhost:3001';

interface PhoneTemplate {
  template_id: number;
  phone_model: string;
  brand: string;
  template_image_url: string | null;
  print_width_mm: number;
  print_height_mm: number;
  canvas_width: number;
  canvas_height: number;
  is_active: boolean;
  created_at?: string;
}

const BRANDS = ['Apple', 'Samsung', 'Xiaomi', 'OPPO', 'Vivo', 'Realme', 'OnePlus', 'Google', 'Huawei', 'Other'];

export default function AdminTemplatesPage() {
  const [templates, setTemplates] = useState<PhoneTemplate[]>([]);
  const [loading, setLoading] = useState(true);
  const [saving, setSaving] = useState(false);
  const [showModal, setShowModal] = useState(false);
  const [editingTemplate, setEditingTemplate] = useState<PhoneTemplate | null>(null);
  const [message, setMessage] = useState<{ type: 'success' | 'error'; text: string } | null>(null);
  const fileInputRef = useRef<HTMLInputElement>(null);
  const [previewImage, setPreviewImage] = useState<string | null>(null);
  
  const [formData, setFormData] = useState({
    phone_model: '',
    brand: 'Apple',
    template_image_url: '',
    print_width_mm: 70,
    print_height_mm: 150,
    canvas_width: 700,
    canvas_height: 1500,
    is_active: true,
  });

  // Load templates
  useEffect(() => {
    loadTemplates();
  }, []);

  const loadTemplates = async () => {
    setLoading(true);
    try {
      const response = await fetch(`${API_URL}/designs/templates`);
      const result = await response.json();
      
      let data = result;
      if (result?.data) {
        data = result.data;
      }
      
      if (Array.isArray(data)) {
        setTemplates(data);
      }
    } catch (error) {
      console.error('Error loading templates:', error);
      showMessage('error', 'KhÃ´ng thá»ƒ táº£i danh sÃ¡ch templates');
    } finally {
      setLoading(false);
    }
  };

  const showMessage = (type: 'success' | 'error', text: string) => {
    setMessage({ type, text });
    setTimeout(() => setMessage(null), 3000);
  };

  const openAddModal = () => {
    setEditingTemplate(null);
    setFormData({
      phone_model: '',
      brand: 'Apple',
      template_image_url: '',
      print_width_mm: 70,
      print_height_mm: 150,
      canvas_width: 700,
      canvas_height: 1500,
      is_active: true,
    });
    setPreviewImage(null);
    setShowModal(true);
  };

  const openEditModal = (template: PhoneTemplate) => {
    setEditingTemplate(template);
    setFormData({
      phone_model: template.phone_model,
      brand: template.brand,
      template_image_url: template.template_image_url || '',
      print_width_mm: template.print_width_mm,
      print_height_mm: template.print_height_mm,
      canvas_width: template.canvas_width,
      canvas_height: template.canvas_height,
      is_active: template.is_active,
    });
    setPreviewImage(template.template_image_url);
    setShowModal(true);
  };

  const handleImageUpload = (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0];
    if (!file) return;

    // Preview
    const reader = new FileReader();
    reader.onload = (event) => {
      const base64 = event.target?.result as string;
      setPreviewImage(base64);
      setFormData(prev => ({ ...prev, template_image_url: base64 }));
    };
    reader.readAsDataURL(file);
  };

  const handleSave = async () => {
    if (!formData.phone_model.trim()) {
      showMessage('error', 'Vui lÃ²ng nháº­p tÃªn model Ä‘iá»‡n thoáº¡i');
      return;
    }

    setSaving(true);
    try {
      const url = editingTemplate 
        ? `${API_URL}/designs/templates/${editingTemplate.template_id}`
        : `${API_URL}/designs/templates`;
      
      const method = editingTemplate ? 'PUT' : 'POST';
      
      // Chuáº©n bá»‹ data Ä‘á»ƒ gá»­i
      const dataToSend = {
        ...formData,
        // Náº¿u template_image_url lÃ  URL cÅ© (khÃ´ng pháº£i base64 má»›i), giá»¯ nguyÃªn
        template_image_url: formData.template_image_url || (editingTemplate?.template_image_url || ''),
      };
      
      console.log('Sending data:', dataToSend);
      
      const response = await fetch(url, {
        method,
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(dataToSend),
      });

      const result = await response.json();
      console.log('API Response:', result);

      if (!response.ok) {
        throw new Error(result.message || 'Failed to save template');
      }

      showMessage('success', editingTemplate ? 'ÄÃ£ cáº­p nháº­t template!' : 'ÄÃ£ thÃªm template má»›i!');
      setShowModal(false);
      loadTemplates();
    } catch (error: any) {
      console.error('Error saving template:', error);
      showMessage('error', error.message || 'KhÃ´ng thá»ƒ lÆ°u template. Vui lÃ²ng thá»­ láº¡i.');
    } finally {
      setSaving(false);
    }
  };

  const handleDelete = async (templateId: number) => {
    if (!confirm('Báº¡n cÃ³ cháº¯c muá»‘n xÃ³a template nÃ y?')) return;

    try {
      const response = await fetch(`${API_URL}/designs/templates/${templateId}`, {
        method: 'DELETE',
      });

      if (!response.ok) {
        throw new Error('Failed to delete template');
      }

      showMessage('success', 'ÄÃ£ xÃ³a template!');
      loadTemplates();
    } catch (error) {
      console.error('Error deleting template:', error);
      showMessage('error', 'KhÃ´ng thá»ƒ xÃ³a template');
    }
  };

  const toggleActive = async (template: PhoneTemplate) => {
    try {
      const response = await fetch(`${API_URL}/designs/templates/${template.template_id}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ ...template, is_active: !template.is_active }),
      });

      if (!response.ok) {
        throw new Error('Failed to update template');
      }

      loadTemplates();
    } catch (error) {
      console.error('Error updating template:', error);
      showMessage('error', 'KhÃ´ng thá»ƒ cáº­p nháº­t tráº¡ng thÃ¡i');
    }
  };

  return (
    <div className="min-h-screen bg-gray-100">
      {/* Header */}
      <header className="bg-white shadow-sm sticky top-0 z-40">
        <div className="max-w-7xl mx-auto px-4 py-4 flex items-center justify-between">
          <div className="flex items-center gap-4">
            <Link href="/admin" className="text-gray-600 hover:text-pink-600 transition">
              <ArrowLeft className="w-6 h-6" />
            </Link>
            <h1 className="text-xl font-bold text-gray-900">Quáº£n LÃ½ Phone Templates</h1>
          </div>
          <button
            onClick={openAddModal}
            className="flex items-center gap-2 px-4 py-2 bg-pink-600 text-white rounded-lg hover:bg-pink-700 transition"
          >
            <Plus className="w-5 h-5" />
            ThÃªm Template
          </button>
        </div>
      </header>

      {/* Message */}
      {message && (
        <div className={`fixed top-20 right-4 z-50 px-4 py-3 rounded-lg shadow-lg flex items-center gap-2 ${
          message.type === 'success' ? 'bg-green-500 text-white' : 'bg-red-500 text-white'
        }`}>
          {message.type === 'success' ? <Check className="w-5 h-5" /> : <AlertCircle className="w-5 h-5" />}
          {message.text}
        </div>
      )}

      {/* Content */}
      <main className="max-w-7xl mx-auto px-4 py-8">
        {loading ? (
          <div className="flex justify-center py-20">
            <div className="w-12 h-12 border-4 border-pink-200 border-t-pink-600 rounded-full animate-spin"></div>
          </div>
        ) : templates.length === 0 ? (
          <div className="text-center py-20 bg-white rounded-xl shadow">
            <Smartphone className="w-16 h-16 text-gray-300 mx-auto mb-4" />
            <h3 className="text-lg font-semibold text-gray-700 mb-2">ChÆ°a cÃ³ template nÃ o</h3>
            <p className="text-gray-500 mb-6">Báº¯t Ä‘áº§u báº±ng cÃ¡ch thÃªm template Ä‘áº§u tiÃªn</p>
            <button
              onClick={openAddModal}
              className="px-6 py-2 bg-pink-600 text-white rounded-lg hover:bg-pink-700 transition"
            >
              ThÃªm Template
            </button>
          </div>
        ) : (
          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
            {templates.map(template => (
              <div 
                key={template.template_id}
                className={`bg-white rounded-xl shadow-sm overflow-hidden border-2 transition ${
                  template.is_active ? 'border-transparent' : 'border-red-200 opacity-60'
                }`}
              >
                {/* Image */}
                <div className="aspect-square bg-gradient-to-br from-gray-100 to-gray-200 relative">
                  {template.template_image_url ? (
                    <img 
                      src={template.template_image_url}
                      alt={template.phone_model}
                      className="w-full h-full object-cover"
                    />
                  ) : (
                    <div className="w-full h-full flex items-center justify-center">
                      <Smartphone className="w-20 h-20 text-gray-300" />
                    </div>
                  )}
                  
                  {/* Status badge */}
                  <div className={`absolute top-2 right-2 px-2 py-1 rounded-full text-xs font-semibold ${
                    template.is_active ? 'bg-green-500 text-white' : 'bg-red-500 text-white'
                  }`}>
                    {template.is_active ? 'Äang hiá»ƒn thá»‹' : 'ÄÃ£ áº©n'}
                  </div>
                </div>

                {/* Info */}
                <div className="p-4">
                  <div className="flex items-center gap-2 mb-1">
                    <span className="text-xs px-2 py-0.5 bg-pink-100 text-pink-600 rounded-full font-medium">
                      {template.brand}
                    </span>
                  </div>
                  <h3 className="font-bold text-gray-900">{template.phone_model}</h3>
                  <p className="text-sm text-gray-500 mt-1">
                    {template.print_width_mm} Ã— {template.print_height_mm} mm
                  </p>
                  <p className="text-xs text-gray-400 mt-1">
                    Canvas: {template.canvas_width} Ã— {template.canvas_height} px
                  </p>

                  {/* Actions */}
                  <div className="flex gap-2 mt-4">
                    <button
                      onClick={() => toggleActive(template)}
                      className={`flex-1 py-2 rounded-lg text-sm font-medium transition ${
                        template.is_active 
                          ? 'bg-gray-100 text-gray-700 hover:bg-gray-200' 
                          : 'bg-green-100 text-green-700 hover:bg-green-200'
                      }`}
                    >
                      {template.is_active ? 'áº¨n' : 'Hiá»‡n'}
                    </button>
                    <button
                      onClick={() => openEditModal(template)}
                      className="flex-1 py-2 bg-blue-100 text-blue-600 rounded-lg text-sm font-medium hover:bg-blue-200 transition"
                    >
                      <Pencil className="w-4 h-4 mx-auto" />
                    </button>
                    <button
                      onClick={() => handleDelete(template.template_id)}
                      className="flex-1 py-2 bg-red-100 text-red-600 rounded-lg text-sm font-medium hover:bg-red-200 transition"
                    >
                      <Trash2 className="w-4 h-4 mx-auto" />
                    </button>
                  </div>
                </div>
              </div>
            ))}
          </div>
        )}
      </main>

      {/* Modal */}
      {showModal && (
        <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
          <div className="bg-white rounded-2xl w-full max-w-lg max-h-[90vh] overflow-y-auto">
            <div className="sticky top-0 bg-white border-b px-6 py-4 flex items-center justify-between">
              <h2 className="text-xl font-bold text-gray-900">
                {editingTemplate ? 'Sá»­a Template' : 'ThÃªm Template Má»›i'}
              </h2>
              <button onClick={() => setShowModal(false)} className="text-gray-500 hover:text-gray-700">
                <X className="w-6 h-6" />
              </button>
            </div>

            <div className="p-6 space-y-5">
              {/* Image Upload */}
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">áº¢nh Template</label>
                <input
                  ref={fileInputRef}
                  type="file"
                  accept="image/*"
                  onChange={handleImageUpload}
                  className="hidden"
                />
                <div 
                  onClick={() => fileInputRef.current?.click()}
                  className="border-2 border-dashed border-gray-300 rounded-xl p-4 text-center cursor-pointer hover:border-pink-500 hover:bg-pink-50 transition"
                >
                  {previewImage ? (
                    <div className="relative">
                      <img 
                        src={previewImage} 
                        alt="Preview" 
                        className="w-32 h-32 object-cover rounded-lg mx-auto"
                      />
                      <p className="text-sm text-gray-500 mt-2">Click Ä‘á»ƒ thay Ä‘á»•i áº£nh</p>
                    </div>
                  ) : (
                    <>
                      <Upload className="w-10 h-10 text-gray-400 mx-auto mb-2" />
                      <p className="text-sm text-gray-600">Click Ä‘á»ƒ upload áº£nh</p>
                      <p className="text-xs text-gray-400 mt-1">PNG, JPG tá»‘i Ä‘a 5MB</p>
                    </>
                  )}
                </div>
                <p className="text-xs text-gray-500 mt-2">
                  Hoáº·c nháº­p URL áº£nh:
                </p>
                <input
                  type="text"
                  value={formData.template_image_url?.startsWith('data:') ? '' : formData.template_image_url}
                  onChange={(e) => {
                    setFormData(prev => ({ ...prev, template_image_url: e.target.value }));
                    if (e.target.value && !e.target.value.startsWith('data:')) {
                      setPreviewImage(e.target.value);
                    }
                  }}
                  placeholder="/templates/iphone15.jpg hoáº·c https://..."
                  className="mt-2 w-full px-3 py-2 border rounded-lg text-sm"
                />
              </div>

              {/* Phone Model */}
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">
                  TÃªn Model <span className="text-red-500">*</span>
                </label>
                <input
                  type="text"
                  value={formData.phone_model}
                  onChange={(e) => setFormData(prev => ({ ...prev, phone_model: e.target.value }))}
                  placeholder="VD: iPhone 15 Pro Max"
                  className="w-full px-3 py-2 border rounded-lg"
                />
              </div>

              {/* Brand */}
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">HÃ£ng</label>
                <select
                  value={formData.brand}
                  onChange={(e) => setFormData(prev => ({ ...prev, brand: e.target.value }))}
                  className="w-full px-3 py-2 border rounded-lg"
                >
                  {BRANDS.map(brand => (
                    <option key={brand} value={brand}>{brand}</option>
                  ))}
                </select>
              </div>

              {/* Dimensions */}
              <div className="grid grid-cols-2 gap-4">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">Chiá»u rá»™ng in (mm)</label>
                  <input
                    type="number"
                    value={formData.print_width_mm}
                    onChange={(e) => setFormData(prev => ({ ...prev, print_width_mm: parseFloat(e.target.value) || 0 }))}
                    className="w-full px-3 py-2 border rounded-lg"
                    step="0.1"
                  />
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">Chiá»u cao in (mm)</label>
                  <input
                    type="number"
                    value={formData.print_height_mm}
                    onChange={(e) => setFormData(prev => ({ ...prev, print_height_mm: parseFloat(e.target.value) || 0 }))}
                    className="w-full px-3 py-2 border rounded-lg"
                    step="0.1"
                  />
                </div>
              </div>

              <div className="grid grid-cols-2 gap-4">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">Canvas Width (px)</label>
                  <input
                    type="number"
                    value={formData.canvas_width}
                    onChange={(e) => setFormData(prev => ({ ...prev, canvas_width: parseInt(e.target.value) || 700 }))}
                    className="w-full px-3 py-2 border rounded-lg"
                  />
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">Canvas Height (px)</label>
                  <input
                    type="number"
                    value={formData.canvas_height}
                    onChange={(e) => setFormData(prev => ({ ...prev, canvas_height: parseInt(e.target.value) || 1500 }))}
                    className="w-full px-3 py-2 border rounded-lg"
                  />
                </div>
              </div>

              {/* Active Toggle */}
              <div className="flex items-center gap-3">
                <input
                  type="checkbox"
                  id="is_active"
                  checked={formData.is_active}
                  onChange={(e) => setFormData(prev => ({ ...prev, is_active: e.target.checked }))}
                  className="w-5 h-5 text-pink-600 rounded"
                />
                <label htmlFor="is_active" className="text-sm font-medium text-gray-700">
                  Hiá»ƒn thá»‹ trÃªn trang thiáº¿t káº¿
                </label>
              </div>
            </div>

            {/* Footer */}
            <div className="sticky bottom-0 bg-gray-50 border-t px-6 py-4 flex gap-3">
              <button
                onClick={() => setShowModal(false)}
                className="flex-1 py-2 bg-gray-200 text-gray-700 rounded-lg font-medium hover:bg-gray-300 transition"
              >
                Há»§y
              </button>
              <button
                onClick={handleSave}
                disabled={saving}
                className="flex-1 py-2 bg-pink-600 text-white rounded-lg font-medium hover:bg-pink-700 transition disabled:opacity-50 flex items-center justify-center gap-2"
              >
                {saving ? (
                  <div className="w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
                ) : (
                  <Save className="w-5 h-5" />
                )}
                {saving ? 'Äang lÆ°u...' : 'LÆ°u'}
              </button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}




################################################################################
## FILE 121: page.tsx
## Path: fontend/src/app/api-test/page.tsx
################################################################################

'use client';

import { useEffect, useState } from 'react';
import {
  fetchUsers,
  fetchProducts,
  fetchOrders,
  fetchCategories,
} from '@/lib/api-client';

export default function ApiTest() {
  const [customers, setCustomers] = useState<any>(null);
  const [products, setProducts] = useState<any>(null);
  const [orders, setOrders] = useState<any>(null);
  const [categories, setCategories] = useState<any>(null);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);

  const handleFetchUsers = async () => {
    setLoading(true);
    setError(null);
    try {
      const data = await fetchUsers();
      setCustomers(data);
    } catch (err: any) {
      setError(err.message || 'Lá»—i khi gá»i API');
    } finally {
      setLoading(false);
    }
  };

  const handleFetchProducts = async () => {
    setLoading(true);
    setError(null);
    try {
      const data = await fetchProducts(5);
      setProducts(data);
    } catch (err: any) {
      setError(err.message || 'Lá»—i khi gá»i API');
    } finally {
      setLoading(false);
    }
  };

  const handleFetchOrders = async () => {
    setLoading(true);
    setError(null);
    try {
      const data = await fetchOrders(10);
      setOrders(data);
    } catch (err: any) {
      setError(err.message || 'Lá»—i khi gá»i API');
    } finally {
      setLoading(false);
    }
  };

  const handleFetchCategories = async () => {
    setLoading(true);
    setError(null);
    try {
      const data = await fetchCategories();
      setCategories(data);
    } catch (err: any) {
      setError(err.message || 'Lá»—i khi gá»i API');
    } finally {
      setLoading(false);
    }
  };

  return (
    <main className="min-h-screen bg-gray-100 p-8">
      <div className="max-w-4xl mx-auto">
        <h1 className="text-3xl font-bold mb-8">Test API Backend</h1>

        {/* Error Display */}
        {error && (
          <div className="mb-4 p-4 bg-red-100 border border-red-400 text-red-700 rounded">
            <strong>Lá»—i:</strong> {error}
          </div>
        )}

        {/* Loading State */}
        {loading && (
          <div className="mb-4 p-4 bg-blue-100 border border-blue-400 text-blue-700 rounded">
            Äang táº£i...
          </div>
        )}

        {/* Buttons */}
        <div className="grid grid-cols-2 gap-4 mb-8">
          <button
            onClick={handleFetchUsers}
            disabled={loading}
            className="bg-blue-500 hover:bg-blue-600 disabled:bg-gray-400 text-white font-bold py-2 px-4 rounded"
          >
            Láº¥y KhÃ¡ch HÃ ng
          </button>
          <button
            onClick={handleFetchProducts}
            disabled={loading}
            className="bg-green-500 hover:bg-green-600 disabled:bg-gray-400 text-white font-bold py-2 px-4 rounded"
          >
            Láº¥y Sáº£n Pháº©m
          </button>
          <button
            onClick={handleFetchOrders}
            disabled={loading}
            className="bg-purple-500 hover:bg-purple-600 disabled:bg-gray-400 text-white font-bold py-2 px-4 rounded"
          >
            Láº¥y ÄÆ¡n HÃ ng
          </button>
          <button
            onClick={handleFetchCategories}
            disabled={loading}
            className="bg-orange-500 hover:bg-orange-600 disabled:bg-gray-400 text-white font-bold py-2 px-4 rounded"
          >
            Láº¥y Danh Má»¥c
          </button>
        </div>

        {/* Results */}
        <div className="space-y-6">
          {customers && (
            <div className="bg-white rounded-lg shadow p-6">
              <h2 className="text-xl font-bold mb-4">KhÃ¡ch HÃ ng</h2>
              <pre className="bg-gray-100 p-4 rounded overflow-auto text-sm">
                {JSON.stringify(customers, null, 2)}
              </pre>
            </div>
          )}

          {products && (
            <div className="bg-white rounded-lg shadow p-6">
              <h2 className="text-xl font-bold mb-4">Sáº£n Pháº©m</h2>
              <pre className="bg-gray-100 p-4 rounded overflow-auto text-sm">
                {JSON.stringify(products, null, 2)}
              </pre>
            </div>
          )}

          {orders && (
            <div className="bg-white rounded-lg shadow p-6">
              <h2 className="text-xl font-bold mb-4">ÄÆ¡n HÃ ng</h2>
              <pre className="bg-gray-100 p-4 rounded overflow-auto text-sm">
                {JSON.stringify(orders, null, 2)}
              </pre>
            </div>
          )}

          {categories && (
            <div className="bg-white rounded-lg shadow p-6">
              <h2 className="text-xl font-bold mb-4">Danh Má»¥c</h2>
              <pre className="bg-gray-100 p-4 rounded overflow-auto text-sm">
                {JSON.stringify(categories, null, 2)}
              </pre>
            </div>
          )}
        </div>
      </div>
    </main>
  );
}




################################################################################
## FILE 122: wishlist-context.tsx
## Path: fontend/src/app/context/wishlist-context.tsx
################################################################################

'use client';

import React, {
  createContext,
  useContext,
  useEffect,
  useState,
  useCallback,
} from 'react';
import { 
  fetchWishlistProductIds, 
  toggleWishlist as apiToggleWishlist,
  fetchWishlist as apiFetchWishlist 
} from '@/lib/api-client';

interface WishlistItem {
  wishlist_id: number;
  product_id: number;
  created_at: string;
  products: {
    product_id: number;
    product_name: string;
    price: number;
    sale_price?: number;
    image_url: string;
    description: string;
  };
}

interface WishlistContextType {
  // Danh sÃ¡ch product_id Ä‘Ã£ yÃªu thÃ­ch
  wishedProducts: Set<number>;
  
  // Danh sÃ¡ch chi tiáº¿t sáº£n pháº©m yÃªu thÃ­ch
  wishlistItems: WishlistItem[];
  
  // Loading state
  loading: boolean;
  
  // Kiá»ƒm tra sáº£n pháº©m cÃ³ trong wishlist
  isWished: (productId: number) => boolean;
  
  // Toggle yÃªu thÃ­ch - return true náº¿u thÃ nh cÃ´ng
  toggleWishlist: (productId: number) => Promise<boolean>;
  
  // Refresh danh sÃ¡ch tá»« server
  refreshWishlist: () => Promise<void>;
  
  // Sá»‘ lÆ°á»£ng sáº£n pháº©m yÃªu thÃ­ch
  wishlistCount: number;
}

const WishlistContext = createContext<WishlistContextType | undefined>(undefined);

export const WishlistProvider = ({
  children,
}: {
  children: React.ReactNode;
}) => {
  const [wishedProducts, setWishedProducts] = useState<Set<number>>(new Set());
  const [wishlistItems, setWishlistItems] = useState<WishlistItem[]>([]);
  const [loading, setLoading] = useState(false);

  /**
   * ðŸ”„ Äá»“ng bá»™ danh sÃ¡ch yÃªu thÃ­ch tá»« backend
   */
  const refreshWishlist = useCallback(async () => {
    try {
      setLoading(true);
      
      // Láº¥y danh sÃ¡ch product_id
      const productIds = await fetchWishlistProductIds();
      console.log('ðŸ“‹ Wishlist productIds:', productIds);
      setWishedProducts(new Set(productIds));
      
      // Láº¥y chi tiáº¿t sáº£n pháº©m
      const items = await apiFetchWishlist();
      console.log('ðŸ“‹ Wishlist items:', items);
      setWishlistItems(items || []);
    } catch (error) {
      console.error('âŒ refreshWishlist failed:', error);
    } finally {
      setLoading(false);
    }
  }, []);

  /**
   *  Kiá»ƒm tra sáº£n pháº©m cÃ³ trong danh sÃ¡ch yÃªu thÃ­ch
   */
  const isWished = useCallback((productId: number): boolean => {
    return wishedProducts.has(productId);
  }, [wishedProducts]);

  /**
   *  Toggle yÃªu thÃ­ch sáº£n pháº©m
   * @returns true náº¿u thÃ nh cÃ´ng, false náº¿u chÆ°a Ä‘Äƒng nháº­p
   */
  const toggleWishlist = useCallback(async (productId: number): Promise<boolean> => {
    try {
      // Kiá»ƒm tra Ä‘Äƒng nháº­p
      const customerData = localStorage.getItem('customer');
      if (!customerData) {
        return false; // ChÆ°a Ä‘Äƒng nháº­p
      }

      // Optimistic update (cáº­p nháº­t UI trÆ°á»›c)
      setWishedProducts(prev => {
        const next = new Set(prev);
        if (next.has(productId)) {
          next.delete(productId);
        } else {
          next.add(productId);
        }
        return next;
      });

      // Gá»i API
      const result = await apiToggleWishlist(productId);
      console.log('Toggle wishlist result:', result);
      
      // Refresh Ä‘á»ƒ Ä‘á»“ng bá»™ vá»›i server
      await refreshWishlist();
      return true;
    } catch (error) {
      console.error('âŒ toggleWishlist failed:', error);
      // Rollback náº¿u lá»—i
      await refreshWishlist();
      return false;
    }
  }, [refreshWishlist]);

  /**
   *  Load wishlist láº§n Ä‘áº§u khi app mount
   */
  useEffect(() => {
    // Chá»‰ load náº¿u Ä‘Ã£ Ä‘Äƒng nháº­p
    const customerData = localStorage.getItem('customer');
    if (customerData) {
      refreshWishlist();
    }
  }, [refreshWishlist]);

  // Láº¯ng nghe sá»± kiá»‡n login/logout (tá»« tab khÃ¡c)
  useEffect(() => {
    const handleStorageChange = () => {
      const customerData = localStorage.getItem('customer');
      if (customerData) {
        refreshWishlist();
      } else {
        setWishedProducts(new Set());
        setWishlistItems([]);
      }
    };

    window.addEventListener('storage', handleStorageChange);
    return () => window.removeEventListener('storage', handleStorageChange);
  }, [refreshWishlist]);

  // Láº¯ng nghe custom event khi login/logout trong cÃ¹ng tab
  useEffect(() => {
    const handleAuthChange = () => {
      const customerData = localStorage.getItem('customer');
      if (customerData) {
        console.log('ðŸ”„ Auth changed - refreshing wishlist');
        refreshWishlist();
      } else {
        console.log('ðŸ”„ Auth changed - clearing wishlist');
        setWishedProducts(new Set());
        setWishlistItems([]);
      }
    };

    window.addEventListener('authChange', handleAuthChange);
    return () => window.removeEventListener('authChange', handleAuthChange);
  }, [refreshWishlist]);

  return (
    <WishlistContext.Provider
      value={{
        wishedProducts,
        wishlistItems,
        loading,
        isWished,
        toggleWishlist,
        refreshWishlist,
        wishlistCount: wishedProducts.size,
      }}
    >
      {children}
    </WishlistContext.Provider>
  );
};

/**
 * ðŸ” Hook an toÃ n
 */
export const useWishlist = () => {
  const context = useContext(WishlistContext);
  if (context === undefined) {
    throw new Error('useWishlist must be used within a WishlistProvider');
  }
  return context;
};




################################################################################
## FILE 123: cart-context.tsx
## Path: fontend/src/app/context/cart-context.tsx
################################################################################

'use client';

import React, {
  createContext,
  useContext,
  useEffect,
  useState,
  useCallback,
} from 'react';
import { fetchShoppingCart } from '@/lib/api-client';

interface CartContextType {
  cartCount: number;

  // Sync vá»›i backend
  refreshCart: () => Promise<void>;

  // Local update (UX mÆ°á»£t)
  increaseCart: (qty?: number) => void;
  decreaseCart: (qty?: number) => void;
  clearCart: () => void;
}

const CartContext = createContext<CartContextType | undefined>(undefined);

export const CartProvider = ({
  children,
}: {
  children: React.ReactNode;
}) => {
  const [cartCount, setCartCount] = useState(0);

  /**
   * ðŸ”„ Äá»“ng bá»™ giá» hÃ ng tá»« backend
   */
  const refreshCart = useCallback(async () => {
    try {
      const result = await fetchShoppingCart();

      if (result?.success && Array.isArray(result.data)) {
        const total = result.data.reduce(
          (sum: number, item: any) => sum + (item.quantity || 0),
          0,
        );
        setCartCount(total);
      } else {
        setCartCount(0);
      }
    } catch (error) {
      console.error('âŒ refreshCart failed:', error);
    }
  }, []);

  /**
   * âž• TÄƒng sá»‘ lÆ°á»£ng ngay (UX)
   */
  const increaseCart = useCallback((qty: number = 1) => {
    setCartCount(prev => Math.max(prev + qty, 0));
  }, []);

  /**
   * âž– Giáº£m sá»‘ lÆ°á»£ng
   */
  const decreaseCart = useCallback((qty: number = 1) => {
    setCartCount(prev => Math.max(prev - qty, 0));
  }, []);

  /**
   * Clear cart (sau checkout / logout)
   */
  const clearCart = useCallback(() => {
    setCartCount(0);
  }, []);

  /**
   * Load cart láº§n Ä‘áº§u khi app mount
   */
  useEffect(() => {
    refreshCart();
  }, [refreshCart]);

  /**
   *  Láº¯ng nghe event cartUpdated Ä‘á»ƒ cáº­p nháº­t ngay khi thÃªm vÃ o giá»
   */
  useEffect(() => {
    const handleCartUpdated = () => {
      refreshCart();
    };

    window.addEventListener('cartUpdated', handleCartUpdated);
    
    return () => {
      window.removeEventListener('cartUpdated', handleCartUpdated);
    };
  }, [refreshCart]);

  return (
    <CartContext.Provider
      value={{
        cartCount,
        refreshCart,
        increaseCart,
        decreaseCart,
        clearCart,
      }}
    >
      {children}
    </CartContext.Provider>
  );
};

/**
 * ðŸ” Hook an toÃ n
 */
export const useCart = () => {
  const context = useContext(CartContext);
  if (!context) {
    throw new Error('useCart must be used within CartProvider');
  }
  return context;
};




################################################################################
## FILE 124: page.tsx
## Path: fontend/src/app/design/page.tsx
################################################################################

'use client';

import React, { useState, useEffect, useRef, useCallback } from 'react';
import { useRouter } from 'next/navigation';
import Link from 'next/link';
import { 
  Upload, Type, Image as ImageIcon, RotateCcw, RotateCw, 
  Trash2, Download, Send, Save, ZoomIn, ZoomOut, 
  Move, Smartphone, ChevronLeft, ChevronRight, Palette,
  AlignCenter, AlignLeft, AlignRight, Bold, Italic, Underline,
  Layers, Eye, EyeOff, Copy, FlipHorizontal, FlipVertical,
  Undo, Redo, Grid, Lock, Unlock, Home
} from 'lucide-react';
import { Canvas as FabricCanvas, FabricImage, FabricText, Rect, Circle, IText } from 'fabric';
import { useAuth } from '@/contexts/AuthContext';
import { getPhoneTemplates, createDesign, updateDesign, submitDesign } from '@/lib/api-client';

// Types
interface PhoneTemplate {
  template_id: number;
  phone_model: string;
  brand: string;
  template_image_url: string;
  print_width_mm: number;
  print_height_mm: number;
  canvas_width: number;
  canvas_height: number;
  is_active: boolean;
}

interface DesignState {
  designId: number | null;
  phoneModel: string;
  templateId: number | null;
  status: 'draft' | 'submitted' | 'processing' | 'approved' | 'rejected';
}

export default function DesignPage() {
  const router = useRouter();
  const { user, isAuthenticated } = useAuth();
  
  // Refs
  const canvasRef = useRef<HTMLCanvasElement>(null);
  const fabricRef = useRef<FabricCanvas | null>(null);
  const fileInputRef = useRef<HTMLInputElement>(null);
  const containerRef = useRef<HTMLDivElement>(null);
  
  // State
  const [templates, setTemplates] = useState<PhoneTemplate[]>([]);
  const [loadingTemplates, setLoadingTemplates] = useState(true);
  const [selectedTemplate, setSelectedTemplate] = useState<PhoneTemplate | null>(null);
  const [designState, setDesignState] = useState<DesignState>({
    designId: null,
    phoneModel: '',
    templateId: null,
    status: 'draft'
  });
  
  const [loading, setLoading] = useState(false);
  const [saving, setSaving] = useState(false);
  const [showTemplateSelector, setShowTemplateSelector] = useState(true);
  const [activeTab, setActiveTab] = useState<'upload' | 'text' | 'shapes' | 'layers'>('upload');
  const [selectedObject, setSelectedObject] = useState<any>(null);
  const [zoom, setZoom] = useState(0.4);
  const [history, setHistory] = useState<string[]>([]);
  const [historyIndex, setHistoryIndex] = useState(-1);
  
  // Text settings
  const [textSettings, setTextSettings] = useState({
    text: 'Nháº­p text',
    fontFamily: 'Arial',
    fontSize: 40,
    fill: '#000000',
    fontWeight: 'normal',
    fontStyle: 'normal',
    textAlign: 'center',
    underline: false
  });
  
  // Guest info (for non-logged in users)
  const [guestInfo, setGuestInfo] = useState({
    name: '',
    email: '',
    phone: ''
  });
  
  // Load templates from API
  useEffect(() => {
    const loadTemplates = async () => {
      setLoadingTemplates(true);
      try {
        const response = await getPhoneTemplates();
        console.log('API Response:', response);
        
        // Handle response format { data, error } from backend
        let templatesData = response;
        if (response?.data) {
          templatesData = response.data;
        }
        
        if (templatesData && Array.isArray(templatesData) && templatesData.length > 0) {
          setTemplates(templatesData);
        } else {
          console.warn('No templates found in API response');
        }
      } catch (error) {
        console.error('Error loading templates:', error);
      } finally {
        setLoadingTemplates(false);
      }
    };
    loadTemplates();
  }, []);
  
  // Initialize Fabric.js canvas
  useEffect(() => {
    if (!canvasRef.current || !selectedTemplate || fabricRef.current) return;
    
    const canvas = new FabricCanvas(canvasRef.current, {
      width: selectedTemplate.canvas_width,
      height: selectedTemplate.canvas_height,
      backgroundColor: '#ffffff',
      selection: true,
      preserveObjectStacking: true,
    });
    
    fabricRef.current = canvas;
    
    // Event listeners
    canvas.on('selection:created', (e) => {
      setSelectedObject(e.selected?.[0] || null);
    });
    
    canvas.on('selection:updated', (e) => {
      setSelectedObject(e.selected?.[0] || null);
    });
    
    canvas.on('selection:cleared', () => {
      setSelectedObject(null);
    });
    
    canvas.on('object:modified', () => {
      saveToHistory();
    });
    
    // Add phone template overlay
    addTemplateOverlay(canvas, selectedTemplate);
    
    // Initial zoom
    updateZoom(0.4);
    
    // Save initial state
    saveToHistory();
    
    return () => {
      canvas.dispose();
      fabricRef.current = null;
    };
  }, [selectedTemplate]);
  
  // Add template overlay (phone frame)
  const addTemplateOverlay = async (canvas: FabricCanvas, template: PhoneTemplate) => {
    const cw = template.canvas_width;
    const ch = template.canvas_height;
    
    // Load template image if available
    if (template.template_image_url) {
      try {
        const img = await FabricImage.fromURL(template.template_image_url, { crossOrigin: 'anonymous' });
        // Scale to fit canvas while maintaining aspect ratio
        const scale = Math.min(cw / (img.width || cw), ch / (img.height || ch)) * 0.9;
        img.scale(scale);
        img.set({
          left: cw / 2,
          top: ch / 2,
          originX: 'center',
          originY: 'center',
          selectable: false,
          evented: false,
          opacity: 0.3,
          name: 'phoneFrame'
        });
        canvas.add(img);
        canvas.sendObjectToBack(img);
      } catch (e) {
        console.log('Could not load template image');
      }
    }
    
    // Calculate safe print area (with padding for phone edges)
    const paddingX = cw * 0.05; // 5% padding on each side
    const paddingTop = ch * 0.08; // 8% padding top (for camera notch)
    const paddingBottom = ch * 0.05; // 5% padding bottom
    
    // Create safe area indicator
    const safeAreaRect = new Rect({
      left: paddingX,
      top: paddingTop,
      width: cw - (paddingX * 2),
      height: ch - paddingTop - paddingBottom,
      fill: 'transparent',
      stroke: '#e91e63',
      strokeWidth: 2,
      strokeDashArray: [10, 5],
      selectable: false,
      evented: false,
      name: 'safeArea'
    });
    
    canvas.add(safeAreaRect);
    
    // Add camera notch indicator for iPhones
    if (template.phone_model.toLowerCase().includes('iphone')) {
      const notchWidth = cw * 0.3;
      const notchHeight = ch * 0.03;
      const notch = new Rect({
        left: (cw - notchWidth) / 2,
        top: 10,
        width: notchWidth,
        height: notchHeight,
        fill: '#00000020',
        rx: notchHeight / 2,
        ry: notchHeight / 2,
        selectable: false,
        evented: false,
        name: 'phoneFrame'
      });
      canvas.add(notch);
    }
    
    // Add phone model label
    const label = new FabricText(template.phone_model, {
      left: cw / 2,
      top: ch * 0.04,
      fontSize: 20,
      fill: '#999999',
      fontFamily: 'Arial',
      originX: 'center',
      selectable: false,
      evented: false,
      name: 'phoneLabel'
    });
    
    canvas.add(label);
    
    // Add size info label
    const sizeLabel = new FabricText(`${template.print_width_mm} Ã— ${template.print_height_mm} mm`, {
      left: cw / 2,
      top: ch - 25,
      fontSize: 14,
      fill: '#cccccc',
      fontFamily: 'Arial',
      originX: 'center',
      selectable: false,
      evented: false,
      name: 'phoneLabel'
    });
    
    canvas.add(sizeLabel);
    canvas.renderAll();
  };
  
  // Save to history for undo/redo
  const saveToHistory = useCallback(() => {
    if (!fabricRef.current) return;
    
    const json = JSON.stringify(fabricRef.current.toJSON());
    const newHistory = history.slice(0, historyIndex + 1);
    newHistory.push(json);
    
    // Limit history to 50 states
    if (newHistory.length > 50) {
      newHistory.shift();
    }
    
    setHistory(newHistory);
    setHistoryIndex(newHistory.length - 1);
  }, [history, historyIndex]);
  
  // Undo
  const undo = useCallback(() => {
    if (historyIndex <= 0 || !fabricRef.current) return;
    
    const newIndex = historyIndex - 1;
    fabricRef.current.loadFromJSON(JSON.parse(history[newIndex]), () => {
      fabricRef.current?.renderAll();
      setHistoryIndex(newIndex);
    });
  }, [history, historyIndex]);
  
  // Redo
  const redo = useCallback(() => {
    if (historyIndex >= history.length - 1 || !fabricRef.current) return;
    
    const newIndex = historyIndex + 1;
    fabricRef.current.loadFromJSON(JSON.parse(history[newIndex]), () => {
      fabricRef.current?.renderAll();
      setHistoryIndex(newIndex);
    });
  }, [history, historyIndex]);
  
  // Update zoom
  const updateZoom = (newZoom: number) => {
    if (!fabricRef.current || !containerRef.current) return;
    
    const clampedZoom = Math.max(0.1, Math.min(2, newZoom));
    setZoom(clampedZoom);
    
    fabricRef.current.setZoom(clampedZoom);
    fabricRef.current.setDimensions({
      width: (selectedTemplate?.canvas_width || 700) * clampedZoom,
      height: (selectedTemplate?.canvas_height || 1500) * clampedZoom
    });
    fabricRef.current.renderAll();
  };
  
  // Handle image upload
  const handleImageUpload = (e: React.ChangeEvent<HTMLInputElement>) => {
    const files = e.target.files;
    if (!files || !fabricRef.current) return;
    
    Array.from(files).forEach(file => {
      const reader = new FileReader();
      reader.onload = async (event) => {
        const imgUrl = event.target?.result as string;
        
        try {
          const img = await FabricImage.fromURL(imgUrl, { crossOrigin: 'anonymous' });
          
          // Scale image to fit canvas
          const canvas = fabricRef.current!;
          const maxWidth = canvas.width! * 0.8;
          const maxHeight = canvas.height! * 0.5;
          
          const scale = Math.min(
            maxWidth / (img.width || 100),
            maxHeight / (img.height || 100)
          );
          
          img.scale(scale);
          img.set({
            left: (canvas.width! / 2) - ((img.width || 100) * scale / 2),
            top: (canvas.height! / 2) - ((img.height || 100) * scale / 2),
            cornerStyle: 'circle',
            cornerColor: '#e91e63',
            cornerStrokeColor: '#ffffff',
            borderColor: '#e91e63',
            transparentCorners: false,
          });
          
          canvas.add(img);
          canvas.setActiveObject(img);
          canvas.renderAll();
          saveToHistory();
        } catch (error) {
          console.error('Error loading image:', error);
        }
      };
      reader.readAsDataURL(file);
    });
    
    // Reset input
    if (fileInputRef.current) {
      fileInputRef.current.value = '';
    }
  };
  
  // Add text
  const addText = () => {
    if (!fabricRef.current) return;
    
    const text = new IText(textSettings.text, {
      left: fabricRef.current.width! / 2,
      top: fabricRef.current.height! / 2,
      fontSize: textSettings.fontSize,
      fontFamily: textSettings.fontFamily,
      fill: textSettings.fill,
      fontWeight: textSettings.fontWeight as any,
      fontStyle: textSettings.fontStyle as any,
      textAlign: textSettings.textAlign,
      underline: textSettings.underline,
      originX: 'center',
      originY: 'center',
      cornerStyle: 'circle',
      cornerColor: '#e91e63',
      cornerStrokeColor: '#ffffff',
      borderColor: '#e91e63',
      transparentCorners: false,
    });
    
    fabricRef.current.add(text);
    fabricRef.current.setActiveObject(text);
    fabricRef.current.renderAll();
    saveToHistory();
  };
  
  // Add shape
  const addShape = (type: 'rect' | 'circle') => {
    if (!fabricRef.current) return;
    
    let shape;
    const centerX = fabricRef.current.width! / 2;
    const centerY = fabricRef.current.height! / 2;
    
    if (type === 'rect') {
      shape = new Rect({
        left: centerX - 75,
        top: centerY - 75,
        width: 150,
        height: 150,
        fill: '#e91e63',
        cornerStyle: 'circle',
        cornerColor: '#e91e63',
        borderColor: '#e91e63',
        transparentCorners: false,
      });
    } else {
      shape = new Circle({
        left: centerX - 75,
        top: centerY - 75,
        radius: 75,
        fill: '#e91e63',
        cornerStyle: 'circle',
        cornerColor: '#e91e63',
        borderColor: '#e91e63',
        transparentCorners: false,
      });
    }
    
    fabricRef.current.add(shape);
    fabricRef.current.setActiveObject(shape);
    fabricRef.current.renderAll();
    saveToHistory();
  };
  
  // Delete selected object
  const deleteSelected = () => {
    if (!fabricRef.current || !selectedObject) return;
    
    // Don't delete system objects
    if (selectedObject.name === 'safeArea' || selectedObject.name === 'phoneLabel') return;
    
    fabricRef.current.remove(selectedObject);
    fabricRef.current.renderAll();
    setSelectedObject(null);
    saveToHistory();
  };
  
  // Rotate object
  const rotateObject = (angle: number) => {
    if (!fabricRef.current || !selectedObject) return;
    
    const currentAngle = selectedObject.angle || 0;
    selectedObject.rotate(currentAngle + angle);
    fabricRef.current.renderAll();
    saveToHistory();
  };
  
  // Flip object
  const flipObject = (direction: 'horizontal' | 'vertical') => {
    if (!fabricRef.current || !selectedObject) return;
    
    if (direction === 'horizontal') {
      selectedObject.set('flipX', !selectedObject.flipX);
    } else {
      selectedObject.set('flipY', !selectedObject.flipY);
    }
    fabricRef.current.renderAll();
    saveToHistory();
  };
  
  // Duplicate object
  const duplicateObject = () => {
    if (!fabricRef.current || !selectedObject) return;
    
    selectedObject.clone((cloned: any) => {
      cloned.set({
        left: (selectedObject.left || 0) + 20,
        top: (selectedObject.top || 0) + 20,
      });
      fabricRef.current!.add(cloned);
      fabricRef.current!.setActiveObject(cloned);
      fabricRef.current!.renderAll();
      saveToHistory();
    });
  };
  
  // Bring to front / Send to back
  const changeLayer = (action: 'front' | 'back') => {
    if (!fabricRef.current || !selectedObject) return;
    
    if (action === 'front') {
      fabricRef.current.bringObjectToFront(selectedObject);
    } else {
      fabricRef.current.sendObjectToBack(selectedObject);
    }
    fabricRef.current.renderAll();
    saveToHistory();
  };
  
  // Export canvas to base64
  const exportCanvas = (): string => {
    if (!fabricRef.current) return '';
    
    // Temporarily remove system objects for export
    const objects = fabricRef.current.getObjects();
    const systemObjects = objects.filter(obj => 
      (obj as any).name === 'safeArea' || (obj as any).name === 'phoneLabel' || (obj as any).name === 'phoneFrame'
    );
    
    systemObjects.forEach(obj => fabricRef.current!.remove(obj));
    
    const dataUrl = fabricRef.current.toDataURL({
      format: 'jpeg',
      quality: 0.8,
      multiplier: 1, // Reduced to avoid large file size
    });
    
    // Re-add system objects
    systemObjects.forEach(obj => fabricRef.current!.add(obj));
    fabricRef.current.renderAll();
    
    return dataUrl;
  };
  
  // Get design data as JSON
  const getDesignData = () => {
    if (!fabricRef.current) return null;
    
    // Get canvas JSON without system objects
    const json = fabricRef.current.toJSON() as any;
    json.objects = json.objects.filter((obj: any) => 
      obj.name !== 'safeArea' && obj.name !== 'phoneLabel' && obj.name !== 'phoneFrame'
    );
    
    return {
      ...json,
      width: selectedTemplate?.canvas_width,
      height: selectedTemplate?.canvas_height,
    };
  };
  
  // Save design
  const handleSave = async () => {
    if (!fabricRef.current || !selectedTemplate) return;
    
    setSaving(true);
    try {
      const designData = getDesignData();
      const previewImage = exportCanvas();
      
      const payload = {
        userId: user?.id || undefined,
        guestEmail: !isAuthenticated ? guestInfo.email : undefined,
        guestName: !isAuthenticated ? guestInfo.name : undefined,
        guestPhone: !isAuthenticated ? guestInfo.phone : undefined,
        templateId: selectedTemplate.template_id.toString(),
        phoneModel: selectedTemplate.phone_model,
        designData,
        previewImageBase64: previewImage,
      };
      
      let result: any;
      if (designState.designId) {
        result = await updateDesign(designState.designId.toString(), {
          designData,
          previewImageBase64: previewImage,
        });
      } else {
        result = await createDesign(payload);
        if (result?.design?.design_id) {
          setDesignState(prev => ({
            ...prev,
            designId: result.design.design_id
          }));
        }
      }
      
      alert('ÄÃ£ lÆ°u thiáº¿t káº¿ thÃ nh cÃ´ng!');
    } catch (error) {
      console.error('Error saving design:', error);
      alert('CÃ³ lá»—i khi lÆ°u thiáº¿t káº¿. Vui lÃ²ng thá»­ láº¡i!');
    } finally {
      setSaving(false);
    }
  };
  
  // Submit design
  const handleSubmit = async () => {
    if (!fabricRef.current || !selectedTemplate) return;
    
    // Validate guest info if not logged in
    if (!isAuthenticated) {
      if (!guestInfo.email || !guestInfo.name || !guestInfo.phone) {
        alert('Vui lÃ²ng nháº­p Ä‘áº§y Ä‘á»§ thÃ´ng tin liÃªn há»‡!');
        return;
      }
    }
    
    setSaving(true);
    try {
      // First save the design
      const designData = getDesignData();
      const previewImage = exportCanvas();
      
      let designId = designState.designId;
      
      if (!designId) {
        const createResult = await createDesign({
          userId: user?.id || undefined,
          guestEmail: !isAuthenticated ? guestInfo.email : undefined,
          guestName: !isAuthenticated ? guestInfo.name : undefined,
          guestPhone: !isAuthenticated ? guestInfo.phone : undefined,
          templateId: selectedTemplate.template_id.toString(),
          phoneModel: selectedTemplate.phone_model,
          designData,
          previewImageBase64: previewImage,
        });
        designId = createResult.design?.design_id;
      } else {
        await updateDesign(designId.toString(), {
          designData,
          previewImageBase64: previewImage,
        });
      }
      
      if (!designId) {
        throw new Error('KhÃ´ng thá»ƒ táº¡o thiáº¿t káº¿');
      }
      
      // Submit for review
      await submitDesign(designId.toString(), {
        guestEmail: !isAuthenticated ? guestInfo.email : undefined,
        guestName: !isAuthenticated ? guestInfo.name : undefined,
        guestPhone: !isAuthenticated ? guestInfo.phone : undefined,
      });
      
      setDesignState(prev => ({
        ...prev,
        designId,
        status: 'submitted'
      }));
      
      alert('Thiáº¿t káº¿ Ä‘Ã£ Ä‘Æ°á»£c gá»­i! Admin sáº½ xem xÃ©t vÃ  liÃªn há»‡ vá»›i báº¡n.');
      
    } catch (error) {
      console.error('Error submitting design:', error);
      alert('CÃ³ lá»—i khi gá»­i thiáº¿t káº¿. Vui lÃ²ng thá»­ láº¡i!');
    } finally {
      setSaving(false);
    }
  };
  
  // Download design
  const handleDownload = () => {
    if (!fabricRef.current) return;
    
    const dataUrl = exportCanvas();
    const link = document.createElement('a');
    link.download = `design-${selectedTemplate?.phone_model || 'custom'}-${Date.now()}.png`;
    link.href = dataUrl;
    link.click();
  };
  
  // Select template
  const handleSelectTemplate = (template: PhoneTemplate) => {
    setSelectedTemplate(template);
    setDesignState(prev => ({
      ...prev,
      phoneModel: template.phone_model,
      templateId: template.template_id
    }));
    setShowTemplateSelector(false);
  };
  
  // Template selector view
  if (showTemplateSelector) {
    return (
      <div className="min-h-screen bg-gradient-to-br from-pink-50 via-purple-50 to-blue-50">
        {/* Header */}
        <header className="bg-white/80 backdrop-blur-md shadow-sm sticky top-0 z-50">
          <div className="max-w-7xl mx-auto px-4 py-4 flex items-center justify-between">
            <Link href="/" className="flex items-center gap-2 text-gray-600 hover:text-pink-600 transition">
              <Home className="w-5 h-5" />
              <span>Trang chá»§</span>
            </Link>
            <h1 className="text-2xl font-bold bg-gradient-to-r from-pink-600 to-purple-600 bg-clip-text text-transparent">
              ðŸŽ¨ Thiáº¿t Káº¿ á»p Äiá»‡n Thoáº¡i
            </h1>
            <div className="w-24"></div>
          </div>
        </header>
        
        <div className="max-w-6xl mx-auto px-4 py-12">
          <div className="text-center mb-12">
            <h2 className="text-4xl font-bold text-gray-900 mb-4">
              Chá»n Model Äiá»‡n Thoáº¡i
            </h2>
            <p className="text-gray-600 text-lg">
              BÆ°á»›c Ä‘áº§u tiÃªn: Chá»n máº«u Ä‘iá»‡n thoáº¡i Ä‘á»ƒ báº¯t Ä‘áº§u thiáº¿t káº¿ á»‘p lÆ°ng Ä‘á»™c Ä‘Ã¡o cá»§a báº¡n
            </p>
          </div>
          
          {/* Loading state */}
          {loadingTemplates && (
            <div className="flex flex-col items-center justify-center py-20">
              <div className="w-16 h-16 border-4 border-pink-200 border-t-pink-600 rounded-full animate-spin mb-4"></div>
              <p className="text-gray-600">Äang táº£i danh sÃ¡ch Ä‘iá»‡n thoáº¡i...</p>
            </div>
          )}
          
          {/* Empty state */}
          {!loadingTemplates && templates.length === 0 && (
            <div className="text-center py-20">
              <Smartphone className="w-20 h-20 text-gray-300 mx-auto mb-4" />
              <h3 className="text-xl font-semibold text-gray-700 mb-2">ChÆ°a cÃ³ máº«u Ä‘iá»‡n thoáº¡i nÃ o</h3>
              <p className="text-gray-500 mb-6">Vui lÃ²ng liÃªn há»‡ admin Ä‘á»ƒ thÃªm máº«u Ä‘iá»‡n thoáº¡i vÃ o há»‡ thá»‘ng.</p>
              <button
                onClick={() => window.location.reload()}
                className="px-6 py-2 bg-pink-600 text-white rounded-lg hover:bg-pink-700 transition"
              >
                Thá»­ láº¡i
              </button>
            </div>
          )}
          
          {/* Group by brand */}
          {!loadingTemplates && templates.length > 0 && ['Apple', 'Samsung', 'Xiaomi', 'OPPO', 'Vivo', 'Realme', 'OnePlus', 'Google', 'Huawei', 'Other'].map(brand => {
            const brandTemplates = templates.filter(t => t.brand === brand || (brand === 'Other' && !['Apple', 'Samsung', 'Xiaomi', 'OPPO', 'Vivo', 'Realme', 'OnePlus', 'Google', 'Huawei'].includes(t.brand)));
            if (brandTemplates.length === 0) return null;
            
            return (
              <div key={brand} className="mb-10">
                <h3 className="text-xl font-semibold text-gray-800 mb-4 flex items-center gap-2">
                  <Smartphone className="w-5 h-5 text-pink-600" />
                  {brand}
                </h3>
                <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-5">
                  {brandTemplates.map(template => (
                    <button
                      key={template.template_id}
                      onClick={() => handleSelectTemplate(template)}
                      className="group bg-white rounded-2xl overflow-hidden shadow-md hover:shadow-2xl transition-all duration-300 border-2 border-transparent hover:border-pink-500 transform hover:-translate-y-1"
                    >
                      <div className="relative aspect-square bg-gradient-to-br from-pink-50 via-white to-purple-50 overflow-hidden">
                        {template.template_image_url ? (
                          <img 
                            src={template.template_image_url} 
                            alt={template.phone_model}
                            className="w-full h-full object-cover group-hover:scale-110 transition-transform duration-500"
                            onError={(e) => {
                              // Fallback to icon if image fails to load
                              (e.target as HTMLImageElement).style.display = 'none';
                              (e.target as HTMLImageElement).nextElementSibling?.classList.remove('hidden');
                            }}
                          />
                        ) : null}
                        <div className={`absolute inset-0 flex items-center justify-center ${template.template_image_url ? 'hidden' : ''}`}>
                          <Smartphone className="w-20 h-20 text-gray-300 group-hover:text-pink-400 transition-colors" />
                        </div>
                        {/* Overlay gradient on hover */}
                        <div className="absolute inset-0 bg-gradient-to-t from-black/40 via-transparent to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300" />
                        {/* Select badge */}
                        <div className="absolute bottom-3 left-1/2 -translate-x-1/2 bg-white/90 backdrop-blur-sm text-pink-600 px-4 py-1.5 rounded-full text-sm font-semibold opacity-0 group-hover:opacity-100 transition-all duration-300 transform translate-y-2 group-hover:translate-y-0 shadow-lg">
                          Chá»n máº«u nÃ y
                        </div>
                      </div>
                      <div className="p-4 text-center">
                        <h4 className="font-bold text-gray-900 group-hover:text-pink-600 transition-colors text-base">
                          {template.phone_model}
                        </h4>
                        <p className="text-xs text-gray-400 mt-1">
                          {template.print_width_mm} Ã— {template.print_height_mm} mm
                        </p>
                      </div>
                    </button>
                  ))}
                </div>
              </div>
            );
          })}
        </div>
      </div>
    );
  }
  
  // Design editor view
  return (
    <div className="min-h-screen bg-gray-100 flex flex-col">
      {/* Header */}
      <header className="bg-white shadow-sm z-50">
        <div className="max-w-full mx-auto px-4 py-3 flex items-center justify-between">
          <div className="flex items-center gap-4">
            <button
              onClick={() => {
                if (confirm('Báº¡n cÃ³ muá»‘n chá»n láº¡i máº«u Ä‘iá»‡n thoáº¡i? Thiáº¿t káº¿ hiá»‡n táº¡i sáº½ bá»‹ máº¥t náº¿u chÆ°a lÆ°u.')) {
                  fabricRef.current?.dispose();
                  fabricRef.current = null;
                  setShowTemplateSelector(true);
                  setSelectedTemplate(null);
                }
              }}
              className="flex items-center gap-2 text-gray-600 hover:text-pink-600 transition"
            >
              <ChevronLeft className="w-5 h-5" />
              <span className="hidden sm:inline">Äá»•i máº«u</span>
            </button>
            <div className="h-6 w-px bg-gray-300"></div>
            <div className="flex items-center gap-2">
              <Smartphone className="w-5 h-5 text-pink-600" />
              <span className="font-semibold text-gray-900">{selectedTemplate?.phone_model}</span>
            </div>
          </div>
          
          <div className="flex items-center gap-2">
            {/* Undo/Redo */}
            <button
              onClick={undo}
              disabled={historyIndex <= 0}
              className="p-2 rounded-lg hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed"
              title="HoÃ n tÃ¡c"
            >
              <Undo className="w-5 h-5" />
            </button>
            <button
              onClick={redo}
              disabled={historyIndex >= history.length - 1}
              className="p-2 rounded-lg hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed"
              title="LÃ m láº¡i"
            >
              <Redo className="w-5 h-5" />
            </button>
            
            <div className="h-6 w-px bg-gray-300 mx-2"></div>
            
            {/* Zoom controls */}
            <button
              onClick={() => updateZoom(zoom - 0.1)}
              className="p-2 rounded-lg hover:bg-gray-100"
              title="Thu nhá»"
            >
              <ZoomOut className="w-5 h-5" />
            </button>
            <span className="text-sm font-medium w-14 text-center">{Math.round(zoom * 100)}%</span>
            <button
              onClick={() => updateZoom(zoom + 0.1)}
              className="p-2 rounded-lg hover:bg-gray-100"
              title="PhÃ³ng to"
            >
              <ZoomIn className="w-5 h-5" />
            </button>
            
            <div className="h-6 w-px bg-gray-300 mx-2"></div>
            
            {/* Action buttons */}
            <button
              onClick={handleDownload}
              className="flex items-center gap-2 px-4 py-2 bg-gray-100 hover:bg-gray-200 rounded-lg transition"
              title="Táº£i xuá»‘ng"
            >
              <Download className="w-4 h-4" />
              <span className="hidden sm:inline">Táº£i xuá»‘ng</span>
            </button>
            <button
              onClick={handleSave}
              disabled={saving}
              className="flex items-center gap-2 px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg transition disabled:opacity-50"
            >
              <Save className="w-4 h-4" />
              <span className="hidden sm:inline">{saving ? 'Äang lÆ°u...' : 'LÆ°u'}</span>
            </button>
            <button
              onClick={handleSubmit}
              disabled={saving}
              className="flex items-center gap-2 px-4 py-2 bg-gradient-to-r from-pink-500 to-purple-500 hover:from-pink-600 hover:to-purple-600 text-white rounded-lg transition disabled:opacity-50"
            >
              <Send className="w-4 h-4" />
              <span className="hidden sm:inline">{saving ? 'Äang gá»­i...' : 'Gá»­i thiáº¿t káº¿'}</span>
            </button>
          </div>
        </div>
      </header>
      
      <div className="flex flex-1 overflow-hidden">
        {/* Left Sidebar - Tools */}
        <aside className="w-72 bg-white shadow-lg overflow-y-auto">
          {/* Tabs */}
          <div className="flex border-b">
            {[
              { id: 'upload', icon: ImageIcon, label: 'áº¢nh' },
              { id: 'text', icon: Type, label: 'Chá»¯' },
              { id: 'shapes', icon: Palette, label: 'HÃ¬nh' },
              { id: 'layers', icon: Layers, label: 'Lá»›p' },
            ].map(tab => (
              <button
                key={tab.id}
                onClick={() => setActiveTab(tab.id as any)}
                className={`flex-1 py-3 flex flex-col items-center gap-1 text-xs font-medium transition ${
                  activeTab === tab.id
                    ? 'text-pink-600 border-b-2 border-pink-600 bg-pink-50'
                    : 'text-gray-500 hover:text-gray-700'
                }`}
              >
                <tab.icon className="w-5 h-5" />
                {tab.label}
              </button>
            ))}
          </div>
          
          <div className="p-4">
            {/* Upload Tab */}
            {activeTab === 'upload' && (
              <div className="space-y-4">
                <input
                  ref={fileInputRef}
                  type="file"
                  accept="image/*"
                  multiple
                  onChange={handleImageUpload}
                  className="hidden"
                />
                <button
                  onClick={() => fileInputRef.current?.click()}
                  className="w-full py-8 border-2 border-dashed border-pink-300 rounded-xl hover:border-pink-500 hover:bg-pink-50 transition flex flex-col items-center gap-2"
                >
                  <Upload className="w-8 h-8 text-pink-500" />
                  <span className="font-medium text-gray-700">Táº£i áº£nh lÃªn</span>
                  <span className="text-xs text-gray-500">PNG, JPG tá»‘i Ä‘a 10MB</span>
                </button>
                
                <p className="text-sm text-gray-500">
                  ðŸ’¡ <strong>Máº¹o:</strong> Sá»­ dá»¥ng áº£nh cÃ³ Ä‘á»™ phÃ¢n giáº£i cao Ä‘á»ƒ káº¿t quáº£ in Ä‘áº¹p nháº¥t!
                </p>
              </div>
            )}
            
            {/* Text Tab */}
            {activeTab === 'text' && (
              <div className="space-y-4">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">Ná»™i dung</label>
                  <textarea
                    value={textSettings.text}
                    onChange={(e) => setTextSettings(prev => ({ ...prev, text: e.target.value }))}
                    className="w-full px-3 py-2 border rounded-lg resize-none"
                    rows={2}
                    placeholder="Nháº­p ná»™i dung..."
                  />
                </div>
                
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">Font chá»¯</label>
                  <select
                    value={textSettings.fontFamily}
                    onChange={(e) => setTextSettings(prev => ({ ...prev, fontFamily: e.target.value }))}
                    className="w-full px-3 py-2 border rounded-lg"
                  >
                    <option value="Arial">Arial</option>
                    <option value="Helvetica">Helvetica</option>
                    <option value="Times New Roman">Times New Roman</option>
                    <option value="Georgia">Georgia</option>
                    <option value="Verdana">Verdana</option>
                    <option value="Courier New">Courier New</option>
                    <option value="Impact">Impact</option>
                    <option value="Comic Sans MS">Comic Sans MS</option>
                  </select>
                </div>
                
                <div className="grid grid-cols-2 gap-4">
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">Cá»¡ chá»¯</label>
                    <input
                      type="number"
                      value={textSettings.fontSize}
                      onChange={(e) => setTextSettings(prev => ({ ...prev, fontSize: parseInt(e.target.value) || 40 }))}
                      className="w-full px-3 py-2 border rounded-lg"
                      min={10}
                      max={200}
                    />
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">MÃ u chá»¯</label>
                    <input
                      type="color"
                      value={textSettings.fill}
                      onChange={(e) => setTextSettings(prev => ({ ...prev, fill: e.target.value }))}
                      className="w-full h-10 border rounded-lg cursor-pointer"
                    />
                  </div>
                </div>
                
                {/* Text style buttons */}
                <div className="flex gap-2">
                  <button
                    onClick={() => setTextSettings(prev => ({ 
                      ...prev, 
                      fontWeight: prev.fontWeight === 'bold' ? 'normal' : 'bold' 
                    }))}
                    className={`flex-1 py-2 rounded-lg border transition ${
                      textSettings.fontWeight === 'bold' ? 'bg-pink-100 border-pink-500 text-pink-600' : 'hover:bg-gray-100'
                    }`}
                  >
                    <Bold className="w-4 h-4 mx-auto" />
                  </button>
                  <button
                    onClick={() => setTextSettings(prev => ({ 
                      ...prev, 
                      fontStyle: prev.fontStyle === 'italic' ? 'normal' : 'italic' 
                    }))}
                    className={`flex-1 py-2 rounded-lg border transition ${
                      textSettings.fontStyle === 'italic' ? 'bg-pink-100 border-pink-500 text-pink-600' : 'hover:bg-gray-100'
                    }`}
                  >
                    <Italic className="w-4 h-4 mx-auto" />
                  </button>
                  <button
                    onClick={() => setTextSettings(prev => ({ ...prev, underline: !prev.underline }))}
                    className={`flex-1 py-2 rounded-lg border transition ${
                      textSettings.underline ? 'bg-pink-100 border-pink-500 text-pink-600' : 'hover:bg-gray-100'
                    }`}
                  >
                    <Underline className="w-4 h-4 mx-auto" />
                  </button>
                </div>
                
                <button
                  onClick={addText}
                  className="w-full py-3 bg-gradient-to-r from-pink-500 to-purple-500 text-white rounded-lg font-medium hover:from-pink-600 hover:to-purple-600 transition"
                >
                  + ThÃªm chá»¯
                </button>
              </div>
            )}
            
            {/* Shapes Tab */}
            {activeTab === 'shapes' && (
              <div className="space-y-4">
                <p className="text-sm text-gray-600">ThÃªm hÃ¬nh dáº¡ng vÃ o thiáº¿t káº¿</p>
                <div className="grid grid-cols-2 gap-3">
                  <button
                    onClick={() => addShape('rect')}
                    className="aspect-square border-2 border-dashed border-gray-300 rounded-xl hover:border-pink-500 hover:bg-pink-50 transition flex items-center justify-center"
                  >
                    <div className="w-12 h-12 bg-pink-500 rounded-lg"></div>
                  </button>
                  <button
                    onClick={() => addShape('circle')}
                    className="aspect-square border-2 border-dashed border-gray-300 rounded-xl hover:border-pink-500 hover:bg-pink-50 transition flex items-center justify-center"
                  >
                    <div className="w-12 h-12 bg-pink-500 rounded-full"></div>
                  </button>
                </div>
              </div>
            )}
            
            {/* Layers Tab */}
            {activeTab === 'layers' && (
              <div className="space-y-4">
                <p className="text-sm text-gray-600">Quáº£n lÃ½ cÃ¡c lá»›p trong thiáº¿t káº¿</p>
                {fabricRef.current?.getObjects().filter(obj => 
                  (obj as any).name !== 'safeArea' && (obj as any).name !== 'phoneLabel'
                ).map((obj, index) => (
                  <div
                    key={index}
                    className={`flex items-center gap-3 p-3 rounded-lg border cursor-pointer transition ${
                      selectedObject === obj ? 'border-pink-500 bg-pink-50' : 'hover:bg-gray-50'
                    }`}
                    onClick={() => {
                      fabricRef.current?.setActiveObject(obj);
                      fabricRef.current?.renderAll();
                      setSelectedObject(obj);
                    }}
                  >
                    <div className="w-10 h-10 bg-gray-200 rounded flex items-center justify-center">
                      {obj.type === 'image' ? (
                        <ImageIcon className="w-5 h-5 text-gray-500" />
                      ) : obj.type === 'i-text' || obj.type === 'text' ? (
                        <Type className="w-5 h-5 text-gray-500" />
                      ) : (
                        <Palette className="w-5 h-5 text-gray-500" />
                      )}
                    </div>
                    <div className="flex-1 min-w-0">
                      <p className="text-sm font-medium text-gray-900 truncate">
                        {obj.type === 'i-text' || obj.type === 'text' 
                          ? (obj as any).text?.substring(0, 20) || 'Text'
                          : obj.type === 'image' 
                            ? 'HÃ¬nh áº£nh'
                            : obj.type === 'rect'
                              ? 'HÃ¬nh chá»¯ nháº­t'
                              : 'HÃ¬nh trÃ²n'
                        }
                      </p>
                      <p className="text-xs text-gray-500">{obj.type}</p>
                    </div>
                  </div>
                ))}
                
                {fabricRef.current?.getObjects().filter(obj => 
                  (obj as any).name !== 'safeArea' && (obj as any).name !== 'phoneLabel'
                ).length === 0 && (
                  <p className="text-center text-gray-400 py-8">
                    ChÆ°a cÃ³ layer nÃ o. HÃ£y thÃªm áº£nh hoáº·c chá»¯!
                  </p>
                )}
              </div>
            )}
          </div>
          
          {/* Guest Info Form (if not logged in) */}
          {!isAuthenticated && (
            <div className="p-4 border-t bg-gray-50">
              <h3 className="font-semibold text-gray-900 mb-3">ThÃ´ng tin liÃªn há»‡</h3>
              <div className="space-y-3">
                <input
                  type="text"
                  placeholder="Há» vÃ  tÃªn *"
                  value={guestInfo.name}
                  onChange={(e) => setGuestInfo(prev => ({ ...prev, name: e.target.value }))}
                  className="w-full px-3 py-2 border rounded-lg text-sm"
                />
                <input
                  type="email"
                  placeholder="Email *"
                  value={guestInfo.email}
                  onChange={(e) => setGuestInfo(prev => ({ ...prev, email: e.target.value }))}
                  className="w-full px-3 py-2 border rounded-lg text-sm"
                />
                <input
                  type="tel"
                  placeholder="Sá»‘ Ä‘iá»‡n thoáº¡i *"
                  value={guestInfo.phone}
                  onChange={(e) => setGuestInfo(prev => ({ ...prev, phone: e.target.value }))}
                  className="w-full px-3 py-2 border rounded-lg text-sm"
                />
              </div>
            </div>
          )}
        </aside>
        
        {/* Canvas Area */}
        <main 
          ref={containerRef}
          className="flex-1 overflow-auto bg-gray-200 flex items-center justify-center p-8"
        >
          <div className="bg-white rounded-2xl shadow-2xl p-4">
            <canvas ref={canvasRef} />
          </div>
        </main>
        
        {/* Right Sidebar - Object Properties */}
        {selectedObject && (
          <aside className="w-64 bg-white shadow-lg overflow-y-auto">
            <div className="p-4 border-b">
              <h3 className="font-semibold text-gray-900">Chá»‰nh sá»­a Ä‘á»‘i tÆ°á»£ng</h3>
            </div>
            
            <div className="p-4 space-y-4">
              {/* Transform */}
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">Xoay</label>
                <div className="flex gap-2">
                  <button
                    onClick={() => rotateObject(-15)}
                    className="flex-1 py-2 border rounded-lg hover:bg-gray-100 transition"
                  >
                    <RotateCcw className="w-4 h-4 mx-auto" />
                  </button>
                  <button
                    onClick={() => rotateObject(15)}
                    className="flex-1 py-2 border rounded-lg hover:bg-gray-100 transition"
                  >
                    <RotateCw className="w-4 h-4 mx-auto" />
                  </button>
                </div>
              </div>
              
              {/* Flip */}
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">Láº­t</label>
                <div className="flex gap-2">
                  <button
                    onClick={() => flipObject('horizontal')}
                    className="flex-1 py-2 border rounded-lg hover:bg-gray-100 transition"
                  >
                    <FlipHorizontal className="w-4 h-4 mx-auto" />
                  </button>
                  <button
                    onClick={() => flipObject('vertical')}
                    className="flex-1 py-2 border rounded-lg hover:bg-gray-100 transition"
                  >
                    <FlipVertical className="w-4 h-4 mx-auto" />
                  </button>
                </div>
              </div>
              
              {/* Layer order */}
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">Thá»© tá»± lá»›p</label>
                <div className="flex gap-2">
                  <button
                    onClick={() => changeLayer('front')}
                    className="flex-1 py-2 border rounded-lg hover:bg-gray-100 transition text-xs"
                  >
                    ÄÆ°a lÃªn trÃªn
                  </button>
                  <button
                    onClick={() => changeLayer('back')}
                    className="flex-1 py-2 border rounded-lg hover:bg-gray-100 transition text-xs"
                  >
                    ÄÆ°a xuá»‘ng dÆ°á»›i
                  </button>
                </div>
              </div>
              
              {/* Actions */}
              <div className="flex gap-2">
                <button
                  onClick={duplicateObject}
                  className="flex-1 py-2 border rounded-lg hover:bg-gray-100 transition"
                  title="NhÃ¢n Ä‘Ã´i"
                >
                  <Copy className="w-4 h-4 mx-auto" />
                </button>
                <button
                  onClick={deleteSelected}
                  className="flex-1 py-2 border border-red-300 text-red-600 rounded-lg hover:bg-red-50 transition"
                  title="XÃ³a"
                >
                  <Trash2 className="w-4 h-4 mx-auto" />
                </button>
              </div>
              
              {/* Color picker for shapes */}
              {(selectedObject.type === 'rect' || selectedObject.type === 'circle') && (
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">MÃ u sáº¯c</label>
                  <input
                    type="color"
                    value={selectedObject.fill || '#e91e63'}
                    onChange={(e) => {
                      selectedObject.set('fill', e.target.value);
                      fabricRef.current?.renderAll();
                      saveToHistory();
                    }}
                    className="w-full h-10 border rounded-lg cursor-pointer"
                  />
                </div>
              )}
              
              {/* Text editing */}
              {(selectedObject.type === 'i-text' || selectedObject.type === 'text') && (
                <>
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">MÃ u chá»¯</label>
                    <input
                      type="color"
                      value={selectedObject.fill || '#000000'}
                      onChange={(e) => {
                        selectedObject.set('fill', e.target.value);
                        fabricRef.current?.renderAll();
                        saveToHistory();
                      }}
                      className="w-full h-10 border rounded-lg cursor-pointer"
                    />
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">Cá»¡ chá»¯</label>
                    <input
                      type="number"
                      value={selectedObject.fontSize || 40}
                      onChange={(e) => {
                        selectedObject.set('fontSize', parseInt(e.target.value) || 40);
                        fabricRef.current?.renderAll();
                        saveToHistory();
                      }}
                      className="w-full px-3 py-2 border rounded-lg"
                      min={10}
                      max={200}
                    />
                  </div>
                </>
              )}
            </div>
          </aside>
        )}
      </div>
    </div>
  );
}




################################################################################
## FILE 125: page.tsx
## Path: fontend/src/app/gift/claim/[giftId]/page.tsx
################################################################################

'use client';

import { useState, useEffect } from 'react';
import { useParams, useRouter } from 'next/navigation';
import Link from 'next/link';
import { getGiftInfo, verifyGift, claimGift } from '@/lib/api-client';
import { 
  Gift, CheckCircle, AlertCircle, Loader2, PartyPopper, 
  Lock, MapPin, Phone, ArrowRight, Clock, User, Mail 
} from 'lucide-react';
import TopBanner from '@/components/layout/TopBanner';
import Header from '@/components/layout/Header';
import Footer from '@/components/layout/Footer';

type GiftStatus = 'pending' | 'verified' | 'claimed' | 'expired';

export default function ClaimGiftPage() {
  const params = useParams();
  const router = useRouter();
  const giftId = params.giftId as string;

  const [gift, setGift] = useState<any>(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState('');
  
  // Verification
  const [verificationCode, setVerificationCode] = useState('');
  const [verifying, setVerifying] = useState(false);
  const [verified, setVerified] = useState(false);

  // Claim form
  const [claimData, setClaimData] = useState({
    address: '',
    phone: '',
  });
  const [claiming, setClaiming] = useState(false);
  const [claimed, setClaimed] = useState(false);
  const [orderId, setOrderId] = useState<number | null>(null);

  // Load gift info
  useEffect(() => {
    if (giftId) {
      loadGift();
    }
  }, [giftId]);

  const loadGift = async () => {
    try {
      setLoading(true);
      const data = await getGiftInfo(giftId);
      setGift(data);
      
      // Check status
      if (data.status === 'verified') {
        setVerified(true);
      } else if (data.status === 'claimed') {
        setClaimed(true);
      }
    } catch (err: any) {
      console.error('Load gift error:', err);
      setError('KhÃ´ng tÃ¬m tháº¥y quÃ  táº·ng hoáº·c Ä‘Ã£ háº¿t háº¡n');
    } finally {
      setLoading(false);
    }
  };

  const handleVerify = async (e: React.FormEvent) => {
    e.preventDefault();
    setError('');

    if (verificationCode.length !== 6) {
      setError('MÃ£ xÃ¡c nháº­n pháº£i cÃ³ 6 chá»¯ sá»‘');
      return;
    }

    try {
      setVerifying(true);
      await verifyGift(giftId, verificationCode);
      setVerified(true);
    } catch (err: any) {
      setError(err.response?.data?.message || 'MÃ£ xÃ¡c nháº­n khÃ´ng Ä‘Ãºng');
    } finally {
      setVerifying(false);
    }
  };

  const handleClaim = async (e: React.FormEvent) => {
    e.preventDefault();
    setError('');

    if (!claimData.address || !claimData.phone) {
      setError('Vui lÃ²ng nháº­p Ä‘á»‹a chá»‰ vÃ  sá»‘ Ä‘iá»‡n thoáº¡i');
      return;
    }

    try {
      setClaiming(true);
      const result = await claimGift(giftId, claimData.address, claimData.phone);
      setClaimed(true);
      setOrderId(result.orderId);
    } catch (err: any) {
      setError(err.response?.data?.message || 'CÃ³ lá»—i xáº£y ra');
    } finally {
      setClaiming(false);
    }
  };

  const getProductImage = () => {
    if (!gift?.products) return '';
    const product = gift.products;
    return product.image_url ||
      product.product_images?.find((img: any) => img.is_primary)?.image_url ||
      product.product_images?.[0]?.image_url ||
      '';
  };

  const isExpired = gift && new Date(gift.expires_at) < new Date();

  // Loading
  if (loading) {
    return (
      <div className="min-h-screen bg-gradient-to-b from-pink-50 to-white flex items-center justify-center">
        <Loader2 className="w-12 h-12 animate-spin text-pink-600" />
      </div>
    );
  }

  // Error - Gift not found
  if (error && !gift) {
    return (
      <div className="min-h-screen bg-gradient-to-b from-pink-50 to-white">
        <TopBanner />
        <Header />
        <div className="max-w-xl mx-auto px-4 py-20 text-center">
          <div className="bg-white rounded-3xl shadow-xl p-8">
            <AlertCircle className="w-16 h-16 text-red-500 mx-auto mb-4" />
            <h1 className="text-2xl font-bold text-gray-900 mb-4">KhÃ´ng TÃ¬m Tháº¥y QuÃ  Táº·ng</h1>
            <p className="text-gray-600 mb-6">{error}</p>
            <Link
              href="/"
              className="inline-block bg-pink-600 text-white px-6 py-3 rounded-full font-semibold"
            >
              Vá» Trang Chá»§
            </Link>
          </div>
        </div>
        <Footer />
      </div>
    );
  }

  // Success - Claimed
  if (claimed) {
    return (
      <div className="min-h-screen bg-gradient-to-b from-green-50 to-white">
        <TopBanner />
        <Header />
        <div className="max-w-xl mx-auto px-4 py-20 text-center">
          <div className="bg-white rounded-3xl shadow-xl p-8">
            <div className="w-24 h-24 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-6">
              <PartyPopper className="w-12 h-12 text-green-600" />
            </div>
            <h1 className="text-3xl font-bold text-gray-900 mb-4">
              ðŸŽ‰ ChÃºc Má»«ng!
            </h1>
            <p className="text-xl text-gray-600 mb-2">
              Báº¡n Ä‘Ã£ nháº­n quÃ  thÃ nh cÃ´ng!
            </p>
            {orderId && (
              <p className="text-gray-500 mb-6">
                MÃ£ Ä‘Æ¡n hÃ ng: <strong>#{orderId}</strong>
              </p>
            )}

            <div className="bg-green-50 rounded-2xl p-6 mb-6">
              <div className="flex items-center gap-4 justify-center">
                {getProductImage() && (
                  <img
                    src={getProductImage()}
                    alt={gift.products.product_name}
                    className="w-20 h-20 rounded-xl object-cover"
                  />
                )}
                <div className="text-left">
                  <h3 className="font-bold text-gray-900">{gift.products.product_name}</h3>
                  <p className="text-green-600 font-semibold">MIá»„N PHÃ</p>
                </div>
              </div>
            </div>

            <p className="text-gray-500 mb-6">
              ÄÆ¡n hÃ ng sáº½ Ä‘Æ°á»£c giao Ä‘áº¿n Ä‘á»‹a chá»‰ báº¡n Ä‘Ã£ cung cáº¥p trong 2-3 ngÃ y lÃ m viá»‡c.
            </p>

            <Link
              href="/shop"
              className="inline-flex items-center gap-2 bg-pink-600 text-white px-6 py-3 rounded-full font-semibold hover:bg-pink-700 transition"
            >
              KhÃ¡m PhÃ¡ ThÃªm Sáº£n Pháº©m
              <ArrowRight className="w-5 h-5" />
            </Link>
          </div>
        </div>
        <Footer />
      </div>
    );
  }

  // Already claimed
  if (gift?.status === 'claimed') {
    return (
      <div className="min-h-screen bg-gradient-to-b from-gray-50 to-white">
        <TopBanner />
        <Header />
        <div className="max-w-xl mx-auto px-4 py-20 text-center">
          <div className="bg-white rounded-3xl shadow-xl p-8">
            <CheckCircle className="w-16 h-16 text-green-500 mx-auto mb-4" />
            <h1 className="text-2xl font-bold text-gray-900 mb-4">QuÃ  ÄÃ£ ÄÆ°á»£c Nháº­n</h1>
            <p className="text-gray-600 mb-6">QuÃ  táº·ng nÃ y Ä‘Ã£ Ä‘Æ°á»£c nháº­n trÆ°á»›c Ä‘Ã³.</p>
            <Link
              href="/shop"
              className="inline-block bg-pink-600 text-white px-6 py-3 rounded-full font-semibold"
            >
              Mua Sáº¯m
            </Link>
          </div>
        </div>
        <Footer />
      </div>
    );
  }

  // Expired
  if (isExpired) {
    return (
      <div className="min-h-screen bg-gradient-to-b from-gray-50 to-white">
        <TopBanner />
        <Header />
        <div className="max-w-xl mx-auto px-4 py-20 text-center">
          <div className="bg-white rounded-3xl shadow-xl p-8">
            <Clock className="w-16 h-16 text-gray-400 mx-auto mb-4" />
            <h1 className="text-2xl font-bold text-gray-900 mb-4">QuÃ  ÄÃ£ Háº¿t Háº¡n</h1>
            <p className="text-gray-600 mb-6">
              Ráº¥t tiáº¿c, quÃ  táº·ng nÃ y Ä‘Ã£ háº¿t háº¡n vÃ o {new Date(gift.expires_at).toLocaleDateString('vi-VN')}.
            </p>
            <Link
              href="/shop"
              className="inline-block bg-pink-600 text-white px-6 py-3 rounded-full font-semibold"
            >
              KhÃ¡m PhÃ¡ Shop
            </Link>
          </div>
        </div>
        <Footer />
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-gradient-to-b from-pink-50 to-white">
      <TopBanner />
      <Header />

      <div className="max-w-4xl mx-auto px-4 py-12">
        {/* Gift Card */}
        <div className="bg-white rounded-3xl shadow-xl overflow-hidden">
          {/* Header */}
          <div className="bg-gradient-to-r from-pink-500 via-rose-500 to-red-500 p-8 text-white text-center">
            <div className="text-6xl mb-4">ðŸŽ</div>
            <h1 className="text-3xl font-bold mb-2">Báº¡n CÃ³ QuÃ  Táº·ng!</h1>
            <p className="opacity-90">Tá»« {gift.sender_name}</p>
          </div>

          <div className="p-8">
            {/* Sender message */}
            {gift.sender_message && (
              <div className="bg-gradient-to-r from-pink-50 to-rose-50 rounded-2xl p-6 mb-8">
                <p className="text-lg text-gray-700 italic text-center">
                  "{gift.sender_message}"
                </p>
                <p className="text-right text-pink-600 mt-2 font-semibold">
                  â€” {gift.sender_name}
                </p>
              </div>
            )}

            {/* Product */}
            <div className="flex flex-col sm:flex-row gap-6 items-center bg-gray-50 rounded-2xl p-6 mb-8">
              <div className="w-40 h-40 bg-white rounded-2xl overflow-hidden shadow flex-shrink-0">
                {getProductImage() ? (
                  <img
                    src={getProductImage()}
                    alt={gift.products?.product_name}
                    className="w-full h-full object-cover"
                  />
                ) : (
                  <div className="w-full h-full flex items-center justify-center text-gray-300">
                    <Gift className="w-16 h-16" />
                  </div>
                )}
              </div>
              <div className="text-center sm:text-left">
                <h2 className="text-2xl font-bold text-gray-900 mb-2">
                  {gift.products?.product_name}
                </h2>
                <p className="text-3xl font-bold text-pink-600">
                  {(gift.products?.sale_price || gift.products?.price)?.toLocaleString('vi-VN')}â‚«
                </p>
                <p className="text-green-600 font-semibold mt-2">ðŸŽ‰ MIá»„N PHÃ CHO Báº N!</p>
              </div>
            </div>

            {/* Expiry warning */}
            <div className="flex items-center gap-2 bg-amber-50 text-amber-700 px-4 py-3 rounded-xl mb-8">
              <Clock className="w-5 h-5 flex-shrink-0" />
              <p>
                QuÃ  cÃ³ hiá»‡u lá»±c Ä‘áº¿n: <strong>{new Date(gift.expires_at).toLocaleDateString('vi-VN')}</strong>
              </p>
            </div>

            {/* Error */}
            {error && (
              <div className="flex items-center gap-2 bg-red-50 text-red-600 px-4 py-3 rounded-xl mb-6">
                <AlertCircle className="w-5 h-5 flex-shrink-0" />
                <p>{error}</p>
              </div>
            )}

            {/* Step 1: Verify */}
            {!verified && (
              <div className="border-2 border-pink-200 rounded-2xl p-6">
                <h3 className="text-xl font-bold text-gray-900 mb-4 flex items-center gap-2">
                  <Lock className="w-6 h-6 text-pink-500" />
                  BÆ°á»›c 1: Nháº­p MÃ£ XÃ¡c Nháº­n
                </h3>
                <p className="text-gray-600 mb-4">
                  MÃ£ xÃ¡c nháº­n 6 sá»‘ Ä‘Ã£ Ä‘Æ°á»£c gá»­i trong email. Vui lÃ²ng kiá»ƒm tra há»™p thÆ°.
                </p>
                <form onSubmit={handleVerify} className="flex flex-col sm:flex-row gap-4">
                  <input
                    type="text"
                    maxLength={6}
                    value={verificationCode}
                    onChange={(e) => setVerificationCode(e.target.value.replace(/\D/g, ''))}
                    className="flex-1 px-6 py-4 text-center text-2xl tracking-widest border-2 border-gray-300 rounded-xl focus:ring-2 focus:ring-pink-500 focus:border-transparent"
                    placeholder="000000"
                  />
                  <button
                    type="submit"
                    disabled={verifying || verificationCode.length !== 6}
                    className="px-8 py-4 bg-pink-600 text-white font-bold rounded-xl hover:bg-pink-700 transition disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2"
                  >
                    {verifying ? (
                      <Loader2 className="w-5 h-5 animate-spin" />
                    ) : (
                      <>
                        <CheckCircle className="w-5 h-5" />
                        XÃ¡c Nháº­n
                      </>
                    )}
                  </button>
                </form>
              </div>
            )}

            {/* Step 2: Claim */}
            {verified && !claimed && (
              <div className="border-2 border-green-200 rounded-2xl p-6">
                <div className="flex items-center gap-2 text-green-600 mb-4">
                  <CheckCircle className="w-6 h-6" />
                  <span className="font-semibold">XÃ¡c nháº­n thÃ nh cÃ´ng!</span>
                </div>

                <h3 className="text-xl font-bold text-gray-900 mb-4 flex items-center gap-2">
                  <MapPin className="w-6 h-6 text-pink-500" />
                  BÆ°á»›c 2: Nháº­p Äá»‹a Chá»‰ Nháº­n QuÃ 
                </h3>

                <form onSubmit={handleClaim} className="space-y-4">
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">
                      Sá»‘ Ä‘iá»‡n thoáº¡i <span className="text-red-500">*</span>
                    </label>
                    <div className="relative">
                      <Phone className="absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400" />
                      <input
                        type="tel"
                        value={claimData.phone}
                        onChange={(e) => setClaimData({ ...claimData, phone: e.target.value })}
                        className="w-full pl-12 pr-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-pink-500 focus:border-transparent"
                        placeholder="0901234567"
                        required
                      />
                    </div>
                  </div>

                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">
                      Äá»‹a chá»‰ nháº­n hÃ ng <span className="text-red-500">*</span>
                    </label>
                    <div className="relative">
                      <MapPin className="absolute left-4 top-4 w-5 h-5 text-gray-400" />
                      <textarea
                        value={claimData.address}
                        onChange={(e) => setClaimData({ ...claimData, address: e.target.value })}
                        rows={3}
                        className="w-full pl-12 pr-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-pink-500 focus:border-transparent resize-none"
                        placeholder="Sá»‘ nhÃ , Ä‘Æ°á»ng, phÆ°á»ng/xÃ£, quáº­n/huyá»‡n, tá»‰nh/thÃ nh phá»‘"
                        required
                      />
                    </div>
                  </div>

                  <button
                    type="submit"
                    disabled={claiming}
                    className="w-full py-4 bg-gradient-to-r from-green-500 to-emerald-500 text-white font-bold rounded-xl hover:from-green-600 hover:to-emerald-600 transition disabled:opacity-50 flex items-center justify-center gap-2"
                  >
                    {claiming ? (
                      <Loader2 className="w-5 h-5 animate-spin" />
                    ) : (
                      <>
                        <Gift className="w-5 h-5" />
                        Nháº­n QuÃ  Ngay
                      </>
                    )}
                  </button>
                </form>
              </div>
            )}
          </div>
        </div>
      </div>

      <Footer />
    </div>
  );
}




################################################################################
## FILE 126: page.tsx
## Path: fontend/src/app/gift/send/page.tsx
################################################################################

'use client';

import { useState, useEffect } from 'react';
import { useSearchParams, useRouter } from 'next/navigation';
import Link from 'next/link';
import { fetchProductById, sendGift, SendGiftData } from '@/lib/api-client';
import { Gift, Heart, ArrowLeft, Send, Loader2, CheckCircle, AlertCircle, Sparkles } from 'lucide-react';
import TopBanner from '@/components/layout/TopBanner';
import Header from '@/components/layout/Header';
import Footer from '@/components/layout/Footer';

export default function SendGiftPage() {
  const router = useRouter();
  const searchParams = useSearchParams();
  const productId = searchParams.get('productId');

  const [product, setProduct] = useState<any>(null);
  const [loading, setLoading] = useState(true);
  const [sending, setSending] = useState(false);
  const [success, setSuccess] = useState(false);
  const [error, setError] = useState('');

  // Form state
  const [formData, setFormData] = useState({
    senderName: '',
    senderEmail: '',
    senderMessage: '',
    recipientName: '',
    recipientEmail: '',
    recipientPhone: '',
  });

  // Load product
  useEffect(() => {
    if (productId) {
      loadProduct(parseInt(productId));
    } else {
      setLoading(false);
    }
  }, [productId]);

  const loadProduct = async (id: number) => {
    try {
      const data = await fetchProductById(id);
      setProduct(data);
    } catch (err) {
      console.error('Error loading product:', err);
    } finally {
      setLoading(false);
    }
  };

  const handleChange = (e: React.ChangeEvent<HTMLInputElement | HTMLTextAreaElement>) => {
    setFormData({ ...formData, [e.target.name]: e.target.value });
  };

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    setError('');

    // Validate
    if (!formData.senderName || !formData.senderEmail || !formData.recipientName || !formData.recipientEmail) {
      setError('Vui lÃ²ng Ä‘iá»n Ä‘áº§y Ä‘á»§ thÃ´ng tin báº¯t buá»™c');
      return;
    }

    if (!productId) {
      setError('Vui lÃ²ng chá»n sáº£n pháº©m Ä‘á»ƒ gá»­i táº·ng');
      return;
    }

    try {
      setSending(true);
      
      const giftData: SendGiftData = {
        ...formData,
        productId: parseInt(productId),
        quantity: 1,
      };

      await sendGift(giftData);
      setSuccess(true);
    } catch (err: any) {
      console.error('Send gift error:', err);
      setError(err.response?.data?.message || 'CÃ³ lá»—i xáº£y ra khi gá»­i quÃ ');
    } finally {
      setSending(false);
    }
  };

  const getProductImage = () => {
    if (!product) return '';
    return product.image_url || 
      product.product_images?.find((img: any) => img.is_primary)?.image_url ||
      product.product_images?.[0]?.image_url ||
      '';
  };

  // Success screen
  if (success) {
    return (
      <div className="min-h-screen bg-gradient-to-b from-pink-50 to-white">
        <TopBanner />
        <Header />
        
        <div className="max-w-2xl mx-auto px-4 py-20">
          <div className="bg-white rounded-3xl shadow-xl p-8 text-center">
            <div className="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-6">
              <CheckCircle className="w-10 h-10 text-green-600" />
            </div>
            
            <h1 className="text-3xl font-bold text-gray-900 mb-4">
              ðŸŽ QuÃ  Táº·ng ÄÃ£ ÄÆ°á»£c Gá»­i!
            </h1>
            
            <p className="text-gray-600 mb-8">
              Email thÃ´ng bÃ¡o Ä‘Ã£ Ä‘Æ°á»£c gá»­i Ä‘áº¿n <strong>{formData.recipientEmail}</strong>. 
              NgÆ°á»i nháº­n sáº½ nháº­n Ä‘Æ°á»£c mÃ£ xÃ¡c nháº­n Ä‘á»ƒ nháº­n quÃ .
            </p>

            <div className="bg-pink-50 rounded-2xl p-6 mb-8">
              <p className="text-pink-800">
                ðŸ’Œ Tin nháº¯n cá»§a báº¡n: <em>"{formData.senderMessage || 'ChÃºc báº¡n vui váº»!'}"</em>
              </p>
            </div>

            <div className="flex flex-col sm:flex-row gap-4 justify-center">
              <Link
                href="/shop"
                className="px-6 py-3 bg-pink-600 text-white rounded-full font-semibold hover:bg-pink-700 transition"
              >
                Tiáº¿p Tá»¥c Mua Sáº¯m
              </Link>
              <button
                onClick={() => {
                  setSuccess(false);
                  setFormData({
                    senderName: '',
                    senderEmail: '',
                    senderMessage: '',
                    recipientName: '',
                    recipientEmail: '',
                    recipientPhone: '',
                  });
                }}
                className="px-6 py-3 border-2 border-pink-600 text-pink-600 rounded-full font-semibold hover:bg-pink-50 transition"
              >
                Gá»­i QuÃ  KhÃ¡c
              </button>
            </div>
          </div>
        </div>

        <Footer />
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-gradient-to-b from-pink-50 to-white">
      <TopBanner />
      <Header />

      <div className="max-w-6xl mx-auto px-4 py-8">
        {/* Back button */}
        <button
          onClick={() => router.back()}
          className="flex items-center gap-2 text-gray-600 hover:text-pink-600 mb-6 transition"
        >
          <ArrowLeft className="w-5 h-5" />
          Quay láº¡i
        </button>

        {/* Title */}
        <div className="text-center mb-10">
          <div className="inline-flex items-center gap-2 bg-pink-100 text-pink-700 px-4 py-2 rounded-full mb-4">
            <Gift className="w-5 h-5" />
            <span className="font-semibold">Gá»­i QuÃ  Táº·ng</span>
          </div>
          <h1 className="text-3xl md:text-4xl font-bold text-gray-900 mb-3">
            Táº·ng QuÃ  Cho NgÆ°á»i ThÃ¢n YÃªu
          </h1>
          <p className="text-gray-600 max-w-xl mx-auto">
            Chá»n sáº£n pháº©m, Ä‘iá»n thÃ´ng tin ngÆ°á»i nháº­n vÃ  gá»­i yÃªu thÆ°Æ¡ng qua email
          </p>
        </div>

        <div className="grid lg:grid-cols-2 gap-8">
          {/* Product Preview */}
          <div className="bg-white rounded-3xl shadow-lg p-6">
            <h2 className="text-xl font-bold text-gray-900 mb-6 flex items-center gap-2">
              <Sparkles className="w-5 h-5 text-pink-500" />
              Sáº£n Pháº©m Táº·ng
            </h2>

            {loading ? (
              <div className="flex items-center justify-center h-64">
                <Loader2 className="w-8 h-8 animate-spin text-pink-600" />
              </div>
            ) : product ? (
              <div className="flex gap-6">
                <div className="w-40 h-40 bg-gray-100 rounded-2xl overflow-hidden flex-shrink-0">
                  {getProductImage() ? (
                    <img
                      src={getProductImage()}
                      alt={product.product_name}
                      className="w-full h-full object-cover"
                    />
                  ) : (
                    <div className="w-full h-full flex items-center justify-center text-gray-400">
                      <Gift className="w-12 h-12" />
                    </div>
                  )}
                </div>
                <div className="flex-1">
                  <h3 className="font-bold text-lg text-gray-900 mb-2">
                    {product.product_name}
                  </h3>
                  <p className="text-gray-500 text-sm mb-4 line-clamp-2">
                    {product.description}
                  </p>
                  <div className="flex items-center gap-3">
                    <span className="text-2xl font-bold text-pink-600">
                      {(product.sale_price || product.price).toLocaleString('vi-VN')}â‚«
                    </span>
                    {product.sale_price && product.sale_price < product.price && (
                      <span className="text-gray-400 line-through">
                        {product.price.toLocaleString('vi-VN')}â‚«
                      </span>
                    )}
                  </div>
                </div>
              </div>
            ) : (
              <div className="text-center py-12">
                <Gift className="w-16 h-16 text-gray-300 mx-auto mb-4" />
                <p className="text-gray-500 mb-4">ChÆ°a chá»n sáº£n pháº©m</p>
                <Link
                  href="/shop"
                  className="inline-block bg-pink-600 text-white px-6 py-2 rounded-full font-semibold hover:bg-pink-700 transition"
                >
                  Chá»n Sáº£n Pháº©m
                </Link>
              </div>
            )}

            {/* Gift message preview */}
            {formData.senderMessage && (
              <div className="mt-6 bg-gradient-to-r from-pink-50 to-rose-50 rounded-2xl p-6">
                <p className="text-sm text-pink-600 font-semibold mb-2">ðŸ’Œ Lá»i nháº¯n cá»§a báº¡n:</p>
                <p className="text-gray-700 italic">"{formData.senderMessage}"</p>
                <p className="text-right text-pink-600 mt-2">â€” {formData.senderName || 'NgÆ°á»i gá»­i'}</p>
              </div>
            )}
          </div>

          {/* Form */}
          <div className="bg-white rounded-3xl shadow-lg p-6">
            <form onSubmit={handleSubmit} className="space-y-6">
              {/* Sender Info */}
              <div>
                <h3 className="text-lg font-bold text-gray-900 mb-4 flex items-center gap-2">
                  <Heart className="w-5 h-5 text-pink-500" />
                  ThÃ´ng Tin NgÆ°á»i Gá»­i
                </h3>
                <div className="grid sm:grid-cols-2 gap-4">
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">
                      TÃªn cá»§a báº¡n <span className="text-red-500">*</span>
                    </label>
                    <input
                      type="text"
                      name="senderName"
                      value={formData.senderName}
                      onChange={handleChange}
                      className="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-pink-500 focus:border-transparent transition"
                      placeholder="Nguyá»…n VÄƒn A"
                      required
                    />
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">
                      Email cá»§a báº¡n <span className="text-red-500">*</span>
                    </label>
                    <input
                      type="email"
                      name="senderEmail"
                      value={formData.senderEmail}
                      onChange={handleChange}
                      className="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-pink-500 focus:border-transparent transition"
                      placeholder="email@example.com"
                      required
                    />
                  </div>
                </div>
              </div>

              {/* Message */}
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">
                  Lá»i nháº¯n gá»­i kÃ¨m
                </label>
                <textarea
                  name="senderMessage"
                  value={formData.senderMessage}
                  onChange={handleChange}
                  rows={3}
                  className="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-pink-500 focus:border-transparent transition resize-none"
                  placeholder="ChÃºc má»«ng sinh nháº­t! Hy vá»ng báº¡n sáº½ thÃ­ch mÃ³n quÃ  nÃ y..."
                />
              </div>

              {/* Recipient Info */}
              <div>
                <h3 className="text-lg font-bold text-gray-900 mb-4 flex items-center gap-2">
                  <Gift className="w-5 h-5 text-pink-500" />
                  ThÃ´ng Tin NgÆ°á»i Nháº­n
                </h3>
                <div className="space-y-4">
                  <div className="grid sm:grid-cols-2 gap-4">
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">
                        TÃªn ngÆ°á»i nháº­n <span className="text-red-500">*</span>
                      </label>
                      <input
                        type="text"
                        name="recipientName"
                        value={formData.recipientName}
                        onChange={handleChange}
                        className="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-pink-500 focus:border-transparent transition"
                        placeholder="Tráº§n Thá»‹ B"
                        required
                      />
                    </div>
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">
                        Sá»‘ Ä‘iá»‡n thoáº¡i
                      </label>
                      <input
                        type="tel"
                        name="recipientPhone"
                        value={formData.recipientPhone}
                        onChange={handleChange}
                        className="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-pink-500 focus:border-transparent transition"
                        placeholder="0901234567"
                      />
                    </div>
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">
                      Email ngÆ°á»i nháº­n <span className="text-red-500">*</span>
                    </label>
                    <input
                      type="email"
                      name="recipientEmail"
                      value={formData.recipientEmail}
                      onChange={handleChange}
                      className="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-pink-500 focus:border-transparent transition"
                      placeholder="nguoinhan@example.com"
                      required
                    />
                    <p className="text-xs text-gray-500 mt-1">
                      ðŸ“§ Email xÃ¡c nháº­n sáº½ Ä‘Æ°á»£c gá»­i Ä‘áº¿n Ä‘á»‹a chá»‰ nÃ y
                    </p>
                  </div>
                </div>
              </div>

              {/* Error */}
              {error && (
                <div className="flex items-center gap-2 bg-red-50 text-red-600 px-4 py-3 rounded-xl">
                  <AlertCircle className="w-5 h-5 flex-shrink-0" />
                  <p>{error}</p>
                </div>
              )}

              {/* Submit */}
              <button
                type="submit"
                disabled={sending || !product}
                className="w-full py-4 bg-gradient-to-r from-pink-500 to-rose-500 text-white font-bold rounded-xl hover:from-pink-600 hover:to-rose-600 transition disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2"
              >
                {sending ? (
                  <>
                    <Loader2 className="w-5 h-5 animate-spin" />
                    Äang gá»­i...
                  </>
                ) : (
                  <>
                    <Send className="w-5 h-5" />
                    Gá»­i QuÃ  Táº·ng
                  </>
                )}
              </button>

              <p className="text-center text-sm text-gray-500">
                ðŸ”’ ThÃ´ng tin cá»§a báº¡n Ä‘Æ°á»£c báº£o máº­t an toÃ n
              </p>
            </form>
          </div>
        </div>
      </div>

      <Footer />
    </div>
  );
}




################################################################################
## FILE 127: page.tsx
## Path: fontend/src/app/product/[id]/page.tsx
################################################################################

'use client';

import React, { useState, useEffect } from 'react';
import { useParams, useRouter } from 'next/navigation';
import Link from 'next/link';
import { 
  Star, Heart, ShoppingCart, Minus, Plus, 
  Truck, Shield, RotateCcw, Check, ChevronRight, Gift,
  Smartphone, ChevronDown, Search
} from 'lucide-react';
import { fetchProductById, addToShoppingCart, fetchCompatiblePhoneModels, fetchAllPhoneModels } from '@/lib/api-client';
import TopBanner from '@/components/layout/TopBanner';
import Header from '@/components/layout/Header';
import Footer from '@/components/layout/Footer';
import { useWishlist } from '@/app/context/wishlist-context';
import { useCart } from '@/app/context/cart-context';

interface PhoneModel {
  model_id: number;
  brand_name: string;
  model_name: string;
  model_code?: string;
  release_year?: number;
  is_popular?: boolean;
}

export default function ProductDetailPage() {
  const params = useParams();
  const router = useRouter();
  const productId = params.id as string;
  const { wishedProducts, toggleWishlist } = useWishlist();
  const { refreshCart, increaseCart } = useCart();

  const [product, setProduct] = useState<any>(null);
  const [loading, setLoading] = useState(true);
  const [selectedImage, setSelectedImage] = useState(0);
  const [quantity, setQuantity] = useState(1);
  const [addingToCart, setAddingToCart] = useState(false);
  
  // Phone model selection states
  const [compatibleModels, setCompatibleModels] = useState<PhoneModel[]>([]);
  const [allPhoneModels, setAllPhoneModels] = useState<{brand: string, models: PhoneModel[]}[]>([]);
  const [selectedPhoneModel, setSelectedPhoneModel] = useState<PhoneModel | null>(null);
  const [showPhoneModelDropdown, setShowPhoneModelDropdown] = useState(false);
  const [phoneModelSearch, setPhoneModelSearch] = useState('');
  const [selectedBrand, setSelectedBrand] = useState<string>('');
  const [loadingModels, setLoadingModels] = useState(false);

  useEffect(() => {
    if (productId) {
      loadProduct();
      loadPhoneModels();
    }
  }, [productId]);

  const loadProduct = async () => {
    try {
      setLoading(true);
      const data = await fetchProductById(parseInt(productId));
      setProduct(data);
    } catch (error) {
      console.error('Error loading product:', error);
    } finally {
      setLoading(false);
    }
  };

  const loadPhoneModels = async () => {
    try {
      setLoadingModels(true);
      // Láº¥y dÃ²ng mÃ¡y tÆ°Æ¡ng thÃ­ch vá»›i sáº£n pháº©m
      const compatibleRes = await fetchCompatiblePhoneModels(parseInt(productId));
      if (compatibleRes.success && compatibleRes.data.length > 0) {
        setCompatibleModels(compatibleRes.data);
      }
      
      // Láº¥y táº¥t cáº£ dÃ²ng mÃ¡y grouped by brand
      const allRes = await fetchAllPhoneModels();
      if (allRes.success) {
        setAllPhoneModels(allRes.data);
      }
    } catch (error) {
      console.error('Error loading phone models:', error);
    } finally {
      setLoadingModels(false);
    }
  };

  // Filter models dá»±a trÃªn search vÃ  brand
  const getFilteredModels = () => {
    let models: PhoneModel[] = [];
    
    // LuÃ´n hiá»‡n Táº¤T Cáº¢ dÃ²ng mÃ¡y tá»« database, khÃ´ng giá»›i háº¡n chá»‰ compatible
    if (allPhoneModels.length > 0) {
      if (selectedBrand) {
        const brandData = allPhoneModels.find(b => b.brand === selectedBrand);
        models = brandData?.models || [];
      } else {
        models = allPhoneModels.flatMap(b => b.models);
      }
    } else if (compatibleModels.length > 0) {
      // Fallback náº¿u allPhoneModels khÃ´ng cÃ³
      if (selectedBrand) {
        models = compatibleModels.filter(m => m.brand_name === selectedBrand);
      } else {
        models = compatibleModels;
      }
    }

    if (phoneModelSearch) {
      const search = phoneModelSearch.toLowerCase();
      models = models.filter(m => 
        m.model_name.toLowerCase().includes(search) ||
        m.brand_name.toLowerCase().includes(search)
      );
    }

    return models;
  };

  const getBrands = () => {
    // LuÃ´n láº¥y táº¥t cáº£ brands tá»« allPhoneModels
    if (allPhoneModels.length > 0) {
      return allPhoneModels.map(b => b.brand);
    }
    // Fallback náº¿u chÆ°a load xong
    if (compatibleModels.length > 0) {
      return [...new Set(compatibleModels.map(m => m.brand_name))];
    }
    return [];
  };

  const handleAddToCart = async (): Promise<boolean> => {
    if (!product) return false;
    
    // Chá»‰ yÃªu cáº§u chá»n dÃ²ng mÃ¡y náº¿u cÃ³ dÃ²ng mÃ¡y trong database
    const hasPhoneModels = compatibleModels.length > 0 || allPhoneModels.length > 0;
    if (hasPhoneModels && !selectedPhoneModel) {
      alert('Vui lÃ²ng chá»n dÃ²ng mÃ¡y Ä‘iá»‡n thoáº¡i!');
      setShowPhoneModelDropdown(true);
      return false;
    }
    
    setAddingToCart(true);
    try {
      // Láº¥y customer tá»« localStorage (Ä‘Ãºng key)
      const customerData = localStorage.getItem('customer');
      if (!customerData) {
        router.push('/login?redirect=' + encodeURIComponent(window.location.pathname));
        return false;
      }
      
      const customer = JSON.parse(customerData);
      const userId = customer.id;
      
      if (!userId) {
        router.push('/login?redirect=' + encodeURIComponent(window.location.pathname));
        return false;
      }

      const result = await addToShoppingCart({
        userId,
        productId: product.product_id,
        quantity,
        phoneModelId: selectedPhoneModel?.model_id,
        phoneModelName: selectedPhoneModel ? `${selectedPhoneModel.brand_name} ${selectedPhoneModel.model_name}` : undefined
      });
      
      if (result.success) {
        // Cáº­p nháº­t cart count ngay láº­p tá»©c (optimistic update cho UX mÆ°á»£t)
        increaseCart(quantity);
        // Sau Ä‘Ã³ sync láº¡i vá»›i backend Ä‘á»ƒ cháº¯c cháº¯n
        window.dispatchEvent(new Event('cartUpdated'));
        return true;
      } else {
        alert(result.message || 'CÃ³ lá»—i xáº£y ra');
        return false;
      }
    } catch (error) {
      console.error('Error adding to cart:', error);
      alert('CÃ³ lá»—i xáº£y ra khi thÃªm vÃ o giá» hÃ ng');
      return false;
    } finally {
      setAddingToCart(false);
    }
  };

  // Mua ngay - thÃªm vÃ o giá» rá»“i chuyá»ƒn Ä‘áº¿n checkout
  const handleBuyNow = async () => {
    const success = await handleAddToCart();
    if (success) {
      router.push('/checkout');
    }
  };

  // ThÃªm vÃ o giá» vÃ  hiá»‡n thÃ´ng bÃ¡o
  const handleAddToCartWithNotification = async () => {
    const success = await handleAddToCart();
    if (success) {
      alert('ÄÃ£ thÃªm vÃ o giá» hÃ ng!');
    }
  };

  const formatPrice = (price: number) => {
    return price?.toLocaleString('vi-VN') + 'â‚«';
  };

  const getDiscountPercent = () => {
    if (!product || !product.sale_price || product.sale_price >= product.price) return 0;
    return Math.round((1 - product.sale_price / product.price) * 100);
  };

  const getProductImage = () => {
    if (!product) return '';
    return product.image_url || 
      product.product_images?.find((img: any) => img.is_primary)?.image_url ||
      product.product_images?.[0]?.image_url ||
      '';
  };

  const images = product?.product_images?.length 
    ? product.product_images 
    : product?.image_url 
      ? [{ image_id: 0, image_url: product.image_url, is_primary: true }]
      : [];

  const isWished = product && wishedProducts.has(product.product_id);

  if (loading) {
    return (
      <div className="min-h-screen bg-gray-50">
        <TopBanner />
        <Header />
        <div className="flex items-center justify-center py-32">
          <div className="animate-spin rounded-full h-16 w-16 border-t-4 border-pink-600"></div>
        </div>
        <Footer />
      </div>
    );
  }

  if (!product) {
    return (
      <div className="min-h-screen bg-gray-50">
        <TopBanner />
        <Header />
        <div className="flex items-center justify-center py-32">
          <div className="text-center">
            <div className="text-6xl mb-4">ðŸ˜¢</div>
            <h2 className="text-2xl font-bold mb-2">KhÃ´ng tÃ¬m tháº¥y sáº£n pháº©m</h2>
            <Link href="/shop" className="text-pink-600 hover:underline">
              â† Quay láº¡i cá»­a hÃ ng
            </Link>
          </div>
        </div>
        <Footer />
      </div>
    );
  }

  const currentPrice = product.sale_price || product.price;

  return (
    <div className="min-h-screen bg-gray-50">
      <TopBanner />
      <Header />

      {/* Breadcrumb */}
      <div className="bg-white border-b">
        <div className="max-w-7xl mx-auto px-4 py-3">
          <div className="flex items-center gap-2 text-sm text-gray-600">
            <Link href="/" className="hover:text-pink-600">Trang chá»§</Link>
            <ChevronRight className="w-4 h-4" />
            <Link href="/shop" className="hover:text-pink-600">Cá»­a hÃ ng</Link>
            <ChevronRight className="w-4 h-4" />
            <span className="text-gray-900 font-medium truncate max-w-[200px]">
              {product.product_name}
            </span>
          </div>
        </div>
      </div>

      {/* Product Main */}
      <div className="max-w-7xl mx-auto px-4 py-8">
        <div className="bg-white rounded-2xl shadow-sm p-6 lg:p-8">
          <div className="grid lg:grid-cols-2 gap-8 lg:gap-12">
            {/* Images */}
            <div>
              <div className="relative aspect-square rounded-2xl overflow-hidden bg-gray-100 mb-4">
                {images.length > 0 ? (
                  <img
                    src={images[selectedImage]?.image_url || getProductImage()}
                    alt={product.product_name}
                    className="w-full h-full object-cover"
                  />
                ) : (
                  <div className="w-full h-full flex items-center justify-center text-gray-400">
                    <ShoppingCart className="w-24 h-24" />
                  </div>
                )}
                {getDiscountPercent() > 0 && (
                  <span className="absolute top-4 left-4 bg-red-500 text-white text-sm font-bold px-3 py-1 rounded-full">
                    -{getDiscountPercent()}%
                  </span>
                )}
              </div>

              {images.length > 1 && (
                <div className="flex gap-3 overflow-x-auto pb-2">
                  {images.map((img: any, index: number) => (
                    <button
                      key={img.image_id || index}
                      onClick={() => setSelectedImage(index)}
                      className={`flex-shrink-0 w-20 h-20 rounded-lg overflow-hidden border-2 transition ${
                        selectedImage === index ? 'border-pink-600' : 'border-gray-200'
                      }`}
                    >
                      <img src={img.image_url} alt="" className="w-full h-full object-cover" />
                    </button>
                  ))}
                </div>
              )}
            </div>

            {/* Info */}
            <div>
              <div className="mb-4">
                {product.categories?.category_name && (
                  <span className="text-pink-600 text-sm font-medium">
                    {product.categories.category_name}
                  </span>
                )}
                <h1 className="text-2xl lg:text-3xl font-bold text-gray-900 mt-1">
                  {product.product_name}
                </h1>
                <div className="flex items-center gap-4 mt-3">
                  <div className="flex items-center gap-1">
                    {[1, 2, 3, 4, 5].map((star) => (
                      <Star
                        key={star}
                        className={`w-5 h-5 ${
                          star <= 4 ? 'fill-yellow-400 text-yellow-400' : 'text-gray-300'
                        }`}
                      />
                    ))}
                    <span className="ml-2 text-sm text-gray-600">4.5 (128 Ä‘Ã¡nh giÃ¡)</span>
                  </div>
                </div>
              </div>

              {/* Price */}
              <div className="mb-6 pb-6 border-b">
                <div className="flex items-baseline gap-3">
                  <span className="text-3xl font-bold text-pink-600">
                    {formatPrice(currentPrice)}
                  </span>
                  {product.sale_price && product.sale_price < product.price && (
                    <span className="text-lg text-gray-400 line-through">
                      {formatPrice(product.price)}
                    </span>
                  )}
                </div>
              </div>

              {/* Description */}
              <p className="text-gray-600 mb-6">{product.description}</p>

              {/* Phone Model Selection */}
              <div className="mb-6">
                <h3 className="font-semibold mb-3 flex items-center gap-2">
                  <Smartphone className="w-5 h-5 text-pink-600" />
                  Chá»n dÃ²ng mÃ¡y:
                  {selectedPhoneModel && (
                    <span className="text-pink-600 font-normal">
                      {selectedPhoneModel.brand_name} {selectedPhoneModel.model_name}
                    </span>
                  )}
                </h3>
                
                <div className="relative">
                  <button
                    onClick={() => setShowPhoneModelDropdown(!showPhoneModelDropdown)}
                    className={`w-full flex items-center justify-between p-4 border-2 rounded-xl transition ${
                      selectedPhoneModel 
                        ? 'border-pink-600 bg-pink-50' 
                        : 'border-gray-200 hover:border-pink-300'
                    }`}
                  >
                    <span className={selectedPhoneModel ? 'text-gray-900' : 'text-gray-500'}>
                      {selectedPhoneModel 
                        ? `${selectedPhoneModel.brand_name} ${selectedPhoneModel.model_name}`
                        : 'Chá»n dÃ²ng mÃ¡y phÃ¹ há»£p vá»›i á»‘p'
                      }
                    </span>
                    <ChevronDown className={`w-5 h-5 transition ${showPhoneModelDropdown ? 'rotate-180' : ''}`} />
                  </button>

                  {showPhoneModelDropdown && (
                    <div className="absolute top-full left-0 right-0 mt-2 bg-white border-2 border-gray-200 rounded-xl shadow-xl z-50 max-h-80 overflow-hidden">
                      {/* Search */}
                      <div className="p-3 border-b sticky top-0 bg-white">
                        <div className="relative">
                          <Search className="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400" />
                          <input
                            type="text"
                            placeholder="TÃ¬m kiáº¿m dÃ²ng mÃ¡y..."
                            value={phoneModelSearch}
                            onChange={(e) => setPhoneModelSearch(e.target.value)}
                            className="w-full pl-10 pr-4 py-2 border rounded-lg focus:border-pink-600 focus:outline-none"
                          />
                        </div>
                      </div>

                      {/* Brand tabs */}
                      {getBrands().length > 1 && (
                        <div className="flex flex-wrap gap-2 p-3 border-b bg-gray-50">
                          <button
                            onClick={() => setSelectedBrand('')}
                            className={`px-3 py-1 rounded-full text-sm transition ${
                              selectedBrand === '' 
                                ? 'bg-pink-600 text-white' 
                                : 'bg-white border hover:bg-gray-100'
                            }`}
                          >
                            Táº¥t cáº£
                          </button>
                          {getBrands().map(brand => (
                            <button
                              key={brand}
                              onClick={() => setSelectedBrand(brand)}
                              className={`px-3 py-1 rounded-full text-sm transition ${
                                selectedBrand === brand 
                                  ? 'bg-pink-600 text-white' 
                                  : 'bg-white border hover:bg-gray-100'
                              }`}
                            >
                              {brand}
                            </button>
                          ))}
                        </div>
                      )}

                      {/* Model list */}
                      <div className="max-h-48 overflow-y-auto">
                        {loadingModels ? (
                          <div className="p-4 text-center text-gray-500">
                            Äang táº£i...
                          </div>
                        ) : getFilteredModels().length === 0 ? (
                          <div className="p-4 text-center text-gray-500">
                            {compatibleModels.length === 0 && allPhoneModels.length === 0
                              ? 'Sáº£n pháº©m nÃ y phÃ¹ há»£p vá»›i má»i dÃ²ng mÃ¡y'
                              : 'KhÃ´ng tÃ¬m tháº¥y dÃ²ng mÃ¡y phÃ¹ há»£p'
                            }
                          </div>
                        ) : (
                          getFilteredModels().map((model) => (
                            <button
                              key={model.model_id}
                              onClick={() => {
                                setSelectedPhoneModel(model);
                                setShowPhoneModelDropdown(false);
                                setPhoneModelSearch('');
                              }}
                              className={`w-full flex items-center justify-between p-3 hover:bg-pink-50 transition text-left ${
                                selectedPhoneModel?.model_id === model.model_id ? 'bg-pink-50' : ''
                              }`}
                            >
                              <div>
                                <span className="text-gray-500 text-sm">{model.brand_name}</span>
                                <span className="mx-2">â€¢</span>
                                <span className="font-medium">{model.model_name}</span>
                                {model.is_popular && (
                                  <span className="ml-2 px-2 py-0.5 bg-orange-100 text-orange-600 text-xs rounded-full">
                                    Phá»• biáº¿n
                                  </span>
                                )}
                              </div>
                              {selectedPhoneModel?.model_id === model.model_id && (
                                <Check className="w-5 h-5 text-pink-600" />
                              )}
                            </button>
                          ))
                        )}
                      </div>
                    </div>
                  )}
                </div>

                {compatibleModels.length > 0 && (
                  <p className="text-sm text-gray-500 mt-2">
                    âœ“ Sáº£n pháº©m nÃ y tÆ°Æ¡ng thÃ­ch vá»›i {compatibleModels.length} dÃ²ng mÃ¡y
                  </p>
                )}
              </div>

              {/* Quantity */}
              <div className="mb-6">
                <h3 className="font-semibold mb-3">Sá»‘ lÆ°á»£ng:</h3>
                <div className="flex items-center gap-4">
                  <div className="flex items-center border rounded-lg">
                    <button
                      onClick={() => setQuantity(q => Math.max(1, q - 1))}
                      className="p-3 hover:bg-gray-100 transition"
                    >
                      <Minus className="w-4 h-4" />
                    </button>
                    <span className="px-6 py-3 font-semibold">{quantity}</span>
                    <button
                      onClick={() => setQuantity(q => q + 1)}
                      className="p-3 hover:bg-gray-100 transition"
                    >
                      <Plus className="w-4 h-4" />
                    </button>
                  </div>
                  <button
                    onClick={() => toggleWishlist(product.product_id)}
                    className={`p-3 rounded-lg border transition ${
                      isWished ? 'bg-pink-50 border-pink-600 text-pink-600' : 'border-gray-200'
                    }`}
                  >
                    <Heart className={`w-6 h-6 ${isWished ? 'fill-pink-600' : ''}`} />
                  </button>
                </div>
              </div>

              {/* Buttons */}
              <div className="flex gap-4 mb-4">
                <button
                  onClick={handleAddToCartWithNotification}
                  disabled={addingToCart}
                  className="flex-1 flex items-center justify-center gap-2 bg-white border-2 border-pink-600 text-pink-600 py-4 rounded-xl font-semibold hover:bg-pink-50 transition disabled:opacity-50"
                >
                  <ShoppingCart className="w-5 h-5" />
                  {addingToCart ? 'Äang thÃªm...' : 'ThÃªm vÃ o giá»'}
                </button>
                <button
                  onClick={handleBuyNow}
                  disabled={addingToCart}
                  className="flex-1 bg-gradient-to-r from-pink-600 to-purple-600 text-white py-4 rounded-xl font-semibold hover:from-pink-700 hover:to-purple-700 transition disabled:opacity-50"
                >
                  {addingToCart ? 'Äang xá»­ lÃ½...' : 'Mua ngay'}
                </button>
              </div>

              {/* Gift Button */}
              <button
                onClick={() => router.push(`/gift/send?productId=${product.product_id}`)}
                className="w-full flex items-center justify-center gap-2 bg-gradient-to-r from-amber-500 to-orange-500 text-white py-4 rounded-xl font-semibold hover:from-amber-600 hover:to-orange-600 transition mb-8"
              >
                <Gift className="w-5 h-5" />
                 Gá»­i Táº·ng Báº¡n BÃ¨
              </button>

              {/* Benefits */}
              <div className="grid grid-cols-2 gap-4 p-4 bg-gray-50 rounded-xl">
                <div className="flex items-center gap-3">
                  <div className="bg-green-100 p-2 rounded-full">
                    <Truck className="w-5 h-5 text-green-600" />
                  </div>
                  <div className="text-sm">
                    <p className="font-medium">Giao hÃ ng nhanh</p>
                    <p className="text-gray-500">2-3 ngÃ y</p>
                  </div>
                </div>
                <div className="flex items-center gap-3">
                  <div className="bg-blue-100 p-2 rounded-full">
                    <Shield className="w-5 h-5 text-blue-600" />
                  </div>
                  <div className="text-sm">
                    <p className="font-medium">Báº£o hÃ nh</p>
                    <p className="text-gray-500">12 thÃ¡ng</p>
                  </div>
                </div>
                <div className="flex items-center gap-3">
                  <div className="bg-orange-100 p-2 rounded-full">
                    <RotateCcw className="w-5 h-5 text-orange-600" />
                  </div>
                  <div className="text-sm">
                    <p className="font-medium">Äá»•i tráº£</p>
                    <p className="text-gray-500">30 ngÃ y</p>
                  </div>
                </div>
                <div className="flex items-center gap-3">
                  <div className="bg-purple-100 p-2 rounded-full">
                    <Check className="w-5 h-5 text-purple-600" />
                  </div>
                  <div className="text-sm">
                    <p className="font-medium">ChÃ­nh hÃ£ng</p>
                    <p className="text-gray-500">100%</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <Footer />
    </div>
  );
}




################################################################################
## FILE 128: page.tsx
## Path: fontend/src/app/promotions/page.tsx
################################################################################

'use client';

import React, { useState, useEffect } from 'react';
import { ShoppingCart, User, Heart, Search, Menu, Tag, Clock, Percent, Gift, Star, ChevronRight } from 'lucide-react';
import Link from 'next/link';
import { fetchCategories } from '@/lib/api-client';

interface Deal {
  id: number;
  title: string;
  description: string;
  discount: string;
  code: string;
  image: string;
  endDate: string;
  tag?: string;
}

const PromotionsPage: React.FC = () => {
  const [cartCount, setCartCount] = useState(0);
  const [wishlistCount, setWishlistCount] = useState(0);
  const [selectedDevice, setSelectedDevice] = useState('iPhone 17 Pro Max');
  const [isCurrencyModalOpen, setIsCurrencyModalOpen] = useState(false);
  const [selectedCurrency, setSelectedCurrency] = useState('USD');
  const [copiedCode, setCopiedCode] = useState<string | null>(null);
  const [devices, setDevices] = useState<string[]>(['iPhone 17 Pro Max']);

  useEffect(() => {
    const loadCategories = async () => {
      try {
        const data = await fetchCategories();
        if (Array.isArray(data) && data.length > 0) {
          const categoryNames = data.map((cat: any) => cat.category_name);
          setDevices(categoryNames);
          setSelectedDevice(categoryNames[0]);
        }
      } catch (error) {
        console.error('Error loading categories:', error);
      }
    };
    loadCategories();
  }, []);

  const handleCurrencyChange = (currency: string) => {
    setSelectedCurrency(currency);
    setIsCurrencyModalOpen(false);
  };

  const copyCode = (code: string) => {
    navigator.clipboard.writeText(code);
    setCopiedCode(code);
    setTimeout(() => setCopiedCode(null), 2000);
  };

  const featuredDeals: Deal[] = [
    {
      id: 1,
      title: 'Mua 4 Tráº£ 2',
      description: 'Mua 4 á»‘p Ä‘iá»‡n thoáº¡i báº¥t ká»³ chá»‰ pháº£i tráº£ tiá»n 2 á»‘p',
      discount: '50%',
      code: 'BUY4GET2',
      image: 'https://images.unsplash.com/photo-1556656793-08538906a9f8?w=600&h=400&fit=crop',
      endDate: '31/12/2024',
      tag: 'HOT'
    },
    {
      id: 2,
      title: 'Giáº£m 30% ToÃ n Bá»™ iPhone 17',
      description: 'Ãp dá»¥ng cho táº¥t cáº£ á»‘p iPhone 17 Series',
      discount: '30%',
      code: 'IPHONE17',
      image: 'https://images.unsplash.com/photo-1592899677977-9c10ca588bbd?w=600&h=400&fit=crop',
      endDate: '25/12/2024',
      tag: 'Má»šI'
    },
    {
      id: 3,
      title: 'Flash Sale Cuá»‘i Tuáº§n',
      description: 'Giáº£m giÃ¡ shock tá»« T7-CN hÃ ng tuáº§n',
      discount: '40%',
      code: 'WEEKEND40',
      image: 'https://images.unsplash.com/photo-1565849904461-04a3cc76e3a9?w=600&h=400&fit=crop',
      endDate: '15/12/2024',
      tag: 'FLASH'
    }
  ];

  const deals: Deal[] = [
    {
      id: 4,
      title: 'Miá»…n PhÃ­ Váº­n Chuyá»ƒn',
      description: 'Cho Ä‘Æ¡n hÃ ng tá»« 100K trá»Ÿ lÃªn',
      discount: 'FREE SHIP',
      code: 'FREESHIP100',
      image: 'https://images.unsplash.com/photo-1511707171634-5f897ff02aa9?w=400&h=300&fit=crop',
      endDate: '31/12/2024'
    },
    {
      id: 5,
      title: 'Giáº£m 20% KhÃ¡ch HÃ ng Má»›i',
      description: 'DÃ nh cho Ä‘Æ¡n hÃ ng Ä‘áº§u tiÃªn',
      discount: '20%',
      code: 'NEW20',
      image: 'https://images.unsplash.com/photo-1510557880182-3d4d3cba35a5?w=400&h=300&fit=crop',
      endDate: '31/12/2024'
    },
    {
      id: 6,
      title: 'Bundle Deal',
      description: 'Mua á»‘p + phá»¥ kiá»‡n giáº£m 25%',
      discount: '25%',
      code: 'BUNDLE25',
      image: 'https://images.unsplash.com/photo-1565849904461-04a3cc76e3a9?w=400&h=300&fit=crop',
      endDate: '20/12/2024'
    },
    {
      id: 7,
      title: 'Sinh Nháº­t GoatTech',
      description: 'Giáº£m 35% nhÃ¢n dá»‹p sinh nháº­t thÆ°Æ¡ng hiá»‡u',
      discount: '35%',
      code: 'BDAY35',
      image: 'https://images.unsplash.com/photo-1556656793-08538906a9f8?w=400&h=300&fit=crop',
      endDate: '10/12/2024'
    },
    {
      id: 8,
      title: 'Giáº£m GiÃ¡ Combo',
      description: 'Mua 2 á»‘p báº¥t ká»³ giáº£m 15%',
      discount: '15%',
      code: 'COMBO15',
      image: 'https://images.unsplash.com/photo-1592899677977-9c10ca588bbd?w=400&h=300&fit=crop',
      endDate: '31/12/2024'
    },
    {
      id: 9,
      title: 'Student Discount',
      description: 'Giáº£m 10% cho há»c sinh, sinh viÃªn',
      discount: '10%',
      code: 'STUDENT10',
      image: 'https://images.unsplash.com/photo-1511707171634-5f897ff02aa9?w=400&h=300&fit=crop',
      endDate: '31/12/2024'
    }
  ];

  return (
    <div className="min-h-screen bg-gray-50">
      {/* Currency Modal */}
      {isCurrencyModalOpen && (
        <div className="fixed inset-0 z-50 flex items-center justify-center" onClick={() => setIsCurrencyModalOpen(false)}>
          <div className="bg-white rounded-xl p-6 max-w-md w-full mx-4 shadow-2xl" onClick={(e) => e.stopPropagation()}>
            <div className="flex items-center justify-between mb-6">
              <h2 className="text-xl font-bold">CHá»ŒN LOáº I TIá»€N Tá»†</h2>
              <button onClick={() => setIsCurrencyModalOpen(false)} className="text-gray-500 hover:text-gray-700">
                <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                </svg>
              </button>
            </div>
            
            <div className="mb-6">
              <label className="block text-sm font-semibold mb-2 text-gray-700">QUá»C GIA/KHU Vá»°C:</label>
              <select 
                className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-600"
                value={selectedCurrency}
                onChange={(e) => handleCurrencyChange(e.target.value)}
              >
                <option value="USD">United States (USD $)</option>
                <option value="VND">Viá»‡t Nam (VND â‚«)</option>
              </select>
            </div>

            <button 
              onClick={() => setIsCurrencyModalOpen(false)}
              className="w-full bg-black text-white py-3 rounded-lg font-semibold hover:bg-gray-800 transition"
            >
              ÃP Dá»¤NG
            </button>
          </div>
        </div>
      )}

      {/* Top Banner */}
      <div className="bg-gradient-to-r from-red-600 to-pink-600 text-white py-2 px-4 text-center text-sm font-semibold animate-pulse">
        <div className="max-w-7xl mx-auto">
          ðŸ”¥ KHUYáº¾N MÃƒI Äáº¶C BIá»†T - GIáº¢M Äáº¾N 50% - MUA NGAY KáººO Lá» ! ðŸ”¥
        </div>
      </div>

      {/* Header */}
      <header className="bg-white shadow-sm sticky top-0 z-40">
        <div className="max-w-7xl mx-auto px-4 py-4">
          <div className="flex items-center justify-between gap-4">
            <div className="flex items-center gap-4">
              <button className="lg:hidden">
                <Menu className="w-6 h-6" />
              </button>
              <button className="lg:hidden">
                <Search className="w-6 h-6" />
              </button>
            </div>

            <Link href="/" className="text-2xl font-bold tracking-wider">
              GoatTech
            </Link>

            <div className="flex items-center gap-4">
              <button className="hidden lg:block px-4 py-2 text-sm font-medium border rounded-lg" onClick={() => setIsCurrencyModalOpen(true)}>
                {selectedCurrency} {selectedCurrency === 'USD' ? '$' : 'â‚«'}
              </button>

              <select 
                value={selectedDevice}
                onChange={(e) => setSelectedDevice(e.target.value)}
                className="hidden lg:block px-4 py-2 border rounded-lg text-sm"
              >
                {devices.map((device) => (
                  <option key={device} value={device}>{device}</option>
                ))}
              </select>

              <button className="relative">
                <Heart className="w-6 h-6" />
                {wishlistCount > 0 && (
                  <span className="absolute -top-1 -right-1 bg-green-500 text-white text-xs w-5 h-5 rounded-full flex items-center justify-center">
                    {wishlistCount}
                  </span>
                )}
              </button>

              <Link href="/account">
                <User className="w-6 h-6" />
              </Link>

              <button className="relative">
                <ShoppingCart className="w-6 h-6" />
                {cartCount > 0 && (
                  <span className="absolute -top-1 -right-1 bg-black text-white text-xs w-5 h-5 rounded-full flex items-center justify-center">
                    {cartCount}
                  </span>
                )}
              </button>
            </div>
          </div>

          {/* Desktop Navigation */}
          <nav className="hidden lg:flex items-center justify-center gap-8 mt-4 pt-4 border-t">
            <Link href="/" className="text-sm font-medium hover:text-pink-600">Trang Chá»§</Link>
            <Link href="/shop" className="text-sm font-medium hover:text-pink-600">Cá»­a HÃ ng</Link>
            <button className="text-sm font-medium hover:text-pink-600">Bá»™ SÆ°u Táº­p</button>
            <Link href="/about" className="text-sm font-medium hover:text-pink-600">Vá» ChÃºng TÃ´i</Link>
            <Link href="/contact" className="text-sm font-medium hover:text-pink-600">LiÃªn Há»‡</Link>
            <Link href="/promotions" className="text-sm font-medium text-red-600">Khuyáº¿n Máº¡i</Link>
          </nav>
        </div>
      </header>

      {/* Hero Section */}
      <div className="bg-gradient-to-r from-red-600 via-pink-600 to-orange-600 text-white py-16">
        <div className="max-w-7xl mx-auto px-4 text-center">
          <div className="inline-block bg-white/20 px-6 py-2 rounded-full mb-4">
            <span className="font-bold">âš¡ SALE Lá»šN THÃNG 12</span>
          </div>
          <h1 className="text-5xl md:text-6xl font-bold mb-6">Khuyáº¿n MÃ£i Äáº·c Biá»‡t</h1>
          <p className="text-xl md:text-2xl mb-8">
            Tiáº¿t kiá»‡m Ä‘áº¿n 50% cho táº¥t cáº£ sáº£n pháº©m - Æ¯u Ä‘Ã£i cÃ³ háº¡n!
          </p>
          <div className="flex items-center justify-center gap-8 text-center">
            <div>
              <div className="text-4xl font-bold mb-1">50+</div>
              <div className="text-sm">MÃ£ Giáº£m GiÃ¡</div>
            </div>
            <div className="w-px h-12 bg-white/30"></div>
            <div>
              <div className="text-4xl font-bold mb-1">500K+</div>
              <div className="text-sm">KhÃ¡ch ÄÃ£ Tiáº¿t Kiá»‡m</div>
            </div>
            <div className="w-px h-12 bg-white/30"></div>
            <div>
              <div className="text-4xl font-bold mb-1">-50%</div>
              <div className="text-sm">Giáº£m Tá»‘i Äa</div>
            </div>
          </div>
        </div>
      </div>

      {/* Featured Deals */}
      <div className="max-w-7xl mx-auto px-4 py-16">
        <h2 className="text-4xl font-bold text-center mb-12">Æ¯u ÄÃ£i Ná»•i Báº­t</h2>
        <div className="grid grid-cols-1 md:grid-cols-3 gap-8">
          {featuredDeals.map((deal) => (
            <div key={deal.id} className="bg-white rounded-2xl overflow-hidden shadow-lg hover:shadow-2xl transition group">
              <div className="relative overflow-hidden">
                {deal.tag && (
                  <span className="absolute top-4 left-4 bg-red-500 text-white px-4 py-1 rounded-full text-sm font-bold z-10">
                    {deal.tag}
                  </span>
                )}
                <div className="absolute top-4 right-4 bg-yellow-400 text-black w-20 h-20 rounded-full flex items-center justify-center font-bold text-lg z-10 shadow-lg">
                  -{deal.discount}
                </div>
                <img
                  src={deal.image}
                  alt={deal.title}
                  className="w-full h-64 object-cover group-hover:scale-110 transition duration-500"
                />
              </div>
              <div className="p-6">
                <h3 className="text-2xl font-bold mb-2">{deal.title}</h3>
                <p className="text-gray-600 mb-4">{deal.description}</p>
                
                <div className="flex items-center gap-2 text-sm text-gray-500 mb-4">
                  <Clock className="w-4 h-4" />
                  <span>Háº¿t háº¡n: {deal.endDate}</span>
                </div>

                <div className="bg-gradient-to-r from-purple-50 to-pink-50 p-4 rounded-lg mb-4">
                  <div className="flex items-center justify-between">
                    <div>
                      <div className="text-xs text-gray-600 mb-1">MÃƒ GIáº¢M GIÃ:</div>
                      <div className="text-xl font-bold text-purple-600">{deal.code}</div>
                    </div>
                    <button
                      onClick={() => copyCode(deal.code)}
                      className="bg-gradient-to-r from-purple-600 to-pink-600 text-white px-6 py-2 rounded-lg font-semibold hover:from-purple-700 hover:to-pink-700 transition"
                    >
                      {copiedCode === deal.code ? 'âœ“ ÄÃ£ Copy' : 'Copy'}
                    </button>
                  </div>
                </div>

                <Link
                  href="/shop"
                  className="block w-full bg-black text-white text-center py-3 rounded-lg font-semibold hover:bg-gray-800 transition"
                >
                  Mua Ngay
                </Link>
              </div>
            </div>
          ))}
        </div>
      </div>

      {/* All Deals */}
      <div className="bg-white py-16">
        <div className="max-w-7xl mx-auto px-4">
          <h2 className="text-4xl font-bold text-center mb-12">Táº¥t Cáº£ Æ¯u ÄÃ£i</h2>
          <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-8">
            {deals.map((deal) => (
              <div key={deal.id} className="bg-gradient-to-br from-gray-50 to-white rounded-xl p-6 border-2 border-gray-100 hover:border-pink-300 hover:shadow-lg transition">
                <div className="flex items-start justify-between mb-4">
                  <div className="bg-gradient-to-br from-pink-500 to-orange-500 text-white w-16 h-16 rounded-xl flex items-center justify-center font-bold shadow-lg">
                    -{deal.discount}
                  </div>
                  <div className="flex items-center gap-1 text-yellow-500">
                    <Star className="w-4 h-4 fill-current" />
                    <Star className="w-4 h-4 fill-current" />
                    <Star className="w-4 h-4 fill-current" />
                    <Star className="w-4 h-4 fill-current" />
                    <Star className="w-4 h-4 fill-current" />
                  </div>
                </div>

                <h3 className="text-xl font-bold mb-2">{deal.title}</h3>
                <p className="text-gray-600 text-sm mb-4">{deal.description}</p>

                <div className="flex items-center gap-2 text-xs text-gray-500 mb-4">
                  <Clock className="w-3 h-3" />
                  <span>Äáº¿n {deal.endDate}</span>
                </div>

                <div className="bg-gray-100 rounded-lg p-3 mb-4 border-2 border-dashed border-gray-300">
                  <div className="flex items-center justify-between">
                    <span className="font-mono font-bold text-purple-600">{deal.code}</span>
                    <button
                      onClick={() => copyCode(deal.code)}
                      className="text-pink-600 hover:text-pink-700 text-sm font-semibold"
                    >
                      {copiedCode === deal.code ? 'âœ“' : 'Copy'}
                    </button>
                  </div>
                </div>

                <Link
                  href="/shop"
                  className="flex items-center justify-center gap-2 w-full bg-gradient-to-r from-pink-600 to-orange-600 text-white py-2 rounded-lg font-semibold hover:from-pink-700 hover:to-orange-700 transition"
                >
                  Ãp Dá»¥ng Ngay <ChevronRight className="w-4 h-4" />
                </Link>
              </div>
            ))}
          </div>
        </div>
      </div>

      {/* How to Use */}
      <div className="max-w-7xl mx-auto px-4 py-16">
        <h2 className="text-4xl font-bold text-center mb-12">CÃ¡ch Sá»­ Dá»¥ng MÃ£ Giáº£m GiÃ¡</h2>
        <div className="grid grid-cols-1 md:grid-cols-4 gap-8">
          <div className="text-center">
            <div className="bg-gradient-to-br from-purple-100 to-pink-100 w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-4">
              <div className="text-3xl font-bold text-purple-600">1</div>
            </div>
            <h3 className="font-semibold text-lg mb-2">Chá»n Sáº£n Pháº©m</h3>
            <p className="text-gray-600">ThÃªm sáº£n pháº©m yÃªu thÃ­ch vÃ o giá» hÃ ng</p>
          </div>
          <div className="text-center">
            <div className="bg-gradient-to-br from-blue-100 to-cyan-100 w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-4">
              <div className="text-3xl font-bold text-blue-600">2</div>
            </div>
            <h3 className="font-semibold text-lg mb-2">Copy MÃ£</h3>
            <p className="text-gray-600">Click nÃºt Copy Ä‘á»ƒ sao chÃ©p mÃ£ giáº£m giÃ¡</p>
          </div>
          <div className="text-center">
            <div className="bg-gradient-to-br from-green-100 to-teal-100 w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-4">
              <div className="text-3xl font-bold text-green-600">3</div>
            </div>
            <h3 className="font-semibold text-lg mb-2">Nháº­p MÃ£</h3>
            <p className="text-gray-600">DÃ¡n mÃ£ vÃ o Ã´ "MÃ£ giáº£m giÃ¡" khi thanh toÃ¡n</p>
          </div>
          <div className="text-center">
            <div className="bg-gradient-to-br from-orange-100 to-red-100 w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-4">
              <div className="text-3xl font-bold text-orange-600">4</div>
            </div>
            <h3 className="font-semibold text-lg mb-2">Tiáº¿t Kiá»‡m</h3>
            <p className="text-gray-600">Táº­n hÆ°á»Ÿng giÃ¡ Æ°u Ä‘Ã£i vÃ  hoÃ n táº¥t Ä‘Æ¡n hÃ ng</p>
          </div>
        </div>
      </div>

      {/* CTA Banner */}
      <div className="bg-gradient-to-r from-purple-600 to-pink-600 py-16">
        <div className="max-w-7xl mx-auto px-4 text-center text-white">
          <Gift className="w-16 h-16 mx-auto mb-4" />
          <h2 className="text-4xl font-bold mb-4">ÄÄƒng KÃ½ Nháº­n Æ¯u ÄÃ£i</h2>
          <p className="text-xl mb-8">Nháº­n mÃ£ giáº£m giÃ¡ 15% cho Ä‘Æ¡n hÃ ng Ä‘áº§u tiÃªn + thÃ´ng bÃ¡o Æ°u Ä‘Ã£i Ä‘á»™c quyá»n</p>
          <div className="flex flex-col sm:flex-row gap-4 justify-center max-w-md mx-auto">
            <input
              type="email"
              placeholder="Nháº­p email cá»§a báº¡n"
              className="px-4 py-3 rounded-lg text-gray-900 flex-1"
            />
            <button className="bg-black text-white px-8 py-3 rounded-lg font-semibold hover:bg-gray-800 transition">
              ÄÄƒng KÃ½ Ngay
            </button>
          </div>
        </div>
      </div>

      {/* Footer */}
      <footer className="bg-gray-900 text-white py-12">
        <div className="max-w-7xl mx-auto px-4">
          <div className="grid grid-cols-1 md:grid-cols-4 gap-8 mb-8">
            <div>
              <h3 className="text-2xl font-bold mb-4">GoatTech</h3>
              <p className="text-gray-400">á»p Ä‘iá»‡n thoáº¡i cao cáº¥p vÃ  phá»¥ kiá»‡n cÃ´ng nghá»‡</p>
            </div>
            <div>
              <h4 className="font-semibold mb-4">Cá»­a HÃ ng</h4>
              <ul className="space-y-2 text-gray-400">
                <li><Link href="/shop" className="hover:text-white">á»p iPhone</Link></li>
                <li><Link href="/shop" className="hover:text-white">Phá»¥ Kiá»‡n</Link></li>
                <li><Link href="/shop" className="hover:text-white">HÃ ng Má»›i Vá»</Link></li>
                <li><Link href="/promotions" className="hover:text-white">Khuyáº¿n Máº¡i</Link></li>
              </ul>
            </div>
            <div>
              <h4 className="font-semibold mb-4">Há»— Trá»£</h4>
              <ul className="space-y-2 text-gray-400">
                <li><Link href="/contact" className="hover:text-white">LiÃªn Há»‡ ChÃºng TÃ´i</Link></li>
                <li><button className="hover:text-white text-left">ThÃ´ng Tin Váº­n Chuyá»ƒn</button></li>
                <li><button className="hover:text-white text-left">ChÃ­nh SÃ¡ch HoÃ n HÃ ng</button></li>
                <li><button className="hover:text-white text-left">CÃ¢u Há»i ThÆ°á»ng Gáº·p</button></li>
              </ul>
            </div>
            <div>
              <h4 className="font-semibold mb-4">Theo DÃµi ChÃºng TÃ´i</h4>
              <ul className="space-y-2 text-gray-400">
                <li><button className="hover:text-white text-left">Instagram</button></li>
                <li><button className="hover:text-white text-left">Facebook</button></li>
                <li><button className="hover:text-white text-left">TikTok</button></li>
                <li><button className="hover:text-white text-left">YouTube</button></li>
              </ul>
            </div>
          </div>
          <div className="border-t border-gray-800 pt-8 text-center text-gray-400">
            <p>&copy; 2024 GoatTech - á»p Äiá»‡n Thoáº¡i Sá»‘ 1 Viá»‡t Nam. Báº£o LÆ°u Má»i Quyá»n.</p>
          </div>
        </div>
      </footer>
    </div>
  );
};

export default PromotionsPage;




################################################################################
## FILE 129: index.ts
## Path: fontend/src/components/guards/index.ts
################################################################################

export * from './CustomerOnly';
export * from './RoleGuard';



################################################################################
## FILE 130: RoleGuard.tsx
## Path: fontend/src/components/guards/RoleGuard.tsx
################################################################################

'use client';

import React, { ReactNode, useEffect } from 'react';
import { useAuth, UserRole } from '@/contexts/AuthContext';
import { useRouter } from 'next/navigation';

interface RoleGuardProps {
  children: ReactNode;
  allowedRoles: UserRole[];
  redirectTo?: string;         // Redirect náº¿u khÃ´ng cÃ³ quyá»n
  fallback?: ReactNode;        // Hiá»ƒn thá»‹ thay vÃ¬ redirect
}

/**
 * Component báº£o vá»‡ route theo role
 * 
 * VÃ­ dá»¥ sá»­ dá»¥ng:
 * <RoleGuard allowedRoles={[UserRole.CUSTOMER]} redirectTo="/login">
 *   <CheckoutPage />
 * </RoleGuard>
 */
export function RoleGuard({
  children,
  allowedRoles,
  redirectTo,
  fallback,
}: RoleGuardProps) {
  const { user, loading, isAuthenticated } = useAuth();
  const router = useRouter();

  useEffect(() => {
    if (!loading && !isAuthenticated && redirectTo) {
      router.push(redirectTo);
    }
  }, [loading, isAuthenticated, redirectTo, router]);

  // Loading
  if (loading) {
    return (
      <div className="flex justify-center items-center min-h-[200px]">
        <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-pink-600" />
      </div>
    );
  }

  // ChÆ°a Ä‘Äƒng nháº­p
  if (!isAuthenticated) {
    if (fallback) return <>{fallback}</>;
    return (
      <div className="text-center py-10">
        <p className="text-gray-600">Vui lÃ²ng Ä‘Äƒng nháº­p Ä‘á»ƒ tiáº¿p tá»¥c</p>
      </div>
    );
  }

  // Kiá»ƒm tra role
  if (!user || !allowedRoles.includes(user.role)) {
    if (fallback) return <>{fallback}</>;
    return (
      <div className="text-center py-10">
        <h2 className="text-xl font-semibold text-red-600 mb-2">
          â›” KhÃ´ng cÃ³ quyá»n truy cáº­p
        </h2>
        <p className="text-gray-600">
          Báº¡n cáº§n vai trÃ² "{allowedRoles.join('" hoáº·c "')}" Ä‘á»ƒ xem trang nÃ y
        </p>
      </div>
    );
  }

  // CÃ³ quyá»n
  return <>{children}</>;
}



################################################################################
## FILE 131: CustomerOnly.tsx
## Path: fontend/src/components/guards/CustomerOnly.tsx
################################################################################

'use client';

import React, { ReactNode } from 'react';
import { useAuth } from '@/contexts/AuthContext';
import Link from 'next/link';

interface CustomerOnlyProps {
  children: ReactNode;
  fallback?: ReactNode;        // Hiá»ƒn thá»‹ khi khÃ´ng cÃ³ quyá»n
  showLoginPrompt?: boolean;   // Hiá»ƒn thá»‹ link Ä‘Äƒng nháº­p
}

/**
 * Component wrapper chá»‰ hiá»ƒn thá»‹ ná»™i dung cho CUSTOMER
 * 
 * VÃ­ dá»¥ sá»­ dá»¥ng:
 * <CustomerOnly>
 *   <button onClick={addToCart}>ThÃªm vÃ o giá» hÃ ng</button>
 * </CustomerOnly>
 */
export function CustomerOnly({
  children,
  fallback,
  showLoginPrompt = true,
}: CustomerOnlyProps) {
  const { user, isCustomer, loading, isAuthenticated } = useAuth();

  // Äang loading
  if (loading) {
    return (
      <div className="animate-pulse bg-gray-200 h-10 w-32 rounded" />
    );
  }

  // ÄÃ£ Ä‘Äƒng nháº­p vÃ  lÃ  Customer -> hiá»ƒn thá»‹ children
  if (isAuthenticated && isCustomer) {
    return <>{children}</>;
  }

  // CÃ³ fallback custom -> hiá»ƒn thá»‹ fallback
  if (fallback) {
    return <>{fallback}</>;
  }

  // Máº·c Ä‘á»‹nh: hiá»ƒn thá»‹ thÃ´ng bÃ¡o
  if (!isAuthenticated && showLoginPrompt) {
    return (
      <Link
        href="/login"
        className="inline-block bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded text-sm transition"
      >
        ÄÄƒng nháº­p Ä‘á»ƒ tiáº¿p tá»¥c
      </Link>
    );
  }

  // ÄÃ£ Ä‘Äƒng nháº­p nhÆ°ng khÃ´ng pháº£i customer
  if (isAuthenticated && !isCustomer) {
    return (
      <span className="text-gray-500 text-sm">
        Chá»‰ khÃ¡ch hÃ ng má»›i thá»±c hiá»‡n Ä‘Æ°á»£c
      </span>
    );
  }

  return null;
}



################################################################################
## FILE 132: index.ts
## Path: fontend/src/components/home/index.ts
################################################################################

// File: fontend/src/components/home/index.ts

export { default as HeroCarousel } from './HeroCarousel';
export { default as CategoryGrid } from './CategoryGrid';
export { default as FeaturedProducts } from './FeaturedProducts';
export { default as PromoSection } from './PromoSection';



################################################################################
## FILE 133: PromoSection.tsx
## Path: fontend/src/components/home/PromoSection.tsx
################################################################################

// File: fontend/src/components/home/PromoSection.tsx

'use client';

import { useState } from 'react';

interface PromoSectionProps {
  title?: string;
  subtitle?: string;
  onSubscribe?: (email: string) => void;
}

export default function PromoSection({
  title = 'Tham Gia NhÃ³m GoatTech',
  subtitle = 'Nháº­n 15% giáº£m giÃ¡ cho Ä‘Æ¡n hÃ ng Ä‘áº§u tiÃªn + Æ°u Ä‘Ã£i Ä‘á»™c quyá»n',
  onSubscribe,
}: PromoSectionProps) {
  const [email, setEmail] = useState('');

  const handleSubmit = (e: React.FormEvent) => {
    e.preventDefault();
    if (email.trim()) {
      onSubscribe?.(email);
      setEmail('');
    }
  };

  return (
    <div className="bg-gradient-to-r from-orange-500 to-pink-500 text-white py-16">
      <div className="max-w-7xl mx-auto px-4 text-center">
        <h2 className="text-4xl font-bold mb-4">{title}</h2>
        <p className="text-xl mb-8">{subtitle}</p>
        <form
          onSubmit={handleSubmit}
          className="flex flex-col sm:flex-row gap-4 justify-center max-w-md mx-auto"
        >
          <input
            type="email"
            value={email}
            onChange={(e) => setEmail(e.target.value)}
            placeholder="Nháº­p email cá»§a báº¡n"
            className="px-4 py-3 rounded-lg text-gray-900 flex-1"
            required
          />
          <button
            type="submit"
            className="bg-white text-orange-600 px-8 py-3 rounded-lg font-semibold hover:bg-gray-100 transition"
          >
            ÄÄƒng KÃ½
          </button>
        </form>
      </div>
    </div>
  );
}



################################################################################
## FILE 134: HeroCarousel.tsx
## Path: fontend/src/components/home/HeroCarousel.tsx
################################################################################

// File: fontend/src/components/home/HeroCarousel.tsx

'use client';

import { useState, useEffect } from 'react';
import { ChevronLeft, ChevronRight } from 'lucide-react';
import { BannerSlide } from '@/types';

interface HeroCarouselProps {
  slides: BannerSlide[];
  autoPlay?: boolean;
  autoPlayInterval?: number;
  onShopNow?: () => void;
}

export default function HeroCarousel({
  slides,
  autoPlay = true,
  autoPlayInterval = 5000,
  onShopNow,
}: HeroCarouselProps) {
  const [currentSlide, setCurrentSlide] = useState(0);

  useEffect(() => {
    if (!autoPlay || slides.length <= 1) return;

    const interval = setInterval(() => {
      setCurrentSlide((prev) => (prev + 1) % slides.length);
    }, autoPlayInterval);

    return () => clearInterval(interval);
  }, [autoPlay, autoPlayInterval, slides.length]);

  const nextSlide = () => {
    setCurrentSlide((prev) => (prev + 1) % slides.length);
  };

  const prevSlide = () => {
    setCurrentSlide((prev) => (prev - 1 + slides.length) % slides.length);
  };

  if (slides.length === 0) return null;

  return (
    <div className="relative bg-gradient-to-r from-purple-600 to-pink-600 text-white overflow-hidden">
      <div className="max-w-7xl mx-auto px-4 py-16 md:py-24">
        <div className="text-center">
          <h1 className="text-4xl md:text-6xl font-bold mb-4">
            {slides[currentSlide].title}
          </h1>
          <p className="text-xl md:text-2xl mb-8">
            {slides[currentSlide].subtitle}
          </p>
          <button
            onClick={onShopNow}
            className="bg-white text-purple-600 px-8 py-3 rounded-full font-semibold hover:bg-gray-100 transition"
          >
            Shop Now
          </button>
        </div>
      </div>

      {slides.length > 1 && (
        <>
          <button
            onClick={prevSlide}
            className="absolute left-4 top-1/2 -translate-y-1/2 bg-white/20 hover:bg-white/30 p-2 rounded-full transition"
          >
            <ChevronLeft className="w-6 h-6" />
          </button>

          <button
            onClick={nextSlide}
            className="absolute right-4 top-1/2 -translate-y-1/2 bg-white/20 hover:bg-white/30 p-2 rounded-full transition"
          >
            <ChevronRight className="w-6 h-6" />
          </button>

          <div className="absolute bottom-4 left-1/2 -translate-x-1/2 flex gap-2">
            {slides.map((_, index) => (
              <button
                key={index}
                onClick={() => setCurrentSlide(index)}
                className={`w-2 h-2 rounded-full transition ${
                  index === currentSlide ? 'bg-white w-8' : 'bg-white/50'
                }`}
              />
            ))}
          </div>
        </>
      )}
    </div>
  );
}



################################################################################
## FILE 135: FeaturedProducts.tsx
## Path: fontend/src/components/home/FeaturedProducts.tsx
################################################################################

// File: fontend/src/components/home/FeaturedProducts.tsx

'use client';

import Link from 'next/link';
import ProductCard from '@/components/ui/ProductCard';
import { Product } from '@/types';

interface FeaturedProductsProps {
  products: Product[];
  title?: string;
  loading?: boolean;
  wishedProducts?: Set<number>;
  onAddToCart?: (product: Product) => void;
  onToggleWishlist?: (productId: number) => void;
}

export default function FeaturedProducts({
  products,
  title = 'Sáº£n Pháº©m Ná»•i Báº­t',
  loading = false,
  wishedProducts = new Set(),
  onAddToCart,
  onToggleWishlist,
}: FeaturedProductsProps) {
  if (loading) {
    return (
      <div className="max-w-7xl mx-auto px-4 py-12">
        <div className="flex items-center justify-between mb-8">
          <h2 className="text-3xl font-bold">{title}</h2>
        </div>
        <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
          {[...Array(4)].map((_, i) => (
            <div key={i} className="bg-white rounded-xl shadow-sm overflow-hidden animate-pulse">
              <div className="h-64 bg-gray-200" />
              <div className="p-4 space-y-3">
                <div className="h-4 bg-gray-200 rounded w-3/4" />
                <div className="h-4 bg-gray-200 rounded w-1/2" />
                <div className="h-8 bg-gray-200 rounded" />
              </div>
            </div>
          ))}
        </div>
      </div>
    );
  }

  return (
    <div className="max-w-7xl mx-auto px-4 py-12">
      <div className="flex items-center justify-between mb-8">
        <h2 className="text-3xl font-bold">{title}</h2>
        <Link href="/shop" className="text-pink-600 font-medium hover:underline">
          Xem Táº¥t Cáº£ â†’
        </Link>
      </div>

      <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
        {products.map((product) => (
          <ProductCard
            key={product.product_id || product.id}
            product={product}
            isWished={wishedProducts.has(product.product_id || product.id)}
            onAddToCart={onAddToCart}
            onToggleWishlist={onToggleWishlist}
          />
        ))}
      </div>
    </div>
  );
}



################################################################################
## FILE 136: CategoryGrid.tsx
## Path: fontend/src/components/home/CategoryGrid.tsx
################################################################################

// File: fontend/src/components/home/CategoryGrid.tsx

'use client';

import Link from 'next/link';
import { Category } from '@/types';

interface CategoryGridProps {
  categories: Category[];
  title?: string;
}

const GRADIENT_COLORS = [
  'from-pink-500 to-rose-500',
  'from-blue-500 to-cyan-500',
  'from-purple-500 to-indigo-500',
  'from-amber-500 to-orange-500',
  'from-emerald-500 to-teal-500',
  'from-red-500 to-pink-500',
  'from-violet-500 to-purple-500',
];

export default function CategoryGrid({
  categories,
  title = 'CÃ¡c sáº£n pháº©m chÃ­nh',
}: CategoryGridProps) {
  return (
    <div className="max-w-7xl mx-auto px-4 py-12">
      <h2 className="text-3xl font-bold mb-8 text-center">{title}</h2>
      <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-7 gap-4">
        {categories.map((category, index) => (
          <Link
            key={category.name}
            href={`/shop?category=${encodeURIComponent(category.name)}`}
            className="group cursor-pointer"
          >
            <div
              className={`bg-gradient-to-br ${GRADIENT_COLORS[index % GRADIENT_COLORS.length]} p-4 rounded-2xl shadow-md hover:shadow-xl hover:scale-105 transition-all duration-300 text-center text-white h-36 flex flex-col items-center justify-center`}
            >
              <span className="text-3xl mb-2">{category.icon}</span>
              <h3 className="font-semibold text-xs mb-1 line-clamp-2 leading-tight px-1">
                {category.name}
              </h3>
              <p className="text-xs opacity-80">{category.count} SP</p>
            </div>
          </Link>
        ))}
      </div>
    </div>
  );
}



################################################################################
## FILE 137: TopBanner.tsx
## Path: fontend/src/components/layout/TopBanner.tsx
################################################################################

// File: fontend/src/components/layout/TopBanner.tsx

export default function TopBanner() {
  return (
    <div className="bg-black text-white py-2 px-4 text-center text-sm">
      <div className="max-w-7xl mx-auto flex items-center justify-center gap-4">
        <span>Miá»…n phÃ­ váº­n chuyá»ƒn cho Ä‘Æ¡n hÃ ng trÃªn 100K</span>
        <span className="hidden md:inline">|</span>
        <span className="hidden md:inline text-pink-400 font-medium">
          Æ¯u Ä‘Ã£i GoatTech: Mua 4 á»‘p - Tráº£ tiá»n 2 á»‘p
        </span>
      </div>
    </div>
  );
}



################################################################################
## FILE 138: Header.tsx
## Path: fontend/src/components/layout/Header.tsx
################################################################################

// File: fontend/src/components/layout/Header.tsx

'use client';

import { useState } from 'react';
import { Search, Menu, ShoppingCart, User, Heart, ChevronDown, LogOut } from 'lucide-react';
import Link from 'next/link';
// import { useAuth } from '@/context/AuthContext';
import { useAuth } from '@/contexts/AuthContext';
import { useCart } from '@/app/context/cart-context';
import { useWishlist } from '@/app/context/wishlist-context';
import { useRouter } from 'next/navigation';


interface HeaderProps {
  // onCartClick?: () => void;
  onWishlistClick?: () => void;
  showDeviceSelector?: boolean;
  devices?: string[];
  selectedDevice?: string;
  onDeviceChange?: (device: string) => void;
  showCurrencySelector?: boolean;
  selectedCurrency?: string;
  onCurrencyClick?: () => void;
}

export default function Header({
  // onCartClick,
  onWishlistClick,
  showDeviceSelector = false,
  devices = [],
  selectedDevice = '',
  onDeviceChange,
  showCurrencySelector = false,
  selectedCurrency = 'VND',
  onCurrencyClick,
}: HeaderProps) {
  const router = useRouter();

  const handleCartClick = () => {
    router.push('/shopping-cart');
  };
  
  const handleWishlistClick = () => {
    if (onWishlistClick) {
      onWishlistClick();
    } else {
      router.push('/wishlist');
    }
  };
  
  const { user, isAuthenticated, logout, getDisplayName } = useAuth();
  const { cartCount } = useCart();
  const { wishlistCount } = useWishlist();
  const [showDropdown, setShowDropdown] = useState(false);
  const [isMenuOpen, setIsMenuOpen] = useState(false);

  const handleLogout = () => {
    logout();
    setShowDropdown(false);
  };

return (
  <header className="bg-gray-100 border-b border-gray-300 sticky top-0 z-50">
    <div className="max-w-7xl mx-auto px-4 py-4">
      <div className="flex items-center justify-between gap-4 text-gray-900">
        {/* Left - Mobile menu */}
        <div className="flex items-center gap-4">
          <button
            className="lg:hidden text-gray-800 hover:text-pink-600"
            onClick={() => setIsMenuOpen(!isMenuOpen)}
          >
            <Menu className="w-6 h-6" />
          </button>
          <button className="lg:hidden text-gray-800 hover:text-pink-600">
            <Search className="w-6 h-6" />
          </button>
        </div>

        {/* Logo */}
        <Link
          href="/"
          className="text-2xl font-bold tracking-wider text-gray-900 hover:text-pink-600 transition"
        >
          GoatTech
        </Link>

        {/* Right */}
        <div className="flex items-center gap-4">
          {/* Device Selector */}
          {showDeviceSelector && devices.length > 0 && (
            <select
              value={selectedDevice}
              onChange={(e) => onDeviceChange?.(e.target.value)}
              className="hidden lg:block px-4 py-2 border border-gray-400 rounded-lg text-sm bg-white text-gray-900"
            >
              {devices.map((device) => (
                <option key={device} value={device}>
                  {device}
                </option>
              ))}
            </select>
          )}

          {/* Currency Selector */}
          {showCurrencySelector && (
            <button
              className="hidden lg:block px-4 py-2 text-sm font-medium text-gray-900 hover:text-pink-600"
              onClick={onCurrencyClick}
            >
              {selectedCurrency} {selectedCurrency === 'USD' ? '$' : 'â‚«'}
            </button>
          )}

          {/* Wishlist */}
          <button
            className="relative text-gray-800 hover:text-pink-600"
            onClick={handleWishlistClick}
          >
            <Heart className={`w-6 h-6 ${wishlistCount > 0 ? 'fill-red-500 text-red-500' : ''}`} />
            {wishlistCount > 0 && (
              <span className="absolute -top-1 -right-1 bg-red-500 text-white text-xs w-5 h-5 rounded-full flex items-center justify-center">
                {wishlistCount}
              </span>
            )}
          </button>

          {/* User section */}
          {isAuthenticated && user ? (
            <div className="relative">
              <button
                onClick={() => setShowDropdown(!showDropdown)}
                className="flex items-center gap-2 text-gray-900 hover:text-pink-600 transition px-2 py-1 rounded-lg hover:bg-pink-100"
              >
                <div className="w-8 h-8 bg-pink-600 text-white rounded-full flex items-center justify-center text-sm font-semibold">
                  {getDisplayName().charAt(0).toUpperCase()}
                </div>
                <span className="hidden sm:inline text-sm font-medium max-w-[100px] truncate">
                  {getDisplayName()}
                </span>
                <ChevronDown className="w-4 h-4" />
              </button>

              {showDropdown && (
                <>
                  <div
                    className="fixed inset-0 z-40"
                    onClick={() => setShowDropdown(false)}
                  />
                  <div className="absolute right-0 mt-2 w-56 bg-white rounded-lg shadow-xl border border-gray-300 py-2 z-50 text-gray-900">
                    <div className="px-4 py-2 border-b border-gray-200">
                      <p className="text-sm font-semibold truncate">
                        {getDisplayName()}
                      </p>
                      <p className="text-xs text-gray-600 truncate">
                        {user.email}
                      </p>
                    </div>

                    <Link
                      href="/login"
                      className="flex items-center gap-2 px-4 py-2 text-sm hover:bg-pink-100 hover:text-pink-600"
                      onClick={() => setShowDropdown(false)}
                    >
                      <User className="w-4 h-4" />
                      TÃ i khoáº£n
                    </Link>

                    <Link
                      href="/order"
                      className="flex items-center gap-2 px-4 py-2 text-sm hover:bg-pink-100 hover:text-pink-600"
                      onClick={() => setShowDropdown(false)}
                    >
                      <ShoppingCart className="w-4 h-4" />
                      ÄÆ¡n hÃ ng
                    </Link>

                    <button
                      onClick={handleLogout}
                      className="w-full flex items-center gap-2 px-4 py-2 text-sm text-red-700 hover:bg-red-100"
                    >
                      <LogOut className="w-4 h-4" />
                      ÄÄƒng xuáº¥t
                    </button>
                  </div>
                </>
              )}
            </div>
          ) : (
            <Link
              href="/login"
              className="text-gray-800 hover:text-pink-600"
            >
              <User className="w-6 h-6" />
            </Link>
          )}

          {/* Cart */}
          <button
            className="relative text-gray-800 hover:text-pink-600"
            onClick={handleCartClick}
          >
            <ShoppingCart className="w-6 h-6" />
            {isAuthenticated && cartCount > 0 && (
              <span className="absolute -top-1 -right-1 bg-pink-600 text-white text-xs w-5 h-5 rounded-full flex items-center justify-center">
                {cartCount}
              </span>
            )}
          </button>
        </div>
      </div>

      {/* Desktop Navigation */}
      <nav className="hidden lg:flex items-center justify-center gap-8 mt-4 pt-4 border-t border-gray-300 text-gray-900">
        <Link href="/shop" className="text-sm font-medium hover:text-pink-600">
          Cá»­a HÃ ng
        </Link>
        <Link href="/collections" className="text-sm font-medium hover:text-pink-600">
          Bá»™ SÆ°u Táº­p
        </Link>
        <Link href="/about" className="text-sm font-medium hover:text-pink-600">
          Vá» ChÃºng TÃ´i
        </Link>
        <Link href="/contact" className="text-sm font-medium hover:text-pink-600">
          LiÃªn Há»‡
        </Link>
        <Link href="/promotions" className="text-sm font-medium text-red-700">
          Khuyáº¿n Máº¡i
        </Link>
      </nav>
    </div>
  </header>
);

}



################################################################################
## FILE 139: Footer.tsx
## Path: fontend/src/components/layout/Footer.tsx
################################################################################

// File: fontend/src/components/layout/Footer.tsx

import Link from 'next/link';

export default function Footer() {
  return (
    <footer className="bg-gray-900 text-white py-12">
      <div className="max-w-7xl mx-auto px-4">
        <div className="grid grid-cols-1 md:grid-cols-4 gap-8 mb-8">
          <div>
            <h3 className="text-2xl font-bold mb-4">GoatTech</h3>
            <p className="text-gray-400">á»p Ä‘iá»‡n thoáº¡i cao cáº¥p vÃ  phá»¥ kiá»‡n cÃ´ng nghá»‡</p>
          </div>
          <div>
            <h4 className="font-semibold mb-4">Cá»­a HÃ ng</h4>
            <ul className="space-y-2 text-gray-400">
              <li><Link href="/shop" className="hover:text-white">á»p iPhone</Link></li>
              <li><Link href="/shop" className="hover:text-white">Phá»¥ Kiá»‡n</Link></li>
              <li><Link href="/promotions" className="hover:text-white">Khuyáº¿n Máº¡i</Link></li>
            </ul>
          </div>
          <div>
            <h4 className="font-semibold mb-4">Há»— Trá»£</h4>
            <ul className="space-y-2 text-gray-400">
              <li><Link href="/contact" className="hover:text-white">LiÃªn Há»‡</Link></li>
              <li>ChÃ­nh SÃ¡ch HoÃ n HÃ ng</li>
              <li>FAQ</li>
            </ul>
          </div>
          <div>
            <h4 className="font-semibold mb-4">Theo DÃµi</h4>
            <ul className="space-y-2 text-gray-400">
              <li>Instagram</li>
              <li>Facebook</li>
              <li>TikTok</li>
            </ul>
          </div>
        </div>
        <div className="border-t border-gray-800 pt-8 text-center text-gray-400">
          <p>Â© 2024 GoatTech. All rights reserved.</p>
        </div>
      </div>
    </footer>
  );
}



################################################################################
## FILE 140: index.ts
## Path: fontend/src/components/modals/index.ts
################################################################################





################################################################################
## FILE 141: CurrencyModal.tsx
## Path: fontend/src/components/modals/CurrencyModal.tsx
################################################################################





################################################################################
## FILE 142: CartModal.tsx
## Path: fontend/src/components/modals/CartModal.tsx
################################################################################

// File: fontend/src/components/modals/CartModal.tsx

'use client';

import { ShoppingCart, X } from 'lucide-react';
import { CartItem } from '@/types';

interface CartModalProps {
  isOpen: boolean;
  onClose: () => void;
  cartItems: CartItem[];
  onUpdateQuantity: (productId: number, quantity: number) => void;
  onRemoveItem: (productId: number) => void;
  onCheckout: () => void;
  checkoutLoading?: boolean;
}

export default function CartModal({
  isOpen,
  onClose,
  cartItems,
  onUpdateQuantity,
  onRemoveItem,
  onCheckout,
  checkoutLoading = false,
}: CartModalProps) {
  if (!isOpen) return null;

  const cartCount = cartItems.reduce((total, item) => total + item.quantity, 0);
  const cartTotal = cartItems.reduce((total, item) => total + item.price * item.quantity, 0);

  return (
    <div
      className="fixed inset-0 z-50 flex items-end sm:items-center justify-center bg-black/50"
      onClick={onClose}
    >
      <div
        className="bg-white rounded-t-3xl sm:rounded-xl w-full sm:max-w-2xl sm:mx-4 max-h-[90vh] overflow-hidden shadow-2xl"
        onClick={(e) => e.stopPropagation()}
      >
        {/* Header */}
        <div className="flex items-center justify-between p-6 border-b">
          <h2 className="text-2xl font-bold">Giá» HÃ ng ({cartCount})</h2>
          <button onClick={onClose} className="text-gray-500 hover:text-gray-700">
            <X className="w-6 h-6" />
          </button>
        </div>

        {/* Body */}
        <div className="overflow-y-auto max-h-[60vh] p-6">
          {cartItems.length === 0 ? (
            <div className="text-center py-12">
              <ShoppingCart className="w-16 h-16 mx-auto text-gray-300 mb-4" />
              <p className="text-gray-500 text-lg">Giá» hÃ ng trá»‘ng</p>
              <button
                onClick={onClose}
                className="mt-4 bg-pink-600 text-white px-6 py-2 rounded-lg hover:bg-pink-700 transition"
              >
                Mua Sáº¯m Ngay
              </button>
            </div>
          ) : (
            <div className="space-y-4">
              {cartItems.map((item) => (
                <div key={item.id} className="flex gap-4 bg-gray-50 p-4 rounded-xl">
                  <img
                    src={item.image || item.image_url}
                    alt={item.name}
                    className="w-24 h-24 object-cover rounded-lg"
                  />
                  <div className="flex-1">
                    <h3 className="font-semibold mb-2 line-clamp-2">{item.name}</h3>
                    <p className="text-pink-600 font-bold mb-2">
                      {item.price.toLocaleString('vi-VN')}â‚«
                    </p>
                    <div className="flex items-center gap-3">
                      <button
                        onClick={() => onUpdateQuantity(item.id, item.quantity - 1)}
                        className="w-8 h-8 rounded-full bg-gray-200 hover:bg-gray-300 flex items-center justify-center"
                      >
                        -
                      </button>
                      <span className="font-semibold w-8 text-center">{item.quantity}</span>
                      <button
                        onClick={() => onUpdateQuantity(item.id, item.quantity + 1)}
                        className="w-8 h-8 rounded-full bg-gray-200 hover:bg-gray-300 flex items-center justify-center"
                      >
                        +
                      </button>
                      <button
                        onClick={() => onRemoveItem(item.id)}
                        className="ml-auto text-red-500 hover:text-red-700 text-sm"
                      >
                        XÃ³a
                      </button>
                    </div>
                  </div>
                </div>
              ))}
            </div>
          )}
        </div>

        {/* Footer */}
        {cartItems.length > 0 && (
          <div className="p-6 border-t bg-gray-50">
            <div className="flex items-center justify-between mb-4">
              <span className="text-lg font-semibold">Tá»•ng Cá»™ng:</span>
              <span className="text-2xl font-bold text-pink-600">
                {cartTotal.toLocaleString('vi-VN')}â‚«
              </span>
            </div>
            <button
              onClick={onCheckout}
              disabled={checkoutLoading}
              className="w-full bg-gradient-to-r from-purple-600 to-pink-600 text-white py-4 rounded-xl font-semibold hover:from-purple-700 hover:to-pink-700 transition disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2"
            >
              {checkoutLoading ? (
                <>
                  <svg className="animate-spin h-5 w-5" viewBox="0 0 24 24">
                    <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4" fill="none" />
                    <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z" />
                  </svg>
                  Äang xá»­ lÃ½...
                </>
              ) : (
                'ðŸ’³ Thanh ToÃ¡n MoMo'
              )}
            </button>
          </div>
        )}
      </div>
    </div>
  );
}



################################################################################
## FILE 143: AddToCartButton.tsx
## Path: fontend/src/components/products/AddToCartButton.tsx
################################################################################

'use client';

import { useAuth } from '@/contexts/AuthContext';
import { addToShoppingCart } from '@/lib/api-client';
import { useRouter } from 'next/navigation';
import { useState } from 'react';

interface AddToCartButtonProps {
  productId: number;
}

export function AddToCartButton({ productId }: AddToCartButtonProps) {
  const { user, isAuthenticated } = useAuth();
  const router = useRouter();
  const [loading, setLoading] = useState(false);

  const handleAddToCart = async (e: React.MouseEvent<HTMLButtonElement>) => {
    // ðŸš« Cháº·n Link bá»c ngoÃ i
    e.preventDefault();
    e.stopPropagation();

    // 1ï¸âƒ£ ChÆ°a Ä‘Äƒng nháº­p â†’ login
    if (!isAuthenticated || !user) {
      alert('Vui lÃ²ng Ä‘Äƒng nháº­p Ä‘á»ƒ thÃªm vÃ o giá» hÃ ng');
      router.push('/login');
      return;
    }

    // 2ï¸âƒ£ KhÃ´ng cÃ³ user.id â†’ lá»—i logic
    if (!user.id) {
      alert('KhÃ´ng tÃ¬m tháº¥y thÃ´ng tin ngÆ°á»i dÃ¹ng');
      return;
    }

    setLoading(true);
    try {
      // 3ï¸âƒ£ Gá»i backend
      await addToShoppingCart({
        // customer_id: user.id,
        productId,
        quantity: 1,
      });

      // 4ï¸âƒ£ Äá»“ng bá»™ giá» hÃ ng (header, cart badgeâ€¦)
      window.dispatchEvent(new Event('cartUpdated'));
    } catch (error) {
      console.error('Add to cart error:', error);
      alert('KhÃ´ng thá»ƒ thÃªm vÃ o giá» hÃ ng, vui lÃ²ng thá»­ láº¡i');
    } finally {
      setLoading(false);
    }
  };

  return (
    <button
      onClick={handleAddToCart}
      disabled={loading}
      className="bg-pink-600 hover:bg-pink-700 text-white px-4 py-2 rounded-lg text-sm font-medium disabled:opacity-50"
    >
      {loading ? 'Äang thÃªm...' : 'ThÃªm VÃ o Giá» HÃ ng'}
    </button>
  );
}





################################################################################
## FILE 144: index.ts
## Path: fontend/src/components/ui/index.ts
################################################################################





################################################################################
## FILE 145: ProductCard.tsx
## Path: fontend/src/components/ui/ProductCard.tsx
################################################################################

// File: fontend/src/components/ui/ProductCard.tsx

'use client';

import { Heart, Star } from 'lucide-react';
import Link from 'next/link';
import { Product } from '@/types';

interface ProductCardProps {
  product: Product;
  isWished?: boolean;
  onAddToCart?: (product: Product) => void;
  onToggleWishlist?: (productId: number) => void;
}

export default function ProductCard({
  product,
  isWished = false,
  onAddToCart,
  onToggleWishlist,
}: ProductCardProps) {
  const productId = product.product_id || product.id;
  const productName = product.name || product.product_name || 'Sáº£n pháº©m';
  const productImage = product.image || product.image_url || 'https://via.placeholder.com/400';
  const productRating = product.rating || 4.5;
  const productReviews = product.reviews || 0;

  return (
    <div className="bg-white rounded-xl shadow-sm hover:shadow-lg transition group cursor-pointer overflow-hidden">
      <Link href={`/product/${productId}`}>
        <div className="relative overflow-hidden">
          {product.tag && (
            <span className="absolute top-3 left-3 bg-red-500 text-white text-xs font-bold px-3 py-1 rounded-full z-10">
              {product.tag}
            </span>
          )}
          <img
            src={productImage}
            alt={productName}
            className="w-full h-64 object-cover group-hover:scale-110 transition duration-300"
          />
          <button
            onClick={(e) => {
              e.preventDefault();
              e.stopPropagation();
              onToggleWishlist?.(productId);
            }}
            className="absolute bottom-3 right-3 bg-white p-2 rounded-full shadow-lg opacity-0 group-hover:opacity-100 transition"
          >
            <Heart
              className={`w-5 h-5 ${isWished ? 'fill-red-500 text-red-500' : ''}`}
            />
          </button>
        </div>
      </Link>

      <div className="p-4">
        <Link href={`/product/${productId}`}>
          <h3 className="font-semibold mb-2 line-clamp-2 hover:text-pink-600 transition">
            {productName}
          </h3>
        </Link>
        <div className="flex items-center gap-2 mb-2">
          <div className="flex items-center">
            <Star className="w-4 h-4 fill-yellow-400 text-yellow-400" />
            <span className="text-sm ml-1">{productRating}</span>
          </div>
          <span className="text-sm text-gray-500">({productReviews})</span>
        </div>
        <div className="flex items-center justify-between">
          <span className="text-xl font-bold">
            {(product.price || 0).toLocaleString('vi-VN')}â‚«
          </span>
          <button
            onClick={() => onAddToCart?.(product)}
            className="bg-pink-600 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-pink-700 transition"
          >
            ThÃªm VÃ o Giá»
          </button>
        </div>
      </div>
    </div>
  );
}



################################################################################
## FILE 146: AuthContext.tsx
## Path: fontend/src/contexts/AuthContext.tsx
################################################################################

// File: fontend/src/app/context/auth-context.tsx

'use client';

import React, { createContext, useContext, useState, useEffect, ReactNode } from 'react';

export interface AuthUser {
  id?: string;
  email: string;
  full_name?: string;
  fullName?: string;
  name?: string;
  phone?: string;
  role?: string;
  is_admin?: boolean; 
  created_at?: string;
  access_token?: string;
}

interface AuthContextType {
  user: AuthUser | null;
  isAuthenticated: boolean;
  loading: boolean;
  login: (userData: AuthUser) => void;
  logout: () => void;
  refreshAuth: () => void;
  getDisplayName: () => string;
  is_admin:() =>boolean;
}

const AuthContext = createContext<AuthContextType | undefined>(undefined);

export function AuthProvider({ children }: { children: ReactNode }) {
  const [user, setUser] = useState<AuthUser | null>(null);
  const [loading, setLoading] = useState(true);

  // Load user tá»« localStorage khi mount
  useEffect(() => {
    refreshAuth();
  }, []);

  // Listen for storage changes (Ä‘á»“ng bá»™ giá»¯a cÃ¡c tab/components)
  useEffect(() => {
    const handleStorageChange = (e: StorageEvent) => {
      if (e.key === 'customer') {
        refreshAuth();
      }
    };

    // Custom event Ä‘á»ƒ Ä‘á»“ng bá»™ trong cÃ¹ng 1 tab
    const handleAuthChange = () => {
      refreshAuth();
    };

    window.addEventListener('storage', handleStorageChange);
    window.addEventListener('authChange', handleAuthChange);

    return () => {
      window.removeEventListener('storage', handleStorageChange);
      window.removeEventListener('authChange', handleAuthChange);
    };
  }, []);

  const refreshAuth = () => {
    try {
      const customerData = localStorage.getItem('customer');
      if (customerData) {
        const parsedUser = JSON.parse(customerData);
        setUser(parsedUser);
      } else {
        setUser(null);
      }
    } catch (error) {
      console.error('Error parsing customer data:', error);
      setUser(null);
    } finally {
      setLoading(false);
    }
  };

  const login = (userData: AuthUser) => {
    localStorage.setItem('customer', JSON.stringify(userData));
    setUser(userData);
    // Dispatch event Ä‘á»ƒ cÃ¡c component khÃ¡c biáº¿t
    window.dispatchEvent(new Event('authChange'));
  };

  const logout = () => {
    localStorage.removeItem('customer');
    localStorage.removeItem('userRole');
    setUser(null);
    // Dispatch event Ä‘á»ƒ cÃ¡c component khÃ¡c biáº¿t
    window.dispatchEvent(new Event('authChange'));
  };

  const getDisplayName = () => {
    if (!user) return '';
    return user.full_name || user.fullName || user.name || user.email?.split('@')[0] || 'User';
  };
  const is_admin = () => {
    if (!user) return false;
    return user.role === 'ADMIN' || user.role === 'admin';
  };

  return (
    <AuthContext.Provider
      value={{
        user,
        isAuthenticated: !!user,
        loading,
        login,
        logout,
        refreshAuth,
        getDisplayName,
        is_admin,
      }}
    >
      {children}
    </AuthContext.Provider>
  );
}

export function useAuth() {
  const context = useContext(AuthContext);
  if (context === undefined) {
    throw new Error('useAuth must be used within an AuthProvider');
  }
  return context;
}



################################################################################
## FILE 147: useWishlist.ts
## Path: fontend/src/hooks/useWishlist.ts
################################################################################





################################################################################
## FILE 148: useProducts.ts
## Path: fontend/src/hooks/useProducts.ts
################################################################################





################################################################################
## FILE 149: useCustomerGuard.ts
## Path: fontend/src/hooks/useCustomerGuard.ts
################################################################################

'use client';

import { useAuth } from '@/contexts/AuthContext';
import { useRouter } from 'next/navigation';

interface UseCustomerGuardOptions {
  redirectTo?: string;
  onDenied?: () => void;
}

/**
 * Hook Ä‘á»ƒ kiá»ƒm tra vÃ  báº£o vá»‡ actions chá»‰ dÃ nh cho customer
 * 
 * VÃ­ dá»¥ sá»­ dá»¥ng:
 * const { checkAndExecute, canExecute } = useCustomerGuard({ 
 *   redirectTo: '/login' 
 * });
 * 
 * // Trong handler
 * const handleAddToCart = () => {
 *   checkAndExecute(() => {
 *     // Logic thÃªm vÃ o giá»
 *   });
 * };
 */
export function useCustomerGuard(options: UseCustomerGuardOptions = {}) {
  const { user, isCustomer, isAuthenticated, loading } = useAuth();
  const router = useRouter();
  const { redirectTo, onDenied } = options;

  // CÃ³ thá»ƒ thá»±c hiá»‡n action khÃ´ng?
  const canExecute = isAuthenticated && isCustomer;

  // Function wrap action
  const checkAndExecute = async (action: () => void | Promise<void>): Promise<boolean> => {
    // ChÆ°a Ä‘Äƒng nháº­p
    if (!isAuthenticated) {
      if (redirectTo) {
        router.push(redirectTo);
      }
      onDenied?.();
      return false;
    }

    // KhÃ´ng pháº£i customer
    if (!isCustomer) {
      console.warn('Action requires CUSTOMER role');
      onDenied?.();
      return false;
    }

    // Thá»±c hiá»‡n action
    await action();
    return true;
  };

  // Require customer - redirect náº¿u khÃ´ng pháº£i
  const requireCustomer = () => {
    if (!loading && !canExecute && redirectTo) {
      router.push(redirectTo);
    }
  };

  return {
    canExecute,
    isCustomer,
    isAuthenticated,
    loading,
    user,
    checkAndExecute,
    requireCustomer,
  };
}



################################################################################
## FILE 150: useCart.ts
## Path: fontend/src/hooks/useCart.ts
################################################################################





################################################################################
## FILE 151: useAuth.ts
## Path: fontend/src/hooks/useAuth.ts
################################################################################





################################################################################
## FILE 152: index.ts
## Path: fontend/src/hooks/index.ts
################################################################################

export * from './useCustomerGuard';




################################################################################
## FILE 153: index.ts
## Path: fontend/src/types/index.ts
################################################################################

// File: fontend/src/types/index.ts

export interface Product {
  id: number;
  product_id?: number;
  name: string;
  product_name?: string;
  price: number;
  image: string;
  image_url?: string;
  rating: number;
  reviews: number;
  tag?: string;
  category?: string;
  category_id?: number;
}

export interface CartItem extends Product {
  quantity: number;
}

export interface Category {
  name: string;
  icon: string;
  count: number;
}

export interface BannerSlide {
  title: string;
  subtitle: string;
  image?: string;
}


